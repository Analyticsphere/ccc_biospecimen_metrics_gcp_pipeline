---
title: "Ad Hoc - Collection-to-BPTL Receipt by Location"
author: "Kelsey Dowling"
date: "`r Sys.Date()`"
header-includes:  
    \usepackage[labelformat=empty]{caption}
    \usepackage{placeins}
    \usepackage{booktabs}
    \usepackage{pdflscape}


output:
  pdf_document:
    extra_dependencies: ["float"]
    toc: false
    keep_tex: yes
    fig_width: 7
    fig_height: 5
    fig_caption: true
    df_print: paged 

---

```{r setup,eval=TRUE,include=FALSE,echo=FALSE, warning=FALSE}
#latex_engine: xelatex

#old.packages()
#update.packages()  


library(bigrquery)
library(data.table) ###to write or read and data management 
library(dplyr) ###data management
# library(boxr) ###read or write data from/to box
library(tidyverse) ###for data management
library(reshape)  ###to work on transition from long to wide or wide to long data
library(listr) ###to work on a list of vector, files or..
library(sqldf) ##sql
library(lubridate) ###date time
library(ggplot2) ###plots
#library(ggpubr) ###for the publications of plots
library(RColorBrewer) ###visions color http://www.sthda.com/english/wiki/colors-in-r
library(gridExtra)
library(stringr) ###to work on patterns, charaters
#library(plyr)
library(tinytex) #for pdf
library(rmarkdown) ###for the output tables into other files: pdf, rtf, etc.
library(janitor) #to get the summary sum
library(finalfit) #https://cran.r-project.org/web/packages/finalfit/vignettes/export.html t
library(expss) ###to add labels
library(epiDisplay) ##recommended applied here crosstable, tab1
library(summarytools) ##recommended
library(gmodels) ##recommended
library(magrittr)
library(arsenal)
library(gtsummary)
library(kableExtra)
library(gt)
library(crosstable)
library(cowplot)
library(webshot2)
library(glue) 
#options(knitr.table.format = "latex")
currentDate <- Sys.Date()

bq_auth()

### Set Box folders for output CSV files #######################################
use_test_box_folder <- TRUE # Local user sets this (Jake or Kelsey)

# Over-ride if using plumber api on GCP (USER DOESN'T TOUCH THIS!)
# Check if the environment variable exists and is not empty
if (!is.null(Sys.getenv("USE_TEST_BOX_FOLDER")) &&
    Sys.getenv("USE_TEST_BOX_FOLDER") != "") {
  use_test_box_folder <- as.logical(Sys.getenv("USE_TEST_BOX_FOLDER"))
}

if (use_test_box_folder) {
  boxfolder <- 222593912729 # test box folder
} else {
  boxfolder <- 221280601453 # destination of CSV files (not pdf)
}


##### Making sure personal C drives aren't referenced if this code is being used by others


#Change to FALSE if referencing this code
write_to_local_drive = F #F

#local_drive="C:/Users/dowlingk2/Documents/Module-Missingness-and-Metrics/data/"    


### This function below is put before any write.csv functions, and "filename" is updated. It determines wheteher the file will be created locally or not.
#filename=
local_drive= ifelse(write_to_local_drive, "C:/Users/dowlingk2/Documents/Module-Missingness-and-Metrics/data/", "")

```

```{r BQPull, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}
##import data to R

project <- "nih-nci-dceg-connect-prod-6d04"
billing <- "nih-nci-dceg-connect-prod-6d04" ##project and billing should be consistent
bio_tb <- bq_project_query(project, query='SELECT * FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.biospecimen_JP` where d_410912345 is not null')  
biospe <- bq_table_download(bio_tb,bigint="integer64",n_max = Inf, page_size = 1000)
cnames <- names(biospe)
###to check variables in recr_noinact_wl1

numbers_only <- function(x) !grepl("\\D", x)

for (i in 1: length(cnames)){
  varname <- cnames[i]
  var<-pull(biospe,varname)
  biospe[,cnames[i]] <- ifelse(numbers_only(var), as.numeric(as.character(var)), var)
}
tb_box <- bq_project_query(project, query="SELECT * FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.boxes_JP`")
box_wl_flat <- bigrquery::bq_table_download(tb_box,bigint="integer64",n_max = Inf, page_size = 1000)
#y <- read_table(urlfile1,header = TRUE, sep = "\t", na.strings = c("NA","N/A",""),fill = TRUE, quote='')
library(rio)
dictionary <- rio::import("https://episphere.github.io/conceptGithubActions/aggregate.json",format = "json")
dd<-rbindlist(dictionary,fill=TRUE,use.names=TRUE,idcol="CID") #THIS TABLE HAS REPLICATED (CIDS+LABELS) WITH DIFFERENT VARIABLE NAMES,
# dd <- as.data.frame(do.call("rbind",dictionary))
# colnames(dd) <- c("Variable Label", "Variable Name")
# dd$CID <- rownames(dd)
box_CID <- as.data.frame(as.numeric(sapply((strsplit(colnames(box_wl_flat),"d_")),tail,1)))
box_CID$variable <- colnames(box_wl_flat)
colnames(box_CID)[1] <-"CID"
box_CID_dd <- base::merge(box_CID, dd,by="CID",all.x=TRUE)
#to convert the numeric variables
numbers_only <- function(x) !grepl("\\D", x)
 cnames <- names(box_wl_flat)
 ###to check variables in recr_noinact_wl1
 data2 <- box_wl_flat
 for (i in 1: length(cnames)){
   varname <- cnames[i]
   var<-pull(data2,varname)
   data2[,cnames[i]] <- ifelse(numbers_only(var), as.numeric(as.character(var)), var)
 }
# 
pct_tb <- function(x,y){
  table1 <- CrossTable(x,y, prop.t=FALSE, prop.r=FALSE, prop.c=TRUE,chisq=FALSE)
  pct <- as.data.frame(cbind(table1$prop.row,table1$t))
  if(ncol(pct)==2){
    total <- as.numeric(sum(pct[,2]))
    pct[nrow(pct)+1,c(1:2)] <- c(1,total)
    rownames(pct)[nrow(pct)] <- "Total"
    colnames(pct)[1] <- paste0("pct_",colnames(pct)[1])
    colnames(pct)[2] <- paste0("n_",colnames(pct)[2])
    
  }
  else  if(ncol(pct)>2 ){
    total <- as.numeric(sum(pct[,3] + pct[,4]))
    pct[nrow(pct)+1,c(1:4)] <- c(sum(pct[,3])/total,sum(pct[,4])/total,sum(pct[,3]),sum(pct[,4]))
    rownames(pct)[nrow(pct)] <- "Total"
    colnames(pct)[c(1:2)] <- paste0("pct_",colnames(pct[c(1:2)]))
    colnames(pct)[c(3:4)] <- paste0("n_",colnames(pct)[c(3:4)])
  
    pct[,5] <- paste0(format(pct[,3],big.mark=","), " (",round(100*pct[,1],1), " %)")
    pct[,6] <- paste0(format(pct[,4],big.mark=","), " (",round(100*pct[,2],1), " %)") 
    colnames(pct)[5] <- paste0("n_",colnames(pct)[1])
    colnames(pct)[6] <- paste0("n_",colnames(pct)[2])
  }
return(pct)
}
##to select biospecimen data in recruitment 
recr_var <- bq_project_query(project, query="SELECT * FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect`.INFORMATION_SCHEMA.COLUMN_FIELD_PATHS WHERE table_name='participants_JP'")
recrvar <- bigrquery::bq_table_download(recr_var, bigint="integer64",n_max = Inf, page_size = 10000)
urlfile<- "https://raw.githubusercontent.com/episphere/conceptGithubActions/master/csv/masterFile.csv" ###to grab the updated dd from github 
y <- read.csv(urlfile)
recrvar_nd <- recrvar[which(grepl("d_",recrvar$column_name)),c("column_name","field_path")]
recrvar_nd$last.CID <- ifelse(grepl("d_",recrvar_nd$column_name),substring(sapply(strsplit(recrvar_nd$column_name,"d_"),tail,1),1,9),NA)
recrvar_nd_label <- base::merge(recrvar_nd, y[,c("Primary.Source","conceptId.2","conceptId.3","Variable.Label","conceptId.4")],by.x="last.CID",by.y="conceptId.3",all.x=TRUE)
recrvar.bio <- recrvar_nd_label[which(recrvar_nd_label$Primary.Source == "Biospecimen" | grepl("biospecimen|blood|urine|mouthwash|Blood|Urine|Mouthwash|collection",recrvar_nd_label$Variable.Label)),] #49 updated due to the changes of the master DD
recrvar.bio <- recrvar.bio[!duplicated(recrvar.bio[,c("last.CID","column_name")]),] #53 updated 10/05/2023 due to the updated dictionary
query <- recrvar.bio$column_name
select <- paste(recrvar.bio$column_name,collapse=",")
#tb_bq <- eval(parse(text=paste("bq_project_query(project, query=\"SELECT token,Connect_ID,d_512820379,d_821247024,d_914594314,d_827220437,d_699625233, date,", select,"FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` Where d_821247024 = '197316935' \")",sep=" ")))

tb_bq <- eval(parse(text=paste("bq_project_query(project, query=\"SELECT token,Connect_ID,d_512820379,d_821247024,d_914594314,d_827220437,d_699625233, date,d_265193023, d_822499427, d_222161762,", select,"FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` Where d_821247024 = '197316935' \")",sep=" ")))
 
recr.bio <- bigrquery::bq_table_download(tb_bq,bigint="integer64",n_max = Inf, page_size = 10000)
##below are the commone variables in the recruitment table on Biospecimen to apply for the analysis. In case any new variables popping up, i would like #to use the one above directly from the resources (master DD and recruitment table schema to get the most updated version on this biospecimen data
# tb <- bq_project_query(project, query="SELECT d_512820379,d_512820379, d_821247024, d_914594314, d_822499427, d_222161762, Connect_ID, d_827220437, token,d_265193023, d_878865966, d_167958071, d_684635302, d_253883960, d_534669573, d_764863765, d_331584571_d_266600170_d_135591601,d_331584571_d_266600170_d_840048338,  d_331584571_d_266600170_d_343048998, d_173836415_d_266600170_d_139245758, d_173836415_d_266600170_d_185243482,
# d_173836415_d_266600170_d_198261154, d_173836415_d_266600170_d_210921343, d_173836415_d_266600170_d_224596428,
# d_173836415_d_266600170_d_316824786, d_173836415_d_266600170_d_341570479, d_173836415_d_266600170_d_398645039,
# d_173836415_d_266600170_d_448660695, d_173836415_d_266600170_d_452847912, d_173836415_d_266600170_d_453452655,
# d_173836415_d_266600170_d_530173840, d_173836415_d_266600170_d_534041351, d_173836415_d_266600170_d_541311218,
# d_173836415_d_266600170_d_561681068, d_173836415_d_266600170_d_592099155, d_173836415_d_266600170_d_611091485,
# d_173836415_d_266600170_d_646899796, d_173836415_d_266600170_d_693370086, d_173836415_d_266600170_d_718172863,
# d_173836415_d_266600170_d_728696253, d_173836415_d_266600170_d_740582332, d_173836415_d_266600170_d_769615780,
# d_173836415_d_266600170_d_786930107, d_173836415_d_266600170_d_822274939, d_173836415_d_266600170_d_847159717,
# d_173836415_d_266600170_d_860477844, d_173836415_d_266600170_d_915179629, d_173836415_d_266600170_d_939818935,
# d_173836415_d_266600170_d_951355211, d_173836415_d_266600170_d_982213346 FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` WHERE d_821247024 = '197316935'")
##to convert to numeric
cnames <- names(recr.bio)
recrver <- recr.bio
for (i in 1: length(cnames)){
  varname <- cnames[i]
  var<-pull(recrver,varname)
  recrver[,cnames[i]] <- ifelse(numbers_only(var), as.numeric(as.character(var)), var)
}
##to get the labels of each variable
recrver_CID <- as.data.frame(sapply((strsplit(colnames(recrver),"d_")),tail,1))
colnames(recrver_CID)[1] <- "CID"
recrver_CID$variable <- names(recr.bio)
recrver_ver1 <- base::merge(dd,recrver_CID,by="CID")
recrver1 <- expss::apply_labels(recrver,
                        d_512820379 = "Recruitment type",#RcrtSI_RecruitType_v1r0
                        d_512820379=c(	"Not active"=180583933,  
                                       "Active"= 486306141, 
                                       "Passive"=854703046),
                        d_821247024 = "Verification status", #RcrtV_Verification_v1r0
                        d_821247024 = c("Not yet verified" =875007964,
                                        "Verified"=197316935,  
                                        "Cannot be verified"=219863910, 
                                        "Duplicate"=922622075 , 
                                        "Outreach timed out"= 160161595),
                        d_827220437 = "Site",#RcrtES_Site_v1r0
                        d_827220437 = c("HealthPartners"= 531629870, "Henry Ford Health System"=548392715,"Marshfield Clinic Health System" = 303349821,"Sanford Health" = 657167265, "University of Chicago Medicine" = 809703864,"Kaiser Permanente Colorado" = 125001209,"Kaiser Permanente Georgia" = 327912200,"Kaiser Permanente Hawaii" = 300267574,"Kaiser Permanente Northwest" = 452412599,"National Cancer Institute" = 517700004,"National Cancer Institute" = 13,"Other" = 181769837),
                        d_914594314 = "Verification status time",   #RcrtV_VerificationTm_V1R0
                        d_878865966 = "Baseline blood sample collected", #BioFin_BaseBloodCol_v1r0
                        d_878865966 = c("Any blood collected"=353358909, "No blood collected"=104430631),
                        d_173836415_d_266600170_d_561681068 = "Date/time basline Research Blood Collected",#BL_BioFin_BBTime_v1r0
                        d_684635302 = "Baseline Mouthwash Collected",    #BioFin_BaseMWCol_v1r0
                        d_684635302 = c("Any mouthwash collected"=353358909,"No mouthwash collected"= 104430631  ),
                        d_173836415_d_266600170_d_448660695 = "Date/time Mouthwash Collected", #
                        d_167958071 = "Baseline Urine collected", 
                        d_167958071 = c( "Any urine collected"=353358909, "No urine collected"=104430631),
                        d_173836415_d_266600170_d_847159717 = "Baseline Date/time Urine collected",
                        d_331584571_d_266600170_d_135591601 = "Baseline Check-In Complete",#BL_BioChk_Complete_v1r0
                        d_331584571_d_266600170_d_135591601 =  c( "No"=104430631, "Yes"=353358909 ),
                        d_331584571_d_266600170_d_840048338 = "Date/Time Baseline Check-In Complete",
                        d_331584571_d_266600170_d_343048998 = "Time Baseline check out complete",#
                        
                        d_173836415_d_266600170_d_530173840 = "Blood Order Placed",#BioClin_BldOrderPlaced_v1r0  ## I ADDED
                        d_173836415_d_266600170_d_530173840 =c( "No"=104430631, "Yes"=353358909 ), ## I ADDED
                        
                        d_173836415_d_266600170_d_592099155 = "Blood Collection Setting",#BL_BioSpm_BloodSetting_v1r0  
                        d_173836415_d_266600170_d_592099155 =c("Research"=534621077, "Clinical"= 664882224,"Home" =103209024),
                        d_173836415_d_266600170_d_718172863 = "Urine Collection Setting",#BL_BioSpm_UrineSetting_v1r0
                        d_173836415_d_266600170_d_718172863 =c("Research"=534621077, "Clinical"= 664882224,"Home" =103209024),
                        d_173836415_d_266600170_d_915179629 = "Mouthwash Collection Setting",#BL_BioSpm_MWSetting_v1r0
                        d_173836415_d_266600170_d_915179629 =c("Research"=534621077, "Clinical"= 664882224,"Home" =103209024),
                        
                        d_265193023 = "Blood/urine/mouthwash combined research survey-Complete",   
                        d_265193023 = c(	"Not Started" =	972455046, "Started"= 615768760,"Submitted"= 231311385),#SrvBLM_ResSrvCompl_v1r0
                        d_822499427 = "Placeholder (Autogenerated) - Date/time Status of Start of blood/urine/mouthwash research survey",#SrvBLM_TmStart_v1r0
                        d_222161762  = "Placeholder (Autogenerated)- Date/Time blood/urine/mouthwash research survey completed" #   SrvBLM_TmComplete_v1r0
)
###to convert to categorical variables
recrver1$RcrtSI_RecruitType_v1r0 <- factor(recrver1$d_512820379, exclude=NULL)
recrver1$RcrtV_Verification_v1r0 <- factor(recrver1$d_821247024, exclude=NULL)
recrver1$BioFin_BaseMWCol_v1r0  <-factor(recrver1$d_684635302,exclude=NULL)
recrver1$BioFin_BaseBloodCol_v1r0 <- factor(recrver1$d_878865966,exclude=NULL)
recrver1$BioFin_BaseUrineCol_v1r0 <- factor(recrver1$d_167958071,exclude=NULL)

recrver1$BioClin_BldOrderPlaced_v1r0 <- factor(recrver1$d_173836415_d_266600170_d_530173840,exclude=NULL) ## I ADDED

recrver1$SrvBLM_ResSrvCompl_v1r0 <-factor(recrver1$d_265193023,exclude=NULL)
recrver1$BL_BioSpm_MWSetting_v1r0 <- factor(recrver1$d_173836415_d_266600170_d_915179629,levels=c("Clinical","Research","Home"))  
recrver1$BL_BioSpm_UrineSetting_v1r0 <- factor(recrver1$d_173836415_d_266600170_d_718172863, levels=c("Clinical","Research","Home"))  
recrver1$BL_BioSpm_BloodSetting_v1r0 <- factor(recrver1$d_173836415_d_266600170_d_592099155,levels=c("Clinical","Research","Home"))  
recrver1$BL_BioChk_Complete_v1r0 <- factor(recrver1$d_331584571_d_266600170_d_135591601,exclude=NULL)
recrver1$Site <-factor(recrver1$d_827220437,levels=c("HealthPartners", "Henry Ford Health System","Marshfield Clinic Health System",
                             "Sanford Health", "University of Chicago Medicine","Kaiser Permanente Colorado",
                             "Kaiser Permanente Georgia","Kaiser Permanente Hawaii","Kaiser Permanente Northwest",
                             "National Cancer Institute","Other"))
recrver1<- recrver1 %>% mutate(BldCollection = ifelse(recrver1$BioFin_BaseBloodCol_v1r0 == 353358909, "YES", "No"))

##to update the censoring time based on Kelsey's request to be consistent with the weekly log: from Monday to Sunday
veristart.date = as.Date(min(as.POSIXct(recr.bio$d_914594314),na.rm=TRUE))
veristart.date + days(5)
#[1] "2021-08-01"
recrver1$verified.week <- ceiling(as.numeric(difftime(as.Date(ymd_hms(recrver1$d_914594314)),as.Date(veristart.date-days(2)),units="days"))/7)
recrver1$verified.Sunday.date <- veristart.date + days(5)+ dweeks(recrver1$verified.week-1)



##to check the duplicate collection by verified participants Connect_ID
biospe[duplicated(biospe$Connect_ID),c("Connect_ID","d_820476880","d_410912345","d_387108065")]
biospe[duplicated(biospe$Connect_ID),"Connect_ID"]
biospe$Connect_ID[duplicated(biospe$Connect_ID)]
dupid <- biospe$Connect_ID[duplicated(biospe$Connect_ID)]
#biospe[which(biospe$Connect_ID %in% dupid),c("Connect_ID","d_820476880","d_410912345","d_387108065","d_143615646_d_593843561","d_973670172_d_593843561")]
##the biospecimen concepts for the biospecimen variablesbles
biospe_var <- as.data.frame((colnames(biospe)))
colnames(biospe_var)[1] <- "variable"
biospe_var$cid1 <- sapply(strsplit(colnames(biospe),"_"), "[", 2)
biospe_var$cid2 <- sapply(strsplit(colnames(biospe),"_"), "[", 4)
biospe_var$cid3 <- sapply(strsplit(colnames(biospe),"_"), "[", 6)
biospe_var$cid_tail <- sapply(strsplit(colnames(biospe),"_"), tail,1)
biospe_CID <- dd[which(dd$CID %in% CID),]
biospe_dd<- base::merge(biospe_var,biospe_CID,by.x="cid_tail",by.y="CID", all.x=TRUE)
tubes <- dd[grepl(" Tube ",dd$`Variable Label`),]
urine <- dd[grepl("Urine",dd$`Variable Label`),]
mouthwash <- dd[grepl("Mouthwash",dd$`Variable Label`),]



```


```{r Table28a, echo=FALSE, warning=FALSE}

#need to make all BPTL 11:30 for consistency purposes of tables 3 & 4


str_sub(biospe$d_143615646_d_926457119,12,24)[!is.na(biospe$d_143615646_d_926457119)] <- "11:30:00.000Z"
str_sub(biospe$d_232343615_d_926457119,12,24)[!is.na(biospe$d_232343615_d_926457119)] <- "11:30:00.000Z"
str_sub(biospe$d_299553921_d_926457119,12,24)[!is.na(biospe$d_299553921_d_926457119)] <- "11:30:00.000Z"
str_sub(biospe$d_376960806_d_926457119,12,24)[!is.na(biospe$d_376960806_d_926457119)] <- "11:30:00.000Z"
str_sub(biospe$d_454453939_d_926457119,12,24)[!is.na(biospe$d_454453939_d_926457119)] <- "11:30:00.000Z"
str_sub(biospe$d_505347689_d_926457119,12,24)[!is.na(biospe$d_505347689_d_926457119)] <- "11:30:00.000Z"
str_sub(biospe$d_589588440_d_926457119,12,24)[!is.na(biospe$d_589588440_d_926457119)] <- "11:30:00.000Z"
str_sub(biospe$d_652357376_d_926457119,12,24)[!is.na(biospe$d_652357376_d_926457119)] <- "11:30:00.000Z"
str_sub(biospe$d_677469051_d_926457119,12,24)[!is.na(biospe$d_677469051_d_926457119)] <- "11:30:00.000Z"
str_sub(biospe$d_683613884_d_926457119,12,24)[!is.na(biospe$d_683613884_d_926457119)] <- "11:30:00.000Z"
str_sub(biospe$d_703954371_d_926457119,12,24)[!is.na(biospe$d_703954371_d_926457119)] <- "11:30:00.000Z"
str_sub(biospe$d_838567176_d_926457119,12,24)[!is.na(biospe$d_838567176_d_926457119)] <- "11:30:00.000Z"
str_sub(biospe$d_958646668_d_926457119,12,24)[!is.na(biospe$d_958646668_d_926457119)] <- "11:30:00.000Z"
str_sub(biospe$d_973670172_d_926457119,12,24)[!is.na(biospe$d_973670172_d_926457119)] <- "11:30:00.000Z"

#RESEARCH 
biospe_adhoc= biospe %>%  filter(d_650516960==534621077 & d_410912345==353358909 & !is.na(d_678166505) & 
                                   #BPTL not null
                             (!is.na(d_143615646_d_926457119) | !is.na(d_232343615_d_926457119) | !is.na(d_299553921_d_926457119) | !is.na(d_376960806_d_926457119) |
                                !is.na(d_454453939_d_926457119) | !is.na(d_505347689_d_926457119) | !is.na(d_589588440_d_926457119) | !is.na(d_652357376_d_926457119) |
                                !is.na(d_677469051_d_926457119) | !is.na(d_683613884_d_926457119) | !is.na(d_703954371_d_926457119) | !is.na(d_838567176_d_926457119) |
                                !is.na(d_958646668_d_926457119) | !is.na(d_973670172_d_926457119))) %>% 
                     mutate(Site_location = case_when(d_951355211==777644826 ~ "UC-DCAM",
                                                      d_951355211==145191545 ~ "Ingalls Harvey",
                                                      d_951355211==489380324 ~ "River East",
                                                      d_951355211==120264574 ~ "South Loop",
                                                      d_951355211==834825425 ~ "HP Research Clinic",
                                                      d_951355211==736183094 ~ "HFH K-13 Research Clinic",
                                                      d_951355211==886364332 ~ "HFH Cancer Pavilion Research Clinic",
                                                      d_951355211==706927479 ~ "HFH Livonia Research Clinic",
                                                      d_951355211==692275326 ~ "Marshfield",
                                                      d_951355211==813701399 ~ "Weston",
                                                      d_951355211==698283667 ~ "Lake Hallie",
                                                      d_951355211==691714762 ~ "Rice Lake",
                                                      d_951355211==487512085 ~ "Wisconsin Rapids",
                                                      d_951355211==983848564 ~ "Colby Abbotsford",
                                                      d_951355211==261931804 ~ "Minocqua",
                                                      d_951355211==665277300 ~ "Merrill",
                                                      d_951355211==589224449 ~ "Sioux Falls Imagenetics",
                                                      d_951355211==467088902 ~ "Fargo South University",
                                                      d_951355211==834825425 ~ "HP Research Clinic",
                                                      d_951355211==567969985 ~ "MF Pop-Up",
                                                      d_951355211==319518299 ~ "UCM Pop-Up",
                                                      d_951355211==940329442 ~ "Orland Park"),
                            Site = case_when(d_827220437==548392715 ~ "Henry Ford",
                                                  d_827220437==531629870 ~ "HealthPartners",
                                                  d_827220437==303349821 ~ "Marshfield",
                                                  d_827220437==657167265 ~ "Sanford",
                                                  d_827220437==809703864 ~ "UChicago",
                                             TRUE ~ "Remove"))

#biospe_adhoc$Site_location<- droplevels(biospe_adhoc$Site_location)
biospe_adhoc$Site_location <- factor(biospe_adhoc$Site_location,levels=c("HP Research Clinic","HFH K-13 Research Clinic","HFH Cancer Pavilion Research Clinic", 
                                                                         "HFH Livonia Research Clinic","Marshfield", "MF Pop-Up",
                                                                         "Weston","Lake Hallie", "Rice Lake","Wisconsin Rapids", 
                                                                         "Colby Abbotsford","Minocqua","Merrill","Sioux Falls Imagenetics","Fargo South University",
                                                                         "Ingalls Harvey", "River East","South Loop","UCM Pop-Up","UC-DCAM","Orland Park")) 

coll_bptl_diff <- biospe_adhoc  %>% group_by(as.character(Connect_ID),Site, Site_location) %>% 
  mutate(any_collection = min(d_143615646_d_926457119, d_232343615_d_926457119, d_299553921_d_926457119, d_376960806_d_926457119, d_454453939_d_926457119, d_505347689_d_926457119, d_589588440_d_926457119, d_652357376_d_926457119, d_677469051_d_926457119, d_683613884_d_926457119, d_703954371_d_926457119, d_838567176_d_926457119, d_958646668_d_926457119, d_973670172_d_926457119, na.rm=T),
         day_past = difftime(as.Date(any_collection), as.Date(d_678166505), units="days"),
         coll_days_diff = ifelse(as.numeric(day_past)<2,"1 Day",ifelse(as.numeric(day_past)<3,"2 Days",ifelse(as.numeric(day_past)<4,"3 Days", ifelse(as.numeric(day_past)<5,"4 Days", ">4 Days")))))


coll_bptl_diff$Connect_ID <- as.numeric(coll_bptl_diff$`as.character(Connect_ID)`)

table.coll_bptl_28a <- ctable(coll_bptl_diff$Site,coll_bptl_diff$coll_days_diff)
crosstable.coll_bptl28a <- as.data.frame(cbind(table.coll_bptl_28a$cross_table,table.coll_bptl_28a$proportions))
#crosstable.coll_bptl28a$UC_Sites <-trimws(rownames(crosstable.coll_bptl28a))
#crosstable.coll_bptl28$UC_Sites<- droplevels(crosstable.coll_bptl28$UC_Sites)
crosstable.coll_bptl28a <- crosstable.coll_bptl28a[c(1:5),]
crosstable.coll_bptl28a$Site <- list("HealthPartners", "Henry Ford Health", "Marshfield", "Sanford Health", "University of Chicago")

#crosstable.coll_bptl28a <- crosstable.coll_bptl28a %>%  filter9

crosstable.coll_bptl28a$n_pct_1_Day <-  paste(format(crosstable.coll_bptl28a[,2],big.mark=","),"(", round(100*crosstable.coll_bptl28a[,8],1),"%)",sep=" ")
crosstable.coll_bptl28a$n_pct_2_Day <-  paste(format(crosstable.coll_bptl28a[,3],big.mark=","),"(", round(100*crosstable.coll_bptl28a[,9],1),"%)",sep=" ")
crosstable.coll_bptl28a$n_pct_3_Day <-  paste(format(crosstable.coll_bptl28a[,4],big.mark=","),"(", round(100*crosstable.coll_bptl28a[,10],1),"%)",sep=" ")
crosstable.coll_bptl28a$n_pct_4_Day <-  paste(format(crosstable.coll_bptl28a[,5],big.mark=","),"(", round(100*crosstable.coll_bptl28a[,11],1),"%)",sep=" ")
crosstable.coll_bptl28a$n_pct_4_plus_days =  paste(format(crosstable.coll_bptl28a[,1],big.mark=","),"(", round(100*crosstable.coll_bptl28a[,7],1),"%)",sep=" ")
crosstable.coll_bptl28a$Total <- paste(crosstable.coll_bptl28a$Total, " (100%)")
#nrow(crosstable.coll_bptl28a)

         
crosstable.coll_bptl28a <- crosstable.coll_bptl28a[,c(13:18,6)]


crosstable.coll_bptl28a[6,] <- list('Total', sum(as.numeric(gsub(",", "", str_extract(crosstable.coll_bptl28a[,2], "\\b\\d{1,4}(,\\d{3})*(?=\\s*\\()")))),
                                    sum(as.numeric(gsub(",", "", str_extract(crosstable.coll_bptl28a[,3], "\\b\\d{1,4}(,\\d{3})*(?=\\s*\\()")))),
                                    sum(as.numeric(gsub(",", "", str_extract(crosstable.coll_bptl28a[,4], "\\b\\d{1,4}(,\\d{3})*(?=\\s*\\()")))),
                                    sum(as.numeric(gsub(",", "", str_extract(crosstable.coll_bptl28a[,5], "\\b\\d{1,4}(,\\d{3})*(?=\\s*\\()")))),
                                    sum(as.numeric(gsub(",", "", str_extract(crosstable.coll_bptl28a[,6], "\\b\\d{1,4}(,\\d{3})*(?=\\s*\\()")))),
                                    sum(as.numeric(gsub(",", "", str_extract(crosstable.coll_bptl28a[,7], "\\b\\d{1,4}(,\\d{3})*(?=\\s*\\()")))))

crosstable.coll_bptl28a[6,2] <- paste(crosstable.coll_bptl28a[6,2], "(",round(100*as.numeric(crosstable.coll_bptl28a[6,2])/as.numeric(crosstable.coll_bptl28a[6,7]), digits=1), "%)")
crosstable.coll_bptl28a[6,3] <- paste(crosstable.coll_bptl28a[6,3], "(",round(100*as.numeric(crosstable.coll_bptl28a[6,3])/as.numeric(crosstable.coll_bptl28a[6,7]), digits=1), "%)")
crosstable.coll_bptl28a[6,4] <- paste(crosstable.coll_bptl28a[6,4], "(",round(100*as.numeric(crosstable.coll_bptl28a[6,4])/as.numeric(crosstable.coll_bptl28a[6,7]), digits=1), "%)")
crosstable.coll_bptl28a[6,5] <- paste(crosstable.coll_bptl28a[6,5], "(",round(100*as.numeric(crosstable.coll_bptl28a[6,5])/as.numeric(crosstable.coll_bptl28a[6,7]), digits=1), "%)")
crosstable.coll_bptl28a[6,6] <- paste(crosstable.coll_bptl28a[6,6], "(",round(100*as.numeric(crosstable.coll_bptl28a[6,6])/as.numeric(crosstable.coll_bptl28a[6,7]), digits=1), "%)")
crosstable.coll_bptl28a[6,7] <- paste(crosstable.coll_bptl28a[6,7], " (100%)")


knitr::kable(crosstable.coll_bptl28a, col.names=c("Site", "1 Day", "2 Days", "3 Days", "4 Day", ">4 Days", "Total"), caption='Table 28.a Research Biospecimen Collection to Receipt at BPTL (in Days) by Site', row.names=FALSE, align=c("l","c","c","c","c","c"), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down")



```



 
```{r Table28b, echo=FALSE, warning=FALSE}

# #need to make all BPTL 11:30 for consistency purposes of tables 3 & 4
# 
# 
# str_sub(biospe$d_143615646_d_926457119,12,24)[!is.na(biospe$d_143615646_d_926457119)] <- "11:30:00.000Z"
# str_sub(biospe$d_232343615_d_926457119,12,24)[!is.na(biospe$d_232343615_d_926457119)] <- "11:30:00.000Z"
# str_sub(biospe$d_299553921_d_926457119,12,24)[!is.na(biospe$d_299553921_d_926457119)] <- "11:30:00.000Z"
# str_sub(biospe$d_376960806_d_926457119,12,24)[!is.na(biospe$d_376960806_d_926457119)] <- "11:30:00.000Z"
# str_sub(biospe$d_454453939_d_926457119,12,24)[!is.na(biospe$d_454453939_d_926457119)] <- "11:30:00.000Z"
# str_sub(biospe$d_505347689_d_926457119,12,24)[!is.na(biospe$d_505347689_d_926457119)] <- "11:30:00.000Z"
# str_sub(biospe$d_589588440_d_926457119,12,24)[!is.na(biospe$d_589588440_d_926457119)] <- "11:30:00.000Z"
# str_sub(biospe$d_652357376_d_926457119,12,24)[!is.na(biospe$d_652357376_d_926457119)] <- "11:30:00.000Z"
# str_sub(biospe$d_677469051_d_926457119,12,24)[!is.na(biospe$d_677469051_d_926457119)] <- "11:30:00.000Z"
# str_sub(biospe$d_683613884_d_926457119,12,24)[!is.na(biospe$d_683613884_d_926457119)] <- "11:30:00.000Z"
# str_sub(biospe$d_703954371_d_926457119,12,24)[!is.na(biospe$d_703954371_d_926457119)] <- "11:30:00.000Z"
# str_sub(biospe$d_838567176_d_926457119,12,24)[!is.na(biospe$d_838567176_d_926457119)] <- "11:30:00.000Z"
# str_sub(biospe$d_958646668_d_926457119,12,24)[!is.na(biospe$d_958646668_d_926457119)] <- "11:30:00.000Z"
# str_sub(biospe$d_973670172_d_926457119,12,24)[!is.na(biospe$d_973670172_d_926457119)] <- "11:30:00.000Z"
# 
# #RESEARCH 
# biospe_adhoc= biospe %>%  filter(d_650516960==534621077 & d_410912345==353358909 & !is.na(d_556788178) & 
#                                    #BPTL not null
#                              (!is.na(d_143615646_d_926457119) | !is.na(d_232343615_d_926457119) | !is.na(d_299553921_d_926457119) | !is.na(d_376960806_d_926457119) |
#                                 !is.na(d_454453939_d_926457119) | !is.na(d_505347689_d_926457119) | !is.na(d_589588440_d_926457119) | !is.na(d_652357376_d_926457119) |
#                                 !is.na(d_677469051_d_926457119) | !is.na(d_683613884_d_926457119) | !is.na(d_703954371_d_926457119) | !is.na(d_838567176_d_926457119) |
#                                 !is.na(d_958646668_d_926457119) | !is.na(d_973670172_d_926457119))) %>% 
#                      mutate(Site_location = case_when(d_951355211==777644826 ~ "UC-DCAM",
#                                                       d_951355211==145191545 ~ "Ingalls Harvey",
#                                                       d_951355211==489380324 ~ "River East",
#                                                       d_951355211==120264574 ~ "South Loop",
#                                                       d_951355211==834825425 ~ "HP Research Clinic",
#                                                       d_951355211==736183094 ~ "HFH K-13 Research Clinic",
#                                                       d_951355211==886364332 ~ "HFH Cancer Pavilion Research Clinic",
#                                                       d_951355211==706927479 ~ "HFH Livonia Research Clinic",
#                                                       d_951355211==692275326 ~ "Marshfield",
#                                                       d_951355211==813701399 ~ "Weston",
#                                                       d_951355211==698283667 ~ "Lake Hallie",
#                                                       d_951355211==691714762 ~ "Rice Lake",
#                                                       d_951355211==487512085 ~ "Wisconsin Rapids",
#                                                       d_951355211==983848564 ~ "Colby Abbotsford",
#                                                       d_951355211==261931804 ~ "Minocqua",
#                                                       d_951355211==665277300 ~ "Merrill",
#                                                       d_951355211==589224449 ~ "Sioux Falls Imagenetics",
#                                                       d_951355211==467088902 ~ "Fargo South University",
#                                                       d_951355211==834825425 ~ "HP Research Clinic",
#                                                       d_951355211==567969985 ~ "MF Pop-Up",
#                                                       d_951355211==319518299 ~ "UCM Pop-Up",
#                                                       d_951355211==940329442 ~ "Orland Park"),
#                             Site = case_when(d_827220437==548392715 ~ "Henry Ford",
#                                                   d_827220437==531629870 ~ "HealthPartners",
#                                                   d_827220437==303349821 ~ "Marshfield",
#                                                   d_827220437==657167265 ~ "Sanford",
#                                                   d_827220437==809703864 ~ "UChicago",
#                                              TRUE ~ "Remove"))
# 
# #biospe_adhoc$Site_location<- droplevels(biospe_adhoc$Site_location)
# biospe_adhoc$Site_location <- factor(biospe_adhoc$Site_location,levels=c("HP Research Clinic","HFH K-13 Research Clinic","HFH Cancer Pavilion Research Clinic", "HFH Livonia Research Clinic","Marshfield", "MF Pop-Up",
#                                                                          "Weston","Lake Hallie", "Rice Lake","Wisconsin Rapids", "Colby Abbotsford","Minocqua","Merrill","Sioux Falls Imagenetics","Fargo South University",
#                                                                          "Ingalls Harvey", "River East","South Loop","UCM Pop-Up","UC-DCAM","Orland Park")) 
# 
# coll_bptl_diff <- biospe_adhoc  %>% group_by(as.character(Connect_ID),Site, Site_location) %>% 
#   mutate(any_collection = min(d_143615646_d_926457119, d_232343615_d_926457119, d_299553921_d_926457119, d_376960806_d_926457119, d_454453939_d_926457119, d_505347689_d_926457119, d_589588440_d_926457119, d_652357376_d_926457119, d_677469051_d_926457119, d_683613884_d_926457119, d_703954371_d_926457119, d_838567176_d_926457119, d_958646668_d_926457119, d_973670172_d_926457119, na.rm=T),
#          day_past = difftime(as.Date(any_collection), as.Date(d_556788178), units="days"),
#          coll_days_diff = ifelse(as.numeric(day_past)<2,"1 Day",ifelse(as.numeric(day_past)<3,"2 Days",ifelse(as.numeric(day_past)<4,"3 Days", ifelse(as.numeric(day_past)<5,"4 Days", ">4 Days")))))
# 
# 
# coll_bptl_diff$Connect_ID <- as.numeric(coll_bptl_diff$`as.character(Connect_ID)`)

table.coll_bptl <- ctable(coll_bptl_diff$Site_location,coll_bptl_diff$coll_days_diff)
crosstable.coll_bptl28 <- as.data.frame(cbind(table.coll_bptl$cross_table,table.coll_bptl$proportions))
crosstable.coll_bptl28$UC_Sites <-trimws(rownames(crosstable.coll_bptl28))
#crosstable.coll_bptl28$UC_Sites<- droplevels(crosstable.coll_bptl28$UC_Sites)

crosstable.coll_bptl28$n_pct_1_Day <-  paste(format(crosstable.coll_bptl28[,2],big.mark=","),"(", round(100*crosstable.coll_bptl28[,8],1),"%)",sep=" ")
crosstable.coll_bptl28$n_pct_2_Day <-  paste(format(crosstable.coll_bptl28[,3],big.mark=","),"(", round(100*crosstable.coll_bptl28[,9],1),"%)",sep=" ")
crosstable.coll_bptl28$n_pct_3_Day <-  paste(format(crosstable.coll_bptl28[,4],big.mark=","),"(", round(100*crosstable.coll_bptl28[,10],1),"%)",sep=" ")
crosstable.coll_bptl28$n_pct_4_Day <-  paste(format(crosstable.coll_bptl28[,5],big.mark=","),"(", round(100*crosstable.coll_bptl28[,11],1),"%)",sep=" ")
crosstable.coll_bptl28$n_pct_4_plus_days =  paste(format(crosstable.coll_bptl28[,1],big.mark=","),"(", round(100*crosstable.coll_bptl28[,7],1),"%)",sep=" ")
crosstable.coll_bptl28$Total <- paste(crosstable.coll_bptl28$Total, " (100%)")
#nrow(crosstable.coll_bptl28)

         
crosstable.coll_bptl28 <- crosstable.coll_bptl28[,c(13:18,6)]


coll_bplt_knitr <- knitr::kable(crosstable.coll_bptl28, col.names=c("Collection Location", "1 Day", "2 Days", "3 Days", "4 Day", ">4 Days", "Total"), caption='Table 28.b Research Biospecimen Collection to Receipt at BPTL (in Days) by Collection Location', row.names=FALSE, align=c("l","c","c","c","c","c"), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down") 

coll_bplt_knitr <- group_rows(
  coll_bplt_knitr,
  group_label = "HealtPartners",
  start_row = 1,
  end_row = 1)  
coll_bplt_knitr <- group_rows(
  coll_bplt_knitr,
  group_label = "Henry Ford Health",
  start_row = 2,
  end_row = 4) 
coll_bplt_knitr <- group_rows(
  coll_bplt_knitr,
  group_label = "Marshfield",
  start_row = 5,
  end_row = 13) 
coll_bplt_knitr <- group_rows(
  coll_bplt_knitr,
  group_label = "Sanford Health",
  start_row = 14,
  end_row = 15)
coll_bplt_knitr <- group_rows(
  coll_bplt_knitr,
  group_label = "University of Chicago",
  start_row = 16,
  end_row = 21)

coll_bplt_knitr

```




```{r, Table29, warning=FALSE, eval=TRUE,echo=FALSE, include=FALSE}

table2_col_bplt <- recrver1 %>% select(Connect_ID, d_173836415_d_266600170_d_185243482, d_173836415_d_266600170_d_452847912, d_173836415_d_266600170_d_822274939, d_173836415_d_266600170_d_139245758)
table2_col_bplt$Connect_ID <- as.numeric(table2_col_bplt$Connect_ID)
biospe$Connect_ID <- as.numeric(biospe$Connect_ID)
table2 <- left_join(biospe, table2_col_bplt, by="Connect_ID")

biospe_adhoc2= table2 %>%  filter(d_650516960==664882224 & d_410912345==353358909  & #clinical and finalized collections
                                   #SiteBlLocatBL / SiteUrLocatBL
                                   (!is.na(d_173836415_d_266600170_d_185243482) | !is.na(d_173836415_d_266600170_d_452847912)) & 
                                   #ClinBloodTmBL/ ClinUrnieTmBL 
                                   (!is.na(d_173836415_d_266600170_d_822274939) | !is.na(d_173836415_d_266600170_d_139245758)) & 
                                   #BioBPTL_DateRec_v1r0 blood or urine
                             (!is.na(d_232343615_d_926457119) | !is.na(d_299553921_d_926457119) | !is.na(d_376960806_d_926457119) |
                                !is.na(d_454453939_d_926457119) | !is.na(d_505347689_d_926457119) | !is.na(d_589588440_d_926457119) | !is.na(d_652357376_d_926457119) |
                                !is.na(d_677469051_d_926457119) | !is.na(d_683613884_d_926457119) | !is.na(d_703954371_d_926457119) | !is.na(d_838567176_d_926457119) |
                                !is.na(d_958646668_d_926457119) | !is.na(d_973670172_d_926457119))) %>%  
                     mutate(Site_location = case_when(d_173836415_d_266600170_d_185243482==1 | d_173836415_d_266600170_d_452847912==1 ~ "NSC",
                                                      d_173836415_d_266600170_d_185243482==2 | d_173836415_d_266600170_d_452847912==2 ~ "Elk River",
                                                      d_173836415_d_266600170_d_185243482==3 | d_173836415_d_266600170_d_452847912==3 ~ "Chanhassen",
                                                      d_173836415_d_266600170_d_185243482==22 | d_173836415_d_266600170_d_452847912==22 |
                                                      d_173836415_d_266600170_d_185243482==24 | d_173836415_d_266600170_d_452847912==24 |
                                                      d_173836415_d_266600170_d_185243482==28 | d_173836415_d_266600170_d_452847912==28 |
                                                      d_173836415_d_266600170_d_185243482==33 | d_173836415_d_266600170_d_452847912==33 |
                                                      d_173836415_d_266600170_d_185243482==34 | d_173836415_d_266600170_d_452847912==34 |
                                                      d_173836415_d_266600170_d_185243482==35 | d_173836415_d_266600170_d_452847912==35 |
                                                        d_173836415_d_266600170_d_185243482==38 | d_173836415_d_266600170_d_452847912==38 |
                                                        d_173836415_d_266600170_d_185243482==40 | d_173836415_d_266600170_d_452847912==40 |
                                                        d_173836415_d_266600170_d_185243482==55 | d_173836415_d_266600170_d_452847912==55 |
                                                      d_173836415_d_266600170_d_185243482==71 | d_173836415_d_266600170_d_452847912==71 ~ "Oahu Clinics",
                                                      d_173836415_d_266600170_d_185243482==23 | d_173836415_d_266600170_d_452847912==23 |
                                                      d_173836415_d_266600170_d_185243482==26 | d_173836415_d_266600170_d_452847912==26 |
                                                      d_173836415_d_266600170_d_185243482==27 | d_173836415_d_266600170_d_452847912==27 |
                                                      d_173836415_d_266600170_d_185243482==32 | d_173836415_d_266600170_d_452847912==32 |
                                                        d_173836415_d_266600170_d_185243482==37 | d_173836415_d_266600170_d_452847912==37 |
                                                        d_173836415_d_266600170_d_185243482==49 | d_173836415_d_266600170_d_452847912==49 |
                                                        d_173836415_d_266600170_d_185243482==56 | d_173836415_d_266600170_d_452847912==56 |
                                                      d_173836415_d_266600170_d_185243482==69 | d_173836415_d_266600170_d_452847912==69 ~ "Non-Oahu Clinics",
                       d_173836415_d_266600170_d_185243482==1050010095 | d_173836415_d_266600170_d_452847912==1050010095 ~ "Wyandotte",
                       d_173836415_d_266600170_d_185243482==1060010063 | d_173836415_d_266600170_d_185243482==1060170018 |
                         d_173836415_d_266600170_d_452847912==1060010063 | d_173836415_d_266600170_d_452847912==1060170018~ "Macomb",
                       d_173836415_d_266600170_d_185243482==1040010047 | d_173836415_d_266600170_d_185243482==1040010046 |
                         d_173836415_d_266600170_d_185243482==1011220006 |
                         d_173836415_d_266600170_d_452847912==1040010047 | d_173836415_d_266600170_d_452847912==1040010046 |
                         d_173836415_d_266600170_d_452847912==1011220006 ~ "West Bloomfield",
                       d_173836415_d_266600170_d_185243482==1011410008 | d_173836415_d_266600170_d_452847912==1011410008 ~ "Royal Oak",
                       d_173836415_d_266600170_d_185243482 ==1010180040 |d_173836415_d_266600170_d_452847912 ==1010180040 ~ "Fairlane (Dearborn)",
                       d_173836415_d_266600170_d_185243482==1010120026 | d_173836415_d_266600170_d_452847912==1010120026 ~ "Columbus",
                       d_173836415_d_266600170_d_185243482==1011660013  | d_173836415_d_266600170_d_452847912==1011660013 ~ "Plymouth",
                       d_173836415_d_266600170_d_185243482==1010360011 | d_173836415_d_266600170_d_452847912==1010360011 ~ "Troy",
                       d_173836415_d_266600170_d_185243482==1010350019 ~ "Taylor",
                       d_173836415_d_266600170_d_185243482==1010240013 | d_173836415_d_266600170_d_452847912==1010240013 ~ "Livonia",
                       d_173836415_d_266600170_d_185243482==1010320019 | d_173836415_d_266600170_d_452847912==1010320019 ~ "Sterling Heights",
                       d_173836415_d_266600170_d_185243482==1010010193 | d_173836415_d_266600170_d_452847912==1010010114 |
                         d_173836415_d_266600170_d_452847912==1010010193 | d_173836415_d_266600170_d_452847912==1010010114~ "K1 HFH Main",
                                        d_827220437==327912200 ~ "Kaiser Permanente Georgia",
                                        d_827220437==452412599 ~ "Kaiser Permanente Northwest",
                                        d_827220437==125001209 ~ "Kaiser Permanente Colorado",
                       TRUE ~ "Remove"),
                       Site = case_when(d_827220437==548392715 ~ "Henry Ford",
                                        d_827220437==531629870 ~ "HealthPartners",
                                        d_827220437==300267574 ~ "Kaiser Permanente Hawaii",
                                        d_827220437==327912200 ~ "Kaiser Permanente Georgia",
                                        d_827220437==452412599 ~ "Kaiser Permanente Northwest",
                                        d_827220437==125001209 ~ "Kaiser Permanente Colorado",
                                        TRUE ~ "Remove"))
biospe_adhoc2 <- biospe_adhoc2 %>%  filter(Site_location!="Remove" & Site!="Remove")
biospe_adhoc2$Site_location <- factor(biospe_adhoc2$Site_location,levels=c("Macomb","West Bloomfield","Wyandotte","Fairlane (Dearborn)","Plymouth", "Royal Oak","Troy", "Taylor",
                                                  "K1 HFH Main","Sterling Heights","Columbus", "Livonia" , "Chanhassen", "Elk River", "Kaiser Permanente Colorado", 
                                                  "Kaiser Permanente Georgia", "Oahu Clinics", "Non-Oahu Clinics", "Kaiser Permanente Northwest")) 


coll_bptl_diff2 <- biospe_adhoc2  %>% group_by(as.character(Connect_ID),Site, Site_location) %>% 
  mutate(any_collection = min(d_232343615_d_926457119, d_299553921_d_926457119, d_376960806_d_926457119, d_454453939_d_926457119, d_505347689_d_926457119,
                              d_589588440_d_926457119, d_652357376_d_926457119, d_677469051_d_926457119, d_683613884_d_926457119, d_703954371_d_926457119,
                              d_838567176_d_926457119, d_958646668_d_926457119, d_973670172_d_926457119, na.rm=T),
         clin_coll_bu = min(d_173836415_d_266600170_d_822274939, d_173836415_d_266600170_d_139245758, na.rm=T),
         day_past = difftime(as.Date(any_collection), as.Date(clin_coll_bu), units="days"),
         coll_days_diff = ifelse(as.numeric(day_past)<2,"1 Day",ifelse(as.numeric(day_past)<3,"2 Days",ifelse(as.numeric(day_past)<4,"3 Days", ifelse(as.numeric(day_past)<5,"4 Days", ">4 Days")))))
#don't know how this is happening but needs to be included for now
coll_bptl_diff2 <- coll_bptl_diff2 %>% filter(!is.na(coll_days_diff))

coll_bptl_diff2$Connect_ID <- as.numeric(coll_bptl_diff2$`as.character(Connect_ID)`)

table.coll_bptl2 <- ctable(coll_bptl_diff2$Site_location,coll_bptl_diff2$coll_days_diff)
crosstable.coll_bptl2 <- as.data.frame(cbind(table.coll_bptl2$cross_table,table.coll_bptl2$proportions))
crosstable.coll_bptl2$location <-trimws(rownames(crosstable.coll_bptl2))


crosstable.coll_bptl2$n_pct_1_Day <-  paste(format(crosstable.coll_bptl2[,2],big.mark=","),"(", round(100*crosstable.coll_bptl2[,8],1),"%)",sep=" ")
crosstable.coll_bptl2$n_pct_2_Day <-  paste(format(crosstable.coll_bptl2[,3],big.mark=","),"(", round(100*crosstable.coll_bptl2[,9],1),"%)",sep=" ")
crosstable.coll_bptl2$n_pct_3_Day <-  paste(format(crosstable.coll_bptl2[,4],big.mark=","),"(", round(100*crosstable.coll_bptl2[,10],1),"%)",sep=" ")
crosstable.coll_bptl2$n_pct_4_Day <-  paste(format(crosstable.coll_bptl2[,5],big.mark=","),"(", round(100*crosstable.coll_bptl2[,11],1),"%)",sep=" ")
crosstable.coll_bptl2$n_pct_4_plus_days =  paste(format(crosstable.coll_bptl2[,1],big.mark=","),"(", round(100*crosstable.coll_bptl2[,7],1),"%)",sep=" ")
crosstable.coll_bptl2$Totals <- paste(crosstable.coll_bptl2$Total, " (100%)")
#nrow(crosstable.coll_bptl2)
crosstable.coll_bptl2$Count <- 1:as.numeric(dim(crosstable.coll_bptl2)[[1]])

#crosstable.coll_bptl_2 <- crosstable.coll_bptl2[, c("Count", "location", "n_pct_1_Day", "n_pct_2_Day", "n_pct_3_Day", "n_pct_4_Day", "n_pct_4_plus_days", "Totals")]
         
crosstable.coll_bptl_2 <- crosstable.coll_bptl2[,c("location","n_pct_1_Day", "n_pct_2_Day", "n_pct_3_Day", "n_pct_4_Day", "n_pct_4_plus_days", "Totals")]

#crosstable.coll_bptl21 %>% gt(groupname_col = "Site")



library(kableExtra)


coll_bplt_knitr2 <- knitr::kable(crosstable.coll_bptl_2, col.names=c("Collection Location", "1 Day", "2 Days", "3 Days", "4 Days", ">4 Days", "Total"), caption='Table 29. Clinical Biospecimen Collection to Receipt at BPTL (in Days) by Clinic Location', row.names=FALSE, align=c("l","c","c","c","c","c","c"), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down") 

coll_bplt_knitr2 <- group_rows(
  coll_bplt_knitr2,
  group_label = "Henry Ford Health",
  start_row = 1,
  end_row = 12)
coll_bplt_knitr2 <- group_rows(
  coll_bplt_knitr2,
  group_label = "HealthPartners",
  start_row = 13,
  end_row = 14)
coll_bplt_knitr2 <- group_rows(
  coll_bplt_knitr2,
  group_label = "Kaiser Permanente Colorado",
  start_row = 15,
  end_row = 15) 
coll_bplt_knitr2 <- group_rows(
  coll_bplt_knitr2,
  group_label = "Kaiser Permanente Georgia",
  start_row = 16,
  end_row = 16) 
coll_bplt_knitr2 <- group_rows(
  coll_bplt_knitr2,
  group_label = "Kaiser Permanente Hawaii",
  start_row = 17,
  end_row = 18) 
coll_bplt_knitr2 <- group_rows(
  coll_bplt_knitr2,
  group_label = "Kaiser Permanente Northwest",
  start_row = 19,
  end_row = 19) 

coll_bplt_knitr2


```


```{r Table30,  echo=FALSE, warning=FALSE}

#add one decimal place, even .0 for whole numbers
format_with_decimal <- function(x, digits = 1) {
  formatted_number <- sprintf("%0.1f", x)
  return(formatted_number)
}



coll_bptl_diff <- coll_bptl_diff %>% mutate(hrs_past = difftime(as.POSIXct(ymd_hms(any_collection)), as.POSIXct(ymd_hms(d_678166505)), units="hours"))
coll_bptl_diff$hrs_past <- as.numeric(coll_bptl_diff$hrs_past)
coll_bptl_diff<- coll_bptl_diff %>%  filter(hrs_past>0)
Hrs_bptl_col <- coll_bptl_diff %>% group_by(Site_location) %>% dplyr::summarise('Min' = format_with_decimal(min(hrs_past)),
                                                                                'Q1' = format_with_decimal(quantile(hrs_past, 0.25)),
                                                                                'Median' = format_with_decimal(median(hrs_past)),
                                                                                'Mean' = format_with_decimal(mean(hrs_past)),
                                                                                'Q3' = format_with_decimal(quantile(hrs_past, 0.75)),
                                                                                '90th' = format_with_decimal(quantile(hrs_past, 0.90)),
                                                                                '98th' = format_with_decimal(quantile(hrs_past, 0.98)))
#Hrs_bptl_col <- Hrs_bptl_col[c(5,2:4,7,9,8,10,16,17,12,1,6,11,13,14,15),]




coll_bplt_knitr3 <- knitr::kable(Hrs_bptl_col, col.names=c("Collection Location", 'Min', 'Q1', 'Median', 'Mean', 'Q3','Perc.90','Perc.98'), caption='Table 30. Time (in Hours) from Research Biospecimen Collection to Receipt at BPTL by Collection Location', row.names=FALSE, align=c("l","c","c","c","c","c","c","c","c"), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down") 



coll_bplt_knitr3 <- group_rows(
  coll_bplt_knitr3,
  group_label = "HealtPartners",
  start_row = 1,
  end_row = 1)  
coll_bplt_knitr3 <- group_rows(
  coll_bplt_knitr3,
  group_label = "Henry Ford Health",
  start_row = 2,
  end_row = 4) 
coll_bplt_knitr3 <- group_rows(
  coll_bplt_knitr3,
  group_label = "Marshfield",
  start_row = 5,
  end_row = 10) 
coll_bplt_knitr3 <- group_rows(
  coll_bplt_knitr3,
  group_label = "Sanford Health",
  start_row = 11,
  end_row = 12)
coll_bplt_knitr3 <- group_rows(
  coll_bplt_knitr3,
  group_label = "University of Chicago",
  start_row = 13,
  end_row = 18)


add_footnote(coll_bplt_knitr3, "Note: BPTL receipt time is assumed to be 11:30am ET.", notation = "none")



```



```{r Table31, warning=FALSE, eval=TRUE,echo=FALSE, include=FALSE}

coll_bptl_diff2 <- coll_bptl_diff2 %>% mutate(hrs_past = difftime(as.POSIXct(ymd_hms(any_collection)), as.POSIXct(ymd_hms(clin_coll_bu)), units="hours"))
coll_bptl_diff2$hrs_past <- as.numeric(coll_bptl_diff2$hrs_past)
Hrs_bptl_col4 <- coll_bptl_diff2 %>% group_by(Site_location) %>% dplyr::summarise('Min' = format_with_decimal(min(hrs_past)),
                                                                                'Q1' = format_with_decimal(quantile(hrs_past, 0.25)),
                                                                                'Median' = format_with_decimal(median(hrs_past)),
                                                                                'Mean' = format_with_decimal(mean(hrs_past)),
                                                                                'Q3' = format_with_decimal(quantile(hrs_past, 0.75)),
                                                                                '90' = format_with_decimal(quantile(hrs_past, 0.9)),
                                                                                '98' = format_with_decimal(quantile(hrs_past, 0.98)))


#Hrs_bptl_col4 <- Hrs_bptl_col4[c(8,15,16,2,11,12,14,3,13,1,7,4,5,10,9,6), ]

coll_bplt_knitr4 <- knitr::kable(Hrs_bptl_col4, col.names=c("Collection Location", 'Min', 'Q1', 'Median', 'Mean', 'Q3','Perc.90','Perc.98'), caption='Table 31. Time (in Hours) from Clinical Biospecimen Collection to Receipt at BPTL by Clinic Location', row.names=FALSE, align=c("l","c","c","c","c","c","c","c","c"), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down") 


coll_bplt_knitr4 <- group_rows(
  coll_bplt_knitr4,
  group_label = "Henry Ford Health",
  start_row = 1,
  end_row = 12)
coll_bplt_knitr4 <- group_rows(
  coll_bplt_knitr4,
  group_label = "HealthPartners",
  start_row = 13,
  end_row = 14)
coll_bplt_knitr4 <- group_rows(
  coll_bplt_knitr4,
  group_label = "Kaiser Permanente Colorado",
  start_row = 15,
  end_row = 15) 
coll_bplt_knitr4 <- group_rows(
  coll_bplt_knitr4,
  group_label = "Kaiser Permanente Georgia",
  start_row = 16,
  end_row = 16) 
coll_bplt_knitr4 <- group_rows(
  coll_bplt_knitr4,
  group_label = "Kaiser Permanente Hawaii",
  start_row = 17,
  end_row = 18) 
coll_bplt_knitr4 <- group_rows(
  coll_bplt_knitr4,
  group_label = "Kaiser Permanente Northwest",
  start_row = 19,
  end_row = 19) 


add_footnote(coll_bplt_knitr4, "Note: BPTL receipt time is assumed to be 11:30am ET.", notation = "none")


#coll_bptl_diff$Connect_ID[coll_bptl_diff$hrs_past>quantile(coll_bptl_diff$hrs_past, 0.99)]
#coll_bptl_diff2$Connect_ID[coll_bptl_diff2$hrs_past>quantile(coll_bptl_diff2$hrs_past, 0.99)]


```

\newpage
\FloatBarrier


```{r Figs6_14 , Plots, warning=FALSE, eval=TRUE,echo=FALSE}

coll_bptl_diff$Weekdays <- factor(weekdays(as.Date(coll_bptl_diff$d_678166505)))
coll_bptl_diff$Weekdays<- factor(coll_bptl_diff$Weekdays,levels=c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"))

coll_bptl_diff2$Weekdays <- factor(weekdays(as.Date(coll_bptl_diff2$clin_coll_bu)))
coll_bptl_diff2$Weekdays<- factor(coll_bptl_diff2$Weekdays,levels=c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"))

scatMF <- coll_bptl_diff %>%  filter(Site=="Marshfield")
scatSF <- coll_bptl_diff %>%  filter(Site=="Sanford")
scatUC <- coll_bptl_diff %>%  filter(Site=="UChicago")
scatKPCO <- coll_bptl_diff2 %>%  filter(Site=="Kaiser Permanente Colorado")
scatKPGA <- coll_bptl_diff2 %>%  filter(Site=="Kaiser Permanente Georgia")
scatKPHI <- coll_bptl_diff2 %>%  filter(Site=="Kaiser Permanente Hawaii")
scatKPNW <- coll_bptl_diff2 %>%  filter(Site=="Kaiser Permanente Northwest")

scatRHP <- coll_bptl_diff %>%  filter(Site=="HealthPartners")
scatCHP <- coll_bptl_diff2 %>%  filter(Site=="HealthPartners")

scatRHF <- coll_bptl_diff %>%  filter(Site=="Henry Ford")
scatCHF <- coll_bptl_diff2 %>%  filter(Site=="Henry Ford")




ggplot(scatMF, aes(x=as.Date(d_678166505), y=hrs_past, color = Weekdays)) + 
    geom_point() + scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", expand=c(0,0)) + 
  scale_y_continuous(name="Hours to BPTL Receipt",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  scale_color_manual(values=c("Sunday"="red", "Monday"="orange", "Tuesday"="pink", "Wednesday"="lightgreen", 
                     "Thursday"="blue", "Friday"="purple", "Saturday"="brown")) +
  theme(panel.background = element_blank(),         
        #legend.title = element_text(size=7),         
        legend.position = "bottom",        
        axis.line = element_line(size=0.2),        
        axis.text.x=element_text(angle=60, hjust=1), 
        axis.title.x = element_text( size = 14, face = "bold") ,         
        axis.title.y = element_text(size = 14, face = "bold",color="black"),         
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +     
  theme(plot.caption = element_text(hjust=0))  + ggtitle(label="Figure 6. Hours from Collection to BPTL Receipt, \n Marshfield")




ggplot(scatSF, aes(x=as.Date(d_678166505), y=hrs_past, color = Weekdays)) + 
    geom_point() + scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", expand=c(0,0)) + 
  scale_y_continuous(name="Hours to BPTL Receipt",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  scale_color_manual(values=c("Sunday"="red", "Monday"="orange", "Tuesday"="pink", "Wednesday"="lightgreen", 
                     "Thursday"="blue", "Friday"="purple", "Saturday"="brown")) +
    theme(panel.background = element_blank(),         
        #legend.title = element_text(size=7),         
        legend.position = "bottom",        
        axis.line = element_line(size=0.2),        
        axis.text.x=element_text(angle=60, hjust=1), 
        axis.title.x = element_text( size = 14, face = "bold") ,         
        axis.title.y = element_text(size = 14, face = "bold",color="black"),         
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +     
  theme(plot.caption = element_text(hjust=0))  +
  ggtitle(label="Figure 7. Hours from Collection to BPTL Receipt, \n Sanford Health")

ggplot(scatUC, aes(x=as.Date(d_678166505), y=hrs_past, color = Weekdays)) + 
    geom_point() + scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", expand=c(0,0)) + 
  scale_y_continuous(name="Hours to BPTL Receipt",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  scale_color_manual(values=c("Sunday"="red", "Monday"="orange", "Tuesday"="pink", "Wednesday"="lightgreen", 
                     "Thursday"="blue", "Friday"="purple", "Saturday"="brown")) +
    theme(panel.background = element_blank(),         
        #legend.title = element_text(size=7),         
        legend.position = "bottom",        
        axis.line = element_line(size=0.2),        
        axis.text.x=element_text(angle=60, hjust=1), 
        axis.title.x = element_text( size = 14, face = "bold") ,         
        axis.title.y = element_text(size = 14, face = "bold",color="black"),         
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +     
  theme(plot.caption = element_text(hjust=0))  +
  ggtitle(label="Figure 8. Hours from Collection to BPTL Receipt, \n University of Chicago Medicine")

ggplot(scatKPCO, aes(x=as.Date(clin_coll_bu), y=hrs_past, color = Weekdays)) + 
    geom_point() + scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", expand=c(0,0)) + 
  scale_y_continuous(name="Hours to BPTL Receipt",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  scale_color_manual(values=c("Sunday"="red", "Monday"="orange", "Tuesday"="pink", "Wednesday"="lightgreen", 
                     "Thursday"="blue", "Friday"="purple", "Saturday"="brown")) +
    theme(panel.background = element_blank(),         
        #legend.title = element_text(size=7),         
        legend.position = "bottom",        
        axis.line = element_line(size=0.2),        
        axis.text.x=element_text(angle=60, hjust=1), 
        axis.title.x = element_text( size = 14, face = "bold") ,         
        axis.title.y = element_text(size = 14, face = "bold",color="black"),         
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +     
  theme(plot.caption = element_text(hjust=0))  +
  ggtitle(label="Figure 9. Hours from Collection to BPTL Receipt, \n Kaiser Permanente Colorado")

ggplot(scatKPGA, aes(x=as.Date(clin_coll_bu), y=hrs_past, color = Weekdays)) + 
    geom_point() + scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", expand=c(0,0)) + 
  scale_y_continuous(name="Hours to BPTL Receipt",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  scale_color_manual(values=c("Sunday"="red", "Monday"="orange", "Tuesday"="pink", "Wednesday"="lightgreen", 
                     "Thursday"="blue", "Friday"="purple", "Saturday"="brown")) +
    theme(panel.background = element_blank(),         
        #legend.title = element_text(size=7),         
        legend.position = "bottom",        
        axis.line = element_line(size=0.2),        
        axis.text.x=element_text(angle=60, hjust=1), 
        axis.title.x = element_text( size = 14, face = "bold") ,         
        axis.title.y = element_text(size = 14, face = "bold",color="black"),         
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +     
  theme(plot.caption = element_text(hjust=0))  +
  ggtitle(label="Figure 10. Hours from Collection to BPTL Receipt, \n Kaiser Permanente Georgia")

ggplot(scatKPHI, aes(x=as.Date(clin_coll_bu), y=hrs_past, color = Weekdays)) + 
    geom_point() + scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", expand=c(0,0)) + 
  scale_y_continuous(name="Hours to BPTL Receipt",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  scale_color_manual(values=c("Sunday"="red", "Monday"="orange", "Tuesday"="pink", "Wednesday"="lightgreen", 
                     "Thursday"="blue", "Friday"="purple", "Saturday"="brown")) +
    theme(panel.background = element_blank(),         
        #legend.title = element_text(size=7),         
        legend.position = "bottom",        
        axis.line = element_line(size=0.2),        
        axis.text.x=element_text(angle=60, hjust=1), 
        axis.title.x = element_text( size = 14, face = "bold") ,         
        axis.title.y = element_text(size = 14, face = "bold",color="black"),         
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +     
  theme(plot.caption = element_text(hjust=0))  +
  ggtitle(label="Figure 11. Hours from Collection to BPTL Receipt, \n Kaiser Permanente Hawaii")

ggplot(scatKPNW, aes(x=as.Date(clin_coll_bu), y=hrs_past, color = Weekdays)) + 
    geom_point() + scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", expand=c(0,0)) + 
  scale_y_continuous(name="Hours to BPTL Receipt",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  scale_color_manual(values=c("Sunday"="red", "Monday"="orange", "Tuesday"="pink", "Wednesday"="lightgreen", 
                     "Thursday"="blue", "Friday"="purple", "Saturday"="brown")) +
    theme(panel.background = element_blank(),         
        #legend.title = element_text(size=7),         
        legend.position = "bottom",        
        axis.line = element_line(size=0.2),        
        axis.text.x=element_text(angle=60, hjust=1), 
        axis.title.x = element_text( size = 14, face = "bold") ,         
        axis.title.y = element_text(size = 14, face = "bold",color="black"),         
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +     
  theme(plot.caption = element_text(hjust=0))  +
  ggtitle(label="Figure 12. Hours from Collection to BPTL Receipt, \n Kaiser Permanente Northwest")



#HP
# Combine the data
scatRHP$coldate <- scatRHP$d_678166505
scatCHP$coldate <- scatCHP$clin_coll_bu
combined_dataHP <- rbind(cbind(scatRHP, Group = "Research"), cbind(scatCHP, Group = "Clinical"))

weekday_order <- c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday")


combined_plotHP <- ggplot(combined_dataHP, aes(x = as.Date(coldate), y = hrs_past, shape = Group, color = factor(weekdays(as.Date(coldate))))) +
  geom_point() +
  #scale_color_manual(values = c("Research" = "red", "Clinical" = "blue")) +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", expand=c(0,0)) +
  scale_y_continuous(name="Hours to BPTL Receipt",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  labs(color = "Weekdays", shape="Setting") +
  scale_color_manual(values=c("Sunday"="red", "Monday"="orange", "Tuesday"="pink", "Wednesday"="lightgreen", 
                     "Thursday"="blue", "Friday"="purple", "Saturday"="brown"), limits = weekday_order) +
  scale_shape_manual(values = c("Research" = 0, "Clinical" = 17)) + 
    theme(panel.background = element_blank(),         
        #legend.title = element_text(size=7),         
        legend.position = "bottom",        
        axis.line = element_line(size=0.2),        
        axis.text.x=element_text(angle=60, hjust=1), 
        axis.title.x = element_text( size = 14, face = "bold") ,         
        axis.title.y = element_text(size = 14, face = "bold",color="black"),         
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +     
  theme(plot.caption = element_text(hjust=0), legend.title = element_text(size = 8.5))  +
  ggtitle(label="Figure 13. Hours from Collection to BPTL Receipt, \n HealthPartners")
combined_plotHP


#HF
scatRHF$coldate <- scatRHF$d_678166505
scatCHF$coldate <- scatCHF$clin_coll_bu
combined_dataHF <- rbind(cbind(scatRHF, Group = "Research"), cbind(scatCHF, Group = "Clinical"))

# Create a scatter plot with colored points
combined_plotHF <- ggplot(combined_dataHF, aes(x = as.Date(coldate), y = hrs_past, shape = Group, color = factor(weekdays(as.Date(coldate))))) +
  geom_point() +
  #scale_color_manual(values = c("Research" = "red", "Clinical" = "blue")) +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", expand=c(0,0)) +
  scale_y_continuous(name="Hours to BPTL Receipt",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  labs(color = "Weekdays", shape="Setting") +
  scale_color_manual(values=c("Sunday"="red", "Monday"="orange", "Tuesday"="pink", "Wednesday"="lightgreen", 
                     "Thursday"="blue", "Friday"="purple", "Saturday"="brown"), limits = weekday_order) +
  scale_shape_manual(values = c("Research" = 0, "Clinical" = 17)) + 
    theme(panel.background = element_blank(),         
        #legend.title = element_text(size=7),         
        legend.position = "bottom",        
        axis.line = element_line(size=0.2),        
        axis.text.x=element_text(angle=60, hjust=1), 
        axis.title.x = element_text( size = 14, face = "bold") ,         
        axis.title.y = element_text(size = 14, face = "bold",color="black"),         
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +     
  theme(plot.caption = element_text(hjust=0), legend.title = element_text(size = 8.5))  +
  ggtitle(label="Figure 14. Hours from Collection to BPTL Receipt, \n Henry Ford")
combined_plotHF



```




```{r ad_hoc_data,eval=TRUE,echo=FALSE,include=FALSE, warning=FALSE}

adhoc_d1 <- coll_bptl_diff %>%  select(Connect_ID, d_827220437, d_820476880, d_650516960, d_951355211, hrs_past, d_678166505, d_719427591, d_787237543_d_825582494, d_926457119)
adhoc_d2 <- coll_bptl_diff2 %>%  select(Connect_ID, d_827220437, d_820476880, d_650516960, d_951355211, hrs_past, d_678166505, d_719427591, d_787237543_d_825582494, d_926457119)
adhoc_d <- rbind(adhoc_d1, adhoc_d2)

adhoc_r <- recrver1 %>%   select(Connect_ID, d_173836415_d_266600170_d_185243482, d_173836415_d_266600170_d_452847912, d_173836415_d_266600170_d_982213346, d_173836415_d_266600170_d_139245758)
adhocb <- box_wl_flat %>%  select(d_560975149, d_132929440, d_948887825, bagID)

adhoc_d$Connect_ID <- as.numeric(adhoc_d$Connect_ID)
adhoc_r$Connect_ID <- as.numeric(adhoc_r$Connect_ID)


adhoc_dr <- left_join(adhoc_d, adhoc_r, by="Connect_ID")
ad_hoc_csv <- merge(adhoc_dr, adhocb, by.x="d_787237543_d_825582494", by.y="bagID", all.x=TRUE, all.y=TRUE)


ad_hoc_csv <- ad_hoc_csv %>%  filter(d_827220437=="548392715")




ad_hoc_csv <- ad_hoc_csv %>% select(Connect_ID, d_827220437, d_820476880, hrs_past, d_650516960, d_951355211, d_173836415_d_266600170_d_185243482, d_173836415_d_266600170_d_452847912, d_678166505, d_173836415_d_266600170_d_982213346, d_173836415_d_266600170_d_139245758, d_719427591, d_560975149, d_132929440, d_948887825, d_926457119)

# ad_hoc_csv <- ad_hoc_csv[, c(Connect_ID, d_827220437, d_820476880, hrs_past, d_650516960, d_951355211, d_173836415_d_266600170_d_185243482, d_173836415_d_266600170_d_452847912, d_556788178, d_173836415_d_266600170_d_982213346, d_173836415_d_266600170_d_139245758, d_719427591, d_560975149, d_132929440, d_948887825)]

colnames(ad_hoc_csv) <- c("Connect_ID", "RcrtES_Site_v1r0", "BioSpm_ColIDScan_v1r0", "Needle-to-Receipt Time (in Hours)", "BioSpm_Setting_v1r0", "BioSpm_Location_v1r0", "BioClin_SiteBldLocBL_v1r0", "BioClin_SiteUrLocatBL_v1r0", "BioCol_ColTime_v1r0", "BioClin_ClinBloodTmBL_v1r0", "BioClin_ClinicalUrnTmBL_v1r0", "BioCol_PhlebInitials_v1r0",  "BioShip_LocalID_v1r0", "BioPack_BoxID_v1r0", "BioShip_SignEmail_v1r0", "BioBPTL_DateRec_v1r0 ")

ad_hoc_csv$RcrtES_Site_v1r0[ad_hoc_csv$RcrtES_Site_v1r0==548392715]="Henry Ford Health"
ad_hoc_csv$BioSpm_Location_v1r0[ad_hoc_csv$BioSpm_Location_v1r0==736183094]="HFH K-13 Research Clinic"
ad_hoc_csv$BioSpm_Location_v1r0[ad_hoc_csv$BioSpm_Location_v1r0==886364332]="HFH Cancer Pavilion Research Clinic"
ad_hoc_csv$BioSpm_Location_v1r0[ad_hoc_csv$BioSpm_Location_v1r0==706927479]="HFH Livonia Research Clinic"

ad_hoc_csv$BioClin_SiteBldLocBL_v1r0[ad_hoc_csv$BioClin_SiteBldLocBL_v1r0==1060170018]="Macomb"
ad_hoc_csv$BioClin_SiteBldLocBL_v1r0[ad_hoc_csv$BioClin_SiteBldLocBL_v1r0==1060010063]="Macomb"
ad_hoc_csv$BioClin_SiteBldLocBL_v1r0[ad_hoc_csv$BioClin_SiteBldLocBL_v1r0==1011220006]="West Bloomfield"
ad_hoc_csv$BioClin_SiteBldLocBL_v1r0[ad_hoc_csv$BioClin_SiteBldLocBL_v1r0==1040010046]="West Bloomfield"
ad_hoc_csv$BioClin_SiteBldLocBL_v1r0[ad_hoc_csv$BioClin_SiteBldLocBL_v1r0==1040010047]="West Bloomfield"
ad_hoc_csv$BioClin_SiteBldLocBL_v1r0[ad_hoc_csv$BioClin_SiteBldLocBL_v1r0==1050010095]="Wyandotte"
ad_hoc_csv$BioClin_SiteBldLocBL_v1r0[ad_hoc_csv$BioClin_SiteBldLocBL_v1r0==1010180040]="Fairlane (Dearborn)"
ad_hoc_csv$BioClin_SiteBldLocBL_v1r0[ad_hoc_csv$BioClin_SiteBldLocBL_v1r0==1011660013]="Plymouth"
ad_hoc_csv$BioClin_SiteBldLocBL_v1r0[ad_hoc_csv$BioClin_SiteBldLocBL_v1r0==1011410008]="Royal Oak"
ad_hoc_csv$BioClin_SiteBldLocBL_v1r0[ad_hoc_csv$BioClin_SiteBldLocBL_v1r0==1010360011]="Troy"
ad_hoc_csv$BioClin_SiteBldLocBL_v1r0[ad_hoc_csv$BioClin_SiteBldLocBL_v1r0==1010010114]="K1 HFH Main"
ad_hoc_csv$BioClin_SiteBldLocBL_v1r0[ad_hoc_csv$BioClin_SiteBldLocBL_v1r0==1010010193]="K1 HFH Main"
ad_hoc_csv$BioClin_SiteBldLocBL_v1r0[ad_hoc_csv$BioClin_SiteBldLocBL_v1r0==1010320019]="Sterling Heights"
ad_hoc_csv$BioClin_SiteBldLocBL_v1r0[ad_hoc_csv$BioClin_SiteBldLocBL_v1r0==1010120026]="Columbus"
ad_hoc_csv$BioClin_SiteBldLocBL_v1r0[ad_hoc_csv$BioClin_SiteBldLocBL_v1r0==1010240013]="Livonia"
ad_hoc_csv$BioClin_SiteBldLocBL_v1r0[ad_hoc_csv$BioClin_SiteBldLocBL_v1r0==1010350019]="Taylor"

ad_hoc_csv$BioClin_SiteUrLocatBL_v1r0[ad_hoc_csv$BioClin_SiteUrLocatBL_v1r0==1060170018]="Macomb"
ad_hoc_csv$BioClin_SiteUrLocatBL_v1r0[ad_hoc_csv$BioClin_SiteUrLocatBL_v1r0==1060010063]="Macomb"
ad_hoc_csv$BioClin_SiteUrLocatBL_v1r0[ad_hoc_csv$BioClin_SiteUrLocatBL_v1r0==1011220006]="West Bloomfield"
ad_hoc_csv$BioClin_SiteUrLocatBL_v1r0[ad_hoc_csv$BioClin_SiteUrLocatBL_v1r0==1040010046]="West Bloomfield"
ad_hoc_csv$BioClin_SiteUrLocatBL_v1r0[ad_hoc_csv$BioClin_SiteUrLocatBL_v1r0==1040010047]="West Bloomfield"
ad_hoc_csv$BioClin_SiteUrLocatBL_v1r0[ad_hoc_csv$BioClin_SiteUrLocatBL_v1r0==1050010095]="Wyandotte"
ad_hoc_csv$BioClin_SiteUrLocatBL_v1r0[ad_hoc_csv$BioClin_SiteUrLocatBL_v1r0==1010180040]="Fairlane (Dearborn)"
ad_hoc_csv$BioClin_SiteUrLocatBL_v1r0[ad_hoc_csv$BioClin_SiteUrLocatBL_v1r0==1011660013]="Plymouth"
ad_hoc_csv$BioClin_SiteUrLocatBL_v1r0[ad_hoc_csv$BioClin_SiteUrLocatBL_v1r0==1011410008]="Royal Oak"
ad_hoc_csv$BioClin_SiteUrLocatBL_v1r0[ad_hoc_csv$BioClin_SiteUrLocatBL_v1r0==1010360011]="Troy"
ad_hoc_csv$BioClin_SiteUrLocatBL_v1r0[ad_hoc_csv$BioClin_SiteUrLocatBL_v1r0==1010010114]="K1 HFH Main"
ad_hoc_csv$BioClin_SiteUrLocatBL_v1r0[ad_hoc_csv$BioClin_SiteUrLocatBL_v1r0==1010010193]="K1 HFH Main"
ad_hoc_csv$BioClin_SiteUrLocatBL_v1r0[ad_hoc_csv$BioClin_SiteUrLocatBL_v1r0==1010320019]="Sterling Heights"
ad_hoc_csv$BioClin_SiteUrLocatBL_v1r0[ad_hoc_csv$BioClin_SiteUrLocatBL_v1r0==1010120026]="Columbus"
ad_hoc_csv$BioClin_SiteUrLocatBL_v1r0[ad_hoc_csv$BioClin_SiteUrLocatBL_v1r0==1010240013]="Livonia"
ad_hoc_csv$BioClin_SiteUrLocatBL_v1r0[ad_hoc_csv$BioClin_SiteUrLocatBL_v1r0==1010350019]="Taylor"

ad_hoc_csv$BioSpm_Setting_v1r0[ad_hoc_csv$BioSpm_Setting_v1r0==534621077]="Research"
ad_hoc_csv$BioSpm_Setting_v1r0[ad_hoc_csv$BioSpm_Setting_v1r0==664882224]="Clinical"
ad_hoc_csv$BioShip_LocalID_v1r0[ad_hoc_csv$BioShip_LocalID_v1r0==706927479]="HFH Livonia Research Clinic"
ad_hoc_csv$BioShip_LocalID_v1r0[ad_hoc_csv$BioShip_LocalID_v1r0==752948709]="Henry Ford Main Campus"


write.csv(ad_hoc_csv,glue("{local_drive}HFH_Needle_to_Receipt_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")



non_repeating_rows <- !duplicated(ad_hoc_csv)
ad_hoc_csv <- ad_hoc_csv[non_repeating_rows, ]

write.csv(ad_hoc_csv,glue("{local_drive}HFH_Needle_to_Receipt_No_Duplicates_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")


```


```{r ad_hoc2_data,eval=TRUE,echo=FALSE,include=FALSE, warning=FALSE}
 

adhocbio <- biospe %>%  select(Connect_ID,d_820476880, d_827220437, d_678166505, d_787237543_d_825582494, d_650516960) %>%  filter(d_827220437 == 531629870)
adhocpt <- recrver1 %>%  select(Connect_ID, d_173836415_d_266600170_d_982213346, d_173836415_d_266600170_d_139245758)
adhocb <- box_wl_flat %>%  select( d_132929440,  bagID)

adhoc_bpt <- left_join(adhocbio, adhocpt, by="Connect_ID")
ad_hoc_bptl <- merge(adhoc_bpt, adhocb, by.x="d_787237543_d_825582494", by.y="bagID", all.x=TRUE, all.y=TRUE)


ad_hoc_bptl <- ad_hoc_bptl %>% select(Connect_ID, d_650516960, d_820476880, d_827220437, d_678166505, d_173836415_d_266600170_d_982213346, d_173836415_d_266600170_d_139245758, d_132929440)


colnames(ad_hoc_bptl) <- c("Connect_ID", "BioSpm_Setting_v1r0", "BioSpm_ColIDScan_v1r0", "RcrtES_Site_v1r0", "BioCol_ColTime_v1r0", "BioClin_ClinBloodTmBL_v1r0", "BioClin_ClinicalUrnTmBL_v1r0", "BioPack_BoxID_v1r0")

ad_hoc_bptl$RcrtES_Site_v1r0[ad_hoc_bptl$RcrtES_Site_v1r0==531629870]="HealthPartners"

ad_hoc_bptl$BioSpm_Setting_v1r0[ad_hoc_bptl$BioSpm_Setting_v1r0==534621077]="Research"
ad_hoc_bptl$BioSpm_Setting_v1r0[ad_hoc_bptl$BioSpm_Setting_v1r0==664882224]="Clinical"

ad_hoc_bptl <- ad_hoc_bptl %>% filter(!is.na(Connect_ID))

non_repeating_rows <- !duplicated(ad_hoc_bptl)
ad_hoc_bptl <- ad_hoc_bptl[non_repeating_rows, ]

write.csv(ad_hoc_bptl,glue("{local_drive}HP Data File for HP Streck Pilot Study_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")


