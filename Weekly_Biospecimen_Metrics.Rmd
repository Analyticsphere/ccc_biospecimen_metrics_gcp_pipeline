
---
title: "Biospecimen Weekly Metrics RMD"
author: "Kelsey Sanchez"
date: "Data Extracted and Report Ran: `r Sys.Date()`"
header-includes:  
  \usepackage[labelformat=empty]{caption}
  \usepackage{placeins}
  \usepackage{booktabs}
  \usepackage{pdflscape}


output:
  pdf_document:
    extra_dependencies: ["float"]
    toc: true
    keep_tex: yes
    fig_width: 7
    fig_height: 5
    fig_caption: true
    df_print: paged 
---
  
  
```{r setup,eval=TRUE,include=FALSE,echo=FALSE, warning=FALSE}

#    latex_engine: xelatex -- this was in the set up previously, but caused issues when running locally so it was removed 

#old.packages()
#update.packages()  


library(bigrquery)
library(data.table) ###to write or read and data management 
library(dplyr) ###data management
# library(boxr) ###read or write data from/to box
library(tidyverse) ###for data management
library(reshape)  ###to work on transition from long to wide or wide to long data
library(listr) ###to work on a list of vector, files or..
library(sqldf) ##sql
library(lubridate) ###date time
library(ggplot2) ###plots
#library(ggpubr) ###for the publications of plots
library(RColorBrewer) ###visions color http://www.sthda.com/english/wiki/colors-in-r
library(gridExtra)
library(stringr) ###to work on patterns, charaters
#library(plyr)
library(tinytex) #for pdf
library(rmarkdown) ###for the output tables into other files: pdf, rtf, etc.
library(janitor) #to get the summary sum
library(finalfit) #https://cran.r-project.org/web/packages/finalfit/vignettes/export.html t
library(expss) ###to add labels
library(epiDisplay) ##recommended applied here crosstable, tab1
library(summarytools) ##recommended
library(gmodels) ##recommended
library(magrittr)
library(arsenal)
library(gtsummary)
library(kableExtra)
library(gt)
library(crosstable)
library(cowplot)
library(webshot2)
library(glue) 
#options(knitr.table.format = "latex")
currentDate <- Sys.Date()
currentDate <- as.Date(currentDate)

bq_auth()

### Set Box folders for output CSV files #######################################
use_test_box_folder <- TRUE # Local user sets this (Jake or Kelsey)

# Over-ride if using plumber api on GCP (USER DOESN'T TOUCH THIS!)
# Check if the environment variable exists and is not empty
if (!is.null(Sys.getenv("USE_TEST_BOX_FOLDER")) &&
    Sys.getenv("USE_TEST_BOX_FOLDER") != "") {
  use_test_box_folder <- as.logical(Sys.getenv("USE_TEST_BOX_FOLDER"))
}

if (use_test_box_folder) {
  boxfolder <- 222593912729 # test box folder
} else {
  boxfolder <- 221280601453 # destination of CSV files (not pdf)
}


##### Making sure personal C drives aren't referenced if this code is being used by others


#Change to FALSE if referencing this code
write_to_local_drive = F #F

#local_drive="C:/Users/dowlingk2/Documents/Module-Missingness-and-Metrics/data/"    


### This function below is put before any write.csv functions, and "filename" is updated. It determines wheteher the file will be created locally or not.
#filename=
local_drive= ifelse(write_to_local_drive, "C:/Users/dowlingk2/Documents/Module-Missingness-and-Metrics/data/", "")

```

```{r BQPull, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}
##import data to R

project <- "nih-nci-dceg-connect-prod-6d04"
billing <- "nih-nci-dceg-connect-prod-6d04" ##project and billing should be consistent
bio_tb <- bq_project_query(project, query='SELECT * FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.biospecimen_JP` where d_410912345 is not null')  
biospe <- bq_table_download(bio_tb,bigint="integer64",n_max = Inf) #, page_size = 1000)
cnames <- names(biospe)
###to check variables in recr_noinact_wl1

numbers_only <- function(x) !grepl("\\D", x)

for (i in 1: length(cnames)){
  varname <- cnames[i]
  var<-pull(biospe,varname)
  biospe[,cnames[i]] <- ifelse(numbers_only(var), as.numeric(as.character(var)), var)
}
tb_box <- bq_project_query(project, query="SELECT * FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.boxes_JP`")
box_wl_flat <- bigrquery::bq_table_download(tb_box,bigint="integer64",n_max = Inf, page_size = 1000)
#y <- read_table(urlfile1,header = TRUE, sep = "\t", na.strings = c("NA","N/A",""),fill = TRUE, quote='')
library(readr)
urlfile<- "https://raw.githubusercontent.com/episphere/conceptGithubActions/master/csv/masterFile.csv" ###to grab the updated dd from github
y <- read.csv(urlfile) #the masterDD has just been updated which can't easily pulled from github directly as before. I need to download from the raw file in the github
#y <- read_table(urlfile1,header = TRUE, sep = "\t", na.strings = c("NA","N/A",""),fill = TRUE, quote='')
library(rio)
dictionary <- rio::import("https://episphere.github.io/conceptGithubActions/aggregate.json",format = "json")
dd<-rbindlist(dictionary,fill=TRUE,use.names=TRUE,idcol="CID") #THIS TABLE HAS REPLICATED (CIDS+LABELS) WITH DIFFERENT VARIABLE NAMES,
# dd <- as.data.frame(do.call("rbind",dictionary))
# colnames(dd) <- c("Variable Label", "Variable Name")
# dd$CID <- rownames(dd)
box_CID <- as.data.frame(as.numeric(sapply((strsplit(colnames(box_wl_flat),"d_")),tail,1)))
box_CID$variable <- colnames(box_wl_flat)
colnames(box_CID)[1] <-"CID"
box_CID_dd <- base::merge(box_CID, dd,by="CID",all.x=TRUE)
#to convert the numeric variables
numbers_only <- function(x) !grepl("\\D", x)
cnames <- names(box_wl_flat)
###to check variables in recr_noinact_wl1
data2 <- box_wl_flat
for (i in 1: length(cnames)){
  varname <- cnames[i]
  var<-pull(data2,varname)
  data2[,cnames[i]] <- ifelse(numbers_only(var), as.numeric(as.character(var)), var)
}
# 
pct_tb <- function(x,y){
  table1 <- CrossTable(x,y, prop.t=FALSE, prop.r=FALSE, prop.c=TRUE,chisq=FALSE)
  pct <- as.data.frame(cbind(table1$prop.row,table1$t))
  if(ncol(pct)==2){
    total <- as.numeric(sum(pct[,2]))
    pct[nrow(pct)+1,c(1:2)] <- c(1,total)
    rownames(pct)[nrow(pct)] <- "Total"
    colnames(pct)[1] <- paste0("pct_",colnames(pct)[1])
    colnames(pct)[2] <- paste0("n_",colnames(pct)[2])
    
  }
  else  if(ncol(pct)>2 ){
    total <- as.numeric(sum(pct[,3] + pct[,4]))
    pct[nrow(pct)+1,c(1:4)] <- c(sum(pct[,3])/total,sum(pct[,4])/total,sum(pct[,3]),sum(pct[,4]))
    rownames(pct)[nrow(pct)] <- "Total"
    colnames(pct)[c(1:2)] <- paste0("pct_",colnames(pct[c(1:2)]))
    colnames(pct)[c(3:4)] <- paste0("n_",colnames(pct)[c(3:4)])
    
    pct[,5] <- paste0(format(pct[,3],big.mark=","), " (",round(100*pct[,1],1), " %)")
    pct[,6] <- paste0(format(pct[,4],big.mark=","), " (",round(100*pct[,2],1), " %)") 
    colnames(pct)[5] <- paste0("n_",colnames(pct)[1])
    colnames(pct)[6] <- paste0("n_",colnames(pct)[2])
  }
  return(pct)
}
##to select biospecimen data in recruitment 
recr_var <- bq_project_query(project, query="SELECT * FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect`.INFORMATION_SCHEMA.COLUMN_FIELD_PATHS WHERE table_name='participants_JP'")
recrvar <- bigrquery::bq_table_download(recr_var, bigint="integer64",n_max = Inf, page_size = 10000)
urlfile<- "https://raw.githubusercontent.com/episphere/conceptGithubActions/master/csv/masterFile.csv" ###to grab the updated dd from github 
y <- read.csv(urlfile)
recrvar_nd <- recrvar[which(grepl("d_",recrvar$column_name)),c("column_name","field_path")]

recrvar_nd$last.CID <- ifelse(grepl("d_",recrvar_nd$column_name),substring(sapply(strsplit(recrvar_nd$column_name,"d_"),tail,1),1,9),NA)
recrvar_nd_label <- base::merge(recrvar_nd, y[,c("Primary.Source","conceptId.2","conceptId.3","Variable.Label","conceptId.4","Current.Format.Value")],by.x="last.CID",by.y="conceptId.3",all.x=TRUE)


#recrvar_nd_label <- base::merge(recrvar_nd, y[,c("Primary.Source","conceptId.2","conceptId.3","Variable.Label","conceptId.4")],by.x="last.CID",by.y="conceptId.3",all.x=TRUE)
#recrvar.bio <- recrvar_nd_label[which(recrvar_nd_label$Primary.Source == "Biospecimen" | grepl("biospecimen|blood|urine|mouthwash|Blood|Urine|Mouthwash|collection",recrvar_nd_label$Variable.Label)),] #49 updated due to the changes of the master DD
#recrvar.bio <- recrvar.bio[!duplicated(recrvar.bio[,c("last.CID","column_name")]),] #53 updated 10/05/2023 due to the updated dictionary #should this line be kept?

recrvar.bio <- recrvar_nd_label[which(recrvar_nd_label$Primary.Source =="Biospecimen" | grepl("biospecimen|blood|urine|mouthwash|collection|Blood|Urine|Mouthwash|MW|Ur|Ur Surv|MW Surv",recrvar_nd_label$Variable.Label)),] #49
query <- unique(recrvar.bio$column_name)
select <- paste(recrvar.bio$column_name,collapse=",")
#tb_bq <- eval(parse(text=paste("bq_project_query(project, query=\"SELECT token,Connect_ID,d_512820379,d_821247024,d_914594314,d_827220437,d_699625233, date,", select,"FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` Where d_821247024 = '197316935' \")",sep=" ")))


tb_bq <- eval(parse(text=paste("bq_project_query(project, query=\"SELECT token,Connect_ID,d_512820379,d_821247024,d_914594314,d_827220437,d_699625233, d_265193023, d_822499427, d_222161762,", select,"FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` Where d_821247024 = '197316935' \")",sep=" "))) #removed "date", as it is no longer in the participants table


recr.bio <- bigrquery::bq_table_download(tb_bq,bigint="integer64",n_max = Inf, page_size = 1000)
##below are the commone variables in the recruitment table on Biospecimen to apply for the analysis. In case any new variables popping up, i would like #to use the one above directly from the resources (master DD and recruitment table schema to get the most updated version on this biospecimen data
# tb <- bq_project_query(project, query="SELECT d_512820379,d_512820379, d_821247024, d_914594314, d_822499427, d_222161762, Connect_ID, d_827220437, token,d_265193023, d_878865966, d_167958071, d_684635302, d_253883960, d_534669573, d_764863765, d_331584571_d_266600170_d_135591601,d_331584571_d_266600170_d_840048338,  d_331584571_d_266600170_d_343048998, d_173836415_d_266600170_d_139245758, d_173836415_d_266600170_d_185243482,
# d_173836415_d_266600170_d_198261154, d_173836415_d_266600170_d_210921343, d_173836415_d_266600170_d_224596428,
# d_173836415_d_266600170_d_316824786, d_173836415_d_266600170_d_341570479, d_173836415_d_266600170_d_398645039,
# d_173836415_d_266600170_d_448660695, d_173836415_d_266600170_d_452847912, d_173836415_d_266600170_d_453452655,
# d_173836415_d_266600170_d_530173840, d_173836415_d_266600170_d_534041351, d_173836415_d_266600170_d_541311218,
# d_173836415_d_266600170_d_561681068, d_173836415_d_266600170_d_592099155, d_173836415_d_266600170_d_611091485,
# d_173836415_d_266600170_d_646899796, d_173836415_d_266600170_d_693370086, d_173836415_d_266600170_d_718172863,
# d_173836415_d_266600170_d_728696253, d_173836415_d_266600170_d_740582332, d_173836415_d_266600170_d_769615780,
# d_173836415_d_266600170_d_786930107, d_173836415_d_266600170_d_822274939, d_173836415_d_266600170_d_847159717,
# d_173836415_d_266600170_d_860477844, d_173836415_d_266600170_d_915179629, d_173836415_d_266600170_d_939818935,
# d_173836415_d_266600170_d_951355211, d_173836415_d_266600170_d_982213346 FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` WHERE d_821247024 = '197316935'")
##to convert to numeric
cnames <- names(recr.bio)
recrver <- recr.bio
for (i in 1: length(cnames)){
  varname <- cnames[i]
  var<-pull(recrver,varname)
  recrver[,cnames[i]] <- ifelse(numbers_only(var), as.numeric(as.character(var)), var)
}
##to get the labels of each variable
recrver_CID <- as.data.frame(sapply((strsplit(colnames(recrver),"d_")),tail,1))
colnames(recrver_CID)[1] <- "CID"
recrver_CID$variable <- names(recr.bio)
recrver_ver1 <- base::merge(dd,recrver_CID,by="CID")
recrver1 <- expss::apply_labels(recrver,
                                d_512820379 = "Recruitment type",#RcrtSI_RecruitType_v1r0
                                d_512820379=c(	"Not active"=180583933,  
                                               "Active"= 486306141, 
                                               "Passive"=854703046),
                                d_821247024 = "Verification status", #RcrtV_Verification_v1r0
                                d_821247024 = c("Not yet verified" =875007964,
                                                "Verified"=197316935,  
                                                "Cannot be verified"=219863910, 
                                                "Duplicate"=922622075 , 
                                                "Outreach timed out"= 160161595),
                                d_827220437 = "Site",#RcrtES_Site_v1r0
                                d_827220437 = c("Baylor Scott and White Health"=472940358,"HealthPartners"= 531629870, "Henry Ford Health System"=548392715,"Marshfield Clinic Health System" = 303349821,"Sanford Health" = 657167265, "University of Chicago Medicine" = 809703864,"Kaiser Permanente Colorado" = 125001209,"Kaiser Permanente Georgia" = 327912200,"Kaiser Permanente Hawaii" = 300267574,"Kaiser Permanente Northwest" = 452412599,"National Cancer Institute" = 517700004,"National Cancer Institute" = 13,"Other" = 181769837),
                                d_914594314 = "Verification status time",   #RcrtV_VerificationTm_V1R0
                                d_878865966 = "Baseline blood sample collected", #BioFin_BaseBloodCol_v1r0
                                d_878865966 = c("Any blood collected"=353358909, "No blood collected"=104430631),
                                d_173836415_d_266600170_d_561681068 = "Date/time basline Research Blood Collected",#BL_BioFin_BBTime_v1r0
                                d_684635302 = "Baseline Mouthwash Collected",    #BioFin_BaseMWCol_v1r0
                                d_684635302 = c("Any mouthwash collected"=353358909,"No mouthwash collected"= 104430631  ),
                                d_173836415_d_266600170_d_448660695 = "Date/time Mouthwash Collected", #
                                d_167958071 = "Baseline Urine collected", 
                                d_167958071 = c( "Any urine collected"=353358909, "No urine collected"=104430631),
                                d_173836415_d_266600170_d_847159717 = "Baseline Date/time Urine collected",
                                d_331584571_d_266600170_d_135591601 = "Baseline Check In Complete",#BL_BioChk_Complete_v1r0
                                d_331584571_d_266600170_d_135591601 =  c( "No"=104430631, "Yes"=353358909 ),
                                d_331584571_d_266600170_d_840048338 = "Date/Time Baseline Check In Complete",
                                d_331584571_d_266600170_d_343048998 = "Time Baseline check out complete",#
                                
                                d_173836415_d_266600170_d_530173840 = "Blood Order Placed",#BioClin_BldOrderPlaced_v1r0  ## I ADDED
                                d_173836415_d_266600170_d_530173840 =c( "No"=104430631, "Yes"=353358909 ), ## I ADDED
                                
                                d_173836415_d_266600170_d_592099155 = "Blood Collection Setting",#BL_BioSpm_BloodSetting_v1r0  
                                d_173836415_d_266600170_d_592099155 =c("Research"=534621077, "Clinical"= 664882224,"Home" =103209024),
                                d_173836415_d_266600170_d_718172863 = "Urine Collection Setting",#BL_BioSpm_UrineSetting_v1r0
                                d_173836415_d_266600170_d_718172863 =c("Research"=534621077, "Clinical"= 664882224,"Home" =103209024),
                                d_173836415_d_266600170_d_915179629 = "Mouthwash Collection Setting",#BL_BioSpm_MWSetting_v1r0
                                d_173836415_d_266600170_d_915179629 =c("Research"=534621077, "Clinical"= 664882224,"Home" =103209024),
                                
                                d_265193023 = "Blood/urine/mouthwash combined research survey-Complete",   
                                d_265193023 = c(	"Not Started" =	972455046, "Started"= 615768760,"Submitted"= 231311385),#SrvBLM_ResSrvCompl_v1r0
                                d_822499427 = "Placeholder (Autogenerated) - Date/time Status of Start of blood/urine/mouthwash research survey",#SrvBLM_TmStart_v1r0
                                d_222161762  = "Placeholder (Autogenerated)- Date/Time blood/urine/mouthwash research survey completed" #   SrvBLM_TmComplete_v1r0
)
###to convert to categorical variables
recrver1$RcrtSI_RecruitType_v1r0 <- factor(recrver1$d_512820379, exclude=NULL)
recrver1$RcrtV_Verification_v1r0 <- factor(recrver1$d_821247024, exclude=NULL)
recrver1$BioFin_BaseMWCol_v1r0  <-factor(recrver1$d_684635302,exclude=NULL)
recrver1$BioFin_BaseBloodCol_v1r0 <- factor(recrver1$d_878865966,exclude=NULL)
recrver1$BioFin_BaseUrineCol_v1r0 <- factor(recrver1$d_167958071,exclude=NULL)

recrver1$BioClin_BldOrderPlaced_v1r0 <- factor(recrver1$d_173836415_d_266600170_d_530173840,exclude=NULL) ## I ADDED

recrver1$SrvBLM_ResSrvCompl_v1r0 <-factor(recrver1$d_265193023,exclude=NULL)
recrver1$BL_BioSpm_MWSetting_v1r0 <- factor(recrver1$d_173836415_d_266600170_d_915179629,levels=c("Clinical","Research","Home"))  
recrver1$BL_BioSpm_UrineSetting_v1r0 <- factor(recrver1$d_173836415_d_266600170_d_718172863, levels=c("Clinical","Research","Home"))  
recrver1$BL_BioSpm_BloodSetting_v1r0 <- factor(recrver1$d_173836415_d_266600170_d_592099155,levels=c("Clinical","Research","Home"))  
recrver1$BL_BioChk_Complete_v1r0 <- factor(recrver1$d_331584571_d_266600170_d_135591601,exclude=NULL)
recrver1$Site <-factor(recrver1$d_827220437,levels=c("Baylor Scott and White Health","HealthPartners", "Henry Ford Health System",
                                                     "Marshfield Clinic Health System",
                                                     "Sanford Health", "University of Chicago Medicine","Kaiser Permanente Colorado",
                                                     "Kaiser Permanente Georgia","Kaiser Permanente Hawaii","Kaiser Permanente Northwest",
                                                     "National Cancer Institute","Other"))
recrver1<- recrver1 %>% mutate(BldCollection = ifelse(recrver1$BioFin_BaseBloodCol_v1r0 == 353358909, "YES", "No"))

##to update the censoring time based on Kelsey's request to be consistent with the weekly log: from Monday to Sunday
veristart.date = as.Date(min(as.POSIXct(recr.bio$d_914594314),na.rm=TRUE))
veristart.date + days(5)
#[1] "2021-08-01"
recrver1$verified.week <- ceiling(as.numeric(difftime(as.Date(ymd_hms(recrver1$d_914594314)),as.Date(veristart.date-days(2)),units="days"))/7)
recrver1$verified.Sunday.date <- veristart.date + days(5)+ dweeks(recrver1$verified.week-1)



##to check the duplicate collection by verified participants Connect_ID
biospe[duplicated(biospe$Connect_ID),c("Connect_ID","d_820476880","d_410912345","d_387108065")]
biospe[duplicated(biospe$Connect_ID),"Connect_ID"]
biospe$Connect_ID[duplicated(biospe$Connect_ID)]
dupid <- biospe$Connect_ID[duplicated(biospe$Connect_ID)]
#biospe[which(biospe$Connect_ID %in% dupid),c("Connect_ID","d_820476880","d_410912345","d_387108065","d_143615646_d_593843561","d_973670172_d_593843561")]
##the biospecimen concepts for the biospecimen variablesbles
biospe_var <- as.data.frame((colnames(biospe)))
colnames(biospe_var)[1] <- "variable"
biospe_var$cid1 <- sapply(strsplit(colnames(biospe),"_"), "[", 2)
biospe_var$cid2 <- sapply(strsplit(colnames(biospe),"_"), "[", 4)
biospe_var$cid3 <- sapply(strsplit(colnames(biospe),"_"), "[", 6)
biospe_var$cid_tail <- sapply(strsplit(colnames(biospe),"_"), tail,1)
CID <- unique(c(biospe_var$cid1,biospe_var$cid2,biospe_var$cid3)) #this line is missing from your code in github.
#biospe_CID <- dd[which(dd$CID %in% CID),]
biospe_CID <- y[which(y$conceptId.3 %in% CID),]
biospe_dd<- base::merge(biospe_var,biospe_CID,by.x="cid_tail",by.y="conceptId.3", all.x=TRUE)
biospe_dd <- biospe_dd%>% arrange(variable,conceptId.1) %>% filter(!duplicated(variable))
#tubes <- dd[grepl(" Tube ",dd$`Variable Label`),] #updated 12/11/2023
tubes <- unique(y[grepl(" Tube ",y$`Secondary.Source`),c("conceptId.1","Secondary.Source")])

urine <- dd[grepl("Urine",dd$`Variable Label`),]
mouthwash <- dd[grepl("Mouthwash",dd$`Variable Label`),]



```




This Weekly Metrics report contains tables and plots for the Connect Biospecimen samples, many stratified by health provider site. This information pertains to verified participants as of the date above and collections that are final.


```{r Tables1_2, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}
# \newpage
# \FloatBarrier
# # Tables

## Tables 1-4

#### FOR TABLES 1-4 I CHANGED NO SAMPLES COLLECTED TO BE NO COLLECTED SAMPLES AND ALSO THAT THE PARTICIPANTS DID HAVE A COLLECTION APPOINTMENT, SO THAT THOSE WHO HAVEN'T EVEN SCHEDULEN AN APPT YET ARE NOT COUNTED IN THE NO SAMPLES COLLECTED COLUMN


# mouthwash or blood or urine collected
recrver1 <- recrver1 %>% mutate(BiospeCollection = ifelse((recrver1$d_684635302 == 353358909 | recrver1$d_878865966 == 353358909| recrver1$d_167958071 == 353358909), "Any biospecimen Collections","No biospecimen collections"))

recrver1$Site<- droplevels(recrver1$Site)



bio.appoint <- biospe %>% arrange(Connect_ID, d_410912345, d_951355211) %>%
  group_by(Connect_ID) %>%
  summarise(
    d_410912345 = mean(d_410912345, na.rm = TRUE), #to remove the multiple collections by Connect_ID
    d_951355211 = first(d_951355211),  # arbitrarily, just to get this variable in the final df
    d_650516960 = first(d_650516960)  # arbitrarily, just to get this variable in the final df
  ) 
 
biocol.tb <- base::merge(recrver1[,c("Connect_ID","Site","BiospeCollection","d_878865966","d_684635302","d_167958071", "d_173836415_d_266600170_d_185243482", "d_173836415_d_266600170_d_452847912", "d_173836415_d_266600170_d_822274939", "d_173836415_d_266600170_d_139245758",
                                     "BL_BioSpm_BloodSetting_v1r0", "BL_BioSpm_UrineSetting_v1r0", "BL_BioSpm_MWSetting_v1r0", "BioFin_BaseBloodCol_v1r0", "BioFin_BaseUrineCol_v1r0", "BioFin_BaseMWCol_v1r0")],
                         bio.appoint,by.x="Connect_ID",by.y="Connect_ID",all.x=TRUE )
 
table1 <- biocol.tb %>% #filter(recrver1$d_821247024==197316935) %>%
  mutate(#appointment = ifelse((d_410912345!= 353358909 | is.na(d_410912345)), 104430631, 353358909),
         biocol.appoint = case_when(BiospeCollection == "Any biospecimen Collections" & d_410912345== 353358909 ~ "Baseline Collection",
                                    #BiospeCollection == "No biospecimen collections" & (d_410912345!= 353358909 | is.na(d_410912345)) ~ "No Baseline Collection"
                                    TRUE ~ "No Baseline Collection")) 
tab___1 <- table1 %>%  
  mutate(biocol.appoint = factor(biocol.appoint, levels=c("Baseline Collection","No Baseline Collection"))) %>% dplyr::select(Site, biocol.appoint )  %>% 
  tbl_cross(
    row = Site,
    col = biocol.appoint,
    digits=c(0,1),
    percent = "row",
    label=list(Site="Site",
                biocol.appoint = " "),
    missing="ifany",
    margin_text="Total") 
 
 


table1_totals <- as.data.frame(tab___1)
table1_totals <- table1_totals[-1, ]
total_rows <- nrow(table1_totals)

biospe.t1 <- knitr::kable(table1_totals, col.names=c("Site", "Baseline Collection","No Baseline Collection", "Total Verified Participants"), caption='Table 1.1: Baseline Biospecimen Collection Status Among Verified Participants', row.names=FALSE,align=c("l","c","c","c"), booktabs = TRUE) %>%  add_indent(seq(1, total_rows - 1)) %>% kable_styling(latex_options = "scale_down")






biospe_locations<-table1 %>% filter(d_650516960== 534621077) %>% 
  mutate(
    Site_location = case_when(
      d_951355211 == 777644826 ~ "UC-DCAM",
      d_951355211 == 145191545 ~ "Ingalls Harvey",
      d_951355211 == 489380324 ~ "River East",
      d_951355211 == 120264574 ~ "South Loop",
      d_951355211 == 834825425 ~ "HP Research Clinic",
      #d_951355211==574368418 ~ "HP Park Nicollet",
      d_951355211 == 736183094 ~ "HFH K-13 Research Clinic",
      d_951355211 == 886364332 ~ "HFH Cancer Pavilion Research Clinic",
      d_951355211 == 706927479 ~ "HFH Livonia Research Clinic",
      d_951355211 == 322059622 ~ "HFH Pop-Up",
      d_951355211 == 692275326 ~ "Marshfield",
      d_951355211 == 813701399 ~ "Weston",
      d_951355211 == 698283667 ~ "Lake Hallie",
      d_951355211 == 691714762 ~ "Rice Lake",
      d_951355211 == 487512085 ~ "Wisconsin Rapids",
      d_951355211 == 983848564 ~ "Colby Abbotsford",
      d_951355211 == 261931804 ~ "Minocqua",
      d_951355211 == 665277300 ~ "Merrill",
      d_951355211 == 589224449 ~ "Sioux Falls Imagenetics",
      d_951355211 == 467088902 ~ "Fargo South University",
      d_951355211 == 567969985 ~ "MF Pop-Up",
      d_951355211 == 319518299 ~ "UCM Pop-Up",
      d_951355211 == 940329442 ~ "Orland Park"
    )
  )
#TRUE ~ "Missing"))


                  
                   


biospe_locations$biocol.appoint[biospe_locations$biocol.appoint=="Baseline Collection"]="Number of Research Collections"

table1_1_locations <-  biospe_locations %>% filter(biocol.appoint=="Number of Research Collections")
table1_1_locations <- table1_1_locations %>%  distinct(Connect_ID, .keep_all = TRUE) #testing this out

col_num <- table(table1_1_locations$Site_location, table1_1_locations$biocol.appoint)

col_num_1.1 <- as.data.frame(col_num)
col_num_1.1 <- col_num_1.1[, c(1,3)]
colnames(col_num_1.1) <- c("Collection Location", "N")
rownames(col_num_1.1) <- col_num_1.1$`Collection Location`


col_num_1.1 <- col_num_1.1 %>%
  mutate(Site_Group = case_when(
    `Collection Location` %in% c("UC-DCAM", "Ingalls Harvey", "River East", "South Loop", "UCM Pop-Up", "Orland Park") ~ "University of Chicago Medicine",
    `Collection Location` == "HP Research Clinic" ~ "HealthPartners", #"HP Park Nicollet",
    `Collection Location` %in% c("Lake Hallie", "Marshfield", "MF Pop-Up", "Minocqua", "Weston", "Wisconsin Rapids", "Rice Lake", "Colby Abbotsford", "Merrill") ~ "Marshfield Clinic Health System",
    `Collection Location` %in% c("Sioux Falls Imagenetics", "Fargo South University") ~ "Sanford Health",
    `Collection Location` %in% c("HFH K-13 Research Clinic", "HFH Livonia Research Clinic", "HFH Cancer Pavilion Research Clinic", "HFH Pop-Up") ~ "Henry Ford Health System",
    TRUE ~ "Other"
  ))

#col_num_1.1$`Number of Research Collections` <- paste(col_num_1.1$`Number of Research Collections`, )

col_num_1.1$`N` <- as.numeric(col_num_1.1$`N`)
col_num_1.1 <- col_num_1.1 %>%
  filter(!is.na(`N`))


 total_collections <- col_num_1.1 %>%
   group_by(Site_Group) %>%
   summarize(Total_Collections = sum(`N`, na.rm = TRUE))


 col_num_1.1 <- col_num_1.1 %>%
   left_join(total_collections, by = "Site_Group")


col_num_1.1 <- col_num_1.1 %>%
  mutate(Percentage = round((`N` / Total_Collections * 100), digits=1))


total_rows <- col_num_1.1 %>%
  group_by(Site_Group) %>%
  summarize(`Collection Location` = "Total",
            `N` = sum(`N`),
            Percentage = 100) %>%
  ungroup()

col_num_1.1 <- bind_rows(col_num_1.1, total_rows)

col_num_1.1$`Total Research Collections` <- paste0(col_num_1.1$`N`, " (", col_num_1.1$Percentage,"%)")
col_num_1.1 <- col_num_1.1[, c(1,3,6)]

col_num_1.1 <- col_num_1.1 %>%
  mutate(`Collection Location` = paste0("\u00A0\u00A0\u00A0", `Collection Location`))


col_num_1.1_gt <- col_num_1.1 %>%

  gt::gt(groupname_col = "Site_Group") 





col_num_1.1_gt <- col_num_1.1_gt %>%  summary_rows(
        groups = TRUE,
        columns = vars("Total Research Collections"),
        fns = (Sum = ~sum(.)),
        ) %>% tab_header("Table 1.2: Baseline Research Biospecimen Collections by Collection Location")







table1_2_locs<-table1 %>% filter(d_650516960== 664882224) 


table1_2_locs$biocol.appoint[table1_2_locs$biocol.appoint=="Baseline Collection"]="Number of Clinical Collections"

table1_2_locations <-  table1_2_locs %>% filter(biocol.appoint=="Number of Clinical Collections")
table1_2_locations <- table1_2_locations %>%  distinct(Connect_ID, .keep_all = TRUE) #testing this out

table1_2__locations <- table1_2_locations %>% mutate(Site_location=case_when(#d_173836415_d_266600170_d_185243482==1 | d_173836415_d_266600170_d_452847912==1 ~ "NSC",
                                                                             Site=="HealthPartners" & (d_173836415_d_266600170_d_185243482 == 2 | d_173836415_d_266600170_d_452847912 == 2) ~ "Elk River",
                                                                             Site=="HealthPartners" & (d_173836415_d_266600170_d_185243482 == 3 | d_173836415_d_266600170_d_452847912 == 3) ~ "Chanhassen",
                                                                             d_173836415_d_266600170_d_185243482 == 1050010095 |
                                                                               d_173836415_d_266600170_d_452847912 == 1050010095 ~ "Wyandotte",
                                                                             d_173836415_d_266600170_d_185243482 == 1060010063 |
                                                                               d_173836415_d_266600170_d_185243482 == 1060170018 |
                                                                               d_173836415_d_266600170_d_452847912 == 1060010063 |
                                                                               d_173836415_d_266600170_d_452847912 == 1060170018 ~ "Macomb",
                                                                             d_173836415_d_266600170_d_185243482 == 1040010047 |
                                                                               d_173836415_d_266600170_d_185243482 == 1040010046 |
                                                                               d_173836415_d_266600170_d_185243482 == 1011220006 |
                                                                               d_173836415_d_266600170_d_452847912 == 1040010047 |
                                                                               d_173836415_d_266600170_d_452847912 == 1040010046 |
                                                                               d_173836415_d_266600170_d_452847912 == 1011220006 ~ "West Bloomfield",
                                                                             d_173836415_d_266600170_d_185243482 == 1011410008 |
                                                                               d_173836415_d_266600170_d_452847912 == 1011410008 ~ "Royal Oak",
                                                                             d_173836415_d_266600170_d_185243482 == 1010180040 |
                                                                               d_173836415_d_266600170_d_452847912 == 1010180040 ~ "Fairlane (Dearborn)",
                                                                             d_173836415_d_266600170_d_185243482 == 1010120026 |
                                                                               d_173836415_d_266600170_d_452847912 == 1010120026 ~ "Columbus",
                                                                             d_173836415_d_266600170_d_185243482 == 1011660013  |
                                                                               d_173836415_d_266600170_d_452847912 == 1011660013 ~ "Plymouth",
                                                                             d_173836415_d_266600170_d_185243482 == 1010360011 |
                                                                               d_173836415_d_266600170_d_452847912 == 1010360011 ~ "Troy",
                                                                             d_173836415_d_266600170_d_185243482 == 1010350019 | 
                                                                               d_173836415_d_266600170_d_452847912 == 1010350019~ "Taylor",
                                                                             d_173836415_d_266600170_d_185243482 == 1010240013 |
                                                                               d_173836415_d_266600170_d_452847912 == 1010240013 ~ "Livonia",
                                                                             d_173836415_d_266600170_d_185243482 == 1010320019 |
                                                                               d_173836415_d_266600170_d_452847912 == 1010320019 ~ "Sterling Heights",
                                                                             d_173836415_d_266600170_d_185243482 == 1010010193 |
                                                                               d_173836415_d_266600170_d_185243482 == 1010010114 |
                                                                               d_173836415_d_266600170_d_452847912 == 1010010193 |
                                                                               d_173836415_d_266600170_d_452847912 == 1010010114 ~ "K1 HFH Main",
                                                                             d_173836415_d_266600170_d_185243482 == 1010200009 |
                                                                               d_173836415_d_266600170_d_452847912 == 1010200009 ~ "Ford Road",
                                                                             d_173836415_d_266600170_d_185243482 == 1010270015 |
                                                                               d_173836415_d_266600170_d_452847912 == 1010270015 ~ "NCO",
                                                                             d_173836415_d_266600170_d_185243482 == 1050020026 | d_173836415_d_266600170_d_452847912 == 1050020026 ~ "Brownstown",
                                                                             Site=="Henry Ford Health System" & is.na(d_173836415_d_266600170_d_185243482) & is.na(d_173836415_d_266600170_d_452847912) ~ "Missing Location ID",
Site=="University of Chicago Medicine" & (d_173836415_d_266600170_d_185243482==1 | d_173836415_d_266600170_d_452847912==1) ~ "South Loop",
Site=="University of Chicago Medicine" & (d_173836415_d_266600170_d_185243482==2 | d_173836415_d_266600170_d_452847912==2) ~ "Orland Park",
Site=="University of Chicago Medicine" & (d_173836415_d_266600170_d_185243482==3 | d_173836415_d_266600170_d_452847912==3) ~ "Kenwood",
Site=="University of Chicago Medicine" & (d_173836415_d_266600170_d_185243482==4 | d_173836415_d_266600170_d_452847912==4) ~ "River East",
Site=="University of Chicago Medicine" & (d_173836415_d_266600170_d_185243482==5 | d_173836415_d_266600170_d_452847912==5) ~ "Dearborn Station"))
 
col_num <- table(table1_2__locations$Site_location, table1_2__locations$biocol.appoint)


col_num_1.2 <- as.data.frame(col_num)
col_num_1.2 <- col_num_1.2[, c(1,3)]
colnames(col_num_1.2) <- c("Collection Location", "N")
rownames(col_num_1.2) <- col_num_1.2$`Collection Location`


col_num_1.2 <- col_num_1.2 %>%
  mutate(Site_Group = case_when(
    `Collection Location` %in% c("Macomb", "West Bloomfield", "Wyandotte","Fairlane (Dearborn)", "Plymouth", "Royal Oak", "Troy", "K1 HFH Main","Sterling Heights","Columbus", 
                                 "Livonia","Taylor", "Ford Road", "NCO","Brownstown", "Missing Location ID") ~ "Henry Ford Health System", 
    `Collection Location` %in% c("Elk River", "Chanhassen") ~ "HealthPartners", #"NSC", 
    `Collection Location` %in% c("South Loop","Orland Park","Kenwood","River East","Dearborn Station") ~ "University of Chicago Medicine",
    TRUE ~ "Other"
  ))




col_num_1.2$`N` <- as.numeric(col_num_1.2$`N`)
col_num_1.2 <- col_num_1.2 %>%
  filter(!is.na(`N`))


 total_collections <- col_num_1.2 %>%
   group_by(Site_Group) %>%
   summarize(Total_Collections = sum(`N`, na.rm = TRUE))


 col_num_1.2 <- col_num_1.2 %>%
   left_join(total_collections, by = "Site_Group")


col_num_1.2 <- col_num_1.2 %>%
  mutate(Percentage = round((`N` / Total_Collections * 100), digits=1))




total_rows <- col_num_1.2 %>%
  group_by(Site_Group) %>%
  summarize(`Collection Location` = "Total",
            `N` = sum(`N`),
            Percentage = 100) %>%
  ungroup()

col_num_1.2 <- bind_rows(col_num_1.2, total_rows)

col_num_1.2$`Total Clinical Collections` <- paste0(col_num_1.2$`N`, " (", col_num_1.2$Percentage,"%)")
col_num_1.2 <- col_num_1.2[, c(1,3,6)]

col_num_1.2 <- col_num_1.2 %>%
  mutate(`Collection Location` = paste0("\u00A0\u00A0\u00A0", `Collection Location`))



col_num_1.2_gt <- col_num_1.2 %>%

  gt::gt(groupname_col = "Site_Group") 




col_num_1.2_gt <- col_num_1.2_gt %>%  summary_rows(
        groups = TRUE,
        columns = vars("Total Clinical Collections"),
        fns = (Sum = ~sum(.)),
        ) %>% tab_header("Table 1.3: Baseline Clinical Biospecimen Collections by Clinic Location")






table2 <- table1 %>% filter(d_410912345== 353358909) %>%
  mutate(BioFin_BaseBloodCol_v1r0 = factor(BioFin_BaseBloodCol_v1r0, levels=c("Any blood collected","No blood collected"))) 


table2_status <- table2 %>% 
  dplyr::select(Site, BioFin_BaseBloodCol_v1r0 )  %>%
  tbl_cross(
    row = Site,
    col = BioFin_BaseBloodCol_v1r0,
    digits=c(0,1),
    percent = "row",
    label=list(Site="Site",
               BioFin_BaseBloodCol_v1r0 = " "),
    missing="ifany",
    margin_text="Total")

table2_totals <- as.data.frame(table2_status)
table2_totals <- table2_totals[-1, ]

biospe.bld <- knitr::kable(table2_totals ,col.names=c("Site", "Any Baseline Blood Collected","No Baseline Blood Collected", "Total Baseline Collections"), caption='Table 1.5: Baseline Blood Collection Status Among Biospecimen Collections', row.names=FALSE,align=c("l","c","c","c"), booktabs = TRUE)  %>% kable_styling(latex_options = "scale_down")



```



```{r Sanford_Table_1.4, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

table1_4_locs <- table1_2_locs 

# Clin_Site_Loc <- recrver1 %>% 
#   select(Site, Connect_ID, d_173836415_d_266600170_d_185243482, d_173836415_d_266600170_d_452847912)

biospe1_5 <- biospe %>% select( Connect_ID,d_556788178)

table1_4_locs <- left_join(table1, biospe1_5, by = "Connect_ID")

table1_4_locs$biocol.appoint[table1_4_locs$biocol.appoint == "Baseline Collection"] <- "Number of Clinical Collections"

table1_4_locations <- table1_4_locs %>% 
  filter(biocol.appoint == "Number of Clinical Collections") %>% 
  distinct(Connect_ID, .keep_all = TRUE)


add_Site_location <- function(table1_4_locations, csv_file_path) {
  site_data <- read_csv(csv_file_path)
  
  if (!("ID" %in% colnames(site_data)) | !("Site_location" %in% colnames(site_data))) {
    stop("The CSV file must contain 'ID' and 'Site_location' columns.")
  }
  
  case_when_string <- ""
  
  for (i in 1:nrow(site_data)) {
    id <- site_data[i, "ID"]
    location <- site_data[i, "Site_location"]
    
    case_when_string <- paste0(
      case_when_string,
      "d_173836415_d_266600170_d_185243482 == ", id, " | d_173836415_d_266600170_d_452847912 == ", id, " ~ '", location, "',\n"
    )
  }
  
  case_when_string <- substr(case_when_string, 1, nchar(case_when_string) - 2)
  
  case_when_statement <- paste0("case_when(\n", case_when_string, "\n)")
  
  table1_4_locations <- table1_4_locations %>%
    mutate(Site_location = eval(parse(text = case_when_statement)))
  
  return(table1_4_locations)
}


table1_4_locations <- add_Site_location(table1_4_locations, "Sanford_Clincal_Locations.csv")
table1_4_locations <- table1_4_locations %>% filter(!is.na(Site_location))


table1_4_locations_all <- table1_4_locations 
table1_4_locations_7days <- table1_4_locations %>% filter(d_556788178 >= currentDate - 7)
table1_4_locations_30days <- table1_4_locations %>% filter(d_556788178 >= currentDate - 30)


count_all <- table1_4_locations_all %>%
  count(Site_location) %>%
  mutate(Count_Total = n) %>%
  select(-n)

total_all <- sum(count_all$Count_Total)
count_all <- count_all %>%
  mutate(Percent_Total = paste0(round((Count_Total / total_all) * 100, 1), "%"))


count_7days <- table1_4_locations_7days %>%
  count(Site_location) %>%
  mutate(Count_7days = n) %>%
  select(-n)

total_7days <- sum(count_7days$Count_7days)
count_7days <- count_7days %>%
  mutate(Percent_7days = paste0(round((Count_7days / total_7days) * 100, 1), "%"))


count_30days <- table1_4_locations_30days %>%
  count(Site_location) %>%
  mutate(Count_30days = n) %>%
  select(-n)

total_30days <- sum(count_30days$Count_30days)
count_30days <- count_30days %>%
  mutate(Percent_30days = paste0(round((Count_30days / total_30days) * 100, 1), "%"))


final_col_num_1.5 <- full_join(count_all, count_7days, by = "Site_location") %>% full_join(count_30days, by = "Site_location") %>%
  replace_na(list(Count_Total = 0, Percent_Total = "0%", Count_7days = 0, Percent_7days = "0%", Count_30days = 0, Percent_30days = "0%"))


total_row <- data.frame(
  Site_location = "Total",
  Count_Total = total_all,
  Percent_Total = "100%",
  Count_7days = total_7days,
  Percent_7days = "100%",
  Count_30days = total_30days,
  Percent_30days = "100%"
)

final_col_num_1.5 <- bind_rows(final_col_num_1.5, total_row)


final_col_num_1.5$C7 <- paste0(final_col_num_1.5$Count_7days, " (", final_col_num_1.5$Percent_7days, ")")
final_col_num_1.5$C30 <- paste0(final_col_num_1.5$Count_30days, " (", final_col_num_1.5$Percent_30days, ")")

#print(final_col_num_1.5[, c(1,2,8,9)])


```






```{r Coll_Sett_AllSites, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}




## Issue: for whatever reason some people have a null BL_BioSpm_BloodSetting_v1r0/Urine/MW value, so the extra '| d_650516960==' is added
#but 650516960 won't apply correctly to mouthwas all the time

coll_set_spec <- table2 %>%
mutate(
    Blood_Clinical = ifelse(BioFin_BaseBloodCol_v1r0 == "Any blood collected" & (BL_BioSpm_BloodSetting_v1r0=="Clinical" | d_650516960=="664882224"), 1, 0),
    Blood_Research = ifelse(BioFin_BaseBloodCol_v1r0 == "Any blood collected" & (BL_BioSpm_BloodSetting_v1r0=="Research" | d_650516960=="534621077"), 1, 0),
    Blood_Home = ifelse(BioFin_BaseBloodCol_v1r0 == "Any blood collected" & (BL_BioSpm_BloodSetting_v1r0=="Home"| d_650516960=="103209024"), 1, 0),
    Urine_Clinical = ifelse(BioFin_BaseUrineCol_v1r0 == "Any urine collected" & (BL_BioSpm_UrineSetting_v1r0=="Clinical" | d_650516960=="664882224"), 1, 0),
    Urine_Research = ifelse(BioFin_BaseUrineCol_v1r0 == "Any urine collected" & (BL_BioSpm_UrineSetting_v1r0=="Research" | d_650516960=="534621077"), 1, 0),
    Urine_Home = ifelse(BioFin_BaseUrineCol_v1r0 == "Any urine collected" & (BL_BioSpm_UrineSetting_v1r0=="Home"| d_650516960=="103209024"), 1, 0),
    Mouthwash_Clinical = ifelse(BioFin_BaseMWCol_v1r0 == "Any mouthwash collected" & BL_BioSpm_MWSetting_v1r0=="Clinical", 1, 0),
    Mouthwash_Research = ifelse(BioFin_BaseMWCol_v1r0 == "Any mouthwash collected" & BL_BioSpm_MWSetting_v1r0=="Research", 1, 0),
    Mouthwash_Home = ifelse(BioFin_BaseMWCol_v1r0 == "Any mouthwash collected" & BL_BioSpm_MWSetting_v1r0=="Home", 1, 0)
  )

derived_cols <- coll_set_spec %>%
  select(starts_with("Blood"), starts_with("Urine"), starts_with("Mouthwash"))






long_format <- derived_cols %>%
  pivot_longer(
    cols = everything(),
    names_to = c("Specimen_Type", "Location"),
    names_sep = "_",
    values_to = "Count"
  )


long_format <- long_format %>% filter(Count == 1)


cross_tab <- long_format %>%
  group_by(Location, Specimen_Type) %>%
  summarise(Count = n()) %>%
  pivot_wider(names_from = Specimen_Type, values_from = Count, values_fill = list(Count = 0))


total_row <- data.frame(
  Location = "Total",
  Blood = sum(cross_tab$Blood),
  Urine = sum(cross_tab$Urine),
  Mouthwash = sum(cross_tab$Mouthwash)
)

allsites_crosstab <- bind_rows(cross_tab, total_row)


  
  # Perentages
  allsites_crosstab <- allsites_crosstab %>%
    mutate(across(starts_with("Blood"), ~ paste0(.x, " (", round(.x / allsites_crosstab$Blood[4], digits = 3) * 100, "%)")),
           across(starts_with("Urine"), ~ paste0(.x, " (", round(.x / allsites_crosstab$Urine[4], digits = 3) * 100, "%)")),
           across(starts_with("Mouthwash"), ~ paste0(.x, " (", round(.x / allsites_crosstab$Mouthwash[4], digits = 3) * 100, "%)")))
  
  # Format the total row separately
  #allsites_crosstab[nrow(allsites_crosstab), -1] <- lapply(allsites_crosstab[nrow(allsites_crosstab), -1], function(x) paste0(x)) #, " (100%)"
  allsites_crosstab[nrow(allsites_crosstab), 2:4] <- lapply(allsites_crosstab[nrow(allsites_crosstab), 2:4], function(x) gsub("\\(100%\\).*", "(100%)", x))


```

```{r Coll_Sett_Hyrbids, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

##need to check this. Wasn't merged correctly in the merge conlflict on Github
table2_hybrid <- table2 %>%  filter(Site=="Henry Ford Health System" | Site=="HealthPartners" | Site=="Sanford Health" | Site=="University of Chicago Medicine")

sites <- unique(table2_hybrid$Site)
site_results <- list()

for (site in sites) {
  site_data <- filter(table2_hybrid, Site == site)

coll_set_spec <- site_data  %>%
mutate(
    Blood_Clinical = ifelse(BioFin_BaseBloodCol_v1r0 == "Any blood collected" & (BL_BioSpm_BloodSetting_v1r0=="Clinical" | d_650516960=="664882224"), 1, 0),
    Blood_Research = ifelse(BioFin_BaseBloodCol_v1r0 == "Any blood collected" & (BL_BioSpm_BloodSetting_v1r0=="Research" | d_650516960=="534621077"), 1, 0),
    Blood_Home = ifelse(BioFin_BaseBloodCol_v1r0 == "Any blood collected" & (BL_BioSpm_BloodSetting_v1r0=="Home"| d_650516960=="103209024"), 1, 0),
    Urine_Clinical = ifelse(BioFin_BaseUrineCol_v1r0 == "Any urine collected" & (BL_BioSpm_UrineSetting_v1r0=="Clinical" | d_650516960=="664882224"), 1, 0),
    Urine_Research = ifelse(BioFin_BaseUrineCol_v1r0 == "Any urine collected" & (BL_BioSpm_UrineSetting_v1r0=="Research" | d_650516960=="534621077"), 1, 0),
    Urine_Home = ifelse(BioFin_BaseUrineCol_v1r0 == "Any urine collected" & (BL_BioSpm_UrineSetting_v1r0=="Home"| d_650516960=="103209024"), 1, 0),
    Mouthwash_Clinical = ifelse(BioFin_BaseMWCol_v1r0 == "Any mouthwash collected" & BL_BioSpm_MWSetting_v1r0=="Clinical", 1, 0),
    Mouthwash_Research = ifelse(BioFin_BaseMWCol_v1r0 == "Any mouthwash collected" & BL_BioSpm_MWSetting_v1r0=="Research", 1, 0),
    Mouthwash_Home = ifelse(BioFin_BaseMWCol_v1r0 == "Any mouthwash collected" & BL_BioSpm_MWSetting_v1r0=="Home", 1, 0)
  )

  
  derived_cols <- coll_set_spec %>%
    select(starts_with("Blood"), starts_with("Urine"), starts_with("Mouthwash"))
  
  long_format <- derived_cols %>%
    pivot_longer(
      cols = everything(),
      names_to = c("Specimen_Type", "Location"),
      names_sep = "_",
      values_to = "Count"
    ) %>%
    filter(Count == 1)
  
  cross_tab_HYB <- long_format %>%
    group_by(Location, Specimen_Type) %>%
    summarise(Count = n(), .groups = 'drop') %>%  # <--- Added .groups = 'drop'
    pivot_wider(
      names_from = Specimen_Type,
      values_from = Count,
      values_fill = list(Count = 0)
    )
  
  # Add Home back with zero counts if it doesn't exist
  if (!"Home" %in% cross_tab_HYB$Location) {
    # <--- Added this block
    cross_tab_HYB <- cross_tab_HYB %>%
      add_row(
        Location = "Home",
        Blood = 0,
        Urine = 0,
        Mouthwash = 0
      )  
  }
  
  total_row <- data.frame(
    Location = "Total",
    Blood = sum(cross_tab_HYB$Blood),
    Urine = sum(cross_tab_HYB$Urine),
    Mouthwash = sum(cross_tab_HYB$Mouthwash)
  )
  
  hybrid_crosstab <- bind_rows(cross_tab_HYB, total_row)
  
  # Perentages
  hybrid_crosstab <- hybrid_crosstab %>%
    mutate(across(starts_with("Blood"), ~ paste0(.x, " (", round(.x / hybrid_crosstab$Blood[4], digits = 3) * 100, "%)")),
           across(starts_with("Urine"), ~ paste0(.x, " (", round(.x / hybrid_crosstab$Urine[4], digits = 3) * 100, "%)")),
           across(starts_with("Mouthwash"), ~ paste0(.x, " (", round(.x / hybrid_crosstab$Mouthwash[4], digits = 3) * 100, "%)")))
  
  # Format the total row separately
  #hybrid_crosstab[nrow(hybrid_crosstab), -1] <- lapply(hybrid_crosstab[nrow(hybrid_crosstab), -1], function(x) paste0(x)) #, " (100%)"
  hybrid_crosstab[nrow(hybrid_crosstab), 2:4] <- lapply(hybrid_crosstab[nrow(hybrid_crosstab), 2:4], function(x) gsub("\\(100%\\).*", "(100%)", x))

  
  # Store the result for the current site
  site_results[[site]] <- hybrid_crosstab
}


```



```{r RemovedTable6, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}


#But this is now used for the deviations

levels(recrver1$BioFin_BaseBloodCol_v1r0)

biocol <- recrver1   %>%  group_by(BioFin_BaseBloodCol_v1r0,BioFin_BaseUrineCol_v1r0,BioFin_BaseMWCol_v1r0) %>% dplyr::tally()   #%>% filter(d_410912345==353358909)

biocol$BioFin_BaseBloodCol_v1r0= ifelse(biocol$BioFin_BaseBloodCol_v1r0=="Any blood collected", "Yes", "No")
biocol$BioFin_BaseUrineCol_v1r0= ifelse(biocol$BioFin_BaseUrineCol_v1r0=="Any urine collected", "Yes", "No")
biocol$BioFin_BaseMWCol_v1r0= ifelse(biocol$BioFin_BaseMWCol_v1r0=="Any mouthwash collected", "Yes", "No")

total <- nrow(recrver1)
biocol$pct <- round(100*biocol$n/nrow(recrver1),digits=1)
#biocol$cumcount <- cumsum(biocol$n)
#biocol$cumpct <- round(100*cumsum(biocol$n)/nrow(recrver1),digits=1)

# biocol <- apply_labels(biocol, total,
#                        pct="percentage of Total verified %")
#                        #cumcount="cumulative counts of verified",
#                        #cumpct="cumulative percentage")

db <- dim(biocol)[[1]]
#biocol <- as_kable(biocol)
func <- function(z) {ifelse(is.numeric(z), round(sum(z), digits=0),'')}
sumrow <- as.data.frame(lapply(biocol, func))
#kable(rbind(df, sumrow))
biocol[,5]
biocol[(db+1),] <- sumrow
biocol[(db+1),1] <- "Total"
biocol[(db+1),2] <- "-"
biocol[(db+1),3] <- "-"

colnames(biocol) <- c("Any Blood Collected","Urine Collected","Mouthwash Collected","Number","Percent")

###Table 6. by site
biocol.site <- list()
recrver1$Site <- droplevels(recrver1$Site)
for(site in unique(recrver1$Site)){
  
  site.sub <- recrver1 %>% filter(Site==site) %>% 
    group_by(BioFin_BaseBloodCol_v1r0,BioFin_BaseUrineCol_v1r0,BioFin_BaseMWCol_v1r0) %>% dplyr::tally() 
  
  site.sub$BioFin_BaseBloodCol_v1r0= ifelse(site.sub$BioFin_BaseBloodCol_v1r0=="Any blood collected", "Yes", "No")
  site.sub$BioFin_BaseUrineCol_v1r0= ifelse(site.sub$BioFin_BaseUrineCol_v1r0=="Any urine collected", "Yes", "No")
  site.sub$BioFin_BaseMWCol_v1r0= ifelse(site.sub$BioFin_BaseMWCol_v1r0=="Any mouthwash collected", "Yes", "No")
  
  total <- as.numeric(nrow(recrver1[which(recrver1$Site==site),]))
  site.sub$pct <- round(100*site.sub$n/total,digits=1)
  
ds <- dim(site.sub)[[1]]
func <- function(z) {ifelse(is.numeric(z), round(sum(z), digits=0),'')}
sumrow <- as.data.frame(lapply(site.sub, func))

site.sub[(ds+1),] <- sumrow
site.sub[(ds+1),1] <- "Total"
site.sub[(ds+1),2] <- "-"
site.sub[(ds+1),3] <- "-"


  biocol.site[[site]] <- site.sub

}

```



```{r Table5a5b, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}


  
site.sub1 <- table1 %>% filter(d_410912345==353358909) 
  
  
site.sub <- site.sub1 %>%  mutate(Setting = case_when(d_650516960==534621077 ~ "Research Collections",
                                                        d_650516960==664882224 ~ "Clinical Collections",
                                                        TRUE ~ "No Collections"),
                                'Specimens Collected'= case_when((BioFin_BaseBloodCol_v1r0=="Any blood collected" & BioFin_BaseUrineCol_v1r0=="Any urine collected" & BioFin_BaseMWCol_v1r0=="Any mouthwash collected") ~ 'Blood, Urine, Mouthwash (All)',
                                                                 (BioFin_BaseBloodCol_v1r0=="Any blood collected" & BioFin_BaseUrineCol_v1r0=="Any urine collected" & BioFin_BaseMWCol_v1r0!="Any mouthwash collected") ~ 'Blood & Urine Only',
                                                                 (BioFin_BaseBloodCol_v1r0=="Any blood collected" & BioFin_BaseUrineCol_v1r0!="Any urine collected" & BioFin_BaseMWCol_v1r0=="Any mouthwash collected") ~ 'Blood & Mouthwash Only',
                                                                 (BioFin_BaseBloodCol_v1r0!="Any blood collected" & BioFin_BaseUrineCol_v1r0=="Any urine collected" & BioFin_BaseMWCol_v1r0=="Any mouthwash collected") ~ 'Urine & Mouthwash Only',
                                                                 (BioFin_BaseBloodCol_v1r0=="Any blood collected" & BioFin_BaseUrineCol_v1r0!="Any urine collected" & BioFin_BaseMWCol_v1r0!="Any mouthwash collected") ~ 'Blood Only',
                                                                 (BioFin_BaseBloodCol_v1r0!="Any blood collected" & BioFin_BaseUrineCol_v1r0=="Any urine collected" & BioFin_BaseMWCol_v1r0!="Any mouthwash collected") ~ 'Urine Only',
                                                                 (BioFin_BaseBloodCol_v1r0!="Any blood collected" & BioFin_BaseUrineCol_v1r0!="Any urine collected" & BioFin_BaseMWCol_v1r0=="Any mouthwash collected") ~ 'Mouthwash Only',
                                                                 (BioFin_BaseBloodCol_v1r0!="Any blood collected" & BioFin_BaseUrineCol_v1r0!="Any urine collected" & BioFin_BaseMWCol_v1r0!="Any mouthwash collected") ~ 'No Specimens Collected'))
site.sub$'Specimens Collected' <- factor(site.sub$'Specimens Collected',levels=c('Blood, Urine, Mouthwash (All)', 'Blood & Urine Only','Blood & Mouthwash Only','Urine & Mouthwash Only','Blood Only','Urine Only','Mouthwash Only','No Specimens Collected'))

table4_redone__R <- site.sub %>% filter(Setting=="Research Collections") 
table4_redone__R$Site <- droplevels(table4_redone__R$Site)
table4_redone__R$'Specimens Collected' <- droplevels(table4_redone__R$'Specimens Collected')
coll_completenessR <- table4_redone__R %>% dplyr::select('Specimens Collected', Site )  %>% 
  tbl_cross(
    row = 'Specimens Collected',
    col = Site,
    digits=c(0,1),
    percent = "col",
    label=list(Site="Site"),
    missing="ifany",
    margin_text="Total")



coll_completenessR_totals <- as.data.frame(coll_completenessR)

coll_completenessR_totals <- coll_completenessR_totals[-1, ]

current_colnames <- colnames(coll_completenessR_totals)

current_colnames[length(current_colnames)] <- "Total Research Collections"
current_colnames[1] <- "Site"

colnames(coll_completenessR_totals) <- current_colnames











site.sub <- site.sub1 %>%  mutate(Setting = case_when(d_650516960==534621077 ~ "Research Collections",
                                                        d_650516960==664882224 ~ "Clinical Collections",
                                                        TRUE ~ "No Collections"),
                                'Specimens Collected'= case_when((BioFin_BaseBloodCol_v1r0=="Any blood collected" & BioFin_BaseUrineCol_v1r0=="Any urine collected" & BioFin_BaseMWCol_v1r0!="Any mouthwash collected") ~ 'Blood & Urine (All)',
                                                                 (BioFin_BaseBloodCol_v1r0=="Any blood collected" & BioFin_BaseUrineCol_v1r0!="Any urine collected" & BioFin_BaseMWCol_v1r0!="Any mouthwash collected") ~ 'Blood Only',
                                                                 (BioFin_BaseBloodCol_v1r0!="Any blood collected" & BioFin_BaseUrineCol_v1r0=="Any urine collected" & BioFin_BaseMWCol_v1r0!="Any mouthwash collected") ~ 'Urine Only',
                                                                 (BioFin_BaseBloodCol_v1r0!="Any blood collected" & BioFin_BaseUrineCol_v1r0!="Any urine collected" & BioFin_BaseMWCol_v1r0!="Any mouthwash collected") ~ 'No Specimens Collected',
                                                                 TRUE ~ "Unknown")) %>%  filter('Specimens Collected'!="Mouthwash" & 'Specimens Collected' != "Unknown")

unique(site.sub$`Specimens Collected`)

site.sub <- site.sub %>% filter(`Specimens Collected` != "Mouthwash" & `Specimens Collected` != "Unknown")

unique(site.sub$`Specimens Collected`)

site.sub$`Specimens Collected` <- factor(site.sub$`Specimens Collected`, levels = c('Blood & Urine (All)', 'Blood Only', 'Urine Only', 'No Specimens Collected'))


table4_redone__C <- site.sub %>%
  filter(Setting == "Clinical Collections")

table4_redone__C$Site <- droplevels(table4_redone__C$Site)
table4_redone__C$'Specimens Collected' <- droplevels(table4_redone__C$'Specimens Collected')
coll_completenessC <- table4_redone__C %>%   dplyr::select('Specimens Collected', Site )  %>% 
  tbl_cross(
    row = 'Specimens Collected',
    col = Site,
    digits=c(0,1),
    percent = "col",
    label=list(Site="Site"),
    missing="ifany",
    margin_text="Total")




coll_completenessC_totals <- as.data.frame(coll_completenessC)

coll_completenessC_totals <- coll_completenessC_totals[-1, ]


current_colnames <- colnames(coll_completenessC_totals)


current_colnames[length(current_colnames)] <- "Total Clinical Collections"
current_colnames[1] <- "Specimens Collected"

colnames(coll_completenessC_totals) <- current_colnames


```







```{r Table6, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}
##Fig 1(table6)
recrver1 <- recrver1 %>% mutate(BiospmCols_v1r0 = 
                                  case_when((recrver1$d_684635302 == 353358909 & recrver1$d_878865966 == 353358909 & recrver1$d_167958071 == 353358909) ~ "All blood, urine and mouthwash",
                                            (recrver1$d_684635302 == 353358909 & recrver1$d_878865966 == 353358909 & recrver1$d_167958071 == 104430631) ~ "Mouthwash and blood, no urine",
                                            (recrver1$d_684635302 == 353358909 & recrver1$d_878865966 == 104430631 & recrver1$d_167958071 == 104430631) ~ "Only mouthwash,no blood or urine",
                                            (recrver1$d_684635302 == 104430631 & recrver1$d_878865966 == 353358909 & recrver1$d_167958071 == 353358909) ~ "Blood and urine, no mouthwash",
                                            (recrver1$d_684635302 == 104430631 & recrver1$d_878865966 == 104430631 & recrver1$d_167958071 == 353358909) ~ "Only urine, no blood or mouthwash",
                                            (recrver1$d_684635302 == 353358909 & recrver1$d_878865966 == 104430631 & recrver1$d_167958071 == 353358909) ~ "Mouthwash and urine, no blood",
                                            (recrver1$d_684635302 == 104430631 & recrver1$d_878865966 == 353358909 & recrver1$d_167958071 == 104430631) ~ "Only blood, no urine or mouthwash",
                                            ((recrver1$d_684635302 == 104430631 | is.na(recrver1$d_684635302)) & (recrver1$d_878865966 == 104430631 | is.na(recrver1$d_878865966)) & (is.na(recrver1$d_167958071) |recrver1$d_167958071 == 104430631)) ~ "No any biospecimen collections"))

table(as.character(recrver1$d_684635302))








### NOT SURE WHAT THIS CODE SECTION GOES TO 
table_colspm <- recrver1[which(recrver1$d_684635302 == 353358909 | recrver1$d_878865966 == 353358909 | recrver1$d_167958071 == 353358909),] %>%
        group_by(BiospmCols_v1r0) %>% dplyr::summarise(count=n()) 
table_colspm$count_pct <- paste0(table_colspm$count," (", round(100*table_colspm$count/sum(table_colspm$count),digits=1),"%)")
table_colspm <- table_colspm[order(-table_colspm$count),]
table_colspm$midpoint = cumsum(table_colspm$count) - (table_colspm$count / 2)
table_colspm$midpoint <- ifelse(table_colspm$count>7, table_colspm$count, cumsum(table_colspm$count) - (table_colspm$count / 2))
table_colspm$midpoint
ggplot(table_colspm, aes(x = "", y = count, fill = BiospmCols_v1r0)) +
  geom_bar(width = 1, stat = "identity") +
  coord_polar(theta = "y", start = 0) +
  scale_fill_manual(values = c("light blue", "Red", "Green", "Orange", "Pink", "Purple","Yellow")) +
  scale_colour_brewer(palette = "Set1") +
  labs(x = "", y = "", title = "Percent (and number) of Biospecimen Collection Completion among baseline collections",
       fill = "BiospmCols_v1r0") + 
  geom_text(aes(x=1.6, label=count_pct),
            position =  position_stack(vjust=0.6), size=3) +
  geom_text(aes(x = 1.3, y = midpoint , label = count_pct), color="black",
            fontface = "bold") +
  theme(plot.title = element_text(hjust = 0.5), 
        legend.title = element_text(hjust = 0.5, face="bold", size = 10))


#label outside
ggplot(table_colspm, aes(x = "", y = count, fill = BiospmCols_v1r0)) +
  geom_bar(width = 1, stat = "identity") +
  coord_polar(theta = "y", start = 0) +
  scale_fill_manual(values = c("light blue", "Red", "Green", "Orange", "Pink", "Purple","Yellow")) +
  #scale_colour_brewer(palette = "Set1") +
  labs(x = "", y = "", title = "Percent (and number) of Biospecimen Collection Completion among baseline collections",
       fill = "BiospmCols_v1r0") + 
  geom_text(aes(x=1.6, label=count_pct),
            position =  position_stack(vjust=0.6), size=3, color="black",fontface = "bold") +
  theme(panel.background = element_blank(),
        plot.title = element_text(hjust = 0.0, face="bold"), 
        axis.ticks = element_blank(),axis.text = element_blank(),
        legend.title = element_text(hjust = 0.5, face="bold", size = 10))


###for the biospecimen data:collections, deviation, and nocollections# ###Table 14. Number of blood, urine, and mouthwash collected by collection setting
pct_tb <- function(x,y){
  table1 <- CrossTable(x,y, prop.t=FALSE, prop.r=FALSE, prop.c=TRUE,chisq=FALSE)
  pct <- as.data.frame(cbind(table1$prop.row,table1$t))
  if(ncol(pct)==2){
    total <- as.numeric(sum(pct[,2]))
    pct[nrow(pct)+1,c(1:2)] <- c(1,total)
    rownames(pct)[nrow(pct)] <- "Total"
    colnames(pct)[1] <- paste0("pct_",colnames(pct)[1])
    colnames(pct)[2] <- paste0("n_",colnames(pct)[2])
    
  }
  else  if(ncol(pct)>2 ){
    total <- as.numeric(sum(pct[,3] + pct[,4]))
    pct[nrow(pct)+1,c(1:4)] <- c(sum(pct[,3])/total,sum(pct[,4])/total,sum(pct[,3]),sum(pct[,4]))
    rownames(pct)[nrow(pct)] <- "Total"
    colnames(pct)[c(1:2)] <- paste0("pct_",colnames(pct[c(1:2)]))
    colnames(pct)[c(3:4)] <- paste0("n_",colnames(pct)[c(3:4)])
    
    pct[,5] <- paste0(format(pct[,3],big.mark=","), " (",round(100*pct[,1],1), "%)")
    pct[,6] <- paste0(format(pct[,4],big.mark=","), " (",round(100*pct[,2],1), "%)") 
    colnames(pct)[5] <- paste0("n_",colnames(pct)[1])
    colnames(pct)[6] <- paste0("n_",colnames(pct)[2])
  }
  return(pct)
}



###Tables on the biospecimen samples
##Table6_bysite. the research blood collection completions
##for blood collection based on the biospecimen data individually
biospe<- expss::apply_labels(biospe,d_827220437 = "Site",#RcrtES_Site_v1r0
                     d_827220437 = c("Baylor Scott and White Health"=472940358, "HealthPartners"= 531629870, "Henry Ford Health System"=548392715,"Marshfield Clinic Health System" = 303349821,"Sanford Health" = 657167265, "University of Chicago Medicine" = 809703864, "Kaiser Permanente Colorado" = 125001209,"Kaiser Permanente Georgia" = 327912200,"Kaiser Permanente Hawaii" = 300267574,"Kaiser Permanente Northwest" = 452412599,"National Cancer Institute" = 517700004,"National Cancer Institute" = 13,"Other" = 181769837))

biospe$Site <- factor(biospe$d_827220437, levels= c("Baylor Scott and White Health", "HealthPartners", "Henry Ford Health System","Marshfield Clinic Health System","Sanford Health", "University of Chicago Medicine","Kaiser Permanente Colorado","Kaiser Permanente Georgia","Kaiser Permanente Hawaii","Kaiser Permanente Northwest")) 


biospe <- biospe %>% arrange(Site)
#tubes <- dd[grepl(" Tube ",dd$`Variable Label`),]
tubes <- unique(y[grepl(" Tube ",y$`Secondary.Source`),c("conceptId.1","Secondary.Source")])
tubes[grepl("00", tubes$`Variable Name`),]

# 6: 652357376             ACD Tube 1 BioCol_0005_v1r0
bld.ls <- c("d_299553921","d_703954371","d_454453939","d_838567176","d_652357376","d_376960806","d_232343615","d_589588440","d_677469051", "d_683613884","d_958646668", "d_505347689") #STRECK added 

tubeid <- grep("d_825582494", names(biospe), value=TRUE) #tube ID
deviation <- grep("d_678857215",names(biospe),value=TRUE) 
colid <- grep("d_593843561", names(biospe), value=TRUE) #collected yes/no
discard <- grep("d_762124027",names(biospe),value=TRUE) #discard yes/no
biodiscard <- biospe[,(which(names(biospe) %in% discard))]

biospe$blddev <-0 #blood deviations
biospe$bldcol <- 0 #blood collections
biospe$blddid <- 0 #discarded
for(i in 1:length(bld.ls)){
  
  bldcol <- ifelse(biospe[,paste(bld.ls[i],"d_593843561",sep="_")] == 104430631 | is.na(biospe[,paste(bld.ls[i],"d_593843561",sep="_")]),0,1)  ##for tube collected
  
  blddev <- ifelse(biospe[,paste(bld.ls[i],"d_678857215",sep="_")]==104430631 | is.na(biospe[,paste(bld.ls[i],"d_678857215",sep="_")]),0,1) #for tube deviations yes/no
  
  blddid <- ifelse(biospe[,paste(bld.ls[i],"d_762124027",sep="_")]==104430631 | is.na(biospe[,paste(bld.ls[i],"d_762124027",sep="_")]),0,1)
  
  biospe$blddev <- biospe$blddev+blddev
  biospe$bldcol <- bldcol + biospe$bldcol ###to check collection
  biospe$blddid <- biospe$blddid+blddid  
  
}
table(biospe$d_650516960,biospe$bldcol)
biospe <- biospe %>% mutate(bloodcomplete = ifelse((d_650516960==534621077 & bldcol == 5) | (d_650516960==664882224 & bldcol == 11), "Blood.Completion" ,#blood collection completion
                                          ifelse( (d_650516960==534621077 & (bldcol<5 & bldcol>0)) | (d_650516960==664882224 & (bldcol <  11 & bldcol < 0)),"Blood.Incompleted","NoBlood")),
                            Urine_col = ifelse(d_973670172_d_593843561==353358909, 1, ifelse(d_973670172_d_593843561==104430631,0,0)),
                            MW_col = ifelse(d_143615646_d_593843561==353358909,1,ifelse(d_143615646_d_593843561==104430631,0,0)),
                            biocol_Setting = case_when(d_650516960==534621077  ~"Research",
                                                        d_650516960==664882224 ~ "Clinical",
                                                         d_650516960 ==103209024 ~ "Home")) 
biospe$Biospe_col <- biospe$bldcol + biospe$Urine_col + biospe$MW_col    
biospe$BaseBLDCol <-ifelse(biospe$bldcol>0,1,ifelse(is.na(biospe$bldcol),NA,0)) #blood collection Yes/No
biospe[duplicated(biospe$Connect_ID),]$Connect_ID







### Table 5
tube_col <- biospe  %>% group_by(as.character(Connect_ID),Site,d_650516960) %>% 
  dplyr::summarise(bldcol_max = max(bldcol),
                   Urine_col_max= max(Urine_col),
                   MW_col_max=max(MW_col),
                   d_973670172_d_593843561_max=max(d_973670172_d_593843561),
                   d_143615646_d_593843561_max = max(d_143615646_d_593843561),
                   d_410912345_max=max(d_410912345),
                   collection.tm =max(as.POSIXct(ymd_hms(d_556788178))),
                   schedulecol.tm =min(as.POSIXct(ymd_hms(d_678166505))))



table(tube_col$d_650516960)
 
tube_col$Connect_ID <- as.numeric(tube_col$`as.character(Connect_ID)`)
tube_research <- tube_col %>% filter(d_650516960==534621077) %>%
  mutate(bld.complt = ifelse(ifelse(collection.tm < as.Date("2024-03-01") | Site=="HealthPartners", bldcol_max==5, bldcol_max==4),"BloodCompletion",ifelse(bldcol_max==0, "NoBlood","BloodIncomplet")))

table.bldcol <- ctable(tube_research$Site,tube_research$bld.complt)
bldcol_research <- as.data.frame(cbind(table.bldcol$cross_table,table.bldcol$proportions))
bldcol_research$Site <-trimws(rownames(bldcol_research))

                             
bldcol_research$n_pct_BloodCompletion <- ifelse(!grepl("Total",rownames(bldcol_research)),  paste(format(bldcol_research[,1],big.mark=","),"(", round(100*bldcol_research[,5],1),"%)",sep=" "), format(bldcol_research[,1],big.mark="," ))
bldcol_research$n_pct_BloodInompletion = ifelse(!grepl("Total",rownames(bldcol_research)),  paste(format(bldcol_research[,2],big.mark=","),"(", round(100*bldcol_research[,6],1),"%)",sep=" "), format(bldcol_research[,2],big.mark="," ))
bldcol_research$n_pct_NoBlood = ifelse(!grepl("Total",rownames(bldcol_research)),  paste(format(bldcol_research[,3],big.mark=","),"(", round(100*bldcol_research[,7],1),"%)",sep=" "), format(bldcol_research[,3],big.mark="," ))
         
bldcol_research1 <- bldcol_research[c(1:6),c(9:12,4)] #c(9:12,4)

```




```{r Table7s, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}


#### U-Chicago
biospe= biospe %>%  mutate(UC_Sites= case_when(d_951355211==777644826 ~ "UC-DCAM",
                                       d_951355211==145191545 ~ "Ingalls Harvey",
                                       d_951355211==489380324 ~ "River East",
                                       d_951355211==120264574 ~ "South Loop",
                                       d_951355211==319518299 ~ "UCM Pop-Up",
                                       d_951355211==940329442 ~ "Orland Park"))
tube_col_UC <- biospe   %>% filter(d_827220437==809703864) %>% group_by(as.character(Connect_ID),UC_Sites,d_650516960) %>% 
  dplyr::summarise(bldcol_max = max(bldcol,na.rm=TRUE),
                   Urine_col_max= max(Urine_col,na.rm=TRUE),
                   MW_col_max=max(MW_col,na.rm=TRUE),
                   d_973670172_d_593843561_max=max(d_973670172_d_593843561,na.rm=TRUE),
                   d_143615646_d_593843561_max = max(d_143615646_d_593843561,na.rm=TRUE),
                   d_410912345_max=max(d_410912345,na.rm=TRUE),
                   collection.tm =max(as.POSIXct(ymd_hms(d_556788178)),na.rm=TRUE),
                   schedulecol.tm =min(as.POSIXct(ymd_hms(d_678166505)),na.rm=TRUE))

tube_col_UC$Connect_ID <- as.numeric(tube_col_UC$`as.character(Connect_ID)`)

tube_research_UC <- tube_col_UC %>% filter(d_650516960==534621077) %>%
  mutate(bld.complt = ifelse(ifelse(collection.tm < as.Date("2024-03-01"), bldcol_max==5, bldcol_max==4),"BloodCompletion",
                             ifelse(bldcol_max==0, "NoBlood","BloodIncomplet")))

table.bldcol_UC <- ctable(tube_research_UC$UC_Sites,tube_research_UC$bld.complt)
bldcol_research_UC <- as.data.frame(cbind(table.bldcol_UC$cross_table,table.bldcol_UC$proportions))
bldcol_research_UC$UC_Sites <-trimws(rownames(bldcol_research_UC))
                             

bldcol_research_UC$n_pct_BloodCompletion <-  paste(format(bldcol_research_UC[,1],big.mark=","),"(", round(100*bldcol_research_UC[,5],1),"%)",sep=" ") 
bldcol_research_UC$n_pct_BloodInompletion =  paste(format(bldcol_research_UC[,2],big.mark=","),"(", round(100*bldcol_research_UC[,6],1),"%)",sep=" ") 
bldcol_research_UC$n_pct_NoBlood = paste(format(bldcol_research_UC[,3],big.mark=","),"(", round(100*bldcol_research_UC[,7],1),"%)",sep=" ") 

bldcol_research_UC$Total <- paste(bldcol_research_UC$Total, " (100%)")
nrow(bldcol_research_UC)
         
bldcol_research_UC1 <- bldcol_research_UC[,c(9:12,4)]





### HF Research
biospe= biospe  %>% mutate(HF_Sites= case_when(d_951355211==736183094 ~ "HFH K-13 Research Clinic",
                                       d_951355211==886364332 ~ "HFH Cancer Pavilion Research Clinic",
                                       d_951355211==706927479 ~ "HFH Livonia Research Clinic",
                                       d_951355211==322059622 ~ "HFH Pop-Up"))
tube_col_HF <- biospe  %>% group_by(as.character(Connect_ID),HF_Sites,d_650516960) %>% 
  filter(HF_Sites=="HFH K-13 Research Clinic" | HF_Sites=="HFH Cancer Pavilion Research Clinic" |  HF_Sites=="HFH Livonia Research Clinic" |  HF_Sites=="HFH Pop-Up") %>% 
  dplyr::summarise(bldcol_max = max(bldcol,na.rm=TRUE),
                   Urine_col_max= max(Urine_col,na.rm=TRUE),
                   MW_col_max=max(MW_col,na.rm=TRUE),
                   d_973670172_d_593843561_max=max(d_973670172_d_593843561,na.rm=TRUE),
                   d_143615646_d_593843561_max = max(d_143615646_d_593843561,na.rm=TRUE),
                   d_410912345_max=max(d_410912345,na.rm=TRUE),
                   collection.tm =max(as.POSIXct(ymd_hms(d_556788178)),na.rm=TRUE),
                   schedulecol.tm =min(as.POSIXct(ymd_hms(d_678166505)),na.rm=TRUE))
table(tube_col_HF$d_650516960)

tube_col_HF$Connect_ID <- as.numeric(tube_col_HF$`as.character(Connect_ID)`)

tube_research_HF <- tube_col_HF %>% filter(d_650516960==534621077) %>%
    mutate(bld.complt = ifelse(ifelse(collection.tm < as.Date("2024-03-01"), bldcol_max==5, bldcol_max==4),"BloodCompletion",ifelse(bldcol_max==0, "NoBlood","BloodIncomplet")))

table.bldcol_HF <- ctable(tube_research_HF$HF_Sites,tube_research_HF$bld.complt)
bldcol_research_HF <- as.data.frame(cbind(table.bldcol_HF$cross_table,table.bldcol_HF$proportions))
bldcol_research_HF$HF_Sites <-trimws(rownames(bldcol_research_HF))
                            

bldcol_research_HF$n_pct_BloodCompletion <- paste(format(bldcol_research_HF[,1],big.mark=","),"(", round(100*bldcol_research_HF[,5],1),"%)",sep=" ")
bldcol_research_HF$n_pct_BloodInompletion = paste(format(bldcol_research_HF[,2],big.mark=","),"(", round(100*bldcol_research_HF[,6],1),"%)",sep=" ")
bldcol_research_HF$n_pct_NoBlood = paste(format(bldcol_research_HF[,3],big.mark=","),"(", round(100*bldcol_research_HF[,7],1),"%)",sep=" ")

bldcol_research_HF$Total <- paste(bldcol_research_HF$Total, " (100%)")
nrow(bldcol_research_HF)
         
bldcol_research_HF1 <- bldcol_research_HF[,c(9:12,4)]
```


```{r Table7.3, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}


biocounts <- biospe %>%  select(Connect_ID, bldcol, d_556788178)
left7 <- left_join(table1_2__locations, biocounts, by="Connect_ID")
biospe7= left7  %>%   filter(Site=="Henry Ford Health System") 
biospe7$HF_Sites <- biospe7$Site_location                             

tube_col_HF2 <- biospe7  %>% group_by(as.character(Connect_ID),HF_Sites,d_650516960) %>%
  dplyr::summarise(bldcol_max = max(bldcol,na.rm=TRUE),
                   collection.tm =max(as.POSIXct(ymd_hms(d_556788178)),na.rm=TRUE))
  
  
tube_col_HF2$Connect_ID <- as.numeric(tube_col_HF2$`as.character(Connect_ID)`)

tube_research_HF2 <- tube_col_HF2 %>% filter(d_650516960==664882224) %>%
  mutate(bld.complt = ifelse(ifelse(collection.tm < as.Date("2024-03-01"), bldcol_max==5, bldcol_max==4),"All Blood Collected",
                              ifelse(bldcol_max==0, "No Blood Collected","Partial Blood Collected"))) 

tube_research_HF2$bld.complt <- factor(tube_research_HF2$bld.complt, levels = c("All Blood Collected","Partial Blood Collected",  "No Blood Collected" ))

clin_bldcnt_HF2_cross <- tube_research_HF2 %>% 
  tbl_cross(
    row = HF_Sites,
    col = bld.complt,
    digits=c(0,1),
    percent = "row",
    label=list(HF_Sites="Clinical Location",
                bld.complt = " "),
    missing="ifany",
    missing_text="0 ( 0 %)",
    margin_text="Total") 

clin_bldcnt_HF2_df <- as.data.frame(clin_bldcnt_HF2_cross$table_body)

clin_bldcnt_HF2 <- clin_bldcnt_HF2_df[c(2:nrow(clin_bldcnt_HF2_df)),c(5:9)]

```



```{r Table9, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

pct_n <- function(x,y){ paste0(x,"( ", round(100*y,2), " %)")}
n_pct_table <- function(x,y){
  #x<-clinicnotes.notcol$Site
  #y<-clinicnotes.notcol$notcol.notes
  ctable<- CrossTable(x,y)
count <- as.data.frame.matrix(ctable$t)
perc <- as.data.frame.matrix(ctable$prop.col)
n<- as.numeric(length(levels(x)))
m <- as.numeric(length(levels(y)))
tb_combo <- array(pct_n(ctable$t,ctable$prop.col),dim=c(n,m)) 
  tb_combo <- as.data.frame(tb_combo)
  colnames(tb_combo) <- colnames(count)
  
  total <- sum(count)
  count$Total <- apply(count,1,sum)
  tb_combo$Total <- paste0(count$Total, "( ", round(100*(count$Total)/total,2), " %)")
  
  tb_combo$Site <- rownames(count)
  tb_combo[(n+1),c(1:(m+1))] <- as.character(apply(count,2,sum))
  tb_combo$Site[is.na(tb_combo$Site)] <- replace_na("Total")  
  return(tb_combo)
}



tube_clinic <- tube_col %>% filter(d_650516960==664882224)%>% mutate(Site=droplevels(Site),
                                                                     bldcol_max=as.factor(bldcol_max))
tube_clinic$bldcol_tubes <- factor(tube_clinic$bldcol_max,levels=c(1:11))
tube_clinic$bldcol_tubes <- droplevels(tube_clinic$bldcol_tubes)
#clinic.bldcol <-CrossTable(tube_clinic$Site,as.factor(tube_clinic$bldcol_tubes))
bldcol_clinic <- n_pct_table(tube_clinic$Site,as.factor(tube_clinic$bldcol_tubes))
                             
bldcol_clinic$"Less Than 7" <- ifelse(!grepl("Total",bldcol_clinic$Site),"0 ( 0.00%)","0")
bldcol_clinic$`11` <- bldcol_clinic$"Less Than 7"






 


## Table 7

tube_clinic <- tube_col %>% filter(d_650516960==664882224 )%>% mutate(Site=droplevels(Site),
                                                                     bldcol_max=as.factor(bldcol_max)) #& grepl("Kaiser",Site)
tube_clinic$bldcol_tubes <- factor(tube_clinic$bldcol_max,levels=c(0:10))
tube_clinic$bldcol_tubes <- droplevels(tube_clinic$bldcol_tubes)
tube_clinic$Site <-factor(tube_clinic$Site,levels=c("HealthPartners", "Henry Ford Health System",
                                                     "Sanford Health", "University of Chicago Medicine","Kaiser Permanente Colorado",
                                                     "Kaiser Permanente Georgia","Kaiser Permanente Hawaii","Kaiser Permanente Northwest"))
                                                           
tube_completeness <- tube_clinic %>% 
  dplyr::select(bldcol_tubes, Site)  %>% 
  tbl_cross(
    col = bldcol_tubes, 
    row = Site,
    percent = "row",
    label= list(bldcol_tubes ~ ' ', Site~'Site'),  
    missing="ifany",
    missing_text="0",
    digits=c(0,1),
    margin_text="Total") 




tube_completeness_totals <- as.data.frame(tube_completeness)
tube_completeness_totals <- tube_completeness_totals[-1, ]


current_colnames <- colnames(tube_completeness_totals)
current_colnames[length(current_colnames)] <- "Total Clinical Collections"
current_colnames[1] <- "Site"
colnames(tube_completeness_totals) <- current_colnames




```




```{r Table4, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}
# ## New table 4 8/22/23
clin_col <- biospe %>% select(Connect_ID, d_650516960, d_410912345)
bldurcl <- left_join(recrver1, clin_col, by="Connect_ID")

bldurcl <- bldurcl %>% filter(d_650516960==664882224 & d_410912345==353358909) %>%
  mutate(Data_System = case_when((d_173836415_d_266600170_d_534041351==353358909 & is.na(d_173836415_d_266600170_d_693370086)) |
                                   (d_173836415_d_266600170_d_210921343==353358909 & is.na(d_173836415_d_266600170_d_786930107))~ "Biospecimen Dashboard Only",
                                   (is.na(d_173836415_d_266600170_d_534041351) & d_173836415_d_266600170_d_693370086==353358909) |
           (is.na(d_173836415_d_266600170_d_210921343) & d_173836415_d_266600170_d_786930107==353358909)~ "Site Data Only",
           (d_173836415_d_266600170_d_534041351==353358909 & d_173836415_d_266600170_d_693370086==353358909) |
                                     (d_173836415_d_266600170_d_210921343==353358909 & d_173836415_d_266600170_d_786930107==353358909) ~ "Site Data & Biospecimen Dashboard"))

bldurcl <- bldurcl %>%  filter(!is.na(Data_System)) ##Domonique looking into why this is happening

newtable_4 <- bldurcl %>% select(Data_System) %>%  group_by(Data_System) %>%  tally()


site_dash_blood<- sum((bldurcl$d_173836415_d_266600170_d_534041351==353358909 & bldurcl$d_173836415_d_266600170_d_693370086==353358909), na.rm = T)
total_blood <- sum((bldurcl$d_173836415_d_266600170_d_534041351==353358909 | bldurcl$d_173836415_d_266600170_d_693370086==353358909), na.rm = T)
dash_blood <- sum((bldurcl$d_173836415_d_266600170_d_534041351==353358909 & is.na(bldurcl$d_173836415_d_266600170_d_693370086)), na.rm = T)
site_blood <- sum((is.na(bldurcl$d_173836415_d_266600170_d_534041351) & bldurcl$d_173836415_d_266600170_d_693370086==353358909), na.rm = T)

dash_bloodP <- paste0(dash_blood, " (", 100*round(dash_blood/total_blood,digits=2), "%)")
site_dash_bloodP <- paste0(site_dash_blood, " (", 100*round(site_dash_blood/total_blood,digits=2), "%)")
site_bloodP <- paste0(site_blood, " (", 100*round(site_blood/total_blood,digits=2), "%)")
total_bloodP <- paste0(total_blood, " (100%)")


site_dash_urine<- sum((bldurcl$d_173836415_d_266600170_d_210921343==353358909 & bldurcl$d_173836415_d_266600170_d_786930107==353358909), na.rm = T)
total_urine <- sum((bldurcl$d_173836415_d_266600170_d_210921343==353358909 | bldurcl$d_173836415_d_266600170_d_786930107==353358909), na.rm = T)
dash_urine <- sum((bldurcl$d_173836415_d_266600170_d_210921343==353358909 & is.na(bldurcl$d_173836415_d_266600170_d_786930107)), na.rm = T)
site_urine <- sum((is.na(bldurcl$d_173836415_d_266600170_d_210921343) & bldurcl$d_173836415_d_266600170_d_786930107==353358909), na.rm = T)

dash_urineP <- paste0(dash_urine, " (", 100*round(dash_urine/total_urine,digits=2), "%)")
site_dash_urineP <- paste0(site_dash_urine, " (", 100*round(site_dash_urine/total_urine,digits=2), "%)")
site_urineP <- paste0(site_urine, " (", 100*round(site_urine/total_urine,digits=2), "%)")
total_urineP <- paste0(total_urine, " (100%)")

newtable_4[,2] <- c(dash_bloodP, site_dash_bloodP, site_bloodP) #, total_bloodP)
newtable_4[,3] <- c(dash_urineP, site_dash_urineP,  site_urineP)#, total_urineP)

newtable_4[4,] <- list('Total', total_bloodP, total_urineP)
colnames(newtable_4) <- c(md("Data System"), md("Blood Collected"), md("Urine Colected"))


```



```{r Table11, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}


#Participants who checked in for a baseline biospecimen visit but did not give any samples
dd[grepl("BioChk",dd$`Variable Name`),]
recr_bio <- base::merge(recrver1,tube_col,by="Connect_ID")
bio_checkin_resh <- recr_bio  %>% filter(!is.na(d_331584571_d_266600170_d_840048338) & d_650516960==534621077) %>% select(BiospeCollection ) %>% tbl_summary()
table(bio_checkin_resh$BiospeCollection)

tubes <- unique(y[grepl(" Tube ",y$`Secondary.Source`),c("conceptId.1","Secondary.Source")])
tube.ls <- paste0("d_", trimws(paste(tubes$conceptId.1,collapes="")))

biospe$tubedev <-0 #biospecimen deviations
biospe$tubecol <- 0 #tube collections
biospe$tubedid <- 0 #tube discarded
for(i in 1:length(tube.ls)){
  
  tubecol <- ifelse(biospe[,paste(tube.ls[i],"d_593843561",sep="_")] == 104430631 | is.na(biospe[,paste(tube.ls[i],"d_593843561",sep="_")]),0,1)  ##for tube collected
  
  tubedev <- ifelse(biospe[,paste(tube.ls[i],"d_678857215",sep="_")]==104430631 | is.na(biospe[,paste(tube.ls[i],"d_678857215",sep="_")]),0,1) #for tube deviations yes/no
  
  tubedid <- ifelse(biospe[,paste(tube.ls[i],"d_762124027",sep="_")]==104430631 | is.na(biospe[,paste(tube.ls[i],"d_762124027",sep="_")]),0,1)
  
  biospe$tubedev <- biospe$tubedev+tubedev
  biospe$tubecol <- tubecol + biospe$tubecol ###to check collection
  biospe$tubedid <- biospe$tubedid+tubedid  
}
table(biospe$tubecol)
table(biospe$tubedev)
biospe$d_827220437 <- as.numeric(biospe$d_827220437)
biospe <- apply_labels(biospe,d_827220437 = "Site",#RcrtES_Site_v1r0
                       d_827220437 = c("Baylor Scott and White Health"=472940358, "HealthPartners"= 531629870, 
                                       "Henry Ford Health System"=548392715, "Kaiser Permanente Colorado" = 125001209,
                                      "Kaiser Permanente Georgia" = 327912200,"Kaiser Permanente Hawaii" = 300267574,
                                      "Kaiser Permanente Northwest" = 452412599, "Marshfield Clinic Health System" = 303349821,
                                      "Sanford Health" = 657167265, "University of Chicago Medicine" = 809703864,
                                      "National Cancer Institute" = 517700004,"National Cancer Institute" = 13,"Other" = 181769837))

biospe$Site <-factor(biospe$d_827220437,levels=c("Baylor Scott and White Health","HealthPartners", "Henry Ford Health System",
                                                     "Marshfield Clinic Health System",
                                                     "Sanford Health", "University of Chicago Medicine","Kaiser Permanente Colorado",
                                                     "Kaiser Permanente Georgia","Kaiser Permanente Hawaii","Kaiser Permanente Northwest",
                                                     "National Cancer Institute","Other"))
biospe$tube_nodev <- biospe$tubecol-biospe$tubedev
total1 <- sum(biospe$tubedev) 
total2 <- sum(biospe$tube_nodev) 
tube_dev <- as.data.frame(aggregate( biospe$tubedev,                # Specify data column[,c("tubedev","tube_nodev")]
                                     by = list(biospe$Site),              # Specify group indicator
                                     FUN = sum))
tube_nodev <- as.data.frame(aggregate( biospe$tube_nodev,                # Specify data column[,c("tubedev","tube_nodev")]
                                     by = list(biospe$Site),              # Specify group indicator
                                     FUN = sum))

  #changed Table17 to Deviation_Freq to match report

Deviation_Freq <- base::merge(tube_dev,tube_nodev,by="row.names")

Deviation_Freq <- Deviation_Freq[,c(2,3,5)]
Deviation_Freq$Total <- Deviation_Freq[,2]+Deviation_Freq[,3]
Deviation_Freq$dev_n_pct <- ifelse(Deviation_Freq[,2] >0, paste0(format(Deviation_Freq[,2],big.mark=",")," (", round(100*Deviation_Freq[,2]/Deviation_Freq$Total, 1)," %)"), "0 (0 %)")
Deviation_Freq$nodev_n_pct <- ifelse(Deviation_Freq[,3] >0, paste0(format(Deviation_Freq[,3],big.mark=",")," (",  round(100*Deviation_Freq[,3]/Deviation_Freq$Total,1), " %)"), "0 (0 %)")

Deviation_Freq[10,c(1:6)] <- c("Total",total1, total2,format(sum(biospe$tubecol),big.mark=","),
                        paste0(format(total1,big.mark=",")," (", round(100*sum(as.numeric(Deviation_Freq[1:9,2]))/sum(as.numeric(Deviation_Freq$Total), na.rm=T), 1)," %)"),  
                        paste0(format(total2,big.mark=",")," (", round(100*sum(as.numeric(Deviation_Freq[1:9,3]))/sum(as.numeric(Deviation_Freq$Total), na.rm=T),1)," %)"))     
Deviation_Freq <- Deviation_Freq %>% mutate(Site = ifelse(is.na(Group.1.x), "Total",  as.character(Group.1.x))) ###to replace NA in the factor variable

```

```{r Deviations, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}
#Table 14. Number of deviations by biospecimen type and by tube type 
#keep this table for CCC version but remove from version that we are sharing with the sites
dev_tube <- NULL
for (i in 1:length(tube.ls)){
  
  id <- paste(tube.ls[i],"d_825582494",sep="_")
  tube <- paste(tube.ls[i],"d_678857215",sep="_")
  #note <- paste(tube.ls[i],"d_536710547",sep="_")
  tube_dev <- paste(tube.ls[i],"d_248868659", sep="_")
  deviation <- grep(tube_dev,colnames(biospe),value=TRUE)
  tmp <- as.data.frame(biospe[,which(colnames(biospe) %in% c(id,tube,deviation))] )
  tmp <- tmp[which(!is.na(tmp[,(colnames(tmp) == id)])),]
  
    dev_long <- data.table::melt(tmp,
                   id.vars=c(id,tube), 
                   measure.vars=deviation,
                   variable.name="dev_type",
                   value.name="deviation")
    
    
  colnames(dev_long)[grep("d_678857215",names(dev_long))] <- "d_678857215"
  colnames(dev_long)[grep("d_825582494",names(dev_long))] <- "TubeID"
  
  dev_long <- dev_long[complete.cases(dev_long[,c("TubeID","d_678857215","dev_type","deviation")]),]

  dev_tube <- dplyr::bind_rows(dev_tube,dev_long)

}  

   dev_tube1   <- dev_tube %>% filter(d_678857215 ==353358909 & deviation == 353358909)  %>%  
     mutate(biospecimen=ifelse(grepl("d_973670172",dev_type), "urine",
                                  ifelse(grepl("d_143615646",dev_type),"Mouthwash","blood")),
            tube_type = case_when(grepl("d_973670172",dev_type) ~ "Urine Tube1",
                                  grepl("d_143615646",dev_type) ~ "MW Tube1",
                                  grepl("d_299553921",dev_type) ~ "SS Tube1",
                                  grepl("d_703954371",dev_type) ~ "SS Tube2",
                                  grepl("d_454453939",dev_type) ~ "EDTA Tube1",
                                  grepl("d_838567176",dev_type) ~ "Heparin Tube1",
                                  grepl("d_652357376",dev_type) ~ "ACD Tube1",
                                  grepl("d_677469051",dev_type) ~ "EDTA Tube2",
                                  grepl("d_683613884",dev_type) ~ "EDTA Tube3",
                                  grepl("d_376960806",dev_type) ~ "SS Tube3",
                                  grepl("d_232343615",dev_type) ~ "SS Tube4",
                                  grepl("d_589588440",dev_type) ~ "SS Tube5",
                                  grepl("d_958646668",dev_type) ~ "Heparin Tube2",
                                  grepl("d_505347689",dev_type) ~ "STRECK Tube1"), #make sure this doesn't break the code
            
              deviationnotes =case_when(sapply(strsplit(as.character(dev_type),"d_"),tail,1) =="102695484" ~ "Deviation Clot < 30min",
                  sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="242307474" ~ "Hemolyzed", 
                  sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="283900611" ~ "Mislabel Resolved",
                  sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="313097539" ~ "Outside Contamated",
                  sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="453343022" ~ "Other",
                  sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="472864016" ~ "Broken", 
                  sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="550088682" ~ "Temparture Too Low",
                  sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="561005927" ~ "Cent Low",
                  sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="635875253" ~ "Broken Gel",
                  sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="654002184" ~ "Centrifuge Too Long",
                  sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="684617815" ~ "MisLabled Discard",
                  sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="690540566" ~"Tempature Too High",
              sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="728366619" ~"Low Volume-(tube/container partially filled but still usable)",
              sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="742806035" ~"MW < 30s",
              sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="757246707" ~"Leak/Spilled",
              sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="777486216" ~"Tube Size",
              sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="810960823" ~"Discard",
              sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="861162895" ~"Cent High",
              sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="912088602" ~"Clot > 2h",
              sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="937362785" ~"Centrifuge Too Short",
              sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="956345366" ~"Insufficient Volume",
              sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="982885431" ~ "Not Found"))
notcol_tubes <- colnames(biospe)[grepl("883732523",colnames(biospe))] #7
col_tubes <- colnames(biospe)[grepl("d_593843561",colnames(biospe))] #13
dev_tubes <- colnames(biospe)[grepl("d_678857215",colnames(biospe))] #13
notcol.ls <- sapply(strsplit(notcol_tubes, "_d"),"[[",1)
   notcol_tube <- NULL
   tubenotcol.ls <-list()
 
   for (i in 1:length(notcol.ls)){
     
     tubecol <- paste(notcol.ls[i],"d_593843561",sep="_")
     tube_notcol <- paste(notcol.ls[i],"d_883732523", sep="_") #notcolnotes
     TubeID <- paste(tube.ls[i],"d_825582494",sep="_")

     tube_deviation <- paste(notcol.ls[i], "d_678857215",sep="_")

     select <- c(TubeID,tubecol,tube_notcol,tube_deviation)
     tmp <- biospe[,(colnames(biospe)%in% c(select,"d_820476880","Site","biocol_Setting"))] 
     notcol <- tmp 
     colnames(notcol)[colnames(notcol)==TubeID] <- "TubeID"
     colnames(notcol)[colnames(notcol)==tubecol] <- "tubecol"
     colnames(notcol)[colnames(notcol)==tube_notcol] <- "tube_notcol"

     colnames(notcol)[colnames(notcol)==tube_deviation] <- "tube_deviation"

     
     notcol$tubeID <- notcol.ls[i]

     notcol_tube <- dplyr::bind_rows(notcol_tube,notcol)

   } 
   

      collection_long <- NULL
   for (i in 1:length(tube.ls)){
     
     tubeid <- paste(tube.ls[i],"d_825582494",sep="_")
     tubecol <- paste(tube.ls[i],"d_593843561",sep="_")
     tube_deviation <- paste(tube.ls[i], "d_678857215",sep="_")
     tube_discard <- paste(tube.ls[i], "d_762124027",sep="_")
     select <- c(tubeid,tubecol,tube_deviation,tube_discard)
     tmp <- biospe[,(colnames(biospe)%in% c(select,"d_820476880","Site","biocol_Setting"))] 
     col <- tmp 
     colnames(col)[colnames(col)==tubeid] <- "TubeID"
     colnames(col)[colnames(col)==tubecol] <- "tubecol"
     colnames(col)[colnames(col)==tube_deviation] <- "tube_deviation"
     colnames(col)[colnames(col)==tube_discard] <- "tube_discard"
     
     col$tubeID <- tube.ls[i]
     collection_long <- dplyr::bind_rows(collection_long,col)
   } 
   
   collection_long <- collection_long  %>% 
     dplyr:: mutate(deviation = case_when(tube_deviation == 353358909 ~ "Any Deviation",
                                          tube_deviation == 104430631 ~ "No Deviation"),
                    Collected = case_when(tubecol ==353358909 ~ "Collected",
                                          tubecol == 104430631 ~ "Not  Collected"),
                    Discarded = case_when(tube_discard == 353358909 ~ "Any Discard",
                                          tube_discard == 104430631 ~ "No Discard"),
                    biospecimen=ifelse(tubeID=="d_973670172", "urine",
                                  ifelse(tubeID=="d_143615646","Mouthwash","blood")),
                    tube_type = case_when(tubeID == "d_973670172"  ~ "Urine Tube1",
                                          tubeID == "d_143615646"  ~ "MW Tube1",
                                          tubeID == "d_299553921"  ~ "SS Tube1",
                                          tubeID == "d_703954371"  ~ "SS Tube2",
                                          tubeID == "d_454453939"  ~ "EDTA Tube1",
                                          tubeID == "d_838567176"  ~ "Heparin Tube1",
                                          tubeID == "d_652357376"  ~ "ACD Tube1",
                                          tubeID == "d_677469051"  ~ "EDTA Tube2",
                                          tubeID == "d_683613884"  ~ "EDTA Tube3",
                                          tubeID == "d_376960806"  ~ "SS Tube3",
                                          tubeID == "d_232343615"  ~ "SS Tube4",
                                          tubeID == "d_589588440"  ~ "SS Tube5",
                                          tubeID == "d_505347689"  ~ "STRECK Tube1", 
                                          tubeID == "d_958646668"  ~ "Heparin Tube2"))
  collection_long$tube_type <- factor(collection_long$tube_type, levels=c("SS Tube1", "SS Tube2","SS Tube3", "SS Tube4", "SS Tube5","Heparin Tube1","Heparin Tube2","EDTA Tube1", "EDTA Tube2","EDTA Tube3","ACD Tube1", "STRECK Tube1", "Urine Tube1","MW Tube1" ) )   

   
   
   dev_tube1$tube_dev <- paste(dev_tube1$tube_type,"Deviation", dev_tube1$deviationnotes,sep=" ")
   dev_tube1$tubeID <- substr(dev_tube1$dev_type,1,11)
  dev <- collection_long %>% filter(tube_deviation==353358909) 
  dev_tube2 <- base::merge(dev,dev_tube1[,c("dev_type","TubeID","tubeID","deviationnotes","tube_dev")],by.x=c("TubeID","tubeID"), by.y=c("TubeID","tubeID")) ##to get the deviation notes


#This is referencred directly in table 12  
  dev_count <- dev_tube2 %>% group_by(biocol_Setting,biospecimen,tube_dev) %>%   dplyr::summarize(count=n()) 

  colnames(dev_count) <- c("Deviation","Number")
  

  
   dev_count.site <- list() 
dev_tube2$Site <- droplevels(dev_tube2$Site)
for(site in unique(dev_tube2$Site)){
  
  site.sub <- dev_tube2 %>% filter(Site==site) %>% 
    group_by(tube_dev) %>% dplyr::tally() 
  total <- as.numeric(nrow(dev_tube2[which(dev_tube2$Site==site),]))
  dev_count.site[[site]] <- site.sub
}


```
  
  
  
  
```{r Table8, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}
  
  research.coltube<- collection_long %>% filter(biocol_Setting == "Research" & tubecol == 104430631) %>%     
    mutate(Site=droplevels(Site),
           tube_type = factor(tube_type,levels=c("SS Tube1", "SS Tube2","Heparin Tube1","EDTA Tube1","ACD Tube1","STRECK Tube1", "Urine Tube1","MW Tube1" )))
  
  
    research.coltube.bld.only<- collection_long %>% filter(biocol_Setting == "Research" & tubecol == 104430631) %>% 
    mutate(Site=droplevels(Site),
           tube_type = factor(tube_type,levels=c("SS Tube1", "SS Tube2","Heparin Tube1","EDTA Tube1","ACD Tube1", "STRECK Tube1")))  #make sure this doesn't break the code
    research.coltube.bld.only<- research.coltube.bld.only %>%  mutate(tube_type=droplevels(tube_type))

 
  
ctable <-  CrossTable(research.coltube.bld.only$Site, research.coltube.bld.only$tube_type)


nocol.type <- as.data.frame(cbind(ctable$t,ctable$prop.col))

  pct_n <- function(x,y){ paste0(x,"( ", round(100*y,1), " %)")}
      count <- as.data.frame.matrix(ctable$t) # to convert the S3 table into the same dimention table via as.data.frame.matrix
      perc <- as.data.frame.matrix(ctable$prop.col)
      
      
   pct_n2 <- function(x,y){ paste0(x,"( ", round(100*y,1), " %)")}
      count2 <- as.data.frame.matrix(ctable$t) # to convert the S3 table into the same dimention table via as.data.frame.matrix
      perc2 <- as.data.frame.matrix(ctable$prop.col)     


#   #notcol_combo = array(pct_n(ctable$t,ctable$prop.col),dim=c(5,7))
#   notcol_combo = array(pct_n(ctable$t,ctable$prop.col),dim=c(5,6))
# 
#   notcol_combo <- as.data.frame(notcol_combo)
#   colnames(notcol_combo) <- colnames(count2)
#   #notcol_combo <- notcol_combo[, c(1:5)] # I added to get rid of MW and Urine, to fix total column
#   
#   count2$Total.NotCol <- apply(count2,1,sum)
#   total <- sum(count2)
#   #notcol_combo$Total.Notcol <- paste0(apply(count[c(1:5),c(1:7)],1,sum), "( ", round(100*apply(count2[c(1:5),c(1:7)],1,sum)/total,2), " %)")
#   notcol_combo$Total.Notcol <- paste0(count2$Total.NotCol, "( ", round(100*count2$Total.NotCol/sum(count2$Total.NotCol),1), " %)")
#   
#   notcol_combo$Site <- rownames(count2)
# 
#   #notcol_combo[6,c(1:8)] <- as.character(apply(count,2,sum))
# notcol_combo[6,c(1:7)] <- as.character(apply(count2,2,sum))
#   notcol_combo$Site[is.na(notcol_combo$Site)] <- replace_na("Total") 
#   
#   
# notcol_combo
    
    
    
    
```




```{r Table2.7_2.8, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}
    
Tb.research.coltube <- tube_col %>% filter(d_650516960==534621077) %>%  mutate(Site=droplevels(Site),
                                                                               bldcol_max=as.factor(bldcol_max)) #& grepl("Kaiser",Site)
Tb.research.coltube$bldcol_tubes <- factor(Tb.research.coltube$bldcol_max,levels=c(0:5))
Tb.research.coltube$bldcol_tubes <- droplevels(Tb.research.coltube$bldcol_tubes)

Tb.research.coltube$Site <-factor(Tb.research.coltube$Site,levels=c("Baylor Scott and White Health","HealthPartners", "Henry Ford Health System",
                                                     "Marshfield Clinic Health System",
                                                     "Sanford Health", "University of Chicago Medicine"))

Total.research.coltube <- Tb.research.coltube %>% 
  dplyr::select(bldcol_tubes, Site)  %>% 
  tbl_cross(
    col = bldcol_tubes, 
    row = Site,
    percent = "row",
    label= list(bldcol_tubes ~ ' ', Site~'Site'),         #list(Site~"Site", bldcol_tubes ~ 'Number of Tubes'),
    missing="ifany",
    missing_text="0",
    digits=c(0,1),
    margin_text="Total") 



research.coltube_totals <- as.data.frame(Total.research.coltube)
research.coltube_totals <- research.coltube_totals[-1, ]


current_colnames <- colnames(research.coltube_totals)
current_colnames[length(current_colnames)] <- "Total Research Collections"
current_colnames[1] <- "Site"
colnames(research.coltube_totals) <- current_colnames

research.coltube_totals








research__blood <- collection_long %>% filter(biocol_Setting == "Research" & tubecol == 353358909) %>% 
    mutate(Site=droplevels(Site),
           tube_type = factor(tube_type,levels=c("SS Tube1", "SS Tube2","Heparin Tube1","EDTA Tube1","ACD Tube1", "STRECK Tube1")))  
    research.coltube.bld.only<- research.coltube.bld.only %>%  mutate(tube_type=droplevels(tube_type))
    
research__blood <- research__blood %>% filter(!is.na(tube_type))

research__blood$Site <-factor(research__blood$Site,levels=c("Baylor Scott and White Health","HealthPartners", "Henry Ford Health System",
                                                     "Marshfield Clinic Health System",
                                                     "Sanford Health", "University of Chicago Medicine"))
        
Total_research_blood <- research__blood %>% 
  dplyr::select(tube_type, Site)  %>% 
  tbl_cross(
    col = tube_type, 
    row = Site,
    percent = "col",
    label= list(tube_type ~ ' ', Site~'Site'), 
    missing="ifany",
    missing_text="0",
    digits=c(0,1),
    margin_text="Total") 



Research_blood_totals <- as.data.frame(Total_research_blood)
Research_blood_totals <- Research_blood_totals[-1, ]


current_colnames <- colnames(Research_blood_totals)
current_colnames[length(current_colnames)] <- "Total Blood Tubes Collections"
current_colnames[1] <- "Site"
colnames(Research_blood_totals) <- current_colnames

Research_blood_totals

```


```{r Table10, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

## Number of tube tubes not collected at clinical collections

clinic.coltube <- collection_long %>%  mutate(tube_types= case_when(tube_type=="SS Tube1" ~ "SS T1",
                                                                    tube_type=="SS Tube2" ~ "SS T2",
                                                                    tube_type=="SS Tube3" ~ "SS T3",
                                                                    tube_type=="SS Tube4" ~ "SS T4",
                                                                    tube_type=="SS Tube5" ~ "SS T5",
                                                                    tube_type=="Heparin Tube1" ~ "Heparin 1",
                                                                    tube_type=="Heparin Tube2" ~ "Heparin 2",
                                                                    tube_type=="EDTA Tube1" ~ "EDTA 1",
                                                                    tube_type=="EDTA Tube2" ~ "EDTA 2",
                                                                    tube_type=="EDTA Tube3" ~ "EDTA 3",
                                                                    tube_type=="ACD Tube1" ~ "ACD 1",
                                                                    tube_type=="STRECK Tube1" ~ "STRECK 1",
                                                                    tube_type=="Urine Tube1" ~ "Urine 1",
                                                                    tube_type=="MW Tube1" ~ "Mouthwash"))

  clinic.coltube<- clinic.coltube %>% filter(biocol_Setting == "Clinical" & tubecol == 353358909 & tube_types!="Urine 1") %>% # & tube_type!="MW Tube1") %>% #added, need to test 
    mutate(Site=droplevels(Site),
           tube_type = factor(tube_types,levels=c("SS T1", "SS T2","SS T3", "SS T4", "SS T5", "Heparin 1","Heparin 2","EDTA 1","EDTA 2","EDTA 3","ACD 1","STRECK 1")))
  
   
 notcol_combo2 <- clinic.coltube %>% 
    dplyr::select(tube_types, Site)  %>% 
    tbl_cross(
        col = tube_types, 
        row = Site,
        percent = "col",
        label= list(tube_types ~ ' ', Site~'Site'),     
        missing="ifany",
        missing_text="0",
        digits=c(0,1),
        margin_text="Total") 

notcol_combo2_totals <- as.data.frame(notcol_combo2)
notcol_combo2_totals <- notcol_combo2_totals[-1, ]


current_colnames <- colnames(notcol_combo2_totals)
current_colnames[length(current_colnames)] <- "Total Blood Tubes Collected"
current_colnames[1] <- "Site"
colnames(notcol_combo2_totals) <- current_colnames
notcol_combo2_totals[, c("Site", "SS T1", "SS T2","SS T3", "SS T4", "SS T5", "Heparin 1","Heparin 2","EDTA 1","EDTA 2","EDTA 3","ACD 1","STRECK 1", "Total Blood Tubes Collected")]

  
  
```



```{r Table12a12b, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}
  
## Table 15  
##Table X: Reason not collected by tube type and by site for research collections only
  a<- collection_long[which(collection_long$tubecol==104430631),]
  b <- notcol_tube[which(notcol_tube$tubecol == 104430631),]
  notcol_notes <- base::merge(a, b[,c("tubeID","d_820476880","tube_notcol")], by=c("tubeID","d_820476880"),all.x=TRUE)
notcol_notes <- notcol_notes %>% 
  mutate(notcol.notes = case_when(tubecol == 104430631 & tube_notcol==181769837 ~ "Other",
                                  tubecol == 104430631 & tube_notcol==234139565 ~ "Short Draw",
                                  tubecol == 104430631 & tube_notcol==681745422 ~ "Participant Refusal",
                                  tubecol == 104430631 & tube_notcol==745205161 ~ "Participant Attempted",
                                  tubecol == 104430631 & tube_notcol==889386523 ~ "Supply Unavailable",
                                  tubecol == 104430631 & is.na(tube_notcol) ~ "Missing Reasons"),
         Collected = case_when(tubecol ==353358909 ~ "Collected",
                               tubecol == 104430631 ~ "Not  Collected"),
                    biospecimen=ifelse(tubeID=="d_973670172", "urine",
                                  ifelse(tubeID=="d_143615646","Mouthwash","blood")),
                    tube_type = case_when(tubeID == "d_973670172"  ~ "Urine Tube1",
                                          tubeID == "d_143615646"  ~ "MW Tube1",
                                          tubeID == "d_299553921"  ~ "SS Tube1",
                                          tubeID == "d_703954371"  ~ "SS Tube2",
                                          tubeID == "d_454453939"  ~ "EDTA Tube1",
                                          tubeID == "d_838567176"  ~ "Heparin Tube1",
                                          tubeID == "d_652357376"  ~ "ACD Tube1",
                                          tubeID == "d_677469051"  ~ "EDTA Tube2",
                                          tubeID == "d_683613884"  ~ "EDTA Tube3",
                                          tubeID == "d_376960806"  ~ "SS Tube3",
                                          tubeID == "d_232343615"  ~ "SS Tube4",
                                          tubeID == "d_589588440"  ~ "SS Tube5",
                                          tubeID == "d_505347689"  ~ "STRECK Tube1",
                                          tubeID == "d_958646668"  ~ "Heparin Tube2"))
notcol_notes$tube_type <- factor(notcol_notes$tube_type, levels=c("SS Tube1", "SS Tube2","SS Tube3", "SS Tube4", "SS Tube5","Heparin Tube1","Heparin Tube2","EDTA Tube1", "EDTA Tube2","EDTA Tube3","ACD Tube1","Urine Tube1","STRECK Tube1","MW Tube1" ) ) 
notcol_notes$notcol.notes <- factor(notcol_notes$notcol.notes, levels=c("Short Draw","Participant Attempted", "Other", "Participant Refusal", "Supply Unavailable", "Missing Reasons"))




n_pct_table <- function(x,y){
  #x<-clinicnotes.notcol$Site
  #y<-clinicnotes.notcol$notcol.notes
  ctable<- CrossTable(x,y)
count <- as.data.frame.matrix(ctable$t)
perc <- as.data.frame.matrix(ctable$prop.col)
n<- as.numeric(length(levels(x)))
m <- as.numeric(length(levels(y)))
tb_combo <- array(pct_n(ctable$t,ctable$prop.col),dim=c(n,m)) 
  tb_combo <- as.data.frame(tb_combo)
  colnames(tb_combo) <- colnames(count)
  
  total <- sum(count)
  count$Total <- apply(count,1,sum)
  tb_combo$Total <- paste0(count$Total, "( ", round(100*(count$Total)/total,1), " %)")
  
  tb_combo$Site <- rownames(count)
  tb_combo[(n+1),c(1:(m+1))] <- as.character(apply(count,2,sum))
  tb_combo$Site[is.na(tb_combo$Site)] <- replace_na("Total")  
  return(tb_combo)
}
research.notcol <- notcol_notes %>% filter(biocol_Setting=="Research" & tubecol==104430631) %>%
   mutate(Site=droplevels(Site),
           tube_type = factor(tube_type,levels=c("SS Tube1", "SS Tube2","Heparin Tube1","EDTA Tube1","ACD Tube1","STRECK Tube1","Urine Tube1","MW Tube1" )))
research.notcol$notcol.notes <- factor(research.notcol$notcol.notes, levels=c("Short Draw","Participant Attempted", "Other", "Participant Refusal", "Supply Unavailable", "Missing Reasons"))

reseachnotes.notcol <- n_pct_table(research.notcol$Site,research.notcol$notcol.notes)
reseachnotes.coltype <- n_pct_table(research.notcol$tube_type,research.notcol$notcol.notes)
notcol.reasons.research <- rbind(reseachnotes.notcol,reseachnotes.coltype)


research.notcolnotes_site <- research.notcol %>% select(notcol.notes,Site) %>% 
  tbl_cross(  col = notcol.notes,
                  row = Site,
                   percent = "row",
                   digits= c(0,1),
                   label= c(notcol.notes~ " ", Site ~ "Site"),
                   missing="ifany",
                   missing_text="0 ( 0 %)")


research.notcolnotes_site_totals <- as.data.frame(research.notcolnotes_site)
research.notcolnotes_site_totals <- research.notcolnotes_site_totals[-1, ]

current_colnames <- colnames(research.notcolnotes_site_totals)
current_colnames[length(current_colnames)] <- "Total Tubes Not Collected"
current_colnames[1] <- "Site "
colnames(research.notcolnotes_site_totals) <- current_colnames







research.notcolnotes_tube <- research.notcol %>% select(notcol.notes, tube_type) %>%
  tbl_cross(  col = notcol.notes,
                  row = tube_type,
                   percent = "row",
                   digits= c(0,1),
                   label= c(notcol.notes~ " ", tube_type~"Tube Type"),
                   missing="ifany",
                   missing_text="0 ( 0 %)")



research.notcolnotes_tube_totals <- as.data.frame(research.notcolnotes_tube)
research.notcolnotes_tube_totals <- research.notcolnotes_tube_totals[-1, ]

current_colnames <- colnames(research.notcolnotes_tube_totals)
current_colnames[length(current_colnames)] <- "Total Tubes Not Collected"
current_colnames[1] <- "Tube Type"
colnames(research.notcolnotes_tube_totals) <- current_colnames





```


```{r Table13, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}


research.notcolnotes <- research.notcol %>% select(notcol.notes,Site, tube_type) %>% crosstable(c(Site, tube_type),by=notcol.notes,showNA="ifany", total="row",margin=c("row", "col"),
           percent_digits=1, percent_pattern="{n} ({p_col})") %>% as_flextable() #%>% as_flex_table()  
clinicnotes.notcol <- notcol_notes %>% filter(biocol_Setting=="Clinical" & tubecol==104430631 & notcol_notes$biospecimen!="Mouthwash"  )%>%    mutate(Site=droplevels(Site),
           tube_type = factor(tube_type,levels=c("SS Tube1", "SS Tube2","SS Tube3", "SS Tube4", "SS Tube5","Heparin Tube1","Heparin Tube2","EDTA Tube1", "EDTA Tube2","EDTA Tube3","ACD Tube1","STRECK Tube1","Urine Tube1" )))
          
clinicnotes.notcol$notcol.notes <- factor(clinicnotes.notcol$notcol.notes, levels=c("Short Draw","Participant Attempted", "Other", "Participant Refusal", "Supply Unavailable", "Missing Reasons"))
clinicnotes.notcol$notcol.notes <- droplevels(clinicnotes.notcol$notcol.notes)
clinicnotes.notcol$tube_type = droplevels(clinicnotes.notcol$tube_type)
clinic.notcolsite <- n_pct_table(clinicnotes.notcol$Site,clinicnotes.notcol$notcol.notes)
clinicnotes.coltype <- n_pct_table(clinicnotes.notcol$tube_type,clinicnotes.notcol$notcol.notes)
notcol.reasons.clinic <- rbind(clinicnotes.coltype,clinic.notcolsite)
reasons <- c("Short Draw","Participant Attempted", "Other", "Participant Refusal", "Supply Unavailable", "Missing Reasons")
missing <- reasons[which(c(reasons,"Site","Total") %nin% colnames(notcol.reasons.clinic))]
n.col <- as.numeric(ncol(notcol.reasons.clinic))
for (i in 1:length(missing)){
notcol.reasons.clinic[,(n.col+i)] <- "0 (0 %)"
  colnames(notcol.reasons.clinic)[n.col+i] <- missing[i]
}

notcol.reasons.clinic[c(14,21),c((n.col+1):8)] <- "0"






## Table 16 
#Table Number of tube tubes Discarded by tube type and site
discard.tb <- collection_long  %>% filter(tube_discard == 353358909) %>% 
  mutate(Site=droplevels(Site),
           tube_type = droplevels(tube_type))
discard.site <- n_pct_table(discard.tb$Site,discard.tb$tube_type)
discard.site <- (discard.site[, c(10, 1:9)]) #Will need to update dimensions when STRECK Tube 1 listed 

discard.site[6,c(2:10)] <- paste(discard.site[6,c(2:10)], "(100%)")

```


```{r Table14, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

###back to the recruitment table
biospe.tm <- recrvar.bio$column_name[which(grepl("Date|time|Time", recrvar.bio$Variable.Label))]
recrvar.bio[which(grepl("Date|time|Time", recrvar.bio$Variable.Label)),c("field_path","Variable.Label")]

recrvar.bio[which(grepl("Survey", recrvar.bio$Primary.Source)),c("field_path","Primary.Source","Variable.Label")]


Test_res_plots <- recr.bio %>%  select(Connect_ID, d_173836415_d_266600170_d_561681068, d_173836415_d_266600170_d_847159717, d_173836415_d_266600170_d_448660695)
Test_res_plots$Connect_ID <- as.numeric(Test_res_plots$Connect_ID)
tube_col$Connect_ID <- as.numeric(tube_col$Connect_ID)
tube_col_plots <- left_join(tube_col, Test_res_plots, by="Connect_ID")
#head(tube_col_plots)


tube_col_plots$BUM.time <- tube_col$collection.tm

tube_col_plots$col.Sunday.week <- ceiling(as.numeric(difftime(tube_col_plots$BUM.time,as.Date(veristart.date-days(2)),units="days"))/7)

tube_col_plots$col.Sunday.date <- veristart.date + days(5) + dweeks(tube_col_plots$col.Sunday.week-1) 
tube_col_plots$col.Monday.date <- tube_col_plots$col.Sunday.date-days(6)
 

recr.biospe <- base::merge(recr.bio,tube_col_plots,by="Connect_ID")
recr.biospe <- recr.biospe %>%
  mutate(research.sv = case_when(d_265193023 == 231311385 ~ "Submitted",
                                 d_265193023 == 615768760 ~ "Started",
                                 d_265193023 == 972455046 ~ "Not Started"),
          clinic.sv = case_when(d_253883960 == 231311385 ~ "Submitted",
                               d_253883960 == 615768760 ~ "Started",
                               d_253883960 == 972455046 ~ "Not Started"))

research.survey <- recr.biospe %>% filter(d_650516960 == 534621077)
 research.survey <- research.survey %>% 
   mutate(research.svtime =  difftime(as.POSIXct(ymd_hms(d_222161762)),as.POSIXct(ymd_hms(d_822499427)),units="hours"),##survey time from start to complete
         tm_biocolsuv = difftime(as.POSIXct(ymd_hms(d_222161762)),as.POSIXct(ymd_hms(d_331584571_d_266600170_d_840048338)),units="hours")) #time between survey completion to biospecimen collection visit check in
research.survey <-research.survey %>%
           mutate(checktmvisit = case_when( as.numeric(tm_biocolsuv) >72 ~"> 72hrs",
                                            72 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 48 ~ "> 48 hrs to 72 hrs",
                                            48 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 24 ~ "> 24 hrs to 48 hrs",   
                                            24 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 12 ~ "> 12 hrs to 24 hrs",
                                            12 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 3 ~ "> 3 hrs to 12 hrs",  
                                            3 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) >= 0 ~ "0 hrs to 3 hrs",
                                            d_265193023 != 231311385 ~ "Not Submitted", 
                                            TRUE ~ "Missing Time"), #changed from NA to "Missing"
         time_biochk = difftime(as.POSIXct(ymd_hms(d_331584571_d_266600170_d_343048998)),as.POSIXct(ymd_hms(d_331584571_d_266600170_d_840048338)),units="mins"))
research.survey$biochk_outlier <- ifelse(is.na(research.survey$time_biochk), "Missing (not checked out)", ifelse( 0<= as.numeric(research.survey$time_biochk)/60 & as.numeric(research.survey$time_biochk)/60 <= 24, "No Outlier", ifelse(as.numeric(research.survey$time_biochk)/60 > 24, "Outlier",  "Undefined")) )   
research.survey$biochk_outlier <- factor(research.survey$biochk_outlier,levels=c("No Outlier","Outlier","Missing (not checked out)"))
research.survey$checktmvisit <- factor(research.survey$checktmvisit, levels=c( "Not Submitted", "Missing Time", "0 hrs to 3 hrs","> 3 hrs to 12 hrs","> 12 hrs to 24 hrs","> 24 hrs to 48 hrs","> 48 hrs to 72 hrs","> 72hrs")) 
research.survey[which(research.survey$research.svtime <0),c("Connect_ID","d_650516960","Site","d_265193023","d_222161762","d_822499427")]


research.survey[which(as.numeric(research.survey$tm_biocolsuv)<0),c("Connect_ID","d_650516960","Site","d_265193023","d_222161762","d_822499427","d_331584571_d_266600170_d_840048338")]

sv.complete <- as.data.frame(tab1(research.survey$research.sv))
sv.complete <- sv.complete %>% mutate(cumulative.Freq = ifelse(output.table.Percent<100.0, cumsum(output.table.Frequency),output.table.Frequency)) 



#17b. Grouped by site--Research
research.surveyHP <- research.survey %>%  filter(Site=="HealthPartners")
research.surveyHF <- research.survey %>%  filter(Site=="Henry Ford Health System")
research.surveyMF <- research.survey %>%  filter(Site=="Marshfield Clinic Health System")
research.surveySH <- research.survey %>%  filter(Site=="Sanford Health")
research.surveyUC <- research.survey %>%  filter(Site=="University of Chicago Medicine")



#17- by site
test17 <- research.survey %>%  filter(Site=="HealthPartners" |  Site=="Henry Ford Health System" | Site=="Marshfield Clinic Health System" | Site=="Sanford Health" | Site=="University of Chicago Medicine" | Site=="Baylor Scott and White Health")
test17$Site<- droplevels(test17$Site)
Table15_combined <- test17 %>% dplyr::select(Site, research.sv )  %>% tbl_cross(
  row = research.sv,
  col = Site,
  digits=c(0,1),
  percent = "column",
  label=list(Site ~ " ", research.sv ~ " "),
  missing="ifany")



Table15_combined_totals <- as.data.frame(Table15_combined)
Table15_combined_totals <- Table15_combined_totals[-1, ]

current_colnames <- colnames(Table15_combined_totals)
current_colnames[length(current_colnames)] <- "Total Research Surveys"
colnames(Table15_combined_totals) <- current_colnames




```



```{r Table15, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

#Table 18                        
#Total number and percent of clinical biospecimen survey status
clinic.survey <- recr.biospe %>% filter(d_650516960 == 664882224)
 clinic.survey <- clinic.survey %>% 
   mutate(d_173836415_d_266600170_d_139245758_clc = as.POSIXct(ymd_hms(d_173836415_d_266600170_d_139245758)), ##urine
          d_173836415_d_266600170_d_982213346_clc = as.POSIXct(ymd_hms(d_173836415_d_266600170_d_982213346)), ##blood collected
          d_173836415_d_266600170_d_740582332_clc = as.POSIXct(ymd_hms(d_173836415_d_266600170_d_740582332)), ##Autogenerated date/time stamp for Any specimen collected at RRL
          d_173836415_d_266600170_d_139245758_urine =as.POSIXct(ymd_hms(d_173836415_d_266600170_d_139245758)), # Urine collected
          d_173836415_d_266600170_d_541311218_urine = as.POSIXct(ymd_hms(d_173836415_d_266600170_d_541311218)),##Clinical DB urine RRL Date/Time received
          d_173836415_d_266600170_d_224596428_urine = as.POSIXct(ymd_hms(d_173836415_d_266600170_d_224596428)), #Clinical Site Urine RRL Date / Time Received
     clinic.svtime =  difftime(as.POSIXct(ymd_hms(d_764863765)),as.POSIXct(ymd_hms(d_534669573)),units="hours")) ##survey time from start to complete
 clinic.survey <- clinic.survey %>% mutate(clc.coltm  = do.call(pmin, c(select(.,ends_with('clc')),na.rm=TRUE))) ###any biospecimen collected time
  clinic.survey$tm_biocolsuv <-  difftime(as.POSIXct(ymd_hms(clinic.survey$d_764863765)),clinic.survey$clc.coltm,units="hours") 
  #time between survey completion to biospecimen collection visit check in
clinicsv.complete <- as.data.frame(tab1(clinic.survey$clinic.sv))
clinicsv.complete <- clinicsv.complete %>% 
  mutate(cumulative.Freq = ifelse(output.table.Percent<100.0, cumsum(output.table.Frequency),output.table.Frequency))


clinic.survey <-clinic.survey %>%
  mutate(checktmvisit = case_when(as.numeric(tm_biocolsuv) >72 ~"> 72hrs",
                                  72 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 48 ~ "> 48 hrs to 72 hrs",
                                  48 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 24 ~ "> 24 hrs to 48 hrs",
                                  24 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 12 ~ "> 12 hrs to 24 hrs",
                                  12 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 3 ~ "> 3 hrs to 12 hrs",    
                                  3 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) >= 0 ~ "0 hrs to 3 hrs", 
                                  d_265193023 != 231311385 ~ "Not Submitted", 
                                  TRUE ~ "Missing Time"))


clinic.survey$checktmvisit <- factor(clinic.survey$checktmvisit, levels=c("Not Submitted", "Missing Time", "0 hrs to 3 hrs","> 3 hrs to 12 hrs","> 12 hrs to 24 hrs","> 24 hrs to 48 hrs","> 48 hrs to 72 hrs","> 72hrs"))
clinic.survey$checktmvisit <- droplevels(clinic.survey$checktmvisit)



#Table18- by SIte-- recr.biospe   or clinic.survey    CURRENTLY THE TABLE 18 IN USE
test18 <- clinic.survey %>%
  mutate(clinical.sv = case_when(d_253883960 == 231311385 ~ "Submitted",
                                 d_253883960 == 615768760 ~ "Started",
                                 d_253883960 == 972455046 ~ "Not Started"))
test18$Site<- droplevels(test18$Site)

Table16_combined <- test18 %>% dplyr::select(Site, clinical.sv )  %>% tbl_cross(
  row = clinical.sv,
  col = Site,
  digits=c(0,1),
  percent = "column",
  label=list(Site ~ " ", clinical.sv ~ " "),
  missing="ifany")


Table16_combined_totals <- as.data.frame(Table16_combined)
Table16_combined_totals <- Table16_combined_totals[-1, ]


current_colnames <- colnames(Table16_combined_totals)
current_colnames[length(current_colnames)] <- " Total Clinical Surveys"
colnames(Table16_combined_totals) <- current_colnames



```




```{r Table16a16b, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}



# Baseline research biospecimen survey completion time from time of visit Check In
    ## added requirement: BioChk_Complete_v1r0 is not null instead of survey completed
      ## Jing's original code already does this!!! recrver1$BL_BioChk_Complete_v1r0 
time.sv_checkin <- research.survey  %>% select(checktmvisit) %>% #%>% filter(d_265193023==231311385)
  tbl_summary(
    label=checktmvisit~"Time from Research Biospecimen Survey Completion Time from Time of Visit Check In",
    statistic = list(all_categorical() ~ "{n}  ({p}%)"),
              digits = all_categorical() ~ c(0, 2),
    missing_text="Missing"
  )
total <- as.numeric(nrow(research.survey)) #[which(research.survey$d_265193023==231311385),]
time.sv_checkin <- as.data.frame(tab1(research.survey$checktmvisit)) #[which(research.survey$d_265193023==231311385),]
time.sv_checkin <-time.sv_checkin %>% 
  mutate(cumulative.Freq = ifelse(trimws(rownames(time.sv_checkin))!="Total", cumsum(output.table.Frequency),output.table.Frequency),
         cumulative.Perc = round(100*cumulative.Freq/total,1))

check<-research.survey[which(is.na(research.survey$checktmvisit) & !is.na(research.survey$d_331584571_d_266600170_d_135591601)),   c("Connect_ID","d_265193023","d_222161762","d_822499427","d_331584571_d_266600170_d_840048338","tm_biocolsuv","checktmvisit")]
     #research.survey$d_265193023==231311385 & 




test17_b <- test17 %>%  filter(d_222161762<as.Date("2023-07-05") & (checktmvisit=="> 72hrs" | checktmvisit=="> 48 hrs to 72 hrs" | checktmvisit=="> 24 hrs to 48 hrs" | 
  checktmvisit=="> 12 hrs to 24 hrs" |checktmvisit=="> 3 hrs to 12 hrs" |checktmvisit=="0 hrs to 3 hrs" | checktmvisit=="Missing Time"))
test17_b$checktmvisit<- droplevels(test17_b$checktmvisit)
test17_a <- test17 %>%  filter(d_222161762>=as.Date("2023-07-05") & (checktmvisit=="> 72hrs" | checktmvisit=="> 48 hrs to 72 hrs" | checktmvisit=="> 24 hrs to 48 hrs" | 
  checktmvisit=="> 12 hrs to 24 hrs" |checktmvisit=="> 3 hrs to 12 hrs" |checktmvisit=="0 hrs to 3 hrs" | checktmvisit=="Missing Time"))
test17_a$checktmvisit<- droplevels(test17_a$checktmvisit) 

Table17_combinedB <- test17_b %>% dplyr::select(Site, checktmvisit )  %>% tbl_cross(
    row = checktmvisit,
    col = Site,
    digits=c(0,2),
    percent = "column",
    label=list(Site ~ " ", checktmvisit ~ " "),
    missing="ifany") 



Table17_combinedB_totals <- as.data.frame(Table17_combinedB)
Table17_combinedB_totals <- Table17_combinedB_totals[-1, ]


current_colnames <- colnames(Table17_combinedB_totals)
current_colnames[length(current_colnames)] <- " Total Research Surveys"
colnames(Table17_combinedB_totals) <- current_colnames















Table17_combinedA <- test17_a %>% dplyr::select(Site, checktmvisit )  %>% tbl_cross(
    row = checktmvisit,
    col = Site,
    digits=c(0,2),
    percent = "column",
    label=list(Site ~ " ", checktmvisit ~ " "),
    missing="ifany")


Table17_combinedA_totals <- as.data.frame(Table17_combinedA)
Table17_combinedA_totals <- Table17_combinedA_totals[-1, ]


current_colnames <- colnames(Table17_combinedA_totals)
current_colnames[length(current_colnames)] <- " Total Research Surveys"
colnames(Table17_combinedA_totals) <- current_colnames



```




```{r Table17, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}
#

    ## added requirement: BioClin_AnyBldUrineRec_v1r0 is not null instead of survey completed
    # request of [which(!is.na(clinic.survey$d_173836415_d_266600170_d_156605577)),] but that's already the case
clinic.survey$tm_biocolsuv <-  difftime(as.POSIXct(ymd_hms(clinic.survey$d_764863765)),clinic.survey$clc.coltm,units="hours") 
time.clcsv_checkin <- as.data.frame.matrix(tab1(clinic.survey$checktmvisit)$output.table) #[which(clinic.survey$d_253883960==231311385),]
time.clcsv_checkin <-time.clcsv_checkin %>% 
  mutate(cumulative.Freq = ifelse(trimws(rownames(time.clcsv_checkin))!="Total", cumsum(time.clcsv_checkin$Frequency),time.clcsv_checkin$Frequency))
         #cumulative.Perc = ifelse(trimws(rownames(time.clcsv_checkin))!="Total", cumsum(output.table.Frequency),output.table.....NA..)
       

#  by Site

test18a_B <- test18 %>%  filter(checktmvisit=="> 72hrs" | checktmvisit=="> 48 hrs to 72 hrs" | checktmvisit=="> 24 hrs to 48 hrs" | 
  checktmvisit=="> 12 hrs to 24 hrs" |checktmvisit=="> 3 hrs to 12 hrs" |checktmvisit=="0 hrs to 3 hrs" | checktmvisit=="Missing Time")
test18a_B$checktmvisit<- droplevels(test18a_B$checktmvisit)


Table18_combined <- test18a_B %>% dplyr::select(Site, checktmvisit )  %>% tbl_cross(
  row = checktmvisit,
  col = Site,
  digits=c(0,2),
  percent = "column",
  label=list(Site ~ " ", checktmvisit ~ " "),
  missing="ifany") 



Table18_combined_totals <- as.data.frame(Table18_combined)
Table18_combined_totals <- Table18_combined_totals[-1, ]


current_colnames <- colnames(Table18_combined_totals)
current_colnames[length(current_colnames)] <- " Total Submitted Clinical Surveys"
colnames(Table18_combined_totals) <- current_colnames



```




```{r Table18a18b, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}


test21r <- recrver1 %>%  filter(d_265193023==231311385 & !is.na(d_222161762) & !is.na(d_822499427)) 
test21r <-  test21r %>% mutate(ctime = as.numeric(difftime(as.POSIXct(ymd_hms(d_222161762)),as.POSIXct(ymd_hms(d_822499427)),units="mins")))
test21rb <-  test21r %>%  filter(d_222161762<as.Date("2023-07-05") & ctime>0)
test21ra <-  test21r %>%  filter(d_222161762>as.Date("2023-07-05"))


Table21R_Before = test21rb %>% group_by(Site) %>% 
  dplyr::summarize('Number of Submitted Research Surveys'=n(),
                   Min = min(ctime),
                   Q1 = quantile(ctime, 0.25),
                   Median = median(ctime),
                   Mean = mean(ctime),
                   #SD=sd(ctime),
                   Q3 = quantile(ctime, 0.75),
                   Perc.95= quantile(ctime, 0.95),
                   Max = max(ctime))


Table21R_After = test21ra %>% group_by(Site) %>% 
  dplyr::summarize('Number of Submitted Research Surveys'=n(),
                   Min = min(ctime),
                   Q1 = quantile(ctime, 0.25),
                   Median = median(ctime),
                   Mean = mean(ctime),
                   #SD=sd(ctime),
                   Q3 = quantile(ctime, 0.75),
                   Perc.95= quantile(ctime, 0.95),
                   Max = max(ctime))
```


```{r Table19a19b20, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}
test22c <- recrver1 %>%  filter(d_253883960==231311385 & !is.na(d_764863765) & !is.na(d_534669573)) 
test22c <-  test22c %>% mutate(ctime = as.numeric(difftime(as.POSIXct(ymd_hms(d_764863765)),as.POSIXct(ymd_hms(d_534669573)),units="mins")))
test22cb <-  test22c %>%  filter(d_764863765<as.Date("2023-07-05"))
test22ca <-  test22c %>%  filter(d_764863765>as.Date("2023-07-05"))


ClinSrvy_Lgth_Before = test22cb %>% group_by(Site) %>% 
  dplyr::summarize('Number of Submitted \n Clinical Surveys'=n(),
                   Min = min(ctime),
                   Q1 = quantile(ctime, 0.25),
                   Median = median(ctime),
                   Mean = mean(ctime),
                   Q3 = quantile(ctime, 0.75),
                   Perc.95= quantile(ctime, 0.95),
                   Max = max(ctime))


ClinSrvy_Lgth_After = test22ca %>% group_by(Site) %>% 
  dplyr::summarize('Number of Submitted \n Clinical Surveys'=n(),
                   Min = min(ctime),
                   Q1 = quantile(ctime, 0.25),
                   Median = median(ctime),
                   Mean = mean(ctime),
                   Q3 = quantile(ctime, 0.75),
                   Perc.95= quantile(ctime, 0.95),
                   Max = max(ctime))


#Table 21 now
# Research biospecimen collection visit length (in minutes)
#updated requirement: remove outlier colm and removed times outside of 8 and 500
statics_biock <- tapply(as.numeric(research.survey$time_biochk),research.survey$biochk_outlier,summary)
tab32a <- bind_rows(statics_biock)

research.vt.length <- research.survey %>%  mutate(time=as.numeric(time_biochk)) 

research.vt.length.table = research.vt.length %>%group_by(Site) %>% #biochk_outlier,
  dplyr::summarize('Number of Research Collection Visits'=n(),
                   Min = min(time,na.rm = TRUE),
                   Q1 = quantile(time, 0.25,na.rm = TRUE),
                   Median = median(time,na.rm = TRUE),
                   Mean = mean(time,na.rm = TRUE),
                   Q3 = quantile(time, 0.75,na.rm = TRUE),
                   Perc.90= quantile(time, 0.90,na.rm = TRUE),
                   Perc.95= quantile(time, 0.95,na.rm = TRUE),
                   Perc.98= quantile(time, 0.98,na.rm = TRUE),
                   Max = max(time,na.rm = TRUE))

##### working on, need to add d_951355211 to this data frame 
sitelocation_20a <- biospe %>%  select(Connect_ID, d_951355211)
sitelocation_20a$Connect_ID <- as.numeric(sitelocation_20a$Connect_ID)
research.vt.length$Connect_ID <- as.numeric(research.vt.length$Connect_ID)
research.vt.length.comb <- left_join(research.vt.length, sitelocation_20a, by="Connect_ID")

research.vt.length.UC <- research.vt.length.comb %>% filter(Site=="University of Chicago Medicine") %>% 
  mutate(Site_location = case_when(d_951355211==777644826 ~ "UC-DCAM",
                                   d_951355211==145191545 ~ "Ingalls Harvey",
                                   d_951355211==489380324 ~ "River East",
                                   d_951355211==120264574 ~ "South Loop",
                                   d_951355211==319518299 ~ "UCM Pop-Up",
                                   d_951355211==940329442 ~ "Orland Park"))
research.vt.length.UC.table = research.vt.length.UC %>%group_by(Site_location) %>% #biochk_outlier,
  dplyr::summarize('Number of Research Collection Visits'=n(),
                   Min = min(time,na.rm = TRUE),
                   Q1 = quantile(time, 0.25,na.rm = TRUE),
                   Median = median(time,na.rm = TRUE),
                   Mean = mean(time,na.rm = TRUE),
                   Q3 = quantile(time, 0.75,na.rm = TRUE),
                   Perc.90= quantile(time, 0.90,na.rm = TRUE),
                   Perc.95= quantile(time, 0.95,na.rm = TRUE),
                   Perc.98= quantile(time, 0.98,na.rm = TRUE),
                   Max = max(time,na.rm = TRUE))



```


```{r Table21a21b, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}
##New Table 22


########################

tab22 <- left_join(recrver1, biospe, by=c("Connect_ID", "Site"))

baseline_colct <- tab22 %>%  filter(d_331584571== 266600170 & !is.na(d_914594314) & !is.na(d_556788178) & d_650516960==534621077) # new-- research only

    ## BEFORE 2/1/23
baseline_colctC <- baseline_colct %>%  filter(d_914594314<as.Date("2022-08-01"))

BSL_colctC <- baseline_colctC %>%  mutate(time = as.numeric(difftime(as.POSIXct(ymd_hms(d_556788178)),as.POSIXct(ymd_hms(d_914594314)),units="days")),
                                 "Number of Participants" = n(),
                                 'Number of Baseline Collections' = case_when(!is.na(d_556788178) ~ n()))


verif_BSL_colctC = BSL_colctC %>%group_by(Site) %>% #select("Number of Participants", 'Number of Baseline Collections', time) %>% 
  dplyr::summarize('Number of Research Cllection Visits'=n(),
                   Min = round(min(time,na.rm = TRUE), digits=1),
                   Q1 = round(quantile(time, 0.25,na.rm = TRUE), digits=1),
                   Median = round(median(time,na.rm = TRUE), digits=1),
                   Mean = round(mean(time,na.rm = TRUE), digits=1),
                   #SD= round(sd(time,na.rm = TRUE), digits=1),
                   Q3= round(quantile(time, 0.75,na.rm = TRUE), digits=1),
                   Max = round(max(time,na.rm = TRUE), digits=1))




    ## ON OR AFTER 2/1/23


baseline_colctD <- baseline_colct %>%  filter(d_914594314>=as.Date("2022-08-01"))

BSL_colctD <- baseline_colctD %>%  mutate(time = as.numeric(difftime(as.POSIXct(ymd_hms(d_556788178)),as.POSIXct(ymd_hms(d_914594314)),units="days")))


verif_BSL_colctD = BSL_colctD %>%group_by(Site) %>% 
  dplyr::summarize('Number of Research Collection Visits'=n(),
                   Min = round(min(time,na.rm = TRUE), digits=1),
                   Q1 = round(quantile(time, 0.25,na.rm = TRUE), digits=1),
                   Median = round(median(time,na.rm = TRUE), digits=1),
                   Mean = round(mean(time,na.rm = TRUE), digits=1),
                   SD= round(sd(time,na.rm = TRUE), digits=1),
                   Q3= round(quantile(time, 0.75,na.rm = TRUE), digits=1),
                   Max = round(max(time,na.rm = TRUE), digits=1))


########


## New table 23


baseline_colct <- tab22 %>%  filter(d_331584571== 266600170 & !is.na(d_914594314) & !is.na(d_556788178) & d_650516960==664882224) # new-- clinical only, will need research also separately later 

    ## BEFORE 2/1/23
baseline_colctA <- baseline_colct %>%  filter(d_914594314<as.Date("2023-02-01"))

BSL_colctA <- baseline_colctA %>%  mutate(time = as.numeric(difftime(as.POSIXct(ymd_hms(d_556788178)),as.POSIXct(ymd_hms(d_914594314)),units="days")),
                                 "Number of Participants" = n(),
                                 'Number of Baseline Collections' = case_when(!is.na(d_556788178) ~ n()))


verif_BSL_colctA = BSL_colctA %>%group_by(Site) %>% #select("Number of Participants", 'Number of Baseline Collections', time) %>% 
  dplyr::summarize('Number of Clinical Collections'=n(),
                   Min = round(min(time,na.rm = TRUE), digits=1),
                   Q1 = round(quantile(time, 0.25,na.rm = TRUE), digits=1),
                   Median = round(median(time,na.rm = TRUE), digits=1),
                   Mean = round(mean(time,na.rm = TRUE), digits=1),
                   SD= round(sd(time,na.rm = TRUE), digits=1),
                   Q3= round(quantile(time, 0.75,na.rm = TRUE), digits=1),
                   Max = round(max(time,na.rm = TRUE), digits=1))




    ## ON OR AFTER 2/1/23

baseline_colctB <- baseline_colct %>%  filter(d_914594314>=as.Date("2023-02-01"))

BSL_colctB <- baseline_colctB %>%  mutate(time = as.numeric(difftime(as.POSIXct(ymd_hms(d_556788178)),as.POSIXct(ymd_hms(d_914594314)),units="days")))


verif_BSL_colctB = BSL_colctB %>%group_by(Site) %>% 
  dplyr::summarize('Number of Clinical Collections'=n(),
                   Min = round(min(time,na.rm = TRUE), digits=1),
                   Q1 = round(quantile(time, 0.25,na.rm = TRUE), digits=1),
                   Median = round(median(time,na.rm = TRUE), digits=1),
                   Mean = round(mean(time,na.rm = TRUE), digits=1),
                   SD= round(sd(time,na.rm = TRUE), digits=1),
                   Q3= round(quantile(time, 0.75,na.rm = TRUE), digits=1),
                   Max = round(max(time,na.rm = TRUE), digits=1))











#New Table 24


ver_draw <- tab22 %>%  filter(biocol_Setting== "Clinical" & !is.na(d_914594314) & !is.na(d_556788178) & d_914594314>=as.Date("2023-02-01")  & Site!='HealthPartners' & Site!='Sanford Health' & Site!='University of Chicago Medicine') 
##won't receive a draw order from HP--Github issue 72

verif_draw <- ver_draw %>%  mutate(time = as.numeric(difftime(as.POSIXct(ymd_hms(d_173836415_d_266600170_d_769615780)),as.POSIXct(ymd_hms(d_914594314)),units="days")))

verif_draw_order = verif_draw %>%group_by(Site) %>% 
  dplyr::summarize('Number of Draw Orders Placed'=n(),
                   Min = round(min(time,na.rm = TRUE), digits=1),
                   Q1 = round(quantile(time, 0.25,na.rm = TRUE), digits=1),
                   Median = round(median(time,na.rm = TRUE), digits=1),
                   Mean = round(mean(time,na.rm = TRUE), digits=1),
                   #SD= round(sd(time,na.rm = TRUE), digits=1),
                   Q3 = round(quantile(time, 0.75,na.rm = TRUE), digits=1),
                   Max = round(max(time,na.rm = TRUE), digits=1))














    ## ON OR AFTER 2/1/23
parts24 <- "SELECT Connect_ID, state_d_667474224 FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` where Connect_ID IS NOT NULL"
parts24_table <- bq_project_query(project, parts24)
parts24_data <- bq_table_download(parts24_table, bigint="integer64",n_max = Inf, page_size = 10000)
parts24_data$Connect_ID <- as.numeric(parts24_data$Connect_ID)
tab24 <- left_join(recrver1, biospe, by=c("Connect_ID", "Site")) %>% left_join(parts24_data, by="Connect_ID")

baseline_24 <- tab24 %>%  filter(d_331584571== 266600170 & !is.na(d_914594314) & !is.na(d_556788178) )

baseline_24_after <- baseline_24 %>%  filter(d_914594314>=as.Date("2022-06-01") ) 

BSL_after24 <- baseline_24_after %>%  mutate(time = as.numeric(difftime(as.POSIXct(ymd_hms(d_556788178)),as.POSIXct(ymd_hms(d_914594314)),units="days")),
                                     # Site = case_when(d_827220437.x==472940358 ~ "Baylor Scott and White Health",
                                     #                  d_827220437.x==125001209 ~ "KP Colorado",
                                     #              d_827220437.x==327912200 ~ "KP Georgia",
                                     #              d_827220437.x==300267574 ~ "KP Hawaii",
                                     #              d_827220437.x==452412599 ~ "KP Northwest",
                                     #              d_827220437.x==548392715 ~ "Henry Ford",
                                     #              d_827220437.x==531629870 ~ "HealthPartners",
                                     #              d_827220437.x==303349821 ~ "Marshfield",
                                     #              d_827220437.x==657167265 ~ "Sanford",
                                     #              d_827220437.x==809703864 ~ "UChicago"),
                                     #              #d_827220437.x==517700004 ~ "NCI"),
                                     campaign = case_when( (state_d_667474224==348281054 | state_d_667474224==324692899)  ~ "Upcoming Appointment" ,
                                                            TRUE ~ "All Other Campaigns"))


verif_baseline_Af = BSL_after24 %>%group_by(Site) %>% 
  dplyr::summarize(#'Number of Baseline Collections1'=n()[campaign=="Upcoming Appointment"],
                   'Number of Baseline Collections1' = sum(campaign == "Upcoming Appointment"),
                   Min1 = round(min(time[campaign=="Upcoming Appointment"],na.rm = TRUE), digits=1),
                   Median1 = round(median(time[campaign=="Upcoming Appointment"],na.rm = TRUE), digits=1),
                   Mean1 = round(mean(time[campaign=="Upcoming Appointment"],na.rm = TRUE), digits=1),
                   SD1= round(sd(time[campaign=="Upcoming Appointment"],na.rm = TRUE), digits=1),
                   Max1 = round(max(time[campaign=="Upcoming Appointment"],na.rm = TRUE), digits=1),
                   #'Number of Baseline Collections2'=n()[campaign=="All Other Campaigns"],
                   'Number of Baseline Collections2'=sum(campaign == "All Other Campaigns"),
                   Min2 = round(min(time[campaign=="All Other Campaigns"],na.rm = TRUE), digits=1),
                   Median2 = round(median(time[campaign=="All Other Campaigns"],na.rm = TRUE), digits=1),
                   Mean2 = round(mean(time[campaign=="All Other Campaigns"],na.rm = TRUE), digits=1),
                   SD2= round(sd(time[campaign=="All Other Campaigns"],na.rm = TRUE), digits=1),
                   Max2 = round(max(time[campaign=="All Other Campaigns"],na.rm = TRUE), digits=1),
                   'Total Number of Baseline Collections'=n())%>%
  ungroup()

 
verif_baseline_Af <- verif_baseline_Af %>%  select(Site,  'Number of Baseline Collections1', Min1, Median1, Mean1, SD1, Max1, 'Number of Baseline Collections2', Min2, Median2, Mean2, SD2, Max2, 'Total Number of Baseline Collections')




```
 
 
 
```{r Figures20_23, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}
#Code for figures


#Fig 1-- for now, no longer being used
sv.outlier.research <- ggplot(research.survey, aes(x=Site, y=as.numeric(time_biochk),fill=Site,color=Site)) + 
  geom_boxplot() + geom_jitter(width = 0.2) +   scale_fill_brewer(palette="Dark2") +
  geom_hline(linetype = "dashed", yintercept = 1440,color="red") + 
  annotate('text', x=1, y=1800, label = "24 hours",size=3)+
  ggtitle("Fig 2. Research Biospecimen Collection \n Visit Length (in Minutes) by Site") +
    ylab("Visit Length (minutes)") + xlab("Site") +
    scale_y_continuous(limits = c(0, 50000)) +
    theme(panel.background = element_blank(),
          legend.title = element_text(size=7),
          axis.line = element_line(size=0.2),
          axis.text.x = element_text(angle = 60,hjust = 1, size = 8, face = "bold"), 
          plot.title = element_text(hjust = 0.5,size = 12, face = "bold"))


#Fig 2- 
research.survey<- research.survey %>% mutate(#weekday = weekdays(ymd_hms(collection.tm)),
                                    start.date = min(schedulecol.tm),
                                    current.date=max(as.POSIXct(ymd_hms(schedulecol.tm))),
                                    BioRec_CollectScheduled = ifelse(as.Date(ymd_hms(schedulecol.tm)) >= as.Date(as.POSIXct(ymd_hms(d_914594314))),1,0))



clinic.survey_specs <- clinic.survey %>%   filter(d_878865966 == 353358909| d_167958071 == 353358909) ## must add

clc.bothtm <- c("d_173836415_d_266600170_d_139245758","d_173836415_d_266600170_d_224596428","d_173836415_d_266600170_d_541311218","d_173836415_d_266600170_d_939818935","d_173836415_d_266600170_d_769615780",
                "d_173836415_d_266600170_d_822274939","d_173836415_d_266600170_d_398645039","d_173836415_d_266600170_d_982213346")
dd[grepl("139245758|224596428|541311218|939818935|769615780|822274939|398645039|982213346",dd$CID),]

clc.both.vt <- clinic.survey_specs[,c("Connect_ID","Site","bldcol_max","Urine_col_max","collection.tm",clc.bothtm)]
clc.both.vt$both.startdate <- min(ymd_hms(clc.both.vt$d_173836415_d_266600170_d_139245758), ymd_hms(clc.both.vt$d_173836415_d_266600170_d_982213346),na.rm=TRUE) #as.POSIXct()
                               
clc.both.vt <- clc.both.vt %>%
  mutate(bldcol.time = case_when(bldcol_max >0 ~ pmin(as.POSIXct(d_173836415_d_266600170_d_982213346),as.POSIXct(d_173836415_d_266600170_d_398645039),as.POSIXct(d_173836415_d_266600170_d_822274939),na.rm=TRUE)),
         urine.time = case_when(Urine_col_max >0 ~ pmin(as.POSIXct(d_173836415_d_266600170_d_139245758),as.POSIXct(d_173836415_d_266600170_d_541311218),as.POSIXct(d_173836415_d_266600170_d_224596428),na.rm=TRUE)),
         BU.time =  pmin(as.POSIXct(bldcol.time),as.POSIXct(urine.time), na.rm = TRUE)) ## matches up exactly with operations code
                                            


clc.both.vt$BU.Sunday.week <- ceiling(as.numeric(difftime(clc.both.vt$BU.time,as.Date(veristart.date-days(2)),units="days"))/7)

clc.both.vt$BU.Sunday.date <- veristart.date + days(5)+dweeks(clc.both.vt$BU.Sunday.week -1) #veristart is 7/27, but that's a tueaday. Add 5 days to make it Sunday, then subtract a week to make it the start of that previous week
clc.both.vt$Monday.date.start <- clc.both.vt$BU.Sunday.date-days(6)


clc.both.vt.KP <- clc.both.vt %>% filter(Monday.date.start>=as.Date("2023-01-30") & BU.Sunday.date < currentDate)
clc.both.vt.CO <- clc.both.vt.KP %>%  filter(clc.both.vt.KP$Site=="Kaiser Permanente Colorado")
clc.both.vt.GA <- clc.both.vt.KP %>%  filter(clc.both.vt.KP$Site=="Kaiser Permanente Georgia")
clc.both.vt.HI <- clc.both.vt.KP %>%  filter(clc.both.vt.KP$Site=="Kaiser Permanente Hawaii")
clc.both.vt.NW <- clc.both.vt.KP %>%  filter(clc.both.vt.KP$Site=="Kaiser Permanente Northwest")



 clc.both.wk_site.CO <- clc.both.vt.CO %>% arrange(Site,BU.Sunday.week,Monday.date.start) %>% group_by(Site,BU.Sunday.week,Monday.date.start) %>% tally()
 
 
 clc_both_vt.site.CO<- clc.both.wk_site.CO  %>% ggplot( aes(x=as_date(clc.both.wk_site.CO$Monday.date.start), y=n)) + 
   geom_line() + 
  geom_point(width = 0.2) +
  scale_y_continuous(name="Number of Collections") + 
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2023-01-16"),as.Date(Sys.Date())-7),expand=c(0,0))  +
  scale_fill_brewer(palette="Dark2") + 

  ggtitle(label="Figure 6.16: Baseline- Weekly Biospecimen Collections,  \n Kaiser Permanente Colorado") +
  theme(panel.background = element_blank(),
        legend.title = element_text(size=7),
        axis.line = element_line(size=0.2),
        axis.text.x = element_text(angle=60, hjust = 1,size = 8, face = "bold"),                                                            
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) 

clc_both_vt.site.CO





clc.both.wk_site.GA <- clc.both.vt.GA %>% arrange(Site,BU.Sunday.week,Monday.date.start) %>% group_by(Site,BU.Sunday.week,Monday.date.start) %>% tally()

clc_both_vt.site.GA<- clc.both.wk_site.GA  %>% ggplot( aes(x=as_date(clc.both.wk_site.GA$Monday.date.start), y=n)) + 
  geom_line() + 
  geom_point(width = 0.2) +
  scale_y_continuous(name="Number of Collections") + 
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2023-01-16"),as.Date(currentDate)-7),expand=c(0,0))  +
  scale_fill_brewer(palette="Dark2") + 
  ggtitle(label="Figure 6.17: Baseline- Weekly Biospecimen Collections,  \n Kaiser Permanente Georgia") +
  #theme_ipsum() +
  theme(panel.background = element_blank(),
        legend.title = element_text(size=7),
        axis.line = element_line(size=0.2),
        axis.text.x = element_text(angle=60, hjust = 1,size = 8, face = "bold"),                                                            
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) 

clc_both_vt.site.GA





clc.both.wk_site.HI <- clc.both.vt.HI %>% arrange(Site,BU.Sunday.week,Monday.date.start) %>% group_by(Site,BU.Sunday.week,Monday.date.start) %>% tally()

clc_both_vt.site.HI<- clc.both.wk_site.HI %>% ggplot( aes(x=as_date(clc.both.wk_site.HI$Monday.date.start), y=n)) +
  geom_line() + 
  geom_point(width = 0.2) +
  scale_y_continuous(name="Number of Collections") + 
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2023-01-16"),as.Date(currentDate)-7),expand=c(0,0))  +
  scale_fill_brewer(palette="Dark2") + 
  ggtitle(label="Figure 6.18: Baseline- Weekly Biospecimen Collections, \n Kaiser Permanente Hawaii") +
  theme(panel.background = element_blank(),
        legend.title = element_text(size=7),
        axis.line = element_line(size=0.2),
        axis.text.x = element_text(angle=60, hjust = 1,size = 8, face = "bold"),                                                            
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) 

clc_both_vt.site.HI





clc.both.wk_site.NW <- clc.both.vt.NW %>% arrange(Site,BU.Sunday.week,Monday.date.start) %>% group_by(Site,BU.Sunday.week,Monday.date.start) %>% tally()

clc_both_vt.site.NW<- clc.both.wk_site.NW  %>% ggplot( aes(x=as_date(clc.both.wk_site.NW$Monday.date.start), y=n)) +
  geom_line() + 
  geom_point(width = 0.2) +
  scale_y_continuous(name="Number of Collections") + #, limits=c(0,5)) +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2023-01-16"),as.Date(currentDate)-7),expand=c(0,0))  +
  scale_fill_brewer(palette="Dark2") + 
  ggtitle(label="Figure 6.19: Baseline- Weekly Biospecimen Collections,  \n Kaiser Permanente Northwest") +
  theme(panel.background = element_blank(),
        legend.title = element_text(size=7),
        axis.line = element_line(size=0.2),
        axis.text.x = element_text(angle=60, hjust = 1,size = 8, face = "bold"),                                                            
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) 

clc_both_vt.site.NW

```


```{r Table26, warning=FALSE, eval=TRUE,echo=FALSE}

#Denominator
  #recrver1$d_821247024 == verified --> all participants in this BQ pull are verfied already
  #d_410912345 is null
#Numerator
  # days between today and verification date d_914594314, confirmed none are null



recrver1 <- recrver1 %>% mutate(BiospeCollection = ifelse((recrver1$d_684635302 == 353358909 | recrver1$d_878865966 == 353358909| recrver1$d_167958071 == 353358909), "Any biospecimen Collections","No biospecimen collections"))

recrver1$Site<- droplevels(recrver1$Site)



bio.appoint <- biospe %>% arrange(Connect_ID, d_410912345) %>% group_by(Connect_ID) %>% summarise(d_410912345=mean(d_410912345,na.rm=TRUE)) #to remove the multiple collections by Connect_ID
 
biocol.tb <- base::merge(recrver1[,c("Connect_ID","Site","BiospeCollection","d_878865966","d_684635302","d_167958071", "d_914594314")],bio.appoint,by.x="Connect_ID",by.y="Connect_ID",all.x=TRUE )
 
table1 <- biocol.tb %>% filter(recrver1$d_821247024==197316935) %>%
  mutate(#appointment = ifelse((d_410912345!= 353358909 | is.na(d_410912345)), 104430631, 353358909),
         biocol.appoint = case_when(BiospeCollection == "Any biospecimen Collections" & d_410912345== 353358909 ~ "Baseline Collection",
                                    #BiospeCollection == "No biospecimen collections" & (d_410912345!= 353358909 | is.na(d_410912345)) ~ "No Baseline Collection"
                                    TRUE ~ "No Baseline Collection"))  



#RESEARCH 

ver_date_diff <-table1  %>% filter(biocol.appoint=="No Baseline Collection")  %>% group_by(Site) %>% 
  mutate(day_past = difftime(as.Date(currentDate), as.Date(d_914594314), units="days"),
         coll_days_diff = ifelse(as.numeric(day_past)<30,"< 30 Days",
                                 ifelse(as.numeric(day_past)<60,"30 to <60 Days",
                                        ifelse(as.numeric(day_past)<90,"60 to <90 Days",
                                        ifelse(as.numeric(day_past)<180,"90 to 180 Days",
                                               ifelse(as.numeric(day_past)<270,"180 to <270 Days",
                                                             "270 Days or More"))))))


ver_date_diff$Connect_ID <- as.numeric(ver_date_diff$Connect_ID)

table.coll_bptl <- ctable(ver_date_diff$Site,ver_date_diff$coll_days_diff)
crosstable.coll_bptl <- as.data.frame(cbind(table.coll_bptl$cross_table,table.coll_bptl$proportions))
crosstable.coll_bptl$Sites <-trimws(rownames(crosstable.coll_bptl))


crosstable.coll_bptl$n_pct_30_Day <-  paste(format(crosstable.coll_bptl[,1],big.mark=","),"(", round(100*crosstable.coll_bptl[,8],1),"%)",sep=" ")
crosstable.coll_bptl$n_pct_60_Day <-  paste(format(crosstable.coll_bptl[,4],big.mark=","),"(", round(100*crosstable.coll_bptl[,11],1),"%)",sep=" ")
crosstable.coll_bptl$n_pct_90_Day <-  paste(format(crosstable.coll_bptl[,5],big.mark=","),"(", round(100*crosstable.coll_bptl[,12],1),"%)",sep=" ")
crosstable.coll_bptl$n_pct_180_Day <-  paste(format(crosstable.coll_bptl[,6],big.mark=","),"(", round(100*crosstable.coll_bptl[,13],1),"%)",sep=" ")
crosstable.coll_bptl$n_pct_270_Day <-  paste(format(crosstable.coll_bptl[,2],big.mark=","),"(", round(100*crosstable.coll_bptl[,9],1),"%)",sep=" ")
crosstable.coll_bptl$n_pct_270_plus_days =  paste(format(crosstable.coll_bptl[,3],big.mark=","),"(", round(100*crosstable.coll_bptl[,10],1),"%)",sep=" ")
crosstable.coll_bptl$Total <- paste(crosstable.coll_bptl$Total, " (100%)")
#nrow(crosstable.coll_bptl)
         
crosstable.coll_bptl1 <- crosstable.coll_bptl[, c(15:21, 7)]


```


```{r Table27, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}


#Table 26

recr_site_only <- recr.biospe %>%  select(d_650516960, Connect_ID)

blood_fig4 <- left_join(recr.bio, recr_site_only, by="Connect_ID") 


###won't receive a draw order from HP--Github issue 72
blood_placed= blood_fig4 %>%  filter(recr.bio$d_821247024==197316935  & (d_827220437==125001209 | d_827220437==327912200 |
                                                                        d_827220437==300267574 | d_827220437==452412599 )) ## excluding hybrid sites
blood_placed= blood_placed %>%  mutate(bld_placed= case_when(d_173836415_d_266600170_d_530173840==353358909 ~ "Blood Draw Order Placed",
                                                             (d_173836415_d_266600170_d_530173840==104430631 | is.na(d_173836415_d_266600170_d_530173840))~ "No Blood Draw Order Placed"),
                               Site= case_when(d_827220437==125001209 ~ "Kaiser Permanente Colorado",
                                                  d_827220437==327912200 ~ "Kaiser Permanente Georgia",
                                                  d_827220437==300267574 ~ "Kaiser Permanente Hawaii",
                                                  d_827220437==452412599 ~ "Kaiser Permanente Northwest"),
                               verif_bld= case_when(d_821247024==197316935 ~ 1,
                                                    TRUE ~ 0))



Table_bld_draw <- blood_placed %>% dplyr::select(Site, bld_placed)  %>% tbl_cross(
  row = Site,
  col = bld_placed,
  percent = "row",
  digits=c(0,1),
  label=list(Site~"Site", bld_placed~" "), 
  missing="ifany",
  missing_text="Unknown") %>%
  bold_labels() %>%
  #italicize_levels() %>% 
  modify_header() %>%
  modify_caption("Table 4.11: Baseline Blood Draw Order Status Among Verified Participants") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)




``` 
 
 
 
```{r Table25, include=FALSE, echo=FALSE, warning=FALSE}


avg_coll <- clinic.survey %>%  filter(d_173836415_d_266600170_d_982213346>=as.Date("2023-02-01") & Site!='HealthPartners' & Site!="Sanford Health" & Site!='University of Chicago Medicine') ##won't receive a draw order from HP--Github issue 72
avg_coll <- avg_coll %>%  mutate(time = as.numeric(difftime(as.POSIXct(ymd_hms(d_173836415_d_266600170_d_982213346)),as.POSIXct(ymd_hms(d_173836415_d_266600170_d_769615780)),units="days")))

avg_draw_order = avg_coll %>%group_by(Site) %>% #biochk_outlier,
  dplyr::summarize('Number of Clinical Collections'=n(),
                   Min = round(min(time,na.rm = TRUE), digits=1),
                   Q1 = round(quantile(time, 0.25,na.rm = TRUE), digits=1),
                   Median = round(median(time,na.rm = TRUE), digits=1),
                   Mean = round(mean(time,na.rm = TRUE), digits=1),
                   Q3 = round(quantile(time, 0.75,na.rm = TRUE), digits=1),
                   Perc.80= quantile(time, 0.80,na.rm = TRUE),
                   Perc.90= quantile(time, 0.90,na.rm = TRUE),
                   Perc.95= quantile(time, 0.95,na.rm = TRUE),
                   Max = round(max(time,na.rm = TRUE), digits=1))

```



```{r Table26_bldorder_present, include=FALSE, echo=FALSE, warning=FALSE}

present.day <- Sys.time()

bldorder_present <- recrver1 %>%  filter(d_878865966==104430631 & !is.na(d_173836415_d_266600170_d_769615780) & Site!='HealthPartners' & Site!='Henry Ford Health System'  & Site!='Sanford Health') %>%  
  mutate(time = as.numeric(difftime(present.day,as.POSIXct(ymd_hms(d_173836415_d_266600170_d_769615780)),units="days")))

avg_bldorder_present = bldorder_present %>%group_by(Site) %>% #biochk_outlier,
  dplyr::summarize('Number of Clinical Collections'=n(),
                   Min = round(min(time,na.rm = TRUE), digits=1),
                   Q1 = round(quantile(time, 0.25,na.rm = TRUE), digits=1),
                   Median = round(median(time,na.rm = TRUE), digits=1),
                   Mean = round(mean(time,na.rm = TRUE), digits=1),
                   Q3 = round(quantile(time, 0.75,na.rm = TRUE), digits=1),
                   Perc.80= quantile(time, 0.80,na.rm = TRUE),
                   Perc.90= quantile(time, 0.90,na.rm = TRUE),
                   Perc.95= quantile(time, 0.95,na.rm = TRUE),
                   Max = round(max(time,na.rm = TRUE), digits=1))


```

 

```{r Figures4, include=FALSE, echo=FALSE, warning=FALSE, eval=TRUE}


##HF
fig4_sub_all <- research.survey %>%  filter(Site=="Henry Ford Health System") # | Site=="Sanford Health" | Site=="University of Chicago Medicine")
fig4_sub_all <- fig4_sub_all %>%  filter((d_684635302 == 353358909 | d_878865966 == 353358909| d_167958071 == 353358909) & !is.na(checktmvisit)) # & d_222161762<as.Date("2023-07-05")

fig4_sub_all$Site<- droplevels(fig4_sub_all$Site)



fig4_sub_1<- fig4_sub_all %>% mutate(hours3 = case_when(checktmvisit=="0 hrs to 3 hrs"~1,
                                                TRUE~0))

visit_wk_site4 <- fig4_sub_1 %>% 
  group_by(Site, col.Monday.date) %>% 
  summarise(
    n = sum(!is.na(checktmvisit)),  
    hours3 = sum(hours3),
    pct3 = 100*round(hours3/n, digits=2)
  ) %>% 
  ungroup()

research.4_1 <- ggplot(visit_wk_site4, aes(x=as.Date(col.Monday.date), y=pct3)) + 
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="Percent %",breaks=seq(0,100,25)) +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-1),expand=c(0,0))  +
  scale_fill_brewer(palette="Dark2") +

  ggtitle(label="Figure 3.3: Baseline- Weekly Percent of Biospecimen Surveys Submitted within 3 Hours of \n Research Collection Visit Check In, Henry Ford Health  ") +
  theme(panel.background = element_blank(),
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14, face = "bold") ,
        axis.title.y = element_text(size = 14, face = "bold",color="black"),
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) 





##Sanford
fig4_sub_all <- research.survey %>%  filter(Site=="Sanford Health") # | Site=="Sanford Health" | Site=="University of Chicago Medicine")
fig4_sub_all <- fig4_sub_all %>%  filter((d_684635302 == 353358909 | d_878865966 == 353358909| d_167958071 == 353358909) & !is.na(checktmvisit)) # & d_222161762<as.Date("2023-07-05")

fig4_sub_all$Site<- droplevels(fig4_sub_all$Site)

fig4_sub_1<- fig4_sub_all %>% mutate(hours3 = case_when(checktmvisit=="0 hrs to 3 hrs"~1,
                                                TRUE~0))
visit_wk_site4__2 <- fig4_sub_1 %>% 
  group_by(Site, col.Monday.date) %>% 
  summarise(
    n = sum(!is.na(checktmvisit)),  
    hours3 = sum(hours3),
    pct3 = 100*round(hours3/n, digits=2)
  ) %>% 
  ungroup()




research.4_2 <- ggplot(visit_wk_site4__2, aes(x=as.Date(col.Monday.date), y=pct3)) + #, color=Site)) + #,fill=Site, color=Site)) +
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="Percent %",breaks=seq(0,100,25)) +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-1),expand=c(0,0))  +
  scale_fill_brewer(palette="Dark2") +
  ggtitle(label="Figure 3.4: Baseline- Weekly Percent of Biospecimen Surveys Submitted within 3 Hours of \n Research Collection Visit Check In, Sanford Health") +
  theme(panel.background = element_blank(),
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14, face = "bold") ,
        axis.title.y = element_text(size = 14, face = "bold",color="black"),
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) 





##UC
fig4_sub_all <- research.survey %>%  filter(Site=="University of Chicago Medicine") # | Site=="Sanford Health" | Site=="University of Chicago Medicine")
fig4_sub_all <- fig4_sub_all %>%  filter((d_684635302 == 353358909 | d_878865966 == 353358909| d_167958071 == 353358909) & !is.na(checktmvisit)) # & d_222161762<as.Date("2023-07-05")

fig4_sub_all$Site<- droplevels(fig4_sub_all$Site)


fig4_sub_1<- fig4_sub_all %>% mutate(hours3 = case_when(checktmvisit=="0 hrs to 3 hrs"~1,
                                                TRUE~0))
visit_wk_site4__3 <- fig4_sub_1 %>% 
  group_by(Site, col.Monday.date) %>% 
  summarise(
    n = sum(!is.na(checktmvisit)),  
    hours3 = sum(hours3),
    pct3 = 100*round(hours3/n, digits=2)
  ) %>% 
  ungroup()


research.4_3 <- ggplot(visit_wk_site4__3, aes(x=as.Date(col.Monday.date), pct3)) + #, color=Site)) + #,fill=Site, color=Site)) +
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="Percent %",breaks=seq(0,100,25)) +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-1),expand=c(0,0))  +
  scale_fill_brewer(palette="Dark2") +
  ggtitle(label="Figure 3.5: Baseline- Weekly Percent of Biospecimen Surveys Submitted within 3 Hours of \n Research Collection Visit Check In, University of Chicago Medicine") +
  theme(panel.background = element_blank(),
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14, face = "bold") ,
        axis.title.y = element_text(size = 14, face = "bold",color="black"),
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) 


```
 
```{r Table28a,include=FALSE, echo=FALSE, warning=FALSE}

#need to make all BPTL 11:30 for consistency purposes of tables 3 & 4


str_sub(biospe$d_143615646_d_926457119,12,24)[!is.na(biospe$d_143615646_d_926457119)] <- "11:30:00.000Z"
str_sub(biospe$d_232343615_d_926457119,12,24)[!is.na(biospe$d_232343615_d_926457119)] <- "11:30:00.000Z"
str_sub(biospe$d_299553921_d_926457119,12,24)[!is.na(biospe$d_299553921_d_926457119)] <- "11:30:00.000Z"
str_sub(biospe$d_376960806_d_926457119,12,24)[!is.na(biospe$d_376960806_d_926457119)] <- "11:30:00.000Z"
str_sub(biospe$d_454453939_d_926457119,12,24)[!is.na(biospe$d_454453939_d_926457119)] <- "11:30:00.000Z"
str_sub(biospe$d_505347689_d_926457119,12,24)[!is.na(biospe$d_505347689_d_926457119)] <- "11:30:00.000Z"
str_sub(biospe$d_589588440_d_926457119,12,24)[!is.na(biospe$d_589588440_d_926457119)] <- "11:30:00.000Z"
str_sub(biospe$d_652357376_d_926457119,12,24)[!is.na(biospe$d_652357376_d_926457119)] <- "11:30:00.000Z"
str_sub(biospe$d_677469051_d_926457119,12,24)[!is.na(biospe$d_677469051_d_926457119)] <- "11:30:00.000Z"
str_sub(biospe$d_683613884_d_926457119,12,24)[!is.na(biospe$d_683613884_d_926457119)] <- "11:30:00.000Z"
str_sub(biospe$d_703954371_d_926457119,12,24)[!is.na(biospe$d_703954371_d_926457119)] <- "11:30:00.000Z"
str_sub(biospe$d_838567176_d_926457119,12,24)[!is.na(biospe$d_838567176_d_926457119)] <- "11:30:00.000Z"
str_sub(biospe$d_958646668_d_926457119,12,24)[!is.na(biospe$d_958646668_d_926457119)] <- "11:30:00.000Z"
str_sub(biospe$d_973670172_d_926457119,12,24)[!is.na(biospe$d_973670172_d_926457119)] <- "11:30:00.000Z"

#RESEARCH 
biospe_adhoc= biospe %>%  filter(d_650516960==534621077 & d_410912345==353358909 & !is.na(d_678166505) & 
                                   #BPTL not null
                             (!is.na(d_143615646_d_926457119) | !is.na(d_232343615_d_926457119) | !is.na(d_299553921_d_926457119) | !is.na(d_376960806_d_926457119) |
                                !is.na(d_454453939_d_926457119) | !is.na(d_505347689_d_926457119) | !is.na(d_589588440_d_926457119) | !is.na(d_652357376_d_926457119) |
                                !is.na(d_677469051_d_926457119) | !is.na(d_683613884_d_926457119) | !is.na(d_703954371_d_926457119) | !is.na(d_838567176_d_926457119) |
                                !is.na(d_958646668_d_926457119) | !is.na(d_973670172_d_926457119))) %>%
                     mutate(Site_location = case_when(d_951355211==777644826 ~ "UC-DCAM",
                                                      d_951355211==145191545 ~ "Ingalls Harvey",
                                                      d_951355211==489380324 ~ "River East",
                                                      d_951355211==120264574 ~ "South Loop",
                                                      d_951355211==834825425 ~ "HP Research Clinic",
                                                      #d_951355211==574368418 ~ "HP Park Nicollet",
                                                      d_951355211==736183094 ~ "HFH K-13 Research Clinic",
                                                      d_951355211==886364332 ~ "HFH Cancer Pavilion Research Clinic",
                                                      d_951355211==706927479 ~ "HFH Livonia Research Clinic",
                                                      d_951355211==322059622 ~ "HFH Pop-Up",
                                                      d_951355211==692275326 ~ "Marshfield",
                                                      d_951355211==813701399 ~ "Weston",
                                                      d_951355211==698283667 ~ "Lake Hallie",
                                                      d_951355211==691714762 ~ "Rice Lake",
                                                      d_951355211==487512085 ~ "Wisconsin Rapids",
                                                      d_951355211==983848564 ~ "Colby Abbotsford",
                                                      d_951355211==261931804 ~ "Minocqua",
                                                      d_951355211==665277300 ~ "Merrill",
                                                      d_951355211==589224449 ~ "Sioux Falls Imagenetics",
                                                      d_951355211==467088902 ~ "Fargo South University",
                                                      d_951355211==567969985 ~ "MF Pop-Up",
                                                      d_951355211==319518299 ~ "UCM Pop-Up",
                                                      d_951355211==940329442 ~ "Orland Park",
                                                      d_951355211==723351427 ~ "HWC, BC",
                                                      d_951355211==807443231 ~ "All Saints (FW)",
                                                      TRUE ~ "Remove"),
                            Site = case_when(d_827220437==472940358 ~ "Baylor Scott and White Health",
                                             d_827220437==548392715 ~ "Henry Ford Health",
                                             d_827220437 == 531629870 ~ "HealthPartners",
                                             d_827220437 == 303349821 ~ "Marshfield",
                                             d_827220437 == 657167265 ~ "Sanford Health",
                                             d_827220437 == 809703864 ~ "University of Chicago", 
                                             TRUE ~ "Remove")) %>%  filter(Site!="Remove" & Site_location!="Remove")
#723351427 807443231
#biospe_adhoc$Site_location<- droplevels(biospe_adhoc$Site_location)
biospe_adhoc$Site_location <- factor(biospe_adhoc$Site_location,
                                     levels=c("HWC, BC","All Saints (FW)","HP Research Clinic", #"HP Park Nicollet",
                                              "HFH K-13 Research Clinic","HFH Cancer Pavilion Research Clinic",
                                              "HFH Livonia Research Clinic", "HFH Pop-Up",
                                              "Marshfield", "MF Pop-Up","Weston","Lake Hallie", "Rice Lake","Wisconsin Rapids", 
                                              "Colby Abbotsford","Minocqua","Merrill",
                                              "Sioux Falls Imagenetics","Fargo South University",
                                              "Ingalls Harvey", "River East","South Loop","UCM Pop-Up","UC-DCAM","Orland Park")) 
biospe_adhoc$Site<- factor(biospe_adhoc$Site, levels=c("Baylor Scott and White Health","HealthPartners","Henry Ford Health","Marshfield","Sanford Health","University of Chicago"))

coll_bptl_diff <- biospe_adhoc  %>% group_by(as.character(Connect_ID),Site, Site_location) %>% 
  mutate(any_collection = min(d_143615646_d_926457119, d_232343615_d_926457119, d_299553921_d_926457119, d_376960806_d_926457119, d_454453939_d_926457119, 
                              d_505347689_d_926457119, d_589588440_d_926457119, d_652357376_d_926457119, d_677469051_d_926457119, d_683613884_d_926457119, 
                              d_703954371_d_926457119, d_838567176_d_926457119, d_958646668_d_926457119, d_973670172_d_926457119, na.rm=T),
         day_past = difftime(as.Date(any_collection), as.Date(d_678166505), units="days"),
         coll_days_diff = ifelse(as.numeric(day_past)<2,"1 Day",ifelse(as.numeric(day_past)<3,"2 Days",ifelse(as.numeric(day_past)<4,"3 Days", ifelse(as.numeric(day_past)<5,"4 Days", ">4 Days")))))


coll_bptl_diff$Connect_ID <- as.numeric(coll_bptl_diff$`as.character(Connect_ID)`)
#coll_bptl_diff$Site<- droplevels(coll_bptl_diff$Site)


table.coll_bptl_28a <- ctable(coll_bptl_diff$Site,coll_bptl_diff$coll_days_diff)
crosstable.coll_bptl28a <- as.data.frame(cbind(table.coll_bptl_28a$cross_table,table.coll_bptl_28a$proportions))
crosstable.coll_bptl28a$Site <- list("Baylor Scott and White Health","HealthPartners","Henry Ford Health","Marshfield","Sanford Health","University of Chicago", "Total")

crosstable.coll_bptl28a$n_pct_1_Day <-  paste(format(crosstable.coll_bptl28a[,2],big.mark=","),"(", round(100*crosstable.coll_bptl28a[,8],1),"%)",sep=" ")
crosstable.coll_bptl28a$n_pct_2_Day <-  paste(format(crosstable.coll_bptl28a[,3],big.mark=","),"(", round(100*crosstable.coll_bptl28a[,9],1),"%)",sep=" ")
crosstable.coll_bptl28a$n_pct_3_Day <-  paste(format(crosstable.coll_bptl28a[,4],big.mark=","),"(", round(100*crosstable.coll_bptl28a[,10],1),"%)",sep=" ")
crosstable.coll_bptl28a$n_pct_4_Day <-  paste(format(crosstable.coll_bptl28a[,5],big.mark=","),"(", round(100*crosstable.coll_bptl28a[,11],1),"%)",sep=" ")
crosstable.coll_bptl28a$n_pct_4_plus_days =  paste(format(crosstable.coll_bptl28a[,1],big.mark=","),"(", round(100*crosstable.coll_bptl28a[,7],1),"%)",sep=" ")
crosstable.coll_bptl28a$Total_Pct <- paste(crosstable.coll_bptl28a$Total, " (100%)")



crosstable.coll_bptl28a <- crosstable.coll_bptl28a[,c(13:19)]


```



 
```{r Table28b,include=FALSE, echo=FALSE, warning=FALSE}


table.coll_bptl <- ctable(coll_bptl_diff$Site_location,coll_bptl_diff$coll_days_diff)
crosstable.coll_bptl28 <- as.data.frame(cbind(table.coll_bptl$cross_table,table.coll_bptl$proportions))
crosstable.coll_bptl28$UC_Sites <-trimws(rownames(crosstable.coll_bptl28))
#crosstable.coll_bptl28$UC_Sites<- droplevels(crosstable.coll_bptl28$UC_Sites)

crosstable.coll_bptl28$n_pct_1_Day <-  paste(format(crosstable.coll_bptl28[,2],big.mark=","),"(", round(100*crosstable.coll_bptl28[,8],1),"%)",sep=" ")
crosstable.coll_bptl28$n_pct_2_Day <-  paste(format(crosstable.coll_bptl28[,3],big.mark=","),"(", round(100*crosstable.coll_bptl28[,9],1),"%)",sep=" ")
crosstable.coll_bptl28$n_pct_3_Day <-  paste(format(crosstable.coll_bptl28[,4],big.mark=","),"(", round(100*crosstable.coll_bptl28[,10],1),"%)",sep=" ")
crosstable.coll_bptl28$n_pct_4_Day <-  paste(format(crosstable.coll_bptl28[,5],big.mark=","),"(", round(100*crosstable.coll_bptl28[,11],1),"%)",sep=" ")
crosstable.coll_bptl28$n_pct_4_plus_days =  paste(format(crosstable.coll_bptl28[,1],big.mark=","),"(", round(100*crosstable.coll_bptl28[,7],1),"%)",sep=" ")
crosstable.coll_bptl28$Total <- paste(crosstable.coll_bptl28$Total, " (100%)")
#nrow(crosstable.coll_bptl28)

         
crosstable.coll_bptl28 <- crosstable.coll_bptl28[,c(13:18,6)]






```

```{r Table29a, include=FALSE, echo=FALSE, warning=FALSE}

table2_col_bplt <- recrver1 %>% select(Connect_ID, d_173836415_d_266600170_d_185243482, d_173836415_d_266600170_d_452847912, d_173836415_d_266600170_d_822274939, d_173836415_d_266600170_d_139245758)
table2_col_bplt$Connect_ID <- as.numeric(table2_col_bplt$Connect_ID)
biospe$Connect_ID <- as.numeric(biospe$Connect_ID)
table5.2 <- left_join(biospe, table2_col_bplt, by="Connect_ID")

#table5.2 <- left_join(table1_2_locations, biospe,  by=c("Connect_ID", "Site", "d_410912345", "d_650516960", "d_951355211"))

biospe_adhoc2= table5.2 %>%  filter(d_650516960==664882224 & d_410912345==353358909  & #clinical and finalized collections
                                   #SiteBlLocatBL / SiteUrLocatBL- removing this to include missing location for counts to add up
                                   #(!is.na(d_173836415_d_266600170_d_185243482) | !is.na(d_173836415_d_266600170_d_452847912)) & 
                                   #ClinBloodTmBL/ ClinUrnieTmBL
                                   (!is.na(d_173836415_d_266600170_d_822274939) | !is.na(d_173836415_d_266600170_d_139245758)) &
                                     #BioBPTL_DateRec_v1r0 blood or urine
                                     (!is.na(d_232343615_d_926457119) | !is.na(d_299553921_d_926457119) | !is.na(d_376960806_d_926457119) |
                                        !is.na(d_454453939_d_926457119) | !is.na(d_505347689_d_926457119) | !is.na(d_589588440_d_926457119) |
                                        !is.na(d_652357376_d_926457119) | !is.na(d_677469051_d_926457119) | !is.na(d_683613884_d_926457119) |
                                        !is.na(d_703954371_d_926457119) |!is.na(d_838567176_d_926457119) | !is.na(d_958646668_d_926457119) |
                                        !is.na(d_973670172_d_926457119))) %>%
                     mutate(Site_location = case_when(#d_173836415_d_266600170_d_185243482==1 | d_173836415_d_266600170_d_452847912==1 ~ "NSC",
                       d_827220437=="531629870" & d_173836415_d_266600170_d_185243482==2 | d_173836415_d_266600170_d_452847912==2 ~ "Elk River",
                       d_827220437=="531629870" & d_173836415_d_266600170_d_185243482==3 | d_173836415_d_266600170_d_452847912==3 ~ "Chanhassen",
                       d_173836415_d_266600170_d_185243482==22 | d_173836415_d_266600170_d_452847912==22 |
                         d_173836415_d_266600170_d_185243482==24 | d_173836415_d_266600170_d_452847912==24 |
                         d_173836415_d_266600170_d_185243482==28 | d_173836415_d_266600170_d_452847912==28 |
                         d_173836415_d_266600170_d_185243482==33 | d_173836415_d_266600170_d_452847912==33 |
                         d_173836415_d_266600170_d_185243482==34 | d_173836415_d_266600170_d_452847912==34 |
                         d_173836415_d_266600170_d_185243482==35 | d_173836415_d_266600170_d_452847912==35 |
                         d_173836415_d_266600170_d_185243482==38 | d_173836415_d_266600170_d_452847912==38 |
                         d_173836415_d_266600170_d_185243482==40 | d_173836415_d_266600170_d_452847912==40 |
                         d_173836415_d_266600170_d_185243482==55 | d_173836415_d_266600170_d_452847912==55 |
                         d_173836415_d_266600170_d_185243482==71 | d_173836415_d_266600170_d_452847912==71 ~ "Oahu Clinics",
                       d_173836415_d_266600170_d_185243482==23 | d_173836415_d_266600170_d_452847912==23 |
                         d_173836415_d_266600170_d_185243482==26 | d_173836415_d_266600170_d_452847912==26 |
                         d_173836415_d_266600170_d_185243482==27 | d_173836415_d_266600170_d_452847912==27 |
                         d_173836415_d_266600170_d_185243482==32 | d_173836415_d_266600170_d_452847912==32 |
                         d_173836415_d_266600170_d_185243482==37 | d_173836415_d_266600170_d_452847912==37 |
                         d_173836415_d_266600170_d_185243482==49 | d_173836415_d_266600170_d_452847912==49 |
                         d_173836415_d_266600170_d_185243482==56 | d_173836415_d_266600170_d_452847912==56 |
                         d_173836415_d_266600170_d_185243482==69 | d_173836415_d_266600170_d_452847912==69 |
                         d_173836415_d_266600170_d_185243482==74 | d_173836415_d_266600170_d_452847912==74 |
                         d_173836415_d_266600170_d_185243482==76 | d_173836415_d_266600170_d_452847912==76 ~ "Non-Oahu Clinics",
                       d_173836415_d_266600170_d_185243482==1050010095 | d_173836415_d_266600170_d_452847912==1050010095 ~ "Wyandotte",
                       d_173836415_d_266600170_d_185243482==1060010063 | d_173836415_d_266600170_d_185243482==1060170018 |
                         d_173836415_d_266600170_d_452847912==1060010063 | d_173836415_d_266600170_d_452847912==1060170018~ "Macomb",
                       d_173836415_d_266600170_d_185243482==1040010047 | d_173836415_d_266600170_d_185243482==1040010046 |
                         d_173836415_d_266600170_d_185243482==1011220006 |
                         d_173836415_d_266600170_d_452847912==1040010047 | d_173836415_d_266600170_d_452847912==1040010046 |
                         d_173836415_d_266600170_d_452847912==1011220006 ~ "West Bloomfield",
                       d_173836415_d_266600170_d_185243482==1011410008 | d_173836415_d_266600170_d_452847912==1011410008 ~ "Royal Oak",
                       d_173836415_d_266600170_d_185243482==1010180040 |d_173836415_d_266600170_d_452847912 ==1010180040 ~ "Fairlane (Dearborn)",
                       d_173836415_d_266600170_d_185243482==1010120026 | d_173836415_d_266600170_d_452847912==1010120026 ~ "Columbus",
                       d_173836415_d_266600170_d_185243482==1011660013  | d_173836415_d_266600170_d_452847912==1011660013 ~ "Plymouth",
                       d_173836415_d_266600170_d_185243482==1010360011 | d_173836415_d_266600170_d_452847912==1010360011 ~ "Troy",
                       d_173836415_d_266600170_d_185243482==1010350019 | d_173836415_d_266600170_d_452847912==1010350019 ~ "Taylor",
                       d_173836415_d_266600170_d_185243482==1010240013 | d_173836415_d_266600170_d_452847912==1010240013 ~ "Livonia",
                       d_173836415_d_266600170_d_185243482== 1010200009 |d_173836415_d_266600170_d_452847912 == 1010200009 ~ "Ford Road",
                       d_173836415_d_266600170_d_185243482== 1010270015 |d_173836415_d_266600170_d_452847912 == 1010270015 ~ "NCO",
                       d_173836415_d_266600170_d_185243482==1010320019 | d_173836415_d_266600170_d_452847912==1010320019 ~ "Sterling Heights",
                       d_173836415_d_266600170_d_185243482==1010010193 | d_173836415_d_266600170_d_452847912==1010010114 |
                         d_173836415_d_266600170_d_185243482==1010010193 | d_173836415_d_266600170_d_452847912==1010010193~ "K1 HFH Main",
                      d_173836415_d_266600170_d_185243482==1050020026 | d_173836415_d_266600170_d_452847912==1050020026 ~ "Brownstown",
                      d_827220437=="548392715" & is.na(d_173836415_d_266600170_d_185243482) & is.na(d_173836415_d_266600170_d_452847912) ~ "Missing Location ID",
                      d_827220437=="809703864" & (d_173836415_d_266600170_d_185243482==1 | d_173836415_d_266600170_d_452847912==1) ~ "South Loop",
                      d_827220437=="809703864" & (d_173836415_d_266600170_d_185243482==2 | d_173836415_d_266600170_d_452847912==2) ~ "Orland Park",
                      d_827220437=="809703864" & (d_173836415_d_266600170_d_185243482==3 | d_173836415_d_266600170_d_452847912==3) ~ "Kenwood",
                      d_827220437=="809703864" & (d_173836415_d_266600170_d_185243482==4 | d_173836415_d_266600170_d_452847912==4) ~ "River East",
                      d_827220437=="809703864" & (d_173836415_d_266600170_d_185243482==5 | d_173836415_d_266600170_d_452847912==5) ~ "Dearborn Station",
                                        d_827220437==327912200 ~ "Kaiser Permanente Georgia",
                                        d_827220437==452412599 ~ "Kaiser Permanente Northwest",
                                        d_827220437==125001209 ~ "Kaiser Permanente Colorado",
                       d_827220437==657167265 ~ "Sanford Health",
                       TRUE ~ "Remove"),
                       Site = case_when(#d_827220437==472940358 ~ "Baylor Scott and White Health", #not yet clinical
                                        d_827220437==548392715 ~ "Henry Ford",
                                        d_827220437==531629870 ~ "HealthPartners",
                                        d_827220437==300267574 ~ "Kaiser Permanente Hawaii",
                                        d_827220437==327912200 ~ "Kaiser Permanente Georgia",
                                        d_827220437==452412599 ~ "Kaiser Permanente Northwest",
                                        d_827220437==125001209 ~ "Kaiser Permanente Colorado",
                                        d_827220437==657167265 ~ "Sanford Health",
                                        d_827220437==809703864 ~ "University of Chicago Medicine",
                                        TRUE ~ "Remove"))
biospe_adhoc2 <- biospe_adhoc2 %>%  filter(Site_location!="Remove" & Site!="Remove")


# bptl_clin_time <- biospe %>%  select(Connect_ID,d_232343615_d_926457119,d_299553921_d_926457119,d_376960806_d_926457119,d_454453939_d_926457119,d_505347689_d_926457119,d_589588440_d_926457119,d_652357376_d_926457119,
#                                  d_677469051_d_926457119,d_683613884_d_926457119,d_703954371_d_926457119,d_838567176_d_926457119,d_958646668_d_926457119,d_973670172_d_926457119)
# 
# clin_bpt_1_4days <- left_join(table1_2__locations, bptl_clin_time, by="Connect_ID")
# 
# biospe_adhoc2 <- clin_bpt_1_4days %>%  filter((!is.na(d_232343615_d_926457119) | !is.na(d_299553921_d_926457119) | !is.na(d_376960806_d_926457119) |
#                                  !is.na(d_454453939_d_926457119) | !is.na(d_505347689_d_926457119) | !is.na(d_589588440_d_926457119) | !is.na(d_652357376_d_926457119) |
#                                  !is.na(d_677469051_d_926457119) | !is.na(d_683613884_d_926457119) | !is.na(d_703954371_d_926457119) | !is.na(d_838567176_d_926457119) |
#                                  !is.na(d_958646668_d_926457119) | !is.na(d_973670172_d_926457119))) %>%
#                               mutate(locationID = case_when( d_173836415_d_266600170_d_185243482==22 | d_173836415_d_266600170_d_452847912==22 |
#                                                              d_173836415_d_266600170_d_185243482==24 | d_173836415_d_266600170_d_452847912==24 |
#                                                              d_173836415_d_266600170_d_185243482==28 | d_173836415_d_266600170_d_452847912==28 |
#                                                              d_173836415_d_266600170_d_185243482==33 | d_173836415_d_266600170_d_452847912==33 |
#                                                              d_173836415_d_266600170_d_185243482==34 | d_173836415_d_266600170_d_452847912==34 |
#                                                              d_173836415_d_266600170_d_185243482==35 | d_173836415_d_266600170_d_452847912==35 |
#                                                              d_173836415_d_266600170_d_185243482==38 | d_173836415_d_266600170_d_452847912==38 |
#                                                              d_173836415_d_266600170_d_185243482==40 | d_173836415_d_266600170_d_452847912==40 |
#                                                              d_173836415_d_266600170_d_185243482==55 | d_173836415_d_266600170_d_452847912==55 |
#                                                              d_173836415_d_266600170_d_185243482==71 | d_173836415_d_266600170_d_452847912==71 ~ "Oahu Clinics",
#                                                          d_173836415_d_266600170_d_185243482==23 | d_173836415_d_266600170_d_452847912==23 |
#                                                              d_173836415_d_266600170_d_185243482==26 | d_173836415_d_266600170_d_452847912==26 |
#                                                              d_173836415_d_266600170_d_185243482==27 | d_173836415_d_266600170_d_452847912==27 |
#                                                              d_173836415_d_266600170_d_185243482==32 | d_173836415_d_266600170_d_452847912==32 |
#                                                              d_173836415_d_266600170_d_185243482==37 | d_173836415_d_266600170_d_452847912==37 |
#                                                              d_173836415_d_266600170_d_185243482==49 | d_173836415_d_266600170_d_452847912==49 |
#                                                              d_173836415_d_266600170_d_185243482==56 | d_173836415_d_266600170_d_452847912==56 |
#                                                              d_173836415_d_266600170_d_185243482==69 | d_173836415_d_266600170_d_452847912==69 |
#                                                              d_173836415_d_266600170_d_185243482==74 | d_173836415_d_266600170_d_452847912==74 |
#                                                              d_173836415_d_266600170_d_185243482==76 | d_173836415_d_266600170_d_452847912==76 ~ "Non-Oahu Clinics",
#                                                         Site=="Kaiser Permanente Georgia" ~ "Kaiser Permanente Georgia",
#                                                         Site=="Kaiser Permanente Northwest" ~ "Kaiser Permanente Northwest",
#                                                         Site=="Kaiser Permanente Colorado" ~ "Kaiser Permanente Colorado",
#                                                         Site=="Sanford Health" ~ "Sanford Health",
#                                                          TRUE ~ Site_location))

biospe_adhoc2$Site_location <- factor(biospe_adhoc2$Site_location,levels=c("Macomb", "West Bloomfield", "Wyandotte","Fairlane (Dearborn)", "Plymouth", "Royal Oak", "Troy", "K1 HFH Main","Sterling Heights",
                                                                           "Columbus",  "Livonia","Taylor", "Ford Road", "NCO", "Brownstown", #"Missing Location ID",#"NSC", 
                                                                           "Chanhassen", "Elk River", "Kaiser Permanente Colorado",
                                                                           "Kaiser Permanente Georgia", "Oahu Clinics", "Non-Oahu Clinics", "Kaiser Permanente Northwest", "Sanford Health",
                                                                           "South Loop","Orland Park","Kenwood","River East","Dearborn Station")) 


coll_bptl_diff2 <- biospe_adhoc2  %>% group_by(as.character(Connect_ID),Site, Site_location) %>% 
  mutate(any_collection = min(d_232343615_d_926457119, d_299553921_d_926457119, d_376960806_d_926457119, d_454453939_d_926457119, d_505347689_d_926457119,
                              d_589588440_d_926457119, d_652357376_d_926457119, d_677469051_d_926457119, d_683613884_d_926457119, d_703954371_d_926457119,
                              d_838567176_d_926457119, d_958646668_d_926457119, d_973670172_d_926457119, na.rm=T),
         clin_coll_bu = min(d_173836415_d_266600170_d_822274939, d_173836415_d_266600170_d_139245758, na.rm=T),
         day_past = difftime(as.Date(any_collection), as.Date(clin_coll_bu), units="days"),
         coll_days_diff = ifelse(as.numeric(day_past)<2,"1 Day",ifelse(as.numeric(day_past)<3,"2 Days",ifelse(as.numeric(day_past)<4,"3 Days", ifelse(as.numeric(day_past)<5,"4 Days", ">4 Days")))))
#don't know how this is happening but needs to be included for now
coll_bptl_diff2 <- coll_bptl_diff2 %>% filter(!is.na(coll_days_diff))

coll_bptl_diff2$Connect_ID <- as.numeric(coll_bptl_diff2$`as.character(Connect_ID)`)
#coll_bptl_diff2$Site<- droplevels(coll_bptl_diff2$Site)

crosstable.coll_bptl29a <- ctable(coll_bptl_diff2$Site,coll_bptl_diff2$coll_days_diff)
crosstable.coll_bptl29a <- as.data.frame(cbind(crosstable.coll_bptl29a$cross_table,crosstable.coll_bptl29a$proportions))
#crosstable.coll_bptl29a$UC_Sites <-trimws(rownames(crosstable.coll_bptl29a))
#crosstable.coll_bptl28$UC_Sites<- droplevels(crosstable.coll_bptl28$UC_Sites)
#crosstable.coll_bptl29a <- crosstable.coll_bptl29a[c(1:7),]
crosstable.coll_bptl29a <- crosstable.coll_bptl29a[c(1:(nrow(crosstable.coll_bptl29a)-1)),]
crosstable.coll_bptl29a$Site <- list("HealthPartners", "Henry Ford Health", "Kaiser Permanente Colorado", "Kaiser Permanente Georgia",
                                     "Kaiser Permanente Hawaii", "Kaiser Permanente Northwest", "Sanford Health", "University of Chicago Medicine")

#crosstable.coll_bptl29a <- crosstable.coll_bptl29a %>%  filter9

crosstable.coll_bptl29a$n_pct_1_Day <-  paste(format(crosstable.coll_bptl29a[,2],big.mark=","),"(", round(100*crosstable.coll_bptl29a[,8],1),"%)",sep=" ")
crosstable.coll_bptl29a$n_pct_2_Day <-  paste(format(crosstable.coll_bptl29a[,3],big.mark=","),"(", round(100*crosstable.coll_bptl29a[,9],1),"%)",sep=" ")
crosstable.coll_bptl29a$n_pct_3_Day <-  paste(format(crosstable.coll_bptl29a[,4],big.mark=","),"(", round(100*crosstable.coll_bptl29a[,10],1),"%)",sep=" ")
crosstable.coll_bptl29a$n_pct_4_Day <-  paste(format(crosstable.coll_bptl29a[,5],big.mark=","),"(", round(100*crosstable.coll_bptl29a[,11],1),"%)",sep=" ")
crosstable.coll_bptl29a$n_pct_4_plus_days =  paste(format(crosstable.coll_bptl29a[,1],big.mark=","),"(", round(100*crosstable.coll_bptl29a[,7],1),"%)",sep=" ")
crosstable.coll_bptl29a$Total <- paste(crosstable.coll_bptl29a$Total, " (100%)")
#nrow(crosstable.coll_bptl29a)

         
crosstable.coll_bptl29a <- crosstable.coll_bptl29a[,c(13:18,6)]


crosstable.coll_bptl29a[9,] <- list('Total', sum(as.numeric(gsub(",", "", str_extract(crosstable.coll_bptl29a[,2], "\\b\\d{1,4}(,\\d{3})*(?=\\s*\\()")))),
                                    sum(as.numeric(gsub(",", "", str_extract(crosstable.coll_bptl29a[,3], "\\b\\d{1,4}(,\\d{3})*(?=\\s*\\()")))),
                                    sum(as.numeric(gsub(",", "", str_extract(crosstable.coll_bptl29a[,4], "\\b\\d{1,4}(,\\d{3})*(?=\\s*\\()")))),
                                    sum(as.numeric(gsub(",", "", str_extract(crosstable.coll_bptl29a[,5], "\\b\\d{1,4}(,\\d{3})*(?=\\s*\\()")))),
                                    sum(as.numeric(gsub(",", "", str_extract(crosstable.coll_bptl29a[,6], "\\b\\d{1,4}(,\\d{3})*(?=\\s*\\()")))),
                                    sum(as.numeric(gsub(",", "", str_extract(crosstable.coll_bptl29a[,7], "\\b\\d{1,4}(,\\d{3})*(?=\\s*\\()")))))



crosstable.coll_bptl29a[9,2] <- paste(crosstable.coll_bptl29a[9,2], "(",round(100*as.numeric(crosstable.coll_bptl29a[9,2])/as.numeric(crosstable.coll_bptl29a[9,7]), digits=1), "%)")
crosstable.coll_bptl29a[9,3] <- paste(crosstable.coll_bptl29a[9,3], "(",round(100*as.numeric(crosstable.coll_bptl29a[9,3])/as.numeric(crosstable.coll_bptl29a[9,7]), digits=1), "%)")
crosstable.coll_bptl29a[9,4] <- paste(crosstable.coll_bptl29a[9,4], "(",round(100*as.numeric(crosstable.coll_bptl29a[9,4])/as.numeric(crosstable.coll_bptl29a[9,7]), digits=1), "%)")
crosstable.coll_bptl29a[9,5] <- paste(crosstable.coll_bptl29a[9,5], "(",round(100*as.numeric(crosstable.coll_bptl29a[9,5])/as.numeric(crosstable.coll_bptl29a[9,7]), digits=1), "%)")
crosstable.coll_bptl29a[9,6] <- paste(crosstable.coll_bptl29a[9,6], "(",round(100*as.numeric(crosstable.coll_bptl29a[9,6])/as.numeric(crosstable.coll_bptl29a[9,7]), digits=1), "%)")
crosstable.coll_bptl29a[9,7] <- paste(crosstable.coll_bptl29a[9,7], " (100%)")


```


```{r, Table29b, include=FALSE, echo=FALSE, warning=FALSE}


table.coll_bptl2 <- ctable(coll_bptl_diff2$Site_location,coll_bptl_diff2$coll_days_diff)
crosstable.coll_bptl2 <- as.data.frame(cbind(table.coll_bptl2$cross_table,table.coll_bptl2$proportions))
crosstable.coll_bptl2$location <-trimws(rownames(crosstable.coll_bptl2))


crosstable.coll_bptl2$n_pct_1_Day <-  paste(format(crosstable.coll_bptl2[,2],big.mark=","),"(", round(100*crosstable.coll_bptl2[,8],1),"%)",sep=" ")
crosstable.coll_bptl2$n_pct_2_Day <-  paste(format(crosstable.coll_bptl2[,3],big.mark=","),"(", round(100*crosstable.coll_bptl2[,9],1),"%)",sep=" ")
crosstable.coll_bptl2$n_pct_3_Day <-  paste(format(crosstable.coll_bptl2[,4],big.mark=","),"(", round(100*crosstable.coll_bptl2[,10],1),"%)",sep=" ")
crosstable.coll_bptl2$n_pct_4_Day <-  paste(format(crosstable.coll_bptl2[,5],big.mark=","),"(", round(100*crosstable.coll_bptl2[,11],1),"%)",sep=" ")
crosstable.coll_bptl2$n_pct_4_plus_days =  paste(format(crosstable.coll_bptl2[,1],big.mark=","),"(", round(100*crosstable.coll_bptl2[,7],1),"%)",sep=" ")
crosstable.coll_bptl2$Totals <- paste(crosstable.coll_bptl2$Total, " (100%)")

crosstable.coll_bptl2$Count <- 1:as.numeric(dim(crosstable.coll_bptl2)[[1]])

         
crosstable.coll_bptl_2 <- crosstable.coll_bptl2[,c("location","n_pct_1_Day", "n_pct_2_Day", "n_pct_3_Day", "n_pct_4_Day", "n_pct_4_plus_days", "Totals")]



```


```{r SF_version_Table5.4,eval=TRUE,echo=FALSE,include=FALSE,results='hold'}


biospe$Connect_ID <- as.numeric(biospe$Connect_ID)
table54 <- left_join(table1_4_locations, biospe,  by=c("Connect_ID", "Site")) 

coll_bptl_diff5_4 <- table54  %>% group_by(as.character(Connect_ID),Site_location) %>% #Site, 
    mutate(any_collection = min(d_232343615_d_926457119, d_299553921_d_926457119, d_376960806_d_926457119, d_454453939_d_926457119, d_505347689_d_926457119,
                                d_589588440_d_926457119, d_652357376_d_926457119, d_677469051_d_926457119, d_683613884_d_926457119, d_703954371_d_926457119,
                                d_838567176_d_926457119, d_958646668_d_926457119, d_973670172_d_926457119, na.rm=T),
           clin_coll_bu = min(d_173836415_d_266600170_d_822274939, d_173836415_d_266600170_d_139245758, na.rm=T),
           day_past = difftime(as.Date(any_collection), as.Date(clin_coll_bu), units="days"),
           coll_days_diff = ifelse(as.numeric(day_past)<2,"1 Day",ifelse(as.numeric(day_past)<3,"2 Days",ifelse(as.numeric(day_past)<4,"3 Days", ifelse(as.numeric(day_past)<5,"4 Days", ">4 Days")))))
#don't know how this is happening but needs to be included for now
coll_bptl_diff5_4 <- coll_bptl_diff5_4 %>% filter(!is.na(coll_days_diff))

coll_bptl_diff5_4$Connect_ID <- as.numeric(coll_bptl_diff5_4$`as.character(Connect_ID)`)


crosstable_coll_bptl5_4 <- coll_bptl_diff5_4 %>%
  tbl_cross(
    row = Site_location,
    col = coll_days_diff,
    percent = "row",
        label=list(Site_location="Collection Location",
               Kit_Status = " "))   # This option keeps the row percentages
ct5_4 <- as.data.frame(crosstable_coll_bptl5_4)
ct5_4 <- ct5_4[c(-1),]
colnames(ct5_4)[1] <- "Collection Location"
colnames(ct5_4)[ncol(ct5_4)] <- "Total Recived Clinical Collections"
  



```

```{r Table30, include=FALSE, echo=FALSE, warning=FALSE}

#add one decimal place, even .0 for whole numbers
format_with_decimal <- function(x, digits = 1) {
  formatted_number <- sprintf("%0.1f", x)
  return(formatted_number)
}



coll_bptl_diff <- coll_bptl_diff %>% mutate(hrs_past = difftime(as.POSIXct(ymd_hms(any_collection)), as.POSIXct(ymd_hms(d_678166505)), units="hours"))
coll_bptl_diff$hrs_past <- as.numeric(coll_bptl_diff$hrs_past)
coll_bptl_diff<- coll_bptl_diff %>%  filter(hrs_past>0)
Hrs_bptl_col <- coll_bptl_diff %>% group_by(Site_location) %>% dplyr::summarise('Min' = format_with_decimal(min(hrs_past)),
                                                                                'Q1' = format_with_decimal(quantile(hrs_past, 0.25)),
                                                                                'Median' = format_with_decimal(median(hrs_past)),
                                                                                'Mean' = format_with_decimal(mean(hrs_past)),
                                                                                'Q3' = format_with_decimal(quantile(hrs_past, 0.75)),
                                                                                '90th' = format_with_decimal(quantile(hrs_past, 0.90)),
                                                                                '98th' = format_with_decimal(quantile(hrs_past, 0.98)))
#Hrs_bptl_col <- Hrs_bptl_col[c(5,2:4,7,9,8,10,16,17,12,1,6,11,13,14,15),]


```



```{r Table31, include=FALSE, echo=FALSE, warning=FALSE}

coll_bptl_diff2 <- coll_bptl_diff2 %>% mutate(hrs_past = difftime(as.POSIXct(ymd_hms(any_collection)), as.POSIXct(ymd_hms(clin_coll_bu)), units="hours"))
coll_bptl_diff2$hrs_past <- as.numeric(coll_bptl_diff2$hrs_past)
Hrs_bptl_col4 <- coll_bptl_diff2 %>% group_by(Site_location) %>% dplyr::summarise('Min' = format_with_decimal(min(hrs_past)),
                                                                                'Q1' = format_with_decimal(quantile(hrs_past, 0.25)),
                                                                                'Median' = format_with_decimal(median(hrs_past)),
                                                                                'Mean' = format_with_decimal(mean(hrs_past)),
                                                                                'Q3' = format_with_decimal(quantile(hrs_past, 0.75)),
                                                                                '90' = format_with_decimal(quantile(hrs_past, 0.9)),
                                                                                '98' = format_with_decimal(quantile(hrs_past, 0.98)))


#Hrs_bptl_col4 <- Hrs_bptl_col4[c(8,15,16,2,11,12,14,3,13,1,7,4,5,10,9,6), ]


#coll_bptl_diff$Connect_ID[coll_bptl_diff$hrs_past>quantile(coll_bptl_diff$hrs_past, 0.99)]
#coll_bptl_diff2$Connect_ID[coll_bptl_diff2$hrs_past>quantile(coll_bptl_diff2$hrs_past, 0.99)]


```
 
 
```{r SF_table5_6, include=FALSE, echo=FALSE, warning=FALSE}

coll_bptl_diff5_4 <- coll_bptl_diff5_4 %>% mutate(hrs_past = difftime(as.POSIXct(ymd_hms(any_collection)), as.POSIXct(ymd_hms(clin_coll_bu)), units="hours"))
coll_bptl_diff5_4$hrs_past <- as.numeric(coll_bptl_diff5_4$hrs_past)
Hrs_bptl_colSF4 <- coll_bptl_diff5_4 %>% group_by(Site_location) %>% dplyr::summarise('Min' = format_with_decimal(min(hrs_past)),
                                                                                'Q1' = format_with_decimal(quantile(hrs_past, 0.25)),
                                                                                'Median' = format_with_decimal(median(hrs_past)),
                                                                                'Mean' = format_with_decimal(mean(hrs_past)),
                                                                                'Q3' = format_with_decimal(quantile(hrs_past, 0.75)),
                                                                                '90' = format_with_decimal(quantile(hrs_past, 0.9)),
                                                                                '98' = format_with_decimal(quantile(hrs_past, 0.98)))


```
 
 
\newpage
 
# Baseline Collection Counts 
\vspace{-0.5em}
\FloatBarrier
```{r KnitrTables1, eval=TRUE,echo=FALSE,results='asis'}
options(knitr.table.format = "latex")
options(kableExtra.auto_format = FALSE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 


biospe.t1 %>% kable_styling(latex_options = "scale_down")
```
\FloatBarrier
```{r KnitrTables1.2_1.3, eval=TRUE,echo=FALSE,results='asis'}
options(knitr.table.format = "latex")
options(kableExtra.auto_format = FALSE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 

col_num_1.1_gt #%>% kable_styling(latex_options = "scale_down")
col_num_1.2_gt #%>% kable_styling(latex_options = "scale_down")
```

\FloatBarrier
```{r KnitrTables2_4, eval=TRUE,echo=FALSE,results='asis'}

knitr::kable(final_col_num_1.5[, c(1,2,8,9)], col.names=c("Collection Location", "Total Clinical Collections", "Clinical Collections \n in Past 7 days",  "Clinical Collections \n in Past 30 days"), caption='Table 1.4: Baseline Clinical Biospecimen Collections at Sanford Health by Clinic Location', row.names=FALSE, align=c("l","c"), format.args = list(big.mark = ","), booktabs = TRUE) %>% 
  column_spec(3:4, width = "4cm")

biospe.bld %>% kable_styling(latex_options = "scale_down")


tab5=knitr::kable(allsites_crosstab, col.names=c("Collection Setting","Any Blood Collected", "Urine Collected", "Mouthwash Collected"), caption='Table 1.6: Baseline Collection Setting Among Biospecimen Collections by Specimen Type', row.names=FALSE, align=c("l","c","c","c"), format.args = list(big.mark = ","), booktabs = TRUE)   
add_footnote(tab5, "Note: Blood and urine specimens are not collected in the Home setting, and mouthwash specimens are not collected in the Clinical setting.", notation = "none")
#footnote(tab5, "Note: Some cells are not applicable. Blood and Urine Samples cannot be collected in a Home Setting. Mouthwash cannot be collected in a Clinical Setting.",fixed_small_size=T)

tab5_1=knitr::kable(site_results["Henry Ford Health System"], col.names=c("Collection Setting","Any Blood Collected", "Urine Collected", "Mouthwash Collected"), caption='Table 1.7: Baseline Collection Setting Among Biospecimen Collections by Specimen Type, Henry Ford Health', row.names=FALSE, align=c("l","c","c","c"), format.args = list(big.mark = ","), booktabs = TRUE)   
add_footnote(tab5_1, "Note: Blood and urine specimens are not collected in the Home setting, and mouthwash specimens are not collected in the Clinical setting.", notation = "none")

tab5_2=knitr::kable(site_results["HealthPartners"], col.names=c("Collection Setting","Any Blood Collected", "Urine Collected", "Mouthwash Collected"), caption='Table 1.8: Baseline Collection Setting Among Biospecimen Collections by Specimen Type, HealthPartners', row.names=FALSE, align=c("l","c","c","c"), format.args = list(big.mark = ","), booktabs = TRUE)   
add_footnote(tab5_2, "Note: Blood and urine specimens are not collected in the Home setting, and mouthwash specimens are not collected in the Clinical setting.", notation = "none")


tab5_3=knitr::kable(site_results["Sanford Health"], col.names=c("Collection Setting","Any Blood Collected", "Urine Collected", "Mouthwash Collected"), caption='Table 1.9: Baseline Collection Setting Among Biospecimen Collections by Specimen Type, Sanford Health', row.names=FALSE, align=c("l","c","c","c"), format.args = list(big.mark = ","), booktabs = TRUE)
add_footnote(tab5_3, "Note: Blood and urine specimens are not collected in the Home setting, and mouthwash specimens are not collected in the Clinical setting.", notation = "none")


tab5_4=knitr::kable(site_results["University of Chicago Medicine"], col.names=c("Collection Setting","Any Blood Collected", "Urine Collected", "Mouthwash Collected"), caption='Table 1.10: Baseline Collection Setting Among Biospecimen Collections by Specimen Type, University of Chicago Medicine', row.names=FALSE, align=c("l","c","c","c"), format.args = list(big.mark = ","), booktabs = TRUE)
add_footnote(tab5_4, "Note: Blood and urine specimens are not collected in the Home setting, and mouthwash specimens are not collected in the Clinical setting.", notation = "none")

#Change from 1.8 to 1.9
Bld_urn_cli = knitr::kable(newtable_4, caption='Table 1.11: Baseline- Data System Status Among Clinical Biospecimen Collections by Specimen Type', row.names=FALSE,align=c("l","c","c"), booktabs = TRUE) %>%  kable_styling(latex_options = "hold_position") 
add_footnote(Bld_urn_cli, "Note: Site data may be available up to 48 hours later than Biospecimen Dashboard data. 'Site Data Only' is assumed to be '0 (0%)' when not listed.", notation = "none")
```

\newpage
\newpage
# Baseline Collection Completeness
\vspace{-0.5em}
\FloatBarrier

```{r KnitrTables5, eval=TRUE,echo=FALSE,results='asis'}



knitr::kable(coll_completenessR_totals , caption='Table 2.1: Baseline Research Biospecimen Collection Completeness by Specimen Type', row.names=FALSE,align=c("l","c","c","c","c","c","c"), booktabs = TRUE)  %>% kable_styling(latex_options = "scale_down")


knitr::kable(coll_completenessC_totals , caption='Table 2.2: Baseline Clinical Biospecimen Collection Completeness by Specimen Type', row.names=FALSE,align=c("l","c","c","c","c","c","c","c","c","c"), booktabs = TRUE)  %>% kable_styling(latex_options = "scale_down") 


```






```{r KnitrTables6_7.1,echo=FALSE,error=FALSE,message=FALSE,results='asis'}

knitr::kable(bldcol_research1, col.names=c("Site","All Blood Collected","Partial Blood Collected","No Blood Collected","Total Research Collections"), caption='Table 2.3: Baseline Blood Collection Completeness Among Research Biospecimen Collections', row.names=FALSE, align=c("l","c","c","c","c"), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down")


knitr::kable(bldcol_research_UC1, col.names=c("Collection Location","All Blood Collected","Partial Blood Collected","No Blood Collected","Total Research Collections"), caption='Table 2.4: Baseline Blood Collection Completeness Among Research Collections by Collection Location, University of Chicago Medicine', row.names=FALSE, align=c("l","c","c","c","c"), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down")
```

\FloatBarrier
```{r Figure1, eval=TRUE,echo=FALSE, warning=FALSE}


Inc_bld_UC <- tube_research_UC %>%  select(Connect_ID, UC_Sites, bld.complt)
Inc_bld_UC$Connect_ID <- as.numeric(Inc_bld_UC$Connect_ID)
research.survey$Connect_ID <- as.numeric(research.survey$Connect_ID)
fig1_UC <- left_join(research.survey, Inc_bld_UC, by="Connect_ID")

fig1_UC_inc <- fig1_UC %>%  filter(Site=="University of Chicago Medicine")


help_fig1 <- fig1_UC_inc %>% select(col.Monday.date, bld.complt) %>%  # %>%  filter(bld.complt=="BloodIncomplet" | bld.complt=="NoBlood")
  mutate(#incomp_blood = case_when(bld.complt=="BloodIncomplet"~"Partial Blood",
                                   #bld.complt=="NoBlood" ~"No Blood"))
    partial_blood= case_when(bld.complt=="BloodIncomplet"~1,
                             TRUE ~0),
          no_blood=case_when(bld.complt=="NoBlood"~1,
                       TRUE ~0))




help_fig1 <- help_fig1 %>% mutate(all_blood=case_when(!is.na(partial_blood) & !is.na(no_blood) ~ 1, TRUE ~ 0)) #all participants per week
  #all_blood=case_when(incomp_blood=="Partial Blood" | incomp_blood=="No Blood" ~1,TRUE ~ 0))
  

help2_1_fig1 <- help_fig1 %>%  group_by(col.Monday.date,  partial_blood, no_blood, all_blood) #%>%  tally() 

help2_1_fig1 <- help2_1_fig1 %>%  mutate(incomp_blood = case_when( (partial_blood==1 |no_blood==1) ~1,
                                                                  TRUE ~ 0))

help2_1_fig1_inc <- help2_1_fig1 %>%  select(col.Monday.date,  partial_blood, no_blood, all_blood, incomp_blood) %>%  group_by(col.Monday.date)


final_fig1_table <- help2_1_fig1_inc %>%  group_by(col.Monday.date) %>%  dplyr::summarize( incomplete=sum(incomp_blood),
                                                                                           partial=sum(partial_blood), 
                                                                                           none_blood=sum(no_blood), 
                                                                                           all_collections=sum(all_blood),  
                                                                                           All_Incomplete=100*(incomplete/all_collections),
                                                                                           Partial__Blood=100*(partial/all_collections),  
                                                                                           No__Blood=100*(none_blood/all_collections))


research.1_1 <- ggplot() +
  geom_line(data = final_fig1_table, aes(x = as.Date(col.Monday.date), y = All_Incomplete, color = "All_Incomplete"), na.rm = TRUE) + 
  geom_line(data = final_fig1_table, aes(x = as.Date(col.Monday.date), y = Partial__Blood, color = "Partial__Blood"), na.rm = TRUE) + 
  geom_line(data = final_fig1_table, aes(x = as.Date(col.Monday.date), y = No__Blood, color = "No__Blood"), na.rm = TRUE) + 
  geom_point(width = 0.2) +
   scale_y_continuous(name = "Percent %", limits = c(0, 100), expand = c(0, 0), breaks = seq(0, 100, 25)) +  
  scale_x_date(name = "Date", date_labels = "%y-%m-%d", date_breaks = "2 weeks", 
               limits = c(as.Date("2022-06-20"), (as.Date(currentDate) - 1)), expand = c(0, 0))  +
  scale_color_manual(name = "Incompletion Level",
                     values = c("All_Incomplete" = "#FDBE19", "No__Blood" = "#3C989E", "Partial__Blood" = "#164C71"),
                     labels = c("Total","No Blood",  "Partial Blood"),
                     guide = guide_legend(nrow = 2, byrow = TRUE)) +
  ggtitle(label = "Figure 2.1: Baseline- Weekly Percent of Incomplete Blood Collections, \n University of Chicago Medicine") +
  theme(panel.background = element_blank(),
        legend.position = "bottom",
        axis.line = element_line(size = 0.2),
        axis.text.x = element_text(angle = 60, hjust = 1), 
        axis.title.x = element_text(size = 14, face = "bold"), 
        axis.title.y = element_text(size = 14, face = "bold", color = "black"),
        plot.title = element_text(hjust = 0.5, size = 12, face = "bold")) +
  labs(caption = "Note: NCI notified UChicago of incomplete blood draws on January 26, 2023.") +
  theme(plot.caption = element_text(hjust = 0))

research.1_1
```

```{r KnitrTables2.5,echo=FALSE,error=FALSE,message=FALSE,results='asis'}


knitr::kable(bldcol_research_HF1, col.names=c("Collection Location","All Blood Collected","Partial Blood Collected","No Blood Collected","Total Research Collections"), caption='Table 2.5: Baseline Blood Collection Completeness Among Research Collections \n by Collection Location, Henry Ford Health', row.names=FALSE, align=c("l","c","c","c","c"), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down")
```

\FloatBarrier
```{r Figure2, eval=TRUE,echo=FALSE, warning=FALSE}


Inc_bld_HF <- tube_research_HF %>%  select(Connect_ID, HF_Sites, bld.complt)
Inc_bld_HF$Connect_ID <- as.numeric(Inc_bld_HF$Connect_ID)
research.survey$Connect_ID <- as.numeric(research.survey$Connect_ID)
fig2_HF <- left_join(research.survey, Inc_bld_HF, by="Connect_ID")

 fig2_HF_inc <- fig2_HF %>%  filter(Site=="Henry Ford Health System")


help_fig2 <- fig2_HF_inc %>% select(col.Monday.date, bld.complt) %>%  # %>%  filter(bld.complt=="BloodIncomplet" | bld.complt=="NoBlood")
  mutate(#incomp_blood = case_when(bld.complt=="BloodIncomplet"~"Partial Blood",
                                  #bld.complt=="NoBlood" ~"No Blood"))
    partial_blood= case_when(bld.complt=="BloodIncomplet"~1,
                             TRUE ~0),
          no_blood=case_when(bld.complt=="NoBlood"~1,
                       TRUE ~0))


help_fig2 <- help_fig2 %>% mutate(all_blood=case_when(!is.na(partial_blood) & !is.na(no_blood) ~ 1, TRUE ~ 0)) #all participants per week
  

help2_1_fig2 <- help_fig2 %>%  group_by(col.Monday.date,  partial_blood, no_blood, all_blood) #%>%  tally() 

help2_1_fig2 <- help2_1_fig2 %>%  mutate(incomp_blood = case_when( (partial_blood==1 |no_blood==1) ~1,
                                                                  TRUE ~ 0))

help2_1_fig2_inc <- help2_1_fig2 %>%  select(col.Monday.date,  partial_blood, no_blood, all_blood, incomp_blood) %>%  group_by(col.Monday.date)

final_fig2_table <- help2_1_fig2_inc %>%  group_by(col.Monday.date) %>% dplyr::summarize( incomplete=sum(incomp_blood),
                                                                                          partial=sum(partial_blood), 
                                                                                          none_blood=sum(no_blood), 
                                                                                          all_collections=sum(all_blood),  
                                                                                          All_Incomplete=100*(incomplete/all_collections),
                                                                                          Partial__Blood=100*(partial/all_collections),  
                                                                                          No__Blood=100*(none_blood/all_collections))

research.1_2 <- ggplot() + #, color=UC_Sites) + #,fill=Site, color=Site)) +
  geom_line(data=final_fig2_table, aes(x=as.Date(col.Monday.date), y=All_Incomplete, colour="All_Incomplete"),na.rm=T) +
  geom_line(data=final_fig2_table, aes(x=as.Date(col.Monday.date), y=Partial__Blood, colour="Partial__Blood"), na.rm=T) +
  geom_line(data=final_fig2_table, aes(x=as.Date(col.Monday.date), y=No__Blood, colour="No__Blood"), na.rm=T) +
  geom_point(width = 0.2) +
  scale_y_continuous(name="Percent %", limits=c(0,100),expand = c(0, 0), breaks=seq(0,100,25)) +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-1) ,expand=c(0,0))  +
  scale_color_manual(name = "Incompletion Level",
                   values = c("All_Incomplete" = "#FDBE19", "No__Blood" = "#3C989E", "Partial__Blood" = "#164C71"),
                   labels = c("Total","No Blood",  "Partial Blood"),
                   guide = guide_legend(nrow = 2, byrow = TRUE)) +
  ggtitle(label="Figure 2.2: Baseline- Weekly Percent of Incomplete Blood Collections, \n Henry Ford Health System") +
  labs(color = "Incompletion Level") +
  theme(panel.background = element_blank(),
        #legend.title = element_text(size=7),
        legend.position="bottom",
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14, face = "bold") ,
        axis.title.y = element_text(size = 14, face = "bold",color="black"),
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +
  labs(caption = "Note: NCI notified Henry Ford of incomplete blood draws on April 19, 2023.") +
  theme(plot.caption = element_text(hjust=0)) + 
  guides(fill=guide_legend(nrow=2,byrow=TRUE))

research.1_2


```



```{r KnitrTables7.3_11,echo=FALSE,error=FALSE,message=FALSE,results='asis'}

knitr::kable(clin_bldcnt_HF2, col.names=c("Clinic Location","All Blood Collected","Partial Blood Collected","No Blood Collected","Total Clinical Collections"), caption='Table 2.6: Baseline Blood Collection Completeness Among Clinical Collections \n by Clinic Location, \n Henry Ford Health', row.names=FALSE, align=c("l","c","c","c"), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down") #"No Blood Tubes Collected",

tab2_7= knitr::kable(research.coltube_totals, caption='Table 2.7: Baseline- Total Blood Tubes Collected Among Research Collections', row.names=FALSE,align=c("l","c","c","c","c","c","c","c","c","c", "c"), booktabs = TRUE) %>%  add_indent(seq(1, nrow(research.coltube_totals) - 1))  %>% kable_styling(latex_options = "scale_down")
add_footnote(tab2_7, "Note: Research collections are expected to have a total of 5 blood tubes collected.", notation = "none") 

tab2_8= knitr::kable(Research_blood_totals, caption='Table 2.8: Baseline Blood Tubes Collected Among Research Collections by Tube Type', row.names=FALSE,align=c("l","c","c","c","c","c","c","c","c","c", "c"), booktabs = TRUE) %>%  add_indent(seq(1, nrow(Research_blood_totals) - 1))  %>% kable_styling(latex_options = "scale_down")
add_footnote(tab2_8, "Note: Research collections are expected to include 2 SSTs, 1 Heparin, 1 EDTA, and either 1 ACD or 1 STRECK.", notation = "none") 




tab10_2= knitr::kable(tube_completeness_totals, caption='Table 2.9: Baseline- Total Blood Tubes Collected Among Clinical Biospecimen Collections', row.names=FALSE,align=c("l","c","c","c","c","c","c","c","c","c", "c"), booktabs = TRUE) %>%  add_indent(seq(1, nrow(tube_completeness_totals) - 1))  %>% kable_styling(latex_options = "scale_down")
add_footnote(tab10_2, "Note: The expected total blood collection tubes vary by site and are as follows: KPHI-9, KPGA-7, KPNW-9, KPCO-8, HFH-5, HP-5, SFH-9, UChicago- 4", notation = "none") 


tab8=knitr::kable(notcol_combo2_totals,caption='Table 2.10: Baseline Blood Tubes Collected Among Clinical Biospecimen Collections by Tube Type', row.names=FALSE,align=c("l","c","c","c","c","c","c","c","c","c","c"), booktabs = TRUE) %>%  kable_styling(latex_options = "scale_down", full_width = FALSE)   %>% column_spec(column = 2:ncol(notcol_combo2_totals),width = "4cm")  %>% column_spec(column = 1:ncol(notcol_combo2_totals),width = "5cm") %>%  landscape()
add_footnote(tab8, "Note: The expected collected tube type varies by site and is as follows: (1)KPCO: 4 SST, 2 Heparin, 2 EDTA. (2)KPGA: 4 SST, 1 Heparin, 2 EDTA. (3)KPHI: 4 SST, 2 Heparin, 3 EDTA. (4)KPNW: 5 SST, 2 Heparin, 2 EDTA. (5)HFH: 2 SST, 1 Heparin, 1 EDTA, 1 ACD. (6) HP: 2 SST, 1 Heparin, 1 EDTA, 1 STRECK. (7) SFH: 4 SST, 2 Heparin, 3 EDTA. (8) UChicago- 2 SST, 1 Heparin, 1 EDTA", notation = "none") 



knitr::kable(Deviation_Freq[,c(7,5,6,4)],col.names=c("Site","Any Deviations","No Deviations", "Total Tubes Collected"), caption='Table 2.11: Baseline- Deviation Status Among Biospecimen Tubes Collected',row.names=FALSE, align=c("l","c","c","c"), booktabs = TRUE )
```


```{r KnitrTables13,echo=FALSE,error=FALSE,message=FALSE,results='asis'}


tabe2_12 <- knitr::kable(research.notcolnotes_site_totals,  caption='Table 2.12: Baseline- Reason Not Collected Among Research Collection Tubes Not Collected', row.names=FALSE,align=c("l","c","c","c","c","c","c", "c"), booktabs = TRUE) %>%  
  add_indent(seq(1, nrow(research.notcolnotes_site_totals) - 1)) %>% kable_styling(latex_options = "scale_down")
add_footnote(tabe2_12,"Note: The 'Short Draw' is applicable to blood collection tubes only.", notation="none")

tubes2_12 <- knitr::kable(research.notcolnotes_tube_totals,  caption='Table 2.13: Baseline- Reason Not Collected Among Research Collection Tubes Not Collected by Tube Type', row.names=FALSE,align=c("l","c","c","c","c","c","c", "c"), booktabs = TRUE)  %>%  
  add_indent(seq(1, nrow(research.notcolnotes_tube_totals) - 1))  %>% kable_styling(latex_options = "scale_down")
add_footnote(tubes2_12, "Note: 'Short Draw' reason applicable to blood collection tubes only.", notation="none")


knitr::kable(discard.site, caption='Table 2.14: Baseline- Discarded Tubes Among Biospecimen Collections by Tube Type', row.names=FALSE,  col.names=c("Site",  "SST 1", "SST 2", "SST 5", "Heparin 1", "Heparin 2", "EDTA 1, 2, or 3", "ACD", "Urine", "Total Discarded Tubes"), align=c("l","c","c","c","c","c","c","c","c"), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down")
#col.names=c("Site",  "SS Tube1", "SS Tube2", "SS Tube5", "Heparin Tubes", "EDTA Tubes", "ACD Tubes", "Urine Tubes", "Total Tubes"), align=c("l","c","c","c","c","c","c","c","c"),
```

\newpage
\newpage
\FloatBarrier
# Baseline Biospecimen Survey
\vspace{-0.5em}
\FloatBarrier
```{r KnitrTables14,echo=FALSE,error=FALSE,message=FALSE,results='asis'}


knitr::kable(Table15_combined_totals,  caption='Table 3.1: Baseline Biospecimen Survey Status Among Research Collections', row.names=FALSE,align=c("l","c","c","c","c","c","c"), booktabs = TRUE)  %>% kable_styling(latex_options = "scale_down")

```




\FloatBarrier
```{r Figure3, echo=FALSE, eval=TRUE, warning=FALSE}



fig3_sub <- research.survey %>%  filter(Site=="University of Chicago Medicine")
fig3_sub <- fig3_sub %>%  filter(!is.na(research.sv)) 

fig3_sub$Site<- droplevels(fig3_sub$Site)

figsub3 <- fig3_sub %>% arrange(col.Monday.date,research.sv) %>% group_by(col.Monday.date,research.sv) %>% tally()

figsub3_2 <- figsub3 %>% group_by(col.Monday.date) %>% mutate(per_week_parts=sum(n))

#New version of Figure 3
figsub3_3 <- figsub3_2 %>% group_by(col.Monday.date) %>% filter(research.sv=="Submitted") %>%  mutate(weekly_sub=n)

figsub3_4 <- figsub3_3 %>% group_by(col.Monday.date) %>%  filter(research.sv=="Submitted") %>%  select(col.Monday.date,research.sv,weekly_sub, per_week_parts)

figsub3_5 <-figsub3_4 %>% ungroup() %>% mutate(cum_sub= cumsum(weekly_sub),
                                 cumtotal= cumsum(per_week_parts))


figsub3_6 <- figsub3_5 %>%  mutate(percent_3= 100*(cum_sub/cumtotal))


ggplot(figsub3_5, aes(x=as.Date(col.Monday.date), y=100*(cum_sub/cumtotal))) + 
  geom_line(na.rm=T) + geom_point(width = 0.2) +
  scale_y_continuous(name="Percent %",limits=c(0,100),expand=c(0,0)) + #, limits=c(0,30), breaks=seq(0,30,5)) +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-1),expand=c(0,0))  +
  scale_fill_brewer(palette="Dark2") +
  ggtitle(label="Figure 3.1: Baseline- Cumulative Percent of Biospecimen Surveys \n Submitted, University of Chicago Medicine") +
  theme(panel.background = element_blank(),
        #legend.title = element_text(size=7),
        #legend.position="right",
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14, face = "bold") ,
        axis.title.y = element_text(size = 14, face = "bold",color="black"),
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) + 
  theme(plot.caption = element_text(hjust=0))

```

\newpage
\FloatBarrier
```{r Figure3.1, echo=FALSE, eval=TRUE, warning=FALSE}
#Comparative Figure 3 of weekly not cummulative

ggplot(figsub3_5, aes(x=as.Date(col.Monday.date), y=100*(weekly_sub/per_week_parts))) + 
  geom_line(na.rm=T) + geom_point(width = 0.2) +
  scale_y_continuous(name="Percent %",limits=c(0,100),expand=c(0,0)) + 
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-1),expand=c(0,0))  +
  scale_fill_brewer(palette="Dark2") +
  ggtitle(label="Figure 3.2: Baseline- Weekly Percent of Biospecimen Surveys Submitted, \n University of Chicago Medicine") +
  theme(panel.background = element_blank(),
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14, face = "bold") ,
        axis.title.y = element_text(size = 14, face = "bold",color="black"),
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) + 
  theme(plot.caption = element_text(hjust=0))


```



```{r KnitrTables15_16,echo=FALSE,error=FALSE,message=FALSE,results='asis'}

knitr::kable(Table16_combined_totals, caption='Table 3.2: Baseline Biospecimen Survey Status Among Clinical Collections', row.names=FALSE,align=c("l","c","c","c","c","c","c","c","c"), booktabs = TRUE)  %>% kable_styling(latex_options = "scale_down")


tbl19a <-knitr::kable(Table17_combinedB_totals, caption='Table 3.3: Baseline Biospecimen Survey Completion Time from Research Collection Visit Check In \n (Pre-COVID- 19 Questions Removal)', row.names=FALSE,align=c("l","c","c","c","c","c","c"), booktabs = TRUE)  %>% kable_styling(latex_options = "scale_down")
add_footnote(tbl19a,"Note: The COVID-19 survey questions were separated from the Biospecimen Survey on July 5, 2023.", notation = "none") 
tbl19b <- knitr::kable(Table17_combinedA_totals, caption='Table 3.4: Baseline Biospecimen Survey Completion Time from Research Collection Visit Check In \n (Post- COVID-19 Questions Removal)', row.names=FALSE,align=c("l","c","c","c","c","c","c"), booktabs = TRUE)  %>% kable_styling(latex_options = "scale_down")
add_footnote(tbl19b,"Note: The COVID-19 survey questions were separated from the Biospecimen Survey on July 5, 2023.", notation = "none") 
```



\newpage
\FloatBarrier

```{r Figures1_3, echo=FALSE, eval=TRUE}

research.4_1
research.4_2
research.4_3

```

\newpage
\FloatBarrier
```{r KnitrTables17_20,echo=FALSE,error=FALSE,message=FALSE,results='asis'}

knitr::kable(Table18_combined_totals, caption='Table 3.5: Baseline Biospecimen Survey Completion Time from Clinical Collection Dashboard Entry', row.names=FALSE,align=c("l","c","c","c","c","c","c","c","c"), booktabs = TRUE)  %>% kable_styling(latex_options = "scale_down")



tab21_rb=knitr::kable(Table21R_Before,caption='Table 3.6: Baseline Biospecimen Survey Completion Length (in Minutes) Among Submitted \n Research Surveys (Pre-COVID-19 Questions Removal)',row.names=FALSE, align=c("l","c","c","c","c","c","c","c","c","c","c","c"),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "scale_down")
add_footnote(tab21_rb,"Note: The COVID-19 survey questions were separated from the Biospecimen Survey on July 5, 2023. Research biospecimen surveys with a negative completion time have been excluded.",notation = "none")

tab21_ra=knitr::kable(Table21R_After,caption='Table 3.7: Baseline Biospecimen Survey Completion Length (in Minutes) Among Submitted \n Research Surveys (Post-COVID-19 Questions Removal)',row.names=FALSE, align=c("l","c","c","c","c","c","c","c","c","c","c","c"),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "scale_down")
add_footnote(tab21_ra,"Note: The COVID-19 survey questions were separated from the Biospecimen Survey on July 5, 2023. ", notation = "none")


tab21_cb=knitr::kable(ClinSrvy_Lgth_Before,caption='Table 3.8: Baseline Biospecimen Survey Completion Length (in Minutes) Among Submitted Clinical Surveys \n (Pre-COVID-19 Questions Removal)',row.names=FALSE, align=c("l","c","c","c","c","c","c","c","c","c","c"),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "scale_down")
add_footnote(tab21_cb,"Note: The COVID-19 survey questions were separated from the Biospecimen Survey on July 5, 2023.", notation = "none")

tab21_ca=knitr::kable(ClinSrvy_Lgth_After,caption='Table 3.9: Baseline Biospecimen Survey Completion Length (in Minutes) Among Submitted Clinical Surveys \n (Post-COVID-19 Questions Removal)',row.names=FALSE, align=c("l","c","c","c","c","c","c","c","c","c","c"),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "scale_down")
add_footnote(tab21_ca,"Note: The COVID-19 survey questions were separated from the Biospecimen Survey on July 5, 2023.", notation = "none")
```


\newpage
\FloatBarrier
# Baseline Collection Activity Durations
\vspace{-0.5em}
\FloatBarrier
```{r KnitrTables20,echo=FALSE,error=FALSE,message=FALSE,results='asis'}
tab23=knitr::kable(research.vt.length.table,caption='Table 4.1: Baseline Research Collection Visit Length (in Minutes)',row.names=FALSE, align=c("l","c","c","c","c","c","c","c","c","c"),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "scale_down") #%>% landscape()
add_footnote(tab23,"Note: Expected visit length for each site is as follows: (1) HealthPartners: 25-60 minutes, (2) Henry Ford: 25-60 minutes, (3) Sanford: 10-45 minutes, (4) Marshfield: 10-45 minutes, and (5) UChicago:15-180 minutes  ", notation = "none") #and greater than 500 minutes 

uc_col_time <- knitr::kable(research.vt.length.UC.table,caption='Table 4.2: Baseline Research Collection Visit Length (in Minutes) by Collection Location, University of Chicago Medicine', col.names=c('Collection Location', 'Number of Research Collection Visits',"Min","Q1","Median","Mean","Q3" ,"Perc.90","Perc.95","Perc.98","Max"), row.names=FALSE, align=c("l","c","c","c","c","c","c","c","c","c"),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "scale_down") #%>% landscape()
add_footnote(uc_col_time,"Note: Visit legnths at or above the 95th percentile and above are likely the result of delayed participant visit check-out and do not reflect accurate visit lentghs", notation = "none") 



```
\FloatBarrier
```{r newFig5, eval=TRUE,echo=FALSE}

UC_Time_plot <- research.vt.length.UC %>%  group_by(col.Monday.date, Site_location) %>% tally(mean(time))


UC_Time <- ggplot(UC_Time_plot, aes(x=as.Date(col.Monday.date), y=n, color=Site_location)) + #,fill=Site, color=Site)) +
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="Average Number of Minutes",limits=c(0,300)) +
scale_color_manual(values=c("Ingalls Harvey"="#B1C7D9", "Orland Park"="#2973A5", "River East"="#FDBE19", 
                              "South Loop"="#565C65", "UC-DCAM"="#3C989E", "UCM Pop-Up"="#CC7D15")) +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),(as.Date(currentDate)-1)),expand=c(0,0)) +
  ggtitle(label="Figure 4.1 Baseline- Weekly Average Research Collection Visit Length (in Minutes) \n by Collection Location, University of Chicago Medicine") +
  labs(color = "Collection Location") +
  theme(panel.background = element_blank(),
        legend.title = element_text(size=8),
        legend.position="bottom",
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14, face = "bold") ,
        axis.title.y = element_text(size = 14, face = "bold",color="black"),
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +
  guides(fill=guide_legend(nrow=2,byrow=TRUE))+
  labs(caption = "Note: Visit lengths greater than 300 minutes (5 hours) have been excluded, as they are likely the result of delayed \n
participant visit checkout.") +
  theme(plot.caption = element_text(hjust=0))


UC_Time



```


```{r KnitrTable21_26,echo=FALSE,error=FALSE,message=FALSE,results='asis'}

tabbA <- knitr::kable(verif_BSL_colctC,caption='Table 4.3: Baseline- Time (in Days) from Verification to Research Collection Among Participants Verified Before 8/01/2022',row.names=FALSE, align=c("l","c","c","c","c","c","c","c"),digits=1, booktabs = TRUE) %>% kable_styling(latex_options = "scale_down")
add_footnote(tabbA,"Note: August 2022 marks when research collection appointments were routinely offered to all new recruits at or near the time of verification. UChicago participant verification largely occurs at or near time of collection.", notation = "none")

tabbB <- knitr::kable(verif_BSL_colctD,caption='Table 4.4: Baseline- Time (in Days) from Verification to Research Collection Among Participants Verified on or After 8/01/2022',row.names=FALSE, align=c("l","c","c","c","c","c","c","c"),digits=1, booktabs = TRUE)  %>% kable_styling(latex_options = "scale_down")
add_footnote(tabbB,"Note: August 2022 marks when research collection appointments were routinely offered to all new recruits at or near the time of verification. UChicago participant verification largely occurs at or near the time of collection.", notation = "none")



BSL_A <- knitr::kable(verif_BSL_colctA,caption='Table 4.5: Baseline- Time (in Days) from Verification to Clinical Collection Among Participants Verified Before 2/01/2023',row.names=FALSE, align=c("l","c","c","c","c","c","c","c"),digits=1, booktabs = TRUE)  %>%  kable_styling(latex_options = "scale_down")
add_footnote(BSL_A,"Note: Baseline Clinical Collections were launched in February 2023.", notation = "none")

BSL_B <-knitr::kable(verif_BSL_colctB,caption='Table 4.6: Baseline- Time (in Days) from Verification to Clinical Collection Among Participants Verified on or After 2/01/2023',row.names=FALSE,  align=c("l","c","c","c","c","c","c","c"),digits=1, booktabs = TRUE)  %>%  kable_styling(latex_options = "scale_down")
add_footnote(BSL_B,"Note: Baseline Clinical Collections were launched in February 2023.", notation = "none")



AF26 <- knitr::kable(verif_baseline_Af,caption = 'Table 4.7: Baseline- Time (in Days) from Verification to Collection Among Participants Verified on or After 6/01/2022 by Campaign Type',row.names=FALSE, booktabs = T, linesep = "", format.args = list(big.mark = ","), align = c("l", "c", "c","c", "c", "c", "c", "c", "c", "c", "c","c", "c","c"), col.names=c("Site",  'Number of Collections',"Min", "Median", "Mean", "SD", "Max", 'Number of Collections', "Min", "Median", "Mean", "SD", "Max","Total Baseline Collections") ) %>% kable_styling(latex_options = "scale_down") %>% 
  add_indent(seq(1, nrow(verif_baseline_Af))) %>% add_header_above(c(" " = 1, "Upcoming Appointment" = 6, "All Other Campaigns" = 6,  " "=1)) %>% landscape() 
add_footnote(AF26, "Note: Upcoming Appointment includes Screening appointment and Non-screening appointment campaign types. All Other Campaigns include Random, Demographic Group, Aging out of study, Geographic group, Post-Screening Selection, Technology adapters, Low-income/health professional shortage areas, and Other campaign types.", notation = "none")


tabl27 <- knitr::kable(verif_draw_order,caption='Table 4.8: Baseline- Time (in Days) from Verification to Draw Order Placement',row.names=FALSE, align=c("l","c","c","c","c","c","c","c"),digits=1, booktabs = TRUE)  %>% kable_styling(latex_options = "scale_down")

add_footnote(tabl27, "Note: Time from verification to draw order placement calculated for participants verified on or after February 1, 2023. HealthPartners, University of Chicago Medicine and Sanford Health are exluded due to the limited availability of draw order placement data.", notation="none")


tab4_9 <- knitr::kable(avg_draw_order, caption='Table 4.9: Baseline- Time (in Days) from Draw Order Placement to Clinical Collection', row.names=FALSE, align=c("l","c","c","c","c","c","c","c","c","c","c","c","c"),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "scale_down") #%>% landscape()
add_footnote(tab4_9, "Note: HealthPartners, University of Chicago Medicine and Sanford Health are exluded due to the limited availability of draw order placement data.", notation="none")

tab4_10 <- knitr::kable(avg_bldorder_present, caption='Table 4.10: Baseline- Time (in Days) from Draw Order Placement to Present Date by Site', row.names=FALSE, align=c("l","c","c","c","c","c","c","c","c","c","c","c","c"),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "scale_down") #%>% landscape()
add_footnote(tab4_10, "Note: Table includes information for Kaiser sites only, other clinical collection sites are excluded.", notation="none")

add_footnote(Table_bld_draw , "Note: Table includes information for Kaiser sites only, other clinical collection sites are excluded.", notation="none")

coll_bplt_knitr <- knitr::kable(crosstable.coll_bptl1, col.names=c("Site", "< 30 Days", "30 to <60 Days","60 to <90 Days", "90 to <180 Days", "180 to <270 Days", "270 Days or More", "Total Participants with No Basline Collections"), caption='Table 4.12: Baseline- Time (in Days) Since Verification Among Participants with No Biospecimen Collection ', row.names=FALSE, align=c("l","c","c","c","c","c","c","c"), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down") 
coll_bplt_knitr

```


\newpage
\newpage
\FloatBarrier
# Baseline Collection-To-Receipt Times
\vspace{-0.5em}
\FloatBarrier
```{r KnitrTable28_30,echo=FALSE,error=FALSE,message=FALSE,results='asis'}

knitr::kable(crosstable.coll_bptl28a, col.names=c("Site", "1 Day", "2 Days", "3 Days", "4 Day", ">4 Days", "Total Received Research Collections"), caption='Table 5.1: Baseline Collection-To-Receipt Time (in Days) Among Research Collections', row.names=FALSE, align=c("l","c","c","c","c","c"), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down")

needle5_2 <- knitr::kable(crosstable.coll_bptl28, col.names=c("Collection Location", "1 Day", "2 Days", "3 Days", "4 Day", ">4 Days", "Total Received Research Collections"), caption='Table 5.2: Baseline Collection-To-Receipt Time (in Days) Among Research Collections by Collection Location', row.names=FALSE, align=c("l","c","c","c","c","c"), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down") 

needle5_2 <- group_rows(
  needle5_2,
  group_label = "Baylor Scott and White Health",
  start_row = 1,
  end_row = 2) 
needle5_2 <- group_rows(
  needle5_2,
  group_label = "HealthPartners",
  start_row = 3,
  end_row = 3)  
needle5_2 <- group_rows(
  needle5_2,
  group_label = "Henry Ford Health",
  start_row = 4,
  end_row = 7) 
needle5_2 <- group_rows(
  needle5_2,
  group_label = "Marshfield",
  start_row = 8,
  end_row = 16) 
needle5_2 <- group_rows(
  needle5_2,
  group_label = "Sanford Health",
  start_row = 17,
  end_row = 18)
needle5_2 <- group_rows(
  needle5_2,
  group_label = "University of Chicago",
  start_row = 19,
  end_row = 24)

needle5_2



knitr::kable(crosstable.coll_bptl29a, col.names=c("Site", "1 Day", "2 Days", "3 Days", "4 Days", ">4 Days", "Total Received Clinical Collections"), caption='Table 5.3: Baseline Collection-To-Receipt Time (in Days) Among Clinical Collections', row.names=FALSE, align=c("l","c","c","c","c","c","c"), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down") 


coll_bplt_knitr2 <- knitr::kable(crosstable.coll_bptl_2, col.names=c("Collection Location", "1 Day", "2 Days", "3 Days", "4 Days", ">4 Days", "Total Recived Clinical Collections"), caption='Table 5.4: Baseline Collection-To-Receipt Time (in Days) Among Clinical Collections by Clinic Location', row.names=FALSE, align=c("l","c","c","c","c","c","c"), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down") 

# coll_bplt_knitr2 <- group_rows(
#   coll_bplt_knitr2,
#   group_label = "Henry Ford Health",
#   start_row = 1,
#   end_row = 15)
# coll_bplt_knitr2 <- group_rows(
#   coll_bplt_knitr2,
#   group_label = "HealthPartners",
#   start_row = 16,
#   end_row = 17)
# coll_bplt_knitr2 <- group_rows(
#   coll_bplt_knitr2,
#   group_label = "Kaiser Permanente Colorado",
#   start_row = 18,
#   end_row = 18) 
# coll_bplt_knitr2 <- group_rows(
#   coll_bplt_knitr2,
#   group_label = "Kaiser Permanente Georgia",
#   start_row = 19,
#   end_row = 19) 
# coll_bplt_knitr2 <- group_rows(
#   coll_bplt_knitr2,
#   group_label = "Kaiser Permanente Hawaii",
#   start_row = 20,
#   end_row = 21) 
# coll_bplt_knitr2 <- group_rows(
#   coll_bplt_knitr2,
#   group_label = "Kaiser Permanente Northwest",
#   start_row = 22,
#   end_row = 22)
# coll_bplt_knitr2 <- group_rows(
#   coll_bplt_knitr2,
#   group_label = "Sanford Health",
#   start_row = 23,
#   end_row = 23)
# coll_bplt_knitr2 <- group_rows(
#   coll_bplt_knitr2,
#   group_label = "University of Chicago Medicine",
#   start_row = 24,
#   end_row = 28)

coll_bplt_knitr2 <- group_rows(
  coll_bplt_knitr2,
  group_label = "Henry Ford Health",
  start_row = 1,
  end_row = 15)
coll_bplt_knitr2 <- group_rows(
  coll_bplt_knitr2,
  group_label = "HealthPartners",
  start_row = 16,
  end_row = 17)
coll_bplt_knitr2 <- group_rows(
  coll_bplt_knitr2,
  group_label = "Kaiser Permanente Colorado",
  start_row = 18,
  end_row = 18) 
coll_bplt_knitr2 <- group_rows(
  coll_bplt_knitr2,
  group_label = "Kaiser Permanente Georgia",
  start_row = 19,
  end_row = 19) 
coll_bplt_knitr2 <- group_rows(
  coll_bplt_knitr2,
  group_label = "Kaiser Permanente Hawaii",
  start_row = 20,
  end_row = 21) 
coll_bplt_knitr2 <- group_rows(
  coll_bplt_knitr2,
  group_label = "Kaiser Permanente Northwest",
  start_row = 22,
  end_row = 22)
coll_bplt_knitr2 <- group_rows(
  coll_bplt_knitr2,
  group_label = "Sanford Health",
  start_row = 23,
  end_row = 23)
coll_bplt_knitr2 <- group_rows(
  coll_bplt_knitr2,
  group_label = "University of Chicago Medicine",
  start_row = 24,
  end_row = 29)


coll_bplt_knitr2

```

\FloatBarrier
```{r KnitrTable5.4a_5.6a,echo=FALSE,error=FALSE,message=FALSE,results='asis'}
#SF version of Table 5.4
table_ct5_4 <- knitr::kable(ct5_4 , caption="Table 5.4a Baseline Collection-To-Receipt Time (in Days) Among Clinical Collections by Clinic Location \n Sanford Health", row.names=FALSE,align=c("l","c","c","c","c"), booktabs = TRUE)
num_rows <- nrow(ct5_4)
table_ct5_4 <- table_ct5_4 %>% row_spec(1:(num_rows - 1), extra_css = "text-indent: 20px;")
kable_styling(table_ct5_4, latex_options = "HOLD_position")


 
 
coll_bplt_knitr3 <- knitr::kable(Hrs_bptl_col, col.names=c("Collection Location", 'Min', 'Q1', 'Median', 'Mean', 'Q3','Perc.90','Perc.98'), caption='Table 5.5: Baseline- Time (in Hours) from Research Collection to Receipt by Collection Location', row.names=FALSE, align=c("l","c","c","c","c","c","c","c","c"), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down") 


coll_bplt_knitr3 <- group_rows(
  coll_bplt_knitr3,
  group_label = "Baylor Scott and White Health",
  start_row = 1,
  end_row = 2) 
coll_bplt_knitr3 <- group_rows(
  coll_bplt_knitr3,
  group_label = "HealthPartners",
  start_row = 3,
  end_row = 3)  
coll_bplt_knitr3 <- group_rows(
  coll_bplt_knitr3,
  group_label = "Henry Ford Health",
  start_row = 4,
  end_row = 7) 
coll_bplt_knitr3 <- group_rows(
  coll_bplt_knitr3,
  group_label = "Marshfield",
  start_row = 8,
  end_row = 13) 
coll_bplt_knitr3 <- group_rows(
  coll_bplt_knitr3,
  group_label = "Sanford Health",
  start_row = 14,
  end_row = 15)
coll_bplt_knitr3 <- group_rows(
  coll_bplt_knitr3,
  group_label = "University of Chicago",
  start_row = 16,
  end_row = 21)


add_footnote(coll_bplt_knitr3, "Note: BPTL receipt time is assumed to be 11:30am ET.", notation = "none")







coll_bplt_knitr4 <- knitr::kable(Hrs_bptl_col4, col.names=c("Collection Location", 'Min', 'Q1', 'Median', 'Mean', 'Q3','Perc.90','Perc.98'), caption='Table 5.6: Baseline- Time (in Hours) from Clinical Collection to Receipt by Clinic Location', row.names=FALSE, align=c("l","c","c","c","c","c","c","c","c"), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down") 


coll_bplt_knitr4 <- group_rows(
  coll_bplt_knitr4,
  group_label = "Henry Ford Health",
  start_row = 1,
  end_row = 14)
coll_bplt_knitr4 <- group_rows(
  coll_bplt_knitr4,
  group_label = "HealthPartners",
  start_row = 15,
  end_row = 16)
coll_bplt_knitr4 <- group_rows(
  coll_bplt_knitr4,
  group_label = "Kaiser Permanente Colorado",
  start_row = 17,
  end_row = 17) 
coll_bplt_knitr4 <- group_rows(
  coll_bplt_knitr4,
  group_label = "Kaiser Permanente Georgia",
  start_row = 18,
  end_row = 18) 
coll_bplt_knitr4 <- group_rows(
  coll_bplt_knitr4,
  group_label = "Kaiser Permanente Hawaii",
  start_row = 19,
  end_row = 20) 
coll_bplt_knitr4 <- group_rows(
  coll_bplt_knitr4,
  group_label = "Kaiser Permanente Northwest",
  start_row = 21,
  end_row = 21) 
coll_bplt_knitr4 <- group_rows(
  coll_bplt_knitr4,
  group_label = "Sanford Health",
  start_row = 22,
  end_row = 22)
coll_bplt_knitr4 <- group_rows(
  coll_bplt_knitr4,
  group_label = "University of Chicago Medicine",
  start_row = 23,
  end_row = as.numeric(nrow(Hrs_bptl_col4)))


coll_bplt_knitr4



knitr::kable(Hrs_bptl_colSF4, col.names=c("Collection Location", 'Min', 'Q1', 'Median', 'Mean', 'Q3','Perc.90','Perc.98'), caption='Table 5.6a: Baseline- Time (in Hours) from Clinical Collection to Receipt by Clinic Location \n Sanford Health', row.names=FALSE, align=c("l","c","c","c","c","c","c","c"), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down") 
```


\FloatBarrier


```{r Figs6_14_Plots, warning=FALSE, eval=TRUE,echo=FALSE}

coll_bptl_diff$Weekdays <- factor(weekdays(as.Date(coll_bptl_diff$d_678166505)))
coll_bptl_diff$Weekdays<- factor(coll_bptl_diff$Weekdays,levels=c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"))

coll_bptl_diff2$Weekdays <- factor(weekdays(as.Date(coll_bptl_diff2$clin_coll_bu)))
coll_bptl_diff2$Weekdays<- factor(coll_bptl_diff2$Weekdays,levels=c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"))

scatMF <- coll_bptl_diff %>%  filter(Site=="Marshfield")
scatSF <- coll_bptl_diff %>%  filter(Site=="Sanford Health")
scatUC <- coll_bptl_diff %>%  filter(Site=="University of Chicago")
scatKPCO <- coll_bptl_diff2 %>%  filter(Site=="Kaiser Permanente Colorado")
scatKPGA <- coll_bptl_diff2 %>%  filter(Site=="Kaiser Permanente Georgia")
scatKPHI <- coll_bptl_diff2 %>%  filter(Site=="Kaiser Permanente Hawaii")
scatKPNW <- coll_bptl_diff2 %>%  filter(Site=="Kaiser Permanente Northwest")

scatRHP <- coll_bptl_diff %>%  filter(Site=="HealthPartners")
scatCHP <- coll_bptl_diff2 %>%  filter(Site=="HealthPartners")
scatRHP$coldate <- scatRHP$d_678166505
scatCHP$coldate <- scatCHP$clin_coll_bu

scatRHF <- coll_bptl_diff %>%  filter(Site=="Henry Ford Health")
scatCHF <- coll_bptl_diff2 %>%  filter(Site=="Henry Ford")

scatCSF <- coll_bptl_diff2 %>%  filter(Site=="Sanford Health")
scatCSF$coldate <- scatCSF$clin_coll_bu

scatCUC <- coll_bptl_diff2 %>%  filter(Site=="University of Chicago Medicine")
scatCUC$coldate <- scatCUC$clin_coll_bu


weekday_order <- c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday")




ggplot(scatMF, aes(x=as.Date(d_678166505), y=hrs_past, color = Weekdays)) + 
    geom_point() + scale_x_date(name="Collection Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-7), expand=c(0,0)) + 
  scale_y_continuous(name="Number of Hours",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  scale_color_manual(values=c("Sunday"="#B1C7D9", "Monday"="#164C71", "Tuesday"="#FDBE19", "Wednesday"="#FBE5B5", 
                     "Thursday"="#565C65", "Friday"="#3C989E", "Saturday"="#CC7D15")) +
  theme(panel.background = element_blank(),         
        #legend.title = element_text(size=7),         
        legend.position = "bottom",        
        axis.line = element_line(size=0.2),        
        axis.text.x=element_text(angle=60, hjust=1), 
        axis.title.x = element_text( size = 14, face = "bold") ,         
        axis.title.y = element_text(size = 14, face = "bold",color="black"),         
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +     
  theme(plot.caption = element_text(hjust=0))  + ggtitle(label="Figure 5.1: Baseline Collection-To-Receipt Time (in Hours), \n Marshfield")




ggplot(scatSF, aes(x=as.Date(d_678166505), y=hrs_past, color = Weekdays)) + 
    geom_point() + scale_x_date(name="Collection Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-7), expand=c(0,0)) + 
  scale_y_continuous(name="Number of Hours",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  scale_color_manual(values=c("Sunday"="#B1C7D9", "Monday"="#164C71", "Tuesday"="#FDBE19", "Wednesday"="#FBE5B5", 
                     "Thursday"="#565C65", "Friday"="#3C989E", "Saturday"="#CC7D15")) +
    theme(panel.background = element_blank(),         
        #legend.title = element_text(size=7),         
        legend.position = "bottom",        
        axis.line = element_line(size=0.2),        
        axis.text.x=element_text(angle=60, hjust=1), 
        axis.title.x = element_text( size = 14, face = "bold") ,         
        axis.title.y = element_text(size = 14, face = "bold",color="black"),         
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +     
  theme(plot.caption = element_text(hjust=0))  +
  ggtitle(label="Figure 5.2: Baseline Collection-To-Receipt Time (in Hours), \n Sanford Health Research Setting")







#SF
scatCSF$coldate <- scatCSF$clin_coll_bu

C_plotSF <- ggplot(scatCSF, aes(x = as.Date(coldate), y = hrs_past, color = factor(weekdays(as.Date(coldate))))) +
  geom_point() +
  scale_x_date(name="Collection Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2024-03-25"),(as.Date(currentDate)-7)), expand=c(0,0)) +
  scale_y_continuous(name="Number of Hours",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  labs(color = "Weekdays") +
   scale_color_manual(values=c("Sunday"="#B1C7D9", "Monday"="#164C71", "Tuesday"="#FDBE19", "Wednesday"="#FBE5B5",
                       "Thursday"="#565C65", "Friday"="#3C989E", "Saturday"="#CC7D15"), limits = weekday_order) +
     theme(panel.background = element_blank(),
         legend.title = element_text(size=7),
         legend.position = "bottom",
         axis.line = element_line(size=0.2),
         axis.text.x=element_text(angle=60, hjust=1),
         axis.title.x = element_text( size = 14, face = "bold") ,
         axis.title.y = element_text(size = 14, face = "bold",color="black"),
         plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +
   theme(plot.caption = element_text(hjust=0), legend.title = element_text(size = 8.5))  +
   ggtitle(label="Figure 5.3: Baseline- Collection-To-Receipt Time (in Hours), \n Sanford Health Clinical Setting")
 C_plotSF


ggplot(scatUC, aes(x=as.Date(d_678166505), y=hrs_past, color = Weekdays)) + 
    geom_point() + scale_x_date(name="Collection Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-7), expand=c(0,0)) + 
  scale_y_continuous(name="Number of Hours",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  scale_color_manual(values=c("Sunday"="#B1C7D9", "Monday"="#164C71", "Tuesday"="#FDBE19", "Wednesday"="#FBE5B5", 
                     "Thursday"="#565C65", "Friday"="#3C989E", "Saturday"="#CC7D15")) +
    theme(panel.background = element_blank(),         
        #legend.title = element_text(size=7),         
        legend.position = "bottom",        
        axis.line = element_line(size=0.2),        
        axis.text.x=element_text(angle=60, hjust=1), 
        axis.title.x = element_text( size = 14, face = "bold") ,         
        axis.title.y = element_text(size = 14, face = "bold",color="black"),         
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +     
  theme(plot.caption = element_text(hjust=0))  +
  ggtitle(label="Figure 5.4: Baseline Collection-To-Receipt Time (in Hours),  \n University of Chicago Medicine Research Setting")


scatCUC$coldate <- scatCUC$clin_coll_bu

C_plotUC <- ggplot(scatCUC, aes(x = as.Date(coldate), y = hrs_past, color = factor(weekdays(as.Date(coldate))))) +
  geom_point() +
  scale_x_date(name="Collection Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2024-03-25"),(as.Date(currentDate)-7)), expand=c(0,0)) +
  scale_y_continuous(name="Number of Hours",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  labs(color = "Weekdays") +
   scale_color_manual(values=c("Sunday"="#B1C7D9", "Monday"="#164C71", "Tuesday"="#FDBE19", "Wednesday"="#FBE5B5",
                       "Thursday"="#565C65", "Friday"="#3C989E", "Saturday"="#CC7D15"), limits = weekday_order) +
     theme(panel.background = element_blank(),
         legend.title = element_text(size=7),
         legend.position = "bottom",
         axis.line = element_line(size=0.2),
         axis.text.x=element_text(angle=60, hjust=1),
         axis.title.x = element_text( size = 14, face = "bold") ,
         axis.title.y = element_text(size = 14, face = "bold",color="black"),
         plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +
   theme(plot.caption = element_text(hjust=0), legend.title = element_text(size = 8.5))  +
   ggtitle(label="Figure 5.5: Baseline- Collection-To-Receipt Time (in Hours), \n University of Chicago Medicine Clinical Setting")
 C_plotUC

ggplot(scatKPCO, aes(x=as.Date(clin_coll_bu), y=hrs_past, color = Weekdays)) + 
    geom_point() + scale_x_date(name="Collection Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-10-10"),as.Date(currentDate)-7), expand=c(0,0)) + 
  scale_y_continuous(name="Number of Hours",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  scale_color_manual(values=c("Sunday"="#B1C7D9", "Monday"="#164C71", "Tuesday"="#FDBE19", "Wednesday"="#FBE5B5", 
                     "Thursday"="#565C65", "Friday"="#3C989E", "Saturday"="#CC7D15")) +
    theme(panel.background = element_blank(),         
        #legend.title = element_text(size=7),         
        legend.position = "bottom",        
        axis.line = element_line(size=0.2),        
        axis.text.x=element_text(angle=60, hjust=1), 
        axis.title.x = element_text( size = 14, face = "bold") ,         
        axis.title.y = element_text(size = 14, face = "bold",color="black"),         
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +     
  theme(plot.caption = element_text(hjust=0))  +
  ggtitle(label="Figure 5.6: Baseline Collection-To-Receipt Time (in Hours),  \n Kaiser Permanente Colorado")

ggplot(scatKPGA, aes(x=as.Date(clin_coll_bu), y=hrs_past, color = Weekdays)) + 
    geom_point() + scale_x_date(name="Collection Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-10-10"),as.Date(currentDate)-7), expand=c(0,0)) + 
  scale_y_continuous(name="Number of Hours",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  scale_color_manual(values=c("Sunday"="#B1C7D9", "Monday"="#164C71", "Tuesday"="#FDBE19", "Wednesday"="#FBE5B5", 
                     "Thursday"="#565C65", "Friday"="#3C989E", "Saturday"="#CC7D15")) +
    theme(panel.background = element_blank(),         
        #legend.title = element_text(size=7),         
        legend.position = "bottom",        
        axis.line = element_line(size=0.2),        
        axis.text.x=element_text(angle=60, hjust=1), 
        axis.title.x = element_text( size = 14, face = "bold") ,         
        axis.title.y = element_text(size = 14, face = "bold",color="black"),         
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +     
  theme(plot.caption = element_text(hjust=0))  +
  ggtitle(label="Figure 5.7: Baseline Collection-To-Receipt Time (in Hours), \n Kaiser Permanente Georgia")

ggplot(scatKPHI, aes(x=as.Date(clin_coll_bu), y=hrs_past, color = Weekdays)) + 
    geom_point() + scale_x_date(name="Collection Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-10-10"),as.Date(currentDate)-7), expand=c(0,0)) + 
  scale_y_continuous(name="Number of Hours",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  scale_color_manual(values=c("Sunday"="#B1C7D9", "Monday"="#164C71", "Tuesday"="#FDBE19", "Wednesday"="#FBE5B5", 
                     "Thursday"="#565C65", "Friday"="#3C989E", "Saturday"="#CC7D15")) +
    theme(panel.background = element_blank(),         
        #legend.title = element_text(size=7),         
        legend.position = "bottom",        
        axis.line = element_line(size=0.2),        
        axis.text.x=element_text(angle=60, hjust=1), 
        axis.title.x = element_text( size = 14, face = "bold") ,         
        axis.title.y = element_text(size = 14, face = "bold",color="black"),         
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +     
  theme(plot.caption = element_text(hjust=0))  +
  ggtitle(label="Figure 5.8: Baseline Collection-To-Receipt Time (in Hours), \n Kaiser Permanente Hawaii")

ggplot(scatKPNW, aes(x=as.Date(clin_coll_bu), y=hrs_past, color = Weekdays)) + 
    geom_point() + scale_x_date(name="Collection Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-10-10"),as.Date(currentDate)-7), expand=c(0,0)) + 
  scale_y_continuous(name="Number of Hours",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  scale_color_manual(values=c("Sunday"="#B1C7D9", "Monday"="#164C71", "Tuesday"="#FDBE19", "Wednesday"="#FBE5B5", 
                     "Thursday"="#565C65", "Friday"="#3C989E", "Saturday"="#CC7D15")) +
    theme(panel.background = element_blank(),         
        #legend.title = element_text(size=7),         
        legend.position = "bottom",        
        axis.line = element_line(size=0.2),        
        axis.text.x=element_text(angle=60, hjust=1), 
        axis.title.x = element_text( size = 14, face = "bold") ,         
        axis.title.y = element_text(size = 14, face = "bold",color="black"),         
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +     
  theme(plot.caption = element_text(hjust=0))  +
  ggtitle(label="Figure 5.9: Baseline Collection-To-Receipt Time (in Hours), \n Kaiser Permanente Northwest")



#HP


R_plotHP <- ggplot(scatRHP, aes(x = as.Date(coldate), y = hrs_past,  color = factor(weekdays(as.Date(coldate))))) +
  geom_point() +
  #scale_color_manual(values = c("Research" = "red", "Clinical" = "blue")) +
  scale_x_date(name="Collection Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-7), expand=c(0,0)) +
  scale_y_continuous(name="Number of Hours",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  labs(color = "Weekdays") +
  scale_color_manual(values=c("Sunday"="#B1C7D9", "Monday"="#164C71", "Tuesday"="#FDBE19", "Wednesday"="#FBE5B5", 
                     "Thursday"="#565C65", "Friday"="#3C989E", "Saturday"="#CC7D15"), limits = weekday_order) +
    theme(panel.background = element_blank(),         
        #legend.title = element_text(size=7),         
        legend.position = "bottom",        
        axis.line = element_line(size=0.2),        
        axis.text.x=element_text(angle=60, hjust=1), 
        axis.title.x = element_text( size = 14, face = "bold") ,         
        axis.title.y = element_text(size = 14, face = "bold",color="black"),         
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +     
  theme(plot.caption = element_text(hjust=0), legend.title = element_text(size = 8.5))  +
  ggtitle(label="Figure 5.10: Baseline- Collection-To-Receipt Time (in Hours), \n HealthPartners Research Setting")
R_plotHP


C_plotHP <- ggplot(scatCHP, aes(x = as.Date(coldate), y = hrs_past, color = factor(weekdays(as.Date(coldate))))) +
  geom_point() +
  #scale_color_manual(values = c("Research" = "red", "Clinical" = "blue")) +
  scale_x_date(name="Collection Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2023-10-23"),as.Date(currentDate)-7), expand=c(0,0)) +
  scale_y_continuous(name="Number of Hours",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  labs(color = "Weekdays") +
  scale_color_manual(values=c("Sunday"="#B1C7D9", "Monday"="#164C71", "Tuesday"="#FDBE19", "Wednesday"="#FBE5B5", 
                     "Thursday"="#565C65", "Friday"="#3C989E", "Saturday"="#CC7D15"), limits = weekday_order) +
    theme(panel.background = element_blank(),         
        #legend.title = element_text(size=7),         
        legend.position = "bottom",        
        axis.line = element_line(size=0.2),        
        axis.text.x=element_text(angle=60, hjust=1), 
        axis.title.x = element_text( size = 14, face = "bold") ,         
        axis.title.y = element_text(size = 14, face = "bold",color="black"),         
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +     
  theme(plot.caption = element_text(hjust=0), legend.title = element_text(size = 8.5))  +
  ggtitle(label="Figure 5.11: Baseline- Collection-To-Receipt Time (in Hours), \n HealthPartners Clinical Setting")
C_plotHP

#HF
scatRHF$coldate <- scatRHF$d_678166505
scatCHF$coldate <- scatCHF$clin_coll_bu
#combined_dataHF <- rbind(cbind(scatRHF, Group = "Research"), cbind(scatCHF, Group = "Clinical"))




combined_plotHF2 <- ggplot(scatRHF, aes(x = as.Date(coldate), y = hrs_past,  color = factor(weekdays(as.Date(coldate))))) + #shape = Group,
  geom_point() +
  #scale_color_manual(values = c("Research" = "red", "Clinical" = "blue")) +
  scale_x_date(name="Colllection Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks",limits=c( as.Date("2022-06-20"),as.Date(currentDate)-7),  expand=c(0,0)) +
  scale_y_continuous(name="Number of Hours",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  labs(color = "Weekdays") + #, shape="Setting"
  scale_color_manual(values=c("Sunday"="#B1C7D9", "Monday"="#164C71", "Tuesday"="#FDBE19", "Wednesday"="#FBE5B5", 
                     "Thursday"="#565C65", "Friday"="#3C989E", "Saturday"="#CC7D15"), limits = weekday_order) +
  #scale_shape_manual(values = c("Research" = 0, "Clinical" = 17)) + 
    theme(panel.background = element_blank(),         
        #legend.title = element_text(size=7),         
        legend.position = "bottom",        
        axis.line = element_line(size=0.2),        
        axis.text.x=element_text(angle=60, hjust=1), 
        axis.title.x = element_text( size = 14, face = "bold") ,         
        axis.title.y = element_text(size = 14, face = "bold",color="black"),         
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +     
  theme(plot.caption = element_text(hjust=0), legend.title = element_text(size = 8.5))  +
  ggtitle(label="Figure 5.12: Baseline- Collection-To-Receipt Time (in Hours), \n Henry Ford Research Setting")

combined_plotHF2


combined_plotHF1 <- ggplot(scatCHF, aes(x = as.Date(coldate), y = hrs_past,  color = factor(weekdays(as.Date(coldate))))) + #shape = Group,
  geom_point() +
  #scale_color_manual(values = c("Research" = "red", "Clinical" = "blue")) +
  scale_x_date(name="Colllection Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks",limits=c( as.Date("2023-04-24"),as.Date(currentDate)-7),  expand=c(0,0)) +
  scale_y_continuous(name="Number of Hours",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  labs(color = "Weekdays") + #, shape="Setting"
  scale_color_manual(values=c("Sunday"="#B1C7D9", "Monday"="#164C71", "Tuesday"="#FDBE19", "Wednesday"="#FBE5B5", 
                     "Thursday"="#565C65", "Friday"="#3C989E", "Saturday"="#CC7D15"), limits = weekday_order) +
  #scale_shape_manual(values = c("Research" = 0, "Clinical" = 17)) + 
    theme(panel.background = element_blank(),         
        #legend.title = element_text(size=7),         
        legend.position = "bottom",        
        axis.line = element_line(size=0.2),        
        axis.text.x=element_text(angle=60, hjust=1), 
        axis.title.x = element_text( size = 14, face = "bold") ,         
        axis.title.y = element_text(size = 14, face = "bold",color="black"),         
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +     
  theme(plot.caption = element_text(hjust=0), legend.title = element_text(size = 8.5))  +
  ggtitle(label="Figure 5.13: Baseline- Collection-To-Receipt Time (in Hours), \n Henry Ford Clinical Setting")

combined_plotHF1
```





\newpage

# Baseline Weekly Biospecimen Collection
\vspace{-0.5em}
\FloatBarrier
```{r Fig15, eval=TRUE,echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 


fig2_all <- recr.biospe %>%  filter(d_684635302 == 353358909 | d_878865966 == 353358909| d_167958071 == 353358909)

fig2_1<- fig2_all %>% mutate(#weekday = weekdays(ymd_hms(collection.tm)),
                                    #chicago = ifelse(d_827220437.y == 809703864, "Chicago","non Chicago"),
                                    #start.date = min(schedulecol.tm),
                                    #current.date=max(as.POSIXct(ymd_hms(schedulecol.tm))),
                                    BioRec_CollectScheduled = ifelse(as.Date(ymd_hms(schedulecol.tm)) >= as.Date(as.POSIXct(ymd_hms(d_914594314))),1,0))
                                    
                                    
visit_wk_site1 <- fig2_1 %>% arrange(col.Sunday.week,col.Monday.date) %>% group_by(col.Sunday.week,col.Monday.date) %>% tally()


research.vt1 <- ggplot(visit_wk_site1, aes(x=as.Date(col.Monday.date), y=n)) + #,fill=Site, color=Site)) +
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="Number of Collections",limits=c(0,100*round(max(visit_wk_site1$n/100,1)))) + 
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-7),expand=c(0,0)) +
  scale_fill_brewer(palette="Dark2") +
  ggtitle(label="Figure 6.1: Baseline- Weekly Total Biospecimen Collections") +
  theme(panel.background = element_blank(),
        legend.title = element_text(size=7),
        legend.position="bottom",
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14, face = "bold") ,
        axis.title.y = element_text(size = 14, face = "bold",color="black"),
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +
        guides(fill=guide_legend(nrow=2,byrow=TRUE))


research.vt1

```



```{r Figures16_18, eval=TRUE,echo=FALSE}
 
 #Hybird version
VW_biospe <- biospe %>%  select(d_951355211, Connect_ID)
VW_biospe$Connect_ID <- as.character(VW_biospe$Connect_ID)
Hybrid_VWS <- left_join(recr.biospe, VW_biospe, by="Connect_ID")


research.surveyVW <- research.survey %>%  select(Site, Connect_ID, col.Sunday.week,col.Monday.date, d_650516960)
research.surveyVW$Connect_ID <- as.character(research.surveyVW$Connect_ID)
VWS <- left_join(research.surveyVW, VW_biospe, by="Connect_ID")

 
 
 research.survey.hybrid <- Hybrid_VWS %>% filter(Site=="Henry Ford Health System" | Site=="HealthPartners"| Site=="Sanford Health" | Site=="University of Chicago Medicine") #<- change to site=HF, color=d_650516960

research.survey.hybrid<-research.survey.hybrid %>% mutate(#weekday = weekdays(ymd_hms(collection.tm)),
                                    #chicago = ifelse(d_827220437.y == 809703864, "Chicago","non Chicago"),
                                    start.date = min(schedulecol.tm),
                                    current.date=max(as.POSIXct(ymd_hms(schedulecol.tm))),
                                    BioRec_CollectScheduled = ifelse(as.Date(ymd_hms(schedulecol.tm)) >= as.Date(as.POSIXct(ymd_hms(d_914594314))),1,0),
                                    Setting= case_when(d_650516960==534621077 ~ "Research",
                                                       d_650516960==664882224 ~ "Clinical"),
                                    Site_location = case_when(d_951355211==777644826 ~ "UC-DCAM",
                                                      d_951355211==145191545 ~ "Ingalls Harvey",
                                                      d_951355211==489380324 ~ "River East",
                                                      d_951355211==120264574 ~ "South Loop",
                                                      d_951355211==834825425 ~ "HP Research Clinic",
                                                      #d_951355211==574368418 ~ "HP Park Nicollet",
                                                      d_951355211==736183094 ~ "HFH K-13 Research Clinic",
                                                      d_951355211==886364332 ~ "HFH Cancer Pavilion Research Clinic",
                                                      d_951355211==706927479 ~ "HFH Livonia Research Clinic",
                                                      d_951355211==692275326 ~ "Marshfield",
                                                      d_951355211==813701399 ~ "Weston",
                                                      d_951355211==698283667 ~ "Lake Hallie",
                                                      d_951355211==691714762 ~ "Rice Lake",
                                                      d_951355211==487512085 ~ "Wisconsin Rapids",
                                                      d_951355211==983848564 ~ "Colby Abbotsford",
                                                      d_951355211==261931804 ~ "Minocqua",
                                                      d_951355211==665277300 ~ "Merrill",
                                                      d_951355211==589224449 ~ "Sioux Falls Imagenetics",
                                                      d_951355211==467088902 ~ "Fargo South University",
                                                      d_951355211==567969985 ~ "MF Pop-Up",
                                                      d_951355211==319518299 ~ "UCM Pop-Up",
                                                      d_951355211==940329442 ~ "Orland Park",
                                                      TRUE ~ "Hybrid"))



visit_wk_site.hybrid <-research.survey.hybrid %>% arrange(Site,Site_location, Setting,col.Sunday.week,col.Monday.date) %>% group_by(Site,Site_location, Setting,col.Sunday.week,col.Monday.date) %>% tally()



 
   visit_wk_site.hybridHF= visit_wk_site.hybrid %>%  filter( Site=="Henry Ford Health System")
 research.vt_plotH <- ggplot(visit_wk_site.hybridHF, aes(x=as.Date(col.Monday.date), y=n, color=Setting )) + #,fill=site, color=site)) +   #research.vt <-    ,fill=Site, color=Site
   geom_line() + geom_point(width = 0.2) +
   scale_y_continuous(name="Number of Collections") +
   scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-7),expand=c(0,0))  +
   scale_color_manual(values=c("Clinical"="#164C71", "Research"="#FDBE19")) +
   ggtitle(label="Figure 6.2: Baseline- Weekly Biospecimen Collections by Collection Setting, \n Henry Ford") +
   labs(color = "Collection Setting") +
   theme(panel.background = element_blank(),
         legend.position = "bottom",
         axis.line = element_line(size=0.2),
         axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) ,  #, face = "bold"
         axis.title.y = element_text(size = 14,color="black"),   #, face = "bold"
         plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) #guides(fill=guide_legend(nrow=2,byrow=TRUE))
 print(research.vt_plotH)
 


edited_fig3_1 <- visit_wk_site.hybridHF %>%  filter(Site_location!="Hybrid")

  ggplot(edited_fig3_1, aes(x=as.Date(col.Monday.date), y=n, color=Site_location)) + #,fill=site, color=site)) +   #research.vt <-    ,fill=Site, color=Site
   geom_point(width = 0.2) + geom_line() + 
   scale_y_continuous(name="Number of Collections") +
   scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-7),expand=c(0,0))  +
   scale_color_manual(name = "Collection Location",
                       values=c("HFH K-13 Research Clinic"="#164C71", "HFH Cancer Pavilion Research Clinic"="#FDBE19", "HFH Livonia Research Clinic"="#3C989E", "HFH Pop-Up"="#CC7D15"),
                      guide = guide_legend(nrow = 2, byrow = TRUE)) +
    labs(color = "Collection Location") +
   ggtitle(label="Figure 6.3: Baseline- Weekly Research Biospecimen Collections \n by Collection Location, Henry Ford Health") +
   theme(panel.background = element_blank(),
         #legend.title = element_text(size=9),
         legend.position = "bottom",
         axis.line = element_line(size=0.2),
         axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) ,  #, face = "bold"
         axis.title.y = element_text(size = 14,color="black"),   #, face = "bold"
         plot.title = element_text(hjust = 0.5,size = 12, face = "bold"))  

 
 
 
  edited_fig3_1_Clin <- clinic.survey %>% filter(d_827220437==548392715) %>% 
   mutate(HF_Sites= case_when(d_173836415_d_266600170_d_185243482==1050010095 | d_173836415_d_266600170_d_452847912==1050010095 ~ "Wyandotte",
                       d_173836415_d_266600170_d_185243482==1060010063 | d_173836415_d_266600170_d_185243482==1060170018 |
                         d_173836415_d_266600170_d_452847912==1060010063 | d_173836415_d_266600170_d_452847912==1060170018~ "Macomb",
                       d_173836415_d_266600170_d_185243482==1040010047 | d_173836415_d_266600170_d_185243482==1040010046 |
                         d_173836415_d_266600170_d_185243482==1011220006 |
                         d_173836415_d_266600170_d_452847912==1040010047 | d_173836415_d_266600170_d_452847912==1040010046 |
                         d_173836415_d_266600170_d_452847912==1011220006 ~ "West Bloomfield",
                       d_173836415_d_266600170_d_185243482==1011410008 | d_173836415_d_266600170_d_452847912==1011410008 ~ "Royal Oak",
                       d_173836415_d_266600170_d_185243482==1010180040 |d_173836415_d_266600170_d_452847912 ==1010180040 ~ "Fairlane (Dearborn)",
                       d_173836415_d_266600170_d_185243482==1010120026 | d_173836415_d_266600170_d_452847912==1010120026 ~ "Columbus",
                       d_173836415_d_266600170_d_185243482==1011660013  | d_173836415_d_266600170_d_452847912==1011660013 ~ "Plymouth",
                       d_173836415_d_266600170_d_185243482==1010360011 | d_173836415_d_266600170_d_452847912==1010360011 ~ "Troy",
                       d_173836415_d_266600170_d_185243482==1010350019 | d_173836415_d_266600170_d_452847912==1010350019 ~ "Taylor",
                       d_173836415_d_266600170_d_185243482==1010240013 | d_173836415_d_266600170_d_452847912==1010240013 ~ "Livonia",
                       d_173836415_d_266600170_d_185243482== 1010200009 |d_173836415_d_266600170_d_452847912 == 1010200009 ~ "Ford Road",
                       d_173836415_d_266600170_d_185243482== 1010270015 |d_173836415_d_266600170_d_452847912 == 1010270015 ~ "NCO",
                       d_173836415_d_266600170_d_185243482==1010320019 | d_173836415_d_266600170_d_452847912==1010320019 ~ "Sterling Heights",
                       d_173836415_d_266600170_d_185243482==1010010193 | d_173836415_d_266600170_d_452847912==1010010114 |
                         d_173836415_d_266600170_d_185243482==1010010193 | d_173836415_d_266600170_d_452847912==1010010114~ "K1 HFH Main",
                       #d_173836415_d_266600170_d_185243482 == 1050020026 | d_173836415_d_266600170_d_452847912 == 1050020026 ~ "Brownstown",
                             TRUE ~ "Remove"))
  edited_fig3_1_Clin <- edited_fig3_1_Clin %>% filter(edited_fig3_1_Clin$HF_Sites !="Remove")
edited_fig3_1_Clin_tally <- edited_fig3_1_Clin %>% arrange(HF_Sites, col.Sunday.week,col.Monday.date) %>% group_by(HF_Sites, col.Sunday.week,col.Monday.date) %>% tally()
  
  research.vt_plotH_Clin <- ggplot(edited_fig3_1_Clin_tally, aes(x=as.Date(col.Monday.date), y=n, color=HF_Sites )) + #,fill=site, color=site)) +   #research.vt <-    ,fill=Site, color=Site
   geom_line() + geom_point(width = 0.2) +
   scale_y_continuous(name="Number of Collections") +
   scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2023-05-22"),as.Date(currentDate)-7),expand=c(0,0))  +
     scale_color_manual(values=c("Wyandotte"="#B1C7D9", "Macomb"="#164C71", "West Bloomfield"="#FDBE19", "Royal Oak"="#F8D991", 
                              "Fairlane (Dearborn)"="#565C65", "Columbus"= "#3C989E", "Plymouth"="#CC7D15", "Troy"="#DAB384", "Taylor"="#7C94A8","Brownstown"="#2973A5",
                              "Livonia"="#BBBEC1", "Ford Road"="#99C0C4", "NCO"="#B9D7E3", "Sterling Heights"="#309EBD", "K1 HFH Main"="#97C4D5")) + 
   ggtitle(label="Figure 6.4: Baseline- Weekly Clinical Biospecimen Collections \n by Clinic Location, Henry Ford Health") +
    labs(color = "Clinic Location") +
   theme(panel.background = element_blank(),
         legend.title = element_text(size=8.5),
         legend.position = "bottom",
         legend.text = element_text(size = 8),
         axis.line = element_line(size=0.2),
         axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) ,  #, face = "bold"
         axis.title.y = element_text(size = 14,color="black"),   #, face = "bold"
         plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) #guides(fill=guide_legend(nrow=2,byrow=TRUE))
 research.vt_plotH_Clin + guides(color = guide_legend(title = "Clinic Location")) 
 
 


 VWS_var <- VWS %>%  mutate(Site_location = case_when(d_951355211==777644826 ~ "UC-DCAM",
                                                      d_951355211==145191545 ~ "Ingalls Harvey",
                                                      d_951355211==489380324 ~ "River East",
                                                      d_951355211==120264574 ~ "South Loop",
                                                      d_951355211==736183094 ~ "HFH K-13 Research Clinic",
                                                      d_951355211==886364332 ~ "HFH Cancer Pavilion Research Clinic",
                                                      d_951355211==706927479 ~ "HFH Livonia Research Clinic",
                                                      d_951355211==692275326 ~ "Marshfield",
                                                      d_951355211==813701399 ~ "Weston",
                                                      d_951355211==698283667 ~ "Lake Hallie",
                                                      d_951355211==691714762 ~ "Rice Lake",
                                                      d_951355211==487512085 ~ "Wisconsin Rapids",
                                                      d_951355211==983848564 ~ "Colby Abbotsford",
                                                      d_951355211==261931804 ~ "Minocqua",
                                                      d_951355211==665277300 ~ "Merrill",
                                                      d_951355211==589224449 ~ "Sioux Falls Imagenetics",
                                                      d_951355211==467088902 ~ "Fargo South University",
                                                      d_951355211==834825425 ~ "HP Research Clinic",
                                                      #d_951355211==574368418 ~ "HP Park Nicollet",
                                                      d_951355211==567969985 ~ "MF Pop-Up",
                                                      d_951355211==319518299 ~ "UCM Pop-Up",
                                                      d_951355211==940329442 ~ "Orland Park"),
                            Setting= case_when(d_650516960==534621077 ~ "Research",
                                               d_650516960==664882224 ~ "Clinical"))
 

visit_wk_site_edited <- VWS_var %>% arrange(Site,Site_location,Setting,col.Sunday.week,col.Monday.date ) %>% group_by(Site_location, Site,Setting, col.Sunday.week,col.Monday.date) %>% tally()

 



 
   research.vt_plUC= visit_wk_site_edited %>%  filter( Site=="University of Chicago Medicine")
 research.vt_plUC <- research.vt_plUC %>% group_by(col.Monday.date) %>% mutate(total_collections = sum(n))
 research.vt_plotUC <- ggplot(research.vt_plUC, aes(x=as.Date(col.Monday.date), y=total_collections)) + #,fill=site, color=site)) +   #research.vt <-    ,fill=Site, color=Site
   geom_line() + geom_point(width = 0.2) +
   scale_y_continuous(name="Number of Collections") +
   scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-7),expand=c(0,0))  +
   scale_fill_brewer(palette="Dark2") +
   ggtitle(label="Figure 6.5: Baseline- Weekly Biospecimen Collections, \n University of Chicago Medicine") +
   theme(panel.background = element_blank(),
         #legend.title = element_text(size=7),
         axis.line = element_line(size=0.2),
         axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) ,  #, face = "bold"
         axis.title.y = element_text(size = 14,color="black"),   #, face = "bold"
         plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) #guides(fill=guide_legend(nrow=2,byrow=TRUE))
 print(research.vt_plotUC)

 
    visit_wk_site.hybridUC= visit_wk_site.hybrid %>%  filter( Site=="University of Chicago Medicine")
    visit_wk_site.hybrid_UC <- visit_wk_site.hybridUC %>%  group_by(Setting, col.Monday.date) %>%  summarise(totals=sum(n))
 clinical.vt_plotUC <- ggplot(visit_wk_site.hybrid_UC, aes(x=as.Date(col.Monday.date), y=totals, color=Setting )) + 
   geom_line() + geom_point(width = 0.2) +
   scale_y_continuous(name="Number of Collections") +
   scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-7),expand=c(0,0))  +
   scale_color_manual(values=c("Clinical"="#164C71", "Research"="#FDBE19")) +
   ggtitle(label="Figure 6.6: Baseline- Weekly Biospecimen Collections by Collection Setting, \n University of Chicago Medicine") +
   labs(color = "Collection Setting") +
   theme(panel.background = element_blank(),
         legend.position = "bottom",
         axis.line = element_line(size=0.2),
         axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) ,  #, face = "bold"
         axis.title.y = element_text(size = 14,color="black"),   #, face = "bold"
         plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) #guides(fill=guide_legend(nrow=2,byrow=TRUE))
 print(clinical.vt_plotUC)
 
 
 research.vt_plUC= visit_wk_site_edited %>%  filter( Site=="University of Chicago Medicine")
 research.vt_plotUC <- ggplot(research.vt_plUC, aes(x=as.Date(col.Monday.date), y=n, color=Site_location)) + #,fill=site, color=site)) +   #research.vt <-    ,fill=Site, color=Site
   geom_line() + geom_point(width = 0.2) +
   scale_y_continuous(name="Number of Collections") +
   scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-7),expand=c(0,0))  +
     scale_color_manual(values=c("Ingalls Harvey"="#B1C7D9", "Orland Park"="#2973A5", "River East"="#FDBE19", 
                              "South Loop"="#565C65", "UC-DCAM"="#3C989E", "UCM Pop-Up"="#CC7D15"),
                        guide = guide_legend(nrow = 2, byrow = TRUE)) +
   ggtitle(label="Figure 6.7: Baseline- Weekly Research Biospecimen Collections \n by Collection Location, University of Chicago Medicine ") +
   labs(color = "Collection Location") +
   theme(panel.background = element_blank(),
         legend.position = "bottom",
         axis.line = element_line(size=0.2),
         axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) ,  #, face = "bold"
         axis.title.y = element_text(size = 14,color="black"),   #, face = "bold"
         plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) 
research.vt_plotUC + guides(color = guide_legend(title = "Collection Location")) 
 
 


 clinical.vt_plUC_locations <- clinic.survey %>% filter(Site=="University of Chicago Medicine") %>%
  mutate(UC_cl_locs = case_when(d_173836415_d_266600170_d_185243482==1 | d_173836415_d_266600170_d_452847912==1 ~ "South Loop",
                             d_173836415_d_266600170_d_185243482==2 | d_173836415_d_266600170_d_452847912==2 ~ "Orland Park",
                             d_173836415_d_266600170_d_185243482==3 | d_173836415_d_266600170_d_452847912==3 ~ "Kenwood",
                             d_173836415_d_266600170_d_185243482==4 | d_173836415_d_266600170_d_452847912==4 ~ "River East",
                             d_173836415_d_266600170_d_185243482==5 | d_173836415_d_266600170_d_452847912==5 ~ "Dearborn Station"))
edited_fig11_1_Clin_tally <- clinical.vt_plUC_locations %>% arrange(UC_cl_locs, col.Sunday.week,col.Monday.date) %>% group_by(UC_cl_locs, col.Sunday.week,col.Monday.date) %>% tally()

clinical.vt_plotUC_locs <- ggplot(edited_fig11_1_Clin_tally, aes(x=as.Date(col.Monday.date), y=n, color=UC_cl_locs)) +  
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="Number of Collections", limit= c(0, max(edited_fig11_1_Clin_tally$n))) +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2024-05-20"),as.Date(currentDate)-7),expand=c(0,0))  +
  scale_color_manual(values=c("Orland Park"="#2973A5", "River East"="#FDBE19", 
                              "South Loop"="#565C65", "Kenwood"="#3C989E", "Dearborn Station"="#CC7D15")) +
  ggtitle(label="Figure 6.8: Baseline- Weekly Clinical Biospecimen Collections by Clinic Location, \n University of Chicago Medicine") +
  labs(color = "Clinic Location") +
  theme(panel.background = element_blank(),
        #legend.title = element_text(size=7),
        legend.position = "bottom",
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) ,  
        axis.title.y = element_text(size = 14,color="black"),   
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) #guides(fill=guide_legend(nrow=2,byrow=TRUE))
clinical.vt_plotUC_locs + guides(color = guide_legend(title = "Clinic Location")) 
 
 
 

research.vt_plMF= visit_wk_site_edited %>%  filter( Site=="Marshfield Clinic Health System")
research.vt_plMF <- research.vt_plMF %>% group_by(col.Monday.date) %>% mutate(total_collections = sum(n))

research.vt_plotMF <- ggplot(research.vt_plMF, aes(x=as.Date(col.Monday.date), y=total_collections)) + #,fill=site, color=site)) +   #research.vt <-    ,fill=Site, color=Site
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="Number Collections") +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),(as.Date(currentDate)-7)),expand=c(0,0))  +
  scale_fill_brewer(palette="Dark2") +
  ggtitle(label="Figure 6.9 Baseline- Weekly Biospecimen Collections, \n Marshfield Clinic Health System") +
  theme(panel.background = element_blank(),
        #legend.title = element_text(size=7),
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) ,  
        axis.title.y = element_text(size = 14,color="black"),   
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) 
print(research.vt_plotMF)

 
 
research.vt_plMF1= visit_wk_site_edited %>%  filter( Site=="Marshfield Clinic Health System")
research.vt_plotMF1 <- ggplot(research.vt_plMF1, aes(x=as.Date(col.Monday.date), y=n, color=Site_location)) +
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="Number Collections") +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),(as.Date(currentDate)-7)),expand=c(0,0))  +
  #scale_fill_brewer(palette="Dark2") +
  scale_color_manual(values=c("Lake Hallie"="#B1C7D9", "Marshfield"="#164C71", "MF Pop-Up"="#FDBE19", 
                              "Minocqua"="#565C65", "Weston"="#3C989E", "Wisconsin Rapids"="#CC7D15"),
                     guide = guide_legend(nrow = 2, byrow = TRUE)) +
  ggtitle(label="Figure 6.10: Baseline- Weekly Research Biospecimen Collections \n by Collection Location, Marshfield Clinic Health System") +
  theme(panel.background = element_blank(),
        #legend.title = element_text(text="Site Location"),
        legend.position = "bottom",
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) ,  #, face = "bold"
        axis.title.y = element_text(size = 14,color="black"),   
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) 
research.vt_plotMF1 + guides(color = guide_legend(title = "Collection Location")) 

```




```{r Figures19_20, eval=TRUE,echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 



research.vt_plSH= visit_wk_site_edited %>%  filter( Site=="Sanford Health")
research.vt_plotSH <- ggplot(research.vt_plSH, aes(x=as.Date(col.Monday.date), y=n)) + 
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="Number of Collections") +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-7),expand=c(0,0))  +
  scale_fill_brewer(palette="Dark2") +
  ggtitle(label="Figure 6.11: Baseline- Weekly Biospecimen Collections, \n Sanford Health") +
  labs(color = "Collection Location") +
  theme(panel.background = element_blank(),
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) ,  #, face = "bold"
        axis.title.y = element_text(size = 14,color="black"),   #, face = "bold"
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) #guides(fill=guide_legend(nrow=2,byrow=TRUE))
print(research.vt_plotSH)


visit_wk_site.hybridSF= visit_wk_site.hybrid %>%  filter( Site=="Sanford Health")
new_SF_plot <- ggplot(visit_wk_site.hybridSF, aes(x=as.Date(col.Monday.date), y=n, color=Setting )) +
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="# Number Collections") +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),(as.Date(currentDate)-7)),expand=c(0,0))  +
  scale_color_manual(values=c("Clinical"="#164C71", "Research"="#FDBE19")) +
  ggtitle(label=paste("Figure 6.12 Baseline- Weekly Biospecimen Collections by Collection Setting \n  Sanford Health")) +
  theme(panel.background = element_blank(),
        #legend.title = element_text(size=7),
        legend.position = "bottom",
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) ,  #, face = "bold"
        axis.title.y = element_text(size = 14,color="black"),   #, face = "bold"
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) #guides(fill=guide_legend(nrow=2,byrow=TRUE))
print(new_SF_plot)



research.vt_plSH= visit_wk_site_edited %>%  filter( Site=="Sanford Health")
research.vt_plotSH <- ggplot(research.vt_plSH, aes(x=as.Date(col.Monday.date), y=n, color=Site_location)) + 
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="Number Collections") +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),(as.Date(currentDate)-7)),expand=c(0,0))  +
  scale_color_manual(values=c("Fargo South University"="#3C989E", "Sioux Falls Imagenetics"="#CC7D15")) + 
  ggtitle(label="Figure 6.13: Baseline- Weekly Research Biospecimen Collections \n by Collection Location, Sanford Health") +
  theme(panel.background = element_blank(),
        legend.position = "bottom",
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) , 
        axis.title.y = element_text(size = 14,color="black"),   
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) 
research.vt_plotSH + guides(color = guide_legend(title = "Collection Location")) 




research.vt_plHP= visit_wk_site.hybrid %>%  filter( Site=="HealthPartners")
research.vt_plotHP <- ggplot(research.vt_plHP, aes(x=as.Date(col.Monday.date), y=n, color=Setting)) + 
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="Number of Collections") + 
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-7),expand=c(0,0))  +
  scale_color_manual(values=c("Clinical"="#164C71", "Research"="#FDBE19")) +
  ggtitle(label="Figure 6.14: Baseline- Weekly Biospecimen Collections \n by Collection Setting, HealthPartners") +
  labs(color = "Collection Setting") +
  theme(panel.background = element_blank(),
        legend.position = "bottom",
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) , 
        axis.title.y = element_text(size = 14,color="black"),  
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold"))
print(research.vt_plotHP)




research.vt_plHP_locations <- clinic.survey %>% filter(Site=="HealthPartners") %>%
  filter(d_173836415_d_266600170_d_185243482==1 | d_173836415_d_266600170_d_452847912==1 | d_173836415_d_266600170_d_185243482==2 |
           d_173836415_d_266600170_d_452847912==2 | d_173836415_d_266600170_d_185243482==3 | d_173836415_d_266600170_d_452847912==3) %>%
  mutate(HP_cl_locs = case_when(d_173836415_d_266600170_d_185243482==1 | d_173836415_d_266600170_d_452847912==1 ~ "NSC",
                             d_173836415_d_266600170_d_185243482==2 | d_173836415_d_266600170_d_452847912==2 ~ "Elk River",
                             d_173836415_d_266600170_d_185243482==3 | d_173836415_d_266600170_d_452847912==3 ~ "Chanhassen"))
edited_fig11_1_Clin_tally <- research.vt_plHP_locations %>% arrange(HP_cl_locs, col.Sunday.week,col.Monday.date) %>% group_by(HP_cl_locs, col.Sunday.week,col.Monday.date) %>% tally()

research.vt_plotHP_locs <- ggplot(edited_fig11_1_Clin_tally, aes(x=as.Date(col.Monday.date), y=n, color=HP_cl_locs)) +  
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="Number of Collections", breaks = seq(min(edited_fig11_1_Clin_tally$n), max(edited_fig11_1_Clin_tally$n), by = 1)) + #, limits=c(0,30), breaks=seq(0,30,5)) +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2023-11-20"),as.Date(currentDate)-7),expand=c(0,0))  +
  scale_color_manual(values=c("NSC"="#99C0C4", "Elk River"="#565C65", "Chanhassen"="#CC7D15")) +
  ggtitle(label="Figure 6.15: Baseline- Weekly Clinical Biospecimen Collections \n  by Clinic Location, HealthPartners ") +
  labs(color = "Clinic Location") +
  theme(panel.background = element_blank(),
        legend.position = "bottom",
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) , 
        axis.title.y = element_text(size = 14,color="black"), 
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) 
research.vt_plotHP_locs + guides(color = guide_legend(title = "Clinic Location")) 


```



```{r AdHoc1, eval=TRUE,echo=FALSE, warning=FALSE, include=FALSE}
Orland_ad_hoc <- research.vt_plUC %>% filter(as.Date(col.Monday.date)>="2023-12-11" & Site_location=="Orland Park")

 Orland_adhoc <- Orland_ad_hoc[,c(5,6)]

sorted_adhoc <- Orland_adhoc %>%
  arrange(col.Monday.date)

total_sum <- sum(sorted_adhoc$n, na.rm = TRUE)

# Create a new row with the total sum
sorted_adhoc$col.Monday.date <- as.character(sorted_adhoc$col.Monday.date)


# Convert col.Monday.date to character for the new row
total_row <- data.frame(col.Monday.date = as.character("Total"), n = total_sum)

# Bind the total row to the original dataframe
sorted_adhoc_with_total <- bind_rows(sorted_adhoc, total_row)

colnames(sorted_adhoc_with_total) <- c("Week", "Collection Count")

#print(sorted_adhoc_with_total)


OrlandAH_totals <- as.data.frame(sorted_adhoc_with_total)
OrlandAH <- OrlandAH_totals[-1, ]

knitr::kable(OrlandAH, caption='Ad Hoc UChicago Orland Park Visit Count Per Week', row.names=FALSE,align=c("l","c"), booktabs = TRUE)  %>% kable_styling(latex_options = "HOLD_position")
```





```{r Fig21_24, eval=TRUE,echo=FALSE}
 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 


clc_both_vt.site.CO
clc_both_vt.site.GA
clc_both_vt.site.HI
clc_both_vt.site.NW

```

\newpage

# Baseline Home Mouthwash Collections

\vspace{-0.5em}




 

```{r HomeMW_DataPull, include=FALSE, echo=FALSE, warning=FALSE}
#not dead of wd or refused
kitstatus <- "SELECT Connect_ID, d_173836415_d_266600170_d_319972665_d_379252329, d_173836415_d_266600170_d_319972665_d_221592017, d_173836415_d_266600170_d_319972665_d_661940160, d_265193023, d_547363263, d_173836415_d_266600170_d_448660695, d_195145666, d_286191859, d_123868967, d_906417725, d_747006172, d_987563196, d_167958071, d_878865966, d_684635302, d_827220437, d_173836415_d_266600170_d_915179629, d_914594314, d_173836415_d_266600170_d_982213346,d_173836415_d_266600170_d_139245758, d_265193023, d_253883960, d_173836415_d_266600170_d_319972665_d_826941471 
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` where Connect_ID IS NOT NULL and d_906417725='104430631'  and d_747006172='104430631' and 
d_987563196='104430631'"
kitstatus_table <- bq_project_query(project, kitstatus)
kit_table <- bq_table_download(kitstatus_table, bigint="integer64",n_max = Inf, page_size = 10000)
kit_table$Connect_ID <- as.numeric(kit_table$Connect_ID)



kitdate <- "SELECT Connect_ID, d_143615646_d_826941471, d_650516960, d_820476880, d_678166505 FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.biospecimen_JP`
where Connect_ID is not null and d_820476880 LIKE 'CHA%'"
kitdate_table <- bq_project_query(project, kitdate)
kit_data <- bq_table_download(kitdate_table, bigint="integer64",n_max = Inf, page_size = 10000)
kit_data$Connect_ID <- as.numeric(kit_data$Connect_ID)




kit_table <- kit_table %>%  mutate(Site = case_when(d_827220437==125001209 ~ "Kaiser Permanente Colorado",
                                                  d_827220437==327912200 ~ "Kaiser Permanente Georgia",
                                                  d_827220437==300267574 ~ "Kaiser Permanente Hawaii",
                                                  d_827220437==452412599 ~ "Kaiser Permanente Northwest",
                                                  d_827220437==657167265 ~ "Sanford Health",
                                                  d_827220437==548392715 ~ "Henry Ford Health System",
                                                  d_827220437==531629870 ~ "HealthPartners",
                                                  d_827220437==303349821 ~ "Marshfield",
                                                  d_827220437==809703864 ~ "University of Chicago Medicine",
                                                  d_827220437==472940358 ~ "Baylor Scott and White Health"),
                                 Kit_Status = case_when(#d_173836415_d_266600170_d_319972665_d_221592017==517216441	~"Pending", -- no one will have this
                                         d_173836415_d_266600170_d_319972665_d_221592017==849527480	~"Address Printed",
                                         d_173836415_d_266600170_d_319972665_d_221592017==241974920	~ "Assigned",
                                         d_173836415_d_266600170_d_319972665_d_221592017==277438316	~ "Shipped",
                                         d_173836415_d_266600170_d_319972665_d_221592017==375535639	~ "Received",
                                         is.na(d_173836415_d_266600170_d_319972665_d_221592017) ~ "No Status"))

kit_table$Kit_Status<- factor(kit_table$Kit_Status,levels=c("No Status", "Address Printed", "Assigned", "Shipped", "Received"))

kit_date <- left_join( kit_data, kit_table,  by="Connect_ID")

kitassembly <- "SELECT * FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.kitAssembly_JP` where Connect_ID IS NOT NULL"
kitassembly_table <- bq_project_query(project, kitassembly)
kitassembly_data <- bq_table_download(kitassembly_table, bigint="integer64",n_max = Inf, page_size = 10000)
kitassembly_data$Connect_ID <- as.numeric(kitassembly_data$Connect_ID)
kit_assembly <- left_join(kitassembly_data, kit_table, by="Connect_ID")
```

 

```{r retry7.1, include=FALSE, echo=FALSE, warning=FALSE}


kitsetting <- "SELECT Connect_ID, d_650516960, d_678166505,d_143615646_d_826941471  FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.biospecimen_JP`
where Connect_ID is not null "
kitsetting_table <- bq_project_query(project, kitsetting)
kit_set <- bq_table_download(kitsetting_table, bigint="integer64",n_max = Inf, page_size = 10000)
kit_set$Connect_ID <- as.numeric(kit_set$Connect_ID)


location_stat <- kit_table %>%  select(Connect_ID, Kit_Status, d_173836415_d_266600170_d_319972665_d_661940160, d_173836415_d_266600170_d_982213346,
                                       d_173836415_d_266600170_d_139245758, Site)
kit_sett <- left_join(location_stat, kit_set,   by="Connect_ID") #%>% left_join(recrver1,  by="Connect_ID")

#"Eligible participants are those who had a clinical collection with blood or urine collected on or after March 29, 2024, and did not refuse, withdraw, or pass away prior to March 29, 2024. Home mouthwash collections were launched for eligible participants in March 29, 2024. Home mouthwash collections for backlog collections (before March 29, 2024) will be launched at a later date.

table27_elg <- kit_sett %>% filter((d_173836415_d_266600170_d_982213346>=as.Date("2024-03-29") & d_173836415_d_266600170_d_139245758>=as.Date("2024-03-29")))


#table27_elg$Site<- droplevels(table27_elg$Site)
table27_elg<- table27_elg %>%  filter(Kit_Status!="Unknown")

#Removing duplicates 
table27_elg_distinct <- table27_elg %>%
     distinct(Connect_ID, .keep_all = TRUE)


#clinical blood or urine given after 4/1/24
status_elg <- table27_elg_distinct %>%  
  distinct(Connect_ID, .keep_all = TRUE) %>%
  tbl_cross(
    row = Site,
    col = Kit_Status,
    digits=c(0,1),
    percent = "row",
    label=list(Site="Site",
               Kit_Status = "Kit Status"),
    missing="ifany",
    margin_text="Total Eligible") 


status_elg_kn <- status_elg %>%
  modify_header(stat_0 = "Total") %>%
  modify_caption("Table 7.1:  Baseline- Home Mouthwash Kit Status Among Eligible Participants") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE) %>%  kable_styling(latex_options = "scale_down") 

 
```



```{r Table_new_7.2, include=FALSE, echo=FALSE, warning=FALSE,results='hold'}

filtered_data <- filter(table27_elg_distinct, Kit_Status %in% c("Received", "Shipped"))

summary_table <- filtered_data %>%
  group_by(Site) %>%
  summarise(Received = sum(Kit_Status == "Received"),
            Shipped = sum(Kit_Status %in% c("Received", "Shipped")))

all_shipped <- summary_table[,c(1,3,2)]

colnames(all_shipped) <- c("Site", "Shipped", "Received")

#Adding total shipped as of a week ago column
summary_table2 <- filtered_data %>% filter(as.Date(d_173836415_d_266600170_d_319972665_d_661940160)< (as.Date(currentDate) -7)) %>% 
    group_by(Site) %>%
    summarise(Shipped_OneWeek = n())

all_shipped[,4] <- summary_table2$Shipped_OneWeek
colnames(all_shipped) <- c("Site", "Shipped", "Received", "Shipped_OneWeek")

 

all_shipped$Received <- as.numeric(all_shipped$Received)
all_shipped$Shipped <- as.numeric(all_shipped$Shipped)
all_shipped$Shipped <- as.numeric(all_shipped$Shipped_OneWeek)


total_shipped <- sum(all_shipped$Shipped)
total_received <- sum(all_shipped$Received)
total_ship_previous_week <- sum(all_shipped$Shipped_OneWeek)
total_received_percentage <- paste(total_received, "(", round(total_received/total_ship_previous_week*100, digits = 1), "%)")
total_row <- c("Total", total_shipped, total_received,total_ship_previous_week)

# Create a new data frame for the "Total" row
total_df <- data.frame(t(total_row), stringsAsFactors = FALSE)

# Set column names
colnames(total_df) <- colnames(all_shipped)

# Append the "Total" row to all_shipped
all_shipped2 <- rbind(all_shipped, total_df)


# Calculate percentages
for(i in 1:nrow(all_shipped2)){
  all_shipped2[i,"Received"] <- paste0(all_shipped2[i,"Received"], " (", round(as.numeric(all_shipped2[i,"Received"])/as.numeric(all_shipped2[i,"Shipped_OneWeek"])*100, digits = 1), "%)")
}

all_shipped2 <- all_shipped2[,c(1,2,4,3)]
  
colnames(all_shipped2) <- c("Site", "Total Shipped", "Total Shipped up to 1 week ago", "Received")
all_shipped2

```



```{r new_Figs7.3, include=FALSE, echo=FALSE, warning=FALSE}


fig7_1 <- ggplot(all_shipped, aes(x = Site)) +
  geom_bar(aes(y = Shipped_OneWeek, fill = "Shipped"), stat = "identity", width=0.8) +
  geom_bar(aes(y = Received, fill = "Received"), stat = "identity", width=0.8) +
  scale_fill_manual(values = c("Shipped" = "#FDBE19", "Received" = "#164C71")) +
  labs(x = NULL, y = "Counts", fill = "") +
  theme_minimal() +
  theme(legend.position = "right",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.text.x = element_text(angle = 5, vjust = 0.5, hjust=1, size = 7),
        axis.line = element_line(color = "black", size = 0.5)) +
  ggtitle("Figure 7.1. Baseline- Total Kits Received of Total Kits Shipped Up To 1 Week Ago, \n by Site")





```


```{r Table7.3_7.6, include=FALSE, echo=FALSE, warning=FALSE}


#Table 7.3
  #before
all_completed <- left_join(table27_elg_distinct,kit_assembly, by=c("Connect_ID", "Site",  "Kit_Status", "d_173836415_d_266600170_d_319972665_d_661940160")) 
all_completed_before <- all_completed %>%  filter(d_173836415_d_266600170_d_319972665_d_661940160 < as.Date("2024-06-17"))
all_completed_after <- all_completed %>%  filter(d_173836415_d_266600170_d_319972665_d_661940160 > as.Date("2024-06-17"))

Coll_Card_Table <- all_completed_before %>% filter(d_173836415_d_266600170_d_319972665_d_221592017 ==375535639) %>% 
            mutate(Card_Status = case_when(d_137401245==353358909	~"Collection Card Not Included",
                                         TRUE ~ "Collection Card Included"))

Coll_Card_StatusBF <- Coll_Card_Table %>% dplyr::select(Site, Card_Status )  %>% tbl_cross(
  row = Site,
  col = Card_Status, 
  digits=c(0,1),
  percent = "row",
  label=list(Site ~ "Site", Card_Status ~ " "),
  missing="ifany",
  missing_text="0 (0%") %>%
  modify_header() %>%
  modify_caption("Table 7.3: Baseline- Home Mouthwash Kit Return Rate for Packages Shipped \n up to 1 Week Ago (kits shipped before 6/17/2024)") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)

  #after
 
Coll_Card_Table <- all_completed_after %>% filter(d_173836415_d_266600170_d_319972665_d_221592017 ==375535639) %>% 
            mutate(Card_Status = case_when(d_137401245==353358909	~"Collection Card Not Included",
                                         TRUE ~ "Collection Card Included"))

Coll_Card_StatusAF <- Coll_Card_Table %>% dplyr::select(Site, Card_Status )  %>% tbl_cross(
  row = Site,
  col = Card_Status,
  digits=c(0,1),
  percent = "row",
  label=list(Site ~ "Site", Card_Status ~ " "),
  missing="ifany",
  missing_text="0 (0%") %>%
  modify_header() %>%
  modify_caption("Table 7.4: Baseline- Home Mouthwash Kit Return Rate for Packages Shipped \n up to 1 Week Ago (kits shipped after 6/17/2024)") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)



#Table 7.4
#d_265193023==231311385 --- had to remove, no one finished yet

test30 <- table27_elg %>%  filter(!is.na(d_143615646_d_826941471) & !is.na(d_173836415_d_266600170_d_319972665_d_661940160)) 

test30 <-  test30 %>% mutate(ctime = as.numeric(difftime(as.POSIXct(ymd_hms(d_143615646_d_826941471)),as.POSIXct(ymd_hms(d_173836415_d_266600170_d_319972665_d_661940160)),units="days")))

test30before <-  test30 %>%  filter(ctime>0 & d_173836415_d_266600170_d_319972665_d_661940160 < as.Date("2024-06-17"))

Table7.4before = test30before %>% group_by(Site) %>% 
  dplyr::summarize(N=n(),
                   Min = min(ctime),
                   Q1 = quantile(ctime, 0.25),
                   Median = median(ctime),
                   Mean = mean(ctime),
                   #SD=sd(ctime),
                   Q3 = quantile(ctime, 0.75),
                   #Perc.95= quantile(ctime, 0.95),
                   Max = max(ctime))

test30after <-  test30 %>%  filter(ctime>0 & d_173836415_d_266600170_d_319972665_d_661940160 > as.Date("2024-06-17"))

Table7.4after = test30after %>% group_by(Site) %>%
  dplyr::summarize(N=n(),
                   Min = min(ctime),
                   Q1 = quantile(ctime, 0.25),
                   Median = median(ctime),
                   Mean = mean(ctime),
                   #SD=sd(ctime),
                   Q3 = quantile(ctime, 0.75),
                   #Perc.95= quantile(ctime, 0.95),
                   Max = max(ctime))



#Table 7.5
firstcoltime <- tube_col %>% select(Connect_ID, collection.tm)
first_col_time <- left_join(table27_elg_distinct, firstcoltime, by=c("Connect_ID", "Site"))
test31 <- first_col_time %>%  filter(!is.na(collection.tm) & !is.na(d_173836415_d_266600170_d_319972665_d_661940160)) 
test31 <-  test31 %>% mutate(ctime = as.numeric(difftime(as.POSIXct(ymd_hms(d_173836415_d_266600170_d_319972665_d_661940160)),
                                                         min(as.POSIXct(ymd_hms(collection.tm))),units="days")))
test31b <-  test31 %>%  filter(ctime>0) 


Table7.5 = test31b %>% group_by(Site) %>% 
  dplyr::summarize(N =n(),
                   Min = min(ctime),
                   Q1 = quantile(ctime, 0.25),
                   Median = median(ctime),
                   Mean = mean(ctime),
                   #SD=sd(ctime),
                   Q3 = quantile(ctime, 0.75),
                   #Perc.95= quantile(ctime, 0.95),
                   Max = max(ctime))


#Table 32



 conditions <- all_completed[,c("Connect_ID","d_173836415_d_266600170_d_319972665_d_221592017", "d_633640710_d_950521660", "d_633640710_d_545319575", "d_633640710_d_938338155", "d_633640710_d_205954477",
                       "d_633640710_d_289239334","d_633640710_d_992420392","d_633640710_d_541085383","d_633640710_d_427719697", "d_633640710_d_100618603")]
 conds <- c("d_633640710_d_950521660", "d_633640710_d_545319575", "d_633640710_d_938338155", "d_633640710_d_205954477", "d_633640710_d_289239334","d_633640710_d_992420392",
           "d_633640710_d_541085383","d_633640710_d_427719697", "d_633640710_d_100618603")
 conditions$conditions <- 0
 conditions$none <-0
 for(i in 1:length(conds)){
   condition <- conditions[,conds[i]]
   count <- ifelse((!is.na(condition) & condition ==353358909), 1, 0)
   conditions$conditions <- count+conditions$conditions
   count1 <- ifelse((!is.na(condition) & condition==104430631), 1, 0)
   conditions$none <- count1+conditions$none
 }

 all_completed <- all_completed %>%
   mutate(multi_cond = 0)  # Initialize the multi_cond column with zeros

 # Filter columns based on pattern
 columns_to_sum <- colnames(all_completed)[grepl("d_633640710_d_", colnames(all_completed))]

 # Loop through each column and apply the operation
 for (col in columns_to_sum) {
   all_completed <- all_completed %>%
     mutate(multi_cond = ifelse(.data[[col]] == 353358909, 1, 0) + .data$multi_cond)
 }

 if(dim(table(all_completed$multi_cond))==0){multi_cond==0}
 
 
 
 all_completed <- all_completed %>%
  mutate(multc1 = 0)  # Initialize the multc1 column with zeros

# Filter columns based on pattern
columns_to_sum <- colnames(all_completed)[grepl("d_633640710_d_", colnames(all_completed))]

# Loop through each column and apply the operation
for (col in columns_to_sum) {
  all_completed <- all_completed %>%
    mutate(multc1 = ifelse(.data[[col]] == 1, 1, 0) + .data$multc1)
}


table_32 <- all_completed %>% filter(d_173836415_d_266600170_d_319972665_d_221592017==375535639) %>%  
  mutate(kit_condition = case_when(multc1>1 & d_633640710_d_950521660!=353358909 ~ "Two of More Conditions Selected", #-- right now no one with multiple selected
                                   #d_633640710_d_950521660==353358909 ~ "Package in Good Conditon",
                                   d_633640710_d_545319575==353358909 ~ "Package Crushed",
                                   d_633640710_d_938338155==353358909 ~ "Improper Packaging",
                                   d_633640710_d_205954477==353358909 ~ "Collection Cup Damaged",
                                   d_633640710_d_289239334==353358909 ~ "Collection Cup Leaked",
                                   d_633640710_d_992420392==353358909 ~ "Empty Cup Returned",
                                   d_633640710_d_541085383==353358909 ~ "Incorrect Collection Type Returned",
                                   d_633640710_d_427719697==353358909 ~ "Collection Cup Not Returned",
                                   d_633640710_d_950521660==353358909 ~ "Package in Good Conditon",
                                   d_633640710_d_100618603==353358909 ~ "Other",
                                   TRUE ~ "No Conditions Selected"))


table__32 <- table_32 %>% select(kit_condition) %>%  group_by(kit_condition) %>%  tally()


table__32$Percentage <- paste0(
  table__32$n,
  " (",
  sprintf("%.0f%%", (table__32$n / sum(table__32$n)) * 100),
  ")"
)

db <- dim(table__32)[[1]]
table__32[(db+1),2] <- sum(table__32$n)
table__32[(db+1),1] <- "Total"
table__32[nrow(table__32),3] <- paste(table__32$n[nrow(table__32)], " (100%)")



table32_pct <- table__32[,c(1,3)]

colnames(table32_pct) <- c("Condition", "Total Received Kits")

table32_pct


```



\FloatBarrier

```{r FigMW1, include=FALSE, echo=FALSE, warning=FALSE}


#NOTE: MUST change currentDate to Mondays date in order for this to run correctly when testing for fixes
#currentDate= recent Monday date

##Received 
kit_set_col_1 <- kit_set %>% select(Connect_ID, d_143615646_d_826941471)

kit_set_col_1$col.Sunday.week <- ceiling(as.numeric(difftime(kit_set_col_1$d_143615646_d_826941471,as.Date(veristart.date-days(2)),units="days"))/7)
kit_set_col_1$col.Sunday.date <- veristart.date + days(5) + dweeks(kit_set_col_1$col.Sunday.week-1) 
kit_set_col_1$col.Monday.date <- kit_set_col_1$col.Sunday.date-days(6)

kit_fig_1 <- inner_join(kit_set_col_1,kit_table,   by="Connect_ID")

fig5_new_1 <- kit_fig_1 %>%
     filter(d_173836415_d_266600170_d_319972665_d_379252329 == 976461859 & as.Date(col.Monday.date) >= "2024-03-29" & as.Date(col.Monday.date) < currentDate)


fig5_week_total_1 <- fig5_new_1 %>%
  group_by(col.Monday.date) %>% 
  summarise(total_received = sum(!is.na(d_143615646_d_826941471)))

# Create a data frame with all Mondays from April 1st, 2024, until today
all_mondays <- data.frame(col.Monday.date = seq(as.Date("2024-04-01"), currentDate-7, by = "week"))


fig5_week_total_1 <- left_join(all_mondays, fig5_week_total_1, by = "col.Monday.date") %>%
  mutate(total_received = replace(total_received, is.na(total_received), 0))




kit_table$col.Sunday.week <- ceiling(as.numeric(difftime(kit_table$d_173836415_d_266600170_d_319972665_d_661940160,as.Date(veristart.date-days(2)),units="days"))/7)
kit_table$col.Sunday.date <- veristart.date + days(5) + dweeks(kit_table$col.Sunday.week-1) 
kit_table$col.Monday.date <- kit_table$col.Sunday.date-days(6)


fig5_new_2 <- kit_table %>%
     filter(d_173836415_d_266600170_d_319972665_d_379252329 == 976461859 & as.Date(col.Monday.date) >= "2024-03-29" & as.Date(col.Monday.date) < currentDate) 

fig5_week_total_2 <- fig5_new_2 %>%
  group_by(col.Monday.date) %>%
  summarise(total_shipped = sum(!is.na(d_173836415_d_266600170_d_319972665_d_661940160)))


fig5_week_total_2 <- left_join(all_mondays, fig5_week_total_2, by = "col.Monday.date") %>%
  mutate(total_shipped = replace(total_shipped, is.na(total_shipped), 0))



fig5_week_final <- fig5_week_total_1

fig5_week_final[,3] <- fig5_week_total_2[,2]

colnames(fig5_week_final) <- c("col.Monday.date", "total_received", "total_shipped")



MW_Coll_Kits <- ggplot(fig5_week_final, aes(x = as.Date(col.Monday.date))) +
  geom_line(aes(y = total_shipped, color = "Total Shipped"), linetype = "dashed", size = 1) +
  geom_line(aes(y = total_received, color = "Total Received"), linetype = "dashed", size = 1) +
  geom_point(aes(y = total_shipped, color = "Total Shipped"), size = 2) +
  geom_point(aes(y = total_received, color = "Total Received"), size = 2) +
  scale_y_continuous(name = "Number of Kits") +
  scale_x_date(name = "Date", date_labels = "%y-%m-%d", date_breaks = "2 weeks",
               limits = c(as.Date("2024-03-25"), as.Date(currentDate-7)), expand = c(0,0)) +
  scale_color_manual(values = c("Total Received" = "#565C65", "Total Shipped" = "#CC7D15")) +
  scale_linetype_manual(values = "dashed", name = "") +
  ggtitle(label = "Figure 7.2: Baseline- Weekly Shipped and Received Baseline Home \n Mouthwash Kits") +
  labs(color = "Kit Status") +
  theme(panel.background = element_blank(),
        legend.title = element_text(size = 8),
        legend.position = "bottom",
        axis.line = element_line(size = 0.2),
        axis.text.x = element_text(angle = 60, hjust = 1),
        axis.title.x = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 14, face = "bold", color = "black"),
        plot.title = element_text(hjust = 0.5, size = 12, face = "bold")) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE))


```



```{r FigMW2, include=FALSE, echo=FALSE, warning=FALSE}


fig5_week_total2 <- fig5_week_final %>%
  arrange(col.Monday.date) %>%
  mutate(cumulative_shipped = cumsum(total_shipped),
         cumulative_received = cumsum(total_received))

fig5_week_total2 <- fig5_week_total2 %>%
  mutate(percentage_received_to_shipped = round(cumulative_received / cumulative_shipped * 100, digits=2))


#Percentage they want is the total received as of today/total shipped as of end of week prior
thus_far <- round(sum(all_shipped$Received)/sum(all_shipped$Shipped_OneWeek)*100, digits=2)


MW_overtime <- ggplot(fig5_week_total2, aes(x = as.Date(col.Monday.date))) +
  geom_ribbon(aes(ymin = 0, ymax = cumulative_shipped, fill = "Total Shipped"), alpha = 0.3) +
  geom_ribbon(aes(ymin = 0, ymax = cumulative_received, fill = "Return Rate"), alpha = 0.3) +
geom_text(data = fig5_week_total2 %>% filter(col.Monday.date == max(col.Monday.date)),
          aes(x = as.Date(col.Monday.date), 
              label = paste0(thus_far, "%")),
          y = thus_far, vjust = -0.5, hjust = 1.2,  color = "black",  size = 3) +
  scale_x_date(name = "Date", date_labels = "%y-%m-%d", date_breaks = "2 weeks",
               limits = c(as.Date("2024-03-25"), as.Date(currentDate-7)), expand = c(0,0)) +
  scale_y_continuous(name = "# Kits Shipped") +
  scale_fill_manual(name = "", values = c("Total Shipped" = "#CC7D15", "Return Rate" = "#0072B2")) +
  ggtitle(label = "Figure 7.3: Baseline Home Mouthwash Kit Return Rate \n for Kits Shipped Up To 1 Week Ago") +
  labs(caption = paste("Note: Shipped data are current through",as.Date(currentDate)-7, ".")) +
  theme(panel.background = element_blank(),
        legend.position = "bottom",
        axis.line = element_line(size = 0.2),
        axis.text.x = element_text(angle = 60, hjust = 1),
        axis.title.x = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 14, face = "bold", color = "black"),
        plot.title = element_text(hjust = 0.5, size = 12, face = "bold"))


```



\FloatBarrier
```{r newTables7.1,eval=TRUE,echo=FALSE,results='asis'} 
#results='asis'

add_footnote(status_elg_kn, "Note: Eligible participants are those who had a clinical collection with blood or urine collected on or after March 29, 2024, and did not refuse, withdraw, or pass away prior to April 2024. Home mouthwash collections were launched for eligible participants in April 2024. Home mouthwash collections for backlog collections (before April 2024) will be launched at a later date.", notation = "none") 
```



\FloatBarrier
```{r KnitrTables7.2,eval=TRUE,echo=FALSE,message=FALSE, results='asis'}

knitr::kable(all_shipped2,caption='Table 7.2 Baseline- Total Home Mouthwash Kit Return Rate for Packages Shipped up to 1 Week Ago',row.names=FALSE, align=c("l","c","c","c"),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "HOLD_position")

```

\FloatBarrier
```{r Fig7_1, eval=TRUE,echo=FALSE}
#fig.height = 5, fig.width = 5, 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 

fig7_1

```


\FloatBarrier
```{r Fig7_2, eval=TRUE,echo=FALSE}
#fig.height = 5, fig.width = 5, 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 

MW_Coll_Kits

```

\FloatBarrier
```{r Fig7_3, eval=TRUE,echo=FALSE}
#fig.height = 5, fig.width = 5, 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
MW_overtime

```

\FloatBarrier
```{r KnitrTables7.3_7.4,eval=TRUE,echo=FALSE,results='asis'}

before7.3 <- Coll_Card_StatusBF %>% kable_styling(latex_options = "HOLD_position")
add_footnote(before7.3, "Note: Kits were returned using USPS prior to 6/17/2024.", notation = "none")

#after7.4 <- Coll_Card_StatusAF %>% kable_styling(latex_options = "HOLD_position")
#add_footnote(after7.4, "Note: Kits were returned using FedEx after 6/17/2024.", notation = "none")

```



\FloatBarrier
```{r KnitrTables7.5_7.8,eval=TRUE,echo=FALSE,results='asis'}


#all these will move down a table number
table7.4before <- knitr::kable(Table7.4before,caption='Table 7.4: Baseline- Time (in Days) from Home Mouthwash Kit Shipment to BPTL Receipt \n (kits shipped before 6/17/2024)',row.names=FALSE, align=c("l","c","c","c","c","c","c"),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "HOLD_position")
add_footnote(table7.4before, "Note: Kits were returned using USPS prior to 6/17/2024.", notation = "none")

#table7.4after <- knitr::kable(Table7.4after,caption='Table 7.6: Baseline- Time (in Days) from Home Mouthwash Kit Shipment to BPTL Receipt \n (kits shipped before 6/17/2024)',row.names=FALSE, align=c("l","c","c","c","c","c","c"),digits=1, booktabs = TRUE) %>% kable_styling(latex_options = "HOLD_position")
#add_footnote(table7.4after, "Note: Kits were returned using FedEx after 6/17/2024.", notation = "none")

knitr::kable(Table7.5,caption='Table 7.5: Baseline- Time (in Days) from Clinical Collection to Home Mouthwash Kit Shipment',row.names=FALSE, align=c("l","c","c","c","c","c","c"),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "HOLD_position")

knitr::kable(table32_pct,caption='Table 7.6: Baseline- Kit Conditions Among Received Home Mouthwash Kits',row.names=FALSE, align=c("l","c"),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "HOLD_position")
```






\FloatBarrier

```{r Tables7.9_7.12, eval=TRUE,echo=FALSE,results='asis'}

table7_7 <- all_completed %>% filter(Kit_Status=="Shipped") %>%
  mutate(MWSrvy_status = case_when(d_547363263==972455046 ~ "Not Started",
                                   d_547363263==615768760 ~ "Started",
                                   d_547363263==231311385 ~ "Submitted")) %>%  
  mutate(MWSrvy_status = factor(MWSrvy_status, levels=c("Not Started","Started", "Submitted"))) %>% dplyr::select(Site, MWSrvy_status )  %>% 
  tbl_cross(
    row = Site,
    col = MWSrvy_status,
    digits=c(0,1),
    percent = "row",
    label=list(Site="Site",
                MWSrvy_status = " "),
    missing="ifany",
    margin_text="Total")

table7_7_totals <- as.data.frame(table7_7)
table7_7_totals <- table7_7_totals[c(-1),]


tab7_7 <- knitr::kable(table7_7_totals ,col.names=c("Site", "Not Started","Started","Submitted","Total Kits in 'Shipped' Status"), caption="Table 7.7: Baseline- Mouthwash Biospecimen Survey Status Among Mouthwash Kits in 'Shipped' Status", row.names=FALSE,align=c("l","c","c","c","c"), booktabs = TRUE)

num_rows <- nrow(table7_7_totals)
tab7_7 <- tab7_7 %>%
  row_spec(1:(num_rows - 1), extra_css = "text-indent: 20px;")

 kable_styling(tab7_7, latex_options = "scale_down")











table7_8 <- all_completed %>%  filter(Kit_Status=="Received") %>%
  mutate(MWSrvy_status = case_when(d_547363263==972455046 ~ "Not Started",
                                   d_547363263==615768760 ~ "Started",
                                   d_547363263==231311385 ~ "Submitted")) %>%  
  mutate(MWSrvy_status = factor(MWSrvy_status, levels=c("Not Started","Started", "Submitted"))) %>% dplyr::select(Site, MWSrvy_status )  %>% 
  tbl_cross(
    row = Site,
    col = MWSrvy_status,
    digits=c(0,1),
    percent = "row",
    label=list(Site="Site",
                MWSrvy_status = " "),
    missing="ifany",
    margin_text="Total")

table7_8_totals <- as.data.frame(table7_8)
table7_8_totals <- table7_8_totals[c(-1),]


tab7_8 <- knitr::kable(table7_8_totals ,col.names=c("Site", "Not Started","Started","Submitted","Total Received Kits"), caption='Table 7.8: Baseline- Mouthwash Biospecimen Survey Status Among Received Home Mouthwash Kits', row.names=FALSE,align=c("l","c","c","c","c"), booktabs = TRUE)  %>% kable_styling(latex_options = "scale_down")


num_rows <- nrow(table7_8_totals)
tab7_8 <- tab7_8 %>%
  row_spec(1:(num_rows - 1), extra_css = "text-indent: 20px;")

 kable_styling(tab7_8, latex_options = "scale_down")










#Before MW Survey description Fix

table7_9 <- all_completed %>% filter(Kit_Status=="Received" & d_137401245==104430631 &  as.Date(d_173836415_d_266600170_d_319972665_d_661940160)<"2024-05-22") %>%
  mutate(MWSrvy_status = case_when(d_547363263==972455046 ~ "Not Started",
                                   d_547363263==615768760 ~ "Started",
                                   d_547363263==231311385 ~ "Submitted"),
         MW_completion = difftime(as.Date(d_173836415_d_266600170_d_448660695),as.Date(d_195145666),units="days"),
         MW_comp_diff= case_when(MWSrvy_status!="Submitted" ~ "Not Submitted",
                                 #as.numeric(MW_completion) <-3 ~ "4+ Days before Collection",
                                 as.numeric(MW_completion) ==-3 ~ "3 Days before Collection",
                                 as.numeric(MW_completion) ==-2 ~ "2 Days before Collection",
                                 as.numeric(MW_completion) ==-2 ~ "1 Day before Collection",
                                 as.numeric(MW_completion)==0 ~ "Same Day as Collection",
                                 as.numeric(MW_completion)==1 ~ "1 Day after Collection",
                                 as.numeric(MW_completion)==2 ~ "2 Days after Collection",
                                 as.numeric(MW_completion)==3 ~ "3 Days after Collection",
                                 as.numeric(MW_completion)>=4 ~ "4+ Days after Collection",
                                 TRUE~"4+ Days before Collection")) %>%
  mutate(MW_comp_diff = factor(MW_comp_diff, levels=c("Not Submitted","4+ Days before Collection", "3 Days before Collection","2 Days before Collection","1 Day before Collection",
                                                      "Same Day as Collection","1 Day after Collection", "2 Days after Collection",
                                                      "3 Days after Collection", "4+ Days after Collection"))) %>% dplyr::select(Site, MW_comp_diff)  %>%
  tbl_cross(
    row = Site,
    col = MW_comp_diff,
    digits=c(0,1),
    percent = "row",
    label=list(Site="Site",
                MW_comp_diff = " "),
    missing="ifany",
    margin_text="Total")



tbl_7_9 <- table7_9 %>%
  #bold_labels() %>%
  #italicize_levels() %>%
  modify_header(stat_0 = "Total") %>%
  modify_caption("Table 7.9: Baseline- Mouthwash Biospecimen Survey Completion Time Relative to Collection Time Reported on Collection Card \n(Pre-update to survey description on PWA)") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE) %>%
  kable_styling(latex_options = "scale_down")


tbl_7_9 <- tbl_7_9 %>%
  footnote("Only includes data from mouthwash kits returned with completed Collection Card")

landscape(tbl_7_9)




#After MW Survey description Fix
table7_10 <- all_completed %>% filter(Kit_Status=="Received" & d_137401245==104430631 &  as.Date(d_173836415_d_266600170_d_319972665_d_661940160)>"2024-05-22") %>%
  mutate(MWSrvy_status = case_when(d_547363263==972455046 ~ "Not Started",
                                   d_547363263==615768760 ~ "Started",
                                   d_547363263==231311385 ~ "Submitted"),
         MW_completion = difftime(as.Date(d_173836415_d_266600170_d_448660695),as.Date(d_195145666),units="days"),
         MW_comp_diff= case_when(MWSrvy_status!="Submitted" ~ "Not Submitted",
                                 #as.numeric(MW_completion) <-3 ~ "4+ Days before Collection",
                                 as.numeric(MW_completion) ==-3 ~ "3 Days before Collection",
                                 as.numeric(MW_completion) ==-2 ~ "2 Days before Collection",
                                 as.numeric(MW_completion) ==-2 ~ "1 Day before Collection",
                                 as.numeric(MW_completion)==0 ~ "Same Day as Collection",
                                 as.numeric(MW_completion)==1 ~ "1 Day after Collection",
                                 as.numeric(MW_completion)==2 ~ "2 Days after Collection",
                                 as.numeric(MW_completion)==3 ~ "3 Days after Collection",
                                 as.numeric(MW_completion)>=4 ~ "4+ Days after Collection",
                                 TRUE~"4+ Days before Collection")) %>%
  mutate(MW_comp_diff = factor(MW_comp_diff, levels=c("Not Submitted","4+ Days before Collection", "3 Days before Collection","2 Days before Collection","1 Day before Collection",
                                                      "Same Day as Collection","1 Day after Collection", "2 Days after Collection",
                                                      "3 Days after Collection", "4+ Days after Collection"))) %>% dplyr::select(Site, MW_comp_diff)  %>%
  tbl_cross(
    row = Site,
    col = MW_comp_diff,
    digits=c(0,1),
    percent = "row",
    label=list(Site="Site",
                MW_comp_diff = " "),
    missing="ifany",
    margin_text="Total")



tbl_7_10 <- table7_10 %>%
  #bold_labels() %>%
  #italicize_levels() %>%
  modify_header(stat_0 = "Total") %>%
  modify_caption("Table 7.10: Baseline- Mouthwash Biospecimen Survey Completion Time Relative to Collection Time Reported on Collection Card \n (Post-update to survey description on PWA)") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE) %>%
  kable_styling(latex_options = "scale_down")

tbl_7_10 <- tbl_7_10 %>%
  footnote("Only includes data from mouthwash kits returned with completed Collection Card")

landscape(tbl_7_10)


```




```{r box_data,eval=TRUE,echo=FALSE,include=FALSE, warning=FALSE}


###download the biospecimen data
currentDate <- Sys.Date()
box_CID <- as.data.frame(as.numeric(sapply((strsplit(colnames(box_wl_flat),"d_")),tail,1)))
box_CID$variable <- colnames(box_wl_flat)
colnames(box_CID)[1] <-"CID"
box_CID$CID <- ifelse(is.na(box_CID$CID), 0, box_CID$CID)
box_CID_dd <- base::merge(box_CID, y[,c("Primary.Source","conceptId.2","conceptId.3","Variable.Name","Variable.Label","conceptId.4","Current.Format.Value")],by.x="CID",by.y="conceptId.3",all.x=TRUE)
box_CID_dd$Variable.Name <- ifelse(is.na(box_CID_dd$Variable.Name), box_CID_dd$variable,box_CID_dd$Variable.Name)
box_CID_dd$category<- ifelse(is.na(box_CID_dd$conceptId.4), 0,ifelse(!is.na(box_CID_dd$conceptId.4) &  box_CID_dd$conceptId.4 !=104430631, 2, 1))
select1 <- box_CID_dd$variable[which(box_CID_dd$category==0)]
yes_no <- box_CID_dd$variable[which(box_CID_dd$category==1)]
box1 <- subset(box_wl_flat,select=select1)
colnames(box1) <- box_CID_dd$Variable.Name[which(box_CID_dd$category==0)]
##for the categorical variables
box1$BioPack_Courier_v1r0 <- ifelse(box_wl_flat$d_666553960==712278213, "FedEx",ifelse(box_wl_flat$d_666553960==149772928, "World Courier",NA))
box_wl_flat$d_560975149 <- as.factor(box_wl_flat$d_560975149)
d_560975149_CIDs <- as.data.frame(cbind(unique(y$conceptId.4[grepl(paste(levels(box_wl_flat$d_560975149),collapse="|"),y$conceptId.4)]),unique(trimws(sapply(strsplit(y$Current.Format.Value[grepl(paste(levels(box_wl_flat$d_560975149),collapse="|"),y$conceptId.4)], "="),tail,1)))))
box1$d_560975149 <- plyr::mapvalues(box_wl_flat$d_560975149,from=d_560975149_CIDs$V1,to=d_560975149_CIDs$V2)
colnames(box1)[which(colnames(box1)=="d_560975149") ]<- box_CID_dd$Variable.Name[which(box_CID_dd$variable=="d_560975149")]
box_wl_flat$d_789843387 <- as.factor(box_wl_flat$d_789843387)
d_789843387_CIDs <- as.data.frame(cbind(unique(y$conceptId.4[grepl(paste(levels(box_wl_flat$d_789843387),collapse="|"),y$conceptId.4)]),unique(trimws(sapply(strsplit(y$Current.Format.Value[grepl(paste(levels(box_wl_flat$d_789843387),collapse="|"),y$conceptId.4)], "="),tail,1)))))
# box1$BioPack_BoxID_v1r0 <- box_wl_flat$d_132929440
# box1$BioPack_ModifiedTime_v1r0 <- box_wl_flat$d_555611076
# box1$BioShip_ShipTime_v1r0 <- box_wl_flat$d_656548982
# box1$BioPack_BoxStrtTime_v1r0 <- box_wl_flat$d_672863981
# box1$BioBPTL_ShipComments_v1r0 <- box_wl_flat$d_870456401
# box1$BioBPTL_DateRec_v1r0 <- box_wl_flat$d_926457119
# box1$BioShip_SignEmail_v1r0 <- box_wl_flat$d_948887825
# box1$BioPack_TrackScan1_v1r0 <- box_wl_flat$d_959708259
# box1$BioBPTL_ShipRec_v1r0 <- box_wl_flat$d_333524031 #check for yes/no structuring
#box1$d_789843387 <- boxes$d_789843387 %>% mutate(d_789843387=factor(d_789843387))
box1$d_789843387 <- plyr::mapvalues(box_wl_flat$d_789843387,from=d_789843387_CIDs$V1,to=d_789843387_CIDs$V2)
colnames(box1)[which(colnames(box1)=="d_789843387") ]<- box_CID_dd$Variable.Name[which(box_CID_dd$variable=="d_789843387")]
##for binary variables
for (i in 1:length(yes_no)){
  x <- yes_no[i]
  
  varname <- box_CID_dd$Variable.Name[grepl(x,box_CID_dd$variable)]
  #type.labels <- dd$`Variable Label`[grepl(CID,dd$CID)]
  check <- as.data.frame(box_wl_flat[,grepl(x, colnames(box_wl_flat))])
  check$variable <- ifelse(check[,1]== 353358909, "Yes",ifelse(check[,1]==104430631,"No",NA))
  colnames(check)[2] <- varname
  box1 <-   cbind(box1,subset(check,select=varname))
}
#gsub("[^[:alnum:][:blank:]+?&/\\-]", "", c) #to remove any specific character in a variable in r
box1 <- box1  %>% mutate(d_238268405=gsub("^[:alnum:][:blank:]","",d_238268405),
                         d_238268405_1=case_when(substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"121149986"~"Crushed",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"200183516" ~"Vials - Incorrect Material Type",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"289322354" ~ "Material Thawed",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"387564837" ~ "Damaged Vials",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"399948893" ~ "Vials - Missing Labels",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"405513630" ~ "Cold Packs - none",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"442684673" ~ "Participant Refusal",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"595987358" ~ "Cold Packs - warm",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"613022284" ~ "No Refrigerant",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"631290535" ~ "Vials - Empty",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"678483571" ~ "Damaged Container (outer and/or inner)",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"679749262" ~ "Package in good condition",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"842171722" ~ "No Pre-notification",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"847410060" ~ "Improper Packaging",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"853876696" ~ "Manifest - not provided",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	 "909529446" ~ "Cold Packs - insufficient",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"922995819" ~ "Manifest/Paperwork/Vial information do not match",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"933646000" ~ "Other- Package Condition",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"958000780" ~ "Shipment Delay") ,
                         d_238268405_2=case_when(substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"121149986"~"Crushed",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"200183516" ~"Vials - Incorrect Material Type",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"289322354" ~ "Material Thawed",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"387564837" ~ "Damaged Vials",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"399948893" ~ "Vials - Missing Labels",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"405513630" ~ "Cold Packs - none",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"442684673" ~ "Participant Refusal",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"595987358" ~ "Cold Packs - warm",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"613022284" ~ "No Refrigerant",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"631290535" ~ "Vials - Empty",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"678483571" ~ "Damaged Container (outer and/or inner)",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"679749262" ~ "Package in good condition",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"842171722" ~ "No Pre-notification",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"847410060" ~ "Improper Packaging",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"853876696" ~ "Manifest - not provided",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	 "909529446" ~ "Cold Packs - insufficient",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"922995819" ~ "Manifest/Paperwork/Vial information do not match",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"933646000" ~ "Other- Package Condition",
                                                 substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"958000780" ~ "Shipment Delay"))
box1<- box1 %>% mutate(BioPack_ShipCondtion_v1r0=ifelse(is.na(d_238268405_2), d_238268405_1, paste(d_238268405_1,d_238268405_2,sep=",")))
#box1 <- box1[, c(1:4, 6:22, 25)] --- why are some columns missing???
#missing: BioPack_BoxID_v1r0	BioPack_ModifiedTime_v1r0	BioShip_ShipTime_v1r0	BioPack_BoxStrtTime_v1r0	BioBPTL_ShipComments_v1r0	BioBPTL_DateRec_v1r0	BioShip_SignEmail_v1r0	BioPack_TrackScan1_v1r0		BioBPTL_ShipRec_v1r0
box1$BioPack_BoxID_v1r0 <- box_wl_flat$d_132929440
box1$BioPack_ModifiedTime_v1r0 <- box_wl_flat$d_555611076
box1$BioShip_ShipTime_v1r0 <- box_wl_flat$d_656548982
box1$BioPack_BoxStrtTime_v1r0 <- box_wl_flat$d_672863981
box1$BioBPTL_ShipComments_v1r0 <- box_wl_flat$d_870456401
box1$BioBPTL_DateRec_v1r0 <- box_wl_flat$d_926457119
box1$BioShip_SignEmail_v1r0 <- box_wl_flat$d_948887825
box1$BioPack_TrackScan1_v1r0 <- box_wl_flat$d_959708259
box1$BioBPTL_ShipRec_v1r0 <- box_wl_flat$d_333524031 #check for yes/no structuring
box1 <- box1 %>%  mutate(BioBPTL_ShipRec_v1r0= case_when(BioBPTL_ShipRec_v1r0==353358909 ~ "Yes",
                                                         BioBPTL_ShipRec_v1r0==104430631  ~ "No"))
box1 <- box1 %>%  select(bagID,	bagType,	tubeID,	BioPack_BoxID_v1r0,	BioPack_ModifiedTime_v1r0,	BioShip_ShipTime_v1r0,	BioPack_BoxStrtTime_v1r0,	BioBPTL_ShipComments_v1r0,	d_885486943,
                         BioBPTL_DateRec_v1r0,	BioShip_SignEmail_v1r0,	BioPack_TrackScan1_v1r0,	BioPack_Courier_v1r0,	BioShip_LocalID_v1r0,	BioShip_LogSite_v1r0,	BioPack_TempProbe_v1r0,
                         BioShip_ShipSubmit_v1r0,	BioPack_OrphanBag_v1r0,	BioBPTL_ShipRec_v1r0,	BioPack_ContainsOrphan_v1r0,	BioPack_ShipCondtion_v1r0)
box1 <- box1[, c(1:8, 10:21)]
write.csv(box1,glue("{local_drive}Formatted_prod_flatBoxes_JP_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")
# write.csv(box1,paste(local_drive, "Formatted_prod_flatBoxes_JP_",currentDate,".csv",sep=""),row.names = F,na="")
```



```{r bipspec_data,eval=TRUE,echo=FALSE,include=FALSE, warning=FALSE}
#11/20 updates
###to get the formats and variable names from DD
factor_cid <-function(var,data){
  var <- as.factor(var)
  var_CIDs <- as.data.frame(cbind(unique(y$conceptId.4[grepl(paste(levels(var),collapse="|"),y$conceptId.4)]),unique(trimws(sapply(strsplit(y$Current.Format.Value[grepl(paste(levels(var),collapse="|"),y$conceptId.4)], "="),tail,1)))))
  
  var <- plyr::mapvalues(var,from=var_CIDs$V1,to=var_CIDs$V2)
}





bio_tb2 <- bq_project_query(project, query='SELECT * FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.biospecimen_JP`')  
biospe2 <- bq_table_download(bio_tb2,bigint="integer64",n_max = Inf, page_size = 1000)


#biospe2$d_646899796 <- biospe2$d_646899796_integer #regular variable coming in as an array
#biospe2$d_928693120 <- biospe2$d_928693120_integer #regular variable coming in as an array


cnames <- names(biospe2)
for (i in 1: length(cnames)){
  varname <- cnames[i]
  var<-pull(biospe2,varname)
  biospe2[,cnames[i]] <- ifelse(numbers_only(var), as.numeric(as.character(var)), var)
}






biospe2_CID <- as.data.frame(sapply((strsplit(colnames(biospe2),"d_")),tail,1))
colnames(biospe2_CID)[1] <- "CID"
#biospe2_CID <- biospe2_CID %>% mutate(CID = ifelse(nchar(CID)>10, substring(CID,1,9), CID))
biospe2_CID$variable <- names(biospe2)
y$conceptId.3 <- as.character(y$conceptId.3)
y$conceptId.4 <- as.numeric(y$conceptId.4)

biospe2_CID_dd <- base::merge(biospe2_CID, y[,c("Formula.for.Index","Primary.Source","conceptId.1","conceptId.2","conceptId.3","Variable.Name","Variable.Label","conceptId.4","Current.Format.Value")],by.x="CID",by.y="conceptId.3",all.x=TRUE)


biospe2_CID_dd <- biospe2_CID_dd %>% mutate(category = case_when(conceptId.4 == 104430631~1,
                                                                 !is.na(conceptId.4) & conceptId.4 !='104430631' &  nchar(conceptId.4)>0 ~ 2,
                                                                 is.na(conceptId.4) | nchar(conceptId.4) == 0 ~0),
                                            firstCID = sapply(strsplit(variable,"_"),"[",2),
                                            
                                            label.1st = case_when(sapply(strsplit(variable,"_"),"[",2) == "973670172"  ~ "UrineTube1",
                                                                  sapply(strsplit(variable,"_"),"[",2) == "143615646"  ~ "MWTube1",
                                                                  sapply(strsplit(variable,"_"),"[",2) == "299553921"  ~ "SSTube1",
                                                                  sapply(strsplit(variable,"_"),"[",2) == "703954371"  ~ "SSTube2",
                                                                  sapply(strsplit(variable,"_"),"[",2) == "454453939"  ~ "EDTATube1",
                                                                  sapply(strsplit(variable,"_"),"[",2) == "838567176"  ~ "HeparinTube1",
                                                                  sapply(strsplit(variable,"_"),"[",2) == "652357376"  ~ "ACDTube1",
                                                                  sapply(strsplit(variable,"_"),"[",2) == "677469051"  ~ "EDTATube2",
                                                                  sapply(strsplit(variable,"_"),"[",2) == "683613884"  ~ "EDTATube3",
                                                                  sapply(strsplit(variable,"_"),"[",2) == "376960806"  ~ "SSTube3",
                                                                  sapply(strsplit(variable,"_"),"[",2) == "232343615"  ~ "SSTube4",
                                                                  sapply(strsplit(variable,"_"),"[",2) == "589588440"  ~ "SSTube5",
                                                                  sapply(strsplit(variable,"_"),"[",2) == "958646668"  ~ "HeparinTube2",
                                                                  sapply(strsplit(variable,"_"),"[",2) == "223999569"  ~ "BiohazardMW",
                                                                  sapply(strsplit(variable,"_"),"[",2) == "787237543"  ~ "BiohazardBIU" ,
                                                                  sapply(strsplit(variable,"_"),"[",2) == "505347689"  ~ "STRECKTube1" ))


biospe2_CID_dd$matched <- ifelse(nchar(biospe2_CID_dd$variable) <12 , 1, ifelse(nchar(biospe2_CID_dd$variable) >12 & biospe2_CID_dd$conceptId.1 == biospe2_CID_dd$firstCID, 1, 0))


biospe2_CID_dd <- biospe2_CID_dd %>% arrange(CID, variable,desc(matched),Formula.for.Index)



biospe2_CID_dd1 <- biospe2_CID_dd[!duplicated(biospe2_CID_dd[,c("CID","variable")]),]
biospe2_CID_dd1$new.varname <- ifelse(biospe2_CID_dd1$matched==1, biospe2_CID_dd1$Variable.Name, paste(gsub("SST1","",biospe2_CID_dd1$Variable.Name),biospe2_CID_dd1$label.1st,sep="_"))
biospe2_CID_dd1$new.varname[which(biospe2_CID_dd1$variable=="d_926457119")] <- "BioBPTL_DateRec_v1r0"
biospe2_CID_dd1$variable[is.na(biospe2_CID_dd1$new.varname)]
#"d_611091485" "Connect_ID"  "date"        "id"          "Site"        "siteAcronym" "token"
biospe1 <- NULL
select0 <- biospe2_CID_dd1$variable[which(biospe2_CID_dd1$category==0 & !is.na(biospe2_CID_dd1$Variable.Name))]
select2 <- biospe2_CID_dd1$variable[which(biospe2_CID_dd1$category==2)]
yes_no <- biospe2_CID_dd1$variable[which(biospe2_CID_dd1$category==1)]
biospe1 <- subset(biospe2,select =c("Connect_ID","token","siteAcronym",select0,select2)) #removed "date", as it is no longer in the participants table
n<- length(select0)
colnames(biospe1)[which(colnames(biospe1) %in% select0)] <-  biospe2_CID_dd1$new.varname[which(biospe2_CID_dd1$category==0 & !is.na(biospe2_CID_dd1$Variable.Name))]



for (i in 1: length(select2)){
  eval(parse(text=paste("biospe1$",select2[i],"<-factor_cid(biospe1$",select2[i],")",sep="")))
}
colnames(biospe1)[which(colnames(biospe1) %in% select2)] <-  biospe2_CID_dd1$new.varname[which(biospe2_CID_dd1$category==2)]

for (i in 1:length(yes_no)){
  x <- yes_no[i]
  
  varname <- biospe2_CID_dd1[grepl(yes_no[i],biospe2_CID_dd1$variable) & biospe2_CID_dd1$category==1,]$new.varname
  
  #type.labels <- dd$`Variable Label`[grepl(CID,dd$CID)]
  check <- as.data.frame(biospe2[,x])
  check$variable <- ifelse(check[,1]== 353358909, "Yes",ifelse(check[,1]==104430631,"No",NA))
  colnames(check)[2] <- varname
  biospe1 <-   cbind(biospe1,subset(check,select=varname))
}


colnames(biospe1) <- gsub("Object|Obj","Tube", colnames(biospe1))
colnames(biospe1) <- gsub("BioCol_Dev_v1r0","Deviation",colnames(biospe1))
biospe1 <- biospe1[,order(colnames(biospe1))]


# the rest part on ordering of the variables is still the same as before or what you shared with me last Friday.
#I don't have any problem running this part
names_set <- c("Connect_ID","RcrtES_Site_v1r0","BioSpm_Visit_v1r0","BioSpm_Setting_v1r0","BioSpm_Location_v1r0","BioSpm_ColIDScan_v1r0",
               "BioReg_ArRegTime_v1r0", "BioCol_ColTime_v1r0", "BioRec_CollectFinal_v1r0","BioRec_CollectFinalTime_v1r0","BioClin_DBBloodID_v1r0",
               "BioClin_DBBloodRRLBL_v1r0",
               "BioClin_DBBloodRRLDtBL_v1r0",
               "BioClin_DBUrineID_v1r0",
               "BioClin_DBUrineRRLBL_v1r0",
               "BioClin_DBUrineRRLDtBL_v1r0",
               "BioCol_PhlebInitials_v1r0",
               "BioCol_ColNote1_v1r0",
               "BioCol_TubeColl_v1r0_Bio",
               "BioCol_TubeID_v1r0_Bio",
               "BioCol_TubeColl_v1r0_SST1",
               "BioCol_TubeID_v1r0_SST1",
               "BioCol_NotCol_v1r0_SST1",
               "BioCol_NotCol_v1r0_SST1",
               "BioCol_Discard_v1r0_SST1",
               "BioCol_TubeColl_v1r0_SST2",
               "BioCol_TubeID_v1r0_SST2",
               "BioCol_NotCol_v1r0_SST2",
               "BioCol_NotCol_v1r0_SST2",
               "BioCol_Discard_v1r0_SST2",
               "BioCol_TubeColl_v1r0_HT1",
               "BioCol_TubeID_v1r0_HT1",
               "BioCol_NotCol_v1r0_HT1",
               "BioCol_NotCol_v1r0_HT1",
               "BioCol_Discard_v1r0_HT1",
               "BioCol_TubeColl_v1r0_EDTAT1",
               "BioCol_TubeID_v1r0_EDTAT1",
               "BioCol_NotCol_v1r0_EDTAT1",
               "BioCol_NotCol_v1r0_EDTAT1",
               "BioCol_Discard_v1r0_EDTAT1",
               "BioCol_TubeColl_v1r0_ACDT1",
               "BioCol_TubeID_v1r0_ACDT1",
               "BioCol_NotCol_v1r0_ACDT1",
               "BioCol_NotCol_v1r0_ACDT1",
               "BioCol_Discard_v1r0_ACDT1",
               "BioCol_TubeColl_v1r0_STRT1",
               "BioCol_TubeID_v1r0_STRT1",
               "BioCol_NotCol_v1r0_STRT1",
               "BioCol_NotCol_v1r0_STRT1",
               "BioCol_Discard_v1r0_STRT1",
               "BioCol_TubeColl_v1r0_UT1",
               "BioCol_TubeID_v1r0_UT1",
               "BioCol_NotCol_v1r0_UT1",
               "BioCol_NotCol_v1r0_UT1",
               "BioCol_Discard_v1r0_UT1",
               "BioCol_TubeColl_v1r0_MWT1",
               "BioCol_TubeID_v1r0_MWT1",
               "BioCol_NotCol_v1r0_MWT1",
               "BioCol_NotCol_v1r0_MWT1",
               "BioCol_Discard_v1r0_MWT1",
               "BioCol_TubeColl_v1r0_BioMW",
               "BioCol_TubeID_v1r0_BioMW",
               "BioCol_TubeColl_v1r0_SST3",
               "BioCol_TubeID_v1r0_SST3",
               "BioCol_Discard_v1r0_SST3",
               "BioCol_TubeColl_v1r0_SST4",
               "BioCol_TubeID_v1r0_SST4",
               "BioCol_Discard_v1r0_SST4",
               "BioCol_TubeColl_v1r0_SST5",
               "BioCol_TubeID_v1r0_SST5",
               "BioCol_Discard_v1r0_SST5",
               "BioCol_TubeID_v1r0_HT2",
               "BioCol_TubeColl_v1r0_HT2",
               "BioCol_Discard_v1r0_HT2",
               "BioCol_TubeColl_v1r0_EDTAT2",
               "BioCol_TubeID_v1r0_EDTAT2",
               "BioCol_Discard_v1r0_EDTAT2",
               "BioCol_TubeColl_v1r0_EDTAT3",
               "BioCol_TubeID_v1r0_EDTAT3",
               "BioCol_Discard_v1r0_EDTAT3",
               "BioCol_CollBoxedStatus_v1r0",
               "BioBPTL_DateRec_v1r0_SST1",
               "BioBPTL_DateRec_v1r0_SST2",
               "BioBPTL_DateRec_v1r0_HT1",
               "BioBPTL_DateRec_v1r0_EDTAT1",
               "BioBPTL_DateRec_v1r0_ACDT1",
               "BioBPTL_DateRec_v1r0_STRT1",
               "BioBPTL_DateRec_v1r0_UT1",
               "BioBPTL_DateRec_v1r0_MWT1",
               "BioKit_KitRecdTmBL_v1r0_MWTube1",
               "BioBPTL_DateRec_v1r0_SST3",
               "BioBPTL_DateRec_v1r0_SST4",
               "BioBPTL_DateRec_v1r0_SST5",
               "BioBPTL_DateRec_v1r0_HT2",
               "BioBPTL_DateRec_v1r0_EDTAT2",
               "BioBPTL_DateRec_v1r0_EDTAT3",
               "BioRec_NoteOpt_v1r0",
               "BioCol_StrayTubesList_v1r0",
               "siteAcronym",
               "BioCol_Deviation_v1r0_SST1",
               "BioCol_DevNotes_v1r0_SST1",
               "Deviation_BrokenSST1",
               "Deviation_ClotLSST1",
               "Deviation_ClotSSST1",
               "Deviation_DiscardSST1",
               "Deviation_GelSST1",
               "Deviation_HemoSST1",
               "Deviation_LeakSST1",
               "Deviation_LowVolSST1",
               "Deviation_MislabDSST1",
               "Deviation_MislabRSST1",
               "Deviation_NotFoundSST1",
               "Deviation_OtherSST1",
               "Deviation_OutContSST1",
               "Deviation_SpeedHSST1",
               "Deviation_SpeedLSST1",
               "Deviation_TempHSST1",
               "Deviation_TempLSST1",
               "Deviation_TimeLSST1",
               "Deviation_TimeSSST1",
               "Deviation_TubeSzSST1",
               "BioCol_Deviation_v1r0_SST2",
               "BioCol_DevNotes_v1r0_SST2",
               "Deviation_BrokenSST2",
               "Deviation_ClotLSST2",
               "Deviation_ClotSSST2",
               "Deviation_DiscardSST2",
               "Deviation_GelSST2",
               "Deviation_HemoSST2",
               "Deviation_LeakSST2",
               "Deviation_LowVolSST2",
               "Deviation_MislabDSST2",
               "Deviation_MislabRSST2",
               "Deviation_NotFoundSST2",
               "Deviation_OtherSST2",
               "Deviation_OutContSST2",
               "Deviation_SpeedHSST2",
               "Deviation_SpeedLSST2",
               "Deviation_TempHSST2",
               "Deviation_TempLSST2",
               "Deviation_TimeLSST2",
               "Deviation_TimeSSST2",
               "Deviation_TubeSzSST2",
               "BioCol_Deviation_v1r0_SST3",
               "BioCol_DevNotes_v1r0_SST3",
               "Deviation_BrokenSST3",
               "Deviation_ClotLSST3",
               "Deviation_ClotS_SST3",
               "Deviation_DiscardSST3",
               "Deviation_GelSST3",
               "Deviation_HemoSST3",
               "Deviation_LeakSST3",
               "Deviation_LowVolSST3",
               "Deviation_MislabDSST3",
               "Deviation_MislabRSST3",
               "Deviation_NotFoundSST3",
               "Deviation_OtherSST3",
               "Deviation_OutContSST3",
               "Deviation_SpeedHSST3",
               "Deviation_SpeedLSST3",
               "Deviation_TempHSST3",
               "Deviation_TempLSST3",
               "Deviation_TimeLSST3",
               "Deviation_TimeSSST3",
               "Deviation_TubeSzSST3",
               "BioCol_Deviation_v1r0_SST4",
               "BioCol_DevNotes_v1r0_SST4",
               "Deviation_BrokenSST4",
               "Deviation_ClotLSST4",
               "Deviation_ClotSSST4",
               "Deviation_DiscardSST4",
               "Deviation_GelSST4",
               "Deviation_HemoSST4",
               "Deviation_LeakSST4",
               "Deviation_LowVolSST4",
               "Deviation_MislabDSST4",
               "Deviation_MislabRSST4",
               "Deviation_NotFoundSST4",
               "Deviation_OtherSST4",
               "Deviation_OutContSST4",
               "Deviation_SpeedHSST4",
               "Deviation_SpeedLSST4",
               "Deviation_TempHSST4",
               "Deviation_TempLSST4",
               "Deviation_TimeLSST4",
               "Deviation_TimeSSST4",
               "Deviation_TubeSzSST4",
               "BioCol_Deviation_v1r0_SST5",
               "BioCol_DevNotes_v1r0_SST5",
               "Deviation_BrokenSST5",
               "Deviation_ClotLSST5",
               "Deviation_ClotSSST5",
               "Deviation_DiscardSST5",
               "Deviation_GelSST5",
               "Deviation_HemoSST5",
               "Deviation_LeakSST5",
               "Deviation_LowVolSST5",
               "Deviation_MislabDSST5",
               "Deviation_MislabRSST5",
               "Deviation_NotFoundSST5",
               "Deviation_OtherSST5",
               "Deviation_OutContSST5",
               "Deviation_SpeedHSST5",
               "Deviation_SpeedLSST5",
               "Deviation_TempHSST5",
               "Deviation_TempLSST5",
               "Deviation_TimeLSST5",
               "Deviation_TimeSSST5",
               "Deviation_TubeSzSST5",
               "BioCol_Deviation_v1r0_HT1",
               "BioCol_DevNotes_v1r0_HT1",
               "Deviation_BrokenHT1",
               "Deviation_DiscardHT1",
               "Deviation_HemoHT1",
               "Deviation_LeakHT1",
               "Deviation_LowVolHT1",
               "Deviation_MislabelDHT1",
               "Deviation_MislabelRHT1",
               "Deviation_NotFoundHT1",
               "Deviation_OtherHT1",
               "Deviation_OutContamHT1",
               "Deviation_TempHHT1",
               "Deviation_TempLHT1",
               "Deviation_TubeSzHT1",
               "BioCol_Deviation_v1r0_HT2",
               "BioCol_DevNotes_v1r0_HT2",
               "Deviation_BrokenHT2",
               "Deviation_DiscardHT2",
               "Deviation_HemoHT2",
               "Deviation_LeakHT2",
               "Deviation_LowVolHT2",
               "Deviation_MislabelDHT2",
               "Deviation_MislabelRHT2",
               "Deviation_NotFoundHT2",
               "Deviation_OtherHT2",
               "Deviation_OutContamHT2",
               "Deviation_TempHHT2",
               "Deviation_TempLHT2",
               "Deviation_TubeSzHT2",
               "BioCol_Deviation_v1r0_EDTAT1",
               "BioCol_DevNotes_v1r0_EDTAT1",
               "Deviation_BrokenEDTAT1",
               "Deviation_DiscEDTAT1",
               "Deviation_HemoEDTAT1",
               "Deviation_LeakEDTAT1",
               "Deviation_LowVolEDTAT1",
               "Deviation_MislDEDTAT1",
               "Deviation_MislREDTAT1",
               "Deviation_NFEDTAT1",
               "Deviation_OtherEDTAT1",
               "Deviation_OutConEDTAT1",
               "Deviation_TempHEDTAT1",
               "Deviation_TempLEDTAT1",
               "Deviation_TubeSzEDTAT1",
               "BioCol_Deviation_v1r0_EDTAT2",
               "BioCol_DevNotes_v1r0_EDTAT2",
               "Deviation_BrokenEDTAT2",
               "Deviation_DiscEDTAT2",
               "Deviation_HemoEDTAT2",
               "Deviation_LeakEDTAT2",
               "Deviation_LowVolEDTAT2",
               "Deviation_MislDEDTAT2",
               "Deviation_MislREDTAT2",
               "Deviation_NFEDTAT2",
               "Deviation_OtherEDTAT2",
               "Deviation_OutConEDTAT2",
               "Deviation_TempHEDTAT2",
               "Deviation_TempLEDTAT2",
               "Deviation_TubeSzEDTAT2",
               "BioCol_Deviation_v1r0_EDTAT3",
               "BioCol_DevNotes_v1r0_EDTAT3",
               "Deviation_BrokenEDTAT3",
               "Deviation_DiscEDTAT3",
               "Deviation_HemoEDTAT3",
               "Deviation_LeakEDTAT3",
               "Deviation_LowVolEDTAT3",
               "Deviation_MislDEDTAT3",
               "Deviation_MislREDTAT3",
               "Deviation_NFEDTAT3",
               "Deviation_OtherEDTAT3",
               "Deviation_OutConEDTAT3",
               "Deviation_TempHEDTAT3",
               "Deviation_TempLEDTAT3",
               "Deviation_TubeSzEDTAT3",
               "BioCol_Deviation_v1r0_ACDT1",
               "BioCol_DevNotes_v1r0_ACDT1",
               "Deviation_BrokenACDT1",
               "Deviation_DiscardACDT1",
               "Deviation_HemoACDT1",
               "Deviation_LeakACDT1",
               "Deviation_LowVolACDT1",
               "Deviation_MislabDACDT1",
               "Deviation_MislabRACDT1",
               "Deviation_NotFndACDT1",
               "Deviation_OtherACDT1",
               "Deviation_OutContACDT1",
               "Deviation_TempHACDT1",
               "Deviation_TempLACDT1",
               "Deviation_TubeSzACDT1",
               "BioCol_Deviation_v1r0_STRT1",
               "BioCol_DevNotes_v1r0_STRT1",
               "Deviation_BrokenSTRT1",
               "Deviation_DiscardSTRT1",
               "Deviation_HemoSTRT1",
               "Deviation_LeakSTRT1",
               "Deviation_LowVolSTRT1",
               "Deviation_MislabDSTRT1",
               "Deviation_MislabRSTRT1",
               "Deviation_NotFndSTRT1",
               "Deviation_OtherSTRT1",
               "Deviation_OutContSTRT1",
               "Deviation_TempHSTRT1",
               "Deviation_TempLSTRT1",
               "Deviation_TubeSzSTRT1",
               "BioCol_Deviation_v1r0_UT1",
               "BioCol_DevNotes_v1r0_UT1",
               "Deviation_BrokenUT1",
               "Deviation_LeakUT1",
               "Deviation_LowVolUT1",
               "Deviation_MislabelDUT1",
               "Deviation_MislabelRUT1",
               "Deviation_NotFoundUT1",
               "Deviation_OtherUT1",
               "Deviation_OutContamUT1",
               "Deviation_TempHUT1",
               "Deviation_TempLUT1",
               "Deviation_UrVolUT1",
               "BioCol_Deviation_v1r0_MWT1",
               "BioCol_DevNotes_v1r0_MWT1",
               "Deviation_BrokenMWT1",
               "Deviation_LeakMWT1",
               "Deviation_LowVolMWT1",
               "Deviation_MislabDMWT1",
               "Deviation_MislabRMWT1",
               "Deviation_MWUnd30sMWT1",
               "Deviation_NotFoundMWT1",
               "Deviation_OtherMWT1",
               "Deviation_OutContMWT1",
               "token")


biospe1_final <- biospe1 %>% select(names_set)

write.csv(biospe1_final,glue("{local_drive}Connect_prod_Biospe_Formats_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")


# If in the future we have additional cols and there's a discrpency between the request column order and the existing column names
#  missing_columns <- setdiff(expected_columns, colnames(biospe1))
# 
# if (length(missing_columns) > 0) {
#   cat("Missing columns:", paste(missing_columns, collapse = ", "), "\n")
# } else {
#   cat("All expected columns are present in the dataframe.\n")
# }
# ##11/16 update suggestion for column header updates
# 
# biospe2_CID_dd <- base::merge(biospe2_CID, y[,c("Index","Primary.Source","conceptId.1","conceptId.2","conceptId.3","Variable.Name","Variable.Label","conceptId.4","Current.Format.Value")],by.x="CID",by.y="conceptId.3",all.x=TRUE) ## the data "y" is leftover in the code
# 
# 
# biospe2_CID_dd <- biospe2_CID_dd %>% mutate(category = case_when(conceptId.4 == 104430631~1,
#                                                                  !is.na(conceptId.4) & conceptId.4 !='104430631' &  nchar(conceptId.4)>0 ~ 2,
#                                                                  is.na(conceptId.4) | nchar(conceptId.4) == 0 ~0),
#                                             firstCID = sapply(strsplit(variable,"_"),"[",2),
#                                             
#                                             label.1st = case_when(sapply(strsplit(variable,"_"),"[",2) == "973670172"  ~ "UrineTube1",
#                                                                   sapply(strsplit(variable,"_"),"[",2) == "143615646"  ~ "MWTube1",
#                                                                   sapply(strsplit(variable,"_"),"[",2) == "299553921"  ~ "SSTube1",
#                                                                   sapply(strsplit(variable,"_"),"[",2) == "703954371"  ~ "SSTube2",
#                                                                   sapply(strsplit(variable,"_"),"[",2) == "454453939"  ~ "EDTATube1",
#                                                                   sapply(strsplit(variable,"_"),"[",2) == "838567176"  ~ "HeparinTube1",
#                                                                   sapply(strsplit(variable,"_"),"[",2) == "652357376"  ~ "ACDTube1",
#                                                                   sapply(strsplit(variable,"_"),"[",2) == "677469051"  ~ "EDTATube2",
#                                                                   sapply(strsplit(variable,"_"),"[",2) == "683613884"  ~ "EDTATube3",
#                                                                   sapply(strsplit(variable,"_"),"[",2) == "376960806"  ~ "SSTube3",
#                                                                   sapply(strsplit(variable,"_"),"[",2) == "232343615"  ~ "SSTube4",
#                                                                   sapply(strsplit(variable,"_"),"[",2) == "589588440"  ~ "SSTube5",
#                                                                   sapply(strsplit(variable,"_"),"[",2) == "958646668"  ~ "HeparinTube2",
#                                                                   sapply(strsplit(variable,"_"),"[",2) == "223999569"  ~ "BiohazardMW",
#                                                                   sapply(strsplit(variable,"_"),"[",2) == "787237543"  ~ "BiohazardBIU" ))
# 
# 
# biospe2_CID_dd$matched <- ifelse(nchar(biospe2_CID_dd$variable) <12, 1, ifelse(nchar(biospe2_CID_dd$variable) >12 & biospe2_CID_dd$conceptId.1 == biospe2_CID_dd$firstCID, 1, 0))  #to add "matched"  flag to select the correct variables based on their combined CIDs (tubeID, last.CID) to compromise the changes in the DD on the biospecimen
# 
# 
# biospe2_CID_dd <- biospe2_CID_dd %>% arrange(CID, variable,desc(matched),Index)
# 
# 
# biospe2_CID_dd1 <- biospe2_CID_dd[!duplicated(biospe2_CID_dd[,c("CID","variable")]),]
# biospe2_CID_dd1$new.varname <- ifelse(biospe2_CID_dd1$matched==1, biospe2_CID_dd1$Variable.Name, paste(gsub("SST1","",biospe2_CID_dd1$Variable.Name),biospe2_CID_dd1$label.1st,sep="_"))
# biospe2_CID_dd1$variable[is.na(biospe2_CID_dd1$new.varname)]
# #"d_611091485" "Connect_ID"  "date"        "id"          "Site"        "siteAcronym" "token"
# biospe1 <- NULL
# select0 <- biospe2_CID_dd1$variable[which(biospe2_CID_dd1$category==0 & !is.na(biospe2_CID_dd1$Variable.Name))]
# select2 <- biospe2_CID_dd1$variable[which(biospe2_CID_dd1$category==2)]
# yes_no <- biospe2_CID_dd1$variable[which(biospe2_CID_dd1$category==1)]
# biospe1 <- subset(biospe2,select =c("Connect_ID","token","siteAcronym","date",select0,select2))
# n<- length(select0)
# colnames(biospe1)[which(colnames(biospe1) %in% select0)] <-  biospe2_CID_dd1$new.varname[which(biospe2_CID_dd1$category==0 & !is.na(biospe2_CID_dd1$Variable.Name))]
# 
# 
# 
# for (i in 1: length(select2)){
#   eval(parse(text=paste("biospe1$",select2[i],"<-factor_cid(biospe1$",select2[i],")",sep="")))
# }
# colnames(biospe1)[which(colnames(biospe1) %in% select2)] <-  biospe2_CID_dd1$new.varname[which(biospe2_CID_dd1$category==2)]
# 
# 
# for (i in 1:length(yes_no)){
#   x <- yes_no[i]
#   
#   varname <- biospe2_CID_dd1[grepl(yes_no[i],biospe2_CID_dd1$variable),]$new.varname
#   #type.labels <- dd$`Variable Label`[grepl(CID,dd$CID)]
#   check <- as.data.frame(biospe2[,x])
#   check$variable <- ifelse(check[,1]== 353358909, "Yes",ifelse(check[,1]==104430631,"No",NA))
#   colnames(check)[2] <- varname
#   biospe1 <-   cbind(biospe1,subset(check,select=varname))
# }
# 
# 
# colnames(biospe1) <- gsub("Object|Obj","Tube", colnames(biospe1))
# colnames(biospe1) <- gsub("BioCol_Dev_v1r0","Deviation",colnames(biospe1))
# biospe1 <- biospe1[,order(colnames(biospe1))]
# 
# 
# biospe1_final <- biospe1[,c(43,162,42,29,38,35:36,41,30,39,40,22,37,23:28,145:161,31:34,164:219,45:65,104:124,1:21,298:337,66:103,125:143,220:296,144,297,163,44)]
#biospe1_fin= subset(biospe1_final, select=-c(BioClin_DBBloodRRL_v1r0, BioClin_DBBloodRRLDt_v1r0, BioClin_DBUrineRRLDt_v1r0))
# write.csv(biospe1_fin,paste(local_drive, "Connect_prod_Biospe_Formats",currentDate,".csv",sep="_"),row.names = F,na="")
#write.csv(biospe1_fin,glue("{local_drive}Connect_prod_Biospe_Formats_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")


```













```{r recrbio_data,eval=TRUE,echo=FALSE,include=FALSE, warning=FALSE}
#Adding mw variables to this csv
mw_addons <- kit_table %>% select(Connect_ID, d_173836415_d_266600170_d_319972665_d_221592017, d_173836415_d_266600170_d_319972665_d_379252329, d_173836415_d_266600170_d_319972665_d_661940160, d_173836415_d_266600170_d_319972665_d_826941471)

recr_mw <- left_join(recrver, mw_addons, by="Connect_ID")

recr.bio$Connect_ID <- as.character(recr.bio$Connect_ID)
mw_addons$Connect_ID <- as.character(mw_addons$Connect_ID)
recr.bio_mw <- left_join(recr.bio, mw_addons, by="Connect_ID")

y$conceptId.4 <- as.numeric(y$conceptId.4)

recrver_CID <- as.data.frame(substring(sapply((strsplit(colnames(recr_mw),"d_")),tail,1),1,9))

colnames(recrver_CID)[1] <- "CID"

recrver_CID$variable <- names(recr.bio_mw)



y$order <- rownames(y)



recrvar_CID_dd <- base::merge(recrver_CID, y[,c("Primary.Source","conceptId.2","conceptId.3","Variable.Name","Variable.Label","conceptId.4","Current.Format.Value","order")],by.x="CID",by.y="conceptId.3",all.x=TRUE)

recrvar_CID_dd <-recrvar_CID_dd %>% arrange(CID, variable,as.numeric(order),Variable.Name) #before remove the duplicates


recrvar_CID_dd <-recrvar_CID_dd[!duplicated(recrvar_CID_dd[,c("CID","variable")]),]






recrvar_CID_dd <- recrvar_CID_dd %>% mutate(category = case_when(conceptId.4 == 104430631~1,
                                                                 
                                                                 !is.na(conceptId.4) & conceptId.4 !=104430631 ~ 2,
                                                                 
                                                                 is.na(conceptId.4) ~0),
                                            
                                            Variable.Name=ifelse(is.na(Variable.Name), variable, Variable.Name))





recrbio1 <- NULL

select0 <- recrvar_CID_dd$variable[which(recrvar_CID_dd$category==0)]

select2 <- recrvar_CID_dd$variable[which(recrvar_CID_dd$category==2)]

yes_no <- recrvar_CID_dd$variable[which(recrvar_CID_dd$category==1)]

recrbio1 <- subset(recr.bio_mw,select =c(select0,select2))

colnames(recrbio1)[which(colnames(recrbio1) %in% select0)] <-  recrvar_CID_dd$Variable.Name[which(recrvar_CID_dd$category==0)]

n<- length(select0)

factor_cid <-function(var){
  
  var <- as.factor(var)
  
  var_CIDs <- as.data.frame(cbind(unique(y$conceptId.4[grepl(paste(levels(var),collapse="|"),y$conceptId.4)]),unique(trimws(sapply(strsplit(y$Current.Format.Value[grepl(paste(levels(var),collapse="|"),y$conceptId.4)], "="),tail,1)))))
  
  
  
  
  var <- plyr::mapvalues(var,from=var_CIDs$V1,to=var_CIDs$V2)
  
}




for (i in 1: length(select2)){
  
  eval(parse(text=paste("recrbio1$",select2[i],"<- factor_cid(recrbio1$", select2[i],")",sep="")))
  
  colnames(recrbio1)[n+i] <- recrvar_CID_dd$Variable.Name[grepl(select2[i],recrvar_CID_dd$variable)]
  
}




for (i in 1:length(yes_no)){
  
  x <- yes_no[i]
  
  varname <- recrvar_CID_dd$Variable.Name[grepl(x,recrvar_CID_dd$variable)]
  
  #type.labels <- dd$`Variable Label`[grepl(CID,dd$CID)]
  
  check <- as.data.frame(recr.bio_mw[,grepl(x, colnames(recr.bio_mw))])
  
  #check <-pull(recr.bio_mw,varname)
  
  check$variable <- ifelse(check[,1]== 353358909, "Yes",ifelse(check[,1]==104430631,"No",NA))
  
  colnames(check)[2] <- varname
  
  recrbio1 <-   cbind(recrbio1,subset(check,select=varname))
  
}


#need to make sure BioChk_CompleteBL_v1r0 is not in their twice--cols 39 & 40 right now
recrbio_1 <- recrbio1[!duplicated(names(recrbio1))]


#new column order requested 11/22/23
recrbio_1 <- recrbio_1[, c("Connect_ID","RcrtES_Site_v1r0","BioFin_BaseBloodCol_v1r0","BioFin_BaseUrineCol_v1r0","BioFin_BaseMouthCol_v1r0","BioSpm_BloodSettingBL_v1r0",
                           "BioSpm_UrineSettingBL_v1r0","BioSpm_MWSettingBL_v1r0","BioChk_CompleteBL_v1r0","BioChk_TimeBL_v1r0","BioFin_CheckOutTmBL_v1r0","BioFin_ResearchBldTmBL_v1r0",
                           "BioFin_ResearchUrnTmBL_v1r0","BioFin_BMTimeBL_v1r0","BioClin_SiteBldLocBL_v1r0","BioClin_SiteUrLocatBL_v1r0","BioClin_SntBloodAccIDBL_v1r0",
                           "BioClin_SntUrineAccIDBL_v1r0", "BioClin_PolyBloodIDBL_v1r0","BioClin_PolyUrineIDBL_v1r0","BioClin_SiteBloodCollBL_v1r0","BioClin_ClinBloodTmBL_v1r0",
                           "BioClin_SiteUrineCollBL_v1r0", "BioClin_ClinicalUrnTmBL_v1r0","BioClin_SiteBloodRRLBL_v1r0","BioClin_SiteBldRRLDtBL_v1r0","BioClin_SiteUrineRRLBL_v1r0",
                           "BioClin_SiteUrnRRLDtBL_v1r0", "BioClin_BldOrUrnPlcdBL_v1r0","BioClin_BldUrnPlcdTmBL_v1r0","BioClin_BldOrderPlcdBL_v1r0","BioClin_BldOrdPlacdDtBL_v1r0",
                           "BioClin_UrnOrdPlacedBL_v1r0", "BioClin_UrnOrdPlcdDtBL_v1r0","BioClin_DBBloodRRLBL_v1r0","BioClin_DBBloodRRLDtBL_v1r0","BioClin_DBUrineRRLBL_v1r0",
                           "BioClin_DBUrineRRLDtBL_v1r0","BioClin_AnySpecRRLBL_v1r0", "BioClin_AnySpecRRLTmBL_v1r0","BioClin_AnyBldUrnRecBL_v1r0","RcrtSI_RecruitType_v1r0",
                           "RcrtUP_Submitted_v1r0","RcrtV_Verification_v1r0","RcrtV_VerificationTm_V1R0", "SrvBLM_ResSrvCompl_v1r0","SrvBLM_TmComplete_v1r0","SrvBLM_TmStart_v1r0",
                           "SrvBlU_BaseComplete_v1r0","SrvBlU_TmComplete_v1r0","SrvBlU_TmStart_v1r0",
                           "BioClin_BldAndUrnRef_v1r0", "HdRef_Baseblood_v1r0","HdRef_DateBaseblood_v1r0",
                           "SrvMtW_TmComplete_v1r0", "SrvMtW_TmStart_v1r0", "SrvMtW_BaseComplete_v1r0", 
                           "BioKit_KitTypeBL_v1r0" , "BioKit_KitStatusBL_v1r0", "BioKit_KitShipTmBL_v1r0", "BioKit_KitRecdTmBL_v1r0", "token")]
#BioClin_DBUrineRRLBL_v1r0    showing as null but in the DD 
#"BioClin_PolyBloodIDBL_v1r0" "BioClin_PolyUrineIDBL_v1r0" showing as not in this df but variable name hasn't changed in DD


# #For some reason the yes/no of some columns are changing back to CIDs
recrbio_1[recrbio_1== as.character("353358909")] = "Yes"
recrbio_1[recrbio_1== as.character("104430631")] = "No"
# 
# recrbio1.replace({'353358909': 'Yes'}, regex=True, inplace=True)


# write.csv(recrbio1,paste(local_drive, "Connect_prod_recr_veriBiospe_Formats_",currentDate,".csv",sep=""),row.names = F,na="")
write.csv(recrbio_1,glue("{local_drive}Connect_prod_recr_veriBiospe_Formats_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")



```



```{r kit_data,eval=TRUE,echo=FALSE,include=FALSE, warning=FALSE}

kitA <- "SELECT 
Connect_ID, 
d_194252513 as BioKit_ReturnKitID_v1r0,
d_259846815 as BioKit_MWCupID_v1r0,
d_690210658 as BioKit_SupplyKitID_v1r0,
d_786397882 as BioKit_MWCardID_v1r0,
d_341636034 as BioKit_KitDatePend_v1r0,
cast(d_531858099 as INT) as BioKit_SupplyKitTrack_v1r0,
d_661940160 as BioKit_KitShipTmBL_v1r0,
d_687158491 as BioKit_KitAssembledIDBL_v1r0,
d_755095663 as BioKit_MWKitComments_v1r0,
d_826941471 as BioKit_KitRecdTmBL_v1r0,
#CAST(d_972453354 AS NUMERIC) as BioKit_ReturnKitTrack_v1r0,
#CAST(REGEXP_REPLACE(d_972453354, r'[^0-9]', '') AS NUMERIC) AS BioKit_ReturnKitTrack_v1r0,
d_972453354 as BioKit_ReturnKitTrack_v1r0,



CASE
    WHEN d_633640710_d_100618603 = '353358909' THEN 'Yes'
    WHEN d_633640710_d_100618603 = '104430631' THEN 'No'
    ELSE 'NA'
  END AS BioKit_OthPkgCond_v1r0,
  CASE
    WHEN d_137401245 = '353358909' THEN 'Yes'
    WHEN d_137401245 = '104430631' THEN 'No'
    ELSE 'NA'
  END AS BioKit_CollCardMissing_v1r0,
  CASE
    WHEN d_633640710_d_205954477 = '353358909' THEN 'Yes'
    WHEN d_633640710_d_205954477 = '104430631' THEN 'No'
    ELSE 'NA'
  END AS BioKit_CollCupDamage_v1r0,
  CASE
    WHEN d_633640710_d_289239334 = '353358909' THEN 'Yes'
    WHEN d_633640710_d_289239334 = '104430631' THEN 'No'
    ELSE 'NA'
  END AS BioKit_CollCupLeak_v1r0,
  CASE
    WHEN d_633640710_d_427719697 = '353358909' THEN 'Yes'
    WHEN d_633640710_d_427719697 = '104430631' THEN 'No'
    ELSE 'NA'
  END AS BioKit_CollCupNotRet_v1r0,
  CASE
    WHEN d_633640710_d_541085383 = '353358909' THEN 'Yes'
    WHEN d_633640710_d_541085383 = '104430631' THEN 'No'
    ELSE 'NA'
  END AS BioKit_IncMatRet_v1r0,
  CASE
    WHEN d_633640710_d_545319575 = '353358909' THEN 'Yes'
    WHEN d_633640710_d_545319575 = '104430631' THEN 'No'
    ELSE 'NA'
  END AS BioKit_PkgCrushed_v1r0,
  CASE
    WHEN d_633640710_d_938338155 = '353358909' THEN 'Yes'
    WHEN d_633640710_d_938338155 = '104430631' THEN 'No'
    ELSE 'NA'
  END AS BioKit_ImpPkging_v1r0,
  CASE
    WHEN d_633640710_d_950521660 = '353358909' THEN 'Yes'
    WHEN d_633640710_d_950521660 = '104430631' THEN 'No'
    ELSE 'NA'
  END AS BioKit_PkgGoodCond_v1r0,
  CASE
    WHEN d_633640710_d_992420392 = '353358909' THEN 'Yes'
    WHEN d_633640710_d_992420392 = '104430631' THEN 'No'
    ELSE 'NA'
  END AS BioKit_EmptyCupRet_v1r0,


  CASE
    WHEN d_221592017 = '517216441' THEN 'Pending'
    WHEN d_221592017 = '849527480' THEN 'Address printed'
    WHEN d_221592017 = '241974920' THEN 'Assigned'
    WHEN d_221592017 = '277438316' THEN 'Shipped'
    WHEN d_221592017 = '375535639' THEN 'Received'
    ELSE 'NA'
  END AS BioKit_KitStatusBL_v1r0,

  CASE
    WHEN d_379252329 = '976461859' THEN 'Mouthwash'
    ELSE 'NA'
  END AS BioKit_KitTypeBL_v1r0,
    CASE
    WHEN d_418571751 = '266600170' THEN 'Baseline'
    ELSE 'NA'
  END AS BioKit_CollRound_v1r0,



FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.kitAssembly_JP` 

where Connect_ID is not null"
kit_A_table <- bq_project_query(project, kitA)
kitA_table <- bq_table_download(kit_A_table, bigint="integer64",n_max = Inf, page_size = 10000)

#To remove any parenthases and avoid sceintific notation
#options(scipen = 999)
#library(bit64)
kitA_table$BioKit_ReturnKitTrack_v1r0 <- gsub("[()]", "", kitA_table$BioKit_ReturnKitTrack_v1r0)
#kitA_table$BioKit_SupplyKitTrack_v1r0 <- as.numeric(kitA_table$BioKit_SupplyKitTrack_v1r0)
kitA_table$BioKit_ReturnKitTrack_v1r0 <- as.numeric(kitA_table$BioKit_ReturnKitTrack_v1r0)


write.csv(kitA_table,glue("{local_drive}Connect_prod_KitAssembly_Table_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")

```

