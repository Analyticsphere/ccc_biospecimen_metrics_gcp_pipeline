---
title: "Biospecimen Weekly Metrics RMD"
author: "Kelsey Sanchez"
date: "Data Extracted and Report Ran: `r Sys.Date()`"
header-includes:  
    \usepackage[labelformat=empty]{caption}
    \usepackage{placeins}
    \usepackage{booktabs}
    \usepackage{pdflscape}
    \usepackage{longtable}


output:
  pdf_document:
      latex_engine: xelatex
      extra_dependencies: ["float", "longtable", "booktabs"]
      toc: true
      keep_tex: yes
      fig_width: 7
      fig_height: 5
      fig_caption: true
      df_print: paged 
---



This Weekly Metrics report contains tables and plots for the Connect Biospecimen samples, many stratified
by health provider site. This information pertains to verified participants as of the date above and collections
that are finalized. This report is limited to information from participants' first finalized specimen collection. In the even that a participant donated specimen(s) in a repeat collection, that information is not reflected in this report.

  
```{r setup,eval=TRUE,include=FALSE,echo=FALSE, warning=FALSE}

#    latex_engine: xelatex -- this was in the set up previously, but caused issues when running locally so it was removed 

#old.packages()
#update.packages()  


library(bigrquery)
library(data.table) ###to write or read and data management 
library(dplyr) ###data management
# library(boxr) ###read or write data from/to box
library(tidyverse) ###for data management
library(reshape)  ###to work on transition from long to wide or wide to long data
library(listr) ###to work on a list of vector, files or..
library(sqldf) ##sql
library(lubridate) ###date time
library(ggplot2) ###plots
#library(ggpubr) ###for the publications of plots
#library(RColorBrewer) ###visions color http://www.sthda.com/english/wiki/colors-in-r
library(gridExtra)
library(stringr) ###to work on patterns, charaters
#library(plyr)
library(tinytex) #for pdf
#library(rmarkdown) ###for the output tables into other files: pdf, rtf, etc.
library(janitor) #to get the summary sum
library(finalfit) #https://cran.r-project.org/web/packages/finalfit/vignettes/export.htmlt
library(expss) ###to add labels
library(epiDisplay) ##recommended applied here crosstable, tab1
library(summarytools) ##recommended
library(gmodels) ##recommended
library(magrittr)
library(arsenal)
library(gtsummary)
library(kableExtra)
library(gt)
library(crosstable)
#library(cowplot)
#library(webshot2)
library(glue) 
library(readr)
library(rio)
library(scales) #for commas in the thousands place to be applied automatically
#options(knitr.table.format = "latex")
currentDate <- Sys.Date()
currentDate <- as.Date(currentDate)

bq_auth()

### Set Box folders for output CSV files #######################################
use_test_box_folder <- TRUE # Local user sets this (Jake or Kelsey)

# Over-ride if using plumber api on GCP (USER DOESN'T TOUCH THIS!)
# Check if the environment variable exists and is not empty
if (!is.null(Sys.getenv("USE_TEST_BOX_FOLDER")) &&
    Sys.getenv("USE_TEST_BOX_FOLDER") != "") {
  use_test_box_folder <- as.logical(Sys.getenv("USE_TEST_BOX_FOLDER"))
}

if (use_test_box_folder) {
  boxfolder <- 222593912729 # test box folder
} else {
  boxfolder <- 221280601453 # destination of CSV files (not pdf)
}


##### Making sure personal C drives aren't referenced if this code is being used by others


#Change to FALSE if referencing this code
write_to_local_drive = F #F

#local_drive="C:/Users/dowlingk2/Documents/Module-Missingness-and-Metrics/data/"    


### This function below is put before any write.csv functions, and "filename" is updated. It determines wheteher the file will be created locally or not.
#filename=
local_drive= ifelse(write_to_local_drive, "C:/Users/dowlingk2/Documents/Module-Missingness-and-Metrics/data/", "")


# knitr::opts_chunk$set(
#   echo = FALSE,
#   warning = FALSE,   
#   message = FALSE,   
#   #fig.keep = "high", # Keep high-resolution plots for display but not save them
#   fig.path = NULL    # Avoid saving to any specific folder
# )


```

```{r BQPull, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}
##import data to R

project <- "nih-nci-dceg-connect-prod-6d04"

bio_tb <- bq_project_query(project, 
                           query='SELECT * FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.biospecimen_JP` where d_410912345 is not null and Connect_ID is not null')  
biospe <- bq_table_download(bio_tb,bigint="integer64",n_max = Inf) #, page_size = 1000)
cnames <- names(biospe)
###to check variables in recr_noinact_wl1

numbers_only <- function(x) !grepl("\\D", x)

for (i in 1: length(cnames)){
  varname <- cnames[i]
  var<-pull(biospe,varname)
  biospe[,cnames[i]] <- ifelse(numbers_only(var), as.numeric(as.character(var)), var)
}


tb_box <- bq_project_query(project, query="SELECT * FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.boxes_JP`")
box_wl_flat <- bigrquery::bq_table_download(tb_box,bigint="integer64",n_max = Inf, page_size = 1000)


urlfile<- "https://raw.githubusercontent.com/episphere/conceptGithubActions/master/csv/masterFile.csv" ###to grab the updated dd from github
y <- read.csv(urlfile) #the masterDD has just been updated which can't easily pulled from github directly as before. I need to download from the raw file in the github


dictionary <- rio::import("https://episphere.github.io/conceptGithubActions/aggregate.json",format = "json")
dd<-rbindlist(dictionary,fill=TRUE,use.names=TRUE,idcol="CID") #THIS TABLE HAS REPLICATED (CIDS+LABELS) WITH DIFFERENT VARIABLE NAMES,



#to convert the numeric variables
numbers_only <- function(x) !grepl("\\D", x)
cnames <- names(box_wl_flat)
###to check variables in recr_noinact_wl1
data2 <- box_wl_flat
for (i in 1: length(cnames)){
  varname <- cnames[i]
  var<-pull(data2,varname)
  data2[,cnames[i]] <- ifelse(numbers_only(var), as.numeric(as.character(var)), var)
}


##to select biospecimen data in recruitment 
recr_var <- bq_project_query(project, query="SELECT * FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect`.INFORMATION_SCHEMA.COLUMN_FIELD_PATHS WHERE table_name='participants_JP'")
recrvar <- bigrquery::bq_table_download(recr_var, bigint="integer64",n_max = Inf, page_size = 10000)
urlfile<- "https://raw.githubusercontent.com/episphere/conceptGithubActions/master/csv/masterFile.csv" ###to grab the updated dd from github 
y <- read.csv(urlfile)
recrvar_nd <- recrvar[which(grepl("d_",recrvar$column_name)),c("column_name","field_path")]

recrvar_nd$last.CID <- ifelse(grepl("d_",recrvar_nd$column_name),substring(sapply(strsplit(recrvar_nd$column_name,"d_"),tail,1),1,9),NA)
recrvar_nd_label <- base::merge(recrvar_nd, y[,c("Primary.Source","conceptId.2","conceptId.3","Variable.Label","conceptId.4","Current.Format.Value")],by.x="last.CID",by.y="conceptId.3",all.x=TRUE)


recrvar.bio <- recrvar_nd_label[which(recrvar_nd_label$Primary.Source =="Biospecimen" | grepl("biospecimen|blood|urine|mouthwash|collection|Blood|Urine|Mouthwash|MW|Ur|Ur Surv|MW Surv",recrvar_nd_label$Variable.Label)),] #49
query <- unique(recrvar.bio$column_name)
select <- paste(recrvar.bio$column_name,collapse=",")

tb_bq <- eval(parse(text=paste("bq_project_query(project, query=\"SELECT token,Connect_ID,d_512820379,d_821247024,d_914594314,d_827220437,d_699625233, d_265193023, d_822499427, 
                               d_222161762, state_d_667474224, state_d_934298480, state_d_684926335, state_d_849518448, state_d_119643471, state_d_253532712, state_d_435027713, state_d_706256705,",
                               select,
                               "FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` Where Connect_ID is not null and d_821247024 = '197316935' and  (d_512820379='486306141' or d_512820379='854703046')  and 
                               d_831041022 = '104430631'\")",
                               sep=" ")))
#removed "date", as it is no longer in the participants table

recr.bio <- bigrquery::bq_table_download(tb_bq,bigint="integer64",n_max = Inf, page_size = 1000)




##to convert to numeric
cnames <- names(recr.bio)
recrver <- recr.bio
for (i in 1: length(cnames)){
  varname <- cnames[i]
  var<-pull(recrver,varname)
  recrver[,cnames[i]] <- ifelse(numbers_only(var), as.numeric(as.character(var)), var)
}
##to get the labels of each variable
recrver_CID <- as.data.frame(sapply((strsplit(colnames(recrver),"d_")),tail,1))
colnames(recrver_CID)[1] <- "CID"
recrver_CID$variable <- names(recr.bio)
recrver_ver1 <- base::merge(dd,recrver_CID,by="CID")
recrver1 <- expss::apply_labels(recrver,
                                d_512820379 = "Recruitment type",#RcrtSI_RecruitType_v1r0
                                d_512820379=c(	"Not active"=180583933,  
                                               "Active"= 486306141, 
                                               "Passive"=854703046),
                                d_821247024 = "Verification status", #RcrtV_Verification_v1r0
                                d_821247024 = c("Not yet verified" =875007964,
                                                "Verified"=197316935,  
                                                "Cannot be verified"=219863910, 
                                                "Duplicate"=922622075 , 
                                                "Outreach timed out"= 160161595),
                                d_827220437 = "Site",#RcrtES_Site_v1r0
                                d_827220437 = c("Baylor Scott and White Health"=472940358,"HealthPartners"= 531629870, 
                                                "Henry Ford Health"=548392715,"Marshfield Clinic Health System" = 303349821,
                                                "Sanford Health" = 657167265, "University of Chicago Medicine" = 809703864,
                                                "Kaiser Permanente Colorado" = 125001209,"Kaiser Permanente Georgia" = 327912200,
                                                "Kaiser Permanente Hawaii" = 300267574,"Kaiser Permanente Northwest" = 452412599),
                                d_914594314 = "Verification status time",   #RcrtV_VerificationTm_V1R0
                                d_878865966 = "Baseline blood sample collected", #BioFin_BaseBloodCol_v1r0
                                d_878865966 = c("Any blood collected"=353358909, "No blood collected"=104430631),
                                d_173836415_d_266600170_d_561681068 = "Date/time basline Research Blood Collected",#BL_BioFin_BBTime_v1r0
                                d_684635302 = "Baseline Mouthwash Collected",    #BioFin_BaseMWCol_v1r0
                                d_684635302 = c("Any mouthwash collected"=353358909,"No mouthwash collected"= 104430631  ),
                                d_173836415_d_266600170_d_448660695 = "Date/time Mouthwash Collected", #
                                d_167958071 = "Baseline Urine collected", 
                                d_167958071 = c( "Any urine collected"=353358909, "No urine collected"=104430631),
                                d_173836415_d_266600170_d_847159717 = "Baseline Date/time Urine collected",
                                d_331584571_d_266600170_d_135591601 = "Baseline Check In Complete",#BL_BioChk_Complete_v1r0
                                d_331584571_d_266600170_d_135591601 =  c( "No"=104430631, "Yes"=353358909 ),
                                d_331584571_d_266600170_d_840048338 = "Date/Time Baseline Check In Complete",
                                d_331584571_d_266600170_d_343048998 = "Time Baseline check out complete",#
                                
                                d_173836415_d_266600170_d_530173840 = "Blood Order Placed",#BioClin_BldOrderPlaced_v1r0  ## I ADDED
                                d_173836415_d_266600170_d_530173840 =c( "No"=104430631, "Yes"=353358909 ), ## I ADDED
                                
                                d_173836415_d_266600170_d_592099155 = "Blood Collection Setting",#BL_BioSpm_BloodSetting_v1r0  
                                d_173836415_d_266600170_d_592099155 =c("Research"=534621077, "Clinical"= 664882224,"Home" =103209024),
                                d_173836415_d_266600170_d_718172863 = "Urine Collection Setting",#BL_BioSpm_UrineSetting_v1r0
                                d_173836415_d_266600170_d_718172863 =c("Research"=534621077, "Clinical"= 664882224,"Home" =103209024),
                                d_173836415_d_266600170_d_915179629 = "Mouthwash Collection Setting",#BL_BioSpm_MWSetting_v1r0
                                d_173836415_d_266600170_d_915179629 =c("Research"=534621077, "Clinical"= 664882224,"Home" =103209024),
                                
                                d_265193023 = "Blood/urine/mouthwash combined research survey-Complete",   
                                d_265193023 = c(	"Not Started" =	972455046, "Started"= 615768760,"Submitted"= 231311385),#SrvBLM_ResSrvCompl_v1r0
                                d_822499427 = "Placeholder (Autogenerated) - Date/time Status of Start of blood/urine/mouthwash research survey",#SrvBLM_TmStart_v1r0
                                d_222161762  = "Placeholder (Autogenerated)- Date/Time blood/urine/mouthwash research survey completed" #   SrvBLM_TmComplete_v1r0
)
###to convert to categorical variables
#recrver1$RcrtSI_RecruitType_v1r0 <- factor(recrver1$d_512820379, exclude=NULL)
#recrver1$RcrtV_Verification_v1r0 <- factor(recrver1$d_821247024, exclude=NULL)
recrver1$BioFin_BaseMWCol_v1r0  <-factor(recrver1$d_684635302,exclude=NULL)
recrver1$BioFin_BaseBloodCol_v1r0 <- factor(recrver1$d_878865966,levels=c("Any blood collected","No blood collected"))
recrver1$BioFin_BaseUrineCol_v1r0 <- factor(recrver1$d_167958071,exclude=NULL)
recrver1$BioClin_BldOrderPlaced_v1r0 <- factor(recrver1$d_173836415_d_266600170_d_530173840,exclude=NULL) ## I ADDED
#recrver1$SrvBLM_ResSrvCompl_v1r0 <-factor(recrver1$d_265193023,exclude=NULL)



recrver1$BL_BioSpm_MWSetting_v1r0 <- factor(recrver1$d_173836415_d_266600170_d_915179629,levels=c("Clinical","Research","Home"))  
recrver1$BL_BioSpm_UrineSetting_v1r0 <- factor(recrver1$d_173836415_d_266600170_d_718172863, levels=c("Clinical","Research","Home"))  
recrver1$BL_BioSpm_BloodSetting_v1r0 <- factor(recrver1$d_173836415_d_266600170_d_592099155,levels=c("Clinical","Research","Home"))  

#recrver1$BL_BioChk_Complete_v1r0 <- factor(recrver1$d_331584571_d_266600170_d_135591601,exclude=NULL)
recrver1$Site <-factor(recrver1$d_827220437,levels=c("Baylor Scott and White Health","HealthPartners", "Henry Ford Health",
                                                     "Marshfield Clinic Health System",
                                                     "Sanford Health", "University of Chicago Medicine","Kaiser Permanente Colorado",
                                                     "Kaiser Permanente Georgia","Kaiser Permanente Hawaii","Kaiser Permanente Northwest"))








### Each week must start on Monday and end with the following Sunday to be consitent with all reports
veristart.date = as.Date(min(as.POSIXct(recr.bio$d_914594314),na.rm=TRUE))
#veristart.date + days(5)
#[1] "2021-08-01"

```


```{r Functions, include=FALSE}


n_pct_table <- function(x,y){
  #x<-clinicnotes.notcol$Site
  #y<-clinicnotes.notcol$notcol.notes
  ctable<- CrossTable(x,y)
  count <- as.data.frame.matrix(ctable$t)
  perc <- as.data.frame.matrix(ctable$prop.col)
  n<- as.numeric(length(levels(x)))
  m <- as.numeric(length(levels(y)))
  tb_combo <- array(pct_n(ctable$t,ctable$prop.col),dim=c(n,m)) 
  tb_combo <- as.data.frame(tb_combo)
  colnames(tb_combo) <- colnames(count)
  
  total <- sum(count)
  count$Total <- apply(count,1,sum)
  tb_combo$Total <- paste0(count$Total, "( ", round(100*(count$Total)/total,1), " %)")
  
  tb_combo$Site <- rownames(count)
  tb_combo[(n+1),c(1:(m+1))] <- as.character(apply(count,2,sum))
  tb_combo$Site[is.na(tb_combo$Site)] <- replace_na("Total")  
  return(tb_combo)
}



pct_n <- function(x,y){ paste0(x,"( ", round(100*y,2), " %)")}



create_tbl_cross <- function(data, row_var, colm_var, row_or_col_pct, row_name, column_name){
cross__table <- data %>%  
  tbl_cross(
    row = !!sym(row_var),
    col = !!sym(colm_var),
    digits=c(0,1),
    percent = row_or_col_pct,
    label=list(!!sym(row_var) ~ row_name,
               !!sym(colm_var) ~ column_name),
    missing="ifany",
    margin_text="Total") 

#Ops doesn't like the grouped by variables on a different line the column labels
cross_table_df <- as.data.frame(cross__table)[-1, ]
  
}


create_tbl_cross2 <- function(data, row_var, colm_var, row_or_col_pct, row_name, column_name, margin_text) {
  cross__table <- data %>%
    tbl_cross(
      row = !!sym(row_var),
      col = !!sym(colm_var),
      label = list(!!sym(row_var) ~ row_name,
                   !!sym(colm_var) ~ column_name),
      percent = row_or_col_pct,
      digits = c(0, 2),
      margin_text = margin_text
    )
  
  # Check if table_body exists and has data
  if (!is.null(cross__table[["table_body"]]) && nrow(cross__table[["table_body"]]) > 0) {
    # Need only the total column to be a column percentage
    cross__table[["table_body"]]$stat_0 <- sapply(strsplit(cross__table[["table_body"]]$stat_0, " "), "[", 1)
    
    cross__table_df <- as.data.frame(cross__table)[2:nrow(as.data.frame(cross__table)), ]
    colnames(cross__table_df)[1] <- row_name
    
    # Ensure 'Total Verified Participants' exists before modifying
    if ("Total Verified Participants" %in% colnames(cross__table_df)) {
      cross__table_df$`Total Verified Participants` <- as.numeric(gsub(",", "", cross__table_df$`Total Verified Participants`))
      
      total_participants <- cross__table_df$`Total Verified Participants`
      percentages <- round((total_participants / total_participants[length(total_participants)]) * 100, digits = 2)
      
      cross__table_df$`Total Verified Participants` <- paste0(format(total_participants, big.mark = ","), " (", percentages, "%)")
    }
    
    colnames(cross__table_df)[ncol(cross__table_df)] <- "Total Verified \n Participants"
    return(cross__table_df)
  } else {
    warning("The cross table is empty or missing table_body.")
    return(data.frame()) # Return an empty data frame if table_body is missing
  }
}




# Function to add total row, total column, and calculate row/column percentages
add_totals_and_percentages <- function(df, total_position = c("row", "col", "both"), 
                                       percentage_type = c("row", "col")) {
  
  # Ensure the 'total_position' and 'percentage_type' are valid options
  total_position <- match.arg(total_position)
  percentage_type <- match.arg(percentage_type)
  
  # Add totals (row, column, or both)
  if (total_position == "row" || total_position == "both") {
    df <- df %>%
      adorn_totals("row")  # Add total row
  }
  
  if (total_position == "col" || total_position == "both") {
    df <- df %>%
      adorn_totals("col")  # Add total column
  }
  
  # Save counts separately to combine with percentages
  counts <- df
  
  # Calculate percentages (row or column)
  df <- df %>%
    adorn_percentages(percentage_type) %>%
    adorn_pct_formatting(digits = 1)
  
  # Combine counts and percentages in the desired format: "count (percentage)"
  df <- counts %>%
    mutate(across(-1, ~ paste0(comma(.x), " (", df[[cur_column()]], ")")))
  
  return(df)
}


###################



#allows gt tables to go onto a second page if it gets too long
gt::gt_latex_dependencies()


```




```{r Removing_Duplicates, include=FALSE}

# Ops no longer wants duplicate collections in this report
## REMOVING DUPLICATES: Method- take the first collection and drop the second collection
##### NOTE: Home MW collections are separate collections BUT they are not finalized, so they will not be removed from the dataframe 


# Step 1: Find the duplicate rows
## 295- one person has three rows; 147 individuals 
actual_dups <- biospe %>%
  filter(!is.na(d_556788178)) %>%
  group_by(Connect_ID) %>%
  filter(n() > 1)

# Step2: Of the duplicate rows, keep the one with the first collection time stamp
#Keeping 147- each person keeps their lower collection time
rows_to_keep <- actual_dups %>%
  group_by(Connect_ID) %>%
  filter(d_556788178 == min(d_556788178, na.rm = TRUE)) %>%
  ungroup()


# Take all duplicate rows out of the original dataframe
#Take the 295 from the original 52650 rows, totaling ==52,355
non_duplicate_rows <- biospe %>%
    anti_join(actual_dups, by = c("Connect_ID", "d_556788178"))  # Ensure all columns are included

# Combine new overall dataframe with those duplicate rows we filtered with the earlier time stamp
#52,355+147=52502
no_dups <- bind_rows(rows_to_keep, non_duplicate_rows)


```

```{r Labeling2, include=FALSE}

no_dups <- expss::apply_labels(no_dups,d_827220437 = "Site",#RcrtES_Site_v1r0
                             d_827220437 = c("Baylor Scott and White Health"=472940358, "HealthPartners"= 531629870, "Henry Ford Health"=548392715,
                                             "Marshfield Clinic Health System" = 303349821,"Sanford Health" = 657167265, 
                                             "University of Chicago Medicine" = 809703864, "Kaiser Permanente Colorado" = 125001209,
                                             "Kaiser Permanente Georgia" = 327912200,"Kaiser Permanente Hawaii" = 300267574,"Kaiser Permanente Northwest" = 452412599))

no_dups$Site <- factor(no_dups$d_827220437, levels= c("Baylor Scott and White Health", "HealthPartners", "Henry Ford Health","Marshfield Clinic Health System",
                                                      "Sanford Health", "University of Chicago Medicine","Kaiser Permanente Colorado","Kaiser Permanente Georgia",
                                                      "Kaiser Permanente Hawaii","Kaiser Permanente Northwest")) 



no_dups <- no_dups %>% 
  mutate(
    Site_location = case_when(
      #UC
      d_951355211 == 777644826 ~ "UC-DCAM",
      d_951355211 == 145191545 ~ "Ingalls Harvey",
      d_951355211 == 489380324 ~ "River East",
      d_951355211 == 120264574 ~ "South Loop",
      d_951355211 == 319518299 ~ "UCM Pop-Up",
      d_951355211 == 940329442 ~ "Orland Park"
      #HP
      d_951355211 == 834825425 ~ "HP Research Clinic",
      d_951355211 == 574368418 ~ "HP Park Nicollet",
      #HFH
      d_951355211 == 736183094 ~ "HFH K-13 Research Clinic",
      d_951355211 == 886364332 ~ "HFH Cancer Pavilion Research Clinic",
      d_951355211 == 706927479 ~ "HFH Livonia Research Clinic",
      d_951355211 == 322059622 ~ "HFH Pop-Up",
      d_951355211 == 911683679 ~ "HFH Detroit Northwest",
      d_951355211 == 852689772 ~ "In-home Collection",
      #MF
      d_951355211 == 692275326 ~ "Marshfield",
      d_951355211 == 813701399 ~ "Weston",
      d_951355211 == 698283667 ~ "Lake Hallie",
      d_951355211 == 691714762 ~ "Rice Lake",
      d_951355211 == 487512085 ~ "Wisconsin Rapids",
      d_951355211 == 983848564 ~ "Colby Abbotsford",
      d_951355211 == 261931804 ~ "Minocqua",
      d_951355211 == 665277300 ~ "Merrill",
      d_951355211 == 567969985 ~ "MF Pop-Up",
      d_951355211 == 255636184 ~ "Stevens Point",
      d_951355211 == 813412950 ~ "Neillsville",
      #BSWH
      d_951355211 == 723351427 ~ "BCC- HWC",
      d_951355211 == 807443231 ~ "FW All Saints",
      d_951355211 == 475614532 ~ "BCC- Plano",
      d_951355211 == 809370237 ~ "BCC- Worth St",
      d_951355211 == 856158129 ~ "BCC- Irving",
      d_951355211 == 397883980 ~ "Irving",
      d_951355211 == 436956777 ~ "NTX Biorepository",
      d_951355211 == 288564244 ~ "BCC- Fort Worth",
      #SF
      d_951355211 == 769594361 ~ "Fargo Amber Valley",
      d_951355211 == 589224449 ~ "Sioux Falls Imagenetics",
      d_951355211 == 467088902 ~ "Fargo South University",
      d_951355211 == 246137578 ~ "Edith Sanford Breast Center (coded as Sanford Center)",
      d_951355211 == 433070901 ~ "Edith Sanford Breast Center",
      #Missing
      is.na(d_951355211) & Site=='University of Chicago Medicine' ~ "Missing UC location",
      is.na(d_951355211) & Site=='HealthPartners' ~ "Missing HP location",
      is.na(d_951355211) & Site=='Marshfield Clinic Health System' ~ "Missing MF location",
      is.na(d_951355211) & Site=='Sanford Health' ~ "Missing SF location",
      is.na(d_951355211) & Site=='Henry Ford Health' ~ "Missing HFH location",
      is.na(d_951355211) & Site=='Baylor Scott and White' ~ "Missing BSWH location",
      TRUE ~ "Unidentified location"
    )
  )



recrver1 <- recrver1 %>%  mutate(Clin_Site_location=case_when(
                                  Site=="HealthPartners" & (d_173836415_d_266600170_d_185243482 == 2 | d_173836415_d_266600170_d_452847912 == 2) ~ "Elk River",
                                  Site=="HealthPartners" & (d_173836415_d_266600170_d_185243482 == 3 | d_173836415_d_266600170_d_452847912 == 3) ~ "Chanhassen",
                                  Site=="HealthPartners" & (d_173836415_d_266600170_d_185243482 == 4 | d_173836415_d_266600170_d_452847912 == 4) ~ "Park Nicollet Minneapolis Clinic",
                                  Site=="HealthPartners" & (d_173836415_d_266600170_d_185243482 == 6 | d_173836415_d_266600170_d_452847912 == 6) ~ "Brooklyn Center",
                                  Site=="HealthPartners" & (d_173836415_d_266600170_d_185243482 == 7 | d_173836415_d_266600170_d_452847912 == 7) ~ "Clinic Stillwater",
                                  Site=="HealthPartners" & (d_173836415_d_266600170_d_185243482 == 8 | d_173836415_d_266600170_d_452847912 == 8) ~ "New Richmond Clinic",
                                  d_173836415_d_266600170_d_185243482 == 1050010095 | d_173836415_d_266600170_d_452847912 == 1050010095 |
                                    d_173836415_d_266600170_d_185243482 == 1050010034 | d_173836415_d_266600170_d_452847912 == 1050010034 ~ "Wyandotte",
                                  d_173836415_d_266600170_d_185243482 == 1060010063 |
                                    d_173836415_d_266600170_d_185243482 == 1060170018 |
                                    d_173836415_d_266600170_d_452847912 == 1060010063 |
                                    d_173836415_d_266600170_d_452847912 == 1060170018 ~ "Macomb",
                                  d_173836415_d_266600170_d_185243482 == 1040010047 |
                                    d_173836415_d_266600170_d_185243482 == 1040010046 |
                                    d_173836415_d_266600170_d_185243482 == 1011220006 |
                                    d_173836415_d_266600170_d_452847912 == 1040010047 |
                                    d_173836415_d_266600170_d_452847912 == 1040010046 |
                                    d_173836415_d_266600170_d_452847912 == 1011220006 ~ "West Bloomfield",
                                  d_173836415_d_266600170_d_185243482 == 1011410008 |
                                    d_173836415_d_266600170_d_452847912 == 1011410008 ~ "Royal Oak",
                                  d_173836415_d_266600170_d_185243482 == 1010180040 |
                                    d_173836415_d_266600170_d_452847912 == 1010180040 ~ "Fairlane (Dearborn)",
                                  d_173836415_d_266600170_d_185243482 == 1010120026 |
                                    d_173836415_d_266600170_d_452847912 == 1010120026 ~ "Columbus",
                                  d_173836415_d_266600170_d_185243482 == 1011660013  |
                                    d_173836415_d_266600170_d_452847912 == 1011660013 ~ "Plymouth",
                                  d_173836415_d_266600170_d_185243482 == 1010360011 |
                                    d_173836415_d_266600170_d_452847912 == 1010360011 ~ "Troy",
                                  d_173836415_d_266600170_d_185243482 == 1010350019 | 
                                    d_173836415_d_266600170_d_452847912 == 1010350019~ "Taylor",
                                  d_173836415_d_266600170_d_185243482 == 1010240013 |
                                    d_173836415_d_266600170_d_452847912 == 1010240013 ~ "Livonia",
                                  d_173836415_d_266600170_d_185243482 == 1010320019 |
                                    d_173836415_d_266600170_d_452847912 == 1010320019 ~ "Sterling Heights",
                                  d_173836415_d_266600170_d_185243482 == 1010010193 |
                                    d_173836415_d_266600170_d_185243482 == 1010010114 |
                                    d_173836415_d_266600170_d_452847912 == 1010010193 |
                                    d_173836415_d_266600170_d_452847912 == 1010010114 ~ "K1 HFH Main",
                                  d_173836415_d_266600170_d_185243482 == 1010200009 |
                                    d_173836415_d_266600170_d_452847912 == 1010200009 ~ "Ford Road",
                                  d_173836415_d_266600170_d_185243482 == 1010270015 |
                                    d_173836415_d_266600170_d_452847912 == 1010270015 ~ "NCO",
                                  d_173836415_d_266600170_d_185243482 == 1050020026 | 
                                    d_173836415_d_266600170_d_452847912 == 1050020026 ~ "Brownstown",
                                  d_173836415_d_266600170_d_185243482 == 1010170010 | 
                                    d_173836415_d_266600170_d_452847912 == 1010170010 ~ "E Jefferson Pathology",
                                  Site=="University of Chicago Medicine" & (d_173836415_d_266600170_d_185243482==1 | d_173836415_d_266600170_d_452847912==1) ~ "South Loop",
                                  Site=="University of Chicago Medicine" & (d_173836415_d_266600170_d_185243482==2 | d_173836415_d_266600170_d_452847912==2) ~ "Orland Park",
                                  Site=="University of Chicago Medicine" & (d_173836415_d_266600170_d_185243482==3 | d_173836415_d_266600170_d_452847912==3) ~ "Kenwood",
                                  Site=="University of Chicago Medicine" & (d_173836415_d_266600170_d_185243482==4 | d_173836415_d_266600170_d_452847912==4) ~ "River East",
                                  Site=="University of Chicago Medicine" & (d_173836415_d_266600170_d_185243482==5 | d_173836415_d_266600170_d_452847912==5) ~ "Dearborn Station",
                                  Site=="University of Chicago Medicine" & (d_173836415_d_266600170_d_185243482==6 | d_173836415_d_266600170_d_452847912==6) ~ "Ingalls",
                                  Site=="University of Chicago Medicine" & (d_173836415_d_266600170_d_185243482==7 | d_173836415_d_266600170_d_452847912==7) ~ "DCAM (Hyde Park)",
                                  Site=="University of Chicago Medicine" & (d_173836415_d_266600170_d_185243482==25 | d_173836415_d_266600170_d_452847912==25) ~ "Crown Point",
                                  Site=="Henry Ford Health" & is.na(d_173836415_d_266600170_d_185243482) & is.na(d_173836415_d_266600170_d_452847912) ~ "Missing HFH location",
                                  Site=="HealthPartners" & is.na(d_173836415_d_266600170_d_185243482) & is.na(d_173836415_d_266600170_d_452847912) ~ "Missing HP location",
                                  Site=="University of Chicago Medicine" & is.na(d_173836415_d_266600170_d_185243482) & is.na(d_173836415_d_266600170_d_452847912) ~ "Missing UC location",
                                  d_173836415_d_266600170_d_185243482==22 | d_173836415_d_266600170_d_452847912==22 |
                                    d_173836415_d_266600170_d_185243482==24 | d_173836415_d_266600170_d_452847912==24 |
                                    d_173836415_d_266600170_d_185243482==28 | d_173836415_d_266600170_d_452847912==28 |
                                    d_173836415_d_266600170_d_185243482==33 | d_173836415_d_266600170_d_452847912==33 |
                                    d_173836415_d_266600170_d_185243482==34 | d_173836415_d_266600170_d_452847912==34 |
                                    d_173836415_d_266600170_d_185243482==35 | d_173836415_d_266600170_d_452847912==35 |
                                    d_173836415_d_266600170_d_185243482==38 | d_173836415_d_266600170_d_452847912==38 |
                                    d_173836415_d_266600170_d_185243482==40 | d_173836415_d_266600170_d_452847912==40 |
                                    d_173836415_d_266600170_d_185243482==55 | d_173836415_d_266600170_d_452847912==55 |
                                    d_173836415_d_266600170_d_185243482==71 | d_173836415_d_266600170_d_452847912==71 ~ "Oahu Clinics",
                                  d_173836415_d_266600170_d_185243482==23 | d_173836415_d_266600170_d_452847912==23 |
                                    d_173836415_d_266600170_d_185243482==26 | d_173836415_d_266600170_d_452847912==26 |
                                    d_173836415_d_266600170_d_185243482==27 | d_173836415_d_266600170_d_452847912==27 |
                                    d_173836415_d_266600170_d_185243482==32 | d_173836415_d_266600170_d_452847912==32 |
                                    d_173836415_d_266600170_d_185243482==37 | d_173836415_d_266600170_d_452847912==37 |
                                    d_173836415_d_266600170_d_185243482==49 | d_173836415_d_266600170_d_452847912==49 |
                                    d_173836415_d_266600170_d_185243482==56 | d_173836415_d_266600170_d_452847912==56 |
                                    d_173836415_d_266600170_d_185243482==69 | d_173836415_d_266600170_d_452847912==69 |
                                    d_173836415_d_266600170_d_185243482==74 | d_173836415_d_266600170_d_452847912==74 |
                                    d_173836415_d_266600170_d_185243482==76 | d_173836415_d_266600170_d_452847912==76 ~ "Non-Oahu Clinics",
                                  d_827220437==327912200 ~ "Kaiser Permanente Georgia",
                                  d_827220437==452412599 ~ "Kaiser Permanente Northwest",
                                  d_827220437==125001209 ~ "Kaiser Permanente Colorado",
                                  d_827220437==657167265 ~ "Sanford Health",
                                  TRUE ~ "Unidentified location"),
                                 BiospeCollection = ifelse((recrver1$d_878865966 == 353358909 | recrver1$d_167958071 == 353358909 | 
                                                              recrver1$d_684635302 == 353358909 ), "Any biospecimen Collections","No biospecimen collections"),
                                 age = case_when(state_d_934298480 == "713781738"~ "30-34",
                                                 state_d_934298480 == '631272782' ~ "35-39",
                                                 state_d_934298480 == '124276120' ~ "40-45",
                                                 state_d_934298480 == '450985724' ~ "46-50",
                                                 state_d_934298480 == '363147933' ~ "51-55",
                                                 state_d_934298480 == '636706443' ~ "56-60",
                                                 state_d_934298480 == '771230670' ~ "61-65",
                                                 state_d_934298480 == '722846087' ~ "66-70"),
                                 race = case_when(state_d_684926335 == '635279662' |state_d_849518448 == '768826601' | state_d_119643471 == '635279662' | state_d_253532712=='723775357' ~ "White, Non-Hispanic" , 
                                                  state_d_684926335 %in% c('232334767', '401335456') |
                                                    state_d_849518448 == '181769837' |
                                                    state_d_253532712 %in% c('153444133','572474909','308427446','211228524','277568192','611398522','181769837') |
                                                    state_d_119643471 %in% c( '232334767','211228524','308427446','432722256','232663805','785578696','200929978','490725843','965998904') ~ "Other",
                                                  state_d_684926335 == '178420302'  | 
                                                    state_d_849518448 == '178420302' | 
                                                    state_d_253532712 == '178420302' |
                                                    state_d_119643471  %in% c( '986445321','746038746','178420302') |
                                                    (is.na(state_d_119643471) & d_827220437 == '657167265') ~ "Unknown"),
                                 sex = case_when(state_d_706256705 == '536341288' | state_d_435027713 == '536341288' ~ "Female",
                                                 state_d_706256705 == '654207589' | state_d_435027713 == '654207589' ~ "Male",
                                                 #state_d_706256705 == '830573274' ~ "Intersex or Other", # too small of a count for now, need to combine with unknown 
                                                 state_d_706256705 == '830573274' | state_d_706256705 == '178420302' | state_d_435027713 == '178420302' ~ "Unknown"))


#biocol.tb <- left_join(recrver1, no_dups, by=c("Connect_ID", "Site", "token"))

biocol.tb <- left_join(recrver1, no_dups, by=c("Connect_ID", "Site"))

```






```{r Tables1.1_1.5, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

## Tables 1-4

#### FOR TABLES 1-4 I CHANGED NO SAMPLES COLLECTED TO BE NO COLLECTED SAMPLES AND ALSO THAT THE PARTICIPANTS DID HAVE A COLLECTION APPOINTMENT, SO THAT THOSE WHO HAVEN'T EVEN SCHEDULEN AN APPT YET ARE NOT COUNTED IN THE NO SAMPLES COLLECTED COLUMN

table1 <- biocol.tb %>%
  mutate(biocol.appoint = case_when(BiospeCollection == "Any biospecimen Collections" & d_410912345== 353358909 ~ "Baseline Collection",
                                    TRUE ~ "No Baseline Collection"))

table1_totals <- create_tbl_cross(table1, "Site", "biocol.appoint", "row", "Site", " ")

biospe.t1 <- knitr::kable(table1_totals, col.names=c("Site", "Baseline Collection","No Baseline Collection", "Total Verified Participants"), caption='Table 1.1: Baseline Biospecimen Collection Status Among Verified Participants', row.names=FALSE,align=c("l","c","c","c"), booktabs = TRUE) %>%  
  add_indent(seq(1, nrow(table1_totals) - 1)) %>% 
  kable_styling(latex_options = "scale_down")








## All collection setting counts

coll_sett_all <- table1 %>%  filter(BiospeCollection == "Any biospecimen Collections" & (d_410912345== 353358909 | BL_BioSpm_MWSetting_v1r0=="Home")) %>% 
  mutate(all_settings = case_when((d_650516960=="664882224" | BL_BioSpm_BloodSetting_v1r0=="Clinical" | 
                                    BL_BioSpm_UrineSetting_v1r0=="Clinical" | BL_BioSpm_MWSetting_v1r0=="Clinical") ~ "Clinical",
                                  (d_650516960=="534621077" | BL_BioSpm_BloodSetting_v1r0=="Research" | 
                                    BL_BioSpm_UrineSetting_v1r0=="Research" | BL_BioSpm_MWSetting_v1r0=="Research")~ "Research",
                                  (d_650516960=="103209024" | BL_BioSpm_BloodSetting_v1r0=="Home" | 
                                    BL_BioSpm_UrineSetting_v1r0=="Home" | BL_BioSpm_MWSetting_v1r0=="Home") ~ "Home"))

table1_allsett <- create_tbl_cross(coll_sett_all, "Site", "all_settings", "row", "Site", "Collection Setting")  

settings_breakdown <- knitr::kable(table1_allsett, 
                                   caption='Table 1.2 Baseline Biospecimen Collection Setting', 
                                   row.names=FALSE,align=c("l","c","c","c"), booktabs = TRUE) %>%  
  add_indent(seq(1, nrow(table1_allsett) - 1)) %>% 
  kable_styling(latex_options = c("scale_down", "hold_position")) %>% 
  footnote(general = "Note: Any collections indicated under 'Home' setting reflect collections in which home mouthwash was the only sample collected.", 
           general_title = "",
         footnote_as_chunk = TRUE, 
         escape = FALSE, 
         threeparttable = TRUE)




## To be used in all Figures as the X-axis Date
coll_sett_all <- coll_sett_all %>%  
  group_by(Connect_ID) %>% 
  mutate(collection.tm =max(as.POSIXct(ymd_hms(d_556788178)),na.rm=TRUE),
         col.Sunday.week = ceiling(as.numeric(difftime(collection.tm,as.Date(veristart.date-days(2)),units="days"))/7),
         col.Sunday.date = veristart.date + days(5) + dweeks(col.Sunday.week-1),
         col.Monday.date = col.Sunday.date-days(6)) %>% 
  ungroup()





## By research location
biospe_R_locations<-coll_sett_all %>% filter(all_settings=="Research") 

biospe_R_locations$biocol.appoint[biospe_R_locations$biocol.appoint=="Baseline Collection"]="Number of Research Collections"

#table1_1_locations <-  biospe_R_locations %>% filter(biocol.appoint=="Number of Research Collections")
#table1_1_locations <- table1_1_locations %>%  distinct(Connect_ID, .keep_all = TRUE) #testing this out

col_num <- table(biospe_R_locations$Site_location, biospe_R_locations$biocol.appoint)

col_num_1.1 <- as.data.frame(col_num)
col_num_1.1 <- col_num_1.1[, c(1,3)]
colnames(col_num_1.1) <- c("Collection Location", "N")
rownames(col_num_1.1) <- col_num_1.1$`Collection Location`


col_num_1.1 <- col_num_1.1 %>%
  mutate(Site_Group = case_when(
    `Collection Location` %in% c("UC-DCAM", "Ingalls Harvey", "River East", "South Loop", "UCM Pop-Up", "Orland Park", "Missing UC location") ~ "University of Chicago Medicine",
    `Collection Location` %in% c("HP Research Clinic",  "HP Park Nicollet", "Missing HP location") ~ "HealthPartners",
    `Collection Location` %in% c("Lake Hallie", "Marshfield", "MF Pop-Up", "Minocqua", "Weston", "Wisconsin Rapids", "Rice Lake", "Colby Abbotsford", "Merrill",
                                 "Stevens Point", "Neillsville", "Missing MF location") ~ "Marshfield Clinic Health System",
    `Collection Location` %in% c("Sioux Falls Imagenetics", "Fargo South University","Edith Sanford Breast Center (coded as Sanford Center)", 
                                  "Edith Sanford Breast Center","Fargo Amber Valley","Missing SF location") ~ "Sanford Health",
    `Collection Location` %in% c("HFH K-13 Research Clinic", "HFH Livonia Research Clinic", "HFH Cancer Pavilion Research Clinic", "HFH Pop-Up", "HFH Detroit Northwest","In-home Collection", "Missing HFH location") ~ "Henry Ford Health",
    `Collection Location` %in% c("BCC- HWC","FW All Saints","BCC- Plano","BCC- Worth St","BCC- Irving","Irving","NTX Biorepository","BCC- Fort Worth", "Missing BSWH location") ~ "Baylor Scott and White",
    TRUE ~ "Other"
  ))

#col_num_1.1$`Number of Research Collections` <- paste(col_num_1.1$`Number of Research Collections`, )

col_num_1.1$`N` <- as.numeric(col_num_1.1$`N`)
col_num_1.1 <- col_num_1.1 %>%
  filter(!is.na(`N`))


total_collections <- col_num_1.1 %>%
  group_by(Site_Group) %>%
  summarize(Total_Collections = sum(`N`, na.rm = TRUE))


col_num_1.1 <- col_num_1.1 %>%
  left_join(total_collections, by = "Site_Group")


col_num_1.1 <- col_num_1.1 %>%
  mutate(Percentage = round((`N` / Total_Collections * 100), digits=1))


total_rows <- col_num_1.1 %>%
  group_by(Site_Group) %>%
  summarize(`Collection Location` = "Total",
            `N` = sum(`N`),
            Percentage = 100) %>%
  ungroup()

col_num_1.1 <- bind_rows(col_num_1.1, total_rows)

col_num_1.1$`Total Research Collections` <- paste0(col_num_1.1$`N`, " (", col_num_1.1$Percentage,"%)")
col_num_1.1 <- col_num_1.1[, c(1,3,6)]

col_num_1.1 <- col_num_1.1 %>%
  mutate(`Collection Location` = paste0("\u00A0\u00A0\u00A0", `Collection Location`))


col_num_1.1_gt <- col_num_1.1 %>%
  
  gt::gt(groupname_col = "Site_Group") 





col_num_1.1_gt <- col_num_1.1_gt %>%  
  summary_rows(
  groups = TRUE,
  columns = vars("Total Research Collections"),
  fns = (Sum = ~sum(.))
  ) %>% 
 tab_header("Table 1.3: Baseline Research Biospecimen Collections by Collection Location") %>% 
  tab_options(table.font.size = px(8))








##By clinical location
  #Seoarate so I can use this df in the SF clinical table
table1_clin <-coll_sett_all %>% filter(all_settings=="Clinical") 

table1_2_locs<- table1_clin %>% filter(Site!="Kaiser Permanente Georgia"& Site!= "Kaiser Permanente Northwest"  & 
                                   Site!="Kaiser Permanente Colorado" & Site!="Kaiser Permanente Hawaii" & Site!= "Sanford Health") 


table1_2_locs$biocol.appoint[table1_2_locs$biocol.appoint=="Baseline Collection"]="Number of Clinical Collections"

table1_2_locations <-  table1_2_locs %>% filter(biocol.appoint=="Number of Clinical Collections")
#table1_2__locations <- table1_2_locations %>%  distinct(Connect_ID, .keep_all = TRUE) #testing this out


col_num <- table(table1_2_locations$Clin_Site_location, table1_2_locations$biocol.appoint)


col_num_1.2 <- as.data.frame(col_num)
col_num_1.2 <- col_num_1.2[, c(1,3)]
colnames(col_num_1.2) <- c("Collection Location", "N")
rownames(col_num_1.2) <- col_num_1.2$`Collection Location`


col_num_1.2 <- col_num_1.2 %>%
  mutate(Site_Group = case_when(
    `Collection Location` %in% c("Macomb", "West Bloomfield", "Wyandotte","Fairlane (Dearborn)", "Plymouth", "Royal Oak", "Troy", "K1 HFH Main","Sterling Heights","Columbus", 
                                 "Livonia","Taylor", "Ford Road", "NCO","Brownstown", "E Jefferson Pathology","Missing HFH location") ~ "Henry Ford Health", 
    `Collection Location` %in% c("Elk River", "Chanhassen", "Park Nicollet Minneapolis Clinic", "Brooklyn Center", "Clinic Stillwater", "New Richmond Clinic", "Missing HP location") ~ "HealthPartners", #"NSC", 
    `Collection Location` %in% c("South Loop","Orland Park","Kenwood","River East","Dearborn Station", "Ingalls", "DCAM (Hyde Park)", 
                                 "Crown Point", "Missing UC location") ~ "University of Chicago Medicine",
    TRUE ~ "Other"
  ))




col_num_1.2$`N` <- as.numeric(col_num_1.2$`N`)
col_num_1.2 <- col_num_1.2 %>%
  filter(!is.na(`N`))


total_collections <- col_num_1.2 %>%
  group_by(Site_Group) %>%
  summarize(Total_Collections = sum(`N`, na.rm = TRUE))


col_num_1.2 <- col_num_1.2 %>%
  left_join(total_collections, by = "Site_Group")


col_num_1.2 <- col_num_1.2 %>%
  mutate(Percentage = round((`N` / Total_Collections * 100), digits=1))




total_rows <- col_num_1.2 %>%
  group_by(Site_Group) %>%
  summarize(`Collection Location` = "Total",
            `N` = sum(`N`),
            Percentage = 100) %>%
  ungroup()

col_num_1.2 <- bind_rows(col_num_1.2, total_rows)

col_num_1.2$`Total Clinical Collections` <- paste0(col_num_1.2$`N`, " (", col_num_1.2$Percentage,"%)")
col_num_1.2 <- col_num_1.2[, c(1,3,6)]

col_num_1.2 <- col_num_1.2 %>%
  mutate(`Collection Location` = paste0("\u00A0\u00A0\u00A0", `Collection Location`))



col_num_1.2_gt <- col_num_1.2 %>%
  
  gt::gt(groupname_col = "Site_Group") 



col_num_1.2_gt <- col_num_1.2_gt %>%  summary_rows(
  groups = TRUE,
  columns = vars("Total Clinical Collections"),
  fns = (Sum = ~sum(.)),
) %>% tab_header("Table 1.4: Baseline Clinical Biospecimen Collections by Clinic Location") 
  





# ## don't think this needed??
# table2 <- table1 %>% filter(biocol.appoint=='Baseline Collection') %>%
#   mutate(BioFin_BaseBloodCol_v1r0 = factor(BioFin_BaseBloodCol_v1r0, levels=c("Any blood collected","No blood collected"))) 



table1.5 <- create_tbl_cross(coll_sett_all, 'Site', "BioFin_BaseBloodCol_v1r0", "row", 'Site', " ")


biospe.bld <- knitr::kable(table1.5, 
                           col.names=c("Site", "Any Blood Collected","No Blood Collected", "Total Collections"),
                           caption='Table 1.7: Baseline Blood Collection Status Among Biospecimen Collections',
                           row.names=FALSE,align=c("l","c","c","c"), 
                           booktabs = TRUE)  %>% 
  add_indent(seq(1,  10)) %>%  
  kable_styling(latex_options = "scale_down") #"HOLD_position"



```

```{r Collections_by_Demographic, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

BLCol_by_Sex_df <- create_tbl_cross2(table1, "sex", "biocol.appoint", "row", "Sex", "Baseline Biospecimen Collection Status", "Total Verified Participants")

BLCol_by_Sex <- knitr::kable(BLCol_by_Sex_df, 
             caption='Table 1.14 Baseline Biospecimen Collection Status by Sex \n Among Verified Participants',
             row.names=FALSE, align=c("l","c","c","c","c","c"), booktabs = TRUE) %>%
    kable_styling(latex_options = "scale_down") %>%  
    add_indent(seq(1, nrow(BLCol_by_Sex_df) - 1)) %>%  landscape() %>% 
  footnote(general="Note: Sex defined as the de-identified sex data reported by sites at time of invitation.",
           general_title = "")





BLCol_by_Age_df <- create_tbl_cross2(table1, "age", "biocol.appoint", "row", "Age", "Baseline Biospecimen Collection Status", "Total Verified Participants")

BLCol_by_Age <- knitr::kable(BLCol_by_Age_df, 
             caption="Table 1.15. Baseline Biospecimen Collection Status by Age \n Among Verified Participants",
             row.names=FALSE, align=c("l","c","c","c","c","c"), booktabs = TRUE) %>%
    kable_styling(latex_options = "scale_down") %>%  
    add_indent(seq(1, nrow(BLCol_by_Age_df) - 1)) %>%  landscape() %>% 
  footnote(general="Note: Age defined as the de-identified age data reported by sites at time of invitation, not current age at the time of specimen collection.",
           general_title = "")





BLCol_by_Race_df <- create_tbl_cross2(table1, "race", "biocol.appoint", "row", "Race", "Baseline Biospecimen Collection Status", "Total Verified Participants")

BLCol_by_Race <- knitr::kable(BLCol_by_Race_df, 
             caption="Table 1.16. Baseline Biospecimen Collection Status by Race \n Among Verified Participants",
             row.names=FALSE, align=c("l","c","c","c","c","c"), booktabs = TRUE) %>%
    kable_styling(latex_options = "scale_down") %>%  
    add_indent(seq(1, nrow(BLCol_by_Race_df) - 1)) %>%  landscape() %>%
    footnote(general = "Note: Race defined as the de-identified race data reported by sites at time of invitation.",
             general_title = "")


```




```{r Sanford_Table_1.4, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

#SF_clin <- table1_clin %>% filter(Site=="Sanford Health")
#biospe1_5 <- no_dups %>% select( Connect_ID,d_556788178)

#table1_4_locations <- left_join(SF_clin, biospe1_5, by = "Connect_ID")
table1_4_locations <- table1_clin %>% filter(Site=="Sanford Health")
table1_4_locations$biocol.appoint[table1_4_locations$biocol.appoint == "Baseline Collection"] <- "Number of Clinical Collections"



# Updated function to add both Site_location and Region columns
add_Site_location <- function(table1_4_locations, csv_file_path) {
  site_data <- read_csv(csv_file_path)
  
  if (!("ID" %in% colnames(site_data)) | !("Site_location" %in% colnames(site_data)) | !("Region" %in% colnames(site_data))) {
    stop("The CSV file must contain 'ID', 'Site_location', and 'Region' columns.")
  }
  
  case_when_string_location <- ""
  case_when_string_region <- ""
  
  for (i in 1:nrow(site_data)) {
    id <- site_data[i, "ID"]
    location <- site_data[i, "Site_location"]
    region <- site_data[i, "Region"]
    
    case_when_string_location <- paste0(
      case_when_string_location,
      "d_173836415_d_266600170_d_185243482 == ", id, " | d_173836415_d_266600170_d_452847912 == ", id, " ~ \"", location, "\",\n"
    )
    

    case_when_string_region <- paste0(
      case_when_string_region,
      "d_173836415_d_266600170_d_185243482 == ", id, " | d_173836415_d_266600170_d_452847912 == ", id, " ~ \"", region, "\",\n"
    )
  }
  
  case_when_string_location <- substr(case_when_string_location, 1, nchar(case_when_string_location) - 2)
  case_when_string_region <- substr(case_when_string_region, 1, nchar(case_when_string_region) - 2)
  
  table1_4_locations <- table1_4_locations %>%
    mutate(
      Site_location = eval(parse(text = paste0("case_when(\n", case_when_string_location, "\n)"))),
      Region = eval(parse(text = paste0("case_when(\n", case_when_string_region, "\n)")))
    )
  
  return(table1_4_locations)
}

# Apply the updated function to add Site_location and Region
table1_4_locations <- add_Site_location(table1_4_locations, "Sanford_Clincal_Locations.csv") 


## Some locations have two IDs from EPIC, need to be combined for tables
table1_4_locations$Site_location[table1_4_locations$Site_location=="Sioux Falls SD 32nd & Ellis Lab Old" | table1_4_locations$Site_location=="Sioux Falls SD 32nd & Ellis Lab"]="Sioux Falls SD 32nd & Ellis Lab "
table1_4_locations$Site_location[table1_4_locations$Site_location=="Sioux Falls SD 69th & Minnesota Lab A" | table1_4_locations$Site_location=="Sioux Falls SD 69th & Minnesota Lab B"]="Sioux Falls SD 69th & Minnesota Lab"
table1_4_locations$Site_location[table1_4_locations$Site_location=="Sioux Falls SD 69th & Louise Lab A" | table1_4_locations$Site_location=="Sioux Falls SD 69th & Louise Lab B"]="Sioux Falls SD 69th & Louise Lab"



##Handle those with missing location IDs
table1_4_locations$Site_location[is.na(table1_4_locations$d_173836415_d_266600170_d_185243482) & is.na(table1_4_locations$d_173836415_d_266600170_d_452847912)]="Missing Both Location IDs"

table1_4_locations$Site_location[is.na(table1_4_locations$Site_location) & 
                                   !(is.na(table1_4_locations$d_173836415_d_266600170_d_185243482) & is.na(table1_4_locations$d_173836415_d_266600170_d_452847912))]="Unidentified SF Location"

table1_4_locations$Region[table1_4_locations$Site_location=="Missing Both Location IDs" | table1_4_locations$Site_location=="Unidentified SF Location"] = "Unknown"



# Aggregate counts by Site_location and Region
count_all <- table1_4_locations %>%
  count(Region, Site_location) %>%
  mutate(Count_Total = n) %>%
  select(-n)

total_all <- sum(count_all$Count_Total)
count_all <- count_all %>%
  mutate(Percent_Total = paste0(round((Count_Total / total_all) * 100, 1), "%"))

# Define the filtered data frames for 7-day and 30-day counts
table1_4_locations_7days <- table1_4_locations %>% filter(d_556788178 >= currentDate - 7)
table1_4_locations_30days <- table1_4_locations %>% filter(d_556788178 >= currentDate - 30)

# Now, you can proceed with your counting and mutating operations
count_all <- table1_4_locations %>%
  count(Region, Site_location) %>%
  mutate(Count_Total = n) %>%
  select(-n)

total_all <- sum(count_all$Count_Total)
count_all <- count_all %>%
  mutate(Percent_Total = paste0(round((Count_Total / total_all) * 100, 1), "%"))



# #Handle those with missing location IDs
# count_all$Site_location[is.na(count_all$Site_location)]="Missing Both Location IDs"
# count_all$Region[is.na(count_all$Region)] = "Unknown"
# #table1_4_locations$Region <- factor(levels=c("Bemidji", "Bismarck", "Fargo", "Sioux Falls", "Unknown"))



# Similarly for 7-day and 30-day counts
count_7days <- table1_4_locations_7days %>%
  count(Region, Site_location) %>%
  mutate(Count_7days = n) %>%
  select(-n)

total_7days <- sum(count_7days$Count_7days)
count_7days <- count_7days %>%
  mutate(Percent_7days = paste0(round((Count_7days / total_7days) * 100, 1), "%"))

count_30days <- table1_4_locations_30days %>%
  count(Region, Site_location) %>%
  mutate(Count_30days = n) %>%
  select(-n)

total_30days <- sum(count_30days$Count_30days)
count_30days <- count_30days %>%
  mutate(Percent_30days = paste0(round((Count_30days / total_30days) * 100, 1), "%"))

# Combine counts into the final table
final_col_num_1.5 <- full_join(count_all, count_7days, by = c("Region", "Site_location")) %>%
  full_join(count_30days, by = c("Region", "Site_location")) %>%
  replace_na(list(Count_Total = 0, Percent_Total = "0%", Count_7days = 0, Percent_7days = "0%", Count_30days = 0, Percent_30days = "0%"))

# Add total row
total_row <- data.frame(
  Region = "Total",
  Site_location = "Total",
  Count_Total = total_all,
  Percent_Total = "100%",
  Count_7days = total_7days,
  Percent_7days = "100%",
  Count_30days = total_30days,
  Percent_30days = "100%"
)

final_col_num_1.5 <- bind_rows(final_col_num_1.5, total_row)

# Add a helper column for sorting counts by region descending
final_col_num_1.5 <- final_col_num_1.5 %>%
  mutate(is_total = if_else(Region == "Total" & Site_location == "Total", 1, 0)) %>%
  arrange(is_total, Region, desc(Count_30days)) %>%
  select(-is_total)  # Remove the helper column

final_col_num_1.5$'In the Past 7 Days' <- paste0(final_col_num_1.5$Count_7days, " (", final_col_num_1.5$Percent_7days, ")")
final_col_num_1.5$'In the Past 30 Days' <- paste0(final_col_num_1.5$Count_30days, " (", final_col_num_1.5$Percent_30days, ")")
final_col_num_1.5$'Collection Location' <- final_col_num_1.5$Site_location


SF_collections <- final_col_num_1.5 %>% filter(Count_7days>0 | Count_30days>0)


# Keep the Region column initially for arranging and grouping
SF_collections <- SF_collections[, c("Region", "Collection Location", "In the Past 7 Days", "In the Past 30 Days")]
SF_collections$Region <- factor(SF_collections$Region, levels=c("Bemidji","Bismarck","Fargo","Sioux Falls", "Unknown", "Total"))


SF_collections_tbl <- SF_collections %>%

  select(-Region) %>%  # Remove Region just before rendering
  kbl(caption = "Table 1.5: Baseline Clinical Biospecimen Collections in the Past 30 Days at Sanford Health by Clinic Location",
      booktabs = TRUE) %>%
  kable_styling(latex_options = "scale_down", full_width = FALSE, font_size = 6) %>%
  row_spec(0, bold = TRUE) %>%
  pack_rows(index = table(SF_collections$Region))  # Group by Region



```


```{r SF1.5, echo=FALSE, eval=TRUE,echo=FALSE,warning=FALSE,include=FALSE,results='hold'}

top10 <- count_all %>%
  group_by(Region) %>%
  top_n(10, Count_Total) %>%                 
  arrange(Region, desc(Count_Total))  %>%     
  ungroup() 


colnames(top10) <- c("Region", "Collection Location", "Top Collection Counts", "Total Percentage")

SF_top10_collections <- top10 %>%
  select(-Region) %>%  
   kbl(caption = "Table 1.6 Top Baseline Clinical Collection Locations at Sanford Health by Region",
       booktabs = TRUE) %>%
  kable_styling(latex_options = "scale_down", full_width = FALSE) %>%
  row_spec(0, bold = TRUE) %>%
  pack_rows(index = table(top10$Region))  # Group by Region for display


colnames(top10) <- c("Region", "Collection Location", "Top Collection Counts", "Total Percentage")

## Used in footnote
SF_footnote <- count_all %>%  group_by(Region) %>%  tally(Count_Total) 

Bi_count <- SF_footnote$n[SF_footnote$Region=="Bismarck"]
F_count <- SF_footnote$n[SF_footnote$Region=="Fargo"]
S_count <- SF_footnote$n[SF_footnote$Region=="Sioux Falls"]
Be_count <- SF_footnote$n[SF_footnote$Region=="Bemidji"]
UK_count <- SF_footnote$n[SF_footnote$Region=="Unknown"]

footnote_text <- paste0("This table reflects Clinical Collections at the top collection locations in each region. ",
                        "The total number of Clinical Collections in each region are as follows: Bemidji: ", Be_count,
                        "; Bismarck: ", Bi_count, "; Fargo: ", F_count, "; Sioux Falls: ", S_count, "; Missing Location IDs: ", UK_count, ".")




```


```{r BL_Collection_Settings_Alt, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

# Derived collection settings are somehow blank in some cases, have to fill in with overall collection setting
setting_ctabs <- coll_sett_all %>%  
  mutate(#settings = case_when(d_650516960=="664882224" ~ "Clinical",
                              #d_650516960=="534621077" ~ "Research",
                              #d_650516960=="103209024" ~ "Home"),
         settings = factor(all_settings, levels=c("Clinical", "Research", "Home")),
         BL_BioSpm_BloodSetting_v1r0 = coalesce(BL_BioSpm_BloodSetting_v1r0, settings),
         BL_BioSpm_UrineSetting_v1r0 = coalesce(BL_BioSpm_UrineSetting_v1r0, settings),
         BL_BioSpm_MWSetting_v1r0 = coalesce(BL_BioSpm_MWSetting_v1r0, settings))


all_blood_settings <- as.data.frame(table(setting_ctabs$BL_BioSpm_BloodSetting_v1r0[setting_ctabs$d_878865966 == 353358909], exclude = NULL))
allurine_settings <- as.data.frame(table(setting_ctabs$BL_BioSpm_UrineSetting_v1r0[setting_ctabs$d_167958071 == 353358909], exclude = NULL))
all_mw_settings <- as.data.frame(table(setting_ctabs$BL_BioSpm_MWSetting_v1r0[setting_ctabs$d_684635302 == 353358909], exclude = NULL))

distrb_allsetts <- cbind(all_blood_settings, allurine_settings, all_mw_settings)

#Remove duplicate columns
distrb_allsetts <- distrb_allsetts[, c(1,2,4,6)]
colnames(distrb_allsetts) <- c("Collection Setting", "Any Blood Collected", "Urine Collected", "Mouthwash Collected")


distrb_allsetts_with_totals <- distrb_allsetts %>%  add_totals_and_percentages(total_position = c("row"), percentage_type = "col")


```


```{r Coll_Sett_Hyrbids, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

##need to check this. Wasn't merged correctly in the merge conlflict on Github
set_by_site <- coll_sett_all %>%  filter(Site=="Henry Ford Health" | Site=="HealthPartners" | Site=="Sanford Health" | Site=="University of Chicago Medicine")

sites <- unique(set_by_site$Site)
site_results <- list()

for (site in sites) {
  site_data <- filter(set_by_site, Site == site)
  
  # Derived collection settings are somehow blank in some cases, have to fill in with overall collection setting
setting_ctabs_Site <- site_data %>%  
  mutate(settings = case_when(d_650516960=="534621077" ~ "Research",
                              d_650516960=="664882224" ~ "Clinical",
                              d_650516960=="103209024" ~ "Home"),
         settings = factor(settings, levels=c("Clinical", "Research", "Home")),
         BL_BioSpm_BloodSetting_v1r0 = coalesce(BL_BioSpm_BloodSetting_v1r0, settings),
         BL_BioSpm_UrineSetting_v1r0 = coalesce(BL_BioSpm_UrineSetting_v1r0, settings),
         BL_BioSpm_MWSetting_v1r0 = coalesce(BL_BioSpm_MWSetting_v1r0, settings))


all_blood_settings_Site <- as.data.frame(table(setting_ctabs_Site$BL_BioSpm_BloodSetting_v1r0[setting_ctabs_Site$d_878865966 == 353358909], exclude = NULL))
allurine_settings_Site <- as.data.frame(table(setting_ctabs_Site$BL_BioSpm_UrineSetting_v1r0[setting_ctabs_Site$d_167958071 == 353358909], exclude = NULL))
all_mw_settings_Site <- as.data.frame(table(setting_ctabs_Site$BL_BioSpm_MWSetting_v1r0[setting_ctabs_Site$d_684635302 == 353358909], exclude = NULL))

distrb_allsetts_Site <- cbind(all_blood_settings_Site, allurine_settings_Site, all_mw_settings_Site)

#Remove duplicate columns
distrb_allsetts_Site <- distrb_allsetts_Site[, c(1,2,4,6)]
colnames(distrb_allsetts_Site) <- c("Collection Setting", "Any Blood Collected", "Urine Collected", "Mouthwash Collected")


distrb_allsetts_Site_with_totals <- distrb_allsetts_Site %>% 
  add_totals_and_percentages(total_position = c("row"), percentage_type = "col")

  
  # Store the result for the current site
  site_results[[site]] <- distrb_allsetts_Site_with_totals
}


```



```{r RemovedTable6, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

#But this is now used for the deviations

levels(recrver1$BioFin_BaseBloodCol_v1r0)

biocol <- recrver1   %>%  group_by(BioFin_BaseBloodCol_v1r0,BioFin_BaseUrineCol_v1r0,BioFin_BaseMWCol_v1r0) %>% dplyr::tally()   #%>% filter(d_410912345==353358909)

biocol$BioFin_BaseBloodCol_v1r0= ifelse(biocol$BioFin_BaseBloodCol_v1r0=="Any blood collected", "Yes", "No")
biocol$BioFin_BaseUrineCol_v1r0= ifelse(biocol$BioFin_BaseUrineCol_v1r0=="Any urine collected", "Yes", "No")
biocol$BioFin_BaseMWCol_v1r0= ifelse(biocol$BioFin_BaseMWCol_v1r0=="Any mouthwash collected", "Yes", "No")

total <- nrow(recrver1)
biocol$pct <- round(100*biocol$n/nrow(recrver1),digits=1)


db <- dim(biocol)[[1]]

func <- function(z) {ifelse(is.numeric(z), round(sum(z), digits=0),'')}
sumrow <- as.data.frame(lapply(biocol, func))

biocol[,5]
biocol[(db+1),] <- sumrow
biocol[(db+1),1] <- "Total"
biocol[(db+1),2] <- "-"
biocol[(db+1),3] <- "-"

colnames(biocol) <- c("Any Blood Collected","Urine Collected","Mouthwash Collected","Number","Percent")

###Table 6. by site
biocol.site <- list()
recrver1$Site <- droplevels(recrver1$Site)
for(site in unique(recrver1$Site)){
  
  site.sub <- recrver1 %>% filter(Site==site) %>% 
    group_by(BioFin_BaseBloodCol_v1r0,BioFin_BaseUrineCol_v1r0,BioFin_BaseMWCol_v1r0) %>% dplyr::tally() 
  
  site.sub$BioFin_BaseBloodCol_v1r0= ifelse(site.sub$BioFin_BaseBloodCol_v1r0=="Any blood collected", "Yes", "No")
  site.sub$BioFin_BaseUrineCol_v1r0= ifelse(site.sub$BioFin_BaseUrineCol_v1r0=="Any urine collected", "Yes", "No")
  site.sub$BioFin_BaseMWCol_v1r0= ifelse(site.sub$BioFin_BaseMWCol_v1r0=="Any mouthwash collected", "Yes", "No")
  
  total <- as.numeric(nrow(recrver1[which(recrver1$Site==site),]))
  site.sub$pct <- round(100*site.sub$n/total,digits=1)
  
  ds <- dim(site.sub)[[1]]
  func <- function(z) {ifelse(is.numeric(z), round(sum(z), digits=0),'')}
  sumrow <- as.data.frame(lapply(site.sub, func))
  
  site.sub[(ds+1),] <- sumrow
  site.sub[(ds+1),1] <- "Total"
  site.sub[(ds+1),2] <- "-"
  site.sub[(ds+1),3] <- "-"
  
  
  biocol.site[[site]] <- site.sub
  
}
```



```{r Table5a5b, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

table4_redone__R <- coll_sett_all %>%  filter(all_settings=="Research") %>% 
  mutate('Specimens Collected'= case_when((BioFin_BaseBloodCol_v1r0=="Any blood collected" & BioFin_BaseUrineCol_v1r0=="Any urine collected" & BioFin_BaseMWCol_v1r0=="Any mouthwash collected") ~ 'Blood, Urine, Mouthwash (All)',
                                          (BioFin_BaseBloodCol_v1r0=="Any blood collected" & BioFin_BaseUrineCol_v1r0=="Any urine collected" & BioFin_BaseMWCol_v1r0!="Any mouthwash collected") ~ 'Blood & Urine Only',
                                          (BioFin_BaseBloodCol_v1r0=="Any blood collected" & BioFin_BaseUrineCol_v1r0!="Any urine collected" & BioFin_BaseMWCol_v1r0=="Any mouthwash collected") ~ 'Blood & Mouthwash Only',
                                          (BioFin_BaseBloodCol_v1r0!="Any blood collected" & BioFin_BaseUrineCol_v1r0=="Any urine collected" & BioFin_BaseMWCol_v1r0=="Any mouthwash collected") ~ 'Urine & Mouthwash Only',
                                          (BioFin_BaseBloodCol_v1r0=="Any blood collected" & BioFin_BaseUrineCol_v1r0!="Any urine collected" & BioFin_BaseMWCol_v1r0!="Any mouthwash collected") ~ 'Blood Only',
                                          (BioFin_BaseBloodCol_v1r0!="Any blood collected" & BioFin_BaseUrineCol_v1r0=="Any urine collected" & BioFin_BaseMWCol_v1r0!="Any mouthwash collected") ~ 'Urine Only',
                                          (BioFin_BaseBloodCol_v1r0!="Any blood collected" & BioFin_BaseUrineCol_v1r0!="Any urine collected" & BioFin_BaseMWCol_v1r0=="Any mouthwash collected") ~ 'Mouthwash Only',
                                          (BioFin_BaseBloodCol_v1r0!="Any blood collected" & BioFin_BaseUrineCol_v1r0!="Any urine collected" & BioFin_BaseMWCol_v1r0!="Any mouthwash collected") ~ 'No Specimens Collected'))

table4_redone__R$'Specimens Collected' <- factor(table4_redone__R$'Specimens Collected',levels=c('Blood, Urine, Mouthwash (All)', 'Blood & Urine Only','Blood & Mouthwash Only','Urine & Mouthwash Only','Blood Only','Urine Only','Mouthwash Only','No Specimens Collected'))


table4_redone__R$Site <- droplevels(table4_redone__R$Site)
table4_redone__R$'Specimens Collected' <- droplevels(table4_redone__R$'Specimens Collected')


spec_by_site_R <- create_tbl_cross(table4_redone__R, 'Specimens Collected', "Site", "column", " ", " ")
colnames(spec_by_site_R)[ncol(spec_by_site_R)] <- "Total Research Collections"







table4_redone__C <- coll_sett_all %>%  filter(all_settings=="Clinical") %>% 
  mutate('Specimens Collected'= case_when((BioFin_BaseBloodCol_v1r0=="Any blood collected" & BioFin_BaseUrineCol_v1r0=="Any urine collected") ~ 'Blood & Urine (All)',
                                          (BioFin_BaseBloodCol_v1r0=="Any blood collected" & BioFin_BaseUrineCol_v1r0!="Any urine collected") ~ 'Blood Only',
                                          (BioFin_BaseBloodCol_v1r0!="Any blood collected" & BioFin_BaseUrineCol_v1r0=="Any urine collected") ~ 'Urine Only',
                                          (BioFin_BaseBloodCol_v1r0!="Any blood collected" & BioFin_BaseUrineCol_v1r0!="Any urine collected") ~ 'No Specimens Collected'))
                                          #TRUE ~ "Unknown")) %>%  filter('Specimens Collected' != "Unknown")
table4_redone__C$`Specimens Collected` <- factor(table4_redone__C$`Specimens Collected`, levels = c('Blood & Urine (All)', 'Blood Only', 'Urine Only', 'No Specimens Collected'))



table4_redone__C$Site <- droplevels(table4_redone__C$Site)
table4_redone__C$'Specimens Collected' <- droplevels(table4_redone__C$'Specimens Collected')


spec_by_site_C <- create_tbl_cross(table4_redone__C, 'Specimens Collected', "Site", "column", " ", " ")
colnames(spec_by_site_C)[ncol(spec_by_site_C)] <- "Total Clinical Collections"

```







```{r Table6, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

coll_sett_all<- coll_sett_all%>% arrange(Site)

tubes <- unique(y[grepl(" Tube ",y$`Secondary.Source`),c("conceptId.1","Secondary.Source")])
tubes[grepl("00", tubes$`Variable Name`),]


bld.ls <- c("d_299553921","d_703954371","d_454453939","d_838567176","d_652357376","d_376960806","d_232343615","d_589588440","d_677469051", "d_683613884","d_958646668", "d_505347689") #STRECK added 

tubeid <- grep("d_825582494", names(coll_sett_all), value=TRUE) #tube ID
deviation <- grep("d_678857215",names(coll_sett_all),value=TRUE) 
colid <- grep("d_593843561", names(coll_sett_all), value=TRUE) #collected yes/no
discard <- grep("d_762124027",names(coll_sett_all),value=TRUE) #discard yes/no
biodiscard <- coll_sett_all[,(which(names(coll_sett_all) %in% discard))]

coll_sett_all$blddev <-0 #blood deviations
coll_sett_all$bldcol <- 0 #blood collections
coll_sett_all$blddid <- 0 #discarded
for(i in 1:length(bld.ls)){
  
  bldcol <- ifelse(coll_sett_all[,paste(bld.ls[i],"d_593843561",sep="_")] == 104430631 | is.na(coll_sett_all[,paste(bld.ls[i],"d_593843561",sep="_")]),0,1)  ##for tube collected
  
  blddev <- ifelse(coll_sett_all[,paste(bld.ls[i],"d_678857215",sep="_")]==104430631 | is.na(coll_sett_all[,paste(bld.ls[i],"d_678857215",sep="_")]),0,1) #for tube deviations yes/no
  
  blddid <- ifelse(coll_sett_all[,paste(bld.ls[i],"d_762124027",sep="_")]==104430631 | is.na(coll_sett_all[,paste(bld.ls[i],"d_762124027",sep="_")]),0,1)
  
  coll_sett_all$blddev <- coll_sett_all$blddev+blddev
  coll_sett_all$bldcol <- bldcol + coll_sett_all$bldcol ###to check collection
  coll_sett_all$blddid <- coll_sett_all$blddid+blddid  
  
}

table(coll_sett_all$d_650516960,coll_sett_all$bldcol)
coll_sett_all<- coll_sett_all%>% mutate(bloodcomplete = ifelse((d_650516960==534621077 & bldcol == 5) | (d_650516960==664882224 & bldcol == 11), "Blood.Completion" ,#blood collection completion
                                                   ifelse( (d_650516960==534621077 & (bldcol<5 & bldcol>0)) | (d_650516960==664882224 & (bldcol <  11 & bldcol > 0)),"Blood.Incompleted","NoBlood")),
                            Urine_col = ifelse(d_973670172_d_593843561==353358909, 1, ifelse(d_973670172_d_593843561==104430631,0,0)),
                            MW_col = ifelse(d_143615646_d_593843561==353358909,1,ifelse(d_143615646_d_593843561==104430631,0,0)),
                            biocol_Setting = case_when(d_650516960==534621077  ~"Research",
                                                       d_650516960==664882224 ~ "Clinical",
                                                       d_650516960 ==103209024 ~ "Home")) 
coll_sett_all$Biospe_col <- coll_sett_all$bldcol + coll_sett_all$Urine_col + coll_sett_all$MW_col    
coll_sett_all$BaseBLDCol <-ifelse(coll_sett_all$bldcol>0,1,ifelse(is.na(coll_sett_all$bldcol),NA,0)) #blood collection Yes/No
coll_sett_all[duplicated(coll_sett_all$Connect_ID),]$Connect_ID







### Table 5
tube_col <- coll_sett_all %>% group_by(as.character(Connect_ID),Site,all_settings) %>% 
  filter(d_410912345== 353358909) %>% #testing
  dplyr::summarise(bldcol_max = max(bldcol),
                   Urine_col_max= max(Urine_col),
                   MW_col_max=max(MW_col),
                   d_973670172_d_593843561_max=max(d_973670172_d_593843561),
                   d_143615646_d_593843561_max = max(d_143615646_d_593843561),
                   d_410912345_max=max(d_410912345),
                   collection.tm =max(as.POSIXct(ymd_hms(d_556788178))),
                   schedulecol.tm =min(as.POSIXct(ymd_hms(d_678166505))))



#table(tube_col$d_650516960)

tube_col$Connect_ID <- as.numeric(tube_col$`as.character(Connect_ID)`)
tube_research <- tube_col %>% filter(all_settings=="Research") %>%
  mutate(bld.complt = ifelse(ifelse(collection.tm < as.Date("2024-03-01") | Site=="HealthPartners", bldcol_max==5, bldcol_max==4),"BloodCompletion",ifelse(bldcol_max==0, "NoBlood","BloodIncomplet")))
#Up until 3/1/24 all sits required 5. Up until 3/31/2025 HP required 5. Then up until 3/31/2025 all sites required 4. Starting 3/31/25 HP requires 4 and all other sites require 3. (Heparin tube dropped)
  # mutate(bld.complt = ifelse(ifelse(collection.tm < as.Date("2024-03-01") | Site=="HealthPartners", bldcol_max==5,
  #                                   ifelse(collection.tm < as.Date("2025-03-31") | Site=="HealthPartners", bldcol_max==4,
  #                                          bldcol_max==3)),"BloodCompletion",ifelse(bldcol_max==0, "NoBlood","BloodIncomplet")))

table.bldcol <- ctable(tube_research$Site,tube_research$bld.complt)
bldcol_research <- as.data.frame(cbind(table.bldcol$cross_table,table.bldcol$proportions))
bldcol_research$Site <-trimws(rownames(bldcol_research))


bldcol_research$n_pct_BloodCompletion <- ifelse(!grepl("Total",rownames(bldcol_research)),  paste(format(bldcol_research[,1],big.mark=","),"(", round(100*bldcol_research[,5],1),"%)",sep=" "), format(bldcol_research[,1],big.mark="," ))
bldcol_research$n_pct_BloodInompletion = ifelse(!grepl("Total",rownames(bldcol_research)),  paste(format(bldcol_research[,2],big.mark=","),"(", round(100*bldcol_research[,6],1),"%)",sep=" "), format(bldcol_research[,2],big.mark="," ))
bldcol_research$n_pct_NoBlood = ifelse(!grepl("Total",rownames(bldcol_research)),  paste(format(bldcol_research[,3],big.mark=","),"(", round(100*bldcol_research[,7],1),"%)",sep=" "), format(bldcol_research[,3],big.mark="," ))

bldcol_research1 <- bldcol_research[c(1:6),c(9:12,4)] #c(9:12,4)

```




```{r Table7s, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

#### U-Chicago
tube_col_UC <- coll_sett_all  %>% filter(Site=='University of Chicago Medicine' & all_settings=="Research" & d_410912345== 353358909) %>% 
  group_by(as.character(Connect_ID),Site_location,all_settings) %>% 
  dplyr::summarise(bldcol_max = max(bldcol,na.rm=TRUE),
                   Urine_col_max= max(Urine_col,na.rm=TRUE),
                   MW_col_max=max(MW_col,na.rm=TRUE),
                   d_973670172_d_593843561_max=max(d_973670172_d_593843561,na.rm=TRUE),
                   d_143615646_d_593843561_max = max(d_143615646_d_593843561,na.rm=TRUE),
                   d_410912345_max=max(d_410912345,na.rm=TRUE),
                   collection.tm =max(as.POSIXct(ymd_hms(d_556788178)),na.rm=TRUE),
                   schedulecol.tm =min(as.POSIXct(ymd_hms(d_678166505)),na.rm=TRUE))

tube_col_UC$Connect_ID <- as.numeric(tube_col_UC$`as.character(Connect_ID)`)

tube_research_UC <- tube_col_UC %>% #filter(d_650516960==534621077) %>%
   mutate(bld.complt = ifelse(ifelse(collection.tm < as.Date("2024-03-01"), bldcol_max==5, bldcol_max==4),"BloodCompletion",
                              ifelse(bldcol_max==0, "NoBlood","BloodIncomplet")))
#Before 3/1/2024 UC required 5. Before 3/31/2025 they required 4. As of 3/31/2025 heparin was dropped so they require 3.
  # mutate(bld.complt = ifelse(ifelse(collection.tm < as.Date("2024-03-01"), bldcol_max==5,
  #                                   ifelse(collection.tm < as.Date("2025-03-31"), bldcol_max==4,
  #                                          bldcol_max==3)),"BloodCompletion",ifelse(bldcol_max==0, "NoBlood","BloodIncomplet")))

table.bldcol_UC <- ctable(tube_research_UC$Site_location,tube_research_UC$bld.complt)
bldcol_research_UC <- as.data.frame(cbind(table.bldcol_UC$cross_table,table.bldcol_UC$proportions))
bldcol_research_UC$Site_location <-trimws(rownames(bldcol_research_UC))


bldcol_research_UC$n_pct_BloodCompletion <-  paste(format(bldcol_research_UC[,1],big.mark=","),"(", round(100*bldcol_research_UC[,5],1),"%)",sep=" ") 
bldcol_research_UC$n_pct_BloodInompletion =  paste(format(bldcol_research_UC[,2],big.mark=","),"(", round(100*bldcol_research_UC[,6],1),"%)",sep=" ") 
bldcol_research_UC$n_pct_NoBlood = paste(format(bldcol_research_UC[,3],big.mark=","),"(", round(100*bldcol_research_UC[,7],1),"%)",sep=" ") 

bldcol_research_UC$Total <- paste(bldcol_research_UC$Total, " (100%)")
nrow(bldcol_research_UC)

bldcol_research_UC1 <- bldcol_research_UC[,c(9:12,4)]





### HF Research
tube_col_HF <- coll_sett_all %>% filter(Site=='Henry Ford Health' & all_settings=="Research") %>% 
  group_by(as.character(Connect_ID),Site_location,d_650516960) %>% 
  dplyr::summarise(bldcol_max = max(bldcol,na.rm=TRUE),
                   Urine_col_max= max(Urine_col,na.rm=TRUE),
                   MW_col_max=max(MW_col,na.rm=TRUE),
                   d_973670172_d_593843561_max=max(d_973670172_d_593843561,na.rm=TRUE),
                   d_143615646_d_593843561_max = max(d_143615646_d_593843561,na.rm=TRUE),
                   d_410912345_max=max(d_410912345,na.rm=TRUE),
                   collection.tm =max(as.POSIXct(ymd_hms(d_556788178)),na.rm=TRUE),
                   schedulecol.tm =min(as.POSIXct(ymd_hms(d_678166505)),na.rm=TRUE))
#table(tube_col_HF$d_650516960)

tube_col_HF$Connect_ID <- as.numeric(tube_col_HF$`as.character(Connect_ID)`)

tube_research_HF <- tube_col_HF %>% #filter(d_650516960==534621077) %>%
  mutate(bld.complt = ifelse(ifelse(collection.tm < as.Date("2024-03-01"), bldcol_max==5, bldcol_max==4),"BloodCompletion",ifelse(bldcol_max==0, "NoBlood","BloodIncomplet")))
#Before 3/1/2024 HF required 5. Before 3/31/2025 they required 4. As of 3/31/2025 heparin was dropped so they require 3.
  # mutate(bld.complt = ifelse(ifelse(collection.tm < as.Date("2024-03-01"), bldcol_max==5,
  #                                   ifelse(collection.tm < as.Date("2025-03-31"), bldcol_max==4,
  #                                          bldcol_max==3)),"BloodCompletion",ifelse(bldcol_max==0, "NoBlood","BloodIncomplet")))

table.bldcol_HF <- ctable(tube_research_HF$Site_location,tube_research_HF$bld.complt)
bldcol_research_HF <- as.data.frame(cbind(table.bldcol_HF$cross_table,table.bldcol_HF$proportions))
bldcol_research_HF$Site_location <-trimws(rownames(bldcol_research_HF))


bldcol_research_HF$n_pct_BloodCompletion <- paste(format(bldcol_research_HF[,1],big.mark=","),"(", round(100*bldcol_research_HF[,5],1),"%)",sep=" ")
bldcol_research_HF$n_pct_BloodInompletion = paste(format(bldcol_research_HF[,2],big.mark=","),"(", round(100*bldcol_research_HF[,6],1),"%)",sep=" ")
bldcol_research_HF$n_pct_NoBlood = paste(format(bldcol_research_HF[,3],big.mark=","),"(", round(100*bldcol_research_HF[,7],1),"%)",sep=" ")

bldcol_research_HF$Total <- paste(bldcol_research_HF$Total, " (100%)")
nrow(bldcol_research_HF)

bldcol_research_HF1 <- bldcol_research_HF[,c(9:12,4)]
```


```{r HF_BloodColl, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}


biocounts <- coll_sett_all %>%  select(Connect_ID, bldcol, d_556788178)
HFSITES <- table1_2_locs %>%  filter(Site=="Henry Ford Health") %>% select(Connect_ID, Clin_Site_location)
biospe7 <- left_join(HFSITES, biocounts, by="Connect_ID")

tube_col_HF2 <- biospe7  %>% group_by(Connect_ID,Clin_Site_location) %>%
  dplyr::summarise(bldcol_max = max(bldcol,na.rm=TRUE),
                   collection.tm =max(as.POSIXct(ymd_hms(d_556788178)),na.rm=TRUE))


tube_research_HF2 <- tube_col_HF2 %>% 
  mutate(bld_complt = ifelse(ifelse(collection.tm < as.Date("2024-03-01"), bldcol_max == 5, bldcol_max == 4), "All Blood Collected",
                             ifelse(bldcol_max == 0, "No Blood Collected", "Partial Blood Collected")),
         bld_complt = factor(bld_complt, levels = c("All Blood Collected", "Partial Blood Collected", "No Blood Collected"))) %>%
  select(Clin_Site_location, bld_complt) %>%
  ungroup()  # Explicitly ungroup to avoid the Connect_ID issue



bloodcomp_clinloc <- create_tbl_cross(tube_research_HF2, "Clin_Site_location", "bld_complt", "row", "Clinical Location", " ")
colnames(bloodcomp_clinloc)[ncol(bloodcomp_clinloc)] <- "Total Clinical Collections"

```



```{r Clinical_Tube_Count, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}


tube_clinic <- tube_col %>% filter(all_settings=="Clinical" )%>% mutate(Site=droplevels(Site),
                                                                      bldcol_max=as.factor(bldcol_max)) #& grepl("Kaiser",Site)
tube_clinic$bldcol_tubes <- factor(tube_clinic$bldcol_max,levels=c(0:10))

tube_clinic$Site <-factor(tube_clinic$Site,levels=c("HealthPartners", "Henry Ford Health",
                                                    "Sanford Health", "University of Chicago Medicine","Kaiser Permanente Colorado",
                                                    "Kaiser Permanente Georgia","Kaiser Permanente Hawaii","Kaiser Permanente Northwest"))

tube_completeness_totals <- tube_clinic %>% ungroup()


bloodtubes_bysite <- create_tbl_cross(tube_completeness_totals, "Site", "bldcol_tubes", "row", "Site", " ")
colnames(bloodtubes_bysite)[ncol(bloodtubes_bysite)] <- "Total Clinical Collections"
colnames(bloodtubes_bysite)[1] <- "Site"



```





```{r Data System, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

bldurcl <- coll_sett_all  %>%  filter(all_settings=="Clinical" & (BioFin_BaseBloodCol_v1r0 == "Any blood collected" | BioFin_BaseUrineCol_v1r0 == "Any urine collected")) %>% 
  mutate(Data_System = case_when((d_173836415_d_266600170_d_534041351==353358909 & is.na(d_173836415_d_266600170_d_693370086)) |
                                   (d_173836415_d_266600170_d_210921343==353358909 & is.na(d_173836415_d_266600170_d_786930107))~ "Biospecimen Dashboard Only",
                                 (is.na(d_173836415_d_266600170_d_534041351) & d_173836415_d_266600170_d_693370086==353358909) |
                                   (is.na(d_173836415_d_266600170_d_210921343) & d_173836415_d_266600170_d_786930107==353358909)~ "Site Data Only",
                                 (d_173836415_d_266600170_d_534041351==353358909 & d_173836415_d_266600170_d_693370086==353358909) |
                                   (d_173836415_d_266600170_d_210921343==353358909 & d_173836415_d_266600170_d_786930107==353358909) ~ "Site Data & Biospecimen Dashboard"))

all_data_system_levels <- c("Biospecimen Dashboard Only", "Site Data & Biospecimen Dashboard", "Site Data Only")


blood_system <- bldurcl %>%
  filter(as.character(d_878865966) == "Any blood collected") %>%
  tabyl(Data_System, d_878865966) %>%
  add_totals_and_percentages(total_position = "row", percentage_type = "col")

urine_system <- bldurcl %>%
  filter(as.character(d_167958071) == "Any urine collected") %>%
  mutate(Data_System = factor(Data_System, levels = all_data_system_levels)) %>%
  tabyl(Data_System, d_167958071) %>%
  add_totals_and_percentages(total_position = "both", percentage_type = "row")

# Combine the two tables
system_coll <- cbind(blood_system, urine_system)
system_coll <- system_coll[, c(1, 2, 4)]  # Keep only relevant columns
colnames(system_coll) <- c("Data System", "Blood Collected", "Urine Collected")

# View the result
system_coll


```



```{r Table11, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

#Participants who checked in for a baseline biospecimen visit but did not give any samples
dd[grepl("BioChk",dd$`Variable Name`),]
recr_bio <- base::merge(recrver1,tube_col,by="Connect_ID")
bio_checkin_resh <- recr_bio  %>% filter(!is.na(d_331584571_d_266600170_d_840048338) & all_settings=="Research") %>% select(BiospeCollection ) %>% tbl_summary()
table(bio_checkin_resh$BiospeCollection)

tubes <- unique(y[grepl(" Tube ",y$`Secondary.Source`),c("conceptId.1","Secondary.Source")])
tube.ls <- paste0("d_", trimws(paste(tubes$conceptId.1,collapes="")))

coll_sett_all$tubedev <-0 #biospecimen deviations
coll_sett_all$tubecol <- 0 #tube collections
coll_sett_all$tubedid <- 0 #tube discarded
for(i in 1:length(tube.ls)){
  
  tubecol <- ifelse(coll_sett_all[,paste(tube.ls[i],"d_593843561",sep="_")] == 104430631 | is.na(coll_sett_all[,paste(tube.ls[i],"d_593843561",sep="_")]),0,1)  ##for tube collected
  
  tubedev <- ifelse(coll_sett_all[,paste(tube.ls[i],"d_678857215",sep="_")]==104430631 | is.na(coll_sett_all[,paste(tube.ls[i],"d_678857215",sep="_")]),0,1) #for tube deviations yes/no
  
  tubedid <- ifelse(coll_sett_all[,paste(tube.ls[i],"d_762124027",sep="_")]==104430631 | is.na(coll_sett_all[,paste(tube.ls[i],"d_762124027",sep="_")]),0,1)
  
  coll_sett_all$tubedev <- coll_sett_all$tubedev+tubedev
  coll_sett_all$tubecol <- tubecol + coll_sett_all$tubecol ###to check collection
  coll_sett_all$tubedid <- coll_sett_all$tubedid+tubedid  
}
table(coll_sett_all$tubecol)
table(coll_sett_all$tubedev)

coll_sett_all$tube_nodev <- coll_sett_all$tubecol-coll_sett_all$tubedev
total1 <- sum(coll_sett_all$tubedev) 
total2 <- sum(coll_sett_all$tube_nodev) 
tube_dev <- as.data.frame(aggregate( coll_sett_all$tubedev,                # Specify data column[,c("tubedev","tube_nodev")]
                                     by = list(coll_sett_all$Site),              # Specify group indicator
                                     FUN = sum))
tube_nodev <- as.data.frame(aggregate( coll_sett_all$tube_nodev,                # Specify data column[,c("tubedev","tube_nodev")]
                                       by = list(coll_sett_all$Site),              # Specify group indicator
                                       FUN = sum))

#changed Table17 to Deviation_Freq to match report

Deviation_Freq <- base::merge(tube_dev,tube_nodev,by="row.names")

Deviation_Freq <- Deviation_Freq[,c(2,3,5)]
Deviation_Freq$Total <- Deviation_Freq[,2]+Deviation_Freq[,3]
Deviation_Freq$dev_n_pct <- ifelse(Deviation_Freq[,2] >0, paste0(format(Deviation_Freq[,2],big.mark=",")," (", round(100*Deviation_Freq[,2]/Deviation_Freq$Total, 1)," %)"), "0 (0 %)")
Deviation_Freq$nodev_n_pct <- ifelse(Deviation_Freq[,3] >0, paste0(format(Deviation_Freq[,3],big.mark=",")," (",  round(100*Deviation_Freq[,3]/Deviation_Freq$Total,1), " %)"), "0 (0 %)")

Deviation_Freq[10,c(1:6)] <- c("Total",total1, total2,format(sum(coll_sett_all$tubecol),big.mark=","),
                               paste0(format(total1,big.mark=",")," (", round(100*sum(as.numeric(Deviation_Freq[1:9,2]))/sum(as.numeric(Deviation_Freq$Total), na.rm=T), 1)," %)"),  
                               paste0(format(total2,big.mark=",")," (", round(100*sum(as.numeric(Deviation_Freq[1:9,3]))/sum(as.numeric(Deviation_Freq$Total), na.rm=T),1)," %)"))     
Deviation_Freq <- Deviation_Freq %>% mutate(Site = ifelse(is.na(Group.1.x), "Total",  as.character(Group.1.x))) ###to replace NA in the factor variable

```

```{r Deviations, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}
#Table 14. Number of deviations by biospecimen type and by tube type 
#keep this table for CCC version but remove from version that we are sharing with the sites
dev_tube <- NULL
for (i in 1:length(tube.ls)){
  
  id <- paste(tube.ls[i],"d_825582494",sep="_")
  tube <- paste(tube.ls[i],"d_678857215",sep="_")
  #note <- paste(tube.ls[i],"d_536710547",sep="_")
  tube_dev <- paste(tube.ls[i],"d_248868659", sep="_")
  deviation <- grep(tube_dev,colnames(coll_sett_all),value=TRUE)
  tmp <- as.data.frame(coll_sett_all[,which(colnames(coll_sett_all) %in% c(id,tube,deviation))] )
  tmp <- tmp[which(!is.na(tmp[,(colnames(tmp) == id)])),]
  
  dev_long <- data.table::melt(tmp,
                               id.vars=c(id,tube), 
                               measure.vars=deviation,
                               variable.name="dev_type",
                               value.name="deviation")
  
  
  colnames(dev_long)[grep("d_678857215",names(dev_long))] <- "d_678857215"
  colnames(dev_long)[grep("d_825582494",names(dev_long))] <- "TubeID"
  
  dev_long <- dev_long[complete.cases(dev_long[,c("TubeID","d_678857215","dev_type","deviation")]),]
  
  dev_tube <- dplyr::bind_rows(dev_tube,dev_long)
  
}  

dev_tube1   <- dev_tube %>% filter(d_678857215 ==353358909 & deviation == 353358909)  %>%  
  mutate(biospecimen=ifelse(grepl("d_973670172",dev_type), "urine",
                            ifelse(grepl("d_143615646",dev_type),"Mouthwash","blood")),
         tube_type = case_when(grepl("d_973670172",dev_type) ~ "Urine Tube1",
                               grepl("d_143615646",dev_type) ~ "MW Tube1",
                               grepl("d_299553921",dev_type) ~ "SS Tube1",
                               grepl("d_703954371",dev_type) ~ "SS Tube2",
                               grepl("d_454453939",dev_type) ~ "EDTA Tube1",
                               grepl("d_838567176",dev_type) ~ "Heparin Tube1",
                               grepl("d_652357376",dev_type) ~ "ACD Tube1",
                               grepl("d_677469051",dev_type) ~ "EDTA Tube2",
                               grepl("d_683613884",dev_type) ~ "EDTA Tube3",
                               grepl("d_376960806",dev_type) ~ "SS Tube3",
                               grepl("d_232343615",dev_type) ~ "SS Tube4",
                               grepl("d_589588440",dev_type) ~ "SS Tube5",
                               grepl("d_958646668",dev_type) ~ "Heparin Tube2",
                               grepl("d_505347689",dev_type) ~ "STRECK Tube1"), #make sure this doesn't break the code
         
         deviationnotes =case_when(sapply(strsplit(as.character(dev_type),"d_"),tail,1) =="102695484" ~ "Deviation Clot < 30min",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="242307474" ~ "Hemolyzed", 
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="283900611" ~ "Mislabel Resolved",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="313097539" ~ "Outside Contamated",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="453343022" ~ "Other",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="472864016" ~ "Broken", 
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="550088682" ~ "Temparture Too Low",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="561005927" ~ "Cent Low",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="635875253" ~ "Broken Gel",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="654002184" ~ "Centrifuge Too Long",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="684617815" ~ "MisLabled Discard",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="690540566" ~"Tempature Too High",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="728366619" ~"Low Volume-(tube/container partially filled but still usable)",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="742806035" ~"MW < 30s",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="757246707" ~"Leak/Spilled",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="777486216" ~"Tube Size",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="810960823" ~"Discard",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="861162895" ~"Cent High",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="912088602" ~"Clot > 2h",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="937362785" ~"Centrifuge Too Short",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="956345366" ~"Insufficient Volume",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="982885431" ~ "Not Found"))
notcol_tubes <- colnames(coll_sett_all)[grepl("883732523",colnames(coll_sett_all))] #7
col_tubes <- colnames(coll_sett_all)[grepl("d_593843561",colnames(coll_sett_all))] #13
dev_tubes <- colnames(coll_sett_all)[grepl("d_678857215",colnames(coll_sett_all))] #13
notcol.ls <- sapply(strsplit(notcol_tubes, "_d"),"[[",1)
notcol_tube <- NULL
tubenotcol.ls <-list()


for (i in 1:length(notcol.ls)){
  
  tubecol <- paste(notcol.ls[i],"d_593843561",sep="_")
  tube_notcol <- paste(notcol.ls[i],"d_883732523", sep="_") #notcolnotes
  TubeID <- paste(tube.ls[i],"d_825582494",sep="_")
  
  tube_deviation <- paste(notcol.ls[i], "d_678857215",sep="_")
  
  select <- c(TubeID,tubecol,tube_notcol,tube_deviation)
  tmp <- coll_sett_all[,(colnames(coll_sett_all)%in% c(select,"d_820476880","Site","biocol_Setting"))] 
  notcol <- tmp 
  colnames(notcol)[colnames(notcol)==TubeID] <- "TubeID"
  colnames(notcol)[colnames(notcol)==tubecol] <- "tubecol"
  colnames(notcol)[colnames(notcol)==tube_notcol] <- "tube_notcol"
  
  colnames(notcol)[colnames(notcol)==tube_deviation] <- "tube_deviation"
  
  
  notcol$tubeID <- notcol.ls[i]
  
  notcol_tube <- dplyr::bind_rows(notcol_tube,notcol)
  
} 


collection_long <- NULL
for (i in 1:length(tube.ls)){
  
  tubeid <- paste(tube.ls[i],"d_825582494",sep="_")
  tubecol <- paste(tube.ls[i],"d_593843561",sep="_")
  tube_deviation <- paste(tube.ls[i], "d_678857215",sep="_")
  tube_discard <- paste(tube.ls[i], "d_762124027",sep="_")
  select <- c(tubeid,tubecol,tube_deviation,tube_discard)
  tmp <- coll_sett_all[,(colnames(coll_sett_all)%in% c(select,"d_820476880","Site","biocol_Setting"))] 
  col <- tmp 
  colnames(col)[colnames(col)==tubeid] <- "TubeID"
  colnames(col)[colnames(col)==tubecol] <- "tubecol"
  colnames(col)[colnames(col)==tube_deviation] <- "tube_deviation"
  colnames(col)[colnames(col)==tube_discard] <- "tube_discard"
  
  col$tubeID <- tube.ls[i]
  collection_long <- dplyr::bind_rows(collection_long,col)
} 

collection_long <- collection_long  %>% 
  dplyr:: mutate(deviation = case_when(tube_deviation == 353358909 ~ "Any Deviation",
                                       tube_deviation == 104430631 ~ "No Deviation"),
                 Collected = case_when(tubecol ==353358909 ~ "Collected",
                                       tubecol == 104430631 ~ "Not  Collected"),
                 Discarded = case_when(tube_discard == 353358909 ~ "Any Discard",
                                       tube_discard == 104430631 ~ "No Discard"),
                 biospecimen=ifelse(tubeID=="d_973670172", "urine",
                                    ifelse(tubeID=="d_143615646","Mouthwash","blood")),
                 tube_type = case_when(tubeID == "d_973670172"  ~ "Urine Tube1",
                                       tubeID == "d_143615646"  ~ "MW Tube1",
                                       tubeID == "d_299553921"  ~ "SS Tube1",
                                       tubeID == "d_703954371"  ~ "SS Tube2",
                                       tubeID == "d_454453939"  ~ "EDTA Tube1",
                                       tubeID == "d_838567176"  ~ "Heparin Tube1",
                                       tubeID == "d_652357376"  ~ "ACD Tube1",
                                       tubeID == "d_677469051"  ~ "EDTA Tube2",
                                       tubeID == "d_683613884"  ~ "EDTA Tube3",
                                       tubeID == "d_376960806"  ~ "SS Tube3",
                                       tubeID == "d_232343615"  ~ "SS Tube4",
                                       tubeID == "d_589588440"  ~ "SS Tube5",
                                       tubeID == "d_505347689"  ~ "STRECK Tube1", 
                                       tubeID == "d_958646668"  ~ "Heparin Tube2"))
collection_long$tube_type <- factor(collection_long$tube_type, levels=c("SS Tube1", "SS Tube2","SS Tube3", "SS Tube4", "SS Tube5",
                                                                        "Heparin Tube1","Heparin Tube2","EDTA Tube1", "EDTA Tube2",
                                                                        "EDTA Tube3","ACD Tube1", "STRECK Tube1", "Urine Tube1","MW Tube1" ) )   



dev_tube1$tube_dev <- paste(dev_tube1$tube_type,"Deviation", dev_tube1$deviationnotes,sep=" ")
dev_tube1$tubeID <- substr(dev_tube1$dev_type,1,11)
dev <- collection_long %>% filter(tube_deviation==353358909) 
dev_tube2 <- base::merge(dev,dev_tube1[,c("dev_type","TubeID","tubeID","deviationnotes","tube_dev")],by.x=c("TubeID","tubeID"), by.y=c("TubeID","tubeID")) ##to get the deviation notes


```




```{r Table2.7_2.8, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

Tb.research.coltube <- tube_col %>% filter(all_settings=="Research") %>%  mutate(Site=droplevels(Site),
                                                                               bldcol_max=as.factor(bldcol_max)) #& grepl("Kaiser",Site)
Tb.research.coltube$bldcol_tubes <- factor(Tb.research.coltube$bldcol_max,levels=c(0:5))
Tb.research.coltube$bldcol_tubes <- droplevels(Tb.research.coltube$bldcol_tubes)

Tb.research.coltube$Site <-factor(Tb.research.coltube$Site,levels=c("Baylor Scott and White Health","HealthPartners", "Henry Ford Health",
                                                                    "Marshfield Clinic Health System",
                                                                    "Sanford Health", "University of Chicago Medicine"))

Total.research.coltube <- Tb.research.coltube %>% ungroup()

bloodtube_R <- create_tbl_cross(Total.research.coltube, "Site", "bldcol_tubes", "row", "Site", " ")
colnames(bloodtube_R)[ncol(bloodtube_R)] <- "Total Research Collections"
colnames(bloodtube_R)[1] <- "Site"






research__blood <- collection_long %>% filter(biocol_Setting == "Research" & tubecol == 353358909) %>% 
  mutate(Site=droplevels(Site),
         tube_type = factor(tube_type,levels=c("SS Tube1", "SS Tube2","Heparin Tube1","EDTA Tube1","ACD Tube1", "STRECK Tube1")))  
#research.coltube.bld.only<- research.coltube.bld.only %>%  mutate(tube_type=droplevels(tube_type))

research__blood <- research__blood %>% filter(!is.na(tube_type))



bloodtubetype_R <- create_tbl_cross(research__blood, "Site", "tube_type", "column", "Site", " ")
colnames(bloodtubetype_R)[ncol(bloodtubetype_R)] <- "Total Blood Tubes Collections"
colnames(bloodtubetype_R)[1] <- "Site"

```



```{r Table10, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}
## Number of tube tubes not collected at clinical collections
  #Note-- ask erin if we can keep these consistent, don't see why we need two versions of the tube names
clinic.coltube <- collection_long %>%  mutate(tube_types= case_when(tube_type=="SS Tube1" ~ "SS T1",
                                                                    tube_type=="SS Tube2" ~ "SS T2",
                                                                    tube_type=="SS Tube3" ~ "SS T3",
                                                                    tube_type=="SS Tube4" ~ "SS T4",
                                                                    tube_type=="SS Tube5" ~ "SS T5",
                                                                    tube_type=="Heparin Tube1" ~ "Heparin 1",
                                                                    tube_type=="Heparin Tube2" ~ "Heparin 2",
                                                                    tube_type=="EDTA Tube1" ~ "EDTA 1",
                                                                    tube_type=="EDTA Tube2" ~ "EDTA 2",
                                                                    tube_type=="EDTA Tube3" ~ "EDTA 3",
                                                                    tube_type=="ACD Tube1" ~ "ACD 1",
                                                                    tube_type=="STRECK Tube1" ~ "STRECK 1",
                                                                    tube_type=="Urine Tube1" ~ "Urine 1",
                                                                    tube_type=="MW Tube1" ~ "Mouthwash"))

clinic.coltube<- clinic.coltube %>% filter(biocol_Setting == "Clinical" & tubecol == 353358909 & tube_types!="Urine 1") %>% # & tube_type!="MW Tube1") %>% #added, need to test 
  mutate(Site=droplevels(Site),
         tube_type = factor(tube_types,levels=c("SS T1", "SS T2","SS T3", "SS T4", "SS T5", "Heparin 1","Heparin 2","EDTA 1","EDTA 2","EDTA 3","ACD 1","STRECK 1")))



bloodtubetype_C <- create_tbl_cross(clinic.coltube, "Site", "tube_types", "column", "Site", " ")
colnames(bloodtubetype_C)[ncol(bloodtubetype_C)] <- "Total Blood Tubes Collections"
colnames(bloodtubetype_C)[1] <- "Site"


```



```{r Table12a12b, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

## Table 15  
##Table X: Reason not collected by tube type and by site for research collections only
a<- collection_long[which(collection_long$tubecol==104430631),]
b <- notcol_tube[which(notcol_tube$tubecol == 104430631),]
notcol_notes <- base::merge(a, b[,c("tubeID","d_820476880","tube_notcol")], by=c("tubeID","d_820476880"),all.x=TRUE)
notcol_notes <- notcol_notes %>% 
  mutate(notcol.notes = case_when(tubecol == 104430631 & tube_notcol==181769837 ~ "Other",
                                  tubecol == 104430631 & tube_notcol==234139565 ~ "Short Draw",
                                  tubecol == 104430631 & tube_notcol==681745422 ~ "Participant Refusal",
                                  tubecol == 104430631 & tube_notcol==745205161 ~ "Participant Attempted",
                                  tubecol == 104430631 & tube_notcol==889386523 ~ "Supply Unavailable",
                                  tubecol == 104430631 & is.na(tube_notcol) ~ "Missing Reasons"),
         Collected = case_when(tubecol ==353358909 ~ "Collected",
                               tubecol == 104430631 ~ "Not  Collected"),
         biospecimen=ifelse(tubeID=="d_973670172", "urine",
                            ifelse(tubeID=="d_143615646","Mouthwash","blood")),
         tube_type = case_when(tubeID == "d_973670172"  ~ "Urine Tube1",
                               tubeID == "d_143615646"  ~ "MW Tube1",
                               tubeID == "d_299553921"  ~ "SS Tube1",
                               tubeID == "d_703954371"  ~ "SS Tube2",
                               tubeID == "d_454453939"  ~ "EDTA Tube1",
                               tubeID == "d_838567176"  ~ "Heparin Tube1",
                               tubeID == "d_652357376"  ~ "ACD Tube1",
                               tubeID == "d_677469051"  ~ "EDTA Tube2",
                               tubeID == "d_683613884"  ~ "EDTA Tube3",
                               tubeID == "d_376960806"  ~ "SS Tube3",
                               tubeID == "d_232343615"  ~ "SS Tube4",
                               tubeID == "d_589588440"  ~ "SS Tube5",
                               tubeID == "d_505347689"  ~ "STRECK Tube1",
                               tubeID == "d_958646668"  ~ "Heparin Tube2"))
notcol_notes$tube_type <- factor(notcol_notes$tube_type, levels=c("SS Tube1", "SS Tube2","SS Tube3", "SS Tube4", "SS Tube5",
                                                                  "Heparin Tube1","Heparin Tube2","EDTA Tube1", "EDTA Tube2",
                                                                  "EDTA Tube3","ACD Tube1","Urine Tube1","STRECK Tube1","MW Tube1" ) ) 
notcol_notes$notcol.notes <- factor(notcol_notes$notcol.notes, levels=c("Short Draw","Participant Attempted", "Other", "Participant Refusal", "Supply Unavailable", "Missing Reasons"))





research.notcol <- notcol_notes %>% filter(biocol_Setting=="Research" & tubecol==104430631) %>%
  mutate(Site=droplevels(Site),
         tube_type = factor(tube_type,levels=c("SS Tube1", "SS Tube2","Heparin Tube1","EDTA Tube1","ACD Tube1","STRECK Tube1","Urine Tube1","MW Tube1" )))
research.notcol$notcol.notes <- factor(research.notcol$notcol.notes, levels=c("Short Draw","Participant Attempted", "Other", "Participant Refusal", "Supply Unavailable", "Missing Reasons"))

reseachnotes.notcol <- n_pct_table(research.notcol$Site,research.notcol$notcol.notes)
reseachnotes.coltype <- n_pct_table(research.notcol$tube_type,research.notcol$notcol.notes)
notcol.reasons.research <- rbind(reseachnotes.notcol,reseachnotes.coltype)



reason_notcol <- create_tbl_cross(research.notcol, "Site", "notcol.notes", "column", "Site", " ")
colnames(reason_notcol)[ncol(reason_notcol)] <- "Total Tubes Not Collected"
colnames(reason_notcol)[1] <- "Site"



# research.notcolnotes_tube <- research.notcol %>% select(notcol.notes, tube_type) %>%
#   tbl_cross(  col = notcol.notes,
#               row = tube_type,
#               percent = "row",
#               digits= c(0,1),
#               label= c(notcol.notes~ " ", tube_type~"Tube Type"),
#               missing="ifany",
#               missing_text="0 ( 0 %)")
# 
# 
# 
# research.notcolnotes_tube_totals <- as.data.frame(research.notcolnotes_tube)
# research.notcolnotes_tube_totals <- research.notcolnotes_tube_totals[-1, ]
# 
# current_colnames <- colnames(research.notcolnotes_tube_totals)
# current_colnames[length(current_colnames)] <- "Total Tubes Not Collected"
# current_colnames[1] <- "Tube Type"
# colnames(research.notcolnotes_tube_totals) <- current_colnames


tube_type_notcolreasons <- create_tbl_cross(research.notcol, "tube_type", "notcol.notes", "column", "Tube Type", " ")
colnames(tube_type_notcolreasons)[ncol(tube_type_notcolreasons)] <- "Total Tubes Not Collected"
colnames(tube_type_notcolreasons)[1] <- "Tube Type"



```


```{r Table13, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

research.notcolnotes <- research.notcol %>% select(notcol.notes,Site, tube_type) %>% 
  crosstable(c(Site, tube_type),by=notcol.notes,showNA="ifany", total="row",margin=c("row", "col"),
             percent_digits=1, percent_pattern="{n} ({p_col})") %>% as_flextable()

clinicnotes.notcol <- notcol_notes %>% filter(biocol_Setting=="Clinical" & tubecol==104430631 & notcol_notes$biospecimen!="Mouthwash"  )%>%    
  mutate(Site=droplevels(Site),
         tube_type = factor(tube_type,levels=c("SS Tube1", "SS Tube2","SS Tube3", "SS Tube4", "SS Tube5","Heparin Tube1","Heparin Tube2",
                                               "EDTA Tube1", "EDTA Tube2","EDTA Tube3","ACD Tube1","STRECK Tube1","Urine Tube1" )))
          
clinicnotes.notcol$notcol.notes <- factor(clinicnotes.notcol$notcol.notes, levels=c("Short Draw","Participant Attempted", "Other", "Participant Refusal", "Supply Unavailable", "Missing Reasons"))
clinicnotes.notcol$notcol.notes <- droplevels(clinicnotes.notcol$notcol.notes)
clinicnotes.notcol$tube_type = droplevels(clinicnotes.notcol$tube_type)
clinic.notcolsite <- n_pct_table(clinicnotes.notcol$Site,clinicnotes.notcol$notcol.notes)
clinicnotes.coltype <- n_pct_table(clinicnotes.notcol$tube_type,clinicnotes.notcol$notcol.notes)
notcol.reasons.clinic <- rbind(clinicnotes.coltype,clinic.notcolsite)
reasons <- c("Short Draw","Participant Attempted", "Other", "Participant Refusal", "Supply Unavailable", "Missing Reasons")
missing <- reasons[which(c(reasons,"Site","Total") %nin% colnames(notcol.reasons.clinic))]
n.col <- as.numeric(ncol(notcol.reasons.clinic))
for (i in 1:length(missing)){
  notcol.reasons.clinic[,(n.col+i)] <- "0 (0 %)"
  colnames(notcol.reasons.clinic)[n.col+i] <- missing[i]
}

notcol.reasons.clinic[c(14,21),c((n.col+1):8)] <- "0"






## Table 16 
#Table Number of tube tubes Discarded by tube type and site
discard.tb <- collection_long  %>% filter(tube_discard == 353358909) %>% 
  mutate(Site=droplevels(Site),
         tube_type = droplevels(tube_type))
discard.site <- n_pct_table(discard.tb$Site,discard.tb$tube_type)
discard.site <- (discard.site[, c(10, 1:9)]) #Will need to update dimensions when STRECK Tube 1 listed 

discard.site[nrow(discard.site),c(2:10)] <- paste(discard.site[nrow(discard.site),c(2:10)], "(100%)")

```


```{r Rsch_Srvy_Status, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

research.survey <- coll_sett_all %>% filter(all_settings == "Research") %>%
  mutate(research.sv = case_when(d_265193023 == 231311385 ~ "Submitted",
                                 d_265193023 == 615768760 ~ "Started",
                                 d_265193023 == 972455046 ~ "Not Started"),
         Site=droplevels(Site),
         research.svtime =  difftime(as.POSIXct(ymd_hms(d_222161762)),as.POSIXct(ymd_hms(d_822499427)),units="hours"), ##survey time from start to complete
         ctime = round(as.numeric(difftime(as.POSIXct(ymd_hms(d_222161762)),as.POSIXct(ymd_hms(d_822499427)),units="mins")), digits=1),
         tm_biocolsuv = difftime(as.POSIXct(ymd_hms(d_222161762)),as.POSIXct(ymd_hms(d_331584571_d_266600170_d_840048338)),units="hours"), #time between survey completion to biospecimen collection visit check in
         checktmvisit = case_when( as.numeric(tm_biocolsuv) >72 ~"> 72hrs",
                                   72 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 48 ~ "> 48 hrs to 72 hrs",
                                   48 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 24 ~ "> 24 hrs to 48 hrs",   
                                   24 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 12 ~ "> 12 hrs to 24 hrs",
                                   12 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 3 ~ "> 3 hrs to 12 hrs",  
                                   3 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) >= 0 ~ "0 hrs to 3 hrs",
                                   d_265193023 != 231311385 ~ "Not Submitted", 
                                   TRUE ~ "Missing Time"), #changed from NA to "Missing"
         time_biochk = difftime(as.POSIXct(ymd_hms(d_331584571_d_266600170_d_343048998)),as.POSIXct(ymd_hms(d_331584571_d_266600170_d_840048338)),units="mins"),
         biochk_outlier = ifelse(is.na(time_biochk), "Missing (not checked out)", 
                                 ifelse( 0<= as.numeric(time_biochk)/60 & as.numeric(time_biochk)/60 <= 24, "No Outlier", 
                                         ifelse(as.numeric(time_biochk)/60 > 24, "Outlier",  "Undefined"))),
         biochk_outlier = factor(biochk_outlier,levels=c("No Outlier","Outlier","Missing (not checked out)")),
         checktmvisit = factor(checktmvisit, levels=c( "Not Submitted", "Missing Time", "0 hrs to 3 hrs","> 3 hrs to 12 hrs",
                                                       "> 12 hrs to 24 hrs","> 24 hrs to 48 hrs","> 48 hrs to 72 hrs","> 72hrs"))) 




BUM_status <- create_tbl_cross(research.survey, "research.sv", "Site", "column", " ", " ")
colnames(BUM_status)[ncol(BUM_status)] = "Total Research Surveys"


##Check in until completion
precovR <- research.survey %>%  filter(research.sv == "Submitted" & 
                                         d_222161762<as.Date("2023-07-05") | (is.na(d_222161762) & d_331584571_d_266600170_d_840048338<as.Date("2023-07-05")))
postcovR <- research.survey %>%  filter(research.sv == "Submitted" & 
                                          d_222161762>=as.Date("2023-07-05") | (is.na(d_222161762) & d_331584571_d_266600170_d_840048338>=as.Date("2023-07-05")))

precovid_BUMtime <- create_tbl_cross(precovR, "checktmvisit", "Site", "column", " ", " ")
colnames(precovid_BUMtime)[ncol(precovid_BUMtime)] = "Total Research Surveys"

postcovid_BUMtime <- create_tbl_cross(postcovR, "checktmvisit", "Site", "column", " ", " ")
colnames(postcovid_BUMtime)[ncol(postcovid_BUMtime)] = "Total Research Surveys"





##Start to submission 
precovR_comp <- research.survey %>%  filter(d_222161762<as.Date("2023-07-05") & research.sv == "Submitted" & ctime>0) 
postcovR_comp <- research.survey %>%  filter(d_222161762>=as.Date("2023-07-05") & research.sv == "Submitted" & ctime>0)


Table21R_Before = precovR_comp %>% group_by(Site) %>% 
  dplyr::summarize('Number of Submitted Research Surveys'=n(),
                   Min = min(ctime),
                   Q1 = quantile(ctime, 0.25),
                   Median = median(ctime),
                   Mean = mean(ctime),
                   Q3 = quantile(ctime, 0.75),
                   Perc.95= quantile(ctime, 0.95),
                   Max = max(ctime))


Table21R_After = postcovR_comp %>% group_by(Site) %>% 
  dplyr::summarize('Number of Submitted Research Surveys'=n(),
                   Min = min(ctime),
                   Q1 = quantile(ctime, 0.25),
                   Median = median(ctime),
                   Mean = mean(ctime),
                   Q3 = quantile(ctime, 0.75),
                   Perc.95= quantile(ctime, 0.95),
                   Max = max(ctime))




```



```{r Clin_Srvy_Status, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

clinical.survey <- coll_sett_all %>% filter(all_settings == "Clinical") %>%
  mutate(clin.sv = case_when(d_253883960 == 231311385 ~ "Submitted",
                             d_253883960 == 615768760 ~ "Started",
                             d_253883960 == 972455046 ~ "Not Started"),
         Site=droplevels(Site),
         d_173836415_d_266600170_d_139245758_clc = as.POSIXct(ymd_hms(d_173836415_d_266600170_d_139245758)), ##urine
         d_173836415_d_266600170_d_982213346_clc = as.POSIXct(ymd_hms(d_173836415_d_266600170_d_982213346)), ##blood collected
         d_173836415_d_266600170_d_740582332_clc = as.POSIXct(ymd_hms(d_173836415_d_266600170_d_740582332)), ##Autogenerated date/time stamp for Any specimen collected at RRL
         clinic.svtime =  difftime(as.POSIXct(ymd_hms(d_764863765)),as.POSIXct(ymd_hms(d_534669573)),units="hours"),
         ctime = round(as.numeric(difftime(as.POSIXct(ymd_hms(d_764863765)),as.POSIXct(ymd_hms(d_534669573)),units="mins")), digits=1)) ##survey time from start to complete

clinical.survey <- clinical.survey %>% mutate(clc.coltm  = do.call(pmin, c(select(.,ends_with('clc')),na.rm=TRUE))) ###any biospecimen collected time
clinical.survey$tm_biocolsuv <-  difftime(as.POSIXct(ymd_hms(clinical.survey$d_764863765)),clinical.survey$clc.coltm,units="hours") #time between survey completion to biospecimen collection visit check in
clinicsv.complete <- as.data.frame(tab1(clinical.survey$clin.sv))
clinicsv.complete <- clinicsv.complete %>% 
  mutate(cumulative.Freq = ifelse(output.table.Percent<100.0, cumsum(output.table.Frequency),output.table.Frequency))


clinical.survey <-clinical.survey %>%
  mutate(checktmvisit = case_when(as.numeric(tm_biocolsuv) >72 ~"> 72hrs",
                                  72 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 48 ~ "> 48 hrs to 72 hrs",
                                  48 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 24 ~ "> 24 hrs to 48 hrs",
                                  24 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 12 ~ "> 12 hrs to 24 hrs",
                                  12 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 3 ~ "> 3 hrs to 12 hrs",    
                                  3 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) >= 0 ~ "0 hrs to 3 hrs", 
                                  d_265193023 != 231311385 ~ "Not Submitted", 
                                  TRUE ~ "Missing Time"),
         checktmvisit = factor(checktmvisit, levels=c("Not Submitted", "Missing Time", "0 hrs to 3 hrs", "> 3 hrs to 12 hrs", 
                                                      "> 12 hrs to 24 hrs", "> 24 hrs to 48 hrs", "> 48 hrs to 72 hrs", "> 72hrs")))

clinical.survey$checktmvisit <- droplevels(clinical.survey$checktmvisit)

BU_status <- create_tbl_cross(clinical.survey, "clin.sv", "Site", "column", " ", " ")
colnames(BU_status)[ncol(BU_status)] = "Total Clinical Surveys"


clin_comp <- clinical.survey %>%  filter(clin.sv == "Submitted")
coll_comp_BU <- create_tbl_cross(clin_comp, "checktmvisit", "Site", "column", " ", " ")

colnames(coll_comp_BU)[ncol(coll_comp_BU)] <- "Total Submitted Clinical Surveys"



##Start to submission 
precovC_comp <- clinical.survey %>%  filter(d_764863765<as.Date("2023-07-05") & clin.sv == "Submitted" & ctime>0)
postcovC_comp <- clinical.survey %>%  filter(d_764863765>=as.Date("2023-07-05") & clin.sv == "Submitted" & ctime>0)


ClinSrvy_Lgth_Before = precovC_comp %>% group_by(Site) %>% 
  dplyr::summarize('Number of Submitted \n Clinical Surveys'=n(),
                   Min = min(ctime),
                   Q1 = quantile(ctime, 0.25),
                   Median = median(ctime),
                   Mean = mean(ctime),
                   Q3 = quantile(ctime, 0.75),
                   Perc.95= quantile(ctime, 0.95),
                   Max = max(ctime))


ClinSrvy_Lgth_After = postcovC_comp %>% group_by(Site) %>% 
  dplyr::summarize('Number of Submitted \n Clinical Surveys'=n(),
                   Min = min(ctime),
                   Q1 = quantile(ctime, 0.25),
                   Median = median(ctime),
                   Mean = mean(ctime),
                   Q3 = quantile(ctime, 0.75),
                   Perc.95= quantile(ctime, 0.95),
                   Max = max(ctime))

```




```{r Research_Srvy_Status, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

### Section 4

statics_biock <- tapply(as.numeric(research.survey$time_biochk),research.survey$biochk_outlier,summary)
tab32a <- bind_rows(statics_biock)

research.vt.length <- research.survey %>%  mutate(time=as.numeric(time_biochk)) 

research.vt.length.table = research.vt.length %>%group_by(Site) %>% #biochk_outlier,
  dplyr::summarize('Number of Research Collection Visits'=n(),
                   Min = min(time,na.rm = TRUE),
                   Q1 = quantile(time, 0.25,na.rm = TRUE),
                   Median = median(time,na.rm = TRUE),
                   Mean = mean(time,na.rm = TRUE),
                   Q3 = quantile(time, 0.75,na.rm = TRUE),
                   Perc.90= quantile(time, 0.90,na.rm = TRUE),
                   Perc.95= quantile(time, 0.95,na.rm = TRUE),
                   Perc.98= quantile(time, 0.98,na.rm = TRUE),
                   Max = max(time,na.rm = TRUE))


research.vt.length.UC <- research.vt.length %>% filter(Site=="University of Chicago Medicine") %>% 
  mutate(Site_location = case_when(d_951355211==777644826 ~ "UC-DCAM",
                                   d_951355211==145191545 ~ "Ingalls Harvey",
                                   d_951355211==489380324 ~ "River East",
                                   d_951355211==120264574 ~ "South Loop",
                                   d_951355211==319518299 ~ "UCM Pop-Up",
                                   d_951355211==940329442 ~ "Orland Park"))
research.vt.length.UC.table = research.vt.length.UC %>%group_by(Site_location) %>% #biochk_outlier,
  dplyr::summarize('Number of Research Collection Visits'=n(),
                   Min = min(time,na.rm = TRUE),
                   Q1 = quantile(time, 0.25,na.rm = TRUE),
                   Median = median(time,na.rm = TRUE),
                   Mean = mean(time,na.rm = TRUE),
                   Q3 = quantile(time, 0.75,na.rm = TRUE),
                   Perc.90= quantile(time, 0.90,na.rm = TRUE),
                   Perc.95= quantile(time, 0.95,na.rm = TRUE),
                   Perc.98= quantile(time, 0.98,na.rm = TRUE),
                   Max = max(time,na.rm = TRUE))




```






```{r Table21a21b, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}
baseline_colct <- coll_sett_all %>%  filter(d_331584571== 266600170 & !is.na(d_914594314) & !is.na(d_556788178) & all_settings=="Research")

## BEFORE 2/1/23
baseline_colctC <- baseline_colct %>%  filter(d_914594314<as.Date("2022-08-01"))

BSL_colctC <- baseline_colctC %>%  mutate(time = as.numeric(difftime(as.POSIXct(ymd_hms(d_556788178)),as.POSIXct(ymd_hms(d_914594314)),units="days")),
                                          "Number of Participants" = n(),
                                          'Number of Baseline Collections' = case_when(!is.na(d_556788178) ~ n()))


verif_BSL_colctC = BSL_colctC %>%group_by(Site) %>%
  dplyr::summarize('Number of Research Cllection Visits'=n(),
                   Min = round(min(time,na.rm = TRUE), digits=1),
                   Q1 = round(quantile(time, 0.25,na.rm = TRUE), digits=1),
                   Median = round(median(time,na.rm = TRUE), digits=1),
                   Mean = round(mean(time,na.rm = TRUE), digits=1),
                   Q3= round(quantile(time, 0.75,na.rm = TRUE), digits=1),
                   Max = round(max(time,na.rm = TRUE), digits=1))




## ON OR AFTER 2/1/23


baseline_colctD <- baseline_colct %>%  filter(d_914594314>=as.Date("2022-08-01"))

BSL_colctD <- baseline_colctD %>%  mutate(time = as.numeric(difftime(as.POSIXct(ymd_hms(d_556788178)),as.POSIXct(ymd_hms(d_914594314)),units="days")))


verif_BSL_colctD = BSL_colctD %>%group_by(Site) %>% 
  dplyr::summarize('Number of Research Collection Visits'=n(),
                   Min = round(min(time,na.rm = TRUE), digits=1),
                   Q1 = round(quantile(time, 0.25,na.rm = TRUE), digits=1),
                   Median = round(median(time,na.rm = TRUE), digits=1),
                   Mean = round(mean(time,na.rm = TRUE), digits=1),
                   SD= round(sd(time,na.rm = TRUE), digits=1),
                   Q3= round(quantile(time, 0.75,na.rm = TRUE), digits=1),
                   Max = round(max(time,na.rm = TRUE), digits=1))



##################



baseline_colct <- coll_sett_all %>%  filter(d_331584571== 266600170 & !is.na(d_914594314) & !is.na(d_556788178) & all_settings=="Clinical") 

## BEFORE 2/1/23
baseline_colctA <- baseline_colct %>%  filter(d_914594314<as.Date("2023-02-01"))

BSL_colctA <- baseline_colctA %>%  mutate(time = as.numeric(difftime(as.POSIXct(ymd_hms(d_556788178)),as.POSIXct(ymd_hms(d_914594314)),units="days")),
                                          "Number of Participants" = n(),
                                          'Number of Baseline Collections' = case_when(!is.na(d_556788178) ~ n()))


verif_BSL_colctA = BSL_colctA %>%group_by(Site) %>%
  dplyr::summarize('Number of Clinical Collections'=n(),
                   Min = round(min(time,na.rm = TRUE), digits=1),
                   Q1 = round(quantile(time, 0.25,na.rm = TRUE), digits=1),
                   Median = round(median(time,na.rm = TRUE), digits=1),
                   Mean = round(mean(time,na.rm = TRUE), digits=1),
                   SD= round(sd(time,na.rm = TRUE), digits=1),
                   Q3= round(quantile(time, 0.75,na.rm = TRUE), digits=1),
                   Max = round(max(time,na.rm = TRUE), digits=1))




## ON OR AFTER 2/1/23

baseline_colctB <- baseline_colct %>%  filter(d_914594314>=as.Date("2023-02-01"))

BSL_colctB <- baseline_colctB %>%  mutate(time = as.numeric(difftime(as.POSIXct(ymd_hms(d_556788178)),as.POSIXct(ymd_hms(d_914594314)),units="days")))


verif_BSL_colctB = BSL_colctB %>%group_by(Site) %>% 
  dplyr::summarize('Number of Clinical Collections'=n(),
                   Min = round(min(time,na.rm = TRUE), digits=1),
                   Q1 = round(quantile(time, 0.25,na.rm = TRUE), digits=1),
                   Median = round(median(time,na.rm = TRUE), digits=1),
                   Mean = round(mean(time,na.rm = TRUE), digits=1),
                   SD= round(sd(time,na.rm = TRUE), digits=1),
                   Q3= round(quantile(time, 0.75,na.rm = TRUE), digits=1),
                   Max = round(max(time,na.rm = TRUE), digits=1))











##########################


ver_draw <- coll_sett_all %>%  filter(all_settings=="Clinical" & !is.na(d_914594314) & !is.na(d_556788178) & d_914594314>=as.Date("2023-02-01")  & 
                                    Site!='HealthPartners' & Site!='Sanford Health' & Site!='University of Chicago Medicine') 
##won't receive a draw order from HP--Github issue 72

verif_draw <- ver_draw %>%  mutate(time = as.numeric(difftime(as.POSIXct(ymd_hms(d_173836415_d_266600170_d_769615780)),as.POSIXct(ymd_hms(d_914594314)),units="days")))

verif_draw_order = verif_draw %>%group_by(Site) %>% 
  dplyr::summarize('Number of Draw Orders Placed'=n(),
                   Min = round(min(time,na.rm = TRUE), digits=1),
                   Q1 = round(quantile(time, 0.25,na.rm = TRUE), digits=1),
                   Median = round(median(time,na.rm = TRUE), digits=1),
                   Mean = round(mean(time,na.rm = TRUE), digits=1),
                   #SD= round(sd(time,na.rm = TRUE), digits=1),
                   Q3 = round(quantile(time, 0.75,na.rm = TRUE), digits=1),
                   Max = round(max(time,na.rm = TRUE), digits=1))



## ON OR AFTER 2/1/23

verif_baseline_Af <- coll_sett_all %>%  filter(d_331584571== 266600170 & !is.na(d_914594314) & !is.na(d_556788178) & d_914594314>=as.Date("2022-06-01")) %>%  
  mutate(time = as.numeric(difftime(as.POSIXct(ymd_hms(d_556788178)),as.POSIXct(ymd_hms(d_914594314)),units="days")),
         campaign = case_when((state_d_667474224==348281054 | state_d_667474224==324692899) ~ "Upcoming Appointment",
                               TRUE ~ "All Other Campaigns")) %>%
  group_by(Site) %>% 
  dplyr::summarize(#'Number of Baseline Collections1'=n()[campaign=="Upcoming Appointment"],
    'Number of Baseline Collections1' = sum(campaign == "Upcoming Appointment"),
    Min1 = round(min(time[campaign=="Upcoming Appointment"],na.rm = TRUE), digits=1),
    Median1 = round(median(time[campaign=="Upcoming Appointment"],na.rm = TRUE), digits=1),
    Mean1 = round(mean(time[campaign=="Upcoming Appointment"],na.rm = TRUE), digits=1),
    SD1= round(sd(time[campaign=="Upcoming Appointment"],na.rm = TRUE), digits=1),
    Max1 = round(max(time[campaign=="Upcoming Appointment"],na.rm = TRUE), digits=1),
    #'Number of Baseline Collections2'=n()[campaign=="All Other Campaigns"],
    'Number of Baseline Collections2'=sum(campaign == "All Other Campaigns"),
    Min2 = round(min(time[campaign=="All Other Campaigns"],na.rm = TRUE), digits=1),
    Median2 = round(median(time[campaign=="All Other Campaigns"],na.rm = TRUE), digits=1),
    Mean2 = round(mean(time[campaign=="All Other Campaigns"],na.rm = TRUE), digits=1),
    SD2= round(sd(time[campaign=="All Other Campaigns"],na.rm = TRUE), digits=1),
    Max2 = round(max(time[campaign=="All Other Campaigns"],na.rm = TRUE), digits=1),
    'Total Number of Baseline Collections'=n())%>%
  ungroup() %>%  
  select(Site,  'Number of Baseline Collections1', Min1, Median1, Mean1, SD1, Max1, 
         'Number of Baseline Collections2', Min2, Median2, Mean2, SD2, Max2, 'Total Number of Baseline Collections')




```

```{r Table25, include=FALSE, echo=FALSE, warning=FALSE}


avg_draw_order <- clinical.survey %>%  filter(d_173836415_d_266600170_d_982213346>=as.Date("2023-02-01") & 
                                        Site!='HealthPartners' & Site!="Sanford Health" & Site!='University of Chicago Medicine') %>%  ##won't receive a draw order from HP--Github issue 72
  mutate(time = as.numeric(difftime(as.POSIXct(ymd_hms(d_173836415_d_266600170_d_982213346)),as.POSIXct(ymd_hms(d_173836415_d_266600170_d_769615780)),units="days"))) %>%
  group_by(Site) %>% 
  dplyr::summarize('Number of Clinical Collections'=n(),
                   Min = round(min(time,na.rm = TRUE), digits=1),
                   Q1 = round(quantile(time, 0.25,na.rm = TRUE), digits=1),
                   Median = round(median(time,na.rm = TRUE), digits=1),
                   Mean = round(mean(time,na.rm = TRUE), digits=1),
                   Q3 = round(quantile(time, 0.75,na.rm = TRUE), digits=1),
                   Perc.80= quantile(time, 0.80,na.rm = TRUE),
                   Perc.90= quantile(time, 0.90,na.rm = TRUE),
                   Perc.95= quantile(time, 0.95,na.rm = TRUE),
                   Max = round(max(time,na.rm = TRUE), digits=1))

```



```{r Table26_bldorder_present, include=FALSE, echo=FALSE, warning=FALSE}

present.day <- Sys.time()

avg_bldorder_present <- recrver1 %>%  filter(d_878865966==104430631 & !is.na(d_173836415_d_266600170_d_769615780) & 
                                           Site!='HealthPartners' & Site!='Henry Ford Health'  & Site!='Sanford Health') %>%  
  mutate(time = as.numeric(difftime(present.day,as.POSIXct(ymd_hms(d_173836415_d_266600170_d_769615780)),units="days"))) %>% 
  group_by(Site) %>% 
  dplyr::summarize('Number of Open Draw Orders'=n(),
                   Min = round(min(time,na.rm = TRUE), digits=1),
                   Q1 = round(quantile(time, 0.25,na.rm = TRUE), digits=1),
                   Median = round(median(time,na.rm = TRUE), digits=1),
                   Mean = round(mean(time,na.rm = TRUE), digits=1),
                   Q3 = round(quantile(time, 0.75,na.rm = TRUE), digits=1),
                   Perc.80= quantile(time, 0.80,na.rm = TRUE),
                   Perc.90= quantile(time, 0.90,na.rm = TRUE),
                   Perc.95= quantile(time, 0.95,na.rm = TRUE),
                   Max = round(max(time,na.rm = TRUE), digits=1))


```



```{r Table27, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}


###won't receive a draw order from HP--Github issue 72
Table_bld_draw= recrver1 %>%  filter(d_827220437==125001209 | d_827220437==327912200 | d_827220437==300267574 | d_827220437==452412599) %>% ## excluding hybrid sites
  mutate(bld_placed= case_when(d_173836415_d_266600170_d_530173840==353358909 ~ "Blood Draw Order Placed",
                               (d_173836415_d_266600170_d_530173840==104430631 | is.na(d_173836415_d_266600170_d_530173840))~ "No Blood Draw Order Placed"),
         Site= case_when(d_827220437==125001209 ~ "Kaiser Permanente Colorado",
                         d_827220437==327912200 ~ "Kaiser Permanente Georgia",
                         d_827220437==300267574 ~ "Kaiser Permanente Hawaii",
                         d_827220437==452412599 ~ "Kaiser Permanente Northwest"),
         verif_bld= case_when(d_821247024==197316935 ~ 1,
                              TRUE ~ 0))  %>% 
  dplyr::select(Site, bld_placed)  %>% 
  tbl_cross(
  row = Site,
  col = bld_placed,
  percent = "row",
  digits=c(0,1),
  label=list(Site~"Site", bld_placed~" "), 
  missing="ifany",
  missing_text="Unknown") %>%
  bold_labels() %>%
  #italicize_levels() %>% 
  modify_header() %>%
  modify_caption("Table 4.11: Baseline Blood Draw Order Status Among Verified Participants") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)




``` 

```{r Table26, warning=FALSE, eval=TRUE,echo=FALSE}

ver_date_diff <-table1  %>% filter(biocol.appoint=="No Baseline Collection")  %>% 
  group_by(Site) %>% 
  mutate(day_past = difftime(as.Date(currentDate), as.Date(d_914594314), units="days"),
         coll_days_diff = ifelse(as.numeric(day_past)<30,"< 30 Days",
                                 ifelse(as.numeric(day_past)<60,"30 to <60 Days",
                                        ifelse(as.numeric(day_past)<90,"60 to <90 Days",
                                               ifelse(as.numeric(day_past)<180,"90 to 180 Days",
                                                      ifelse(as.numeric(day_past)<270,"180 to <270 Days",
                                                             "270 Days or More"))))))


ver_date_diff$Connect_ID <- as.numeric(ver_date_diff$Connect_ID)

table.coll_bptl <- ctable(ver_date_diff$Site,ver_date_diff$coll_days_diff)
crosstable.coll_bptl <- as.data.frame(cbind(table.coll_bptl$cross_table,table.coll_bptl$proportions))
crosstable.coll_bptl$Sites <-trimws(rownames(crosstable.coll_bptl))


crosstable.coll_bptl$n_pct_30_Day <-  paste(format(crosstable.coll_bptl[,1],big.mark=","),"(", round(100*crosstable.coll_bptl[,8],1),"%)",sep=" ")
crosstable.coll_bptl$n_pct_60_Day <-  paste(format(crosstable.coll_bptl[,4],big.mark=","),"(", round(100*crosstable.coll_bptl[,11],1),"%)",sep=" ")
crosstable.coll_bptl$n_pct_90_Day <-  paste(format(crosstable.coll_bptl[,5],big.mark=","),"(", round(100*crosstable.coll_bptl[,12],1),"%)",sep=" ")
crosstable.coll_bptl$n_pct_180_Day <-  paste(format(crosstable.coll_bptl[,6],big.mark=","),"(", round(100*crosstable.coll_bptl[,13],1),"%)",sep=" ")
crosstable.coll_bptl$n_pct_270_Day <-  paste(format(crosstable.coll_bptl[,2],big.mark=","),"(", round(100*crosstable.coll_bptl[,9],1),"%)",sep=" ")
crosstable.coll_bptl$n_pct_270_plus_days =  paste(format(crosstable.coll_bptl[,3],big.mark=","),"(", round(100*crosstable.coll_bptl[,10],1),"%)",sep=" ")
crosstable.coll_bptl$Total <- paste(crosstable.coll_bptl$Total, " (100%)")
#nrow(crosstable.coll_bptl)

crosstable.coll_bptl1 <- crosstable.coll_bptl[, c(15:21, 7)]


```


```{r Table28a,include=FALSE, echo=FALSE, warning=FALSE}

#### Section 5


str_sub(research.survey$d_143615646_d_926457119,12,24)[!is.na(research.survey$d_143615646_d_926457119)] <- "11:30:00.000Z"
str_sub(research.survey$d_232343615_d_926457119,12,24)[!is.na(research.survey$d_232343615_d_926457119)] <- "11:30:00.000Z"
str_sub(research.survey$d_299553921_d_926457119,12,24)[!is.na(research.survey$d_299553921_d_926457119)] <- "11:30:00.000Z"
str_sub(research.survey$d_376960806_d_926457119,12,24)[!is.na(research.survey$d_376960806_d_926457119)] <- "11:30:00.000Z"
str_sub(research.survey$d_454453939_d_926457119,12,24)[!is.na(research.survey$d_454453939_d_926457119)] <- "11:30:00.000Z"
str_sub(research.survey$d_505347689_d_926457119,12,24)[!is.na(research.survey$d_505347689_d_926457119)] <- "11:30:00.000Z"
str_sub(research.survey$d_589588440_d_926457119,12,24)[!is.na(research.survey$d_589588440_d_926457119)] <- "11:30:00.000Z"
str_sub(research.survey$d_652357376_d_926457119,12,24)[!is.na(research.survey$d_652357376_d_926457119)] <- "11:30:00.000Z"
str_sub(research.survey$d_677469051_d_926457119,12,24)[!is.na(research.survey$d_677469051_d_926457119)] <- "11:30:00.000Z"
str_sub(research.survey$d_683613884_d_926457119,12,24)[!is.na(research.survey$d_683613884_d_926457119)] <- "11:30:00.000Z"
str_sub(research.survey$d_703954371_d_926457119,12,24)[!is.na(research.survey$d_703954371_d_926457119)] <- "11:30:00.000Z"
str_sub(research.survey$d_838567176_d_926457119,12,24)[!is.na(research.survey$d_838567176_d_926457119)] <- "11:30:00.000Z"
str_sub(research.survey$d_958646668_d_926457119,12,24)[!is.na(research.survey$d_958646668_d_926457119)] <- "11:30:00.000Z"
str_sub(research.survey$d_973670172_d_926457119,12,24)[!is.na(research.survey$d_973670172_d_926457119)] <- "11:30:00.000Z"

#RESEARCH 
biospe_adhoc_all <-  research.survey %>%  filter(all_settings=="Research" & d_410912345==353358909 & !is.na(d_678166505) & !is.na(Site_location) & !is.na(Site))

#BPTL null- not used in this table, but need to understand the denominator inconsistencies 
biospe_adhoc_missings = biospe_adhoc_all %>%  filter(is.na(d_143615646_d_926457119) & is.na(d_232343615_d_926457119) & 
                                                           is.na(d_299553921_d_926457119) & is.na(d_376960806_d_926457119) &
                                                           is.na(d_454453939_d_926457119) & is.na(d_505347689_d_926457119) & 
                                                           is.na(d_589588440_d_926457119) & is.na(d_652357376_d_926457119) &
                                                           is.na(d_677469051_d_926457119) & is.na(d_683613884_d_926457119) & 
                                                           is.na(d_703954371_d_926457119) & is.na(d_838567176_d_926457119) &
                                                           is.na(d_958646668_d_926457119) & is.na(d_973670172_d_926457119))
#Used for this table- BPTL not null
coll_bptl_diff <- biospe_adhoc_all %>%  
  filter(!is.na(d_143615646_d_926457119) | !is.na(d_232343615_d_926457119) |
                                                 !is.na(d_299553921_d_926457119) | !is.na(d_376960806_d_926457119) |
                                                 !is.na(d_454453939_d_926457119) | !is.na(d_505347689_d_926457119) |
                                                 !is.na(d_589588440_d_926457119) |!is.na(d_652357376_d_926457119) |
                                                 !is.na(d_677469051_d_926457119) | !is.na(d_683613884_d_926457119) |
                                                 !is.na(d_703954371_d_926457119) | !is.na(d_838567176_d_926457119) |
                                                 !is.na(d_958646668_d_926457119) | !is.na(d_973670172_d_926457119)) %>%
  mutate(Site_location = factor(Site_location,
                                levels=c("BCC- HWC","FW All Saints","BCC- Plano","BCC- Worth St","BCC- Irving",
                                         "Irving", "NTX Biorepository","BCC- Fort Worth",
                                         "HP Research Clinic", "HP Park Nicollet", "Missing HP location",
                                         "HFH K-13 Research Clinic","HFH Cancer Pavilion Research Clinic",
                                         "HFH Livonia Research Clinic", "HFH Pop-Up", "HFH Detroit Northwest","In-home Collection", "Missing HFH location",
                                         "Neillsville", "Missing MF location",
                                         "Marshfield", "MF Pop-Up","Weston","Lake Hallie", "Rice Lake","Wisconsin Rapids", 
                                         "Colby Abbotsford","Minocqua","Merrill","Stevens Point",
                                         "Sioux Falls Imagenetics","Fargo South University","Edith Sanford Breast Center (coded as Sanford Center)", 
                                  "Edith Sanford Breast Center","Fargo Amber Valley",
                                         "Ingalls Harvey", "River East","South Loop","UCM Pop-Up","UC-DCAM","Orland Park", "Missing UC location")),
         Site = factor(Site, levels=c("Baylor Scott and White Health","HealthPartners","Henry Ford Health",
                                      "Marshfield Clinic Health System","Sanford Health","University of Chicago Medicine")))  %>% 
  group_by(as.character(Connect_ID),Site, Site_location) %>% 
  mutate(any_collection = min(d_143615646_d_926457119, d_232343615_d_926457119, d_299553921_d_926457119, d_376960806_d_926457119, d_454453939_d_926457119, 
                              d_505347689_d_926457119, d_589588440_d_926457119, d_652357376_d_926457119, d_677469051_d_926457119, d_683613884_d_926457119, 
                              d_703954371_d_926457119, d_838567176_d_926457119, d_958646668_d_926457119, d_973670172_d_926457119,  na.rm=T),
         day_past = difftime(as.Date(any_collection), as.Date(d_678166505), units="days"),
         coll_days_diff = ifelse(as.numeric(day_past)<2,"1 Day",
                                 ifelse(as.numeric(day_past)<3,"2 Days",
                                        ifelse(as.numeric(day_past)<4,"3 Days", 
                                               ifelse(as.numeric(day_past)<5,"4 Days",
                                                      ifelse(as.numeric(day_past)>=5,">4 Days", "Missing time stamp(s)"))))))
                                  #"Missing time stamp(s)"))))))


coll_bptl_diff$Connect_ID <- as.numeric(coll_bptl_diff$`as.character(Connect_ID)`)


table.coll_bptl_28a <- ctable(coll_bptl_diff$Site,coll_bptl_diff$coll_days_diff)
crosstable.coll_bptl28a <- as.data.frame(cbind(table.coll_bptl_28a$cross_table,table.coll_bptl_28a$proportions))
crosstable.coll_bptl28a$Site <- list("Baylor Scott and White Health","HealthPartners","Henry Ford Health",
                                     "Marshfield Clinic Health System","Sanford Health","University of Chicago Medicine", "Total")

crosstable.coll_bptl28a$n_pct_1_Day <-  paste(format(crosstable.coll_bptl28a[,2],big.mark=","),"(", round(100*crosstable.coll_bptl28a[,8],1),"%)",sep=" ")
crosstable.coll_bptl28a$n_pct_2_Day <-  paste(format(crosstable.coll_bptl28a[,3],big.mark=","),"(", round(100*crosstable.coll_bptl28a[,9],1),"%)",sep=" ")
crosstable.coll_bptl28a$n_pct_3_Day <-  paste(format(crosstable.coll_bptl28a[,4],big.mark=","),"(", round(100*crosstable.coll_bptl28a[,10],1),"%)",sep=" ")
crosstable.coll_bptl28a$n_pct_4_Day <-  paste(format(crosstable.coll_bptl28a[,5],big.mark=","),"(", round(100*crosstable.coll_bptl28a[,11],1),"%)",sep=" ")
crosstable.coll_bptl28a$n_pct_4_plus_days =  paste(format(crosstable.coll_bptl28a[,1],big.mark=","),"(", round(100*crosstable.coll_bptl28a[,7],1),"%)",sep=" ")
crosstable.coll_bptl28a$Total_Pct <- paste(crosstable.coll_bptl28a$Total, " (100%)")

crosstable.coll_bptl28a <- crosstable.coll_bptl28a[,c(13:19)]


```

```{r Table28b,include=FALSE, echo=FALSE, warning=FALSE}


table.coll_bptl <- ctable(coll_bptl_diff$Site_location,coll_bptl_diff$coll_days_diff)
ctable.coll_bptl28 <- as.data.frame(cbind(table.coll_bptl$cross_table,table.coll_bptl$proportions))
ctable.coll_bptl28$UC_Sites <-trimws(rownames(ctable.coll_bptl28))

ctable.coll_bptl28$n_pct_1_Day <-  paste(format(ctable.coll_bptl28[,2],big.mark=","),"(", round(100*ctable.coll_bptl28[,8],1),"%)",sep=" ")
ctable.coll_bptl28$n_pct_2_Day <-  paste(format(ctable.coll_bptl28[,3],big.mark=","),"(", round(100*ctable.coll_bptl28[,9],1),"%)",sep=" ")
ctable.coll_bptl28$n_pct_3_Day <-  paste(format(ctable.coll_bptl28[,4],big.mark=","),"(", round(100*ctable.coll_bptl28[,10],1),"%)",sep=" ")
ctable.coll_bptl28$n_pct_4_Day <-  paste(format(ctable.coll_bptl28[,5],big.mark=","),"(", round(100*ctable.coll_bptl28[,11],1),"%)",sep=" ")
ctable.coll_bptl28$n_pct_4_plus_days =  paste(format(ctable.coll_bptl28[,1],big.mark=","),"(", round(100*ctable.coll_bptl28[,7],1),"%)",sep=" ")
ctable.coll_bptl28$Total <- paste(ctable.coll_bptl28$Total, " (100%)")
#nrow(ctable.coll_bptl28)


ctable.coll_bptl28 <- ctable.coll_bptl28[,c(13:18,6)]

colnames(ctable.coll_bptl28) <- c("Collection Location", "1 Day", "2 Days", "3 Days", "4 Day", ">4 Days", "Total Received Research Collections")

#to help shirnk this very long table
ctable.coll_bptl28 <- ctable.coll_bptl28 %>%  filter(!is.na("Collection Location"))


ctable.coll_bptl28 <- ctable.coll_bptl28 %>%
  mutate(Site_Group = case_when(
    `Collection Location` %in% c("UC-DCAM", "Ingalls Harvey", "River East", "South Loop", "UCM Pop-Up", "Orland Park", "Missing UC location") ~ "University of Chicago Medicine",
    `Collection Location` %in% c("HP Research Clinic",  "HP Park Nicollet", "Missing HP location") ~ "HealthPartners",
    `Collection Location` %in% c("Lake Hallie", "Marshfield", "MF Pop-Up", "Minocqua", "Weston", "Wisconsin Rapids", "Rice Lake", "Colby Abbotsford", "Merrill", "Stevens Point",
                                 "Neillsville", "Missing MF location") ~ "Marshfield Clinic Health System",
    `Collection Location` %in% c("Sioux Falls Imagenetics", "Fargo South University", "Edith Sanford Breast Center (coded as Sanford Center)", 
                                  "Edith Sanford Breast Center","Fargo Amber Valley","Missing SF location") ~ "Sanford Health",
    `Collection Location` %in% c("HFH K-13 Research Clinic", "HFH Livonia Research Clinic", "HFH Cancer Pavilion Research Clinic", "HFH Pop-Up", "HFH Detroit Northwest", "In-home Collection","Missing HFH location") ~ "Henry Ford Health",
    `Collection Location` %in% c("BCC- HWC","FW All Saints","BCC- Plano","BCC- Worth St","BCC- Irving","Irving","NTX Biorepository","BCC- Fort Worth", "Missing BSWH location") ~ "Baylor Scott and White",
    TRUE ~ " "
  )) 


# crosstable.coll_bptl28 <- ctable.coll_bptl28  %>%
#   gt::gt(groupname_col = "Site_Group") %>% 
#   tab_header(title = "Table 5.2: Baseline Collection-To-Receipt Time (in Days) \n Among Research Collections by Collection Location") %>% 
#   tab_footnote(footnote = paste0("At the time of reporting, ", dim(biospe_adhoc_missings)[[1]], " of the Research Collections do not have not receipt date/time information available."),
#                locations = gt::cells_title(groups = "title")) %>% 
#   gt::tab_style(style = list(gt::cell_text(weight = "bold")),
#                 locations = gt::cells_row_groups()) %>% 
#   gt::tab_style(style = list(gt::cell_text(align = "center")), 
#                 locations = gt::cells_title(groups = "title")) %>%  
#   gt::cols_width(everything() ~ gt::px(80),
#                   `Collection Location` ~ gt::px(160)) %>%  # Narrow column widths if needed  
#   gt::tab_options(table.width = "100%", # Adjust the width as needed
#     table.border.right.width = px(0),
#     #container.width = "80%",  # Ensure table container doesn't full page width
#     table.align = "left", # Ensure the table aligns to the left
#     table.font.size = "7pt")



#to help shirnk this very long table
ctable.coll_bptl28 <- ctable.coll_bptl28 %>%  filter(str_sub(.data$`Total Received Research Collections`, 1, 1) != "0")


# Separate the Total row
total_row <- ctable.coll_bptl28 %>% filter(`Collection Location` == "Total")

# Remove the Total row from the main table
rsch_coll_times <- ctable.coll_bptl28 %>%
  filter(`Collection Location` != "Total") %>%
  arrange(Site_Group, `Collection Location`)

# Append the Total row at the bottom with Site_Group = "Total"
rsch_coll_times <- bind_rows(rsch_coll_times, total_row %>% mutate(Site_Group = "Total"))


rsch_coll_times$Site_Group <- factor(rsch_coll_times$Site_Group, levels = unique(rsch_coll_times$Site_Group))

# Count occurrences of each Site_Group to ensure proper grouping
site_group_counts <- table(rsch_coll_times$Site_Group)

#colnames(rsch_coll_times)[1] <- "Collection Location"

rsch_coll_times52 <- knitr::kable(rsch_coll_times[, c(2:7)], 
             caption="Table 5.2: Baseline Collection-To-Receipt Time (in Days) Among Research Collections by Collection Location",
             col.names=c("Collection Location","1 Day","2 Days","3 Days","4 Day",">4 Days","Total Received Research Collections"),
             align=c("l","c","c","c","c","c","c"), 
             booktabs = TRUE, longtable = TRUE) %>%  
  pack_rows(index = site_group_counts) %>%  # Ensure "Total" is last
  row_spec(which(rsch_coll_times$`Collection Location` %in% names(site_group_counts)), hline_after = TRUE) %>%
  kable_styling(latex_options = "scale_down", full_width = FALSE, font_size=7) %>% 
  landscape()



```

```{r, Table29b, include=FALSE, echo=FALSE, warning=FALSE}


biospe_adhoc_2 = clinical.survey %>%  filter(d_410912345==353358909)

##To be used in the footnote to determine how many participants have missing data, if any 
#BPTL null- not used in this table, but need to understand the denominator inconsistencies
biospe_adhoc2_missings = biospe_adhoc_2 %>% filter((is.na(d_173836415_d_266600170_d_822274939) & is.na(d_173836415_d_266600170_d_139245758)) | #d_173836415_d_266600170_d_982213346
                                                  !(!is.na(d_232343615_d_926457119) | !is.na(d_299553921_d_926457119) | !is.na(d_376960806_d_926457119) |
                                                      !is.na(d_454453939_d_926457119) | !is.na(d_505347689_d_926457119) | !is.na(d_589588440_d_926457119) |
                                                      !is.na(d_652357376_d_926457119) | !is.na(d_677469051_d_926457119) | !is.na(d_683613884_d_926457119) |
                                                      !is.na(d_703954371_d_926457119) |!is.na(d_838567176_d_926457119) | !is.na(d_958646668_d_926457119) |
                                                      !is.na(d_973670172_d_926457119)))


####


biospe_adhoc2= biospe_adhoc_2 %>%  filter((!is.na(d_232343615_d_926457119) | !is.na(d_299553921_d_926457119) | !is.na(d_376960806_d_926457119) |
                                         !is.na(d_454453939_d_926457119) | !is.na(d_505347689_d_926457119) | !is.na(d_589588440_d_926457119) |
                                         !is.na(d_652357376_d_926457119) | !is.na(d_677469051_d_926457119) | !is.na(d_683613884_d_926457119) |
                                         !is.na(d_703954371_d_926457119) |!is.na(d_838567176_d_926457119) | !is.na(d_958646668_d_926457119) |
                                         !is.na(d_973670172_d_926457119)) &
                                      !is.na(Clin_Site_location) & !is.na(Site)) %>% 
  mutate(Site=droplevels(Site))

coll_bptl_diff2 <- biospe_adhoc2  %>% group_by(as.character(Connect_ID),Site, Clin_Site_location) %>% 
  mutate(any_collection = min(d_232343615_d_926457119, d_299553921_d_926457119, d_376960806_d_926457119, d_454453939_d_926457119, d_505347689_d_926457119,
                              d_589588440_d_926457119, d_652357376_d_926457119, d_677469051_d_926457119, d_683613884_d_926457119, d_703954371_d_926457119,
                              d_838567176_d_926457119, d_958646668_d_926457119, d_973670172_d_926457119, na.rm=T),
         clin_coll_bu = min(d_173836415_d_266600170_d_822274939, d_173836415_d_266600170_d_139245758, na.rm=T), #d_173836415_d_266600170_d_982213346
         day_past = difftime(as.Date(any_collection), as.Date(clin_coll_bu), units="days"),
         coll_days_diff = ifelse(as.numeric(day_past)<2,"1 Day",
                                 ifelse(as.numeric(day_past)<3,"2 Days",
                                        ifelse(as.numeric(day_past)<4,"3 Days", 
                                               ifelse(as.numeric(day_past)<5,"4 Days", 
                                                      ifelse(as.numeric(day_past)>=5,">4 Days", "Missing Time Stamp(s)"))))))
#don't know how this is happening but needs to be included for now
coll_bptl_diff2 <- coll_bptl_diff2 %>% filter(!is.na(coll_days_diff))


# biospe_adhoc2$Clin_Site_location <- factor(biospe_adhoc2$Clin_Site_location,levels=c("Macomb", "West Bloomfield", "Wyandotte","Fairlane (Dearborn)", "Plymouth", "Royal Oak", "Troy", "K1 HFH Main","Sterling Heights","Columbus", 
#                                  "Livonia","Taylor", "Ford Road", "NCO","Brownstown", "E Jefferson Pathology", "Missing HFH Location ID","Elk River", "Chanhassen","Park Nicollet Minneapolis Clinic","Brooklyn Center", "Clinic Stillwater", "New Richmond Clinic", "Missing HP location", "Kaiser Permanente Colorado","Kaiser Permanente Georgia","Oahu Clinics", "Non-Oahu Clinics", "Kaiser Permanente Northwest","Sanford Health", "South Loop","Orland Park","Kenwood","River East","Dearborn Station", "Ingalls","DCAM (Hyde Park)", "Crown Point", "Missing UC location")) 


coll_bptl_diff2$Connect_ID <- as.numeric(coll_bptl_diff2$`as.character(Connect_ID)`)
coll_bptl_diff2$coll_days_diff <- factor(coll_bptl_diff2$coll_days_diff,levels=c("1 Day","2 Days","3 Days","4 Days", ">4 Days"))


ctabs_rsch_coll_days <- coll_bptl_diff2 %>%  tabyl(Site, coll_days_diff) %>%  add_totals_and_percentages(total_position = c("both"), percentage_type = "row")










#### By Site location
rsch_coll_days <- coll_bptl_diff2 %>%  tabyl(Clin_Site_location, coll_days_diff) %>%  add_totals_and_percentages(total_position = c("both"), percentage_type = "row")
colnames(rsch_coll_days) <- c("Collection Location", "1 Day", "2 Days", "3 Days", "4 Day", ">4 Days", "Total Received Clinical Collections")

rsch_coll_days$`Collection Location`[rsch_coll_days$`Collection Location`=="Kaiser Permanente Colorado"]="KPCO"
rsch_coll_days$`Collection Location`[rsch_coll_days$`Collection Location`=="Kaiser Permanente Georgia"]="KPGA"
rsch_coll_days$`Collection Location`[rsch_coll_days$`Collection Location`=="Kaiser Permanente Hawaii"]="KPHI"
rsch_coll_days$`Collection Location`[rsch_coll_days$`Collection Location`=="Kaiser Permanente Northwest"]="KPNW"

rsch_coll_days <- rsch_coll_days %>%
  mutate(Site_Group = case_when(
    `Collection Location` %in% c("Macomb", "West Bloomfield", "Wyandotte","Fairlane (Dearborn)", "Plymouth", "Royal Oak", "Troy", "K1 HFH Main","Sterling Heights","Columbus", 
                                 "Livonia","Taylor", "Ford Road", "NCO","Brownstown", "E Jefferson Pathology", "Missing HFH location") ~ "Henry Ford Health", 
    `Collection Location` %in% c("Elk River", "Chanhassen", "Park Nicollet Minneapolis Clinic", "Brooklyn Center", "Clinic Stillwater", "New Richmond Clinic", "Missing HP location") ~ "HealthPartners", #"NSC", 
    `Collection Location`== "KPCO" ~ "Kaiser Permanente Colorado",
    `Collection Location`== "KPGA" ~ "Kaiser Permanente Georgia",
    `Collection Location` %in% c("Oahu Clinics", "Non-Oahu Clinics") ~ "Kaiser Permanente Hawaii",
    `Collection Location`== "KPNW" ~ "Kaiser Permanente Northwest",
    `Collection Location`== "Sanford Health" ~ "Sanford Health",
    `Collection Location` %in% c("South Loop","Orland Park","Kenwood","River East","Dearborn Station", "Ingalls", 
                                 "DCAM (Hyde Park)","Crown Point", "Missing UC location") ~ "University of Chicago Medicine",
    TRUE ~ " "
  )) 

crosstable.coll_bptl_2 <- rsch_coll_days  %>%
  gt::gt(groupname_col = "Site_Group") %>% 
  tab_header(title='Table 5.4: Baseline Collection-To-Receipt Time (in Days) \n Among Clinical Collections by Clinic Location') %>% 
  tab_footnote(footnote= paste0("At the time of reporting, ", dim(biospe_adhoc2_missings)[[1]], " of the Clinical Collections did not have collection and/or receipt date/time information available."),
               locations = gt::cells_column_labels(columns = "Total Received Clinical Collections")) %>% 
  gt::tab_style(style = list(gt::cell_text(weight = "bold")),
                locations = gt::cells_row_groups()) %>% 
  gt::tab_style(style = list(gt::cell_text(align = "center")), 
                locations = gt::cells_title(groups = "title")) %>%
gt::cols_width(
  `Collection Location` ~ gt::px(175), #Location Titles are by far the longest
  `Total Received Clinical Collections` ~ gt::px(80), # Totals are rather long as well
  everything() ~ gt::px(70)) %>%  
gt::tab_options(table.width = "95%", # Adjust the width as needed
  table.border.right.width = px(0),
  #container.width = "80%",  # Ensure table container doesn't full page width
  table.align = "left", # Ensure the table aligns to the left
  table.font.size = "6pt")


```




```{r SF_version_Table5.4,eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

coll_sett_all$Connect_ID <- as.numeric(coll_sett_all$Connect_ID)
table54 <- left_join(table1_4_locations, 
                     coll_sett_all[,c("Connect_ID", "Site", "d_232343615_d_926457119", "d_299553921_d_926457119", "d_376960806_d_926457119", "d_454453939_d_926457119", "d_505347689_d_926457119",
                              "d_589588440_d_926457119", "d_652357376_d_926457119", "d_677469051_d_926457119", "d_683613884_d_926457119", "d_703954371_d_926457119",
                              "d_838567176_d_926457119", "d_958646668_d_926457119", "d_973670172_d_926457119")],  by=c("Connect_ID", "Site")) 

coll_bptl_diff5_4 <- table1_4_locations  %>% group_by(as.character(Connect_ID),Site_location) %>% #Site, 
  mutate(any_collection = min(d_232343615_d_926457119, d_299553921_d_926457119, d_376960806_d_926457119, d_454453939_d_926457119, d_505347689_d_926457119,
                              d_589588440_d_926457119, d_652357376_d_926457119, d_677469051_d_926457119, d_683613884_d_926457119, d_703954371_d_926457119,
                              d_838567176_d_926457119, d_958646668_d_926457119, d_973670172_d_926457119, na.rm=T),
         clin_coll_bu = min(d_173836415_d_266600170_d_822274939, d_173836415_d_266600170_d_139245758, na.rm=T), #d_173836415_d_266600170_d_982213346
         day_past = difftime(as.Date(any_collection), as.Date(clin_coll_bu), units="days"),
         coll_days_diff = ifelse(as.numeric(day_past)<2,"1 Day",ifelse(as.numeric(day_past)<3,"2 Days",ifelse(as.numeric(day_past)<4,"3 Days", ifelse(as.numeric(day_past)<5,"4 Days", ">4 Days")))),
         coll_days_diff = factor(coll_days_diff, levels=c("1 Day","2 Days","3 Days", "4 Days", ">4 Days")))
                                                          

coll_bptl_diff5_4$Connect_ID <- as.numeric(coll_bptl_diff5_4$`as.character(Connect_ID)`)


crosstable_coll_bptl5_4 <- coll_bptl_diff5_4 %>% ungroup() 


SF_coll_rcpt <- create_tbl_cross(crosstable_coll_bptl5_4, "Site_location", "coll_days_diff", "row", "Collection Location", " ")
colnames(SF_coll_rcpt)[ncol(SF_coll_rcpt)] <- "Total Recived Clinical Collections"
colnames(SF_coll_rcpt)[1] <- "Collection Location"

```

```{r Table30, include=FALSE, echo=FALSE, warning=FALSE}


#add one decimal place, even .0 for whole numbers
format_with_decimal <- function(x, digits = 1) {
  formatted_number <- sprintf("%0.1f", x)
  return(formatted_number)
}



coll_bptl_diff <- coll_bptl_diff %>% mutate(hrs_past = difftime(as.POSIXct(ymd_hms(any_collection)), as.POSIXct(ymd_hms(d_678166505)), units="hours"))
coll_bptl_diff$hrs_past <- as.numeric(coll_bptl_diff$hrs_past)
coll_bptl_diff<- coll_bptl_diff %>%  filter(hrs_past>0)
Hrs_bptl_rsch_summ <- coll_bptl_diff %>% group_by(Site_location) %>% dplyr::summarise('Min' = format_with_decimal(min(hrs_past)),
                                                                                'Q1' = format_with_decimal(quantile(hrs_past, 0.25)),
                                                                                'Median' = format_with_decimal(median(hrs_past)),
                                                                                'Mean' = format_with_decimal(mean(hrs_past)),
                                                                                'Q3' = format_with_decimal(quantile(hrs_past, 0.75)),
                                                                                'Perc.90' = format_with_decimal(quantile(hrs_past, 0.90)),
                                                                                'Perc.98' = format_with_decimal(quantile(hrs_past, 0.98)))



colnames(Hrs_bptl_rsch_summ)[1] <- "Collection Location"

Hrs_bptl_rsch_summ <- Hrs_bptl_rsch_summ %>%
  mutate(Site_Group = case_when(
    `Collection Location` %in% c("UC-DCAM", "Ingalls Harvey", "River East", "South Loop", "UCM Pop-Up", "Orland Park", "Missing UC location") ~ "University of Chicago Medicine",
    `Collection Location` %in% c("HP Research Clinic",  "HP Park Nicollet", "Missing HP location") ~ "HealthPartners",
    `Collection Location` %in% c("Lake Hallie", "Marshfield", "MF Pop-Up", "Minocqua", "Weston", "Wisconsin Rapids", "Rice Lake", "Colby Abbotsford", "Merrill", "Stevens Point",
                                 "Neillsville", "Missing MF location") ~ "Marshfield Clinic Health System",
    `Collection Location` %in% c("Sioux Falls Imagenetics", "Edith Sanford Breast Center (coded as Sanford Center)", 
                                  "Edith Sanford Breast Center","Fargo Amber Valley","Fargo South University", "Missing SF location") ~ "Sanford Health",
    `Collection Location` %in% c("HFH K-13 Research Clinic", "HFH Livonia Research Clinic", "HFH Cancer Pavilion Research Clinic", "HFH Pop-Up", "HFH Detroit Northwest","In-home Collection","Missing HFH location") ~ "Henry Ford Health",
    `Collection Location` %in% c("BCC- HWC","FW All Saints","BCC- Plano","BCC- Worth St","BCC- Irving","Irving","NTX Biorepository","BCC- Fort Worth", "Missing BSWH location") ~ "Baylor Scott and White",
    TRUE ~ " "
  )) 

#Footnote, if any data missing
footnote5.5 <- coll_bptl_diff %>% filter(is.na(any_collection) | is.na(d_678166505))


# Hrs_bptl_rsch <- Hrs_bptl_rsch_summ  %>%
#   gt::gt(groupname_col = "Site_Group") %>% 
#   tab_header('Table 5.5: Baseline- Time (in Hours) from Research Collection to Receipt by Collection Location') %>% 
#   tab_footnote(footnote= "Note: BPTL receipt time is assumed to be 11:30am ET.",
#                locations = gt::cells_title(groups = "title")) %>% 
#   gt::tab_style(style = list(gt::cell_text(weight = "bold")),
#                 locations = gt::cells_row_groups()) %>% 
#   gt::tab_options(table.width = "100%", table.align = "left", table.font.size = px(7))

hrs_rsch_55 <- Hrs_bptl_rsch_summ %>%
  arrange(Site_Group, `Collection Location`)


hrs_rsch_55$Site_Group <- factor(hrs_rsch_55$Site_Group, levels = unique(hrs_rsch_55$Site_Group))

# Count occurrences of each Site_Group to ensure proper grouping
site_group_counts <- table(hrs_rsch_55$Site_Group)


knit_hrs_rsch_55 <- knitr::kable(hrs_rsch_55[, c(1:8)], 
             caption='Table 5.5: Baseline- Time (in Hours) from Research Collection to Receipt by Collection Location',
             align=c("l","c","c","c","c","c","c","c"), 
             booktabs = TRUE, longtable = TRUE) %>%  
  pack_rows(index = site_group_counts) %>% 
  kable_styling(latex_options = "scale_down", full_width = FALSE, font_size=7) %>% 
  landscape()





```


```{r Table31, include=FALSE, echo=FALSE, warning=FALSE}

coll_bptl_diff2 <- coll_bptl_diff2 %>% mutate(hrs_past = difftime(as.POSIXct(ymd_hms(any_collection)), as.POSIXct(ymd_hms(clin_coll_bu)), units="hours"))
coll_bptl_diff2$hrs_past <- as.numeric(coll_bptl_diff2$hrs_past)
Hrs_bptl_clin_summ <- coll_bptl_diff2 %>% group_by(Clin_Site_location) %>% dplyr::summarise('Min' = format_with_decimal(min(hrs_past, na.rm=T)),
                                                                                  'Q1' = format_with_decimal(quantile(hrs_past, 0.25, na.rm=T)),
                                                                                  'Median' = format_with_decimal(median(hrs_past, na.rm=T)),
                                                                                  'Mean' = format_with_decimal(mean(hrs_past, na.rm=T)),
                                                                                  'Q3' = format_with_decimal(quantile(hrs_past, 0.75, na.rm=T)),
                                                                                  'Perc.90' = format_with_decimal(quantile(hrs_past, 0.9, na.rm=T)),
                                                                                  'Perc.98' = format_with_decimal(quantile(hrs_past, 0.98, na.rm=T)))

colnames(Hrs_bptl_clin_summ)[1] <- "Collection Location"

Hrs_bptl_clin_summ <- Hrs_bptl_clin_summ %>%
  mutate(Site_Group = case_when(
    `Collection Location` %in% c("Macomb", "West Bloomfield", "Wyandotte","Fairlane (Dearborn)", "Plymouth", "Royal Oak", "Troy", "K1 HFH Main","Sterling Heights","Columbus", 
                                 "Livonia","Taylor", "Ford Road", "NCO","Brownstown", "E Jefferson Pathology", "Missing HFH location") ~ "Henry Ford Health", 
    `Collection Location` %in% c("Elk River", "Chanhassen", "Park Nicollet Minneapolis Clinic", "Brooklyn Center", "Clinic Stillwater", "New Richmond Clinic", "Missing HP location") ~ "HealthPartners", #"NSC", 
    `Collection Location`== "Kaiser Permanente Colorado" ~ "Kaiser Permanente Colorado",
    `Collection Location`== "Kaiser Permanente Georgia" ~ "Kaiser Permanente Georgia",
    `Collection Location` %in% c("Oahu Clinics", "Non-Oahu Clinics") ~ "Kaiser Permanente Hawaii",
    `Collection Location`== "Kaiser Permanente Northwest" ~ "Kaiser Permanente Northwest",
    `Collection Location`== "Sanford Health" ~ "Sanford Health",
    `Collection Location` %in% c("South Loop","Orland Park","Kenwood","River East","Dearborn Station", "Ingalls", 
                                 "DCAM (Hyde Park)","Crown Point", "Missing UC location") ~ "University of Chicago Medicine",
    TRUE ~ " "
  )) 

#Footnote, if any data missing
footnote5.5 <- coll_bptl_diff2 %>% filter(is.na(any_collection) | is.na(clin_coll_bu))

Hrs_bptl_clin <- Hrs_bptl_clin_summ  %>%
  gt::gt(groupname_col = "Site_Group") %>% 
  tab_header('Table 5.6: Baseline- Time (in Hours) from Clinical Collection to Receipt by Clinic Location')  %>% 
  gt::tab_style(style = list(gt::cell_text(weight = "bold")),
                locations = gt::cells_row_groups()) %>% 
  gt::tab_options(table.width = "90%", table.align = "left", table.font.size = "smaller")
  #tab_footnote(footnote= paste0('Table 5.6: Baseline- Time (in Hours) from Clinical Collection to Receipt by Clinic Location'),
               #locations = gt::cells_column_labels(columns = "Total Received Clinical Collections"))


```



```{r SF_table5_6, include=FALSE, echo=FALSE, warning=FALSE}

coll_bptl_diff5_4 <- coll_bptl_diff5_4 %>% mutate(hrs_past = difftime(as.POSIXct(ymd_hms(any_collection)), as.POSIXct(ymd_hms(clin_coll_bu)), units="hours"))
coll_bptl_diff5_4$hrs_past <- as.numeric(coll_bptl_diff5_4$hrs_past)
Hrs_bptl_clinSF <- coll_bptl_diff5_4 %>% group_by(Site_location) %>% dplyr::summarise('Min' = format_with_decimal(min(hrs_past, na.rm=T)),
                                                                                      'Q1' = format_with_decimal(quantile(hrs_past, 0.25, na.rm=T)),
                                                                                      'Median' = format_with_decimal(median(hrs_past, na.rm=T)),
                                                                                      'Mean' = format_with_decimal(mean(hrs_past, na.rm=T)),
                                                                                      'Q3' = format_with_decimal(quantile(hrs_past, 0.75, na.rm=T)),
                                                                                      '90' = format_with_decimal(quantile(hrs_past, 0.9, na.rm=T)),
                                                                                      '98' = format_with_decimal(quantile(hrs_past, 0.98, na.rm=T)))

```


```{r Figures20_23, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}
clinical.survey_specs <- clinical.survey %>%   group_by(Connect_ID, Site) %>% 
  mutate(bldcol_max = max(bldcol),
         Urine_col_max= max(Urine_col)) %>% 
  ungroup()

clc.bothtm <- c("d_173836415_d_266600170_d_139245758","d_173836415_d_266600170_d_224596428","d_173836415_d_266600170_d_541311218","d_173836415_d_266600170_d_939818935","d_173836415_d_266600170_d_769615780",
                "d_173836415_d_266600170_d_822274939","d_173836415_d_266600170_d_398645039","d_173836415_d_266600170_d_982213346")
dd[grepl("139245758|224596428|541311218|939818935|769615780|822274939|398645039|982213346",dd$CID),]

clc.both.vt <- clinical.survey_specs[,c("Connect_ID","Site","bldcol_max","Urine_col_max","collection.tm",clc.bothtm)]
clc.both.vt$both.startdate <- min(ymd_hms(clc.both.vt$d_173836415_d_266600170_d_139245758), ymd_hms(clc.both.vt$d_173836415_d_266600170_d_982213346),na.rm=TRUE) #as.POSIXct()

clc.both.vt <- clc.both.vt %>%
  mutate(bldcol.time = case_when(bldcol_max >0 ~ pmin(as.POSIXct(d_173836415_d_266600170_d_982213346),as.POSIXct(d_173836415_d_266600170_d_398645039),as.POSIXct(d_173836415_d_266600170_d_822274939),na.rm=TRUE)),
         urine.time = case_when(Urine_col_max >0 ~ pmin(as.POSIXct(d_173836415_d_266600170_d_139245758),as.POSIXct(d_173836415_d_266600170_d_541311218),as.POSIXct(d_173836415_d_266600170_d_224596428),na.rm=TRUE)),
         BU.time =  pmin(as.POSIXct(bldcol.time),as.POSIXct(urine.time), na.rm = TRUE)) ## matches up exactly with operations code



clc.both.vt$BU.Sunday.week <- ceiling(as.numeric(difftime(clc.both.vt$BU.time,as.Date(veristart.date-days(2)),units="days"))/7)

clc.both.vt$BU.Sunday.date <- veristart.date + days(5)+dweeks(clc.both.vt$BU.Sunday.week -1) #veristart is 7/27, but that's a tueaday. Add 5 days to make it Sunday, then subtract a week to make it the start of that previous week
clc.both.vt$Monday.date.start <- clc.both.vt$BU.Sunday.date-days(6)


clc.both.vt.KP <- clc.both.vt %>% filter(Monday.date.start>=as.Date("2023-01-30") & BU.Sunday.date < currentDate)
clc.both.vt.CO <- clc.both.vt.KP %>%  filter(clc.both.vt.KP$Site=="Kaiser Permanente Colorado")
clc.both.vt.GA <- clc.both.vt.KP %>%  filter(clc.both.vt.KP$Site=="Kaiser Permanente Georgia")
clc.both.vt.HI <- clc.both.vt.KP %>%  filter(clc.both.vt.KP$Site=="Kaiser Permanente Hawaii")
clc.both.vt.NW <- clc.both.vt.KP %>%  filter(clc.both.vt.KP$Site=="Kaiser Permanente Northwest")



clc.both.wk_site.CO <- clc.both.vt.CO %>% arrange(Site,BU.Sunday.week,Monday.date.start) %>% group_by(Site,BU.Sunday.week,Monday.date.start) %>% tally()


clc_both_vt.site.CO<- clc.both.wk_site.CO  %>% ggplot( aes(x=as_date(clc.both.wk_site.CO$Monday.date.start), y=n)) +
  geom_line() +
  geom_point(width = 0.2) +
  scale_y_continuous(name="Number of Collections") +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "4 weeks", limits=c( as.Date("2023-01-16"),as.Date(Sys.Date())-7),expand=c(0,0))  +
  scale_fill_brewer(palette="Dark2") +

  ggtitle(label="Figure 6.18: Baseline- Weekly Biospecimen Collections,  \n Kaiser Permanente Colorado") +
  theme(panel.background = element_blank(),
        legend.title = element_text(size=7),
        axis.line = element_line(size=0.2),
        axis.text.x = element_text(angle=60, hjust = 1,size = 8, face = "bold"),
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold"))

clc_both_vt.site.CO





clc.both.wk_site.GA <- clc.both.vt.GA %>% arrange(Site,BU.Sunday.week,Monday.date.start) %>% group_by(Site,BU.Sunday.week,Monday.date.start) %>% tally()

clc_both_vt.site.GA<- clc.both.wk_site.GA  %>% ggplot( aes(x=as_date(clc.both.wk_site.GA$Monday.date.start), y=n)) +
  geom_line() +
  geom_point(width = 0.2) +
  scale_y_continuous(name="Number of Collections") +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "4 weeks", limits=c( as.Date("2023-01-16"),as.Date(currentDate)-7),expand=c(0,0))  +
  scale_fill_brewer(palette="Dark2") +
  ggtitle(label="Figure 6.19: Baseline- Weekly Biospecimen Collections,  \n Kaiser Permanente Georgia") +
  theme(panel.background = element_blank(),
        legend.title = element_text(size=7),
        axis.line = element_line(size=0.2),
        axis.text.x = element_text(angle=60, hjust = 1,size = 8, face = "bold"),
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold"))

clc_both_vt.site.GA





clc.both.wk_site.HI <- clc.both.vt.HI %>% arrange(Site,BU.Sunday.week,Monday.date.start) %>% group_by(Site,BU.Sunday.week,Monday.date.start) %>% tally()

clc_both_vt.site.HI<- clc.both.wk_site.HI %>% ggplot( aes(x=as_date(clc.both.wk_site.HI$Monday.date.start), y=n)) +
  geom_line() +
  geom_point(width = 0.2) +
  scale_y_continuous(name="Number of Collections") +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "4 weeks", limits=c( as.Date("2023-01-16"),as.Date(currentDate)-7),expand=c(0,0))  +
  ggtitle(label="Figure 6.20: Baseline- Weekly Biospecimen Collections, \n Kaiser Permanente Hawaii") +
  theme(panel.background = element_blank(),
        legend.title = element_text(size=7),
        axis.line = element_line(size=0.2),
        axis.text.x = element_text(angle=60, hjust = 1,size = 8, face = "bold"),
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold"))

clc_both_vt.site.HI





clc.both.wk_site.NW <- clc.both.vt.NW %>% arrange(Site,BU.Sunday.week,Monday.date.start) %>% group_by(Site,BU.Sunday.week,Monday.date.start) %>% tally()

clc_both_vt.site.NW<- clc.both.wk_site.NW  %>% ggplot( aes(x=as_date(clc.both.wk_site.NW$Monday.date.start), y=n)) +
  geom_line() +
  geom_point(width = 0.2) +
  scale_y_continuous(name="Number of Collections") + #, limits=c(0,5)) +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "4 weeks", limits=c( as.Date("2023-01-16"),as.Date(currentDate)-7),expand=c(0,0))  +
  ggtitle(label="Figure 6.21: Baseline- Weekly Biospecimen Collections,  \n Kaiser Permanente Northwest") +
  theme(panel.background = element_blank(),
        legend.title = element_text(size=7),
        axis.line = element_line(size=0.2),
        axis.text.x = element_text(angle=60, hjust = 1,size = 8, face = "bold"),
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold"))

clc_both_vt.site.NW

```




```{r Figures4, include=FALSE, echo=FALSE, warning=FALSE, eval=TRUE}

research.survey<- research.survey %>% mutate(#weekday = weekdays(ymd_hms(collection.tm)),
  schedulecol.tm =min(as.POSIXct(ymd_hms(d_678166505))),
  #start.date = min(schedulecol.tm),
  current.date=max(as.POSIXct(ymd_hms(schedulecol.tm))),
  BioRec_CollectScheduled = ifelse(as.Date(ymd_hms(schedulecol.tm)) >= as.Date(as.POSIXct(ymd_hms(d_914594314))),1,0))


##HF
fig4_sub_all <- research.survey %>%  filter(Site=="Henry Ford Health") # | Site=="Sanford Health" | Site=="University of Chicago Medicine")
fig4_sub_all <- fig4_sub_all %>%  filter((d_684635302 == 353358909 | d_878865966 == 353358909| d_167958071 == 353358909) & !is.na(checktmvisit)) # & d_222161762<as.Date("2023-07-05")

fig4_sub_all$Site<- droplevels(fig4_sub_all$Site)



fig4_sub_1<- fig4_sub_all %>% mutate(hours3 = case_when(checktmvisit=="0 hrs to 3 hrs"~1,
                                                        TRUE~0))

visit_wk_site4 <- fig4_sub_1 %>%
  group_by(Site, col.Monday.date) %>%
  summarise(
    n = sum(!is.na(checktmvisit)),
    hours3 = sum(hours3),
    pct3 = 100*round(hours3/n, digits=2)
  ) %>%
  ungroup()

research.4_1 <- ggplot(visit_wk_site4, aes(x=as.Date(col.Monday.date), y=pct3)) +
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="Percent %",breaks=seq(0,100,25)) +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-1),expand=c(0,0))  +
  scale_fill_brewer(palette="Dark2") +

  ggtitle(label="Figure 3.3: Baseline- Weekly Percent of Biospecimen Surveys Submitted within 3 Hours of \n Research Collection Visit Check In, Henry Ford Health  ") +
  theme(panel.background = element_blank(),
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14, face = "bold") ,
        axis.title.y = element_text(size = 14, face = "bold",color="black"),
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold"))





##Sanford
fig4_sub_all <- research.survey %>%  filter(Site=="Sanford Health") # | Site=="Sanford Health" | Site=="University of Chicago Medicine")
fig4_sub_all <- fig4_sub_all %>%  filter((d_684635302 == 353358909 | d_878865966 == 353358909| d_167958071 == 353358909) & !is.na(checktmvisit)) # & d_222161762<as.Date("2023-07-05")

fig4_sub_all$Site<- droplevels(fig4_sub_all$Site)

fig4_sub_1<- fig4_sub_all %>% mutate(hours3 = case_when(checktmvisit=="0 hrs to 3 hrs"~1,
                                                        TRUE~0))
visit_wk_site4__2 <- fig4_sub_1 %>%
  group_by(Site, col.Monday.date) %>%
  summarise(
    n = sum(!is.na(checktmvisit)),
    hours3 = sum(hours3),
    pct3 = 100*round(hours3/n, digits=2)
  ) %>%
  ungroup()




research.4_2 <- ggplot(visit_wk_site4__2, aes(x=as.Date(col.Monday.date), y=pct3)) + #, color=Site)) + #,fill=Site, color=Site)) +
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="Percent %",breaks=seq(0,100,25)) +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-1),expand=c(0,0))  +
  scale_fill_brewer(palette="Dark2") +
  ggtitle(label="Figure 3.4: Baseline- Weekly Percent of Biospecimen Surveys Submitted within 3 Hours of \n Research Collection Visit Check In, Sanford Health") +
  theme(panel.background = element_blank(),
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14, face = "bold") ,
        axis.title.y = element_text(size = 14, face = "bold",color="black"),
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold"))





##UC
fig4_sub_all <- research.survey %>%  filter(Site=="University of Chicago Medicine") # | Site=="Sanford Health" | Site=="University of Chicago Medicine")
fig4_sub_all <- fig4_sub_all %>%  filter((d_684635302 == 353358909 | d_878865966 == 353358909| d_167958071 == 353358909) & !is.na(checktmvisit)) # & d_222161762<as.Date("2023-07-05")

fig4_sub_all$Site<- droplevels(fig4_sub_all$Site)


fig4_sub_1<- fig4_sub_all %>% mutate(hours3 = case_when(checktmvisit=="0 hrs to 3 hrs"~1,
                                                        TRUE~0))
visit_wk_site4__3 <- fig4_sub_1 %>%
  group_by(Site, col.Monday.date) %>%
  summarise(
    n = sum(!is.na(checktmvisit)),
    hours3 = sum(hours3),
    pct3 = 100*round(hours3/n, digits=2)
  ) %>%
  ungroup()


research.4_3 <- ggplot(visit_wk_site4__3, aes(x=as.Date(col.Monday.date), pct3)) + #, color=Site)) + #,fill=Site, color=Site)) +
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="Percent %",breaks=seq(0,100,25)) +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-1),expand=c(0,0))  +
  scale_fill_brewer(palette="Dark2") +
  ggtitle(label="Figure 3.5: Baseline- Weekly Percent of Biospecimen Surveys Submitted within 3 Hours of \n Research Collection Visit Check In, University of Chicago Medicine") +
  theme(panel.background = element_blank(),
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14, face = "bold") ,
        axis.title.y = element_text(size = 14, face = "bold",color="black"),
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold"))
```













\newpage

# Baseline Collection Counts 
\vspace{-0.5em}
\FloatBarrier
```{r KnitrTables1, eval=TRUE,echo=FALSE,error=FALSE, message=FALSE, warning=FALSE, results='asis'}
options(knitr.table.format = "latex")
options(kableExtra.auto_format = FALSE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 


biospe.t1  %>% kable_styling(latex_options = "scale_down")


settings_breakdown
  
```
\FloatBarrier
```{r KnitrTables1.3, eval=TRUE,echo=FALSE,error=FALSE, message=FALSE,warning=FALSE,results='asis'}
# options(knitr.table.format = "latex")
# options(kableExtra.auto_format = FALSE)
# knitr::opts_chunk$set(warning = FALSE, message = FALSE) 


col_num_1.1_gt 

```
\newpage
\FloatBarrier
```{r KnitrTables1.4, eval=TRUE,echo=FALSE,error=FALSE, message=FALSE,warning=FALSE,results='asis'}

col_num_1.2_gt 
```

\FloatBarrier
```{r KnitrTables1.5, eval=TRUE,echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, results='asis'}

add_footnote(SF_collections_tbl, 

             paste0("This table reflects Clincal Collections in the past 30 days; the total number of Clinical Collections at Sanford Health is ",
                    dim(table1_4_locations)[[1]]),
             notation = "none")

add_footnote(SF_top10_collections,footnote_text, notation= "none") 
# paste0("This table reflects Clincal Collections at the top collection locations in each region. The total number of Clinical Collections in each region are as follows: Bemidji: ", Be_count,"; Bismarck: ", Bi_count, "; Fargo: ", F_count, "; Sioux Falls: ", S_count, "."), notation = "none")


```
\FloatBarrier
```{r KnitrTables1.7, eval=TRUE,echo=FALSE,error=FALSE, message=FALSE, warning=FALSE, results='asis'}
biospe.bld #%>% kable_styling(latex_options = "scale_down")
```

\FloatBarrier
```{r KnitrTables1.8, eval=TRUE,echo=FALSE,warning=FALSE, message=FALSE, results='asis'}

tab5=knitr::kable(distrb_allsetts_with_totals, 
                  #col.names=c("Collection Setting","Any Blood Collected", "Urine Collected", "Mouthwash Collected"), 
                  caption='Table 1.8: Baseline Collection Setting Among Biospecimen Collections by Specimen Type', 
                  row.names=FALSE, align=c("l","c","c","c"), format.args = list(big.mark = ","), booktabs = TRUE)   
add_footnote(tab5, "Note: Blood and urine specimens are not collected in the Home setting, and mouthwash specimens are not collected in the Clinical setting.", 
             notation = "none")

```

\FloatBarrier
```{r KnitrTables1.9, eval=TRUE,echo=FALSE,warning=FALSE, message=FALSE, results='asis'}
tab5_1=knitr::kable(site_results["Henry Ford Health"], 
                    col.names=c("Collection Setting","Any Blood Collected", "Urine Collected", "Mouthwash Collected"), 
                    caption='Table 1.9: Baseline Collection Setting Among Biospecimen Collections by Specimen Type, Henry Ford Health', 
                    row.names=FALSE, align=c("l","c","c","c"), format.args = list(big.mark = ","), booktabs = TRUE)   
add_footnote(tab5_1, "Note: Blood and urine specimens are not collected in the Home setting, and mouthwash specimens are not collected in the Clinical setting.", 
             notation = "none")
```

\FloatBarrier
```{r KnitrTables1.10, eval=TRUE,echo=FALSE,warning=FALSE, message=FALSE, results='asis'}
tab5_2=knitr::kable(site_results["HealthPartners"], 
                    col.names=c("Collection Setting","Any Blood Collected", "Urine Collected", "Mouthwash Collected"), 
                    caption='Table 1.10: Baseline Collection Setting Among Biospecimen Collections by Specimen Type, HealthPartners', 
                    row.names=FALSE, align=c("l","c","c","c"), format.args = list(big.mark = ","), booktabs = TRUE)   
add_footnote(tab5_2, "Note: Blood and urine specimens are not collected in the Home setting, and mouthwash specimens are not collected in the Clinical setting.", 
             notation = "none")
```

\FloatBarrier
```{r KnitrTables1.11, eval=TRUE,echo=FALSE,warning=FALSE, message=FALSE, results='asis'}

tab5_3=knitr::kable(site_results["Sanford Health"], 
                    col.names=c("Collection Setting","Any Blood Collected", "Urine Collected", "Mouthwash Collected"), 
                    caption='Table 1.11: Baseline Collection Setting Among Biospecimen Collections by Specimen Type, Sanford Health', 
                    row.names=FALSE, align=c("l","c","c","c"), format.args = list(big.mark = ","), booktabs = TRUE)
add_footnote(tab5_3, "Note: Blood and urine specimens are not collected in the Home setting, and mouthwash specimens are not collected in the Clinical setting.", 
             notation = "none")
```

\FloatBarrier
```{r KnitrTables1.12, eval=TRUE,echo=FALSE,warning=FALSE, message=FALSE, results='asis'}

tab5_4=knitr::kable(site_results["University of Chicago Medicine"], 
                    col.names=c("Collection Setting","Any Blood Collected", "Urine Collected", "Mouthwash Collected"), 
                    caption='Table 1.12: Baseline Collection Setting Among Biospecimen Collections by Specimen Type, University of Chicago Medicine', 
                    row.names=FALSE, align=c("l","c","c","c"), format.args = list(big.mark = ","), booktabs = TRUE)
add_footnote(tab5_4, "Note: Blood and urine specimens are not collected in the Home setting, and mouthwash specimens are not collected in the Clinical setting.", 
             notation = "none")
```

\FloatBarrier
```{r KnitrTables1.13, eval=TRUE,echo=FALSE,warning=FALSE, message=FALSE, results='asis'}
#Change from 1.8 to 1.9
Bld_urn_cli = knitr::kable(system_coll, 
                           caption='Table 1.13: Baseline- Data System Status Among Clinical Biospecimen Collections by Specimen Type', 
                           row.names=FALSE,align=c("l","c","c"), booktabs = TRUE) %>%  
  kable_styling(latex_options = "scale_down") #"HOLD_position"
add_footnote(Bld_urn_cli, "Note: Site data may be available up to 48 hours later than Biospecimen Dashboard data. 'Site Data Only' is assumed to be '0 (0%)' when not listed.", 
             notation = "none")
```



\FloatBarrier
```{r KnitrTables1.14_1.16, eval=TRUE,echo=FALSE,warning=FALSE, message=FALSE, results='asis'}

BLCol_by_Sex 

BLCol_by_Age 

BLCol_by_Race

```



\FloatBarrier
\newpage
\newpage
# Baseline Collection Completeness
\vspace{-0.5em}
\FloatBarrier

```{r KnitrTables5, eval=TRUE,echo=FALSE,error=FALSE, message=FALSE, warning=FALSE, results='asis'}



knitr::kable(spec_by_site_R , 
             caption='Table 2.1: Baseline Research Biospecimen Collection Completeness by Specimen Type', 
             row.names=FALSE,align=c("l","c","c","c","c","c","c"), booktabs = TRUE)  %>% 
  kable_styling(latex_options = "scale_down")




knitr::kable(spec_by_site_C, 
             caption='Table 2.2: Baseline Clinical Biospecimen Collection Completeness by Specimen Type', 
             row.names=FALSE,align=c("l","c","c","c","c","c","c","c","c","c"), booktabs = TRUE)  %>% 
  kable_styling(latex_options = "scale_down") 


```






```{r KnitrTables6_7.1,echo=FALSE,error=FALSE,message=FALSE, warning=FALSE, results='asis'}

knitr::kable(bldcol_research1, 
             col.names=c("Site","All Blood Collected","Partial Blood Collected","No Blood Collected","Total Research Collections"), 
             caption='Table 2.3: Baseline Blood Collection Completeness Among Research Biospecimen Collections', 
             row.names=FALSE, align=c("l","c","c","c","c"), booktabs = TRUE) %>% 
  kable_styling(latex_options = "scale_down")


knitr::kable(bldcol_research_UC1, 
             col.names=c("Collection Location","All Blood Collected","Partial Blood Collected","No Blood Collected","Total Research Collections"), 
             caption='Table 2.4: Baseline Blood Collection Completeness Among Research Collections by Collection Location, University of Chicago Medicine', 
             row.names=FALSE, align=c("l","c","c","c","c"), booktabs = TRUE) %>% 
  kable_styling(latex_options = "scale_down")
```

\FloatBarrier
```{r Figure1, eval=TRUE,echo=FALSE, warning=FALSE}

Inc_bld_UC <- tube_research_UC %>%  select(Connect_ID, Site_location, bld.complt)
Inc_bld_UC$Connect_ID <- as.numeric(Inc_bld_UC$Connect_ID)
research.survey$Connect_ID <- as.numeric(research.survey$Connect_ID)
fig1_UC <- left_join(research.survey, Inc_bld_UC, by="Connect_ID")

fig1_UC_inc <- fig1_UC %>%  filter(Site=="University of Chicago Medicine")


help_fig1 <- fig1_UC_inc %>% select(col.Monday.date, bld.complt) %>%  # %>%  filter(bld.complt=="BloodIncomplet" | bld.complt=="NoBlood")
  mutate(#incomp_blood = case_when(bld.complt=="BloodIncomplet"~"Partial Blood",
    #bld.complt=="NoBlood" ~"No Blood"))
    partial_blood= case_when(bld.complt=="BloodIncomplet"~1,
                             TRUE ~0),
    no_blood=case_when(bld.complt=="NoBlood"~1,
                       TRUE ~0))




help_fig1 <- help_fig1 %>% mutate(all_blood=case_when(!is.na(partial_blood) & !is.na(no_blood) ~ 1, TRUE ~ 0)) #all participants per week
#all_blood=case_when(incomp_blood=="Partial Blood" | incomp_blood=="No Blood" ~1,TRUE ~ 0))


help2_1_fig1 <- help_fig1 %>%  group_by(col.Monday.date,  partial_blood, no_blood, all_blood) #%>%  tally()

help2_1_fig1 <- help2_1_fig1 %>%  mutate(incomp_blood = case_when( (partial_blood==1 |no_blood==1) ~1,
                                                                   TRUE ~ 0))

help2_1_fig1_inc <- help2_1_fig1 %>%  select(col.Monday.date,  partial_blood, no_blood, all_blood, incomp_blood) %>%  group_by(col.Monday.date)


final_fig1_table <- help2_1_fig1_inc %>%  group_by(col.Monday.date) %>%  dplyr::summarize( incomplete=sum(incomp_blood),
                                                                                           partial=sum(partial_blood),
                                                                                           none_blood=sum(no_blood),
                                                                                           all_collections=sum(all_blood),
                                                                                           All_Incomplete=100*(incomplete/all_collections),
                                                                                           Partial__Blood=100*(partial/all_collections),
                                                                                           No__Blood=100*(none_blood/all_collections))


research.1_1 <- ggplot() +
  geom_line(data = final_fig1_table, aes(x = as.Date(col.Monday.date), y = All_Incomplete, color = "All_Incomplete"), na.rm = TRUE) +
  geom_line(data = final_fig1_table, aes(x = as.Date(col.Monday.date), y = Partial__Blood, color = "Partial__Blood"), na.rm = TRUE) +
  geom_line(data = final_fig1_table, aes(x = as.Date(col.Monday.date), y = No__Blood, color = "No__Blood"), na.rm = TRUE) +
  geom_point(width = 0.2) +
  scale_y_continuous(name = "Percent %", limits = c(0, 100), expand = c(0, 0), breaks = seq(0, 100, 25)) +
  scale_x_date(name = "Date", date_labels = "%y-%m-%d", date_breaks = "2 weeks",
               limits = c(as.Date("2022-06-20"), (as.Date(currentDate) - 1)), expand = c(0, 0))  +
  scale_color_manual(name = "Incompletion Level",
                     values = c("All_Incomplete" = "#FDBE19", "No__Blood" = "#3C989E", "Partial__Blood" = "#164C71"),
                     labels = c("Total","No Blood",  "Partial Blood"),
                     guide = guide_legend(nrow = 2, byrow = TRUE)) +
  ggtitle(label = "Figure 2.1: Baseline- Weekly Percent of Incomplete Blood Collections, \n University of Chicago Medicine") +
  theme(panel.background = element_blank(),
        legend.position = "bottom",
        axis.line = element_line(size = 0.2),
        axis.text.x = element_text(angle = 60, hjust = 1),
        axis.title.x = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 14, face = "bold", color = "black"),
        plot.title = element_text(hjust = 0.5, size = 12, face = "bold")) +
  labs(caption = "Note: NCI notified UChicago of incomplete blood draws on January 26, 2023.") +
  theme(plot.caption = element_text(hjust = 0))

research.1_1


```

```{r KnitrTables2.5,echo=FALSE,error=FALSE,message=FALSE, warning=FALSE, results='asis'}


knitr::kable(bldcol_research_HF1, 
             col.names=c("Collection Location","All Blood Collected","Partial Blood Collected","No Blood Collected","Total Research Collections"), 
             caption='Table 2.5: Baseline Blood Collection Completeness Among Research Collections \n by Collection Location, Henry Ford Health', 
             row.names=FALSE, align=c("l","c","c","c","c"), booktabs = TRUE) %>% 
  kable_styling(latex_options = "scale_down")
```

\FloatBarrier
```{r Figure2, eval=TRUE,echo=FALSE, warning=FALSE}


Inc_bld_HF <- tube_research_HF %>%  select(Connect_ID, Site_location, bld.complt)
Inc_bld_HF$Connect_ID <- as.numeric(Inc_bld_HF$Connect_ID)
research.survey$Connect_ID <- as.numeric(research.survey$Connect_ID)
fig2_HF <- left_join(research.survey, Inc_bld_HF, by="Connect_ID")

fig2_HF_inc <- fig2_HF %>%  filter(Site=="Henry Ford Health")


help_fig2 <- fig2_HF_inc %>% select(col.Monday.date, bld.complt) %>%  # %>%  filter(bld.complt=="BloodIncomplet" | bld.complt=="NoBlood")
  mutate(#incomp_blood = case_when(bld.complt=="BloodIncomplet"~"Partial Blood",
    #bld.complt=="NoBlood" ~"No Blood"))
    partial_blood= case_when(bld.complt=="BloodIncomplet"~1,
                             TRUE ~0),
    no_blood=case_when(bld.complt=="NoBlood"~1,
                       TRUE ~0))


help_fig2 <- help_fig2 %>% mutate(all_blood=case_when(!is.na(partial_blood) & !is.na(no_blood) ~ 1, TRUE ~ 0)) #all participants per week


help2_1_fig2 <- help_fig2 %>%  group_by(col.Monday.date,  partial_blood, no_blood, all_blood) #%>%  tally()

help2_1_fig2 <- help2_1_fig2 %>%  mutate(incomp_blood = case_when( (partial_blood==1 |no_blood==1) ~1,
                                                                   TRUE ~ 0))

help2_1_fig2_inc <- help2_1_fig2 %>%  select(col.Monday.date,  partial_blood, no_blood, all_blood, incomp_blood) %>%  group_by(col.Monday.date)

final_fig2_table <- help2_1_fig2_inc %>%  group_by(col.Monday.date) %>% dplyr::summarize( incomplete=sum(incomp_blood),
                                                                                          partial=sum(partial_blood),
                                                                                          none_blood=sum(no_blood),
                                                                                          all_collections=sum(all_blood),
                                                                                          All_Incomplete=100*(incomplete/all_collections),
                                                                                          Partial__Blood=100*(partial/all_collections),
                                                                                          No__Blood=100*(none_blood/all_collections))

research.1_2 <- ggplot() + #, color=UC_Sites) + #,fill=Site, color=Site)) +
  geom_line(data=final_fig2_table, aes(x=as.Date(col.Monday.date), y=All_Incomplete, colour="All_Incomplete"),na.rm=T) +
  geom_line(data=final_fig2_table, aes(x=as.Date(col.Monday.date), y=Partial__Blood, colour="Partial__Blood"), na.rm=T) +
  geom_line(data=final_fig2_table, aes(x=as.Date(col.Monday.date), y=No__Blood, colour="No__Blood"), na.rm=T) +
  geom_point(width = 0.2) +
  scale_y_continuous(name="Percent %", limits=c(0,100),expand = c(0, 0), breaks=seq(0,100,25)) +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-1) ,expand=c(0,0))  +
  scale_color_manual(name = "Incompletion Level",
                     values = c("All_Incomplete" = "#FDBE19", "No__Blood" = "#3C989E", "Partial__Blood" = "#164C71"),
                     labels = c("Total","No Blood",  "Partial Blood"),
                     guide = guide_legend(nrow = 2, byrow = TRUE)) +
  ggtitle(label="Figure 2.2: Baseline- Weekly Percent of Incomplete Blood Collections, \n Henry Ford Health") +
  labs(color = "Incompletion Level") +
  theme(panel.background = element_blank(),
        #legend.title = element_text(size=7),
        legend.position="bottom",
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14, face = "bold") ,
        axis.title.y = element_text(size = 14, face = "bold",color="black"),
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +
  labs(caption = "Note: NCI notified Henry Ford of incomplete blood draws on April 19, 2023.") +
  theme(plot.caption = element_text(hjust=0)) +
  guides(fill=guide_legend(nrow=2,byrow=TRUE))

research.1_2


```



```{r KnitrTables7.3_11,echo=FALSE,error=FALSE,message=FALSE,warning=FALSE,results='asis'}

knitr::kable(bloodcomp_clinloc,
             col.names=c("Clinic Location","All Blood Collected","Partial Blood Collected","No Blood Collected","Total Clinical Collections"),
             caption='Table 2.6: Baseline Blood Collection Completeness Among Clinical Collections \n by Clinic Location, \n Henry Ford Health',
             row.names=FALSE, align=c("l","c","c","c"), booktabs = TRUE) %>%
  kable_styling(latex_options = "scale_down") %>%  
  add_indent(seq(1, nrow(bloodcomp_clinloc) - 1))





tab2_7= knitr::kable(bloodtube_R, 
                     caption='Table 2.7: Baseline- Total Blood Tubes Collected Among Research Collections', 
                     row.names=FALSE,align=c("l","c","c","c","c","c","c","c","c","c", "c"), booktabs = TRUE) %>%  
  add_indent(seq(1, nrow(bloodtube_R) - 1))  %>% 
  kable_styling(latex_options = "scale_down")
add_footnote(tab2_7, "Note: Research collections are expected to have a total of 5 blood tubes collected.", notation = "none")
#add_footnote(tab2_7, "Note: As of 3/31/2025: Research Collections for BSWH, HFH, MFH, SFH and UChicago are expected to have 3 tubes; Research Collections for HP are expected to have 4 tubes. Prior to 3/31/2025, Research Collections for all sites were expected to have 4-5 tubes.", notation = "none")





tab2_8= knitr::kable(bloodtubetype_R, 
                     caption='Table 2.8: Baseline Blood Tubes Collected Among Research Collections by Tube Type', 
                     row.names=FALSE,align=c("l","c","c","c","c","c","c","c","c","c", "c"), booktabs = TRUE) %>%  
  add_indent(seq(1, nrow(bloodtubetype_R) - 1))  %>% 
  kable_styling(latex_options = "scale_down")
add_footnote(tab2_8, "Note: Research collections are expected to include 2 SSTs, 1 Heparin, 1 EDTA, and either 1 ACD or 1 STRECK.", notation = "none")
#add_footnote(tab2_8, "Note: Research collections are expected to include 2 SSTs, 1 EDTA, and, for HP, 1 Streck. ACD and Heparin tubes are no longer collected.", notation = "none")




tab10_2= knitr::kable(bloodtubes_bysite, 
                      caption='Table 2.9: Baseline- Total Blood Tubes Collected Among Clinical Biospecimen Collections', 
                      row.names=FALSE,align=c("l","c","c","c","c","c","c","c","c","c", "c"), booktabs = TRUE) %>%  
  add_indent(seq(1, nrow(bloodtubes_bysite) - 1))  %>% 
  kable_styling(latex_options = "scale_down")
add_footnote(tab10_2, "Note: The expected total blood collection tubes vary by site and are as follows: KPHI-9, KPGA-7, KPNW-9, KPCO-8, HFH-5, HP-5, SFH-9, UChicago- 4", notation = "none") 



tab8=knitr::kable(bloodtubetype_C,
                  caption='Table 2.10: Baseline Blood Tubes Collected Among Clinical Biospecimen Collections by Tube Type',
                  row.names=FALSE,align=c("l","c","c","c","c","c","c","c","c","c","c","c","c","c"), booktabs = TRUE) %>%  
  add_indent(seq(1, nrow(bloodtubetype_C) - 1))  %>% 
  kable_styling(latex_options = "scale_down", full_width = FALSE)   %>% 
  landscape()
add_footnote(tab8, "Note: The expected collected tube type varies by site and is as follows: (1)KPCO: 4 SST, 2 Heparin, 2 EDTA. (2)KPGA: 4 SST, 1 Heparin, 2 EDTA. (3)KPHI: 4 SST, 2 Heparin, 3 EDTA. (4)KPNW: 5 SST, 2 Heparin, 2 EDTA. (5)HFH: 2 SST, 1 Heparin, 1 EDTA, 1 ACD. (6) HP: 2 SST, 1 Heparin, 1 EDTA, 1 STRECK. (7) SFH: 4 SST, 2 Heparin, 3 EDTA. (8) UChicago- 2 SST, 1 Heparin, 1 EDTA", notation = "none") 



devns <- knitr::kable(Deviation_Freq[,c(7,5,6,4)],
             col.names=c("Site","Any Deviations","No Deviations", "Total Tubes Collected"), 
             caption='Table 2.11: Baseline- Deviation Status Among Biospecimen Tubes Collected',
             row.names=FALSE, align=c("l","c","c","c"), booktabs = TRUE )
add_footnote(devns, "Note: This table includes deviations on all baseline specimens except home mouthwash.", notation = "none") 
```


```{r KnitrTables13,echo=FALSE,error=FALSE,message=FALSE,warning=FALSE,results='asis'}


tabe2_12 <- knitr::kable(reason_notcol,  
                         caption='Table 2.12: Baseline- Reason Not Collected Among Research Collection Tubes Not Collected', 
                         row.names=FALSE,align=c("l","c","c","c","c","c","c", "c"), booktabs = TRUE) %>%  
  add_indent(seq(1, nrow(reason_notcol) - 1)) %>% 
  kable_styling(latex_options = "scale_down")
add_footnote(tabe2_12,"Note: The 'Short Draw' is applicable to blood collection tubes only.", notation="none")

tubes2_12 <- knitr::kable(tube_type_notcolreasons,  
                          caption='Table 2.13: Baseline- Reason Not Collected Among Research Collection Tubes Not Collected by Tube Type',
                          row.names=FALSE,align=c("l","c","c","c","c","c","c", "c"), booktabs = TRUE)  %>%  
  add_indent(seq(1, nrow(tube_type_notcolreasons) - 1))  %>% 
  kable_styling(latex_options = "scale_down")
add_footnote(tubes2_12, "Note: 'Short Draw' reason applicable to blood collection tubes only.", notation="none")


knitr::kable(discard.site, 
             caption='Table 2.14: Baseline- Discarded Tubes Among Biospecimen Collections by Tube Type', 
             row.names=FALSE,  
             col.names=c("Site",  "SST 1", "SST 2", "SST 5", "Heparin 1", "Heparin 2", "EDTA 1, 2, or 3", "ACD", "Urine", "Total Discarded Tubes"), 
             align=c("l","c","c","c","c","c","c","c","c"), booktabs = TRUE) %>%
  kable_styling(latex_options = "scale_down")
#col.names=c("Site",  "SS Tube1", "SS Tube2", "SS Tube5", "Heparin Tubes", "EDTA Tubes", "ACD Tubes", "Urine Tubes", "Total Tubes"), align=c("l","c","c","c","c","c","c","c","c"),
```

\newpage
\newpage
\FloatBarrier
# Baseline Biospecimen Survey
\vspace{-0.5em}
\FloatBarrier
```{r KnitrTables14,echo=FALSE,error=FALSE,message=FALSE,warning=FALSE,results='asis'}


knitr::kable(BUM_status,  
             caption='Table 3.1: Baseline Biospecimen Survey Status Among Research Collections', 
             row.names=FALSE,align=c("l","c","c","c","c","c","c"), booktabs = TRUE)  %>% 
  kable_styling(latex_options = "scale_down")

```




\FloatBarrier
```{r Figure3, echo=FALSE, eval=TRUE, warning=FALSE}


fig3_sub <- research.survey %>%  filter(Site=="University of Chicago Medicine")
fig3_sub <- fig3_sub %>%  filter(!is.na(research.sv)) 

fig3_sub$Site<- droplevels(fig3_sub$Site)

figsub3 <- fig3_sub %>% arrange(col.Monday.date,research.sv) %>% group_by(col.Monday.date,research.sv) %>% tally()

figsub3_2 <- figsub3 %>% group_by(col.Monday.date) %>% mutate(per_week_parts=sum(n))

#New version of Figure 3
figsub3_3 <- figsub3_2 %>% group_by(col.Monday.date) %>% filter(research.sv=="Submitted") %>%  mutate(weekly_sub=n)

figsub3_4 <- figsub3_3 %>% group_by(col.Monday.date) %>%  filter(research.sv=="Submitted") %>%  select(col.Monday.date,research.sv,weekly_sub, per_week_parts)

figsub3_5 <-figsub3_4 %>% ungroup() %>% mutate(cum_sub= cumsum(weekly_sub),
                                               cumtotal= cumsum(per_week_parts))


figsub3_6 <- figsub3_5 %>%  mutate(percent_3= 100*(cum_sub/cumtotal))


ggplot(figsub3_5, aes(x=as.Date(col.Monday.date), y=100*(cum_sub/cumtotal))) + 
  geom_line(na.rm=T) + geom_point(width = 0.2) +
  scale_y_continuous(name="Percent %",limits=c(0,100),expand=c(0,0)) + #, limits=c(0,30), breaks=seq(0,30,5)) +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-1),expand=c(0,0))  +
  scale_fill_brewer(palette="Dark2") +
  ggtitle(label="Figure 3.1: Baseline- Cumulative Percent of Biospecimen Surveys \n Submitted, University of Chicago Medicine") +
  theme(panel.background = element_blank(),
        #legend.title = element_text(size=7),
        #legend.position="right",
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14, face = "bold") ,
        axis.title.y = element_text(size = 14, face = "bold",color="black"),
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) + 
  theme(plot.caption = element_text(hjust=0))


```

\newpage
\FloatBarrier
```{r Figure3.1, echo=FALSE, eval=TRUE, warning=FALSE}
#Comparative Figure 3 of weekly not cummulative

ggplot(figsub3_5, aes(x=as.Date(col.Monday.date), y=100*(weekly_sub/per_week_parts))) + 
  geom_line(na.rm=T) + geom_point(width = 0.2) +
  scale_y_continuous(name="Percent %",limits=c(0,100),expand=c(0,0)) + 
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-1),expand=c(0,0))  +
  ggtitle(label="Figure 3.2: Baseline- Weekly Percent of Biospecimen Surveys Submitted, \n University of Chicago Medicine") +
  theme(panel.background = element_blank(),
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14, face = "bold") ,
        axis.title.y = element_text(size = 14, face = "bold",color="black"),
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) + 
  theme(plot.caption = element_text(hjust=0))


```



```{r KnitrTables15_16,echo=FALSE,error=FALSE,message=FALSE,results='asis'}

knitr::kable(BU_status, 
             caption='Table 3.2: Baseline Biospecimen Survey Status Among Clinical Collections', 
             row.names=FALSE,align=c("l","c","c","c","c","c","c","c","c"), booktabs = TRUE)  %>% 
  kable_styling(latex_options = "scale_down")



tbl19a <-knitr::kable(precovid_BUMtime, 
                      caption='Table 3.3: Baseline Biospecimen Survey Completion Time from Research Collection Visit Check In \n (Pre-COVID- 19 Questions Removal)',
                      row.names=FALSE,align=c("l","c","c","c","c","c","c"), booktabs = TRUE)  %>% 
  kable_styling(latex_options = "scale_down")
add_footnote(tbl19a,"Note: The COVID-19 survey questions were separated from the Biospecimen Survey on July 5, 2023.", notation = "none") 



tbl19b <- knitr::kable(postcovid_BUMtime, 
                       caption='Table 3.4: Baseline Biospecimen Survey Completion Time from Research Collection Visit Check In \n (Post- COVID-19 Questions Removal)',
                       row.names=FALSE,align=c("l","c","c","c","c","c","c"), booktabs = TRUE)  %>% 
  kable_styling(latex_options = "scale_down")
add_footnote(tbl19b,"Note: The COVID-19 survey questions were separated from the Biospecimen Survey on July 5, 2023.", notation = "none") 

```



\newpage
\FloatBarrier

```{r Figures1_3, echo=FALSE, eval=TRUE}

research.4_1
research.4_2
research.4_3

```

\newpage
\FloatBarrier
```{r KnitrTables17_20,echo=FALSE,error=FALSE,message=FALSE,results='asis'}

knitr::kable(coll_comp_BU, 
             caption='Table 3.5: Baseline Clinical Biospecimen Survey Complete Time from Collection Time', 
             row.names=FALSE,align=c("l","c","c","c","c","c","c","c","c"), booktabs = TRUE)  %>% kable_styling(latex_options = "scale_down")



tab21_rb=knitr::kable(Table21R_Before,
                      caption='Table 3.6: Baseline Biospecimen Survey Completion Length (in Minutes) Among Submitted \n Research Surveys (Pre-COVID-19 Questions Removal)',
                      row.names=FALSE, align=c("l","c","c","c","c","c","c","c","c","c","c","c"),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "scale_down")
add_footnote(tab21_rb,"Note: The COVID-19 survey questions were separated from the Biospecimen Survey on July 5, 2023. Research biospecimen surveys with a negative completion time have been excluded.",notation = "none")




tab21_ra=knitr::kable(Table21R_After,
                      caption='Table 3.7: Baseline Biospecimen Survey Completion Length (in Minutes) Among Submitted \n Research Surveys (Post-COVID-19 Questions Removal)',
                      row.names=FALSE, align=c("l","c","c","c","c","c","c","c","c","c","c","c"),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "scale_down")
add_footnote(tab21_ra,"Note: The COVID-19 survey questions were separated from the Biospecimen Survey on July 5, 2023. ", notation = "none")





tab21_cb=knitr::kable(ClinSrvy_Lgth_Before,
                      caption='Table 3.8: Baseline Biospecimen Survey Completion Length (in Minutes) Among Submitted Clinical Surveys \n (Pre-COVID-19 Questions Removal)',
                      row.names=FALSE, align=c("l","c","c","c","c","c","c","c","c","c","c"),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "scale_down")
add_footnote(tab21_cb,"Note: The COVID-19 survey questions were separated from the Biospecimen Survey on July 5, 2023.", notation = "none")




tab21_ca=knitr::kable(ClinSrvy_Lgth_After,
                      caption='Table 3.9: Baseline Biospecimen Survey Completion Length (in Minutes) Among Submitted Clinical Surveys \n (Post-COVID-19 Questions Removal)',
                      row.names=FALSE, align=c("l","c","c","c","c","c","c","c","c","c","c"),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "scale_down")
add_footnote(tab21_ca,"Note: The COVID-19 survey questions were separated from the Biospecimen Survey on July 5, 2023.", notation = "none")
```


\newpage
\FloatBarrier
# Baseline Collection Activity Durations
\vspace{-0.5em}
\FloatBarrier
```{r KnitrTables20,echo=FALSE,error=FALSE,message=FALSE,results='asis'}
tab23=knitr::kable(research.vt.length.table,
                   caption='Table 4.1: Baseline Research Collection Visit Length (in Minutes)',
                   row.names=FALSE, align=c("l","c","c","c","c","c","c","c","c","c"),digits=1, booktabs = TRUE)%>% 
  kable_styling(latex_options = "scale_down") #%>% landscape()
add_footnote(tab23,"Note: Expected visit length for each site is as follows: (1) HealthPartners: 25-60 minutes, (2) Henry Ford: 25-60 minutes, (3) Sanford: 10-45 minutes, (4) Marshfield: 10-45 minutes, and (5) UChicago:15-180 minutes  ", notation = "none") #and greater than 500 minutes 


uc_col_time <- knitr::kable(research.vt.length.UC.table,
                            caption='Table 4.2: Baseline Research Collection Visit Length (in Minutes) by Collection Location, University of Chicago Medicine', 
                            col.names=c('Collection Location', 'Number of Research Collection Visits',"Min","Q1","Median","Mean","Q3" ,"Perc.90","Perc.95","Perc.98","Max"),
                            row.names=FALSE, align=c("l","c","c","c","c","c","c","c","c","c"),digits=1, booktabs = TRUE)%>% 
  kable_styling(latex_options = "scale_down") #%>% landscape()
add_footnote(uc_col_time,"Note: Visit legnths at or above the 95th percentile and above are likely the result of delayed participant visit check-out and do not reflect accurate visit lentghs", notation = "none") 



```
\FloatBarrier
```{r newFig5, eval=TRUE,echo=FALSE}

UC_Time_plot <- research.vt.length.UC %>%  group_by(col.Monday.date, Site_location) %>% tally(mean(time))


UC_Time <- ggplot(UC_Time_plot, aes(x=as.Date(col.Monday.date), y=n, color=Site_location)) + #,fill=Site, color=Site)) +
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="Average Number of Minutes",limits=c(0,300)) +
  scale_color_manual(values=c("Ingalls Harvey"="#B1C7D9", "Orland Park"="#2973A5", "River East"="#FDBE19", 
                              "South Loop"="#565C65", "UC-DCAM"="#3C989E", "UCM Pop-Up"="#CC7D15")) +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),(as.Date(currentDate)-1)),expand=c(0,0)) +
  ggtitle(label="Figure 4.1 Baseline- Weekly Average Research Collection Visit Length (in Minutes) \n by Collection Location, University of Chicago Medicine") +
  labs(color = "Collection Location") +
  theme(panel.background = element_blank(),
        legend.title = element_text(size=8),
        legend.position="bottom",
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14, face = "bold") ,
        axis.title.y = element_text(size = 14, face = "bold",color="black"),
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +
  guides(fill=guide_legend(nrow=2,byrow=TRUE))+
  labs(caption = "Note: Visit lengths greater than 300 minutes (5 hours) have been excluded, as they are likely the result of delayed \n
participant visit check−out.") +
  theme(plot.caption = element_text(hjust=0))


UC_Time



```


```{r KnitrTable21_26,echo=FALSE,error=FALSE,message=FALSE,results='asis'}

tabbA <- knitr::kable(verif_BSL_colctC,
                      caption='Table 4.3: Baseline- Time (in Days) from Verification to Research Collection Among Participants Verified Before 8/01/2022',
                      row.names=FALSE, align=c("l","c","c","c","c","c","c","c"),digits=1, booktabs = TRUE) %>% kable_styling(latex_options = "scale_down")
add_footnote(tabbA,"Note: August 2022 marks when research collection appointments were routinely offered to all new recruits at or near the time of verification. UChicago participant verification largely occurs at or near time of collection.", notation = "none")

tabbB <- knitr::kable(verif_BSL_colctD,
                      caption='Table 4.4: Baseline- Time (in Days) from Verification to Research Collection Among Participants Verified on or After 8/01/2022',
                      row.names=FALSE, align=c("l","c","c","c","c","c","c","c"),digits=1, booktabs = TRUE)  %>% kable_styling(latex_options = "scale_down")
add_footnote(tabbB,"Note: August 2022 marks when research collection appointments were routinely offered to all new recruits at or near the time of verification. UChicago participant verification largely occurs at or near the time of collection.", notation = "none")



BSL_A <- knitr::kable(verif_BSL_colctA,
                      caption='Table 4.5: Baseline- Time (in Days) from Verification to Clinical Collection Among Participants Verified Before 2/01/2023',
                      row.names=FALSE, align=c("l","c","c","c","c","c","c","c"),digits=1, booktabs = TRUE)  %>%  kable_styling(latex_options = "scale_down")
add_footnote(BSL_A,"Note: Baseline Clinical Collections were launched in February 2023.", notation = "none")



BSL_B <-knitr::kable(verif_BSL_colctB,
                     caption='Table 4.6: Baseline- Time (in Days) from Verification to Clinical Collection Among Participants Verified on or After 2/01/2023',
                     row.names=FALSE,  align=c("l","c","c","c","c","c","c","c"),digits=1, booktabs = TRUE)  %>%  kable_styling(latex_options = "scale_down")
add_footnote(BSL_B,"Note: Baseline Clinical Collections were launched in February 2023.", notation = "none")



AF26 <- knitr::kable(verif_baseline_Af,
                     caption = 'Table 4.7: Baseline- Time (in Days) from Verification to Collection Among Participants Verified on or After 6/01/2022 by Campaign Type',
                     row.names=FALSE, booktabs = T, linesep = "", format.args = list(big.mark = ","), 
                     align = c("l", "c", "c","c", "c", "c", "c", "c", "c", "c", "c","c", "c","c"), 
                     col.names=c("Site",  'Number of Collections',"Min", "Median", "Mean", "SD", "Max", 'Number of Collections', 
                                 "Min", "Median", "Mean", "SD", "Max","Total Baseline Collections") ) %>% 
  kable_styling(latex_options = "scale_down") %>% 
  add_indent(seq(1, nrow(verif_baseline_Af))) %>% 
  add_header_above(c(" " = 1, "Upcoming Appointment" = 6, "All Other Campaigns" = 6,  " "=1)) %>% landscape() 
add_footnote(AF26, "Note: Upcoming Appointment includes “Screening appointment” and “Non-screening appointment” campaign types. All Other Campaigns include “Random”, “Demographic Group”, “Aging out of study”, “Geographic group”, “Post-Screening Selection”, “Technology adapters”, “Low-income/health professional shortage areas”, and “Other” campaign types.", notation = "none")




tabl27 <- knitr::kable(verif_draw_order,
                       caption='Table 4.8: Baseline- Time (in Days) from Verification to Draw Order Placement',row.names=FALSE, align=c("l","c","c","c","c","c","c","c"),digits=1, booktabs = TRUE)  %>% kable_styling(latex_options = "scale_down")

add_footnote(tabl27, "Note: Time from verification to draw order placement calculated for participants verified on or after February 1, 2023. HealthPartners, University of Chicago Medicine and Sanford Health are excluded due to the limited availability of draw order placement data.", notation="none")


tab4_9 <- knitr::kable(avg_draw_order, 
                       caption='Table 4.9: Baseline- Time (in Days) from Draw Order Placement to Clinical Collection', 
                       row.names=FALSE, align=c("l","c","c","c","c","c","c","c","c","c","c","c","c"),digits=1, booktabs = TRUE) %>% 
  kable_styling(latex_options = "scale_down") #%>% landscape()
add_footnote(tab4_9, "Note: HealthPartners, University of Chicago Medicine and Sanford Health are excluded due to the limited availability of draw order placement data.", notation="none")



tab4_10 <- knitr::kable(avg_bldorder_present, 
                        caption='Table 4.10: Baseline- Time (in Days) from Draw Order Placement to Present Date by Site', 
                        row.names=FALSE, align=c("l","c","c","c","c","c","c","c","c","c","c","c","c"),digits=1, booktabs = TRUE) %>% 
  kable_styling(latex_options = "scale_down") #%>% landscape()
add_footnote(tab4_10, "Note: Table includes information for Kaiser sites only, other clinical collection sites are excluded.", notation="none")



add_footnote(Table_bld_draw , "Note: Table includes information for Kaiser sites only, other clinical collection sites are excluded.", notation="none")



knitr::kable(crosstable.coll_bptl1, 
             col.names=c("Site", "< 30 Days", "30 to <60 Days","60 to <90 Days", "90 to <180 Days", "180 to <270 Days", 
                         "270 Days or More", "Total Participants with No Basline Collections"), 
             caption='Table 4.12: Baseline- Time (in Days) Since Verification Among Participants with No Biospecimen Collection ', 
             row.names=FALSE, align=c("l","c","c","c","c","c","c","c"), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down") 

```


\newpage
\newpage
\FloatBarrier
# Baseline Collection-To-Receipt Times
\vspace{-0.5em}
\FloatBarrier
```{r KnitrTable28_30,echo=FALSE,error=FALSE,message=FALSE,results='asis'}

all_rsch_days <- knitr::kable(crosstable.coll_bptl28a, 
             col.names=c("Site", "1 Day", "2 Days", "3 Days", "4 Day", ">4 Days", "Total Received Research Collections"), 
             caption='Table 5.1: Baseline Collection-To-Receipt Time (in Days) Among Research Collections', 
             row.names=FALSE, align=c("l","c","c","c","c","c"), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down")
add_footnote(all_rsch_days, paste0("At the time of reporting, ", dim(biospe_adhoc_missings)[[1]], " of the Research Collections do not have not receipt date/time information available."), notation="none")
```

\FloatBarrier
```{r Rsch_clt_days,echo=FALSE,error=FALSE,message=FALSE,warning=FALSE,results='asis'}

#crosstable.coll_bptl28 %>% gt::as_latex()

add_footnote(rsch_coll_times52, paste0("At the time of reporting, ", dim(biospe_adhoc_missings)[[1]], " of the Research Collections do not have receipt date/time information available."), notation="none")

```

\FloatBarrier
```{r clin_clt_days,echo=FALSE,error=FALSE,message=FALSE,warning=FALSE,results='asis'}
clin_bptl <- knitr::kable(ctabs_rsch_coll_days, 
             col.names=c("Site", "1 Day", "2 Days", "3 Days", "4 Days", ">4 Days", "Total Received Clinical Collections"), 
             caption='Table 5.3: Baseline Collection-To-Receipt Time (in Days) Among Clinical Collections', 
             row.names=FALSE, align=c("l","c","c","c","c","c","c"), booktabs = TRUE) %>% 
  kable_styling(latex_options = "scale_down")
add_footnote(clin_bptl, paste0("At the time of reporting, ", dim(biospe_adhoc2_missings)[[1]], " of the Clinical Collections did not have collection and/or receipt date/time information available."), notation="none")
```

\FloatBarrier
```{r clin_loc_clt_days,echo=FALSE,error=FALSE,message=FALSE,results='asis'}
crosstable.coll_bptl_2

```

\FloatBarrier
```{r SF_col_days,echo=FALSE,error=FALSE,message=FALSE,warning=FALSE,results='asis'}
#SF version of Table 5.4
knitr::kable(SF_coll_rcpt, 
             caption="Table 5.4a Baseline Collection-To-Receipt Time (in Days) Among Clinical Collections by Clinic Location \n Sanford Health",
             row.names=FALSE,align=c("l","c","c","c","c"), 
             booktabs = TRUE, longtable = TRUE) %>%  
  kable_styling(latex_options = "scale_down", full_width = FALSE, font_size=8) %>% 
  landscape()

```

\FloatBarrier
```{r Coll_Time_Spread_Rsch,echo=FALSE,error=FALSE,message=FALSE,warning=FALSE,results='asis'}
#Hrs_bptl_rsch

add_footnote(knit_hrs_rsch_55, "Note: BPTL receipt time is assumed to be 11:30am ET.", notation="none")

```


\newpage

\FloatBarrier
```{r Coll_Time_Spread_Clin,echo=FALSE,error=FALSE,message=FALSE,warning=FALSE,results='asis'}
Hrs_bptl_clin
```

\newpage

\FloatBarrier
```{r Coll_Time_Spread_SF,echo=FALSE,error=FALSE,message=FALSE,warning=FALSE,results='asis'}

knitr::kable(Hrs_bptl_clinSF, 
             col.names=c("Collection Location", 'Min', 'Q1', 'Median', 'Mean', 'Q3','Perc.90','Perc.98'), 
             caption='Table 5.6a: Baseline- Time (in Hours) from Clinical Collection to Receipt by Clinic Location \n Sanford Health', 
             row.names=FALSE, align=c("l","c","c","c","c","c","c","c"), booktabs = TRUE, longtable = TRUE) %>% 
  kable_styling(latex_options = "scale_down", font_size=7) 

```

\newpage
\FloatBarrier
\newpage
\newpage

```{r Figs6_14_Plots, warning=FALSE, eval=TRUE,echo=FALSE}

coll_bptl_diff$Weekdays <- factor(weekdays(as.Date(coll_bptl_diff$d_678166505)))
coll_bptl_diff$Weekdays<- factor(coll_bptl_diff$Weekdays,levels=c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"))

coll_bptl_diff2$Weekdays <- factor(weekdays(as.Date(coll_bptl_diff2$clin_coll_bu)))
coll_bptl_diff2$Weekdays<- factor(coll_bptl_diff2$Weekdays,levels=c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"))

scatMF <- coll_bptl_diff %>%  filter(Site=="Marshfield Clinic Health System")
scatSF <- coll_bptl_diff %>%  filter(Site=="Sanford Health")
scatUC <- coll_bptl_diff %>%  filter(Site=="University of Chicago Medicine")
scatRHF <- coll_bptl_diff %>%  filter(Site=="Henry Ford Health")
scatRHP <- coll_bptl_diff %>%  filter(Site=="HealthPartners")

scatKPCO <- coll_bptl_diff2 %>%  filter(Site=="Kaiser Permanente Colorado")
scatKPGA <- coll_bptl_diff2 %>%  filter(Site=="Kaiser Permanente Georgia")
scatKPHI <- coll_bptl_diff2 %>%  filter(Site=="Kaiser Permanente Hawaii")
scatKPNW <- coll_bptl_diff2 %>%  filter(Site=="Kaiser Permanente Northwest")
scatCHF <- coll_bptl_diff2 %>%  filter(Site=="Henry Ford Health")
scatCHP <- coll_bptl_diff2 %>%  filter(Site=="HealthPartners")
scatCSF <- coll_bptl_diff2 %>%  filter(Site=="Sanford Health")
scatCUC <- coll_bptl_diff2 %>%  filter(Site=="University of Chicago Medicine")


scatRHP$coldate <- scatRHP$d_678166505
scatCHP$coldate <- scatCHP$clin_coll_bu
scatCSF$coldate <- scatCSF$clin_coll_bu
scatCUC$coldate <- scatCUC$clin_coll_bu


weekday_order <- c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday")




ggplot(scatMF, aes(x=as.Date(d_678166505), y=hrs_past, color = Weekdays)) + 
  geom_point() + scale_x_date(name="Collection Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-7), expand=c(0,0)) + 
  scale_y_continuous(name="Number of Hours",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  scale_color_manual(values=c("Sunday"="#B1C7D9", "Monday"="#164C71", "Tuesday"="#FDBE19", "Wednesday"="#FBE5B5", 
                              "Thursday"="#565C65", "Friday"="#3C989E", "Saturday"="#CC7D15")) +
  theme(panel.background = element_blank(),         
        #legend.title = element_text(size=7),         
        legend.position = "bottom",        
        axis.line = element_line(size=0.2),        
        axis.text.x=element_text(angle=60, hjust=1), 
        axis.title.x = element_text( size = 14, face = "bold") ,         
        axis.title.y = element_text(size = 14, face = "bold",color="black"),         
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +     
  theme(plot.caption = element_text(hjust=0))  + ggtitle(label="Figure 5.1: Baseline Collection-To-Receipt Time (in Hours), \n Marshfield")




ggplot(scatSF, aes(x=as.Date(d_678166505), y=hrs_past, color = Weekdays)) + 
  geom_point() + scale_x_date(name="Collection Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-7), expand=c(0,0)) + 
  scale_y_continuous(name="Number of Hours",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  scale_color_manual(values=c("Sunday"="#B1C7D9", "Monday"="#164C71", "Tuesday"="#FDBE19", "Wednesday"="#FBE5B5", 
                              "Thursday"="#565C65", "Friday"="#3C989E", "Saturday"="#CC7D15")) +
  theme(panel.background = element_blank(),         
        #legend.title = element_text(size=7),         
        legend.position = "bottom",        
        axis.line = element_line(size=0.2),        
        axis.text.x=element_text(angle=60, hjust=1), 
        axis.title.x = element_text( size = 14, face = "bold") ,         
        axis.title.y = element_text(size = 14, face = "bold",color="black"),         
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +     
  theme(plot.caption = element_text(hjust=0))  +
  ggtitle(label="Figure 5.2: Baseline Collection-To-Receipt Time (in Hours), \n Sanford Health Research Setting")







#SF
scatCSF$coldate <- scatCSF$clin_coll_bu

C_plotSF <- ggplot(scatCSF, aes(x = as.Date(coldate), y = hrs_past, color = factor(weekdays(as.Date(coldate))))) +
  geom_point() +
  scale_x_date(name="Collection Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2024-03-25"),(as.Date(currentDate)-7)), expand=c(0,0)) +
  scale_y_continuous(name="Number of Hours",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  labs(color = "Weekdays") +
  scale_color_manual(values=c("Sunday"="#B1C7D9", "Monday"="#164C71", "Tuesday"="#FDBE19", "Wednesday"="#FBE5B5",
                              "Thursday"="#565C65", "Friday"="#3C989E", "Saturday"="#CC7D15"), limits = weekday_order) +
  theme(panel.background = element_blank(),
        legend.title = element_text(size=7),
        legend.position = "bottom",
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1),
        axis.title.x = element_text( size = 14, face = "bold") ,
        axis.title.y = element_text(size = 14, face = "bold",color="black"),
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +
  theme(plot.caption = element_text(hjust=0), legend.title = element_text(size = 8.5))  +
  ggtitle(label="Figure 5.3: Baseline- Collection-To-Receipt Time (in Hours), \n Sanford Health Clinical Setting")
C_plotSF


ggplot(scatUC, aes(x=as.Date(d_678166505), y=hrs_past, color = Weekdays)) + 
  geom_point() + scale_x_date(name="Collection Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-7), expand=c(0,0)) + 
  scale_y_continuous(name="Number of Hours",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  scale_color_manual(values=c("Sunday"="#B1C7D9", "Monday"="#164C71", "Tuesday"="#FDBE19", "Wednesday"="#FBE5B5", 
                              "Thursday"="#565C65", "Friday"="#3C989E", "Saturday"="#CC7D15")) +
  theme(panel.background = element_blank(),         
        #legend.title = element_text(size=7),         
        legend.position = "bottom",        
        axis.line = element_line(size=0.2),        
        axis.text.x=element_text(angle=60, hjust=1), 
        axis.title.x = element_text( size = 14, face = "bold") ,         
        axis.title.y = element_text(size = 14, face = "bold",color="black"),         
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +     
  theme(plot.caption = element_text(hjust=0))  +
  ggtitle(label="Figure 5.4: Baseline Collection-To-Receipt Time (in Hours),  \n University of Chicago Medicine Research Setting")


scatCUC$coldate <- scatCUC$clin_coll_bu

C_plotUC <- ggplot(scatCUC, aes(x = as.Date(coldate), y = hrs_past, color = factor(weekdays(as.Date(coldate))))) +
  geom_point() +
  scale_x_date(name="Collection Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2024-03-25"),(as.Date(currentDate)-7)), expand=c(0,0)) +
  scale_y_continuous(name="Number of Hours",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  labs(color = "Weekdays") +
  scale_color_manual(values=c("Sunday"="#B1C7D9", "Monday"="#164C71", "Tuesday"="#FDBE19", "Wednesday"="#FBE5B5",
                              "Thursday"="#565C65", "Friday"="#3C989E", "Saturday"="#CC7D15"), limits = weekday_order) +
  theme(panel.background = element_blank(),
        legend.title = element_text(size=7),
        legend.position = "bottom",
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1),
        axis.title.x = element_text( size = 14, face = "bold") ,
        axis.title.y = element_text(size = 14, face = "bold",color="black"),
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +
  theme(plot.caption = element_text(hjust=0), legend.title = element_text(size = 8.5))  +
  ggtitle(label="Figure 5.5: Baseline- Collection-To-Receipt Time (in Hours), \n University of Chicago Medicine Clinical Setting")
C_plotUC

ggplot(scatKPCO, aes(x=as.Date(clin_coll_bu), y=hrs_past, color = Weekdays)) + 
  geom_point() + scale_x_date(name="Collection Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-10-10"),as.Date(currentDate)-7), expand=c(0,0)) + 
  scale_y_continuous(name="Number of Hours",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  scale_color_manual(values=c("Sunday"="#B1C7D9", "Monday"="#164C71", "Tuesday"="#FDBE19", "Wednesday"="#FBE5B5", 
                              "Thursday"="#565C65", "Friday"="#3C989E", "Saturday"="#CC7D15")) +
  theme(panel.background = element_blank(),         
        #legend.title = element_text(size=7),         
        legend.position = "bottom",        
        axis.line = element_line(size=0.2),        
        axis.text.x=element_text(angle=60, hjust=1), 
        axis.title.x = element_text( size = 14, face = "bold") ,         
        axis.title.y = element_text(size = 14, face = "bold",color="black"),         
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +     
  theme(plot.caption = element_text(hjust=0))  +
  ggtitle(label="Figure 5.6: Baseline Collection-To-Receipt Time (in Hours),  \n Kaiser Permanente Colorado")

ggplot(scatKPGA, aes(x=as.Date(clin_coll_bu), y=hrs_past, color = Weekdays)) + 
  geom_point() + scale_x_date(name="Collection Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-10-10"),as.Date(currentDate)-7), expand=c(0,0)) + 
  scale_y_continuous(name="Number of Hours",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  scale_color_manual(values=c("Sunday"="#B1C7D9", "Monday"="#164C71", "Tuesday"="#FDBE19", "Wednesday"="#FBE5B5", 
                              "Thursday"="#565C65", "Friday"="#3C989E", "Saturday"="#CC7D15")) +
  theme(panel.background = element_blank(),         
        #legend.title = element_text(size=7),         
        legend.position = "bottom",        
        axis.line = element_line(size=0.2),        
        axis.text.x=element_text(angle=60, hjust=1), 
        axis.title.x = element_text( size = 14, face = "bold") ,         
        axis.title.y = element_text(size = 14, face = "bold",color="black"),         
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +     
  theme(plot.caption = element_text(hjust=0))  +
  ggtitle(label="Figure 5.7: Baseline Collection-To-Receipt Time (in Hours), \n Kaiser Permanente Georgia")

ggplot(scatKPHI, aes(x=as.Date(clin_coll_bu), y=hrs_past, color = Weekdays)) + 
  geom_point() + scale_x_date(name="Collection Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-10-10"),as.Date(currentDate)-7), expand=c(0,0)) + 
  scale_y_continuous(name="Number of Hours",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  scale_color_manual(values=c("Sunday"="#B1C7D9", "Monday"="#164C71", "Tuesday"="#FDBE19", "Wednesday"="#FBE5B5", 
                              "Thursday"="#565C65", "Friday"="#3C989E", "Saturday"="#CC7D15")) +
  theme(panel.background = element_blank(),         
        #legend.title = element_text(size=7),         
        legend.position = "bottom",        
        axis.line = element_line(size=0.2),        
        axis.text.x=element_text(angle=60, hjust=1), 
        axis.title.x = element_text( size = 14, face = "bold") ,         
        axis.title.y = element_text(size = 14, face = "bold",color="black"),         
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +     
  theme(plot.caption = element_text(hjust=0))  +
  ggtitle(label="Figure 5.8: Baseline Collection-To-Receipt Time (in Hours), \n Kaiser Permanente Hawaii")

ggplot(scatKPNW, aes(x=as.Date(clin_coll_bu), y=hrs_past, color = Weekdays)) + 
  geom_point() + scale_x_date(name="Collection Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-10-10"),as.Date(currentDate)-7), expand=c(0,0)) + 
  scale_y_continuous(name="Number of Hours",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  scale_color_manual(values=c("Sunday"="#B1C7D9", "Monday"="#164C71", "Tuesday"="#FDBE19", "Wednesday"="#FBE5B5", 
                              "Thursday"="#565C65", "Friday"="#3C989E", "Saturday"="#CC7D15")) +
  theme(panel.background = element_blank(),         
        #legend.title = element_text(size=7),         
        legend.position = "bottom",        
        axis.line = element_line(size=0.2),        
        axis.text.x=element_text(angle=60, hjust=1), 
        axis.title.x = element_text( size = 14, face = "bold") ,         
        axis.title.y = element_text(size = 14, face = "bold",color="black"),         
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +     
  theme(plot.caption = element_text(hjust=0))  +
  ggtitle(label="Figure 5.9: Baseline Collection-To-Receipt Time (in Hours), \n Kaiser Permanente Northwest")



#HP


R_plotHP <- ggplot(scatRHP, aes(x = as.Date(coldate), y = hrs_past,  color = factor(weekdays(as.Date(coldate))))) +
  geom_point() +
  #scale_color_manual(values = c("Research" = "red", "Clinical" = "blue")) +
  scale_x_date(name="Collection Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-7), expand=c(0,0)) +
  scale_y_continuous(name="Number of Hours",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  labs(color = "Weekdays") +
  scale_color_manual(values=c("Sunday"="#B1C7D9", "Monday"="#164C71", "Tuesday"="#FDBE19", "Wednesday"="#FBE5B5", 
                              "Thursday"="#565C65", "Friday"="#3C989E", "Saturday"="#CC7D15"), limits = weekday_order) +
  theme(panel.background = element_blank(),         
        #legend.title = element_text(size=7),         
        legend.position = "bottom",        
        axis.line = element_line(size=0.2),        
        axis.text.x=element_text(angle=60, hjust=1), 
        axis.title.x = element_text( size = 14, face = "bold") ,         
        axis.title.y = element_text(size = 14, face = "bold",color="black"),         
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +     
  theme(plot.caption = element_text(hjust=0), legend.title = element_text(size = 8.5))  +
  ggtitle(label="Figure 5.10: Baseline- Collection-To-Receipt Time (in Hours), \n HealthPartners Research Setting")
R_plotHP


C_plotHP <- ggplot(scatCHP, aes(x = as.Date(coldate), y = hrs_past, color = factor(weekdays(as.Date(coldate))))) +
  geom_point() +
  #scale_color_manual(values = c("Research" = "red", "Clinical" = "blue")) +
  scale_x_date(name="Collection Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2023-10-23"),as.Date(currentDate)-7), expand=c(0,0)) +
  scale_y_continuous(name="Number of Hours",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  labs(color = "Weekdays") +
  scale_color_manual(values=c("Sunday"="#B1C7D9", "Monday"="#164C71", "Tuesday"="#FDBE19", "Wednesday"="#FBE5B5", 
                              "Thursday"="#565C65", "Friday"="#3C989E", "Saturday"="#CC7D15"), limits = weekday_order) +
  theme(panel.background = element_blank(),         
        #legend.title = element_text(size=7),         
        legend.position = "bottom",        
        axis.line = element_line(size=0.2),        
        axis.text.x=element_text(angle=60, hjust=1), 
        axis.title.x = element_text( size = 14, face = "bold") ,         
        axis.title.y = element_text(size = 14, face = "bold",color="black"),         
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +     
  theme(plot.caption = element_text(hjust=0), legend.title = element_text(size = 8.5))  +
  ggtitle(label="Figure 5.11: Baseline- Collection-To-Receipt Time (in Hours), \n HealthPartners Clinical Setting")
C_plotHP

#HF
scatRHF$coldate <- scatRHF$d_678166505
scatCHF$coldate <- scatCHF$clin_coll_bu
#combined_dataHF <- rbind(cbind(scatRHF, Group = "Research"), cbind(scatCHF, Group = "Clinical"))




combined_plotHF2 <- ggplot(scatRHF, aes(x = as.Date(coldate), y = hrs_past,  color = factor(weekdays(as.Date(coldate))))) + #shape = Group,
  geom_point() +
  #scale_color_manual(values = c("Research" = "red", "Clinical" = "blue")) +
  scale_x_date(name="Colllection Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks",limits=c( as.Date("2022-06-20"),as.Date(currentDate)-7),  expand=c(0,0)) +
  scale_y_continuous(name="Number of Hours",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  labs(color = "Weekdays") + #, shape="Setting"
  scale_color_manual(values=c("Sunday"="#B1C7D9", "Monday"="#164C71", "Tuesday"="#FDBE19", "Wednesday"="#FBE5B5", 
                              "Thursday"="#565C65", "Friday"="#3C989E", "Saturday"="#CC7D15"), limits = weekday_order) +
  #scale_shape_manual(values = c("Research" = 0, "Clinical" = 17)) + 
  theme(panel.background = element_blank(),         
        #legend.title = element_text(size=7),         
        legend.position = "bottom",        
        axis.line = element_line(size=0.2),        
        axis.text.x=element_text(angle=60, hjust=1), 
        axis.title.x = element_text( size = 14, face = "bold") ,         
        axis.title.y = element_text(size = 14, face = "bold",color="black"),         
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +     
  theme(plot.caption = element_text(hjust=0), legend.title = element_text(size = 8.5))  +
  ggtitle(label="Figure 5.12: Baseline- Collection-To-Receipt Time (in Hours), \n Henry Ford Research Setting")

combined_plotHF2


combined_plotHF1 <- ggplot(scatCHF, aes(x = as.Date(coldate), y = hrs_past,  color = factor(weekdays(as.Date(coldate))))) + #shape = Group,
  geom_point() +
  #scale_color_manual(values = c("Research" = "red", "Clinical" = "blue")) +
  scale_x_date(name="Colllection Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks",limits=c( as.Date("2023-04-24"),as.Date(currentDate)-7),  expand=c(0,0)) +
  scale_y_continuous(name="Number of Hours",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  labs(color = "Weekdays") + #, shape="Setting"
  scale_color_manual(values=c("Sunday"="#B1C7D9", "Monday"="#164C71", "Tuesday"="#FDBE19", "Wednesday"="#FBE5B5", 
                              "Thursday"="#565C65", "Friday"="#3C989E", "Saturday"="#CC7D15"), limits = weekday_order) +
  #scale_shape_manual(values = c("Research" = 0, "Clinical" = 17)) + 
  theme(panel.background = element_blank(),         
        #legend.title = element_text(size=7),         
        legend.position = "bottom",        
        axis.line = element_line(size=0.2),        
        axis.text.x=element_text(angle=60, hjust=1), 
        axis.title.x = element_text( size = 14, face = "bold") ,         
        axis.title.y = element_text(size = 14, face = "bold",color="black"),         
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +     
  theme(plot.caption = element_text(hjust=0), legend.title = element_text(size = 8.5))  +
  ggtitle(label="Figure 5.13: Baseline- Collection-To-Receipt Time (in Hours), \n Henry Ford Clinical Setting")

combined_plotHF1

```





\newpage

# Baseline Weekly Biospecimen Collection
\vspace{-0.5em}
\FloatBarrier
```{r Fig15, eval=TRUE,echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 


fig2_1<- coll_sett_all %>% group_by(Connect_ID) %>% 
  mutate(schedulecol.tm =min(as.POSIXct(ymd_hms(d_678166505)))) %>% 
  ungroup() %>% 
  mutate(BioRec_CollectScheduled = ifelse(as.Date(ymd_hms(schedulecol.tm)) >= as.Date(as.POSIXct(ymd_hms(d_914594314))),1,0))


visit_wk_site1 <- fig2_1 %>% arrange(col.Sunday.week,col.Monday.date) %>% group_by(col.Sunday.week,col.Monday.date) %>% tally()


research.vt1 <- ggplot(visit_wk_site1, aes(x=as.Date(col.Monday.date), y=n)) + #,fill=Site, color=Site)) +
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="Number of Collections",limits=c(0,100*round(max(visit_wk_site1$n/100,1)))) + 
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "4 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-7),expand=c(0,0)) +
  scale_fill_brewer(palette="Dark2") +
  ggtitle(label="Figure 6.1: Baseline- Weekly Total Biospecimen Collections") +
  theme(panel.background = element_blank(),
        legend.title = element_text(size=7),
        legend.position="bottom",
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14, face = "bold") ,
        axis.title.y = element_text(size = 14, face = "bold",color="black"),
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +
  guides(fill=guide_legend(nrow=2,byrow=TRUE))


research.vt1

```



```{r Figures16_18, eval=TRUE,echo=FALSE}

research.survey.hybrid <- coll_sett_all %>% filter(Site=="Henry Ford Health" | Site=="HealthPartners"| Site=="Sanford Health" | Site=="University of Chicago Medicine") %>% 
  group_by(Connect_ID, Site) %>% 
  mutate(schedulecol.tm =min(as.POSIXct(ymd_hms(d_678166505)),na.rm=TRUE)) %>% 
  ungroup() %>% 
  mutate(start.date = min(schedulecol.tm),
         current.date=max(as.POSIXct(ymd_hms(schedulecol.tm))),
         BioRec_CollectScheduled = ifelse(as.Date(ymd_hms(schedulecol.tm)) >= as.Date(as.POSIXct(ymd_hms(d_914594314))),1,0))


visit_wk_site.hybrid <-research.survey.hybrid %>% arrange(Site,Site_location, all_settings,col.Sunday.week,col.Monday.date) %>% group_by(Site,Site_location, all_settings,col.Sunday.week,col.Monday.date) %>% tally()




visit_wk_site.hybridHF= visit_wk_site.hybrid %>%  filter( Site=="Henry Ford Health")
research.vt_plotH <- ggplot(visit_wk_site.hybridHF, aes(x=as.Date(col.Monday.date), y=n, color=all_settings )) + #,fill=site, color=site)) +   #research.vt <-    ,fill=Site, color=Site
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="Number of Collections") +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "4 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-7),expand=c(0,0))  +
  scale_color_manual(values=c("Clinical"="#164C71", "Research"="#FDBE19")) +
  ggtitle(label="Figure 6.2: Baseline- Weekly Biospecimen Collections by Collection Setting, \n Henry Ford") +
  labs(color = "Collection Setting") +
  theme(panel.background = element_blank(),
        legend.position = "bottom",
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) ,  #, face = "bold"
        axis.title.y = element_text(size = 14,color="black"),   #, face = "bold"
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) #guides(fill=guide_legend(nrow=2,byrow=TRUE))
print(research.vt_plotH)



edited_fig3_1 <- visit_wk_site.hybridHF %>%  filter(all_settings=="Research")

ggplot(edited_fig3_1, aes(x=as.Date(col.Monday.date), y=n, color=Site_location)) + #,fill=site, color=site)) +   #research.vt <-    ,fill=Site, color=Site
  geom_point(width = 0.2) + geom_line() + 
  scale_y_continuous(name="Number of Collections") +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "4 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-7),expand=c(0,0))  +
  scale_color_manual(name = "Collection Location",
                     values=c("HFH K-13 Research Clinic"="#164C71", "HFH Cancer Pavilion Research Clinic"="#FDBE19", 
                              "HFH Livonia Research Clinic"="#3C989E", "HFH Pop-Up"="#CC7D15",
                              "HFH Detroit Northwest"="#BBBEC1", "In-home Collection"="#2973A5"),
                     guide = guide_legend(nrow = 3, byrow = TRUE)) +
  labs(color = "Collection Location") +
  ggtitle(label="Figure 6.3: Baseline- Weekly Research Biospecimen Collections \n by Collection Location, Henry Ford Health") +
  theme(panel.background = element_blank(),
        #legend.title = element_text(size=9),
        legend.position = "bottom",
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) ,  #, face = "bold"
        axis.title.y = element_text(size = 14,color="black"),   #, face = "bold"
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold"))  





edited_fig3_1_Clin_tally <- clinical.survey %>% filter(Site=="Henry Ford Health") %>% 
  arrange(Clin_Site_location, col.Sunday.week,col.Monday.date) %>% 
  group_by(Clin_Site_location, col.Sunday.week,col.Monday.date) %>% tally()

research.vt_plotH_Clin <- ggplot(edited_fig3_1_Clin_tally, aes(x=as.Date(col.Monday.date), y=n, color=Clin_Site_location )) + #,fill=site, color=site)) +   #research.vt <-    ,fill=Site, color=Site
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="Number of Collections") +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "4 weeks", limits=c( as.Date("2023-05-22"),as.Date(currentDate)-7),expand=c(0,0))  +
  scale_color_manual(values=c("Wyandotte"="#B1C7D9", "Macomb"="#164C71", "West Bloomfield"="#FDBE19", "Royal Oak"="#F8D991", 
                              "Fairlane (Dearborn)"="#565C65", "Columbus"= "#3C989E", "Plymouth"="#CC7D15", "Troy"="#DAB384", "Taylor"="#7C94A8","Brownstown"="#2973A5",
                              "Livonia"="#BBBEC1", "Ford Road"="#99C0C4", "NCO"="#B9D7E3", "Sterling Heights"="#309EBD", "K1 HFH Main"="#97C4D5", "E Jefferson Pathology"="#74B0C7")) + 
  ggtitle(label="Figure 6.4: Baseline- Weekly Clinical Biospecimen Collections \n by Clinic Location, Henry Ford Health") +
  labs(color = "Clinic Location") +
  theme(panel.background = element_blank(),
        legend.title = element_text(size=8.5),
        legend.position = "bottom",
        legend.text = element_text(size = 8),
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) ,  #, face = "bold"
        axis.title.y = element_text(size = 14,color="black"),   #, face = "bold"
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) #guides(fill=guide_legend(nrow=2,byrow=TRUE))
research.vt_plotH_Clin + guides(color = guide_legend(title = "Clinic Location")) 





visit_wk_site_edited <- coll_sett_all %>% arrange(Site,Site_location,all_settings,col.Sunday.week,col.Monday.date ) %>% group_by(Site_location, Site,all_settings, col.Sunday.week,col.Monday.date) %>% tally()





research.vt_plUC= visit_wk_site_edited %>%  filter( Site=="University of Chicago Medicine")
research.vt_plUC <- research.vt_plUC %>% group_by(col.Monday.date) %>% mutate(total_collections = sum(n))
research.vt_plotUC <- ggplot(research.vt_plUC, aes(x=as.Date(col.Monday.date), y=total_collections)) + #,fill=site, color=site)) +   #research.vt <-    ,fill=Site, color=Site
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="Number of Collections") +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "4 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-7),expand=c(0,0))  +
  scale_fill_brewer(palette="Dark2") +
  ggtitle(label="Figure 6.5: Baseline- Weekly Biospecimen Collections, \n University of Chicago Medicine") +
  theme(panel.background = element_blank(),
        #legend.title = element_text(size=7),
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) ,  #, face = "bold"
        axis.title.y = element_text(size = 14,color="black"),   #, face = "bold"
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) #guides(fill=guide_legend(nrow=2,byrow=TRUE))
print(research.vt_plotUC)


visit_wk_site.hybridUC= visit_wk_site.hybrid %>%  filter( Site=="University of Chicago Medicine")
visit_wk_site.hybrid_UC <- visit_wk_site.hybridUC %>%  group_by(all_settings, col.Monday.date) %>%  summarise(totals=sum(n))
clinical.vt_plotUC <- ggplot(visit_wk_site.hybrid_UC, aes(x=as.Date(col.Monday.date), y=totals, color=all_settings )) + 
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="Number of Collections") +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-7),expand=c(0,0))  +
  scale_color_manual(values=c("Clinical"="#164C71", "Research"="#FDBE19")) +
  ggtitle(label="Figure 6.6: Baseline- Weekly Biospecimen Collections by Collection Setting, \n University of Chicago Medicine") +
  labs(color = "Collection Setting") +
  theme(panel.background = element_blank(),
        legend.position = "bottom",
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) ,  #, face = "bold"
        axis.title.y = element_text(size = 14,color="black"),   #, face = "bold"
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) #guides(fill=guide_legend(nrow=2,byrow=TRUE))
print(clinical.vt_plotUC)


research.vt_plUC= visit_wk_site_edited %>%  filter( Site=="University of Chicago Medicine" & all_settings=="Research")
research.vt_plotUC <- ggplot(research.vt_plUC, aes(x=as.Date(col.Monday.date), y=n, color=Site_location)) + #,fill=site, color=site)) +   #research.vt <-    ,fill=Site, color=Site
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="Number of Collections") +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "4 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-7),expand=c(0,0))  +
  scale_color_manual(values=c("Ingalls Harvey"="#B1C7D9", "Orland Park"="#2973A5", "River East"="#FDBE19", 
                              "South Loop"="#565C65", "UC-DCAM"="#3C989E", "UCM Pop-Up"="#CC7D15"),
                     guide = guide_legend(nrow = 2, byrow = TRUE)) +
  ggtitle(label="Figure 6.7: Baseline- Weekly Research Biospecimen Collections \n by Collection Location, University of Chicago Medicine ") +
  labs(color = "Collection Location") +
  theme(panel.background = element_blank(),
        legend.position = "bottom",
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) ,  #, face = "bold"
        axis.title.y = element_text(size = 14,color="black"),   #, face = "bold"
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) 
research.vt_plotUC + guides(color = guide_legend(title = "Collection Location")) 








edited_fig11_1_Clin_tally <- clinical.survey %>%
  filter(Site == "University of Chicago Medicine") %>% 
  arrange(Clin_Site_location, col.Sunday.week, col.Monday.date) %>%
  group_by(Clin_Site_location, col.Sunday.week, col.Monday.date) %>%
  tally()

# Complete the data to include all combinations of Clin_Site_location and dates in the range
date_range <- seq.Date(from = as.Date("2024-05-20"), to = as.Date(currentDate)-7, by = "week")
clinic_locations <- c("South Loop", "Orland Park", "Kenwood", "River East", "Dearborn Station", "Ingalls","DCAM (Hyde Park)", "Crown Point")

complete_data <- edited_fig11_1_Clin_tally %>%
  ungroup() %>%
  complete(Clin_Site_location = clinic_locations, col.Monday.date = date_range, fill = list(n = 0))

clinical.vt_plotUC_locs <- ggplot(complete_data, aes(x = as.Date(col.Monday.date), y = n, color = Clin_Site_location)) +  
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name = "Number of Collections", limits = c(0, max(complete_data$n))) +
  scale_x_date(name = "Date", date_labels = "%y-%m-%d", date_breaks = "4 weeks", limits = c(as.Date("2024-05-20"), as.Date(currentDate)-7), expand = c(0,0)) +
  scale_color_manual(values = c("Orland Park" = "#2973A5", "River East" = "#FDBE19", 
                                "South Loop" = "#565C65", "Kenwood" = "#3C989E", "Ingalls"="#B1C7D9",
                                "DCAM (Hyde Park)"="#164C71", "Dearborn Station" = "#CC7D15", "Crown Point"="#309EBD")) +
  ggtitle(label = "Figure 6.8: Baseline- Weekly Clinical Biospecimen Collections by Clinic Location, \n University of Chicago Medicine") +
  labs(color = "Clinic Location") +
  theme(panel.background = element_blank(),
        legend.position = "bottom",
        axis.line = element_line(size = 0.2),
        axis.text.x = element_text(angle = 60, hjust = 1), 
        axis.title.x = element_text(size = 14),  
        axis.title.y = element_text(size = 14, color = "black"),   
        plot.title = element_text(hjust = 0.5, size = 12, face = "bold"))

clinical.vt_plotUC_locs + guides(color = guide_legend(title = "Clinic Location"))






research.vt_plMF= visit_wk_site_edited %>%  filter( Site=="Marshfield Clinic Health System")
research.vt_plMF <- research.vt_plMF %>% group_by(col.Monday.date) %>% mutate(total_collections = sum(n))

research.vt_plotMF <- ggplot(research.vt_plMF, aes(x=as.Date(col.Monday.date), y=total_collections)) + #,fill=site, color=site)) +   #research.vt <-    ,fill=Site, color=Site
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="Number Collections") +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "4 weeks", limits=c( as.Date("2022-06-20"),(as.Date(currentDate)-7)),expand=c(0,0))  +
  scale_fill_brewer(palette="Dark2") +
  ggtitle(label="Figure 6.9 Baseline- Weekly Biospecimen Collections, \n Marshfield Clinic Health System") +
  theme(panel.background = element_blank(),
        #legend.title = element_text(size=7),
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) ,  
        axis.title.y = element_text(size = 14,color="black"),   
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) 
print(research.vt_plotMF)



research.vt_plMF1= visit_wk_site_edited %>%  filter( Site=="Marshfield Clinic Health System")
research.vt_plotMF1 <- ggplot(research.vt_plMF1, aes(x=as.Date(col.Monday.date), y=n, color=Site_location)) +
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="Number Collections") +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),(as.Date(currentDate)-7)),expand=c(0,0))  +
  #scale_fill_brewer(palette="Dark2") +
  scale_color_manual(values=c("Lake Hallie"="#B1C7D9", "Marshfield"="#164C71", "MF Pop-Up"="#FDBE19", 
                              "Minocqua"="#565C65", "Weston"="#3C989E", "Wisconsin Rapids"="#CC7D15",
                              "Neillsville"="#309EBD"),
                     guide = guide_legend(nrow = 2, byrow = TRUE)) +
  ggtitle(label="Figure 6.10: Baseline- Weekly Research Biospecimen Collections \n by Collection Location, Marshfield Clinic Health System") +
  theme(panel.background = element_blank(),
        #legend.title = element_text(text="Site Location"),
        legend.position = "bottom",
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) ,  #, face = "bold"
        axis.title.y = element_text(size = 14,color="black"),   
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) 
research.vt_plotMF1 + guides(color = guide_legend(title = "Collection Location")) 




```




```{r Figures19_20, eval=TRUE,echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 

research.vt_plSH= visit_wk_site_edited %>%  filter( Site=="Sanford Health")
research.vt_plSH <- research.vt_plSH %>% group_by(col.Monday.date) %>% mutate(total_collections = sum(n))
research.vt_plotSH <- ggplot(research.vt_plSH, aes(x=as.Date(col.Monday.date), y=total_collections)) + 
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="Number of Collections") +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "4 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-7),expand=c(0,0))  +
  scale_fill_brewer(palette="Dark2") +
  ggtitle(label="Figure 6.11: Baseline- Weekly Biospecimen Collections, \n Sanford Health") +
  labs(color = "Collection Location") +
  theme(panel.background = element_blank(),
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) ,  #, face = "bold"
        axis.title.y = element_text(size = 14,color="black"),   #, face = "bold"
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) #guides(fill=guide_legend(nrow=2,byrow=TRUE))
print(research.vt_plotSH)


visit_wk_site.hybridSF= visit_wk_site.hybrid %>%  filter( Site=="Sanford Health")
new_SF_plot <- ggplot(visit_wk_site.hybridSF, aes(x=as.Date(col.Monday.date), y=n, color=all_settings )) +
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="# Number Collections") +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "4 weeks", limits=c( as.Date("2022-06-20"),(as.Date(currentDate)-7)),expand=c(0,0))  +
  scale_color_manual(values=c("Clinical"="#164C71", "Research"="#FDBE19")) +
  ggtitle(label=paste("Figure 6.12 Baseline- Weekly Biospecimen Collections by Collection Setting \n  Sanford Health")) +
  labs(color = "Collection Setting") +
  theme(panel.background = element_blank(),
        #legend.title = element_text(size=7),
        legend.position = "bottom",
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) ,  #, face = "bold"
        axis.title.y = element_text(size = 14,color="black"),   #, face = "bold"
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) #guides(fill=guide_legend(nrow=2,byrow=TRUE))
print(new_SF_plot)



research.vt_plSH= visit_wk_site_edited %>%  filter( Site=="Sanford Health" & all_settings=="Research")
research.vt_plotSH <- ggplot(research.vt_plSH, aes(x=as.Date(col.Monday.date), y=n, color=Site_location)) + 
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="Number Collections") +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "4 weeks", limits=c( as.Date("2022-06-20"),(as.Date(currentDate)-7)),expand=c(0,0))  +
  scale_color_manual(values=c("Fargo South University"="#3C989E", "Sioux Falls Imagenetics"="#CC7D15",
                              "Edith Sanford Breast Center (coded as Sanford Center)"="#FDBE19", 
                                  "Edith Sanford Breast Center"="#2973A5","Fargo Amber Valley"="#309EBD")) +
                     #guide = guide_legend(nrow = 2, byrow = TRUE)) + 
guides(color = guide_legend(nrow = 3, byrow = TRUE, title = "Collection Location")) +
  ggtitle(label="Figure 6.13: Baseline- Weekly Research Biospecimen Collections \n by Collection Location, Sanford Health") +
  theme(panel.background = element_blank(),
        legend.title = element_text(size=8.5),
        legend.position = "bottom",
        legend.text = element_text(size = 8),
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) , 
        axis.title.y = element_text(size = 14,color="black"),   
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) 
print(research.vt_plotSH) #+ guides(color = guide_legend(title = "Collection Location")) 




research.vt_plHP= visit_wk_site.hybrid %>%  filter( Site=="HealthPartners")
research.vt_plotHP <- ggplot(research.vt_plHP, aes(x=as.Date(col.Monday.date), y=n, color=all_settings)) + 
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="Number of Collections") + 
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "4 weeks", limits=c( as.Date("2022-06-20"),as.Date(currentDate)-7),expand=c(0,0))  +
  scale_color_manual(values=c("Clinical"="#164C71", "Research"="#FDBE19")) +
  ggtitle(label="Figure 6.14: Baseline- Weekly Biospecimen Collections \n by Collection Setting, HealthPartners") +
  labs(color = "Collection Setting") +
  theme(panel.background = element_blank(),
        legend.position = "bottom",
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) , 
        axis.title.y = element_text(size = 14,color="black"),  
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold"))
print(research.vt_plotHP)




research.vt_plHP_locations <- clinical.survey %>% filter(Site=="HealthPartners") %>%
  filter(d_173836415_d_266600170_d_185243482==1 | d_173836415_d_266600170_d_452847912==1 | d_173836415_d_266600170_d_185243482==2 |
           d_173836415_d_266600170_d_452847912==2 | d_173836415_d_266600170_d_185243482==3 | d_173836415_d_266600170_d_452847912==3) %>%
  mutate(HP_cl_locs = case_when(d_173836415_d_266600170_d_185243482 == 1 | d_173836415_d_266600170_d_452847912 == 1 ~ "NSC",
                                d_173836415_d_266600170_d_185243482 == 2 | d_173836415_d_266600170_d_452847912 == 2 ~ "Elk River",
                                d_173836415_d_266600170_d_185243482 == 3 | d_173836415_d_266600170_d_452847912 == 3 ~ "Chanhassen",
                                d_173836415_d_266600170_d_185243482 == 4 | d_173836415_d_266600170_d_452847912 == 4 ~ "Park Nicollet Minneapolis Clinic",
                                d_173836415_d_266600170_d_185243482 == 6 | d_173836415_d_266600170_d_452847912 == 6 ~ "Brooklyn Center",
                                d_173836415_d_266600170_d_185243482 == 7 | d_173836415_d_266600170_d_452847912 == 7 ~ "Clinic Stillwater",
                                d_173836415_d_266600170_d_185243482 == 8 | d_173836415_d_266600170_d_452847912 == 8 ~ "New Richmond Clinic"))
edited_fig11_1_Clin_tally <- research.vt_plHP_locations %>% arrange(HP_cl_locs, col.Sunday.week,col.Monday.date) %>% group_by(HP_cl_locs, col.Sunday.week,col.Monday.date) %>% tally()

research.vt_plotHP_locs <- ggplot(edited_fig11_1_Clin_tally, aes(x=as.Date(col.Monday.date), y=n, color=HP_cl_locs)) +  
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="Number of Collections", breaks = seq(min(edited_fig11_1_Clin_tally$n), max(edited_fig11_1_Clin_tally$n), by = 1)) + #, limits=c(0,30), breaks=seq(0,30,5)) +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "4 weeks", limits=c( as.Date("2023-11-20"),as.Date(currentDate)-7),expand=c(0,0))  +
  scale_color_manual(values=c("NSC"="#99C0C4", "Elk River"="#565C65", "Chanhassen"="#CC7D15", "Park Nicollet Minneapolis Clinic"="#FDBE19",
                              "Brooklyn Center"="#3C989E", "Clinic Stillwater"="#2973A5", "New Richmond Clinic"="#E7CCAD" )) +
  ggtitle(label="Figure 6.15: Baseline- Weekly Clinical Biospecimen Collections \n  by Clinic Location, HealthPartners ") +
  labs(color = "Clinic Location") +
  theme(panel.background = element_blank(),
        legend.position = "bottom",
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) , 
        axis.title.y = element_text(size = 14,color="black"), 
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) 
research.vt_plotHP_locs + guides(color = guide_legend(title = "Clinic Location")) 





research.vt_plBSW= visit_wk_site_edited %>%  filter( Site=="Baylor Scott and White Health")
research.vt_plBSW <- research.vt_plBSW %>% group_by(col.Monday.date) %>% mutate(total_collections = sum(n))

research.vt_plotBSW <- ggplot(research.vt_plBSW, aes(x=as.Date(col.Monday.date), y=total_collections)) + #,fill=site, color=site)) +   #research.vt <-    ,fill=Site, color=Site
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="Number Collections", limits = c(0, NA)) +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "1 week", limits=c( as.Date("2024-06-24"),(as.Date(currentDate)-7)),expand=c(0,0))  +
  scale_fill_brewer(palette="Dark2") +
  ggtitle(label="Figure 6.16 Baseline- Weekly Biospecimen Collections, \n Baylor Scott and White Health") +
  theme(panel.background = element_blank(),
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) ,  
        axis.title.y = element_text(size = 14,color="black"),   
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) 
print(research.vt_plotBSW)




#research.vt_plotBSW1 <- 
  ggplot(research.vt_plBSW, aes(x=as.Date(col.Monday.date), y=n, color=Site_location)) +
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="Number Collections", limits = c(0, NA)) +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "1 week", limits=c( as.Date("2024-06-24"),(as.Date(currentDate)-7)),expand=c(0,0))  +
  #scale_fill_brewer(palette="Dark2") +
  scale_color_manual(values=c("BCC- Fort Worth"="#B1C7D9", "BCC- HWC"="#164C71", "BCC- Worth St"="#FDBE19", 
                              "FW All Saints"="#565C65", "NTX Biorepository"="#3C989E",
                              "BCC- Plano"="#FBE5B5","BCC- Irving"="#E7CCAD","Irving"="#309EBD")) +
                     #guide = guide_legend(nrow = 2, byrow = TRUE)) +
guides(color = guide_legend(nrow = 2, byrow = TRUE, title = "Collection Location"))+
  ggtitle(label="Figure 6.17: Baseline- Weekly Research Biospecimen Collections \n by Collection Location, Baylor Scott and White Health") +
  theme(panel.background = element_blank(),
        legend.position = "bottom",
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) ,  #, face = "bold"
        axis.title.y = element_text(size = 14,color="black"),   
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) 
#research.vt_plotBSW1 + guides(color = guide_legend(title = "Collection Location")) 



```



```{r Fig21_24, eval=TRUE,echo=FALSE}

knitr::opts_chunk$set(warning = FALSE, message = FALSE) 


clc_both_vt.site.CO
clc_both_vt.site.GA
clc_both_vt.site.HI
clc_both_vt.site.NW

```

\newpage

# Baseline Home Mouthwash Collections

\vspace{-0.5em}




```{r HomeMW_DataPull, include=FALSE, echo=FALSE, warning=FALSE}
#not dead of wd or refused
kitstatus <- "SELECT Connect_ID, d_173836415_d_266600170_d_319972665_d_379252329, d_173836415_d_266600170_d_319972665_d_221592017, d_173836415_d_266600170_d_319972665_d_661940160, d_265193023, d_547363263, d_173836415_d_266600170_d_448660695, d_195145666, d_286191859, d_123868967, d_906417725, d_747006172, d_987563196, d_167958071, d_878865966, d_684635302, d_827220437, d_173836415_d_266600170_d_915179629, d_914594314, d_173836415_d_266600170_d_982213346,d_173836415_d_266600170_d_139245758, d_265193023, d_253883960, d_173836415_d_266600170_d_319972665_d_826941471 
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` where Connect_ID IS NOT NULL and d_906417725='104430631'  and d_747006172='104430631' and 
d_987563196='104430631'"
kitstatus_table <- bq_project_query(project, kitstatus)
kit_table <- bq_table_download(kitstatus_table, bigint="integer64",n_max = Inf, page_size = 10000)
kit_table$Connect_ID <- as.numeric(kit_table$Connect_ID)



kitdate <- "SELECT Connect_ID, d_143615646_d_826941471, d_650516960, d_820476880, d_678166505 FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.biospecimen_JP`
where Connect_ID is not null and d_820476880 LIKE 'CHA%'"
kitdate_table <- bq_project_query(project, kitdate)
kit_data <- bq_table_download(kitdate_table, bigint="integer64",n_max = Inf, page_size = 10000)
kit_data$Connect_ID <- as.numeric(kit_data$Connect_ID)




kit_table <- kit_table %>%  mutate(Site = case_when(d_827220437==125001209 ~ "Kaiser Permanente Colorado",
                                                    d_827220437==327912200 ~ "Kaiser Permanente Georgia",
                                                    d_827220437==300267574 ~ "Kaiser Permanente Hawaii",
                                                    d_827220437==452412599 ~ "Kaiser Permanente Northwest",
                                                    d_827220437==657167265 ~ "Sanford Health",
                                                    d_827220437==548392715 ~ "Henry Ford Health",
                                                    d_827220437==531629870 ~ "HealthPartners",
                                                    d_827220437==303349821 ~ "Marshfield",
                                                    d_827220437==809703864 ~ "University of Chicago Medicine",
                                                    d_827220437==472940358 ~ "Baylor Scott and White Health"),
                                   Kit_Status = case_when(#d_173836415_d_266600170_d_319972665_d_221592017==517216441	~"Pending", -- no one will have this
                                     d_173836415_d_266600170_d_319972665_d_221592017==728267588	~"Initialized",
                                     d_173836415_d_266600170_d_319972665_d_221592017==849527480	~"Address Printed",
                                     d_173836415_d_266600170_d_319972665_d_221592017==241974920	~ "Assigned",
                                     d_173836415_d_266600170_d_319972665_d_221592017==277438316	~ "Shipped",
                                     d_173836415_d_266600170_d_319972665_d_221592017==375535639	~ "Received",
                                     is.na(d_173836415_d_266600170_d_319972665_d_221592017) ~ "No Status"))

kit_table$Kit_Status<- factor(kit_table$Kit_Status,levels=c("No Status","Initialized", "Address Printed", "Assigned", "Shipped", "Received"))

kit_date <- left_join( kit_data, kit_table,  by="Connect_ID")

kitassembly <- "SELECT * FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.kitAssembly_JP` where Connect_ID IS NOT NULL"
kitassembly_table <- bq_project_query(project, kitassembly)
kitassembly_data <- bq_table_download(kitassembly_table, bigint="integer64",n_max = Inf, page_size = 10000)
kitassembly_data$Connect_ID <- as.numeric(kitassembly_data$Connect_ID)
kit_assembly <- left_join(kitassembly_data, kit_table, by="Connect_ID")


#Removing duplicates 
kit_assembly <- kit_assembly %>%
  distinct(Connect_ID, .keep_all = TRUE)

```



```{r tbl7.1, include=FALSE, echo=FALSE, warning=FALSE}

## Merging the biospecimen table in to use this kit_sett table as a Figure later

kitsetting <- "SELECT Connect_ID, d_650516960, d_678166505,d_143615646_d_826941471  FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.biospecimen_JP`
where Connect_ID is not null "
kitsetting_table <- bq_project_query(project, kitsetting)
kit_set <- bq_table_download(kitsetting_table, bigint="integer64",n_max = Inf, page_size = 10000)
kit_set$Connect_ID <- as.numeric(kit_set$Connect_ID)


location_stat <- kit_table %>%  select(Connect_ID, Kit_Status, d_173836415_d_266600170_d_319972665_d_661940160, d_173836415_d_266600170_d_982213346,
                                       d_173836415_d_266600170_d_139245758, d_547363263, Site)
kit_sett <- left_join(location_stat, kit_set,   by="Connect_ID") #%>% left_join(recrver1,  by="Connect_ID")

#"Eligible participants” are those who had a clinical collection with blood or urine collected on or after March 29, 2024, and did not refuse, withdraw, or pass away prior to March 29, 2024. Home mouthwash collections were launched for eligible participants in March 29, 2024. Home mouthwash collections for backlog collections (before March 29, 2024) will be launched at a later date.

table27_elg <- kit_sett %>% filter((d_173836415_d_266600170_d_982213346>=as.Date("2024-03-29") & d_173836415_d_266600170_d_139245758>=as.Date("2024-03-29")))


#table27_elg$Site<- droplevels(table27_elg$Site)
table27_elg<- table27_elg %>%  filter(Kit_Status!="Unknown")

#Removing duplicates 
table27_elg_distinct <- table27_elg %>%
  distinct(Connect_ID, .keep_all = TRUE)


#clinical blood or urine given after 4/1/24
status_elg <- table27_elg_distinct %>%  
  distinct(Connect_ID, .keep_all = TRUE) %>%
  tbl_cross(
    row = Site,
    col = Kit_Status,
    digits=c(0,1),
    percent = "row",
    label=list(Site="Site",
               Kit_Status = "Kit Status"),
    missing="ifany",
    margin_text="Total Eligible") 


status_elg_kn <- status_elg %>%
  modify_header(stat_0 = "Total") %>%
  modify_caption("Table 7.1:  Baseline- Home Mouthwash Kit Status Among Eligible Participants") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE) %>%  kable_styling(latex_options = "scale_down") 


```



```{r Table_new_7.2, include=FALSE, echo=FALSE, warning=FALSE,results='hold'}

filtered_data <- filter(table27_elg_distinct, Kit_Status %in% c("Received", "Shipped"))

summary_table2_all<- filtered_data %>%
  group_by(Site) %>%
  summarise(Shipped = sum(Kit_Status %in% c("Received", "Shipped")),
            Shipped_OneWeek = sum(Kit_Status %in% c("Received", "Shipped") & 
                                    as.Date(d_173836415_d_266600170_d_319972665_d_661940160) < currentDate-7),
            Received = sum(Kit_Status == "Received"))


total_shipped <- sum(summary_table2_all$Shipped)
total_received <- sum(summary_table2_all$Received)
total_ship_previous_week <- sum(summary_table2_all$Shipped_OneWeek)
total_received_percentage <- paste(total_received, "(", round(total_received/total_ship_previous_week*100, digits = 1), "%)")
total_row <- c("Total", total_shipped, total_ship_previous_week, total_received)

# Create a new data frame for the "Total" row
total_df <- data.frame(t(total_row), stringsAsFactors = FALSE)

# Set column names
colnames(total_df) <- colnames(summary_table2_all)

# Append the "Total" row to summary_table2_all
all_shipped_2 <- rbind(summary_table2_all, total_df)


```


```{r new_Figs7.3, include=FALSE, echo=FALSE, warning=FALSE}


all_shipped_2_filtered <- all_shipped_2 %>%
  filter(Site != "Total")  %>% 
  mutate(Site = gsub("Kaiser Permanente", "KP", Site))

fig7_1 <- ggplot(all_shipped_2_filtered, aes(x = Site)) +
  geom_bar(aes(y = as.numeric(Shipped_OneWeek), fill = "Shipped"), stat = "identity", width = 0.8, position = position_dodge(width = 0.8)) +
  geom_bar(aes(y = as.numeric(Received), fill = "Received"), stat = "identity", width = 0.8, position = position_dodge(width = 0.8)) +
  scale_fill_manual(values = c("Shipped" = "#FDBE19", "Received" = "#164C71")) +
  labs(x = NULL, y = "Counts", fill = "") +
  theme_minimal() +
  theme(
    legend.position = "right",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    axis.text.x = element_text(angle = 25, vjust = 0.5, hjust = 1, size = 7),
    axis.line = element_line(color = "black", size = 0.5)
  ) +
  ggtitle("Figure 7.1. Baseline- Total Kits Received of Total Kits Shipped Up To 1 Week Ago, \n by Site")


```




```{r Table7.2_before_after, include=FALSE, echo=FALSE, warning=FALSE,results='hold'}


#### Overall Table 7.2

# Calculate percentages
for(i in 1:nrow(all_shipped_2)){
  all_shipped_2[i,"Received"] <- paste0(all_shipped_2[i,"Received"], " (", round(as.numeric(all_shipped_2[i,"Received"])/as.numeric(all_shipped_2[i,"Shipped_OneWeek"])*100, digits = 1), "%)")
}


#### BEFORE 6/17/24 -- shipments were stopped from mid may to mid June ######################   
#Adding total shipped as of a week ago column
summary_table2_before<- filtered_data %>%
  group_by(Site) %>%
  summarise(Shipped = sum(Kit_Status %in% c("Received", "Shipped") & as.Date(d_173836415_d_266600170_d_319972665_d_661940160) < "2024-06-17"),
            Shipped_OneWeek = sum(Kit_Status %in% c("Received", "Shipped") & as.Date(d_173836415_d_266600170_d_319972665_d_661940160) < "2024-06-17"),
            Received = sum(Kit_Status == "Received" & as.Date(d_173836415_d_266600170_d_319972665_d_661940160) < "2024-06-17"))


total_shipped <- sum(summary_table2_before$Shipped)
total_received <- sum(summary_table2_before$Received)
total_ship_previous_week <- sum(summary_table2_before$Shipped_OneWeek)
total_received_percentage <- paste(total_received, "(", round(total_received/total_ship_previous_week*100, digits = 1), "%)")
total_row <- c("Total", total_shipped, total_ship_previous_week, total_received) 

# Create a new data frame for the "Total" row
total_df <- data.frame(t(total_row), stringsAsFactors = FALSE)

# Set column names
colnames(total_df) <- colnames(summary_table2_before)

# Append the "Total" row to summary_table2_before
all_shipped_before <- rbind(summary_table2_before, total_df)

# Calculate percentages
for(i in 1:nrow(all_shipped_before)){
  all_shipped_before[i,"Received"] <- paste0(all_shipped_before[i,"Received"], " (", round(as.numeric(all_shipped_before[i,"Received"])/as.numeric(all_shipped_before[i,"Shipped_OneWeek"])*100, digits = 1), "%)")
  
}
all_shipped_before







#### AFTER 6/17/24######################   d_173836415_d_266600170_d_319972665_d_661940160
#Adding total shipped as of a week ago column

summary_table_after<- filtered_data %>%
  group_by(Site) %>%
  summarise(Shipped = sum(Kit_Status %in% c("Received", "Shipped") & as.Date(d_173836415_d_266600170_d_319972665_d_661940160) > "2024-06-17" &
               as.Date(d_173836415_d_266600170_d_319972665_d_661940160) <= "2024-08-28"),
            Shipped_OneWeek = sum(Kit_Status %in% c("Received", "Shipped") & as.Date(d_173836415_d_266600170_d_319972665_d_661940160) > "2024-06-17" &
                                    as.Date(d_173836415_d_266600170_d_319972665_d_661940160) <= "2024-08-28"  &
                                    as.Date(d_173836415_d_266600170_d_319972665_d_661940160) < (as.Date(currentDate) -7)),
            Received = sum(Kit_Status == "Received" & as.Date(d_173836415_d_266600170_d_319972665_d_661940160) > "2024-06-17" &
                              as.Date(d_173836415_d_266600170_d_319972665_d_661940160) <= "2024-08-28"))


total_shipped <- sum(summary_table_after$Shipped)
total_received <- sum(summary_table_after$Received)
total_ship_previous_week <- sum(summary_table_after$Shipped_OneWeek)
total_received_percentage <- paste(total_received, "(", round(total_received/total_ship_previous_week*100, digits = 1), "%)")
total_row <- c("Total", total_shipped, total_ship_previous_week, total_received)

# Create a new data frame for the "Total" row
total_df <- data.frame(t(total_row), stringsAsFactors = FALSE)

# Set column names
colnames(total_df) <- colnames(summary_table_after)

# Append the "Total" row to summary_table_after
all_shipped_after <- rbind(summary_table_after, total_df)

# Calculate percentages
for(i in 1:nrow(all_shipped_after)){
  all_shipped_after[i,"Received"] <- paste0(all_shipped_after[i,"Received"], " (", round(as.numeric(all_shipped_after[i,"Received"])/as.numeric(all_shipped_after[i,"Shipped_OneWeek"])*100, digits = 1), "%)")
  
}
all_shipped_after








###### After 8/28/24 ###################


summary_table_after2<- filtered_data %>%
  group_by(Site) %>%
  summarise(Shipped = sum(Kit_Status %in% c("Received", "Shipped") & as.Date(d_173836415_d_266600170_d_319972665_d_661940160) > "2024-08-28"),
            Shipped_TwoWeeks = sum(Kit_Status %in% c("Received", "Shipped") & as.Date(d_173836415_d_266600170_d_319972665_d_661940160) > "2024-08-28" & 
                                    as.Date(d_173836415_d_266600170_d_319972665_d_661940160) < (as.Date(currentDate) -14)),
            Received = sum(Kit_Status == "Received" & as.Date(d_173836415_d_266600170_d_319972665_d_661940160) > "2024-08-28"))


total_shipped2 <- sum(summary_table_after2$Shipped)
total_received2 <- sum(summary_table_after2$Received)
total_ship_previous_week2 <- sum(summary_table_after2$Shipped_TwoWeeks)
total_received2_percentage <- paste(total_received2, "(", round(total_received2/total_ship_previous_week2*100, digits = 1), "%)")
total_row2 <- c("Total", total_shipped2, total_ship_previous_week2, total_received2)

# Create a new data frame for the "Total" row
total_df2 <- data.frame(t(total_row2), stringsAsFactors = FALSE)

# Set column names
colnames(total_df2) <- colnames(summary_table_after2)

# Append the "Total" row to summary_table_after2
all_shipped_after2 <- rbind(summary_table_after2, total_df2)

# Calculate percentages
for(i in 1:nrow(all_shipped_after2)){
  all_shipped_after2[i,"Received"] <- paste0(all_shipped_after2[i,"Received"], " (", round(as.numeric(all_shipped_after2[i,"Received"])/as.numeric(all_shipped_after2[i,"Shipped_TwoWeeks"])*100, digits = 1), "%)")
  
}
all_shipped_after2


```





```{r Table7.3_7.6, include=FALSE, echo=FALSE, warning=FALSE}


####################
all_completed <- left_join(table27_elg_distinct,kit_assembly, by=c("Connect_ID", "Site",  "Kit_Status", "d_173836415_d_266600170_d_319972665_d_661940160", 'd_547363263'))

Coll_Card_Table <- all_completed %>% filter(d_173836415_d_266600170_d_319972665_d_221592017 ==375535639) %>% 
  mutate(Card_Status = case_when(d_137401245==353358909	~"Collection Card Not Included",
                                 TRUE ~ "Collection Card Included"))

Coll_Card_StatusBF <- Coll_Card_Table %>% dplyr::select(Site, Card_Status )  %>% tbl_cross(
  row = Site,
  col = Card_Status, 
  digits=c(0,1),
  percent = "row",
  label=list(Site ~ "Site", Card_Status ~ " "),
  missing="ifany",
  missing_text="0 (0%") %>%
  modify_header() %>%
  modify_caption("Table 7.6: Baseline- Collection Card Status Among Home Mouthwash Kits Received") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)




############
#d_265193023==231311385 --- had to remove, no one finished yet

test30 <- table27_elg %>%  filter(!is.na(d_143615646_d_826941471) & !is.na(d_173836415_d_266600170_d_319972665_d_661940160)) 

test30 <-  test30 %>% mutate(ctime = as.numeric(difftime(as.POSIXct(ymd_hms(d_143615646_d_826941471)),as.POSIXct(ymd_hms(d_173836415_d_266600170_d_319972665_d_661940160)),units="days")))

test30before <-  test30 %>%  filter(ctime>0 & d_173836415_d_266600170_d_319972665_d_661940160 < as.Date("2024-06-17"))

Table7.4before = test30before %>% group_by(Site) %>% 
  dplyr::summarize(N=n(),
                   Min = min(ctime),
                   Q1 = quantile(ctime, 0.25),
                   Median = median(ctime),
                   Mean = mean(ctime),
                   #SD=sd(ctime),
                   Q3 = quantile(ctime, 0.75),
                   #Perc.95= quantile(ctime, 0.95),
                   Max = max(ctime))

test30after <-  test30 %>%  filter(ctime>0 & d_173836415_d_266600170_d_319972665_d_661940160 > as.Date("2024-06-17"))

Table7.4after = test30after %>% group_by(Site) %>%
  dplyr::summarize(N=n(),
                   Min = min(ctime),
                   Q1 = quantile(ctime, 0.25),
                   Median = median(ctime),
                   Mean = mean(ctime),
                   #SD=sd(ctime),
                   Q3 = quantile(ctime, 0.75),
                   #Perc.95= quantile(ctime, 0.95),
                   Max = max(ctime))




#################
firstcoltime <- tube_col %>% select(Connect_ID, collection.tm)
first_col_time <- left_join(table27_elg_distinct, firstcoltime, by=c("Connect_ID", "Site"))
test31 <- first_col_time %>%  filter(!is.na(collection.tm) & !is.na(d_173836415_d_266600170_d_319972665_d_661940160)) 
test31 <-  test31 %>% mutate(ctime = as.numeric(difftime(as.POSIXct(ymd_hms(d_173836415_d_266600170_d_319972665_d_661940160)),
                                                         min(as.POSIXct(ymd_hms(collection.tm))),units="days")))
test31b <-  test31 %>%  filter(ctime>0) 


Table7.5 = test31b %>% group_by(Site) %>% 
  dplyr::summarize(N =n(),
                   Min = min(ctime),
                   Q1 = quantile(ctime, 0.25),
                   Median = median(ctime),
                   Mean = mean(ctime),
                   #SD=sd(ctime),
                   Q3 = quantile(ctime, 0.75),
                   #Perc.95= quantile(ctime, 0.95),
                   Max = max(ctime))




##################################

conditions <- all_completed[,c("Connect_ID","d_173836415_d_266600170_d_319972665_d_221592017", "d_633640710_d_950521660", "d_633640710_d_545319575", "d_633640710_d_938338155", "d_633640710_d_205954477",
                               "d_633640710_d_289239334","d_633640710_d_992420392","d_633640710_d_541085383","d_633640710_d_427719697", "d_633640710_d_100618603")]
conds <- c("d_633640710_d_950521660", "d_633640710_d_545319575", "d_633640710_d_938338155", "d_633640710_d_205954477", "d_633640710_d_289239334","d_633640710_d_992420392",
           "d_633640710_d_541085383","d_633640710_d_427719697", "d_633640710_d_100618603")
conditions$conditions <- 0
conditions$none <-0
for(i in 1:length(conds)){
  condition <- conditions[,conds[i]]
  count <- ifelse((!is.na(condition) & condition ==353358909), 1, 0)
  conditions$conditions <- count+conditions$conditions
  count1 <- ifelse((!is.na(condition) & condition==104430631), 1, 0)
  conditions$none <- count1+conditions$none
}

all_completed <- all_completed %>%
  mutate(multi_cond = 0)  # Initialize the multi_cond column with zeros

# Filter columns based on pattern
columns_to_sum <- colnames(all_completed)[grepl("d_633640710_d_", colnames(all_completed))]

# Loop through each column and apply the operation
for (col in columns_to_sum) {
  all_completed <- all_completed %>%
    mutate(multi_cond = ifelse(.data[[col]] == 353358909, 1, 0) + .data$multi_cond)
}

if(dim(table(all_completed$multi_cond))==0){multi_cond==0}



all_completed <- all_completed %>%
  mutate(multc1 = 0)  # Initialize the multc1 column with zeros

# Filter columns based on pattern
columns_to_sum <- colnames(all_completed)[grepl("d_633640710_d_", colnames(all_completed))]

# Loop through each column and apply the operation
for (col in columns_to_sum) {
  all_completed <- all_completed %>%
    mutate(multc1 = ifelse(.data[[col]] == 1, 1, 0) + .data$multc1)
}


table_32 <- all_completed %>% filter(d_173836415_d_266600170_d_319972665_d_221592017==375535639) %>%  
  mutate(kit_condition = case_when(multc1>1 & d_633640710_d_950521660!=353358909 ~ "Two of More Conditions Selected", #-- right now no one with multiple selected
                                   #d_633640710_d_950521660==353358909 ~ "Package in Good Conditon",
                                   d_633640710_d_545319575==353358909 ~ "Package Crushed",
                                   d_633640710_d_938338155==353358909 ~ "Improper Packaging",
                                   d_633640710_d_205954477==353358909 ~ "Collection Cup Damaged",
                                   d_633640710_d_289239334==353358909 ~ "Collection Cup Leaked",
                                   d_633640710_d_992420392==353358909 ~ "Empty Cup Returned",
                                   d_633640710_d_541085383==353358909 ~ "Incorrect Collection Type Returned",
                                   d_633640710_d_427719697==353358909 ~ "Collection Cup Not Returned",
                                   d_633640710_d_950521660==353358909 ~ "Package in Good Conditon",
                                   d_633640710_d_100618603==353358909 ~ "Other",
                                   TRUE ~ "No Conditions Selected"))


table__32 <- table_32 %>% select(kit_condition) %>%  group_by(kit_condition) %>%  tally()


table__32$Percentage <- paste0(
  table__32$n,
  " (",
  sprintf("%.0f%%", (table__32$n / sum(table__32$n)) * 100),
  ")"
)

db <- dim(table__32)[[1]]
table__32[(db+1),2] <- sum(table__32$n)
table__32[(db+1),1] <- "Total"
table__32[nrow(table__32),3] <- paste(table__32$n[nrow(table__32)], " (100%)")



table32_pct <- table__32[,c(1,3)]

colnames(table32_pct) <- c("Condition", "Total Received Kits")

table32_pct


```



\FloatBarrier

```{r FigMW1, include=FALSE, echo=FALSE, warning=FALSE}


#NOTE: MUST change currentDate to Mondays date in order for this to run correctly when testing for fixes
#currentDate= recent Monday date

##Received 
kit_set_col_1 <- kit_set %>% select(Connect_ID, d_143615646_d_826941471)

kit_set_col_1$col.Sunday.week <- ceiling(as.numeric(difftime(kit_set_col_1$d_143615646_d_826941471,as.Date(veristart.date-days(2)),units="days"))/7)
kit_set_col_1$col.Sunday.date <- veristart.date + days(5) + dweeks(kit_set_col_1$col.Sunday.week-1) 
kit_set_col_1$col.Monday.date <- kit_set_col_1$col.Sunday.date-days(6)

kit_fig_1 <- inner_join(kit_set_col_1,kit_table,   by="Connect_ID")

fig5_new_1 <- kit_fig_1 %>%
  filter(d_173836415_d_266600170_d_319972665_d_379252329 == 976461859 & as.Date(col.Monday.date) >= "2024-03-29" & as.Date(col.Monday.date) < currentDate)


fig5_week_total_1 <- fig5_new_1 %>%
  group_by(col.Monday.date) %>% 
  summarise(total_received = sum(!is.na(d_143615646_d_826941471)))

# Create a data frame with all Mondays from April 1st, 2024, until today
all_mondays <- data.frame(col.Monday.date = seq(as.Date("2024-04-01"), currentDate-7, by = "week"))


fig5_week_total_1 <- left_join(all_mondays, fig5_week_total_1, by = "col.Monday.date") %>%
  mutate(total_received = replace(total_received, is.na(total_received), 0))




kit_table$col.Sunday.week <- ceiling(as.numeric(difftime(kit_table$d_173836415_d_266600170_d_319972665_d_661940160,as.Date(veristart.date-days(2)),units="days"))/7)
kit_table$col.Sunday.date <- veristart.date + days(5) + dweeks(kit_table$col.Sunday.week-1) 
kit_table$col.Monday.date <- kit_table$col.Sunday.date-days(6)


fig5_new_2 <- kit_table %>%
  filter(d_173836415_d_266600170_d_319972665_d_379252329 == 976461859 & as.Date(col.Monday.date) >= "2024-03-29" & as.Date(col.Monday.date) < currentDate) 

fig5_week_total_2 <- fig5_new_2 %>%
  group_by(col.Monday.date) %>%
  summarise(total_shipped = sum(!is.na(d_173836415_d_266600170_d_319972665_d_661940160)))


fig5_week_total_2 <- left_join(all_mondays, fig5_week_total_2, by = "col.Monday.date") %>%
  mutate(total_shipped = replace(total_shipped, is.na(total_shipped), 0))



fig5_week_final <- fig5_week_total_1

fig5_week_final[,3] <- fig5_week_total_2[,2]

colnames(fig5_week_final) <- c("col.Monday.date", "total_received", "total_shipped")



MW_Coll_Kits <- ggplot(fig5_week_final, aes(x = as.Date(col.Monday.date))) +
  geom_line(aes(y = total_shipped, color = "Total Shipped"), linetype = "dashed", size = 1) +
  geom_line(aes(y = total_received, color = "Total Received"), linetype = "dashed", size = 1) +
  geom_point(aes(y = total_shipped, color = "Total Shipped"), size = 2) +
  geom_point(aes(y = total_received, color = "Total Received"), size = 2) +
  scale_y_continuous(name = "Number of Kits") +
  scale_x_date(name = "Date", date_labels = "%y-%m-%d", date_breaks = "2 weeks",
               limits = c(as.Date("2024-03-25"), as.Date(currentDate-7)), expand = c(0,0)) +
  scale_color_manual(values = c("Total Received" = "#565C65", "Total Shipped" = "#CC7D15")) +
  scale_linetype_manual(values = "dashed", name = "") +
  ggtitle(label = "Figure 7.2: Baseline- Weekly Shipped and Received Baseline Home \n Mouthwash Kits") +
  labs(color = "Kit Status") +
  theme(panel.background = element_blank(),
        legend.title = element_text(size = 8),
        legend.position = "bottom",
        axis.line = element_line(size = 0.2),
        axis.text.x = element_text(angle = 60, hjust = 1),
        axis.title.x = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 14, face = "bold", color = "black"),
        plot.title = element_text(hjust = 0.5, size = 12, face = "bold")) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE))


```



```{r FigMW2, include=FALSE, echo=FALSE, warning=FALSE}


fig5_week_total2 <- fig5_week_final %>%
  arrange(col.Monday.date) %>%
  mutate(cumulative_shipped = cumsum(total_shipped),
         cumulative_received = cumsum(total_received))

fig5_week_total2 <- fig5_week_total2 %>%
  mutate(percentage_received_to_shipped = round(cumulative_received / cumulative_shipped * 100, digits=2))


#Percentage they want is the total received as of today/total shipped as of end of week prior
thus_far <- round(sum(as.numeric(all_shipped_2_filtered$Received))/sum(as.numeric(all_shipped_2_filtered$Shipped_OneWeek))*100, digits=2)


MW_overtime <- ggplot(fig5_week_total2, aes(x = as.Date(col.Monday.date))) +
  geom_ribbon(aes(ymin = 0, ymax = cumulative_shipped, fill = "Total Shipped"), alpha = 0.3) +
  geom_ribbon(aes(ymin = 0, ymax = cumulative_received, fill = "Return Rate"), alpha = 0.3) +
  geom_text(data = fig5_week_total2 %>% filter(col.Monday.date == max(col.Monday.date)),
            aes(x = as.Date(col.Monday.date), 
                label = paste0(thus_far, "%")),
            y = thus_far, vjust = -0.5, hjust = 1.2,  color = "black",  size = 3) +
  scale_x_date(name = "Date", date_labels = "%y-%m-%d", date_breaks = "2 weeks",
               limits = c(as.Date("2024-03-25"), as.Date(currentDate-7)), expand = c(0,0)) +
  scale_y_continuous(name = "# Kits Shipped") +
  scale_fill_manual(name = "", values = c("Total Shipped" = "#CC7D15", "Return Rate" = "#0072B2")) +
  ggtitle(label = "Figure 7.3: Baseline− Home Mouthwash Kit Return Rate \n for Kits Shipped Up To 1 Week Ago") +
  labs(caption = paste("Note: Shipped data are current through",as.Date(currentDate)-7, ".")) +
  theme(panel.background = element_blank(),
        legend.position = "bottom",
        axis.line = element_line(size = 0.2),
        axis.text.x = element_text(angle = 60, hjust = 1),
        axis.title.x = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 14, face = "bold", color = "black"),
        plot.title = element_text(hjust = 0.5, size = 12, face = "bold"))


```




\FloatBarrier
```{r newTables7.1,eval=TRUE,echo=FALSE,results='asis'} 
#results='asis'

add_footnote(status_elg_kn, "Note: “Eligible participants” are those who had a clinical collection with blood or urine collected on or after March 29, 2024, and did not refuse, withdraw, or pass away prior to April 2024. Home mouthwash collections were launched for eligible participants in April 2024. Home mouthwash collections for backlog collections (before April 2024) will be launched at a later date.", notation = "none") 
```

\FloatBarrier
```{r KnitrTables7.2,eval=TRUE,echo=FALSE,message=FALSE, warning = FALSE, results='asis'}

knitr::kable(all_shipped_2,format.args = list(big.mark = ","),
             caption='Table 7.2 Baseline- Total Home Mouthwash Kit Return Rate for Packages Shipped up to 1 Week Ago',
             row.names=FALSE, align=c("l","c","c","c"),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "HOLD_position")

```

\FloatBarrier
```{r KnitrTables7.2before,eval=TRUE,echo=FALSE,message=FALSE, warning = FALSE, results='asis'}

table7_2before <- knitr::kable(all_shipped_before,
                               caption='Table 7.3 Baseline- Home Mouthwash Kit Return Rate for Packages Shipped up to 1 Week Ago (kits shipped before 6/17/2024)',
                               row.names=FALSE, align=c("l","c","c","c"),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "HOLD_position")
add_footnote(table7_2before, "Note: During this time the kit return method was USPS.", notation = "none")

```


\FloatBarrier

```{r KnitrTables7.2after,eval=TRUE,echo=FALSE,message=FALSE, warning = FALSE, results='asis'}

table7_2after <- knitr::kable(all_shipped_after,format.args = list(big.mark = ","),
                              caption='Table 7.4 Baseline- Home Mouthwash Kit Return Rate for Packages Shipped up to 1 Week Ago \n (kits shipped between 6/17/2024 and 8/28/2024)',
                              row.names=FALSE, align=c("l","c","c","c"),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "HOLD_position")
add_footnote(table7_2after, "Note: During this time the kit return method was FedEx; Query for addresses to print pulled oldest clinical collection date/time stamp first.", notation = "none")


```

\FloatBarrier

```{r Shipped_After_August,eval=TRUE,echo=FALSE,message=FALSE, warning = FALSE, results='asis'}

table7_2after2 <- knitr::kable(all_shipped_after2,format.args = list(big.mark = ","),
                              caption='Table 7.5 Baseline- Home Mouthwash Kit Return Rate for Packages Shipped up to 2 Weeks Ago (kits shipped after 8/28/2024)',
                              row.names=FALSE, align=c("l","c","c","c"),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "HOLD_position")
add_footnote(table7_2after2, "Query for addresses to print was updated on 8/28/2024 to pull most recent clinical collection date/time stamp first, with a 5 day lag from date of clinical blood/urine collection date. Kit return method remained as FedEx.", notation = "none")

```



\FloatBarrier
```{r Fig7_1, eval=TRUE,echo=FALSE}
#fig.height = 5, fig.width = 5, 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 

fig7_1

```


\FloatBarrier
```{r Fig7_2, eval=TRUE,echo=FALSE}
#fig.height = 5, fig.width = 5, 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 

MW_Coll_Kits

```

\FloatBarrier
```{r Fig7_3, eval=TRUE,echo=FALSE}
#fig.height = 5, fig.width = 5, 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
MW_overtime

```

\FloatBarrier
```{r KnitrTables7.3_7.4,eval=TRUE,echo=FALSE,error=FALSE, message=FALSE, results='asis'}

Coll_Card_StatusBF %>% kable_styling(latex_options = "HOLD_position")


```



\FloatBarrier
```{r KnitrTables7.5_7.8,eval=TRUE,echo=FALSE,error=FALSE, message=FALSE, results='asis'}


#all these will move down a table number
table7.4before <- knitr::kable(Table7.4before,
                               caption='Table 7.7: Baseline- Time (in Days) from Home Mouthwash Kit Shipment to BPTL Receipt \n (kits shipped before 6/17/2024)',
                               row.names=FALSE, align=c("l","c","c","c","c","c","c"),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "HOLD_position")
add_footnote(table7.4before, "Note: Kits were returned using USPS prior to 6/17/2024.", notation = "none")



table7.4after <- knitr::kable(Table7.4after,
                              caption='Table 7.8: Baseline- Time (in Days) from Home Mouthwash Kit Shipment to BPTL Receipt \n (kits shipped after 6/17/2024)',
                              row.names=FALSE, align=c("l","c","c","c","c","c","c"),digits=1, booktabs = TRUE) %>% kable_styling(latex_options = "HOLD_position")
add_footnote(table7.4after, "Note: Kits were returned using FedEx after 6/17/2024.", notation = "none")



knitr::kable(Table7.5,
             caption='Table 7.9: Baseline- Time (in Days) from Clinical Collection to Home Mouthwash Kit Shipment',
             row.names=FALSE, align=c("l","c","c","c","c","c","c"),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "HOLD_position")


knitr::kable(table32_pct,
             caption='Table 7.10: Baseline- Kit Conditions Among Received Home Mouthwash Kits',
             row.names=FALSE, align=c("l","c"),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "HOLD_position")
```






\FloatBarrier

```{r Tables7.9_7.12, eval=TRUE,echo=FALSE,results='asis'}

table7_7 <- table27_elg_distinct %>% filter(Kit_Status=="Shipped") %>% 
  mutate(MWSrvy_status = case_when(d_547363263==972455046 ~ "Not Started",
                                   d_547363263==615768760 ~ "Started",
                                   d_547363263==231311385 ~ "Submitted")) %>%  
  mutate(MWSrvy_status = factor(MWSrvy_status, levels=c("Not Started","Started", "Submitted"))) %>% dplyr::select(Site, MWSrvy_status )  %>% 
  tbl_cross(
    row = Site,
    col = MWSrvy_status,
    digits=c(0,1),
    percent = "row",
    label=list(Site="Site",
               MWSrvy_status = "Survey Status"),
    missing="ifany",
    margin_text="Total")

table7_7_totals <- as.data.frame(table7_7)
table7_7_totals <- table7_7_totals[c(-1),]


tab7_7 <- knitr::kable(table7_7_totals ,
                       col.names=c("Site", "Not Started","Started","Submitted","Total Kits in 'Shipped' Status"), 
                       caption="Table 7.11: Baseline- Mouthwash Biospecimen Survey Status Among Mouthwash Kits in 'Shipped' Status", 
                       row.names=FALSE,align=c("l","c","c","c","c"), booktabs = TRUE)

num_rows <- nrow(table7_7_totals)
tab7_7 <- tab7_7 %>%
  row_spec(1:(num_rows - 1), extra_css = "text-indent: 20px;")

kable_styling(tab7_7, latex_options = "scale_down")











table7_8 <- table27_elg_distinct %>%  filter(Kit_Status=="Received") %>%
  mutate(MWSrvy_status = case_when(d_547363263==972455046 ~ "Not Started",
                                   d_547363263==615768760 ~ "Started",
                                   d_547363263==231311385 ~ "Submitted")) %>%  
  mutate(MWSrvy_status = factor(MWSrvy_status, levels=c("Not Started","Started", "Submitted"))) %>% dplyr::select(Site, MWSrvy_status )  %>% 
  tbl_cross(
    row = Site,
    col = MWSrvy_status,
    digits=c(0,1),
    percent = "row",
    label=list(Site="Site",
               MWSrvy_status = " "),
    missing="ifany",
    margin_text="Total")

table7_8_totals <- as.data.frame(table7_8)
table7_8_totals <- table7_8_totals[c(-1),]


tab7_8 <- knitr::kable(table7_8_totals ,
                       col.names=c("Site", "Not Started","Started","Submitted","Total Received Kits"), 
                       caption='Table 7.12: Baseline- Mouthwash Biospecimen Survey Status Among Received Home Mouthwash Kits', 
                       row.names=FALSE,align=c("l","c","c","c","c"), booktabs = TRUE)  %>% kable_styling(latex_options = "scale_down")


num_rows <- nrow(table7_8_totals)
tab7_8 <- tab7_8 %>%
  row_spec(1:(num_rows - 1), extra_css = "text-indent: 20px;")

kable_styling(tab7_8, latex_options = "scale_down")










#Before MW Survey description Fix

table7_9 <- all_completed %>% filter(Kit_Status=="Received" & d_137401245==104430631 &  as.Date(d_173836415_d_266600170_d_319972665_d_661940160)<"2024-05-22") %>%
  mutate(MWSrvy_status = case_when(d_547363263==972455046 ~ "Not Started",
                                   d_547363263==615768760 ~ "Started",
                                   d_547363263==231311385 ~ "Submitted"),
         MW_completion = difftime(as.Date(d_173836415_d_266600170_d_448660695),as.Date(d_195145666),units="days"),
         MW_comp_diff= case_when(MWSrvy_status!="Submitted" ~ "Not Submitted",
                                 #as.numeric(MW_completion) <-3 ~ "4+ Days before Collection",
                                 as.numeric(MW_completion) ==-3 ~ "3 Days before Collection",
                                 as.numeric(MW_completion) ==-2 ~ "2 Days before Collection",
                                 as.numeric(MW_completion) ==-1 ~ "1 Day before Collection",
                                 as.numeric(MW_completion)==0 ~ "Same Day as Collection",
                                 as.numeric(MW_completion)==1 ~ "1 Day after Collection",
                                 as.numeric(MW_completion)==2 ~ "2 Days after Collection",
                                 as.numeric(MW_completion)==3 ~ "3 Days after Collection",
                                 as.numeric(MW_completion)>=4 ~ "4+ Days after Collection",
                                 TRUE~"4+ Days before Collection")) %>%
  mutate(MW_comp_diff = factor(MW_comp_diff, levels=c("Not Submitted","4+ Days before Collection", "3 Days before Collection","2 Days before Collection","1 Day before Collection",
                                                      "Same Day as Collection","1 Day after Collection", "2 Days after Collection",
                                                      "3 Days after Collection", "4+ Days after Collection"))) %>% dplyr::select(Site, MW_comp_diff)  %>%
  tbl_cross(
    row = Site,
    col = MW_comp_diff,
    digits=c(0,1),
    percent = "row",
    label=list(Site="Site",
               MW_comp_diff = " "),
    missing="ifany",
    margin_text="Total")



tbl_7_9 <- table7_9 %>%
  #bold_labels() %>%
  #italicize_levels() %>%
  modify_header(stat_0 = "Total") %>%
  modify_caption("Table 7.13: Baseline- Mouthwash Biospecimen Survey Completion Time Relative to Collection Time Reported on Collection Card \n(Pre-update to survey description on PWA)") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE) %>%
  kable_styling(latex_options = "scale_down")


tbl_7_9 <- tbl_7_9 %>%
  footnote("Only includes data from mouthwash kits returned with completed Collection Card")

landscape(tbl_7_9)




#After MW Survey description Fix
table7_10 <- all_completed %>% filter(Kit_Status=="Received" & d_137401245==104430631 &  as.Date(d_173836415_d_266600170_d_319972665_d_661940160)>"2024-05-22") %>%
  mutate(MWSrvy_status = case_when(d_547363263==972455046 ~ "Not Started",
                                   d_547363263==615768760 ~ "Started",
                                   d_547363263==231311385 ~ "Submitted"),
         MW_completion = difftime(as.Date(d_173836415_d_266600170_d_448660695),as.Date(d_195145666),units="days"),
         MW_comp_diff= case_when(MWSrvy_status!="Submitted" ~ "Not Submitted",
                                 #as.numeric(MW_completion) <=-4 ~ "4+ Days before Collection",
                                 as.numeric(MW_completion) ==-3 ~ "3 Days before Collection",
                                 as.numeric(MW_completion) ==-2 ~ "2 Days before Collection",
                                 as.numeric(MW_completion) ==-1 ~ "1 Day before Collection",
                                 as.numeric(MW_completion)==0 ~ "Same Day as Collection",
                                 as.numeric(MW_completion)==1 ~ "1 Day after Collection",
                                 as.numeric(MW_completion)==2 ~ "2 Days after Collection",
                                 as.numeric(MW_completion)==3 ~ "3 Days after Collection",
                                 as.numeric(MW_completion)>=4 ~ "4+ Days after Collection", 
                                 TRUE~"4+ Days before Collection")) %>%
  mutate(MW_comp_diff = factor(MW_comp_diff, levels=c("Not Submitted","4+ Days before Collection", "3 Days before Collection","2 Days before Collection","1 Day before Collection",
                                                      "Same Day as Collection","1 Day after Collection", "2 Days after Collection",
                                                      "3 Days after Collection", "4+ Days after Collection"))) %>% 
  dplyr::select(Site, MW_comp_diff)  %>%
  tbl_cross(
    row = Site,
    col = MW_comp_diff,
    digits=c(0,1),
    percent = "row",
    label=list(Site="Site",
               MW_comp_diff = " "),
    missing="ifany",
    margin_text="Total")



tbl_7_10 <- table7_10 %>%
  #bold_labels() %>%
  #italicize_levels() %>%
  modify_header(stat_0 = "Total") %>%
  modify_caption("Table 7.14: Baseline- Mouthwash Biospecimen Survey Completion Time Relative to Collection Time Reported on Collection Card \n (Post-update to survey description on PWA)") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE) %>%
  kable_styling(latex_options = "scale_down")

tbl_7_10 <- tbl_7_10 %>%
  footnote("Only includes data from mouthwash kits returned with completed Collection Card")

landscape(tbl_7_10)


```
