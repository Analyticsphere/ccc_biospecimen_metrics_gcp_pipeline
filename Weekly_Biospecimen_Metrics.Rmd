
---
title: "Biospecimen Weekly Metrics RMD"
author: "Kelsey Dowling"
date: "Data Extracted and Report Ran: `r Sys.Date()`"
header-includes:  
    \usepackage[labelformat=empty]{caption}
    \usepackage{placeins}


output:
  pdf_document:
    extra_dependencies: ["float"]
    toc: true
    toc_depth: 2
    keep_tex: yes
    fig_width: 7
    fig_height: 5
    fig_caption: true
    latex_engine: xelatex
    df_print: paged 
---



```{r setup,eval=TRUE,include=FALSE,echo=FALSE, warning=FALSE}


#old.packages()
#update.packages()  


library(bigrquery)
library(data.table) ###to write or read and data management 
library(dplyr) ###data management
# library(boxr) ###read or write data from/to box
library(tidyverse) ###for data management
library(reshape)  ###to work on transition from long to wide or wide to long data
library(listr) ###to work on a list of vector, files or..
library(sqldf) ##sql
library(lubridate) ###date time
library(ggplot2) ###plots
#library(ggpubr) ###for the publications of plots
library(RColorBrewer) ###visions color http://www.sthda.com/english/wiki/colors-in-r
library(gridExtra)
library(stringr) ###to work on patterns, charaters
#library(plyr)
library(tinytex) #for pdf
library(rmarkdown) ###for the output tables into other files: pdf, rtf, etc.
library(janitor) #to get the summary sum
library(finalfit) #https://cran.r-project.org/web/packages/finalfit/vignettes/export.html t
library(expss) ###to add labels
library(epiDisplay) ##recommended applied here crosstable, tab1
library(summarytools) ##recommended
library(gmodels) ##recommended
library(magrittr)
library(arsenal)
library(gtsummary)
library(kableExtra)
library(gt)
library(crosstable)
library(cowplot)
library(webshot2)
library(glue) 
#options(knitr.table.format = "latex")
currentDate <- Sys.Date()

bq_auth()

### Set Box folders for output CSV files #######################################
use_test_box_folder <- TRUE # Local user sets this (Jake or Kelsey)

# Over-ride if using plumber api on GCP (USER DOESN'T TOUCH THIS!)
# Check if the environment variable exists and is not empty
if (!is.null(Sys.getenv("USE_TEST_BOX_FOLDER")) &&
    Sys.getenv("USE_TEST_BOX_FOLDER") != "") {
  use_test_box_folder <- as.logical(Sys.getenv("USE_TEST_BOX_FOLDER"))
}

if (use_test_box_folder) {
  boxfolder <- 221458210866 # test box folder
} else {
  boxfolder <- 221280601453 # destination of CSV files (not pdf)
}

################################################################################
```

```{r, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}
##import data to R

project <- "nih-nci-dceg-connect-prod-6d04"
billing <- "nih-nci-dceg-connect-prod-6d04" ##project and billing should be consistent
bio_tb <- bq_project_query(project, query='SELECT * FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.biospecimen_JP` where d_410912345 is not null')  
biospe <- bq_table_download(bio_tb,bigint="integer64")
cnames <- names(biospe)
###to check variables in recr_noinact_wl1

numbers_only <- function(x) !grepl("\\D", x)

for (i in 1: length(cnames)){
  varname <- cnames[i]
  var<-pull(biospe,varname)
  biospe[,cnames[i]] <- ifelse(numbers_only(var), as.numeric(as.character(var)), var)
}
tb_box <- bq_project_query(project, query="SELECT * FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.boxes_JP`")
box_wl_flat <- bigrquery::bq_table_download(tb_box,bigint = "integer64")
#y <- read_table(urlfile1,header = TRUE, sep = "\t", na.strings = c("NA","N/A",""),fill = TRUE, quote='')
library(rio)
dictionary <- rio::import("https://episphere.github.io/conceptGithubActions/aggregate.json",format = "json")
dd<-rbindlist(dictionary,fill=TRUE,use.names=TRUE,idcol="CID") #THIS TABLE HAS REPLICATED (CIDS+LABELS) WITH DIFFERENT VARIABLE NAMES,
# dd <- as.data.frame(do.call("rbind",dictionary))
# colnames(dd) <- c("Variable Label", "Variable Name")
# dd$CID <- rownames(dd)
box_CID <- as.data.frame(as.numeric(sapply((strsplit(colnames(box_wl_flat),"d_")),tail,1)))
box_CID$variable <- colnames(box_wl_flat)
colnames(box_CID)[1] <-"CID"
box_CID_dd <- merge(box_CID, dd,by="CID",all.x=TRUE)
#to convert the numeric variables
numbers_only <- function(x) !grepl("\\D", x)
 cnames <- names(box_wl_flat)
 ###to check variables in recr_noinact_wl1
 data2 <- box_wl_flat
 for (i in 1: length(cnames)){
   varname <- cnames[i]
   var<-pull(data2,varname)
   data2[,cnames[i]] <- ifelse(numbers_only(var), as.numeric(as.character(var)), var)
 }
# 
pct_tb <- function(x,y){
  table1 <- CrossTable(x,y, prop.t=FALSE, prop.r=FALSE, prop.c=TRUE,chisq=FALSE)
  pct <- as.data.frame(cbind(table1$prop.row,table1$t))
  if(ncol(pct)==2){
    total <- as.numeric(sum(pct[,2]))
    pct[nrow(pct)+1,c(1:2)] <- c(1,total)
    rownames(pct)[nrow(pct)] <- "Total"
    colnames(pct)[1] <- paste0("pct_",colnames(pct)[1])
    colnames(pct)[2] <- paste0("n_",colnames(pct)[2])
    
  }
  else  if(ncol(pct)>2 ){
    total <- as.numeric(sum(pct[,3] + pct[,4]))
    pct[nrow(pct)+1,c(1:4)] <- c(sum(pct[,3])/total,sum(pct[,4])/total,sum(pct[,3]),sum(pct[,4]))
    rownames(pct)[nrow(pct)] <- "Total"
    colnames(pct)[c(1:2)] <- paste0("pct_",colnames(pct[c(1:2)]))
    colnames(pct)[c(3:4)] <- paste0("n_",colnames(pct)[c(3:4)])
  
    pct[,5] <- paste0(format(pct[,3],big.mark=","), " (",round(100*pct[,1],1), " %)")
    pct[,6] <- paste0(format(pct[,4],big.mark=","), " (",round(100*pct[,2],1), " %)") 
    colnames(pct)[5] <- paste0("n_",colnames(pct)[1])
    colnames(pct)[6] <- paste0("n_",colnames(pct)[2])
  }
return(pct)
}
##to select biospecimen data in recruitment 
recr_var <- bq_project_query(project, query="SELECT * FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect`.INFORMATION_SCHEMA.COLUMN_FIELD_PATHS WHERE table_name='participants_JP'")
recrvar <- bigrquery::bq_table_download(recr_var,bigint = "integer64")
urlfile<- "https://raw.githubusercontent.com/episphere/conceptGithubActions/master/csv/masterFile.csv" ###to grab the updated dd from github 
y <- read.csv(urlfile)
recrvar_nd <- recrvar[which(grepl("d_",recrvar$column_name)),c("column_name","field_path")]
recrvar_nd$last.CID <- ifelse(grepl("d_",recrvar_nd$column_name),substring(sapply(strsplit(recrvar_nd$column_name,"d_"),tail,1),1,9),NA)
recrvar_nd_label <- merge(recrvar_nd, y[,c("Primary.Source","conceptId.2","conceptId.3","Variable.Label","conceptId.4")],by.x="last.CID",by.y="conceptId.3",all.x=TRUE)
recrvar.bio <- recrvar_nd_label[which(recrvar_nd_label$Primary.Source == "Biospecimen" | grepl("biospecimen|blood|urine|mouthwash|collection",recrvar_nd_label$Variable.Label)),] #49
query <- recrvar.bio$column_name
select <- paste(recrvar.bio$column_name,collapse=",")
tb_bq <- eval(parse(text=paste("bq_project_query(project, query=\"SELECT token,Connect_ID,d_512820379,d_821247024,d_914594314,d_827220437,d_699625233, date,", select,"FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` Where d_821247024 = '197316935' \")",sep=" ")))
 
recr.bio <- bigrquery::bq_table_download(tb_bq,bigint = "integer64")
##below are the commone variables in the recruitment table on Biospecimen to apply for the analysis. In case any new variables popping up, i would like #to use the one above directly from the resources (master DD and recruitment table schema to get the most updated version on this biospecimen data
# tb <- bq_project_query(project, query="SELECT d_512820379,d_512820379, d_821247024, d_914594314, d_822499427, d_222161762, Connect_ID, d_827220437, token,d_265193023, d_878865966, d_167958071, d_684635302, d_253883960, d_534669573, d_764863765, d_331584571_d_266600170_d_135591601,d_331584571_d_266600170_d_840048338,  d_331584571_d_266600170_d_343048998, d_173836415_d_266600170_d_139245758, d_173836415_d_266600170_d_185243482,
# d_173836415_d_266600170_d_198261154, d_173836415_d_266600170_d_210921343, d_173836415_d_266600170_d_224596428,
# d_173836415_d_266600170_d_316824786, d_173836415_d_266600170_d_341570479, d_173836415_d_266600170_d_398645039,
# d_173836415_d_266600170_d_448660695, d_173836415_d_266600170_d_452847912, d_173836415_d_266600170_d_453452655,
# d_173836415_d_266600170_d_530173840, d_173836415_d_266600170_d_534041351, d_173836415_d_266600170_d_541311218,
# d_173836415_d_266600170_d_561681068, d_173836415_d_266600170_d_592099155, d_173836415_d_266600170_d_611091485,
# d_173836415_d_266600170_d_646899796, d_173836415_d_266600170_d_693370086, d_173836415_d_266600170_d_718172863,
# d_173836415_d_266600170_d_728696253, d_173836415_d_266600170_d_740582332, d_173836415_d_266600170_d_769615780,
# d_173836415_d_266600170_d_786930107, d_173836415_d_266600170_d_822274939, d_173836415_d_266600170_d_847159717,
# d_173836415_d_266600170_d_860477844, d_173836415_d_266600170_d_915179629, d_173836415_d_266600170_d_939818935,
# d_173836415_d_266600170_d_951355211, d_173836415_d_266600170_d_982213346 FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` WHERE d_821247024 = '197316935'")
##to convert to numeric
cnames <- names(recr.bio)
recrver <- recr.bio
for (i in 1: length(cnames)){
  varname <- cnames[i]
  var<-pull(recrver,varname)
  recrver[,cnames[i]] <- ifelse(numbers_only(var), as.numeric(as.character(var)), var)
}
##to get the labels of each variable
recrver_CID <- as.data.frame(sapply((strsplit(colnames(recrver),"d_")),tail,1))
colnames(recrver_CID)[1] <- "CID"
recrver_CID$variable <- names(recr.bio)
recrver_ver1 <- merge(dd,recrver_CID,by="CID")
recrver1 <- expss::apply_labels(recrver,
                        d_512820379 = "Recruitment type",#RcrtSI_RecruitType_v1r0
                        d_512820379=c(	"Not active"=180583933,  
                                       "Active"= 486306141, 
                                       "Passive"=854703046),
                        d_821247024 = "Verification status", #RcrtV_Verification_v1r0
                        d_821247024 = c("Not yet verified" =875007964,
                                        "Verified"=197316935,  
                                        "Cannot be verified"=219863910, 
                                        "Duplicate"=922622075 , 
                                        "Outreach timed out"= 160161595),
                        d_827220437 = "Site",#RcrtES_Site_v1r0
                        d_827220437 = c("HealthPartners"= 531629870, "Henry Ford Health System"=548392715,"Marshfield Clinic Health System" = 303349821,"Sanford Health" = 657167265, "University of Chicago Medicine" = 809703864,"Kaiser Permanente Colorado" = 125001209,"Kaiser Permanente Georgia" = 327912200,"Kaiser Permanente Hawaii" = 300267574,"Kaiser Permanente Northwest" = 452412599,"National Cancer Institute" = 517700004,"National Cancer Institute" = 13,"Other" = 181769837),
                        d_914594314 = "Verification status time",   #RcrtV_VerificationTm_V1R0
                        d_878865966 = "Baseline blood sample collected", #BioFin_BaseBloodCol_v1r0
                        d_878865966 = c("Any blood collected"=353358909, "No blood collected"=104430631),
                        d_173836415_d_266600170_d_561681068 = "Date/time basline Research Blood Collected",#BL_BioFin_BBTime_v1r0
                        d_684635302 = "Baseline Mouthwash Collected",    #BioFin_BaseMWCol_v1r0
                        d_684635302 = c("Any mouthwash collected"=353358909,"No mouthwash collected"= 104430631  ),
                        d_173836415_d_266600170_d_448660695 = "Date/time Mouthwash Collected", #
                        d_167958071 = "Baseline Urine collected", 
                        d_167958071 = c( "Any urine collected"=353358909, "No urine collected"=104430631),
                        d_173836415_d_266600170_d_847159717 = "Baseline Date/time Urine collected",
                        d_331584571_d_266600170_d_135591601 = "Baseline Check-In Complete",#BL_BioChk_Complete_v1r0
                        d_331584571_d_266600170_d_135591601 =  c( "No"=104430631, "Yes"=353358909 ),
                        d_331584571_d_266600170_d_840048338 = "Date/Time Baseline Check-In Complete",
                        d_331584571_d_266600170_d_343048998 = "Time Baseline check out complete",#
                        
                        d_173836415_d_266600170_d_530173840 = "Blood Order Placed",#BioClin_BldOrderPlaced_v1r0  ## I ADDED
                        d_173836415_d_266600170_d_530173840 =c( "No"=104430631, "Yes"=353358909 ), ## I ADDED
                        
                        d_173836415_d_266600170_d_592099155 = "Blood Collection Setting",#BL_BioSpm_BloodSetting_v1r0  
                        d_173836415_d_266600170_d_592099155 =c("Research"=534621077, "Clinical"= 664882224,"Home" =103209024),
                        d_173836415_d_266600170_d_718172863 = "Urine Collection Setting",#BL_BioSpm_UrineSetting_v1r0
                        d_173836415_d_266600170_d_718172863 =c("Research"=534621077, "Clinical"= 664882224,"Home" =103209024),
                        d_173836415_d_266600170_d_915179629 = "Mouthwash Collection Setting",#BL_BioSpm_MWSetting_v1r0
                        d_173836415_d_266600170_d_915179629 =c("Research"=534621077, "Clinical"= 664882224,"Home" =103209024),
                        
                        d_265193023 = "Blood/urine/mouthwash combined research survey-Complete",   
                        d_265193023 = c(	"Not Started" =	972455046, "Started"= 615768760,"Submitted"= 231311385),#SrvBLM_ResSrvCompl_v1r0
                        d_822499427 = "Placeholder (Autogenerated) - Date/time Status of Start of blood/urine/mouthwash research survey",#SrvBLM_TmStart_v1r0
                        d_222161762  = "Placeholder (Autogenerated)- Date/Time blood/urine/mouthwash research survey completed" #   SrvBLM_TmComplete_v1r0
)
###to convert to categorical variables
recrver1$RcrtSI_RecruitType_v1r0 <- factor(recrver1$d_512820379, exclude=NULL)
recrver1$RcrtV_Verification_v1r0 <- factor(recrver1$d_821247024, exclude=NULL)
recrver1$BioFin_BaseMWCol_v1r0  <-factor(recrver1$d_684635302,exclude=NULL)
recrver1$BioFin_BaseBloodCol_v1r0 <- factor(recrver1$d_878865966,exclude=NULL)
recrver1$BioFin_BaseUrineCol_v1r0 <- factor(recrver1$d_167958071,exclude=NULL)

recrver1$BioClin_BldOrderPlaced_v1r0 <- factor(recrver1$d_173836415_d_266600170_d_530173840,exclude=NULL) ## I ADDED

recrver1$SrvBLM_ResSrvCompl_v1r0 <-factor(recrver1$d_265193023,exclude=NULL)
recrver1$BL_BioSpm_MWSetting_v1r0 <- factor(recrver1$d_173836415_d_266600170_d_915179629,levels=c("Clinical","Research","Home"))  
recrver1$BL_BioSpm_UrineSetting_v1r0 <- factor(recrver1$d_173836415_d_266600170_d_718172863, levels=c("Clinical","Research","Home"))  
recrver1$BL_BioSpm_BloodSetting_v1r0 <- factor(recrver1$d_173836415_d_266600170_d_592099155,levels=c("Clinical","Research","Home"))  
recrver1$BL_BioChk_Complete_v1r0 <- factor(recrver1$d_331584571_d_266600170_d_135591601,exclude=NULL)
recrver1$Site <-factor(recrver1$d_827220437,levels=c("HealthPartners", "Henry Ford Health System","Marshfield Clinic Health System",
                             "Sanford Health", "University of Chicago Medicine","Kaiser Permanente Colorado",
                             "Kaiser Permanente Georgia","Kaiser Permanente Hawaii","Kaiser Permanente Northwest",
                             "National Cancer Institute","Other"))
recrver1<- recrver1 %>% mutate(BldCollection = ifelse(recrver1$BioFin_BaseBloodCol_v1r0 == 353358909, "YES", "No"))


##to check the duplicate collection by verified participants Connect_ID
biospe[duplicated(biospe$Connect_ID),c("Connect_ID","d_820476880","d_410912345","d_387108065")]
biospe[duplicated(biospe$Connect_ID),"Connect_ID"]
biospe$Connect_ID[duplicated(biospe$Connect_ID)]
dupid <- biospe$Connect_ID[duplicated(biospe$Connect_ID)]
#biospe[which(biospe$Connect_ID %in% dupid),c("Connect_ID","d_820476880","d_410912345","d_387108065","d_143615646_d_593843561","d_973670172_d_593843561")]
##the biospecimen concepts for the biospecimen variablesbles
biospe_var <- as.data.frame((colnames(biospe)))
colnames(biospe_var)[1] <- "variable"
biospe_var$cid1 <- sapply(strsplit(colnames(biospe),"_"), "[", 2)
biospe_var$cid2 <- sapply(strsplit(colnames(biospe),"_"), "[", 4)
biospe_var$cid3 <- sapply(strsplit(colnames(biospe),"_"), "[", 6)
biospe_var$cid_tail <- sapply(strsplit(colnames(biospe),"_"), tail,1)
biospe_CID <- dd[which(dd$CID %in% CID),]
biospe_dd<- merge(biospe_var,biospe_CID,by.x="cid_tail",by.y="CID", all.x=TRUE)
tubes <- dd[grepl(" Tube ",dd$`Variable Label`),]
urine <- dd[grepl("Urine",dd$`Variable Label`),]
mouthwash <- dd[grepl("Mouthwash",dd$`Variable Label`),]



```


This Weekly Metrics report contains tables and plots for the Connect Biospecimen samples, many stratified by health provider site. This information pertains to verified participants as of the date above and collections that are final.
 

\newpage
\FloatBarrier
# Tables



```{r, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}


## Tables 1-4

#### FOR TABLES 1-4 I CHANGED NO SAMPLES COLLECTED TO BE NO COLLECTED SAMPLES AND ALSO THAT THE PARTICIPANTS DID HAVE A COLLECTION APPOINTMENT, SO THAT THOSE WHO HAVEN'T EVEN SCHEDULEN AN APPT YET ARE NOT COUNTED IN THE NO SAMPLES COLLECTED COLUMN

#sapply((strsplit(colnames(recrver),"d_")),tail,1)
###table1 Percent (and number) of verified participants with baseline biospecimen collections by site
##for any biospecimen collections
recrver1 <- recrver1 %>% mutate(BiospeCollection = ifelse((recrver1$d_684635302 == 353358909 | recrver1$d_878865966 == 353358909| recrver1$d_167958071 == 353358909), "Any biospecimen Collections","No biospecimen collections"))

recrver1$Site<- droplevels(recrver1$Site)


 
bio.appoint <- biospe %>% arrange(Connect_ID, d_410912345) %>% group_by(Connect_ID) %>% summarise(d_410912345=mean(d_410912345,na.rm=TRUE)) #to remove the multiple collections by Connect_ID
 
biocol.tb <- merge(recrver1[,c("Connect_ID","Site","BiospeCollection","d_878865966","d_684635302","d_167958071")],bio.appoint,by.x="Connect_ID",by.y="Connect_ID",all.x=TRUE )
 
table1 <- biocol.tb %>% 
  mutate(appointment = ifelse((d_410912345!= 353358909 | is.na(d_410912345)), 104430631, 353358909),
         biocol.appoint = case_when(BiospeCollection == "Any biospecimen Collections" ~ "Any Collections",
                                    BiospeCollection == "No biospecimen collections" & d_410912345==353358909 ~ "No Collections but had an Appointment",
                                    BiospeCollection == "No biospecimen collections" & is.na(d_410912345) ~ "No Collections No Appointment")) %>% 
  mutate(biocol.appoint = factor(biocol.appoint, levels=c("Any Collections","No Collections but had an Appointment","No Collections No Appointment"))) %>% dplyr::select(Site, biocol.appoint )  %>% 
  tbl_cross(
    row = Site,
    col = biocol.appoint,
    digits=c(0,1),
    percent = "row",
    label=list(Site="Site",
               biocol.appoint = "Baseline Biospecimen Collections"),
    missing="ifany",
    margin_text="Total Verified Participants") 
 
 
table1[["table_body"]]$stat_0 <- sapply(strsplit(table1[["table_body"]]$stat_0," "),"[",1)
 
table1 <- table1%>%
  #bold_labels() %>%
  #italicize_levels() %>% 
  modify_header(stat_0 = "Total Verified \n Participants") %>%
  modify_caption("Table 1. Baseline Biospecimen Collections Among Verified Participants") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)
 
biocol <- c("d_878865966","d_167958071","d_684635302")      
bio <- c("Blood","Urine","Mouthwash")
 
biocol.tbs <- list()
 
for (i in 1:3){
  table <- biocol.tb %>% select(Site,d_410912345,contains(biocol[i]))
  names(table)[3] <- "var"
  table <- table %>% mutate(appointment = ifelse((d_410912345!= 353358909 | is.na(d_410912345)), 104430631, 353358909),
                            biocol.appoint = case_when(var == 353358909  ~ paste("Any",bio[i], "Collections",sep=" "),
                                                       (var == 104430631 | is.na(var)) & d_410912345==353358909 ~ paste("No",bio[i],"Collections but had an Appointment",sep =" "),
                                                       (var == 104430631 | is.na(var)) & is.na(d_410912345) ~ paste("No",bio[i], "Collections No Appointment",sep=" "))) %>%
    mutate(biocol.appoint <- factor(biocol.appoint, levels=c(glue("Any {bio[i]} Collected \", \"No {bio[i]} Collected \n (Collection Visit)\",  \"No {bio[i]} Collected \n (No Collection Visit)")))) %>% dplyr::select(Site, biocol.appoint )  %>% 
    tbl_cross(
      row = Site,
      col = biocol.appoint,
      digits=c(0,1),
      percent = "row",
      label=list(Site="Site",
                 biocol.appoint = paste("Baseline", bio[i], "Collections",sep=" ")),
      missing="ifany",
      margin_text="Total Verified Participants") 
  
  
  table[["table_body"]]$stat_0 <- sapply(strsplit(table[["table_body"]]$stat_0," "),"[",1)
  biocol.tbs[[i]] <- table%>%
    #bold_labels() %>%
    #italicize_levels() %>% 
    modify_header(stat_0 = "Total",
    ) %>%
    modify_caption(paste("Table", i+1, ". Baseline", bio[i], "Collections Among Verified Participants",sep=" ")) %>% 
    as_kable_extra(escape = FALSE, addtl_fmt = TRUE)
}
```

 
```{r, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}
table1
for (i in 1:3){print(biocol.tbs[[i]])}


biospe.t1 <- table1
biospe.bld <- biocol.tbs[[1]]
biospe.urine <- biocol.tbs[[2]]
biospe.mw <- biocol.tbs[[3]]


```





```{r, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}
# ### Table 1
# biocol <- c("BiospeCollection","BioFin_BaseBloodCol_v1r0","BioFin_BaseUrineCol_v1r0","BioFin_BaseMWCol_v1r0")
# biocol.tbs <- list()
# for (i in 1:4){
#    tmp <- eval(parse(text=paste("pct_tb(recrver1$Site,recrver1$",biocol[i],")",sep="")))
#    tmp <- tmp[,grepl("n_",colnames(tmp))]
#    tmp$site <- rownames(tmp)
#    biocol.tbs[[i]] <- tmp
# } 



```


```{r, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

# 
# biospe.t1 <- biocol.tbs[[1]]
#  biospe.t1$Total <- biospe.t1$`n_Any biospecimen Collections` + biospe.t1$`n_No biospecimen collections`
# # biospe.t1$`n_pct_Any biospecimen Collections` <- ifelse(biospe.t1$site != "Total", biospe.t1$`n_pct_Any biospecimen Collections`, format(biospe.t1$`n_Any biospecimen Collections`,big.mark=","))
# # 
# # biospe.t1$`n_pct_No biospecimen collections` <- ifelse(biospe.t1$site != "Total", biospe.t1$`n_pct_No biospecimen collections`, format(biospe.t1$`n_No biospecimen collections`,big.mark=","))
# 
# colnames(biospe.t1) <- gsub("n_pct_", "",colnames(biospe.t1))
# # Total <- as.data.frame(biospe.t1[which(biospe.t1$site=="Total"),c("site","n_pct_Any biospecimen Collections","n_pct_No biospecimen collections","Total")])
# # Total$`n_pct_Any biospecimen Collections` <- sapply(strsplit(Total$`n_pct_Any biospecimen Collections`, " "), "[", 1)
# # Total$`n_pct_No biospecimen collections` <- sapply(strsplit(as.character(Total$`n_pct_No biospecimen collections`), " "), "[", 1)
# 
# View(biospe.t1)
# 
# 
# 
# 
# ###Table 2
# #blood
# biospe.bld <- biocol.tbs[[2]]
# #biospe.bld$`n_pct_No blood collected` <- ifelse(biospe.bld$site != "Total", biospe.bld$`n_pct_No blood collected`, format(biospe.bld$`n_No blood collected`,big.mark=","))
# 
# # biospe.bld$`n_pct_Any blood collected` <- ifelse(biospe.bld$site != "Total", biospe.bld$`n_pct_Any blood collected`, format(biospe.bld$`n_Any blood collected`,big.mark=","))
#  biospe.bld$Total <- biospe.bld$`n_No blood collected` + biospe.bld$`n_Any blood collected`
# 
# colnames(biospe.bld) <- gsub("n_pct_", "",colnames(biospe.bld))
# 
# 
# 
# ###Table 3
# #urine
# biospe.urine <- biocol.tbs[[3]]
# # biospe.urine$`n_pct_No urint collected` <- ifelse(biospe.urine$site != "Total", biospe.urine$`n_pct_No urine collected`, format(biospe.urine$`n_No urine collected`,big.mark=","))
# # 
# # biospe.urine$`n_pct_Any urine collected` <- ifelse(biospe.urine$site != "Total", biospe.urine$`n_pct_Any urine collected`, format(biospe.urine$`n_Any urine collected`,big.mark=","))
#  biospe.urine$Total <- biospe.urine$`n_No urine collected` + biospe.urine$`n_Any urine collected`
# 
# colnames(biospe.urine) <-  gsub("n_pct_", "",colnames(biospe.urine))
# 
# 
# 
# 
# ### Table 4
# #mouthwash
# biospe.mw <- biocol.tbs[[4]]
# # biospe.mw$`n_pct_No mouthwash collected` <- ifelse(biospe.mw$site != "Total", biospe.mw$`n_pct_No mouthwash collected`, format(biospe.mw$`n_No mouthwash collected`,big.mark=","))
# # 
# # biospe.mw$`n_pct_Any mouthwash collected` <- ifelse(biospe.mw$site != "Total", biospe.mw$`n_pct_Any mouthwash collected`, format(biospe.mw$`n_Any mouthwash collected`,big.mark=","))
#  biospe.mw$Total <- biospe.mw$`n_No mouthwash collected` + biospe.mw$`n_Any mouthwash collected`
# 
# colnames(biospe.mw) <- gsub("n_pct_", "",colnames(biospe.mw))
# 
# 
# 
# 
# 
# 
# #option2.
# Table1_biospecol <- recrver1 %>% dplyr::select(Site, BiospeCollection )  %>% tbl_cross(
#   row = Site,
#   col = BiospeCollection,
#   digits=c(0,2),
#   percent = "row",
#   label=list(Site="Site",
#              BiospeCollection = "Baseline Biospecimen Collections"),
#   missing="ifany") %>%
#   #bold_labels() %>%
#   #italicize_levels() %>% 
#   modify_header() %>%
#   modify_caption("table1 Number (and percent) of verified participants with any baseline biospecimen collections by site") %>%
#   as_kable_extra(escape = FALSE, addtl_fmt = TRUE)
# table(recrver1$Site)
# t_site <- as.data.frame(tab1(recrver1$Site)[[2]])
# explanatory = "Site"
# dependent = 'BiospeCollection'
# recrver1 %>%
#   summary_factorlist(dependent, explanatory, 
#                      p=FALSE, add_dependent_label=TRUE) -> t1
# colnames(t1)[2] <- "Site"
# t1_all <- merge(t1, t_site, by.x="Site",by.y="row.names",all.y=TRUE)
# t1_all[1,c(3,4)] <- table(recrver1$BiospeCollection)
# t1_all1 <- t1_all[c(4:7,2,3,8:10,1),c(1,4,3,5)]
# colnames(t1_all1)[4] <- "Total"
# ###Table 2-previous Percent (and number) of verified participants with baseline blood collected by site
# Table2_bldcol <- recrver1 %>% dplyr::select(Site, BioFin_BaseBloodCol_v1r0 )  %>% tbl_cross(
#   row = Site,
#   col = BioFin_BaseBloodCol_v1r0,
#   percent = "row",
#   digits=c(0,2),
#   label=list(Site~"Site", BioFin_BaseBloodCol_v1r0 ~ "Baseline Blood Collections" ),
#   missing="ifany",
#   missing_text="Unknown") %>%
#   #bold_labels() %>%
#   #italicize_levels() %>% 
#   modify_header() %>%
#   modify_caption("Table 2. Number (and percent) of verified participants with baseline blood collected by site") %>%
#   as_kable_extra(escape = FALSE, addtl_fmt = TRUE)
# ###Table 3-previous Percent (and number) of verified participants with baseline Urine collected by site
# Table3_urincol <- recrver1 %>% dplyr::select(Site, BioFin_BaseUrineCol_v1r0 )  %>% tbl_cross(
#   row = Site,
#   col = BioFin_BaseUrineCol_v1r0,
#   percent = "row",
#   digits=c(0,2),
#   label=list(Site~"Site", BioFin_BaseUrineCol_v1r0 ~ "Baseline Urine Collections" ),
#   missing="ifany",
#   missing_text="Unknown") %>%
#   #bold_labels() %>%
#   #italicize_levels() %>% 
#   modify_header(label ~ "Baseline Urine Collections") %>%
#   modify_caption("Table 3. Number (and percent) of verified participants with baseline Urine collected by site") %>%
#   as_kable_extra(escape = FALSE, addtl_fmt = TRUE)
# ##option 2 for table 3
# recrver1 = apply_labels(recrver1,
#                         Site = "Site",
#                         BioFin_BaseUrineCol_v1r0 = "Baseline Urine collected"
# )
# #t_site$freq_pct <- paste0(t_site$Frequency," (",t_site$Percent, "%)")
# table(recrver1$Site)
# explanatory = "Site"
# dependent = 'BioFin_BaseUrineCol_v1r0'
# recrver1 %>%
#   summary_factorlist(dependent, explanatory, 
#                      p=FALSE, add_dependent_label=TRUE) -> t4
# colnames(t4)[2] <- "Site"
# t4_all <- merge(t4, t_site, by.x="Site",by.y="row.names",all.y=TRUE)
# t4_all[1,c(3,4)] <- table(recrver1$BioFin_BaseUrineCol_v1r0)
# t4_all1 <- t4_all[c(4:7,2,3,8:10,1),c(1,4,3,5)]
# ##Table 4-previous
# Table4_mwcol <- recrver1 %>% dplyr::select(Site, BioFin_BaseMWCol_v1r0 )  %>% tbl_cross(
#   row = Site,
#   col = BioFin_BaseMWCol_v1r0,
#   percent = "row",
#   digits=c(0,2),
#   label=list(Site~"Site", BioFin_BaseMWCol_v1r0 ~ "Baseline Mouthwash Collections" ),
#   missing="ifany",
#   missing_text="Unknown") %>%
#   #bold_labels() %>%
#   #italicize_levels() %>% 
#   modify_header() %>%
#   modify_caption("Table 4. Percent (and number) of verified participants with baseline mouthwash collected by site") %>%
#   as_kable_extra(escape = FALSE, addtl_fmt = TRUE)
# #otption 2
# explanatory = "Site"
# dependent = 'BioFin_BaseMWCol_v1r0'
# recrver1 = apply_labels(recrver1,
#                         Site = "Site",
#                         BioFin_BaseMWCol_v1r0 = "Baseline Mouthwash collected"
# )
# recrver1 %>%
#   summary_factorlist(dependent, explanatory, 
#                      p=FALSE, add_dependent_label=TRUE) -> t3
# colnames(t3)[2] <- "Site"
# t3_all <- merge(t3, t_site, by.x="Site",by.y="row.names",all.y=TRUE)
# t3_all[1,c(3,4)] <- table(recrver1$BioFin_BaseMWCol_v1r0)
# t3_all1 <- t3_all[,-c(2,6:7)]
# colnames(t3_all1)[4] <- "Total"
# #  t3$Site <- t3$Site %>% replace_na('Total')
# #t3$'Any biospecimen Collected'[t3$'Any Mouthwash Collected' == ''] <- "0 (0.0)"
# 
# 
# 
# 


#Table 5.
settings <- recrvar.bio[grepl("Setting",recrvar.bio$Variable.Label),]$column_name
setting <- c("BL_BioSpm_BloodSetting_v1r0","BL_BioSpm_UrineSetting_v1r0","BL_BioSpm_MWSetting_v1r0")
bio <- c("d_878865966","d_167958071","d_684635302")
col_set <- list()
for (i in 1:3){
tmp <-eval(parse(text=paste("pct_tb(recrver1$",setting[i],",recrver1$",bio[i],")",sep="")))
tmp <- tmp %>% select(contains("n_Any")) %>% 
  mutate(Setting = trimws(rownames(tmp)))
col_set[[i]] <- tmp 
}
biosettings <- col_set %>% reduce(full_join,by="Setting")
biosettings[4,c(1:4)] <- c("0", "Home",  "0", "0")
biosettings[1,4] <- "0"
biosettings <- biosettings[order(biosettings$Setting),c(2,1,3,4)] 
colnames(biosettings)[2:4] <- gsub("n_","",colnames(biosettings)[2:4])
#View(biosettings)

bioset <- biosettings


#View(bioset)

a5<- round(as.numeric(as.character(bioset[1,2]))/ as.numeric(as.character(bioset[4,2])), digits=3)*100
b5 <- round(as.numeric(as.character(bioset[1,3]))/ as.numeric(as.character(bioset[4,3])), digits=3)*100
c5 <- round(as.numeric(as.character(bioset[1,4]))/ as.numeric(as.character(bioset[4,4])), digits=3)*100
d5 <- round(as.numeric(as.character(bioset[2,2]))/ as.numeric(as.character(bioset[4,2])), digits=2) *100
e5<- round(as.numeric(as.character(bioset[2,3]))/ as.numeric(as.character(bioset[4,3])), digits=2)*100
f5 <- round(as.numeric(as.character(bioset[2,4]))/ as.numeric(as.character(bioset[4,4])), digits=2)*100
g5 <- round(as.numeric(as.character(bioset[3,2]))/ as.numeric(as.character(bioset[4,2])), digits=3)*100
h5 <- round(as.numeric(as.character(bioset[3,3]))/ as.numeric(as.character(bioset[4,3])), digits=3)*100
i5 <- round(as.numeric(as.character(bioset[3,4]))/ as.numeric(as.character(bioset[4,4])), digits=3)*100


bioset[1,2] <- paste0(bioset[1,2], " (", a5, "%)")
bioset[1,3]  <- paste0(bioset[1,3], " (", b5, "%)")
bioset[1,4]  <- paste0(bioset[1,4], " (", c5, "%)")
bioset[2,2] <- paste0(bioset[2,2], " (", d5, "%)")
bioset[2,3]  <- paste0(bioset[2,3], " (", e5, "%)")
bioset[2,4]  <- paste0(bioset[2,4], " (", f5, "%)")
bioset[3,2] <- paste0(bioset[3,2], " (", g5, "%)")
bioset[3,3] <- paste0(bioset[3,3], " (", h5, "%)")
bioset[3,4]  <- paste0(bioset[3,4], " (", i5, "%)")

bioset[4,2] <- paste0(bioset[4,2] , " (100%)")
bioset[4,3] <- paste0(bioset[4,3], " (100%)")
bioset[4,4] <- paste0(bioset[4,4], " (100%)")


#View(biocol)





 ## ON HOLD-- retest
#Table 5.1 -- Henry Ford Only

settings <- recrvar.bio[grepl("Setting",recrvar.bio$Variable.Label),]$column_name
setting <- c("BL_BioSpm_BloodSetting_v1r0","BL_BioSpm_UrineSetting_v1r0","BL_BioSpm_MWSetting_v1r0")
bio <- c("d_878865966","d_167958071","d_684635302")
col_set5 <- list()
for (i in 1:3){
  recrver1_5_1 <- recrver1 %>%  filter(Site=="Henry Ford Health System") #& BL_BioSpm_BloodSetting_v1r0=="Clinical" & BL_BioSpm_UrineSetting_v1r0=="Clinical" & BL_BioSpm_MWSetting_v1r0=="Clinical"
tmp <-eval(parse(text=paste("pct_tb(recrver1_5_1$",setting[i],",recrver1_5_1$",bio[i],")",sep="")))
#tmp <- tmp %>%
tmp <- tmp %>% select(contains("n_Any")) %>%  mutate(Setting = trimws(rownames(tmp)))
col_set5[[i]] <- tmp
}
biosettings5_1 <- col_set5 %>% reduce(full_join,by="Setting")
biosettings5_1[4,c(1:4)] <- c("0", "Home",  "0", "0")
biosettings5_1[1,4] <- "0"
biosettings5_1 <- biosettings5_1[order(biosettings5_1$Setting),c(2,1,3,4)]
colnames(biosettings5_1)[2:4] <- gsub("n_","",colnames(biosettings5_1)[2:4])
#View(biosettings5_1)

bioset5_1 <- biosettings5_1


#View(bioset5_1)

a5<- round(as.numeric(as.character(bioset5_1[1,2]))/ as.numeric(as.character(bioset5_1[4,2])), digits=3)*100
b5 <- round(as.numeric(as.character(bioset5_1[1,3]))/ as.numeric(as.character(bioset5_1[4,3])), digits=3)*100
c5 <- round(as.numeric(as.character(bioset5_1[1,4]))/ as.numeric(as.character(bioset5_1[4,4])), digits=3)*100
d5 <- round(as.numeric(as.character(bioset5_1[2,2]))/ as.numeric(as.character(bioset5_1[4,2])), digits=2) *100
e5<- round(as.numeric(as.character(bioset5_1[2,3]))/ as.numeric(as.character(bioset5_1[4,3])), digits=2)*100
f5 <- round(as.numeric(as.character(bioset5_1[2,4]))/ as.numeric(as.character(bioset5_1[4,4])), digits=2)*100
g5 <- round(as.numeric(as.character(bioset5_1[3,2]))/ as.numeric(as.character(bioset5_1[4,2])), digits=3)*100
h5 <- round(as.numeric(as.character(bioset5_1[3,3]))/ as.numeric(as.character(bioset5_1[4,3])), digits=3)*100
i5 <- round(as.numeric(as.character(bioset5_1[3,4]))/ as.numeric(as.character(bioset5_1[4,4])), digits=3)*100


bioset5_1[1,2] <- paste0(bioset5_1[1,2], " (", a5, "%)")
bioset5_1[1,3]  <- paste0(bioset5_1[1,3], " (", b5, "%)")
bioset5_1[1,4]  <- paste0(bioset5_1[1,4], " (", c5, "%)")
bioset5_1[2,2] <- paste0(bioset5_1[2,2], " (", d5, "%)")
bioset5_1[2,3]  <- paste0(bioset5_1[2,3], " (", e5, "%)")
bioset5_1[2,4]  <- paste0(bioset5_1[2,4], " (", f5, "%)")
bioset5_1[3,2] <- paste0(bioset5_1[3,2], " (", g5, "%)")
bioset5_1[3,3] <- paste0(bioset5_1[3,3], " (", h5, "%)")
bioset5_1[3,4]  <- paste0(bioset5_1[3,4], " (", i5, "%)")

bioset5_1[4,2] <- paste0(bioset5_1[4,2] , " (100%)")
bioset5_1[4,3] <- paste0(bioset5_1[4,3], " (100%)")
bioset5_1[4,4] <- paste0(bioset5_1[4,4], " (100%)")


#View(bioset5_1)















###Table 6 Baseline biospecimen collection status among verified participants research collection
levels(recrver1$BioFin_BaseBloodCol_v1r0)

biocol <- recrver1   %>%  group_by(BioFin_BaseBloodCol_v1r0,BioFin_BaseUrineCol_v1r0,BioFin_BaseMWCol_v1r0) %>% dplyr::tally()   #%>% filter(d_410912345==353358909)

biocol$BioFin_BaseBloodCol_v1r0= ifelse(biocol$BioFin_BaseBloodCol_v1r0=="Any blood collected", "Yes", "No")
biocol$BioFin_BaseUrineCol_v1r0= ifelse(biocol$BioFin_BaseUrineCol_v1r0=="Any urine collected", "Yes", "No")
biocol$BioFin_BaseMWCol_v1r0= ifelse(biocol$BioFin_BaseMWCol_v1r0=="Any mouthwash collected", "Yes", "No")

total <- nrow(recrver1)
biocol$pct <- round(100*biocol$n/nrow(recrver1),digits=1)
#biocol$cumcount <- cumsum(biocol$n)
#biocol$cumpct <- round(100*cumsum(biocol$n)/nrow(recrver1),digits=1)

# biocol <- apply_labels(biocol, total,
#                        pct="percentage of Total verified %")
#                        #cumcount="cumulative counts of verified",
#                        #cumpct="cumulative percentage")

db <- dim(biocol)[[1]]
#biocol <- as_kable(biocol)
func <- function(z) {ifelse(is.numeric(z), round(sum(z), digits=0),'')}
sumrow <- as.data.frame(lapply(biocol, func))
#kable(rbind(df, sumrow))
biocol[,5]
biocol[(db+1),] <- sumrow
biocol[(db+1),1] <- "Total"
biocol[(db+1),2] <- "-"
biocol[(db+1),3] <- "-"

colnames(biocol) <- c("Any Blood Collected","Urine Collected","Mouthwash Collected","Number","Percent")
#View(biocol)

#biocol$n = ifelse(!grepl("Total",rownames(biocol)),  paste(format(biocol[,4],big.mark=","),"(", round(100*biocol[,4],1),"%)",sep=" "))
#biocol$pct = ifelse(!grepl("Total",rownames(biocol)),  paste(format(biocol[,5],big.mark=","),"(", round(100*biocol[,5],1),"%)",sep=" "))

#View(biocol)


# biocol_gt <- biocol %>%  gt() %>%  
#   fmt_number(columns = "pct", decimals = 2) %>%
#     tab_header(title = md("Table 6. Baseline Biospecimen Collection Status Among Verified Participants")) %>% 
#   cols_label(n= md("**Number**"), BioFin_BaseBloodCol_v1r0=md("**Any Blood Collected**"), BioFin_BaseUrineCol_v1r0=md("**Urine Collected**"), BioFin_BaseMWCol_v1r0=md("**Mouthwash Collected**"), pct = md("**Percent**")) %>% 
#   summary_rows(
#     column = c(n, pct),
#     fns= list(
#       Sum= ~sum(.)
#     ), decimals=0) %>%
#   tab_options(
#       stub.font.weight = "bold"
#     ) %>%
#   tab_style(
#     style = list(
#       cell_text(weight = "bold")
#     ),
#     locations = cells_body(
#       columns = c(BioFin_BaseBloodCol_v1r0, BioFin_BaseUrineCol_v1r0, BioFin_BaseMWCol_v1r0),
#     )
#   ) %>%  tab_footnote(footnote="Note: Based on data entered into the Connect Biospecimen Dashboard")
# 
# biocol_gt

# kk<- cbind(as.table(data.frame(biocol)),as.matrix(apply(biocol,1,sum)))
# dd<-rbind(data.frame(biocol),apply(biocol,2,sum))
# 
# rownames(dd)<-c(rownames(dd)[-8],"Total")

#biocol= biocol %>%  adorn_totals()


###Table 6. by site
biocol.site <- list()
recrver1$Site <- droplevels(recrver1$Site)
for(site in unique(recrver1$Site)){
  
  site.sub <- recrver1 %>% filter(Site==site) %>% 
    group_by(BioFin_BaseBloodCol_v1r0,BioFin_BaseUrineCol_v1r0,BioFin_BaseMWCol_v1r0) %>% dplyr::tally() 
  
  site.sub$BioFin_BaseBloodCol_v1r0= ifelse(site.sub$BioFin_BaseBloodCol_v1r0=="Any blood collected", "Yes", "No")
  site.sub$BioFin_BaseUrineCol_v1r0= ifelse(site.sub$BioFin_BaseUrineCol_v1r0=="Any urine collected", "Yes", "No")
  site.sub$BioFin_BaseMWCol_v1r0= ifelse(site.sub$BioFin_BaseMWCol_v1r0=="Any mouthwash collected", "Yes", "No")
  
  total <- as.numeric(nrow(recrver1[which(recrver1$Site==site),]))
  site.sub$pct <- round(100*site.sub$n/total,digits=1)
  
ds <- dim(site.sub)[[1]]
func <- function(z) {ifelse(is.numeric(z), round(sum(z), digits=0),'')}
sumrow <- as.data.frame(lapply(site.sub, func))
#kable(rbind(df, sumrow))
#site.sub[,5]
site.sub[(ds+1),] <- sumrow
site.sub[(ds+1),1] <- "Total"
site.sub[(ds+1),2] <- "-"
site.sub[(ds+1),3] <- "-"

  
  #site.sub$cumcount <- cumsum(site.sub$n)
  #site.sub$cumpct <- round(100*cumsum(site.sub$n)/total,digits=1)
  biocol.site[[site]] <- site.sub

}






##Updated table 6 (a and b) Now includes all sites but is split by collection setting
b6 <- biospe %>%  select(Connect_ID, d_650516960, d_410912345)

spec_collt <- recrver1 %>%  select(Connect_ID, Site, BioFin_BaseBloodCol_v1r0,BioFin_BaseUrineCol_v1r0,BioFin_BaseMWCol_v1r0)

rb_table6 <- left_join(spec_collt, b6, by="Connect_ID")

#rb_table6$Site <- droplevels(rb_table6$Site)
  
site.sub1 <- rb_table6 %>% filter(d_410912345==353358909) 
  
  
site.sub <- site.sub1 %>%  mutate(Setting = case_when(d_650516960==534621077 ~ "Research Collections",
                                                        d_650516960==664882224 ~ "Clinical Collections",
                                                        TRUE ~ "No Collections"),
                                'Specimens Collected'= case_when((BioFin_BaseBloodCol_v1r0=="Any blood collected" & BioFin_BaseUrineCol_v1r0=="Any urine collected" & BioFin_BaseMWCol_v1r0=="Any mouthwash collected") ~ 'Blood, Urine, Mouthwash (All)',
                                                                 (BioFin_BaseBloodCol_v1r0=="Any blood collected" & BioFin_BaseUrineCol_v1r0=="Any urine collected" & BioFin_BaseMWCol_v1r0!="Any mouthwash collected") ~ 'Blood & Urine Only',
                                                                 (BioFin_BaseBloodCol_v1r0=="Any blood collected" & BioFin_BaseUrineCol_v1r0!="Any urine collected" & BioFin_BaseMWCol_v1r0=="Any mouthwash collected") ~ 'Blood & Mouthwash Only',
                                                                 (BioFin_BaseBloodCol_v1r0!="Any blood collected" & BioFin_BaseUrineCol_v1r0=="Any urine collected" & BioFin_BaseMWCol_v1r0=="Any mouthwash collected") ~ 'Urine & Mouthwash Only',
                                                                 (BioFin_BaseBloodCol_v1r0=="Any blood collected" & BioFin_BaseUrineCol_v1r0!="Any urine collected" & BioFin_BaseMWCol_v1r0!="Any mouthwash collected") ~ 'Blood Only',
                                                                 (BioFin_BaseBloodCol_v1r0!="Any blood collected" & BioFin_BaseUrineCol_v1r0=="Any urine collected" & BioFin_BaseMWCol_v1r0!="Any mouthwash collected") ~ 'Urine Only',
                                                                 (BioFin_BaseBloodCol_v1r0!="Any blood collected" & BioFin_BaseUrineCol_v1r0!="Any urine collected" & BioFin_BaseMWCol_v1r0=="Any mouthwash collected") ~ 'Mouthwash Only',
                                                                 (BioFin_BaseBloodCol_v1r0!="Any blood collected" & BioFin_BaseUrineCol_v1r0!="Any urine collected" & BioFin_BaseMWCol_v1r0!="Any mouthwash collected") ~ 'No Specimens Collected'))
site.sub$'Specimens Collected' <- factor(site.sub$'Specimens Collected',levels=c('Blood, Urine, Mouthwash (All)', 'Blood & Urine Only','Blood & Mouthwash Only','Urine & Mouthwash Only','Blood Only','Urine Only','Mouthwash Only','No Specimens Collected'))

table6_redone__R <- site.sub %>% filter(Setting=="Research Collections") 
table6_redone__R$Site <- droplevels(table6_redone__R$Site)
table6_redone__R$'Specimens Collected' <- droplevels(table6_redone__R$'Specimens Collected')
table6_redoneR <- table6_redone__R %>% dplyr::select('Specimens Collected', Site )  %>% 
  tbl_cross(
    row = 'Specimens Collected',
    col = Site,
    digits=c(0,1),
    percent = "row",
    # label=list(Site="",
    #            biocol.appoint = ""),
    missing="ifany",
    margin_text="Total")

table6_redoneR <- table6_redoneR%>%
  #bold_labels() %>%
  #italicize_levels() %>% 
  modify_header(stat_0 = "Total") %>%
  modify_caption("Table 6.a Baseline Research Collection Completeness by Site") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)




site.sub <- site.sub1 %>%  mutate(Setting = case_when(d_650516960==534621077 ~ "Research Collections",
                                                        d_650516960==664882224 ~ "Clinical Collections",
                                                        TRUE ~ "No Collections"),
                                'Specimens Collected'= case_when((BioFin_BaseBloodCol_v1r0=="Any blood collected" & BioFin_BaseUrineCol_v1r0=="Any urine collected" & BioFin_BaseMWCol_v1r0!="Any mouthwash collected") ~ 'Blood & Urine (All)',
                                                                 (BioFin_BaseBloodCol_v1r0=="Any blood collected" & BioFin_BaseUrineCol_v1r0!="Any urine collected" & BioFin_BaseMWCol_v1r0!="Any mouthwash collected") ~ 'Blood Only',
                                                                 (BioFin_BaseBloodCol_v1r0!="Any blood collected" & BioFin_BaseUrineCol_v1r0=="Any urine collected" & BioFin_BaseMWCol_v1r0!="Any mouthwash collected") ~ 'Urine Only',
                                                                 (BioFin_BaseBloodCol_v1r0!="Any blood collected" & BioFin_BaseUrineCol_v1r0!="Any urine collected" & BioFin_BaseMWCol_v1r0!="Any mouthwash collected") ~ 'No Specimens Collected'))
site.sub$'Specimens Collected' <- factor(site.sub$'Specimens Collected',levels=c('Blood & Urine (All)', 'Blood Only','Urine Only','No Specimens Collected'))


table6_redone__C <- site.sub %>% filter(Setting=="Clinical Collections")
table6_redone__C$Site <- droplevels(table6_redone__C$Site)
table6_redone__C$'Specimens Collected' <- droplevels(table6_redone__C$'Specimens Collected')
table6_redoneC <- table6_redone__C %>%   dplyr::select('Specimens Collected', Site )  %>% 
  tbl_cross(
    row = 'Specimens Collected',
    col = Site,
    digits=c(0,1),
    percent = "row",
    # label=list(Site="",
    #            biocol.appoint = ""),
    missing="ifany",
    margin_text="Total")

table6_redoneC <- table6_redoneC%>%
  #bold_labels() %>%
  #italicize_levels() %>% 
  modify_header(stat_0 = "Total") %>%
  modify_caption("Table 6.b Baseline Clinical Collection Completeness by Site") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)









##Fig 1(table6)
recrver1 <- recrver1 %>% mutate(BiospmCols_v1r0 = 
                                  case_when((recrver1$d_684635302 == 353358909 & recrver1$d_878865966 == 353358909 & recrver1$d_167958071 == 353358909) ~ "All blood, urine and mouthwash",
                                            (recrver1$d_684635302 == 353358909 & recrver1$d_878865966 == 353358909 & recrver1$d_167958071 == 104430631) ~ "Mouthwash and blood, no urine",
                                            (recrver1$d_684635302 == 353358909 & recrver1$d_878865966 == 104430631 & recrver1$d_167958071 == 104430631) ~ "Only mouthwash,no blood or urine",
                                            (recrver1$d_684635302 == 104430631 & recrver1$d_878865966 == 353358909 & recrver1$d_167958071 == 353358909) ~ "Blood and urine, no mouthwash",
                                            (recrver1$d_684635302 == 104430631 & recrver1$d_878865966 == 104430631 & recrver1$d_167958071 == 353358909) ~ "Only urine, no blood or mouthwash",
                                            (recrver1$d_684635302 == 353358909 & recrver1$d_878865966 == 104430631 & recrver1$d_167958071 == 353358909) ~ "Mouthwash and urine, no blood",
                                            (recrver1$d_684635302 == 104430631 & recrver1$d_878865966 == 353358909 & recrver1$d_167958071 == 104430631) ~ "Only blood, no urine or mouthwash",
                                            ((recrver1$d_684635302 == 104430631 | is.na(recrver1$d_684635302)) & (recrver1$d_878865966 == 104430631 | is.na(recrver1$d_878865966)) & (is.na(recrver1$d_167958071) |recrver1$d_167958071 == 104430631)) ~ "No any biospecimen collections"))

table(as.character(recrver1$d_684635302))








### NOT SURE WHAT THIS CODE SECTION GOES TO 
table_colspm <- recrver1[which(recrver1$d_684635302 == 353358909 | recrver1$d_878865966 == 353358909 | recrver1$d_167958071 == 353358909),] %>%
        group_by(BiospmCols_v1r0) %>% dplyr::summarise(count=n()) 
table_colspm$count_pct <- paste0(table_colspm$count," (", round(100*table_colspm$count/sum(table_colspm$count),digits=1),"%)")
table_colspm <- table_colspm[order(-table_colspm$count),]
table_colspm$midpoint = cumsum(table_colspm$count) - (table_colspm$count / 2)
table_colspm$midpoint <- ifelse(table_colspm$count>7, table_colspm$count, cumsum(table_colspm$count) - (table_colspm$count / 2))
table_colspm$midpoint
ggplot(table_colspm, aes(x = "", y = count, fill = BiospmCols_v1r0)) +
  geom_bar(width = 1, stat = "identity") +
  coord_polar(theta = "y", start = 0) +
  scale_fill_manual(values = c("light blue", "Red", "Green", "Orange", "Pink", "Purple","Yellow")) +
  scale_colour_brewer(palette = "Set1") +
  labs(x = "", y = "", title = "Percent (and number) of Biospecimen Collection Completion among baseline collections",
       fill = "BiospmCols_v1r0") + 
  geom_text(aes(x=1.6, label=count_pct),
            position =  position_stack(vjust=0.6), size=3) +
  geom_text(aes(x = 1.3, y = midpoint , label = count_pct), color="black",
            fontface = "bold") +
  theme(plot.title = element_text(hjust = 0.5), 
        legend.title = element_text(hjust = 0.5, face="bold", size = 10))


#label outside
ggplot(table_colspm, aes(x = "", y = count, fill = BiospmCols_v1r0)) +
  geom_bar(width = 1, stat = "identity") +
  coord_polar(theta = "y", start = 0) +
  scale_fill_manual(values = c("light blue", "Red", "Green", "Orange", "Pink", "Purple","Yellow")) +
  #scale_colour_brewer(palette = "Set1") +
  labs(x = "", y = "", title = "Percent (and number) of Biospecimen Collection Completion among baseline collections",
       fill = "BiospmCols_v1r0") + 
  geom_text(aes(x=1.6, label=count_pct),
            position =  position_stack(vjust=0.6), size=3, color="black",fontface = "bold") +
  theme(panel.background = element_blank(),
        plot.title = element_text(hjust = 0.0, face="bold"), 
        axis.ticks = element_blank(),axis.text = element_blank(),
        legend.title = element_text(hjust = 0.5, face="bold", size = 10))


###for the biospecimen data:collections, deviation, and nocollections# ###Table 14. Number of blood, urine, and mouthwash collected by collection setting
pct_tb <- function(x,y){
  table1 <- CrossTable(x,y, prop.t=FALSE, prop.r=FALSE, prop.c=TRUE,chisq=FALSE)
  pct <- as.data.frame(cbind(table1$prop.row,table1$t))
  if(ncol(pct)==2){
    total <- as.numeric(sum(pct[,2]))
    pct[nrow(pct)+1,c(1:2)] <- c(1,total)
    rownames(pct)[nrow(pct)] <- "Total"
    colnames(pct)[1] <- paste0("pct_",colnames(pct)[1])
    colnames(pct)[2] <- paste0("n_",colnames(pct)[2])
    
  }
  else  if(ncol(pct)>2 ){
    total <- as.numeric(sum(pct[,3] + pct[,4]))
    pct[nrow(pct)+1,c(1:4)] <- c(sum(pct[,3])/total,sum(pct[,4])/total,sum(pct[,3]),sum(pct[,4]))
    rownames(pct)[nrow(pct)] <- "Total"
    colnames(pct)[c(1:2)] <- paste0("pct_",colnames(pct[c(1:2)]))
    colnames(pct)[c(3:4)] <- paste0("n_",colnames(pct)[c(3:4)])
    
    pct[,5] <- paste0(format(pct[,3],big.mark=","), " (",round(100*pct[,1],1), "%)")
    pct[,6] <- paste0(format(pct[,4],big.mark=","), " (",round(100*pct[,2],1), "%)") 
    colnames(pct)[5] <- paste0("n_",colnames(pct)[1])
    colnames(pct)[6] <- paste0("n_",colnames(pct)[2])
  }
  return(pct)
}



###Tables on the biospecimen samples
##Table6_bysite. the research blood collection completions
##for blood collection based on the biospecimen data individually
biospe<- expss::apply_labels(biospe,d_827220437 = "Site",#RcrtES_Site_v1r0
                     d_827220437 = c("HealthPartners"= 531629870, "Henry Ford Health System"=548392715,"Marshfield Clinic Health System" = 303349821,"Sanford Health" = 657167265, "University of Chicago Medicine" = 809703864, "Kaiser Permanente Colorado" = 125001209,"Kaiser Permanente Georgia" = 327912200,"Kaiser Permanente Hawaii" = 300267574,"Kaiser Permanente Northwest" = 452412599,"National Cancer Institute" = 517700004,"National Cancer Institute" = 13,"Other" = 181769837))

biospe$Site <- factor(biospe$d_827220437, levels= c("HealthPartners", "Henry Ford Health System","Marshfield Clinic Health System","Sanford Health", "University of Chicago Medicine","Kaiser Permanente Colorado","Kaiser Permanente Georgia","Kaiser Permanente Hawaii","Kaiser Permanente Northwest")) 

#125001209 300267574 303349821 327912200 452412599 531629870 548392715 657167265 809703864 
#        2         2       329         1         4       417       169       200       314 
                      
#125001209 300267574 303349821 327912200 452412599 531629870 548392715 657167265 809703864 
#        2         2       329         1         4       417       169       200       314 
biospe <- biospe %>% arrange(Site)
tubes <- dd[grepl(" Tube ",dd$`Variable Label`),]
tubes[grepl("00", tubes$`Variable Name`),]
###         CID         Variable Label    Variable Name
# 2: 299553921 Serum Separator Tube 1 BioCol_0001_v1r0
# 9: 703954371 Serum Separator Tube 2 BioCol_0002_v1r0
# 3: 376960806 Serum Separator Tube 3 BioCol_0011_v1r0
# 1: 232343615 Serum Separator Tube 4 BioCol_0012_v1r0
# 5: 589588440 Serum Separator Tube 5 BioCol_0021_v1r0
# 4: 454453939            EDTA Tube 1 BioCol_0004_v1r0
# 7: 677469051            EDTA Tube 2 BioCol_0014_v1r0
# 8: 683613884            EDTA Tube 3 BioCol_0024_v1r0
# 10: 838567176         Heparin Tube 1 BioCol_0003_v1r0
# 11: 958646668         Heparin Tube 2 BioCol_0013_v1r0
# 6: 652357376             ACD Tube 1 BioCol_0005_v1r0
bld.ls <- c("d_299553921","d_703954371","d_454453939","d_838567176","d_652357376","d_376960806","d_232343615","d_589588440","d_677469051", "d_683613884","d_958646668") #blood tube types CIDs: the first 5 tubes are research, add the rest are clinical
#bld.ls <- c("d_299553921","d_703954371","d_454453939","d_838567176","d_652357376") #blood tube types CIDs research collections
##research collection tubes
 ##biospeciment tube type CIDs
tubeid <- grep("d_825582494", names(biospe), value=TRUE) #tube ID
deviation <- grep("d_678857215",names(biospe),value=TRUE) 
colid <- grep("d_593843561", names(biospe), value=TRUE) #collected yes/no
discard <- grep("d_762124027",names(biospe),value=TRUE) #discard yes/no
biodiscard <- biospe[,(which(names(biospe) %in% discard))]
#eval(parse(text=paste("varlong <-grep(",\"d_593843561\",",names(biospe),value=TRUE)",sep="")))
###Table 6. Percent (and number) of Blood Completeness among baseline collections
###reshape the data: binary variables for tube collections: collected(y/n),deviation(y/n), tubeID, discarded (y/n), notcollection reasons:5,
###notcollection Notes (338286049), deviation notes (536710547)
biospe$blddev <-0 #blood deviations
biospe$bldcol <- 0 #blood collections
biospe$blddid <- 0 #discarded
for(i in 1:length(bld.ls)){
  
  bldcol <- ifelse(biospe[,paste(bld.ls[i],"d_593843561",sep="_")] == 104430631 | is.na(biospe[,paste(bld.ls[i],"d_593843561",sep="_")]),0,1)  ##for tube collected
  
  blddev <- ifelse(biospe[,paste(bld.ls[i],"d_678857215",sep="_")]==104430631 | is.na(biospe[,paste(bld.ls[i],"d_678857215",sep="_")]),0,1) #for tube deviations yes/no
  
  blddid <- ifelse(biospe[,paste(bld.ls[i],"d_762124027",sep="_")]==104430631 | is.na(biospe[,paste(bld.ls[i],"d_762124027",sep="_")]),0,1)
  
  biospe$blddev <- biospe$blddev+blddev
  biospe$bldcol <- bldcol + biospe$bldcol ###to check collection
  biospe$blddid <- biospe$blddid+blddid  
  # k the completion of the blood collection of 5 types
  
}
table(biospe$d_650516960,biospe$bldcol)
biospe <- biospe %>% mutate(bloodcomplete = ifelse((d_650516960==534621077 & bldcol == 5) | (d_650516960==664882224 & bldcol == 11), "Blood.Completion" ,#blood collection completion
                                          ifelse( (d_650516960==534621077 & (bldcol<5 & bldcol>0)) | (d_650516960==664882224 & (bldcol <  11 & bldcol < 0)),"Blood.Incompleted","NoBlood")),
                            Urine_col = ifelse(d_973670172_d_593843561==353358909, 1, ifelse(d_973670172_d_593843561==104430631,0,0)),
                            MW_col = ifelse(d_143615646_d_593843561==353358909,1,ifelse(d_143615646_d_593843561==104430631,0,0)),
                            biocol_Setting = case_when(d_650516960==534621077  ~"Research",
                                                        d_650516960==664882224 ~ "Clinical",
                                                         d_650516960 ==103209024 ~ "Home")) 
biospe$Biospe_col <- biospe$bldcol + biospe$Urine_col + biospe$MW_col    
biospe$BaseBLDCol <-ifelse(biospe$bldcol>0,1,ifelse(is.na(biospe$bldcol),NA,0)) #blood collection Yes/No
biospe[duplicated(biospe$Connect_ID),]$Connect_ID
#[1] 2055639272 3654414289 4467774615 5537363912 6258863606 7574078898 8261536089 #stg biospecimen data
# [1] 1219400073 1397465779 2310991421 2513005250 2699722546 4289925849 7154937817 8087190864
###to get the summary collection data per person on urine, blood, and mouthwash collections for each biospecimen collection settings
#tube_col <- biospe %>% dplyr::select(Connect_ID, d_678166505,d_951355211, d_410912345,d_650516960, d_556788178,grep("593843561",colnames(biospe)),bldcol)
#tube_col <- tube_col %>% group_by(as.character(Connect_ID))  %>% arrange(bldcol,d_973670172_d_593843561,d_143615646_d_593843561) %>% slice(n())
#biospe1 <- biospe %>% group_by(as.character(Connect_ID)) %>% arrange(desc(Biospe_col)) %>% slice(n())






### Table 7
tube_col <- biospe  %>% group_by(as.character(Connect_ID),Site,d_650516960) %>% 
  dplyr::summarise(bldcol_max = max(bldcol,na.rm=TRUE),
                   Urine_col_max= max(Urine_col,na.rm=TRUE),
                   MW_col_max=max(MW_col,na.rm=TRUE),
                   d_973670172_d_593843561_max=max(d_973670172_d_593843561,na.rm=TRUE),
                   d_143615646_d_593843561_max = max(d_143615646_d_593843561,na.rm=TRUE),
                   d_410912345_max=max(d_410912345,na.rm=TRUE),
                   collection.tm =max(as.POSIXct(ymd_hms(d_556788178)),na.rm=TRUE),
                   schedulecol.tm =min(as.POSIXct(ymd_hms(d_678166505)),na.rm=TRUE))
table(tube_col$d_650516960)
#534621077 664882224 
#     1421        10 
tube_col$Connect_ID <- as.numeric(tube_col$`as.character(Connect_ID)`)
#tube_col[duplicated(tube_col$Connect_ID),]$Connect_ID #only 1 2310991421
tube_research <- tube_col %>% filter(d_650516960==534621077) %>%
  mutate(bld.complt = ifelse(bldcol_max==5,"BloodCompletion",ifelse(bldcol_max==0, "NoBlood","BloodIncomplet")))
#tube_research$Site <- droplevels(tube_research$Site)
table.bldcol <- ctable(tube_research$Site,tube_research$bld.complt)
bldcol_research <- as.data.frame(cbind(table.bldcol$cross_table,table.bldcol$proportions))
bldcol_research$Site <-trimws(rownames(bldcol_research))
                             
bldcol_research$n_pct_BloodCompletion <- ifelse(!grepl("Total",rownames(bldcol_research)),  paste(format(bldcol_research[,1],big.mark=","),"(", round(100*bldcol_research[,5],1),"%)",sep=" "), format(bldcol_research[,1],big.mark="," ))
bldcol_research$n_pct_BloodInompletion = ifelse(!grepl("Total",rownames(bldcol_research)),  paste(format(bldcol_research[,2],big.mark=","),"(", round(100*bldcol_research[,6],1),"%)",sep=" "), format(bldcol_research[,2],big.mark="," ))
bldcol_research$n_pct_NoBlood = ifelse(!grepl("Total",rownames(bldcol_research)),  paste(format(bldcol_research[,3],big.mark=","),"(", round(100*bldcol_research[,7],1),"%)",sep=" "), format(bldcol_research[,3],big.mark="," ))
         
bldcol_research1 <- bldcol_research[c(1:5,10),c(9:12,4)] #c(9:12,4)







### Table 7.1- specifically for U-Chicago 
biospe= biospe  %>% mutate(UC_Sites= case_when(d_951355211==777644826 ~ "UC-DCAM",
                                       d_951355211==145191545 ~ "Ingalls Harvey",
                                       d_951355211==489380324 ~ "River East",
                                       d_951355211==120264574 ~ "South Loop"))
tube_col_UC <- biospe  %>% group_by(as.character(Connect_ID),UC_Sites,d_650516960) %>% 
  filter(UC_Sites=="UC-DCAM" | UC_Sites=="Ingalls Harvey" |  UC_Sites=="River East" |  UC_Sites=="South Loop" ) %>% 
  dplyr::summarise(bldcol_max = max(bldcol,na.rm=TRUE),
                   Urine_col_max= max(Urine_col,na.rm=TRUE),
                   MW_col_max=max(MW_col,na.rm=TRUE),
                   d_973670172_d_593843561_max=max(d_973670172_d_593843561,na.rm=TRUE),
                   d_143615646_d_593843561_max = max(d_143615646_d_593843561,na.rm=TRUE),
                   d_410912345_max=max(d_410912345,na.rm=TRUE),
                   collection.tm =max(as.POSIXct(ymd_hms(d_556788178)),na.rm=TRUE),
                   schedulecol.tm =min(as.POSIXct(ymd_hms(d_678166505)),na.rm=TRUE))
table(tube_col_UC$d_650516960)
#534621077 664882224 
#     1421        10 
tube_col_UC$Connect_ID <- as.numeric(tube_col_UC$`as.character(Connect_ID)`)
#tube_col_UC[duplicated(tube_col_UC$Connect_ID),]$Connect_ID #only 1 2310991421
tube_research_UC <- tube_col_UC %>% filter(d_650516960==534621077) %>%
  mutate(bld.complt = ifelse(bldcol_max==5,"BloodCompletion",ifelse(bldcol_max==0, "NoBlood","BloodIncomplet")))
#tube_research_UC$UC_Sites <- droplevels(tube_research_UC$UC_Sites)
table.bldcol_UC <- ctable(tube_research_UC$UC_Sites,tube_research_UC$bld.complt)
bldcol_research_UC <- as.data.frame(cbind(table.bldcol_UC$cross_table,table.bldcol_UC$proportions))
bldcol_research_UC$UC_Sites <-trimws(rownames(bldcol_research_UC))
                             
bldcol_research_UC$n_pct_BloodCompletion <- ifelse(!grepl("Total",rownames(bldcol_research_UC)),  paste(format(bldcol_research_UC[,1],big.mark=","),"(", round(100*bldcol_research_UC[,5],1),"%)",sep=" "), format(bldcol_research_UC[,1],big.mark="," ))
bldcol_research_UC$n_pct_BloodInompletion = ifelse(!grepl("Total",rownames(bldcol_research_UC)),  paste(format(bldcol_research_UC[,2],big.mark=","),"(", round(100*bldcol_research_UC[,6],1),"%)",sep=" "), format(bldcol_research_UC[,2],big.mark="," ))
bldcol_research_UC$n_pct_NoBlood = ifelse(!grepl("Total",rownames(bldcol_research_UC)),  paste(format(bldcol_research_UC[,3],big.mark=","),"(", round(100*bldcol_research_UC[,7],1),"%)",sep=" "), format(bldcol_research_UC[,3],big.mark="," ))
         
bldcol_research_UC1 <- bldcol_research_UC[,c(9:12,4)]





### Table 7.2- specifically for Henry Ford--- RESEARCH SITES
biospe= biospe  %>% mutate(HF_Sites= case_when(d_951355211==736183094 ~ "HFH K-13 Research Clinic",
                                       d_951355211==886364332 ~ "HFH Cancer Pavilion Research Clinic",
                                       d_951355211==706927479 ~ "HFH Livonia Research Clinic"))
tube_col_HF <- biospe  %>% group_by(as.character(Connect_ID),HF_Sites,d_650516960) %>% 
  filter(HF_Sites=="HFH K-13 Research Clinic" | HF_Sites=="HFH Cancer Pavilion Research Clinic" |  HF_Sites=="HFH Livonia Research Clinic") %>% 
  dplyr::summarise(bldcol_max = max(bldcol,na.rm=TRUE),
                   Urine_col_max= max(Urine_col,na.rm=TRUE),
                   MW_col_max=max(MW_col,na.rm=TRUE),
                   d_973670172_d_593843561_max=max(d_973670172_d_593843561,na.rm=TRUE),
                   d_143615646_d_593843561_max = max(d_143615646_d_593843561,na.rm=TRUE),
                   d_410912345_max=max(d_410912345,na.rm=TRUE),
                   collection.tm =max(as.POSIXct(ymd_hms(d_556788178)),na.rm=TRUE),
                   schedulecol.tm =min(as.POSIXct(ymd_hms(d_678166505)),na.rm=TRUE))
table(tube_col_HF$d_650516960)
#534621077 664882224 
#     1421        10 
tube_col_HF$Connect_ID <- as.numeric(tube_col_HF$`as.character(Connect_ID)`)
#tube_col_HF[duplicated(tube_col_HF$Connect_ID),]$Connect_ID #only 1 2310991421
tube_research_HF <- tube_col_HF %>% filter(d_650516960==534621077) %>%
  mutate(bld.complt = ifelse(bldcol_max==5,"BloodCompletion",ifelse(bldcol_max==0, "NoBlood","BloodIncomplet")))
#tube_research_HF$HF_Sites <- droplevels(tube_research_HF$HF_Sites)
table.bldcol_HF <- ctable(tube_research_HF$HF_Sites,tube_research_HF$bld.complt)
bldcol_research_HF <- as.data.frame(cbind(table.bldcol_HF$cross_table,table.bldcol_HF$proportions))
bldcol_research_HF$HF_Sites <-trimws(rownames(bldcol_research_HF))
                             
bldcol_research_HF$n_pct_BloodCompletion <- ifelse(!grepl("Total",rownames(bldcol_research_HF)),  paste(format(bldcol_research_HF[,1],big.mark=","),"(", round(100*bldcol_research_HF[,5],1),"%)",sep=" "), format(bldcol_research_HF[,1],big.mark="," ))
bldcol_research_HF$n_pct_BloodInompletion = ifelse(!grepl("Total",rownames(bldcol_research_HF)),  paste(format(bldcol_research_HF[,2],big.mark=","),"(", round(100*bldcol_research_HF[,6],1),"%)",sep=" "), format(bldcol_research_HF[,2],big.mark="," ))
bldcol_research_HF$n_pct_NoBlood = ifelse(!grepl("Total",rownames(bldcol_research_HF)),  paste(format(bldcol_research_HF[,3],big.mark=","),"(", round(100*bldcol_research_HF[,7],1),"%)",sep=" "), format(bldcol_research_HF[,3],big.mark="," ))
         
bldcol_research_HF1 <- bldcol_research_HF[,c(9:12,4)]





### Table 7.3- specifically for Henry Ford--CLINICAL SITES--- need to wait until there's more data
table7_3 <- recrver1 %>%  select(Connect_ID, d_173836415_d_266600170_d_185243482)
left7 <- left_join(biospe, table7_3, by="Connect_ID")

biospe7= left7  %>% mutate(HF_Sites= case_when(d_173836415_d_266600170_d_185243482==1050010095 ~ "HF Wyandotte Hospital",
                                       d_173836415_d_266600170_d_185243482==1060010063 ~ "HF Macomb Medical Pavilion",
                                       d_173836415_d_266600170_d_185243482==1040010047 ~ "HF West Bloomfield Hospital"))
tube_col_HF2 <- biospe7  %>% group_by(as.character(Connect_ID),HF_Sites,d_650516960) %>% 
  filter(HF_Sites=="HF Wyandotte Hospital" | HF_Sites=="HF Macomb Medical Pavilion" |  HF_Sites=="HF West Bloomfield Hospital") %>% 
  dplyr::summarise(bldcol_max = max(bldcol,na.rm=TRUE),
                   Urine_col_max= max(Urine_col,na.rm=TRUE),
                   MW_col_max=max(MW_col,na.rm=TRUE),
                   d_973670172_d_593843561_max=max(d_973670172_d_593843561,na.rm=TRUE),
                   d_143615646_d_593843561_max = max(d_143615646_d_593843561,na.rm=TRUE),
                   d_410912345_max=max(d_410912345,na.rm=TRUE),
                   collection.tm =max(as.POSIXct(ymd_hms(d_556788178)),na.rm=TRUE),
                   schedulecol.tm =min(as.POSIXct(ymd_hms(d_678166505)),na.rm=TRUE))
table(tube_col_HF2$d_650516960)
#534621077 664882224 
#     1421        10 
tube_col_HF2$Connect_ID <- as.numeric(tube_col_HF2$`as.character(Connect_ID)`)
#tube_col_HF2[duplicated(tube_col_HF2$Connect_ID),]$Connect_ID #only 1 2310991421
tube_research_HF2 <- tube_col_HF2 %>% filter(d_650516960==664882224) %>%
  mutate(bld.complt = ifelse(bldcol_max==5,"BloodCompletion",ifelse(bldcol_max==0, "NoBlood","BloodIncomplet")))
#tube_research_HF2$HF_Sites <- droplevels(tube_research_HF2$HF_Sites)
table.bldcol_HF2 <- ctable(tube_research_HF2$HF_Sites,tube_research_HF2$bld.complt)
bldcol_research_HF2 <- as.data.frame(cbind(table.bldcol_HF2$cross_table,table.bldcol_HF2$proportions))
bldcol_research_HF2$HF_Sites <-trimws(rownames(bldcol_research_HF2))

bldcol_research_HF2$BloodCompletion[1] <- paste0(bldcol_research_HF2$BloodCompletion[1], " (100%)")
bldcol_research_HF2$BloodCompletion[2] <- paste0(bldcol_research_HF2$BloodCompletion[2], " (100%)")
bldcol_research_HF2$BloodCompletion[3] <- paste0(bldcol_research_HF2$BloodCompletion[3], " (100%)")

bldcol_research_HF2$Partial <- list("0 (0%)", "0 (0%)","0 (0%)", 0)
bldcol_research_HF2$None <- list("0 (0%)", "0 (0%)","0 (0%)", 0)

# View(bldcol_research_HF2) # You can't use this on GCP!!!

bldcol_research_HF2 <- bldcol_research_HF2[, c(5,1,6,7, 2)]
          
# #--- need to wait until there's more data to revert back to original code                   
# bldcol_research_HF2$n_pct_BloodCompletion <- ifelse(!grepl("Total",rownames(bldcol_research_HF2)),  paste(format(bldcol_research_HF2[,1],big.mark=","),"(", round(100*bldcol_research_HF2[,5],1),"%)",sep=" "), format(bldcol_research_HF2[,1],big.mark="," ))
# bldcol_research_HF2$n_pct_BloodInompletion = ifelse(!grepl("Total",rownames(bldcol_research_HF2)),  paste(format(bldcol_research_HF2[,2],big.mark=","),"(", round(100*bldcol_research_HF2[,6],1),"%)",sep=" "), format(bldcol_research_HF2[,2],big.mark="," ))
# bldcol_research_HF2$n_pct_NoBlood = ifelse(!grepl("Total",rownames(bldcol_research_HF2)),  paste(format(bldcol_research_HF2[,3],big.mark=","),"(", round(100*bldcol_research_HF2[,7],1),"%)",sep=" "), format(bldcol_research_HF2[,3],big.mark="," ))
# 
# bldcol_research_HF_2 <- bldcol_research_HF2[,c(9:12,4)]










  
### Table 8- renumbered
#c("2513005250","2699722546","4289925849","7154937817","8087190864")),c("Connect_ID","d_410912345_max","bldcol_max","d_143615646_d_593843561_max","d_973670172_d_593843561_max")]
pct_n <- function(x,y){ paste0(x,"( ", round(100*y,2), " %)")}
n_pct_table <- function(x,y){
  #x<-clinicnotes.notcol$Site
  #y<-clinicnotes.notcol$notcol.notes
  ctable<- CrossTable(x,y)
count <- as.data.frame.matrix(ctable$t)
perc <- as.data.frame.matrix(ctable$prop.col)
n<- as.numeric(length(levels(x)))
m <- as.numeric(length(levels(y)))
tb_combo <- array(pct_n(ctable$t,ctable$prop.col),dim=c(n,m)) 
  tb_combo <- as.data.frame(tb_combo)
  colnames(tb_combo) <- colnames(count)
  
  total <- sum(count)
  count$Total <- apply(count,1,sum)
  tb_combo$Total <- paste0(count$Total, "( ", round(100*(count$Total)/total,2), " %)")
  
  tb_combo$Site <- rownames(count)
  tb_combo[(n+1),c(1:(m+1))] <- as.character(apply(count,2,sum))
  tb_combo$Site[is.na(tb_combo$Site)] <- replace_na("Total")  
  return(tb_combo)
}
tube_clinic <- tube_col %>% filter(d_650516960==664882224 & grepl("Kaiser",Site))%>% mutate(Site=droplevels(Site),
                                                                     bldcol_max=as.factor(bldcol_max))
tube_clinic$bldcol_tubes <- factor(tube_clinic$bldcol_max,levels=c(1:11))
tube_clinic$bldcol_tubes <- droplevels(tube_clinic$bldcol_tubes)
#clinic.bldcol <-CrossTable(tube_clinic$Site,as.factor(tube_clinic$bldcol_tubes))
bldcol_clinic <- n_pct_table(tube_clinic$Site,as.factor(tube_clinic$bldcol_tubes))
                             
# for (i in 1:length(levels(tube_clinic$bldcol_tubes))){
#   bldcol_clinic[,i+24] <- ifelse(!grepl("Total",rownames(bldcol_clinic)), paste(format(bldcol_clinic[,i],big.mark=","),"(",round(100*bldcol_clinic[,12+i], 2),"%)",sep=" "), 
#   format(bldcol_clinic[,i],big.mark="," ))
# colnames(bldcol_clinic)[i+24] <- paste0("Tube ",i)  
# }
bldcol_clinic$"Less Than 7" <- ifelse(!grepl("Total",bldcol_clinic$Site),"0 ( 0.00%)","0")
bldcol_clinic$`11` <- bldcol_clinic$"Less Than 7"
#bldcol_clinic1$TubeNo <- trimws(rownames(bldcol_clinic1))






 
  
  
  
  
  


## Table 10

tube_clinic <- tube_col %>% filter(d_650516960==664882224 )%>% mutate(Site=droplevels(Site),
                                                                     bldcol_max=as.factor(bldcol_max)) #& grepl("Kaiser",Site)
tube_clinic$bldcol_tubes <- factor(tube_clinic$bldcol_max,levels=c(0:10))
tube_clinic$bldcol_tubes <- droplevels(tube_clinic$bldcol_tubes)
#tube_clinic$bldcol_tubes <- as.numeric(tube_clinic$bldcol_tubes)

# table(tube_clinic$bldcol_tubes, tube_clinic$Site)
# 
# table10rd <- as.data.frame.matrix(table(tube_clinic$bldcol_tubes, tube_clinic$Site))
# table10rd %>%  gt()
# 
# bldcol_clinics <- tube_clinic %>% select(Site, bldcol_tubes)
# total <- nrow(bldcol_clinics)

table10rd <- tube_clinic %>% 
  dplyr::select(bldcol_tubes, Site)  %>% 
  tbl_cross(
    col = bldcol_tubes, 
    row = Site,
    percent = "row",
    label= bldcol_tubes ~ 'Number of Tubes',          #list(Site~"Site", bldcol_tubes ~ 'Number of Tubes'),
    missing="ifany",
    missing_text="0",
    digits=c(0,1),
    margin_text="Total") 
#Table9_BldCli[["table_body"]]$stat_0 <- sapply(strsplit(Table9_BldCli[["table_body"]]$stat_0," "),"[",1) 
table10rd <- table10rd %>%
  #bold_labels() %>%
  #italicize_levels() %>% 
  modify_header() %>%
  modify_caption("Table 9. Blood Completeness (Number of Blood Tubes Collected) for Participants with Baseline Clinical Collections") %>% ## used to be Table 8
  as_kable_extra()
table10rd







##Table 11- renumbered--- named Table8_BldCli to Table11_BldCli to match report
    # table(recr_clin$Site) -- confirmed HF hybird is included in this 
recr_clin <- recrver1 %>% dplyr::filter(d_173836415_d_266600170_d_592099155 == 664882224 | d_173836415_d_266600170_d_718172863  == 664882224) %>%
   mutate(BL_BioClin_DBUrineRRL_v1r0=ifelse(d_173836415_d_266600170_d_210921343==104430631 | is.na(d_173836415_d_266600170_d_210921343), "No","Yes"),
          BioClin_SiteUrineColl_v1r0=ifelse(d_173836415_d_266600170_d_786930107==104430631 | is.na(d_173836415_d_266600170_d_786930107), "No","Yes"),
          BL_BioClin_DBBloodRRL_v1r0=ifelse(d_173836415_d_266600170_d_534041351==104430631 | is.na(d_173836415_d_266600170_d_534041351), "No","Yes"),
          BioClin_SiteBloodColl_v1r0=ifelse(d_173836415_d_266600170_d_693370086==104430631 | is.na(d_173836415_d_266600170_d_693370086), "No","Yes")
   )
Table11_BldCli <- recr_clin %>% 
  dplyr::select(BL_BioClin_DBBloodRRL_v1r0, BioClin_SiteBloodColl_v1r0 )  %>% 
  mutate(BL_BioClin_DBBloodRRL_v1r0= factor(BL_BioClin_DBBloodRRL_v1r0,levels=c("Yes","No")),
         BioClin_SiteBloodColl_v1r0=factor(BioClin_SiteBloodColl_v1r0,levels=c("Yes","No"))) %>%
  tbl_cross(
    col = BL_BioClin_DBBloodRRL_v1r0,
    row = BioClin_SiteBloodColl_v1r0,
    percent = "cell",
    #label=list(BL_BioClin_DBBloodRRL_v1r0~"Any Blood Collected (Data from Dashboard)", BioClin_SiteBloodColl_v1r0 ~ 'Any Blood Collected (Data Sent by KP)'),
    label=list(BL_BioClin_DBBloodRRL_v1r0~"Any Blood Collected (Data from Dashboard)", BioClin_SiteBloodColl_v1r0 ~ 'Any Blood Collected (Data Sent by Site)'),  #on hold- HF should show up under clinical 
    missing="ifany",
    missing_text="0",
    digits=c(0,1),
    margin_text="Total") 
Table11_BldCli[["table_body"]]$stat_0 <- sapply(strsplit(Table11_BldCli[["table_body"]]$stat_0," "),"[",1) 
Table11_BldCli <- Table11_BldCli %>%
  #bold_labels() %>%
  #italicize_levels() %>% 
  modify_header() %>%
  #modify_caption("Table 11. Baseline Blood Collection Status in Data Sent from KP vs Connect Biospecimen Dashboard") %>%
  modify_caption("Table 11. Baseline Blood Collection Status in Data Sent from Site vs Connect Biospecimen Dashboard") %>% #on hold- HF should show up under clinical 
  as_kable_extra()

#table(recr_clin$Site)  # check if HF included, this is one check for both tables 11 and 12





## Table 12- renumbered---- renamed Table9_UrineCli to Table12_UrineCli
        # table(recr_clin$Site) -- confirmed HF hybird is included in this 
Table12_UrineCli <- recr_clin %>% 
  dplyr::select(BL_BioClin_DBUrineRRL_v1r0, BioClin_SiteUrineColl_v1r0 ) %>% 
  mutate(BL_BioClin_DBUrineRRL_v1r0= factor(BL_BioClin_DBUrineRRL_v1r0,levels=c("Yes","No")),
         BioClin_SiteUrineColl_v1r0= factor(BioClin_SiteUrineColl_v1r0,levels=c("Yes","No")))  %>% 
  tbl_cross(
    col = BL_BioClin_DBUrineRRL_v1r0,
    row = BioClin_SiteUrineColl_v1r0,
    percent = "cell",
    digits= c(0,1),
    #label=list(BL_BioClin_DBUrineRRL_v1r0~"Urine collected (Data from Dashboard)", BioClin_SiteUrineColl_v1r0 ~ 'Urine collected (Data Sent by KP)'),
    label=list(BL_BioClin_DBUrineRRL_v1r0~"Urine collected (Data from Dashboard)", BioClin_SiteUrineColl_v1r0 ~ 'Urine collected (Data Sent by Site)'), #on hold- HF should show up under clinical 
    missing="ifany",
    missing_text="0",
    margin_text="Total")  

Table12_UrineCli[["table_body"]]$stat_0 <- sapply(strsplit(Table12_UrineCli[["table_body"]]$stat_0," "),"[",1) 
Table12_UrineCli <- Table12_UrineCli%>%
  #bold_labels() %>%
  #italicize_levels() %>% 
  modify_header() %>%
  #modify_caption("Table 12. Baseline Urine Collection Status in Data Sent From KP vs Connect Biospecimen Dashborad") %>%
  modify_caption("Table 12. Baseline Urine Collection Status in Data Sent From Site vs Connect Biospecimen Dashborad") %>% #on hold- HF should show up under clinical 
  as_kable_extra()






#Table 13 
#Participants who checked in for a baseline biospecimen visit but did not give any samples
dd[grepl("BioChk",dd$`Variable Name`),]
recr_bio <- merge(recrver1,tube_col,by="Connect_ID")
bio_checkin_resh <- recr_bio  %>% filter(!is.na(d_331584571_d_266600170_d_840048338) & d_650516960==534621077) %>% select(BiospeCollection ) %>% tbl_summary()
table(bio_checkin_resh$BiospeCollection)
#Table 12 Number (and percent) of tubes with any deviation by site
#dd[grepl("BioCol_00",dd$`Variable Name`),] %>% arrange(`Variable Label`)
#          CID                          Variable Label    Variable Name
#  1: 143615646                               Mouthwash BioCol_0007_v1r0
#  2: 223999569            Biohazard Bag (mouthwash) ID BioCol_0009_v1r0
#  3: 232343615                  Serum Separator Tube 4 BioCol_0012_v1r0
#  4: 299553921                  Serum Separator Tube 1 BioCol_0001_v1r0
#  5: 376960806                  Serum Separator Tube 3 BioCol_0011_v1r0
#  6: 454453939                             EDTA Tube 1 BioCol_0004_v1r0
#  7: 589588440                  Serum Separator Tube 5 BioCol_0021_v1r0
#  8: 652357376                              ACD Tube 1 BioCol_0005_v1r0
#  9: 677469051                             EDTA Tube 2 BioCol_0014_v1r0
# 10: 683613884                             EDTA Tube 3 BioCol_0024_v1r0
# 11: 703954371                  Serum Separator Tube 2 BioCol_0002_v1r0
# 12: 787237543 Biohazard Bag (Blood or Blood/Urine) ID BioCol_0008_v1r0
# 13: 838567176                          Heparin Tube 1 BioCol_0003_v1r0
# 14: 958646668                          Heparin Tube 2 BioCol_0013_v1r0
# 15: 973670172                                   Urine BioCol_0006_v1r0
tubes <- dd[which(grepl("BioCol_00",as.character(dd$`Variable Name`)) & !grepl("Biohazard Bag", dd$`Variable Label`)),] 
tubes <- tubes[order(tubes$"Variable Name"),]
tube.ls <- paste0("d_", trimws(paste(tubes[which(grepl("00", tubes$`Variable Name`)),]$CID,collapes="")))
# [1] "d_299553921" "d_703954371" "d_838567176" "d_454453939" "d_652357376" "d_973670172" "d_143615646"
# [8] "d_376960806" "d_232343615" "d_958646668" "d_677469051" "d_589588440" "d_683613884"
biospe$tubedev <-0 #biospecimen deviations
biospe$tubecol <- 0 #tube collections
biospe$tubedid <- 0 #tube discarded
for(i in 1:length(tube.ls)){
  
  tubecol <- ifelse(biospe[,paste(tube.ls[i],"d_593843561",sep="_")] == 104430631 | is.na(biospe[,paste(tube.ls[i],"d_593843561",sep="_")]),0,1)  ##for tube collected
  
  tubedev <- ifelse(biospe[,paste(tube.ls[i],"d_678857215",sep="_")]==104430631 | is.na(biospe[,paste(tube.ls[i],"d_678857215",sep="_")]),0,1) #for tube deviations yes/no
  
  tubedid <- ifelse(biospe[,paste(tube.ls[i],"d_762124027",sep="_")]==104430631 | is.na(biospe[,paste(tube.ls[i],"d_762124027",sep="_")]),0,1)
  
  biospe$tubedev <- biospe$tubedev+tubedev
  biospe$tubecol <- tubecol + biospe$tubecol ###to check collection
  biospe$tubedid <- biospe$tubedid+tubedid  
  # k the completion of the 13 tube collections
}
table(biospe$tubecol)
table(biospe$tubedev)
biospe$d_827220437 <- as.numeric(biospe$d_827220437)
biospe <- apply_labels(biospe,d_827220437 = "Site",#RcrtES_Site_v1r0
                       d_827220437 = c("HealthPartners"= 531629870, "Henry Ford Health System"=548392715, "Kaiser Permanente Colorado" = 125001209,
                                      "Kaiser Permanente Georgia" = 327912200,"Kaiser Permanente Hawaii" = 300267574,"Kaiser Permanente Northwest" = 452412599,
                                      "Marshfield Clinic Health System" = 303349821,"Sanford Health" = 657167265, "University of Chicago Medicine" = 809703864,
                                      "National Cancer Institute" = 517700004,"National Cancer Institute" = 13,"Other" = 181769837))
biospe$tube_nodev <- biospe$tubecol-biospe$tubedev
total1 <- sum(biospe$tubedev) 
total2 <- sum(biospe$tube_nodev) 
tube_dev <- as.data.frame(aggregate( biospe$tubedev,                # Specify data column[,c("tubedev","tube_nodev")]
                                     by = list(biospe$Site),              # Specify group indicator
                                     FUN = sum))
tube_nodev <- as.data.frame(aggregate( biospe$tube_nodev,                # Specify data column[,c("tubedev","tube_nodev")]
                                     by = list(biospe$Site),              # Specify group indicator
                                     FUN = sum))

  #changed Table17 to Table13 to match report
Table13 <- merge(tube_dev,tube_nodev,by="row.names")
Table13 <- Table13[,c(2,3,5)]
Table13$Total <- Table13[,2]+Table13[,3]
Table13$dev_n_pct <- ifelse(Table13[,2] >0, paste0(format(Table13[,2],big.mark=",")," (", round(100*Table13[,2]/Table13$Total, 1)," %)"), "0 (0 %)")
Table13$nodev_n_pct <- ifelse(Table13[,3] >0, paste0(format(Table13[,3],big.mark=",")," (",  round(100*Table13[,3]/Table13$Total,1), " %)"), "0 (0 %)")

Table13[10,c(1:6)] <- c("Total",total1, total2,format(sum(biospe$tubecol),big.mark=","),
                        paste0(format(total1,big.mark=",")," (", round(100*sum(as.numeric(Table13[1:9,2]))/sum(as.numeric(Table13$Total), na.rm=T), 1)," %)"),  
                        paste0(format(total2,big.mark=",")," (", round(100*sum(as.numeric(Table13[1:9,3]))/sum(as.numeric(Table13$Total), na.rm=T),1)," %)"))     
Table13 <- Table13 %>% mutate(Site = ifelse(is.na(Group.1.x), "Total Tubes Collected",  as.character(Group.1.x))) ###to replace NA in the factor variable
#as.numeric(Table13[,2])+ as.numeric(Table13[,3])

# Table13$Total <- format(Table13$Total, big.mark=",")
# Table13[10,c(1:6)] <- c("Total",total1, total2,format(sum(biospe$tubecol),big.mark=","),format(total1,big.mark=","),format(total2,big.mark=","))
# Table13 <- Table13 %>% mutate(Site = ifelse(is.na(Group.1.x), "Total Tubes Collected",  as.character(Group.1.x))) ###to replace NA in the factor variable








#Table 14. Number of deviations by biospecimen type and by tube type 
#keep this table for CCC version but remove from version that we are sharing with the sites
dev_tube <- NULL
for (i in 1:length(tube.ls)){
  
  id <- paste(tube.ls[i],"d_825582494",sep="_")
  tube <- paste(tube.ls[i],"d_678857215",sep="_")
  #note <- paste(tube.ls[i],"d_536710547",sep="_")
  tube_dev <- paste(tube.ls[i],"d_248868659", sep="_")
  deviation <- grep(tube_dev,colnames(biospe),value=TRUE)
  tmp <- as.data.frame(biospe[,which(colnames(biospe) %in% c(id,tube,deviation))] )
  tmp <- tmp[which(!is.na(tmp[,(colnames(tmp) == id)])),]
  
    dev_long <- melt(tmp,
                   id.vars=c(id,tube), 
                   measure.vars=deviation,
                   variable.name="dev_type",
                   value.name="deviation")
    
    
  colnames(dev_long)[grep("d_678857215",names(dev_long))] <- "d_678857215"
  colnames(dev_long)[grep("d_825582494",names(dev_long))] <- "TubeID"
  #colnames(dev_long)[grep("d_536710547",names(dev_long))] <- "d_536710547"
  
  dev_long <- dev_long[complete.cases(dev_long[,c("TubeID","d_678857215","dev_type","deviation")]),]
  #colnames(dev_long)[1] <- "d_678857215"
  #dev_long$d_536710547 <- as.character(dev_long$d_536710547)
  
  #dev_tube[[i]] <- dev_long
  dev_tube <- dplyr::bind_rows(dev_tube,dev_long)
  #print(c(i,bios.ls[i]))
}  
#329
   dev_tube1   <- dev_tube %>% filter(d_678857215 ==353358909 & deviation == 353358909)  %>%  
     mutate(biospecimen=ifelse(grepl("d_973670172",dev_type), "urine",
                                  ifelse(grepl("d_143615646",dev_type),"Mouthwash","blood")),
            tube_type = case_when(grepl("d_973670172",dev_type) ~ "Urine Tube1",
                                  grepl("d_143615646",dev_type) ~ "MW Tube1",
                                  grepl("d_299553921",dev_type) ~ "SS Tube1",
                                  grepl("d_703954371",dev_type) ~ "SS Tube2",
                                  grepl("d_454453939",dev_type) ~ "EDTA Tube1",
                                  grepl("d_838567176",dev_type) ~ "Heparin Tube1",
                                  grepl("d_652357376",dev_type) ~ "ACD Tube1",
                                  grepl("d_677469051",dev_type) ~ "EDTA Tube2",
                                  grepl("d_683613884",dev_type) ~ "EDTA Tube3",
                                  grepl("d_376960806",dev_type) ~ "SS Tube3",
                                  grepl("d_232343615",dev_type) ~ "SS Tube4",
                                  grepl("d_589588440",dev_type) ~ "SS Tube5",
                                  grepl("d_958646668",dev_type) ~ "Heparin Tube2"),
            
              deviationnotes =case_when(sapply(strsplit(as.character(dev_type),"d_"),tail,1) =="102695484" ~ "Deviation Clot < 30min",
                  sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="242307474" ~ "Hemolyzed", 
                  sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="283900611" ~ "Mislabel Resolved",
                  sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="313097539" ~ "Outside Contamated",
                  sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="453343022" ~ "Other",
                  sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="472864016" ~ "Broken", 
                  sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="550088682" ~ "Temparture Too Low",
                  sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="561005927" ~ "Cent Low",
                  sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="635875253" ~ "Broken Gel",
                  sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="654002184" ~ "Centrifuge Too Long",
                  sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="684617815" ~ "MisLabled Discard",
                  sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="690540566" ~"Tempature Too High",
              sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="728366619" ~"Low Volume-(tube/container partially filled but still usable)",
              sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="742806035" ~"MW < 30s",
              sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="757246707" ~"Leak/Spilled",
              sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="777486216" ~"Tube Size",
              sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="810960823" ~"Discard",
              sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="861162895" ~"Cent High",
              sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="912088602" ~"Clot > 2h",
              sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="937362785" ~"Centrifuge Too Short",
              sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="956345366" ~"Insufficient Volume",
              sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="982885431" ~ "Not Found"))
notcol_tubes <- colnames(biospe)[grepl("883732523",colnames(biospe))] #7
col_tubes <- colnames(biospe)[grepl("d_593843561",colnames(biospe))] #13
dev_tubes <- colnames(biospe)[grepl("d_678857215",colnames(biospe))] #13
notcol.ls <- sapply(strsplit(notcol_tubes, "_d"),"[[",1)
   notcol_tube <- NULL
   tubenotcol.ls <-list()
 
   for (i in 1:length(notcol.ls)){
     
     tubecol <- paste(notcol.ls[i],"d_593843561",sep="_")
     tube_notcol <- paste(notcol.ls[i],"d_883732523", sep="_") #notcolnotes
     TubeID <- paste(tube.ls[i],"d_825582494",sep="_")
     #tube_notcolnotes <- paste(tube.ls[i],"d_338286049", sep="_")
     tube_deviation <- paste(notcol.ls[i], "d_678857215",sep="_")
     #tube_devnotes <- paste(notcol.ls[i],"d_536710547",sep="_") 
     #select <- c(tubecol,tube_notcol,tube_notcolnotes,tube_deviation,tube_devnotes)
     select <- c(TubeID,tubecol,tube_notcol,tube_deviation)
     tmp <- biospe[,(colnames(biospe)%in% c(select,"d_820476880","Site","biocol_Setting"))] 
     notcol <- tmp 
     colnames(notcol)[colnames(notcol)==TubeID] <- "TubeID"
     colnames(notcol)[colnames(notcol)==tubecol] <- "tubecol"
     colnames(notcol)[colnames(notcol)==tube_notcol] <- "tube_notcol"
     #colnames(notcol)[colnames(notcol)==tube_notcolnotes] <- "tube_notcolnotes"
     colnames(notcol)[colnames(notcol)==tube_deviation] <- "tube_deviation"
     #colnames(notcol)[colnames(notcol)==tube_devnotes] <- "tube_deviationnotes"
     
     #if(!grepl("tube_notcolnotes",colnames(notcol))){notcol$tube_notcolnotes <- NA}   
     #if(!grepl("tube_deviationnotes",colnames(notcol))){notcol$tube_deviationnotes <- NA} 
     
     notcol$tubeID <- notcol.ls[i]
     #notcol1 <- notcol[which(notcol$tubecol==104430631),] 
     notcol_tube <- dplyr::bind_rows(notcol_tube,notcol)
     #tubenotcol.ls[[i]] <- notcol1
     #collection_long <- dplyr::bind_rows(collection_long,notcol)
   } 
   
   #collection_long <- as.data.frame(do.call("rbind",notcol_tube))
   
   ##collected tube and deviaton (both have the same length oftubes)
      collection_long <- NULL
   for (i in 1:length(tube.ls)){
     
     tubeid <- paste(tube.ls[i],"d_825582494",sep="_")
     tubecol <- paste(tube.ls[i],"d_593843561",sep="_")
     tube_deviation <- paste(tube.ls[i], "d_678857215",sep="_")
     tube_discard <- paste(tube.ls[i], "d_762124027",sep="_")
     #select <- c(tubecol,tube_notcol,tube_notcolnotes,tube_deviation,tube_devnotes)
     select <- c(tubeid,tubecol,tube_deviation,tube_discard)
     tmp <- biospe[,(colnames(biospe)%in% c(select,"d_820476880","Site","biocol_Setting"))] 
     col <- tmp 
     colnames(col)[colnames(col)==tubeid] <- "TubeID"
     colnames(col)[colnames(col)==tubecol] <- "tubecol"
     colnames(col)[colnames(col)==tube_deviation] <- "tube_deviation"
     colnames(col)[colnames(col)==tube_discard] <- "tube_discard"
     
     col$tubeID <- tube.ls[i]
     collection_long <- dplyr::bind_rows(collection_long,col)
   } 
   
   collection_long <- collection_long  %>% 
     dplyr:: mutate(deviation = case_when(tube_deviation == 353358909 ~ "Any Deviation",
                                          tube_deviation == 104430631 ~ "No Deviation"),
                    Collected = case_when(tubecol ==353358909 ~ "Collected",
                                          tubecol == 104430631 ~ "Not  Collected"),
                    Discarded = case_when(tube_discard == 353358909 ~ "Any Discard",
                                          tube_discard == 104430631 ~ "No Discard"),
                    biospecimen=ifelse(tubeID=="d_973670172", "urine",
                                  ifelse(tubeID=="d_143615646","Mouthwash","blood")),
                    tube_type = case_when(tubeID == "d_973670172"  ~ "Urine Tube1",
                                          tubeID == "d_143615646"  ~ "MW Tube1",
                                          tubeID == "d_299553921"  ~ "SS Tube1",
                                          tubeID == "d_703954371"  ~ "SS Tube2",
                                          tubeID == "d_454453939"  ~ "EDTA Tube1",
                                          tubeID == "d_838567176"  ~ "Heparin Tube1",
                                          tubeID == "d_652357376"  ~ "ACD Tube1",
                                          tubeID == "d_677469051"  ~ "EDTA Tube2",
                                          tubeID == "d_683613884"  ~ "EDTA Tube3",
                                          tubeID == "d_376960806"  ~ "SS Tube3",
                                          tubeID == "d_232343615"  ~ "SS Tube4",
                                          tubeID == "d_589588440"  ~ "SS Tube5",
                                          tubeID == "d_958646668"  ~ "Heparin Tube2"))
  collection_long$tube_type <- factor(collection_long$tube_type, levels=c("SS Tube1", "SS Tube2","SS Tube3", "SS Tube4", "SS Tube5","Heparin Tube1","Heparin Tube2","EDTA Tube1", "EDTA Tube2","EDTA Tube3","ACD Tube1","Urine Tube1","MW Tube1" ) )  
     
   Table17_option2 <- collection_long %>% mutate(deviation = dplyr::case_when(tube_deviation == 353358909 ~ "Any Deviation",
                                                                              tube_deviation == 104430631 ~ "No Deviation"),
                                                   Collected = dplyr::case_when(tubecol ==353358909 ~ "Collected",
                                                                                tubecol == 104430631 ~ "Not Collected")) %>%  #filter(d_650516960==534621077 & !is.na(d_331584571_d_266600170_d_343048998) ) %>% 
     select(Site,deviation) %>%
     tbl_cross(    col = deviation,
                   row = Site,
                   percent = "row",
                   #label=(),
                   missing="no") %>%
     bold_labels() %>%
     italicize_levels() %>% 
     modify_header() %>%
     modify_caption("Table 17. Number (and percent) of tubes with any deviation by site") %>%
     as_kable()#tab_header(title = "Patient Characteristics", subtitle = "Presented by treatment")
   
   
   dev_tube1$tube_dev <- paste(dev_tube1$tube_type,"Deviation", dev_tube1$deviationnotes,sep=" ")
   dev_tube1$tubeID <- substr(dev_tube1$dev_type,1,11)
  dev <- collection_long %>% filter(tube_deviation==353358909) 
  dev_tube2 <- merge(dev,dev_tube1[,c("dev_type","TubeID","tubeID","deviationnotes","tube_dev")],by.x=c("TubeID","tubeID"), by.y=c("TubeID","tubeID")) ##to get the deviation notes


#This is referencred directly in table 12  
  dev_count <- dev_tube2 %>% group_by(biocol_Setting,biospecimen,tube_dev) %>%   dplyr::summarize(count=n()) 
  #dev_count <- dev_count[3:4] #removed setting and type as requested-- maybe add that when table is actually ran?
  #dev_count <- dev_count %>%  mutate(Site=droplevels(Site))   #try this for later filtering 
  colnames(dev_count) <- c("Deviation","Number")
  
  
    ##trying to filter table 12 by site
#  dev_count.site <- list()
# dev_tube2$Site <- droplevels(dev_tube2$Site)
# for(site in unique(dev_tube2$Site)){
#   
#   site.sub <- dev_tube2 %>% filter(Site==site) %>% 
#     group_by(Site, biocol_Setting,biospecimen,tube_dev) %>% dplyr::tally() 
#   total <- as.numeric(nrow(dev_tube2[which(dev_tube2$Site==site),]))
#   site.sub$pct <- round(100*site.sub$n/total,digits=1)
#   site.sub$cumcount <- cumsum(site.sub$n)
#   site.sub$cumpct <- round(100*cumsum(site.sub$n)/total,digits=1)
#   dev_count.site[[site]] <- site.sub
# }
  
   dev_count.site <- list() 
dev_tube2$Site <- droplevels(dev_tube2$Site)
for(site in unique(dev_tube2$Site)){
  
  site.sub <- dev_tube2 %>% filter(Site==site) %>% 
    group_by(tube_dev) %>% dplyr::tally() 
  total <- as.numeric(nrow(dev_tube2[which(dev_tube2$Site==site),]))
  dev_count.site[[site]] <- site.sub
}
  
  
  
  
  

 
 

### Table 8 (NOW TABLE 8, previously 13) --- 8.1 ON HOLD , will hybrid be a setting added to the DD?
  ##Table19Number of tube tubes not collected at research collection visits
  ###as Stephanie commended for the order "Order columns to match draw order:"SST1, SST2, Heprarin, EDTA, ACD, Urine, Mouthwash "
  
  research.coltube<- collection_long %>% filter(biocol_Setting == "Research" & tubecol == 104430631) %>%     
    mutate(Site=droplevels(Site),
           tube_type = factor(tube_type,levels=c("SS Tube1", "SS Tube2","Heparin Tube1","EDTA Tube1","ACD Tube1","Urine Tube1","MW Tube1" )))
  
  
    research.coltube.bld.only<- collection_long %>% filter(biocol_Setting == "Research" & tubecol == 104430631) %>% 
    mutate(Site=droplevels(Site),
           tube_type = factor(tube_type,levels=c("SS Tube1", "SS Tube2","Heparin Tube1","EDTA Tube1","ACD Tube1")))
    research.coltube.bld.only<- research.coltube.bld.only %>%  mutate(tube_type=droplevels(tube_type))

 
  
#ctable <-  as.data.frame(xtabs(~Site+tube_type, research.coltube))
  # research.coltube.blood <- research.coltube %>% filter(research.coltube$tube_type=="SS Tube1" | research.coltube$tube_type=="SS Tube2" |
  #                                                                                           research.coltube$tube_type=="Heparin Tube1" | research.coltube$tube_type== "EDTA"|
  #                                                                                           research.coltube$tube_type=="ACD Tube1")
  #ctable <-  CrossTable(research.coltube$Site, research.coltube.blood)
  #research.coltube.blood$tube_type
    
    
#ctable <-  CrossTable(research.coltube$Site, research.coltube$tube_type)
ctable <-  CrossTable(research.coltube.bld.only$Site, research.coltube.bld.only$tube_type)


nocol.type <- as.data.frame(cbind(ctable$t,ctable$prop.col))

  pct_n <- function(x,y){ paste0(x,"( ", round(100*y,1), " %)")}
      count <- as.data.frame.matrix(ctable$t) # to convert the S3 table into the same dimention table via as.data.frame.matrix
      perc <- as.data.frame.matrix(ctable$prop.col)
      
      
   pct_n2 <- function(x,y){ paste0(x,"( ", round(100*y,1), " %)")}
      count2 <- as.data.frame.matrix(ctable$t) # to convert the S3 table into the same dimention table via as.data.frame.matrix
      perc2 <- as.data.frame.matrix(ctable$prop.col)     


  #notcol_combo = array(pct_n(ctable$t,ctable$prop.col),dim=c(5,7))
  notcol_combo = array(pct_n(ctable$t,ctable$prop.col),dim=c(5,5))

  notcol_combo <- as.data.frame(notcol_combo)
  colnames(notcol_combo) <- colnames(count2)
  #notcol_combo <- notcol_combo[, c(1:5)] # I added to get rid of MW and Urine, to fix total column
  
  count2$Total.NotCol <- apply(count2,1,sum)
  total <- sum(count2)
  #notcol_combo$Total.Notcol <- paste0(apply(count[c(1:5),c(1:7)],1,sum), "( ", round(100*apply(count2[c(1:5),c(1:7)],1,sum)/total,2), " %)")
  notcol_combo$Total.Notcol <- paste0(count2$Total.NotCol, "( ", round(100*count2$Total.NotCol/sum(count2$Total.NotCol),1), " %)")
  
  notcol_combo$Site <- rownames(count2)

  #notcol_combo[6,c(1:8)] <- as.character(apply(count,2,sum))
notcol_combo[6,c(1:6)] <- as.character(apply(count2,2,sum))
  notcol_combo$Site[is.na(notcol_combo$Site)] <- replace_na("Total") 
  
  
  
  
  

## Table 8.1 ON HOLD , will hybrid be a setting added to the DD?
      # for now just filtering by site=HF, as its the only hybrid site right now

  research.coltube8_1<- collection_long %>% filter(biocol_Setting == "Clinical" & Site == "Henry Ford Health System" & tubecol == 104430631) %>%
    mutate(Site=droplevels(Site),
           tube_type = factor(tube_type,levels=c("SS Tube1", "SS Tube2","Heparin Tube1","EDTA Tube1","ACD Tube1","Urine Tube1","MW Tube1" )))


    research.coltube8_1.bld.only<- collection_long %>% filter(biocol_Setting == "Clinical" & Site == "Henry Ford Health System" & tubecol == 104430631) %>%
    mutate(Site=droplevels(Site),
           tube_type = factor(tube_type,levels=c("SS Tube1", "SS Tube2", "SS Tube3", "SS Tube4","Heparin Tube1", "Heparin Tube2","EDTA Tube1", "EDTA Tube2", "EDTA Tube3"))) #,"ACD Tube1"
    research.coltube8_1.bld.only<- research.coltube8_1.bld.only %>%  mutate(tube_type=droplevels(tube_type))



#ctable <-  as.data.frame(xtabs(~Site+tube_type, research.coltube8_1))
  # research.coltube8_1.blood <- research.coltube8_1 %>% filter(research.coltube8_1$tube_type=="SS Tube1" | research.coltube8_1$tube_type=="SS Tube2" |
  #                                                                                           research.coltube8_1$tube_type=="Heparin Tube1" | research.coltube8_1$tube_type== "EDTA"|
  #                                                                                           research.coltube8_1$tube_type=="ACD Tube1")
  #ctable <-  CrossTable(research.coltube8_1$Site, research.coltube8_1.blood)
  #research.coltube8_1.blood$tube_type


#ctable <-  CrossTable(research.coltube8_1$Site, research.coltube8_1$tube_type)
ctable <-  CrossTable(research.coltube8_1.bld.only$Site, research.coltube8_1.bld.only$tube_type)


nocol.type <- as.data.frame(cbind(ctable$t,ctable$prop.col))

  pct_n <- function(x,y){ paste0(x,"( ", round(100*y,1), " %)")}
      count <- as.data.frame.matrix(ctable$t) # to convert the S3 table into the same dimention table via as.data.frame.matrix
      perc <- as.data.frame.matrix(ctable$prop.col)


   pct_n2 <- function(x,y){ paste0(x,"( ", round(100*y,1), " %)")}
      count8_1 <- as.data.frame.matrix(ctable$t) # to convert the S3 table into the same dimention table via as.data.frame.matrix
      perc2 <- as.data.frame.matrix(ctable$prop.col)


  #notcol_combo8_1 = array(pct_n(ctable$t,ctable$prop.col),dim=c(5,7))
  notcol_combo8_1 = array(pct_n(ctable$t,ctable$prop.col),dim=c(5,5))

  notcol_combo8_1 <- as.data.frame(notcol_combo8_1)
  colnames(notcol_combo8_1) <- colnames(count8_1)
  #notcol_combo8_1 <- notcol_combo8_1[, c(1:5)] # I added to get rid of MW and Urine, to fix total column

  count8_1$Total.NotCol <- apply(count8_1,1,sum)
  total <- sum(count8_1)
  #notcol_combo8_1$Total.Notcol <- paste0(apply(count[c(1:5),c(1:7)],1,sum), "( ", round(100*apply(count8_1[c(1:5),c(1:7)],1,sum)/total,2), " %)")
  notcol_combo8_1$Total.Notcol <- paste0(count8_1$Total.NotCol, "( ", round(100*count8_1$Total.NotCol/sum(count8_1$Total.NotCol),2), " %)")

  notcol_combo8_1$Site <- rownames(count8_1)

  #notcol_combo8_1[6,c(1:8)] <- as.character(apply(count,2,sum))
notcol_combo8_1[6,c(1:6)] <- as.character(apply(count8_1,2,sum))
  notcol_combo8_1$Site[is.na(notcol_combo8_1$Site)] <- replace_na("Total")

  
  
  
  
  
  




  
  ### Table 9-- previously 14
Tb.research.coltube <- research.coltube %>% select(tube_type,Site) %>% 
  tbl_cross(  col = tube_type,
                  row = Site,
                   percent = "col",
                   digits= c(0,1),
                   #label=(),
                   missing="ifany",
                   missing_text="0 ( 0 %)",
                   margin_text = "Tube Not Collected") %>%
     modify_header() %>%
     modify_caption("Table 19. Number of Tube Not Collected at Research Collection Visits") %>%
     as_kable_extra()

## Number of tube tubes not collected at clinical collections

  clinic.coltube<- collection_long %>% 
  filter((Site=="Kaiser Permanente Colorado" | Site=="Kaiser Permanente Georgia" | Site=="Kaiser Permanente Northwest" | Site=="Kaiser Permanente Hawaii" | Site=="Henry Ford Health System") & tubecol == 353358909) %>%  ###changed to filter = yes, removed biocol_Setting == "Clinical", changed to KP + HP,  remove | Site=="HealthPartners"
    #filter(biocol_Setting == "Clinical" & tubecol == 353358909) %>%  ## ON HOLD- HYBIRD HF needs to be included, so clinical setting should include it 
    #filter((Site=="Kaiser Permanente Colorado" | Site=="Kaiser Permanente Georgia" | Site=="Kaiser Permanente Northwest" | Site=="Kaiser Permanente Hawaii" | Site=="Henry Ford Health System") & tubecol == 353358909) %>%
    mutate(Site=droplevels(Site),
           tube_type = factor(tube_type,levels=c("SS Tube1", "SS Tube2","SS Tube3", "SS Tube4", "SS Tube5", "Heparin Tube1","Heparin Tube2","EDTA Tube1","EDTA Tube2","EDTA Tube3","ACD Tube1","Urine Tube1" )))
  
  clinic.coltube <- clinic.coltube %>%  filter(biocol_Setting == "Clinical")
  
clinic.ctable<- CrossTable(clinic.coltube$Site,clinic.coltube$tube_type)
count <- as.data.frame.matrix(clinic.ctable$t)
perc <- as.data.frame.matrix(clinic.ctable$prop.col)

#notcol_combo2 <- array(pct_n(clinic.ctable$t,clinic.ctable$prop.col), dim=c(5,12)) ##think this should be 4 without HP  
notcol_combo2 <- array(pct_n(clinic.ctable$t,clinic.ctable$prop.col), dim=c(5,12)) #changed back to 5 with HF hybrid

  notcol_combo2 <- as.data.frame(notcol_combo2)
  colnames(notcol_combo2) <- colnames(count)
  
  count$Total.NotCol <- apply(count,1,sum)
  total <- sum(count)
  #notcol_combo2$Total.Notcol <- paste0(apply(count[c(1:5),],1,sum), "( ", round(100*apply(count,1,sum)/total,2), " %)") #should this also be 1:4??
  #notcol_combo2$Total.Notcol <- paste0(apply(count[c(1:4),],1,sum), "( ", round(100*apply(count,1,sum)/total,2), " %)")
  
  notcol_combo2$Site <- rownames(count)

  notcol_combo2[6,c(1:13)] <- as.character(apply(count,2,sum))
  notcol_combo2[6,13] <- NA
  notcol_combo2$Site[is.na(notcol_combo2$Site)] <- replace_na("Total")  
  notcol_combo2 <- notcol_combo2[, c(13, 1:11)]
  #notcol_combo2[5,1] <- "Total"
#View(notcol_combo2)   
 



  
  
  
  
  
  
  
## Table 15  
##Table X: Reason not collected by tube type and by site for research collections only
  a<- collection_long[which(collection_long$tubecol==104430631),]
  b <- notcol_tube[which(notcol_tube$tubecol == 104430631),]
  notcol_notes <- merge(a, b[,c("tubeID","d_820476880","tube_notcol")], by=c("tubeID","d_820476880"),all.x=TRUE)
notcol_notes <- notcol_notes %>% 
  mutate(notcol.notes = case_when(tubecol == 104430631 & tube_notcol==181769837 ~ "Other",
                                  tubecol == 104430631 & tube_notcol==234139565 ~ "Short Draw",
                                  tubecol == 104430631 & tube_notcol==681745422 ~ "Participant Refusal",
                                  tubecol == 104430631 & tube_notcol==745205161 ~ "Participant Attempted",
                                  tubecol == 104430631 & tube_notcol==889386523 ~ "Supply Unavailable",
                                  tubecol == 104430631 & is.na(tube_notcol) ~ "Missing Reasons"),
         Collected = case_when(tubecol ==353358909 ~ "Collected",
                               tubecol == 104430631 ~ "Not  Collected"),
                    biospecimen=ifelse(tubeID=="d_973670172", "urine",
                                  ifelse(tubeID=="d_143615646","Mouthwash","blood")),
                    tube_type = case_when(tubeID == "d_973670172"  ~ "Urine Tube1",
                                          tubeID == "d_143615646"  ~ "MW Tube1",
                                          tubeID == "d_299553921"  ~ "SS Tube1",
                                          tubeID == "d_703954371"  ~ "SS Tube2",
                                          tubeID == "d_454453939"  ~ "EDTA Tube1",
                                          tubeID == "d_838567176"  ~ "Heparin Tube1",
                                          tubeID == "d_652357376"  ~ "ACD Tube1",
                                          tubeID == "d_677469051"  ~ "EDTA Tube2",
                                          tubeID == "d_683613884"  ~ "EDTA Tube3",
                                          tubeID == "d_376960806"  ~ "SS Tube3",
                                          tubeID == "d_232343615"  ~ "SS Tube4",
                                          tubeID == "d_589588440"  ~ "SS Tube5",
                                          tubeID == "d_958646668"  ~ "Heparin Tube2"))
notcol_notes$tube_type <- factor(notcol_notes$tube_type, levels=c("SS Tube1", "SS Tube2","SS Tube3", "SS Tube4", "SS Tube5","Heparin Tube1","Heparin Tube2","EDTA Tube1", "EDTA Tube2","EDTA Tube3","ACD Tube1","Urine Tube1","MW Tube1" ) ) 
notcol_notes$notcol.notes <- factor(notcol_notes$notcol.notes, levels=c("Short Draw","Participant Attempted", "Other", "Participant Refusal", "Supply Unavailable", "Missing Reasons"))




n_pct_table <- function(x,y){
  #x<-clinicnotes.notcol$Site
  #y<-clinicnotes.notcol$notcol.notes
  ctable<- CrossTable(x,y)
count <- as.data.frame.matrix(ctable$t)
perc <- as.data.frame.matrix(ctable$prop.col)
n<- as.numeric(length(levels(x)))
m <- as.numeric(length(levels(y)))
tb_combo <- array(pct_n(ctable$t,ctable$prop.col),dim=c(n,m)) 
  tb_combo <- as.data.frame(tb_combo)
  colnames(tb_combo) <- colnames(count)
  
  total <- sum(count)
  count$Total <- apply(count,1,sum)
  tb_combo$Total <- paste0(count$Total, "( ", round(100*(count$Total)/total,1), " %)")
  
  tb_combo$Site <- rownames(count)
  tb_combo[(n+1),c(1:(m+1))] <- as.character(apply(count,2,sum))
  tb_combo$Site[is.na(tb_combo$Site)] <- replace_na("Total")  
  return(tb_combo)
}
research.notcol <- notcol_notes %>% filter(biocol_Setting=="Research" & tubecol==104430631) %>% 
   mutate(Site=droplevels(Site),
           tube_type = factor(tube_type,levels=c("SS Tube1", "SS Tube2","Heparin Tube1","EDTA Tube1","ACD Tube1","Urine Tube1","MW Tube1" )))
research.notcol$notcol.notes <- factor(research.notcol$notcol.notes, levels=c("Short Draw","Participant Attempted", "Participant Refusal", "Supply Unavailable","Other",  "Missing Reasons"))
#research.notcol$notcol.notes <- droplevels(research.notcol$notcol.notes)
reseachnotes.notcol <- n_pct_table(research.notcol$Site,research.notcol$notcol.notes)
reseachnotes.coltype <- n_pct_table(research.notcol$tube_type,research.notcol$notcol.notes)
notcol.reasons.research <- rbind(reseachnotes.notcol,reseachnotes.coltype)


research.notcolnotes_site <- research.notcol %>% select(notcol.notes,Site) %>% 
  tbl_cross(  col = notcol.notes,
                  row = Site,
                   percent = "row",
                   digits= c(0,1),
                   label= c(notcol.notes~ " ", Site ~ " "),
                   missing="ifany",
                   missing_text="0 ( 0 %)")%>%
     modify_header() %>%
     modify_caption("Table 15a. Reason Not Collected for Tubes Not Collected at Research Collection Visits by Site") %>% 
  as_kable_extra() %>% kable_styling(latex_options = "scale_down")
research.notcolnotes_site


research.notcolnotes_tube <- research.notcol %>% select(notcol.notes, tube_type) %>%
  tbl_cross(  col = notcol.notes,
                  row = tube_type,
                   percent = "row",
                   digits= c(0,1),
                   label= c(notcol.notes~ " ", tube_type~" "),
                   missing="ifany",
                   missing_text="0 ( 0 %)")%>%
     modify_header() %>%
     modify_caption("Table 15b. Reason Not Collected for Tubes Not Collected at Research Collection Visits by Tube Type") %>%
     as_kable_extra() %>% kable_styling(latex_options = "scale_down")
research.notcolnotes_tube


# research.notcolnotes_tube <- reseachnotes.coltype %>% select(notcol.notes, tube_type) %>% 
#   tbl_cross(  col = notcol.notes,
#                   row = tube_type,
#                    percent = "row",
#                    digits= c(0,1),
#                    #label= c(notcol.notes~ "", tube_type~"Tube Type"),
#                    missing="ifany",
#                    missing_text="0 ( 0 %)")%>%
#      modify_header() %>%
#      modify_caption("Table 15b. Reason Not Collected for Tubes Not Collected at Research Collection Visits by Tube Type") %>%
#      as_kable_extra()
# research.notcolnotes_tube

# research.notcolnotes_space <- rbind(research.notcolnotes_site, research.notcolnotes_tube)
# research.notcolnotes_space







## Was Table16---- now deleted
#notcol_notes<- merge(collection_long,notcol_tube,by="tubeID")
research.notcolnotes <- research.notcol %>% select(notcol.notes,Site, tube_type) %>% crosstable(c(Site, tube_type),by=notcol.notes,showNA="ifany", total="row",margin=c("row", "col"),
           percent_digits=1, percent_pattern="{n} ({p_col})") %>% as_flextable() #%>% as_flex_table()  
clinicnotes.notcol <- notcol_notes %>% filter(biocol_Setting=="Clinical" & tubecol==104430631 & notcol_notes$biospecimen!="Mouthwash"  )%>%    mutate(Site=droplevels(Site),
           tube_type = factor(tube_type,levels=c("SS Tube1", "SS Tube2","SS Tube3", "SS Tube4", "SS Tube5","Heparin Tube1","Heparin Tube2","EDTA Tube1", "EDTA Tube2","EDTA Tube3","ACD Tube1","Urine Tube1" )))
          
clinicnotes.notcol$notcol.notes <- factor(clinicnotes.notcol$notcol.notes, levels=c("Short Draw","Participant Attempted", "Other", "Participant Refusal", "Supply Unavailable", "Missing Reasons"))
clinicnotes.notcol$notcol.notes <- droplevels(clinicnotes.notcol$notcol.notes)
clinicnotes.notcol$tube_type = droplevels(clinicnotes.notcol$tube_type)
clinic.notcolsite <- n_pct_table(clinicnotes.notcol$Site,clinicnotes.notcol$notcol.notes)
clinicnotes.coltype <- n_pct_table(clinicnotes.notcol$tube_type,clinicnotes.notcol$notcol.notes)
notcol.reasons.clinic <- rbind(clinicnotes.coltype,clinic.notcolsite)
reasons <- c("Short Draw","Participant Attempted", "Other", "Participant Refusal", "Supply Unavailable", "Missing Reasons")
missing <- reasons[which(c(reasons,"Site","Total") %nin% colnames(notcol.reasons.clinic))]
n.col <- as.numeric(ncol(notcol.reasons.clinic))
for (i in 1:length(missing)){
notcol.reasons.clinic[,(n.col+i)] <- "0 (0 %)"
  colnames(notcol.reasons.clinic)[n.col+i] <- missing[i]
}
notcol.reasons.clinic[c(13,19),c((n.col+1):8)] <- "0"






## Table 16 
#Table Number of tube tubes Discarded by tube type and site
discard.tb <- collection_long  %>% filter(tube_discard == 353358909) %>% 
  mutate(Site=droplevels(Site),
           tube_type = droplevels(tube_type))
discard.site <- n_pct_table(discard.tb$Site,discard.tb$tube_type)
discard.site <- (discard.site[, c(10, 1:9)])






###back to the recruitment table
biospe.tm <- recrvar.bio$column_name[which(grepl("Date|time|Time", recrvar.bio$Variable.Label))]
recrvar.bio[which(grepl("Date|time|Time", recrvar.bio$Variable.Label)),c("field_path","Variable.Label")]
#                              field_path                                                     Variable.Label
# 12  d_173836415_d_266600170_d_139245758                                 Date/time Clinical Urine collected
# 43                          d_222161762          Date/Time blood/urine/mouthwash research survey completed
# 48  d_173836415_d_266600170_d_224596428                       Clinical Site Urine RRL Date / Time Received
# 85  d_331584571_d_266600170_d_343048998                                            Time check out complete
# 100                         d_390198398                            Date/time refused baseline blood sample
# 101 d_173836415_d_266600170_d_398645039                           Clinical DB blood RRL Date/Time Received
# 121 d_173836415_d_266600170_d_448660695                                      Date/time Mouthwash Collected
# 156                         d_534669573                    Date/time Status of Start of blood/urine survey
# 161 d_173836415_d_266600170_d_541311218                           Clinical DB urine RRL Date/Time received
# 170 d_173836415_d_266600170_d_561681068                                 Date/time Research Blood Collected
# 240 d_173836415_d_266600170_d_740582332    Autogenerated date/time stamp for Any specimen collected at RRL
# 247                         d_764863765                             Date/Time blood/urine survey completed
# 249 d_173836415_d_266600170_d_769615780                                       Date/Time Blood Order Placed
# 260                         d_808663245                            Date/time refused baseline urine sample
# 266 d_173836415_d_266600170_d_822274939                       Clinical Site Blood RRL Date / Time Received
# 267                         d_822499427 Date/time Status of Start of blood/urine/mouthwash research survey
# 276 d_331584571_d_266600170_d_840048338                                        Date/Time Check-In Complete
# 278 d_173836415_d_266600170_d_847159717                                 Date/time Research Urine collected
# 306 d_173836415_d_266600170_d_939818935                                       Date/Time Urine Order Placed
# 319 d_173836415_d_266600170_d_982213346                                 Date/time Clinical Blood Collected
recrvar.bio[which(grepl("Survey", recrvar.bio$Primary.Source)),c("field_path","Primary.Source","Variable.Label")]
#      field_path Primary.Source                                                     Variable.Label
# 43  d_222161762         Survey          Date/Time blood/urine/mouthwash research survey completed
# 52  d_253883960         Survey                                        Flag for blood/urine survey
# 58  d_265193023         Survey                     Blood/urine/mouthwash combined research survey
# 156 d_534669573         Survey                    Date/time Status of Start of blood/urine survey
# 164 d_547363263         Survey                                          Flag for mouthwash survey
# 247 d_764863765         Survey                             Date/Time blood/urine survey completed
# 267 d_822499427         Survey Date/time Status of Start of blood/urine/mouthwash research survey





##Table 17
recr.biospe <- merge(recr.bio,tube_col,by="Connect_ID")
recr.biospe <- recr.biospe %>%
  mutate(research.sv = case_when(d_265193023 == 231311385 ~ "Submitted",
                                 d_265193023 == 615768760 ~ "Started",
                                 d_265193023 == 972455046 ~ "Not Started"),
          clinic.sv = case_when(d_253883960 == 231311385 ~ "Submitted",
                               d_253883960 == 615768760 ~ "Started",
                               d_253883960 == 972455046 ~ "Not Started"))
##Total number and percent of research biospecimen survey status
research.survey <- recr.biospe %>% filter(d_650516960 == 534621077)
 research.survey <- research.survey %>% 
   mutate(research.svtime =  difftime(as.POSIXct(ymd_hms(d_222161762)),as.POSIXct(ymd_hms(d_822499427)),units="hours"),##survey time from start to complete
         tm_biocolsuv = difftime(as.POSIXct(ymd_hms(d_222161762)),as.POSIXct(ymd_hms(d_331584571_d_266600170_d_840048338)),units="hours")) #time between survey completion to biospecimen collection visit check in
research.survey <-research.survey %>%
  # mutate(checktmvisit = ifelse( as.numeric(tm_biocolsuv) >72,"Greater than 72hrs (3 days)",
  #                       ifelse( 72 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 48, "> 48 hrs to 72 hrs",
  #                         ifelse( 48 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 24, "> 24 hrs to 48 hrs",   
  #                           ifelse( 24 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 12, "> 12 hrs to 24 hrs",
  #                             ifelse( 12 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 3, "> 3 hrs to 12 hrs",      
  #                                ifelse( 3 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) >= 0, "0 hrs to 3 hrs","Not Submitted")))))),
  #                                #ifelse(d_265193023 != 231311385, "Not Submitted", "Missing Time"))))))), #changed from NA to "Missing"
           mutate(checktmvisit = case_when( as.numeric(tm_biocolsuv) >72 ~"Greater than 72hrs (3 days)",
                                            72 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 48 ~ "> 48 hrs to 72 hrs",
                                            48 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 24 ~ "> 24 hrs to 48 hrs",   
                                            24 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 12 ~ "> 12 hrs to 24 hrs",
                                            12 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 3 ~ "> 3 hrs to 12 hrs",  
                                            3 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) >= 0 ~ "0 hrs to 3 hrs",
                                            d_265193023 != 231311385 ~ "Not Submitted", 
                                            TRUE ~ "Missing Time"), #changed from NA to "Missing"
         time_biochk = difftime(as.POSIXct(ymd_hms(d_331584571_d_266600170_d_343048998)),as.POSIXct(ymd_hms(d_331584571_d_266600170_d_840048338)),units="mins"))
research.survey$biochk_outlier <- ifelse(is.na(research.survey$time_biochk), "Missing (not checked out)", ifelse( 0<= as.numeric(research.survey$time_biochk)/60 & as.numeric(research.survey$time_biochk)/60 <= 24, "No Outlier", ifelse(as.numeric(research.survey$time_biochk)/60 > 24, "Outlier",  "Undefined")) )   
research.survey$biochk_outlier <- factor(research.survey$biochk_outlier,levels=c("No Outlier","Outlier","Missing (not checked out)"))
research.survey$checktmvisit <- factor(research.survey$checktmvisit, levels=c( "Not Submitted", "Missing Time", "0 hrs to 3 hrs","> 3 hrs to 12 hrs","> 12 hrs to 24 hrs","> 24 hrs to 48 hrs","> 48 hrs to 72 hrs","Greater than 72hrs (3 days)")) 
research.survey[which(research.survey$research.svtime <0),c("Connect_ID","d_650516960","Site","d_265193023","d_222161762","d_822499427")]
#     Connect_ID d_650516960                            Site d_265193023              d_222161762              d_822499427
# 259 2848814334   534621077 Marshfield Clinic Health System   231311385 2022-08-26T08:00:00.000Z 2022-08-30T00:43:06.653Z
# 274 2927684519   534621077 Marshfield Clinic Health System   231311385 2022-11-16T08:00:00.000Z 2022-11-30T22:39:24.145Z
# 337 3342756222   534621077                  HealthPartners   231311385 2022-10-22T08:00:00.000Z 2022-11-08T03:48:34.373Z
# 661 5226692703   534621077                  HealthPartners   231311385 2022-08-15T08:00:00.000Z 2022-08-15T22:49:30.154Z
##these four participants' survey time viloted the time sequential rule
research.survey[which(as.numeric(research.survey$tm_biocolsuv)<0),c("Connect_ID","d_650516960","Site","d_265193023","d_222161762","d_822499427","d_331584571_d_266600170_d_840048338")]
#     Connect_ID d_650516960                            Site d_265193023              d_222161762              d_822499427
# 274 2927684519   534621077 Marshfield Clinic Health System   231311385 2022-11-16T08:00:00.000Z 2022-11-30T22:39:24.145Z
#     d_331584571_d_266600170_d_840048338
# 274            2022-11-16T13:10:58.573Z
sv.complete <- as.data.frame(tab1(research.survey$research.sv))
sv.complete <- sv.complete %>% mutate(cumulative.Freq = ifelse(output.table.Percent<100.0, cumsum(output.table.Frequency),output.table.Frequency)) 



#17b. Grouped by site--Research
research.surveyHP <- research.survey %>%  filter(Site=="HealthPartners")
research.surveyHF <- research.survey %>%  filter(Site=="Henry Ford Health System")
research.surveyMF <- research.survey %>%  filter(Site=="Marshfield Clinic Health System")
research.surveySH <- research.survey %>%  filter(Site=="Sanford Health")
research.surveyUC <- research.survey %>%  filter(Site=="University of Chicago Medicine")

sv.completeHP <- as.data.frame(tab1(research.surveyHP$research.sv))
sv.completeHP <- sv.completeHP %>% mutate(cumulative.Freq = ifelse(output.table.Percent<100.0, cumsum(output.table.Frequency),output.table.Frequency)) 

sv.completeHF <- as.data.frame(tab1(research.surveyHF$research.sv))
sv.completeHF <- sv.completeHF %>% mutate(cumulative.Freq = ifelse(output.table.Percent<100.0, cumsum(output.table.Frequency),output.table.Frequency)) 

sv.completeMF <- as.data.frame(tab1(research.surveyMF$research.sv))
sv.completeMF <- sv.completeMF %>% mutate(cumulative.Freq = ifelse(output.table.Percent<100.0, cumsum(output.table.Frequency),output.table.Frequency)) 

sv.completeSH <- as.data.frame(tab1(research.surveySH$research.sv))
sv.completeSH <- sv.completeSH %>% mutate(cumulative.Freq = ifelse(output.table.Percent<100.0, cumsum(output.table.Frequency),output.table.Frequency)) 

sv.completeUC <- as.data.frame(tab1(research.surveyUC$research.sv))
sv.completeUC <- sv.completeUC %>% mutate(cumulative.Freq = ifelse(output.table.Percent<100.0, cumsum(output.table.Frequency),output.table.Frequency)) 


#17- by site
test17 <- research.survey %>%  filter(Site=="HealthPartners" |  Site=="Henry Ford Health System" | Site=="Marshfield Clinic Health System" | Site=="Sanford Health" | Site=="University of Chicago Medicine")
test17$Site<- droplevels(test17$Site)
Table17_combined <- test17 %>% dplyr::select(Site, research.sv )  %>% tbl_cross(
  row = research.sv,
  col = Site,
  digits=c(0,1),
  percent = "column",
  label=list(Site ~ " ", research.sv ~ " "),
  # label=list(Site="",
  #            research.sv = ""),
  missing="ifany") %>%
  #bold_labels() %>%
  #italicize_levels() %>%
  modify_header() %>%
  modify_caption("Table 17. Baseline Research Biospecimen Survey Status by Site") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)







# recr.biospe <- recr.biospe %>%
#   mutate(research.sv = case_when(d_265193023 == 231311385 ~ "Submitted",
#                                  d_265193023 == 615768760 ~ "Started",
#                                  d_265193023 == 972455046 ~ "Not Started"),
#           clinic.sv = case_when(d_253883960 == 231311385 ~ "Submitted",
#                                d_253883960 == 615768760 ~ "Started",
#                                d_253883960 == 972455046 ~ "Not Started"))
# research.survey17HP <- recr.biospe %>% filter(d_650516960 == 534621077) 
# 
# research.survey17b <- research.survey17b %>%  select(research.sv, Site)
# table17b <- research.survey17b %>%  group_by(research.sv, Site) #%>%   summarize_at(c("participants", "percent"), sum, na.rm = TRUE)
# 
# 
# research.survey17b <- research.survey17b %>%  select(research.sv) %>%  group_by(Site)
# 
# research.surveyB <- research.survey %>%  select(research.sv, Site)
# sv.completeB <- as.data.frame(research.surveyB)
# #sv.completeB <- sv.completeB %>%  group_by(Site)
# sv.completeB <- sv.completeB %>% mutate(cumulative.Freq = ifelse(output.table.Percent<100.0, cumsum(output.table.Frequency),output.table.Frequency)) 
# 
# table17b <- research.survey17b %>%  select(research.sv) %>%  group_by(Site)
# View(table17b)
# 
# 
# table(recr.biospe$Site, recr.biospe$research.sv)






#Table 18                        
#Total number and percent of clinical biospecimen survey status
clinic.survey <- recr.biospe %>% filter(d_650516960 == 664882224)
 clinic.survey <- clinic.survey %>% 
   mutate(d_173836415_d_266600170_d_139245758_clc = as.POSIXct(ymd_hms(d_173836415_d_266600170_d_139245758)), ##urine
          d_173836415_d_266600170_d_982213346_clc = as.POSIXct(ymd_hms(d_173836415_d_266600170_d_982213346)), ##blood collected
          d_173836415_d_266600170_d_740582332_clc = as.POSIXct(ymd_hms(d_173836415_d_266600170_d_740582332)), ##Autogenerated date/time stamp for Any specimen collected at RRL
          d_173836415_d_266600170_d_139245758_urine =as.POSIXct(ymd_hms(d_173836415_d_266600170_d_139245758)), # Urine collected
          d_173836415_d_266600170_d_541311218_urine = as.POSIXct(ymd_hms(d_173836415_d_266600170_d_541311218)),##Clinical DB urine RRL Date/Time received
          d_173836415_d_266600170_d_224596428_urine = as.POSIXct(ymd_hms(d_173836415_d_266600170_d_224596428)), #Clinical Site Urine RRL Date / Time Received
     clinic.svtime =  difftime(as.POSIXct(ymd_hms(d_764863765)),as.POSIXct(ymd_hms(d_534669573)),units="hours")) ##survey time from start to complete
 clinic.survey <- clinic.survey %>% mutate(clc.coltm  = do.call(pmin, c(select(.,ends_with('clc')),na.rm=TRUE))) ###any biospecimen collected time
  clinic.survey$tm_biocolsuv <-  difftime(as.POSIXct(ymd_hms(clinic.survey$d_764863765)),clinic.survey$clc.coltm,units="hours") 
  #time between survey completion to biospecimen collection visit check in
clinicsv.complete <- as.data.frame(tab1(clinic.survey$clinic.sv))
clinicsv.complete <- clinicsv.complete %>% 
  mutate(cumulative.Freq = ifelse(output.table.Percent<100.0, cumsum(output.table.Frequency),output.table.Frequency))
# Number and percent of clinical biospecimen survey completion time by survey status
# clinic.survey <-clinic.survey %>%
#   mutate(checktmvisit = ifelse( as.numeric(tm_biocolsuv) >72,"Greater than 72hrs (3 days)",
#                         ifelse( 72 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 48, "> 48 hrs to 72 hrs",
#                           ifelse( 48 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 24, "> 24 hrs to 48 hrs",   
#                             ifelse( 24 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 12, "> 12 hrs to 24 hrs",
#                               ifelse( 12 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 3, "> 3 hrs to 12 hrs",      
#                                  ifelse( 3 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) >= 0, "0 hrs to 3 hrs", 
#                                          ifelse(is.na(tm_biocolsuv), "Missing", NA))))))))

clinic.survey <-clinic.survey %>%
  mutate(checktmvisit = case_when(as.numeric(tm_biocolsuv) >72 ~"Greater than 72hrs (3 days)",
                                  72 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 48 ~ "> 48 hrs to 72 hrs",
                                  48 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 24 ~ "> 24 hrs to 48 hrs",
                                  24 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 12 ~ "> 12 hrs to 24 hrs",
                                  12 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 3 ~ "> 3 hrs to 12 hrs",    
                                  3 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) >= 0 ~ "0 hrs to 3 hrs", 
                                  d_265193023 != 231311385 ~ "Not Submitted", 
                                  TRUE ~ "Missing Time"))


         #time_biochk = difftime(as.POSIXct(ymd_hms(d_331584571_d_266600170_d_343048998)),clc.coltm,units="mins"))
#clinic.survey$biochk_outlier <- ifelse(as.numeric(clinic.survey$time_biochk)/60 > 24, "Outlier",
#                               ifelse( 0<= as.numeric(clinic.survey$time_biochk)/60 & as.numeric(clinic.survey$time_biochk)/60 <= 24, "No Outlier", "Missing (not checked out)"))
clinic.survey$checktmvisit <- factor(clinic.survey$checktmvisit, levels=c("Not Submitted", "Missing Time", "0 hrs to 3 hrs","> 3 hrs to 12 hrs","> 12 hrs to 24 hrs","> 24 hrs to 48 hrs","> 48 hrs to 72 hrs","Greater than 72hrs (3 days)"))
clinic.survey$checktmvisit <- droplevels(clinic.survey$checktmvisit)



#Table 18b by site
clinic.surveyCO <- clinic.survey %>%  filter(Site=="Kaiser Permanente Colorado")
clinic.surveyGA <- clinic.survey %>%  filter(Site=="Kaiser Permanente Georgia")
clinic.surveyHI <- clinic.survey %>%  filter(Site=="Kaiser Permanente Hawaii")
clinic.surveyNW <- clinic.survey %>%  filter(Site=="Kaiser Permanente Northwest")


clinicsv.completeCO <- as.data.frame(tab1(clinic.surveyCO$clinic.sv))
clinicsv.completeCO <- clinicsv.completeCO %>% 
  mutate(cumulative.Freq = ifelse(output.table.Percent<100.0, cumsum(output.table.Frequency),output.table.Frequency))

clinicsv.completeGA <- as.data.frame(tab1(clinic.surveyGA$clinic.sv))
clinicsv.completeGA <- clinicsv.completeGA %>% 
  mutate(cumulative.Freq = ifelse(output.table.Percent<100.0, cumsum(output.table.Frequency),output.table.Frequency))

clinicsv.completeHI <- as.data.frame(tab1(clinic.surveyHI$clinic.sv))
clinicsv.completeHI <- clinicsv.completeHI %>% 
  mutate(cumulative.Freq = ifelse(output.table.Percent<100.0, cumsum(output.table.Frequency),output.table.Frequency))

clinicsv.completeNW <- as.data.frame(tab1(clinic.surveyNW$clinic.sv))
clinicsv.completeNW <- clinicsv.completeNW %>% 
  mutate(cumulative.Freq = ifelse(output.table.Percent<100.0, cumsum(output.table.Frequency),output.table.Frequency))



#Table18- by SIte-- recr.biospe   or clinic.survey    CURRENTLY THE TABLE 18 IN USE
test18 <- clinic.survey %>%
  mutate(clinical.sv = case_when(d_253883960 == 231311385 ~ "Submitted",
                                 d_253883960 == 615768760 ~ "Started",
                                 d_253883960 == 972455046 ~ "Not Started"))
test18a <- test18 %>%  filter(Site=="Kaiser Permanente Colorado" |  Site=="Kaiser Permanente Georgia" | Site=="Kaiser Permanente Hawaii" | Site=="Kaiser Permanente Northwest" | Site=="Henry Ford Health System") # add or Site=="Henry Ford Health System" on hold
test18a$Site<- droplevels(test18a$Site)

Table18_combined <- test18a %>% dplyr::select(Site, clinical.sv )  %>% tbl_cross(
  row = clinical.sv,
  col = Site,
  digits=c(0,1),
  percent = "column",
  label=list(Site ~ " ", clinical.sv ~ " "),
  # label=list(Site="",
  #            research.sv = ""),
  missing="ifany") %>%
  #bold_labels() %>%
  #italicize_levels() %>%
  modify_header() %>%
  modify_caption("Table 18. Baseline Clinical Biospecimen Survey Status by Site") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)








## Table 19
# Baseline research biospecimen survey completion time from time of visit check-in
    ## added requirement: BioChk_Complete_v1r0 is not null instead of survey completed
      ## Jing's original code already does this!!! recrver1$BL_BioChk_Complete_v1r0 
time.sv_checkin <- research.survey  %>% select(checktmvisit) %>% #%>% filter(d_265193023==231311385)
  tbl_summary(
    label=checktmvisit~"Time from Research Biospecimen Survey Completion Time from Time of Visit Check-In",
    statistic = list(all_categorical() ~ "{n}  ({p}%)"),
              digits = all_categorical() ~ c(0, 2),
    missing_text="Missing"
  )
total <- as.numeric(nrow(research.survey)) #[which(research.survey$d_265193023==231311385),]
time.sv_checkin <- as.data.frame(tab1(research.survey$checktmvisit)) #[which(research.survey$d_265193023==231311385),]
time.sv_checkin <-time.sv_checkin %>% 
  mutate(cumulative.Freq = ifelse(trimws(rownames(time.sv_checkin))!="Total", cumsum(output.table.Frequency),output.table.Frequency),
         cumulative.Perc = round(100*cumulative.Freq/total,1))

check<-research.survey[which(is.na(research.survey$checktmvisit) & !is.na(research.survey$d_331584571_d_266600170_d_135591601)),   c("Connect_ID","d_265193023","d_222161762","d_822499427","d_331584571_d_266600170_d_840048338","tm_biocolsuv","checktmvisit")]
     #research.survey$d_265193023==231311385 & 



#Table 19b-- by Site
#test17 <- research.survey %>%  filter(Site=="HealthPartners" |  Site=="Henry Ford Health System" | Site=="Marshfield Clinic Health System" | Site=="Sanford Health" | Site=="University of Chicago Medicine")
# Table19_combined <- test17 %>% dplyr::select(Site, checktmvisit )  %>% tbl_cross(
#   row = checktmvisit,
#   col = Site,
#   digits=c(0,1),
#   percent = "column",
#   label=list(Site ~ " ", checktmvisit ~ " "),
#   missing="ifany") %>%
#   #bold_labels() %>%
#   #italicize_levels() %>% 
#   modify_header() %>%
#   modify_caption("Table 19. Baseline Research Biospecimen Survey Completion Time from Time of Visit Check-In") %>%
#   as_kable_extra(escape = FALSE, addtl_fmt = TRUE)
test17_b <- test17 %>%  filter(d_222161762<as.Date("2023-07-05") & (checktmvisit=="Greater than 72hrs (3 days)" | checktmvisit=="> 48 hrs to 72 hrs" | checktmvisit=="> 24 hrs to 48 hrs" | 
  checktmvisit=="> 12 hrs to 24 hrs" |checktmvisit=="> 3 hrs to 12 hrs" |checktmvisit=="0 hrs to 3 hrs" | checktmvisit=="Missing Time"))
test17_b$checktmvisit<- droplevels(test17_b$checktmvisit)
test17_a <- test17 %>%  filter(d_222161762>=as.Date("2023-07-05") & (checktmvisit=="Greater than 72hrs (3 days)" | checktmvisit=="> 48 hrs to 72 hrs" | checktmvisit=="> 24 hrs to 48 hrs" | 
  checktmvisit=="> 12 hrs to 24 hrs" |checktmvisit=="> 3 hrs to 12 hrs" |checktmvisit=="0 hrs to 3 hrs" | checktmvisit=="Missing Time"))
test17_a$checktmvisit<- droplevels(test17_a$checktmvisit) 

Table19_combinedB <- test17_b %>% dplyr::select(Site, checktmvisit )  %>% tbl_cross(
    row = checktmvisit,
    col = Site,
    digits=c(0,2),
    percent = "column",
    label=list(Site ~ " ", checktmvisit ~ " "),
    missing="ifany") %>%
    #bold_labels() %>%
    #italicize_levels() %>% 
    modify_header() %>%
    modify_caption("19a. Baseline Research Biospecimen Survey Completion Time from Visit Check-In Time (Pre-COVID-19 Questions Removal)") %>%
    as_kable_extra(escape = FALSE, addtl_fmt = TRUE)


Table19_combinedA <- test17_a %>% dplyr::select(Site, checktmvisit )  %>% tbl_cross(
    row = checktmvisit,
    col = Site,
    digits=c(0,2),
    percent = "column",
    label=list(Site ~ " ", checktmvisit ~ " "),
    missing="ifany") %>%
    #bold_labels() %>%
    #italicize_levels() %>% 
    modify_header() %>%
    modify_caption("19b. Baseline Research Biospecimen Survey Completion Time from Visit Check-In Time (Post-COVID-19 Questions Removal)") %>%
    as_kable_extra(escape = FALSE, addtl_fmt = TRUE)




# research.surveyHP <- research.survey %>%  filter(Site=="HealthPartners")
# research.surveyHF <- research.survey %>%  filter(Site=="Henry Ford Health System")
# research.surveyMF <- research.survey %>%  filter(Site=="Marshfield Clinic Health System")
# research.surveySH <- research.survey %>%  filter(Site=="Sanford Health")
# research.surveyUC <- research.survey %>%  filter(Site=="University of Chicago Medicine")

# ##HP
# test19 <- research.survey %>%  filter(Site=="HealthPartners" |  Site=="Henry Ford Health System" | Site=="Marshfield Clinic Health System" | Site=="Sanford Health" | Site=="University of Chicago Medicine")
# time.sv_checkinHP <- test19  %>% select(checktmvisit) %>% #%>% filter(d_265193023==231311385)
#   tbl_summary(
#     label=checktmvisit~"Time from Research Biospecimen Survey Completion Time from Time of Visit Check-In",
#     statistic = list(all_categorical() ~ "{n}  ({p}%)"),
#               digits = all_categorical() ~ c(0, 2),
#     missing_text="Missing"
#   )
# total <- as.numeric(nrow(research.surveyHP)) #[which(research.surveyHP$d_265193023==231311385),]
# time.sv_checkinHP <- as.data.frame(tab1(research.surveyHP$checktmvisit)) #[which(research.surveyHP$d_265193023==231311385),]
# time.sv_checkinHP <-time.sv_checkinHP %>% 
#   mutate(cumulative.Freq = ifelse(trimws(rownames(time.sv_checkinHP))!="Total", cumsum(output.table.Frequency),output.table.Frequency),
#          cumulative.Perc = round(100*cumulative.Freq/total,1))
# 
# 
# 
# ##HF
# time.sv_checkinHF <- research.surveyHF  %>% select(checktmvisit) %>% #%>% filter(d_265193023==231311385)
#   tbl_summary(
#     label=checktmvisit~"Time from Research Biospecimen Survey Completion Time from Time of Visit Check-In",
#     statistic = list(all_categorical() ~ "{n}  ({p}%)"),
#               digits = all_categorical() ~ c(0, 2),
#     missing_text="Missing"
#   )
# total <- as.numeric(nrow(research.surveyHF)) #[which(research.surveyHF$d_265193023==231311385),]
# time.sv_checkinHF <- as.data.frame(tab1(research.surveyHF$checktmvisit)) #[which(research.surveyHF$d_265193023==231311385),]
# time.sv_checkinHF <-time.sv_checkinHF %>% 
#   mutate(cumulative.Freq = ifelse(trimws(rownames(time.sv_checkinHF))!="Total", cumsum(output.table.Frequency),output.table.Frequency),
#          cumulative.Perc = round(100*cumulative.Freq/total,1))
# 
# ##MF
# time.sv_checkinMF <- research.surveyMF  %>% select(checktmvisit) %>% #%>% filter(d_265193023==231311385)
#   tbl_summary(
#     label=checktmvisit~"Time from Research Biospecimen Survey Completion Time from Time of Visit Check-In",
#     statistic = list(all_categorical() ~ "{n}  ({p}%)"),
#               digits = all_categorical() ~ c(0, 2),
#     missing_text="Missing"
#   )
# total <- as.numeric(nrow(research.surveyMF)) #[which(research.surveyMF$d_265193023==231311385),]
# time.sv_checkinMF <- as.data.frame(tab1(research.surveyMF$checktmvisit)) #[which(research.surveyMF$d_265193023==231311385),]
# time.sv_checkinMF <-time.sv_checkinMF %>% 
#   mutate(cumulative.Freq = ifelse(trimws(rownames(time.sv_checkinMF))!="Total", cumsum(output.table.Frequency),output.table.Frequency),
#          cumulative.Perc = round(100*cumulative.Freq/total,1))
# 
# ##SH
# time.sv_checkinSH <- research.surveySH  %>% select(checktmvisit) %>% #%>% filter(d_265193023==231311385)
#   tbl_summary(
#     label=checktmvisit~"Time from Research Biospecimen Survey Completion Time from Time of Visit Check-In",
#     statistic = list(all_categorical() ~ "{n}  ({p}%)"),
#               digits = all_categorical() ~ c(0, 2),
#     missing_text="Missing"
#   )
# total <- as.numeric(nrow(research.surveySH)) #[which(research.surveySH$d_265193023==231311385),]
# time.sv_checkinSH <- as.data.frame(tab1(research.surveySH$checktmvisit)) #[which(research.surveySH$d_265193023==231311385),]
# time.sv_checkinSH <-time.sv_checkinSH %>% 
#   mutate(cumulative.Freq = ifelse(trimws(rownames(time.sv_checkinSH))!="Total", cumsum(output.table.Frequency),output.table.Frequency),
#          cumulative.Perc = round(100*cumulative.Freq/total,1))
# 
# ##UC
# time.sv_checkinUC <- research.surveyUC  %>% select(checktmvisit) %>% #%>% filter(d_265193023==231311385)
#   tbl_summary(
#     label=checktmvisit~"Time from Research Biospecimen Survey Completion Time from Time of Visit Check-In",
#     statistic = list(all_categorical() ~ "{n}  ({p}%)"),
#               digits = all_categorical() ~ c(0, 2),
#     missing_text="Missing"
#   )
# total <- as.numeric(nrow(research.surveyUC)) #[which(research.surveyUC$d_265193023==231311385),]
# time.sv_checkinUC <- as.data.frame(tab1(research.surveyUC$checktmvisit)) #[which(research.surveyUC$d_265193023==231311385),]
# time.sv_checkinUC <-time.sv_checkinUC %>% 
#   mutate(cumulative.Freq = ifelse(trimws(rownames(time.sv_checkinUC))!="Total", cumsum(output.table.Frequency),output.table.Frequency),
#          cumulative.Perc = round(100*cumulative.Freq/total,1))
# 
# 





#Table 20
# clinic.surveyCO <- clinic.survey %>%  filter(Site=="Kaiser Permanente Colorado")
# clinic.surveyGA <- clinic.survey %>%  filter(Site=="Kaiser Permanente Georgia")
# clinic.surveyHI <- clinic.survey %>%  filter(Site=="Kaiser Permanente Hawaii")
# clinic.surveyNW <- clinic.survey %>%  filter(Site=="Kaiser Permanente Northwest")

    ## added requirement: BioClin_AnyBldUrineRec_v1r0 is not null instead of survey completed
    # request of [which(!is.na(clinic.survey$d_173836415_d_266600170_d_156605577)),] but that's already the case
clinic.survey$tm_biocolsuv <-  difftime(as.POSIXct(ymd_hms(clinic.survey$d_764863765)),clinic.survey$clc.coltm,units="hours") 
time.clcsv_checkin <- as.data.frame.matrix(tab1(clinic.survey$checktmvisit)$output.table) #[which(clinic.survey$d_253883960==231311385),]
time.clcsv_checkin <-time.clcsv_checkin %>% 
  mutate(cumulative.Freq = ifelse(trimws(rownames(time.clcsv_checkin))!="Total", cumsum(time.clcsv_checkin$Frequency),time.clcsv_checkin$Frequency))
         #cumulative.Perc = ifelse(trimws(rownames(time.clcsv_checkin))!="Total", cumsum(output.table.Frequency),output.table.....NA..)
       

# Table 20b-- by Site
#test18a <- test18 %>%  filter(Site=="Kaiser Permanente Colorado" |  Site=="Kaiser Permanente Georgia" | Site=="Kaiser Permanente Hawaii" | Site=="Kaiser Permanente Northwest") #

# Table20_combined <- test18a %>% dplyr::select(Site, checktmvisit )  %>% tbl_cross(
#   row = checktmvisit,
#   col = Site,
#   digits=c(0,1),
#   percent = "column",
#   label=list(Site ~ " ", checktmvisit ~ " "),
#   missing="ifany") %>%
#   #bold_labels() %>%
#   #italicize_levels() %>% 
#   modify_header() %>%
#   modify_caption("Table 20. Baseline Clinical Biospecimen Survey Complete Time from Time of Collection") %>% #on hold: check that HF shows up
#   as_kable_extra(escape = FALSE, addtl_fmt = TRUE)

# test18a_B <- test18a %>%  filter(d_764863765<as.Date("2023-07-05")) 
# test18a_A <- test18a %>%  filter(d_764863765>=as.Date("2023-07-05"))

test18a_B <- test18a %>%  filter(checktmvisit=="Greater than 72hrs (3 days)" | checktmvisit=="> 48 hrs to 72 hrs" | checktmvisit=="> 24 hrs to 48 hrs" | 
  checktmvisit=="> 12 hrs to 24 hrs" |checktmvisit=="> 3 hrs to 12 hrs" |checktmvisit=="0 hrs to 3 hrs" | checktmvisit=="Missing Time")
test18a_B$checktmvisit<- droplevels(test18a_B$checktmvisit)
# test18a_A <- test18a %>%  filter(d_764863765>=as.Date("2023-07-05") & (checktmvisit=="Greater than 72hrs (3 days)" | checktmvisit=="> 48 hrs to 72 hrs" | checktmvisit=="> 24 hrs to 48 hrs" | 
#   checktmvisit=="> 12 hrs to 24 hrs" |checktmvisit=="> 3 hrs to 12 hrs" |checktmvisit=="0 hrs to 3 hrs" | checktmvisit=="Missing Time"))
# test18a_A$checktmvisit<- droplevels(test18a_A$checktmvisit) 

Table20_combined <- test18a_B %>% dplyr::select(Site, checktmvisit )  %>% tbl_cross(
  row = checktmvisit,
  col = Site,
  digits=c(0,2),
  percent = "column",
  label=list(Site ~ " ", checktmvisit ~ " "),
  missing="ifany") %>%
  #bold_labels() %>%
  #italicize_levels() %>% 
  modify_header() %>%
  modify_caption("20. Baseline Clinical Biospecimen Survey Complete Time from Collection Time") %>% #on hold: check that HF shows up
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)


# Table20_combinedA <- test18a_A %>% dplyr::select(Site, checktmvisit )  %>% tbl_cross(
#   row = checktmvisit,
#   col = Site,
#   digits=c(0,2),
#   percent = "column",
#   label=list(Site ~ " ", checktmvisit ~ " "),
#   missing="ifany") %>%
#   #bold_labels() %>%
#   #italicize_levels() %>% 
#   modify_header() %>%
#   modify_caption("20b. Baseline Clinical Biospecimen Survey Complete Time from Collection Time (Pre-COVID-19 Questions Removal)") %>% #on hold: check that HF shows up
#   as_kable_extra(escape = FALSE, addtl_fmt = TRUE)







time.clcsv_checkinCO <- as.data.frame.matrix(tab1(clinic.surveyCO$checktmvisit)$output.table) #[which(clinic.surveyCO$d_253883960==231311385),]
time.clcsv_checkinCO <-time.clcsv_checkinCO %>% 
  mutate(cumulative.Freq = ifelse(trimws(rownames(time.clcsv_checkinCO))!="Total", cumsum(time.clcsv_checkinCO$Frequency),time.clcsv_checkinCO$Frequency))

time.clcsv_checkinGA <- as.data.frame.matrix(tab1(clinic.surveyGA$checktmvisit)$output.table) #[which(clinic.surveyGA$d_253883960==231311385),]
time.clcsv_checkinGA <-time.clcsv_checkinGA %>% 
  mutate(cumulative.Freq = ifelse(trimws(rownames(time.clcsv_checkinGA))!="Total", cumsum(time.clcsv_checkinGA$Frequency),time.clcsv_checkinGA$Frequency))

time.clcsv_checkinHI <- as.data.frame.matrix(tab1(clinic.surveyHI$checktmvisit)$output.table) #[which(clinic.surveyHI$d_253883960==231311385),]
time.clcsv_checkinHI <-time.clcsv_checkinHI %>% 
  mutate(cumulative.Freq = ifelse(trimws(rownames(time.clcsv_checkinHI))!="Total", cumsum(time.clcsv_checkinHI$Frequency),time.clcsv_checkinHI$Frequency))

time.clcsv_checkinNW <- as.data.frame.matrix(tab1(clinic.surveyNW$checktmvisit)$output.table) #[which(clinic.surveyNW$d_253883960==231311385),]
time.clcsv_checkinNW <-time.clcsv_checkinNW %>% 
  mutate(cumulative.Freq = ifelse(trimws(rownames(time.clcsv_checkinNW))!="Total", cumsum(time.clcsv_checkinNW$Frequency),time.clcsv_checkinNW$Frequency))








#Table 21
# Research biospecimen collection visit length (in minutes)
 #updated requirement: remove outlier colm and removed times outside of 8 and 500
statics_biock <- tapply(as.numeric(research.survey$time_biochk),research.survey$biochk_outlier,summary)
tab32a <- bind_rows(statics_biock)
##tab32a$`Outlier Present?` <- ifelse(rownames(statics_biock)==1,"no outliers","outlier")   ## I commented out--- wasn't running for me 
research.vt.length <- research.survey %>%  mutate(time=as.numeric(time_biochk)) 
#research.vt.length = research.vt.length %>%  filter(8<time) # & time<500) 
research.vt.length = research.vt.length %>%group_by(Site) %>% #biochk_outlier,
  dplyr::summarize('Number of Collection Visits'=n(),
                   Min = min(time,na.rm = TRUE),
                   Q1 = quantile(time, 0.25,na.rm = TRUE),
                   Median = median(time,na.rm = TRUE),
                   Mean = mean(time,na.rm = TRUE),
                   SD=sd(time,na.rm = TRUE),
                   Q3 = quantile(time, 0.75,na.rm = TRUE),
                   Perc.90= quantile(time, 0.90,na.rm = TRUE),
                   Perc.95= quantile(time, 0.95,na.rm = TRUE),
                   Perc.98= quantile(time, 0.98,na.rm = TRUE),
                   Max = max(time,na.rm = TRUE))



#New table 22


########################

tab22 <- left_join(recrver1, biospe, by="Connect_ID")

baseline_colct <- tab22 %>%  filter(d_331584571== 266600170 & !is.na(d_914594314) & !is.na(d_556788178) & d_650516960==534621077) # new-- research only

    ## BEFORE 2/1/23
baseline_colctC <- baseline_colct %>%  filter(d_914594314<as.Date("2022-08-01"))

BSL_colctC <- baseline_colctC %>%  mutate(time = as.numeric(difftime(as.POSIXct(ymd_hms(d_556788178)),as.POSIXct(ymd_hms(d_914594314)),units="days")),
                                     Site = case_when(#d_827220437.x==125001209 ~ "Kaiser Permanente Colorado",
                                                  #d_827220437.x==327912200 ~ "Kaiser Permanente Georgia",
                                                  #d_827220437.x==300267574 ~ "Kaiser Permanente Hawaii",
                                                  #d_827220437.x==452412599 ~ "Kaiser Permanente Northwest",
                                                  d_827220437.x==548392715 ~ "Henry Ford",
                                                  d_827220437.x==531629870 ~ "HealthPartners",
                                                  d_827220437.x==303349821 ~ "Marshfield",
                                                  d_827220437.x==657167265 ~ "Sanford",
                                                  d_827220437.x==809703864 ~ "University of Chicago",
                                                  d_827220437.x==517700004 ~ "NCI"),
                                 "Number of Participants" = n(),
                                 'Number of Baseline Collections' = case_when(!is.na(d_556788178) ~ n()))


verif_BSL_colctC = BSL_colctC %>%group_by(Site) %>% #select("Number of Participants", 'Number of Baseline Collections', time) %>% 
  dplyr::summarize('Number of Baseline Collections'=n(),
                   Min = round(min(time,na.rm = TRUE), digits=1),
                   Q1 = round(quantile(time, 0.25,na.rm = TRUE), digits=1),
                   Median = round(median(time,na.rm = TRUE), digits=1),
                   Mean = round(mean(time,na.rm = TRUE), digits=1),
                   SD= round(sd(time,na.rm = TRUE), digits=1),
                   Q3= round(quantile(time, 0.75,na.rm = TRUE), digits=1),
                   Max = round(max(time,na.rm = TRUE), digits=1))




    ## ON OR AFTER 2/1/23

baseline_colctD <- baseline_colct %>%  filter(d_914594314>=as.Date("2022-08-01"))

BSL_colctD <- baseline_colctD %>%  mutate(time = as.numeric(difftime(as.POSIXct(ymd_hms(d_556788178)),as.POSIXct(ymd_hms(d_914594314)),units="days")),
                                 Site = case_when(#d_827220437.x==125001209 ~ "Kaiser Permanente Colorado",
                                                  #d_827220437.x==327912200 ~ "Kaiser Permanente Georgia",
                                                  #d_827220437.x==300267574 ~ "Kaiser Permanente Hawaii",
                                                  #d_827220437.x==452412599 ~ "Kaiser Permanente Northwest",
                                                  d_827220437.x==548392715 ~ "Henry Ford",
                                                   d_827220437.x==531629870 ~ "HealthPartners",
                                                   d_827220437.x==303349821 ~ "Marshfield",
                                                   d_827220437.x==657167265 ~ "Sanford",
                                                   d_827220437.x==809703864 ~ "University of Chicago",
                                                   d_827220437.x==517700004 ~ "NCI"))


verif_BSL_colctD = BSL_colctD %>%group_by(Site) %>% 
  dplyr::summarize('Number of Baseline Collections'=n(),
                   Min = round(min(time,na.rm = TRUE), digits=1),
                   Q1 = round(quantile(time, 0.25,na.rm = TRUE), digits=1),
                   Median = round(median(time,na.rm = TRUE), digits=1),
                   Mean = round(mean(time,na.rm = TRUE), digits=1),
                   SD= round(sd(time,na.rm = TRUE), digits=1),
                   Q3= round(quantile(time, 0.75,na.rm = TRUE), digits=1),
                   Max = round(max(time,na.rm = TRUE), digits=1))


########



#biospe22 <- biospe %>% filter(d_650516960==664882224)


  #bio: 331584571, 556788178    #parts:914594314, 827220437


baseline_colct <- tab22 %>%  filter(d_331584571== 266600170 & !is.na(d_914594314) & !is.na(d_556788178) & d_650516960==664882224) # new-- clinical only, will need research also separately later 

    ## BEFORE 2/1/23
baseline_colctA <- baseline_colct %>%  filter(d_914594314<as.Date("2023-02-01"))

BSL_colctA <- baseline_colctA %>%  mutate(time = as.numeric(difftime(as.POSIXct(ymd_hms(d_556788178)),as.POSIXct(ymd_hms(d_914594314)),units="days")),
                                     Site = case_when(d_827220437.x==125001209 ~ "Kaiser Permanente Colorado",
                                                  d_827220437.x==327912200 ~ "Kaiser Permanente Georgia",
                                                  d_827220437.x==300267574 ~ "Kaiser Permanente Hawaii",
                                                  d_827220437.x==452412599 ~ "Kaiser Permanente Northwest",
                                                  d_827220437.x==548392715 ~ "Henry Ford"),
                                                  # d_827220437.x==531629870 ~ "HealthPartners",
                                                  # d_827220437.x==303349821 ~ "Marshfield",
                                                  # d_827220437.x==657167265 ~ "Sanford",
                                                  # d_827220437.x==809703864 ~ "University of Chicago",
                                                  # d_827220437.x==517700004 ~ "NCI"),
                                 "Number of Participants" = n(),
                                 'Number of Baseline Collections' = case_when(!is.na(d_556788178) ~ n()))


verif_BSL_colctA = BSL_colctA %>%group_by(Site) %>% #select("Number of Participants", 'Number of Baseline Collections', time) %>% 
  dplyr::summarize('Number of Baseline Collections'=n(),
                   Min = round(min(time,na.rm = TRUE), digits=1),
                   Q1 = round(quantile(time, 0.25,na.rm = TRUE), digits=1),
                   Median = round(median(time,na.rm = TRUE), digits=1),
                   Mean = round(mean(time,na.rm = TRUE), digits=1),
                   SD= round(sd(time,na.rm = TRUE), digits=1),
                   Q3= round(quantile(time, 0.75,na.rm = TRUE), digits=1),
                   Max = round(max(time,na.rm = TRUE), digits=1))




    ## ON OR AFTER 2/1/23

baseline_colctB <- baseline_colct %>%  filter(d_914594314>=as.Date("2023-02-01"))

BSL_colctB <- baseline_colctB %>%  mutate(time = as.numeric(difftime(as.POSIXct(ymd_hms(d_556788178)),as.POSIXct(ymd_hms(d_914594314)),units="days")),
                                 Site = case_when(d_827220437.x==125001209 ~ "Kaiser Permanente Colorado",
                                                  d_827220437.x==327912200 ~ "Kaiser Permanente Georgia",
                                                  d_827220437.x==300267574 ~ "Kaiser Permanente Hawaii",
                                                  d_827220437.x==452412599 ~ "Kaiser Permanente Northwest",
                                                  d_827220437.x==548392715 ~ "Henry Ford"))
                                                  # d_827220437.x==531629870 ~ "HealthPartners",
                                                  # d_827220437.x==303349821 ~ "Marshfield",
                                                  # d_827220437.x==657167265 ~ "Sanford",
                                                  # d_827220437.x==809703864 ~ "University of Chicago",
                                                  # d_827220437.x==517700004 ~ "NCI"))


verif_BSL_colctB = BSL_colctB %>%group_by(Site) %>% 
  dplyr::summarize('Number of Baseline Collections'=n(),
                   Min = round(min(time,na.rm = TRUE), digits=1),
                   Q1 = round(quantile(time, 0.25,na.rm = TRUE), digits=1),
                   Median = round(median(time,na.rm = TRUE), digits=1),
                   Mean = round(mean(time,na.rm = TRUE), digits=1),
                   SD= round(sd(time,na.rm = TRUE), digits=1),
                   Q3= round(quantile(time, 0.75,na.rm = TRUE), digits=1),
                   Max = round(max(time,na.rm = TRUE), digits=1))











#New Table 23 
  #recrver1, d_914594314 , d_173836415_d_266600170_d_769615780, d_827220437     &        biospe,  biocol_Setting== "Clinical",


ver_draw <- tab22 %>%  filter(biocol_Setting== "Clinical" & !is.na(d_914594314) & !is.na(d_556788178) & d_914594314>=as.Date("2023-02-01"))



verif_draw <- ver_draw %>%  mutate(time = as.numeric(difftime(as.POSIXct(ymd_hms(d_173836415_d_266600170_d_769615780)),as.POSIXct(ymd_hms(d_914594314)),units="days")),
                                 Site = case_when(d_827220437.x==125001209 ~ "Kaiser Permanente Colorado",
                                                  d_827220437.x==327912200 ~ "Kaiser Permanente Georgia",
                                                  d_827220437.x==300267574 ~ "Kaiser Permanente Hawaii",
                                                  d_827220437.x==452412599 ~ "Kaiser Permanente Northwest",
                                                  d_827220437.x==548392715 ~ "Henry Ford Health System")) #on hold- HF should have data from clinical 

verif_draw_order = verif_draw %>%group_by(Site) %>% 
  dplyr::summarize('Number of Draw Orders Placed'=n(),
                   Min = round(min(time,na.rm = TRUE), digits=1),
                   Q1 = round(quantile(time, 0.25,na.rm = TRUE), digits=1),
                   Median = round(median(time,na.rm = TRUE), digits=1),
                   Mean = round(mean(time,na.rm = TRUE), digits=1),
                   SD= round(sd(time,na.rm = TRUE), digits=1),
                   Max = round(max(time,na.rm = TRUE), digits=1))











## New table 24


    ## ON OR AFTER 2/1/23
parts24 <- "SELECT Connect_ID, state_d_667474224 FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` where Connect_ID IS NOT NULL"
parts24_table <- bq_project_query(project, parts24)
parts24_data <- bq_table_download(parts24_table, bigint = "integer64")
parts24_data$Connect_ID <- as.numeric(parts24_data$Connect_ID)
tab24 <- left_join(recrver1, biospe, by="Connect_ID") %>% left_join(parts24_data, by="Connect_ID")

baseline_24 <- tab24 %>%  filter(d_331584571== 266600170 & !is.na(d_914594314) & !is.na(d_556788178) )

baseline_24_after <- baseline_24 %>%  filter(d_914594314>=as.Date("2022-06-01") ) 

BSL_after24 <- baseline_24_after %>%  mutate(time = as.numeric(difftime(as.POSIXct(ymd_hms(d_556788178)),as.POSIXct(ymd_hms(d_914594314)),units="days")),
                                     Site = case_when(d_827220437.x==125001209 ~ "KP Colorado",
                                                  d_827220437.x==327912200 ~ "KP Georgia",
                                                  d_827220437.x==300267574 ~ "KP Hawaii",
                                                  d_827220437.x==452412599 ~ "KP Northwest",
                                                  d_827220437.x==548392715 ~ "Henry Ford",
                                                  d_827220437.x==531629870 ~ "HealthPartners",
                                                  d_827220437.x==303349821 ~ "Marshfield",
                                                  d_827220437.x==657167265 ~ "Sanford",
                                                  d_827220437.x==809703864 ~ "UChicago"),
                                                  #d_827220437.x==517700004 ~ "NCI"),
                                     campaign = case_when( (state_d_667474224==348281054 | state_d_667474224==324692899)  ~ "Upcoming Appointment" ,
                                                            TRUE ~ "All Other Campaigns"))

#BSL_after24 <- BSL_after24 %>%  mutate("Number of Baseline Collections1" = case_when(campaign=="Upcoming Appointment" ~n ()[campaign=="Upcoming Appointment"]),"Number of Baseline Collections2" = case_when(campaign=="All Other Campaigns" ~ n()[campaign=="All Other Campaigns"]))


#BSL_a24 <- BSL_after24 %>% filter(Site!="Sanford" & Site!="Marshfield" & Site!="HealthPartners")

verif_baseline_24_Af = BSL_after24 %>%group_by(Site) %>% 
  dplyr::summarize(#'Number of Baseline Collections1'=n()[campaign=="Upcoming Appointment"],
                   Min1 = round(min(time[campaign=="Upcoming Appointment"],na.rm = TRUE), digits=1),
                   Median1 = round(median(time[campaign=="Upcoming Appointment"],na.rm = TRUE), digits=1),
                   Mean1 = round(mean(time[campaign=="Upcoming Appointment"],na.rm = TRUE), digits=1),
                   SD1= round(sd(time[campaign=="Upcoming Appointment"],na.rm = TRUE), digits=1),
                   Max1 = round(max(time[campaign=="Upcoming Appointment"],na.rm = TRUE), digits=1),
                   #'Number of Baseline Collections2'=n()[campaign=="All Other Campaigns"],
                   Min2 = round(min(time[campaign=="All Other Campaigns"],na.rm = TRUE), digits=1),
                   Median2 = round(median(time[campaign=="All Other Campaigns"],na.rm = TRUE), digits=1),
                   Mean2 = round(mean(time[campaign=="All Other Campaigns"],na.rm = TRUE), digits=1),
                   SD2= round(sd(time[campaign=="All Other Campaigns"],na.rm = TRUE), digits=1),
                   Max2 = round(max(time[campaign=="All Other Campaigns"],na.rm = TRUE), digits=1),
                   'Total Number of Baseline Collections'=n()) %>%  
  mutate('Number of Baseline Collections1' = as.data.frame(table(BSL_after24$Site, BSL_after24$campaign))[c(10:18), 3],
         'Number of Baseline Collections2'= as.data.frame(table(BSL_after24$Site, BSL_after24$campaign))[c(1:9), 3])

#verif_baseline_24_Af <- verif_baseline_24_Af 
verif_baseline_24_Af <- verif_baseline_24_Af %>%  select(Site,  'Number of Baseline Collections1', Min1, Median1, Mean1, SD1, Max1, 'Number of Baseline Collections2', Min2, Median2, Mean2, SD2, Max2, 'Total Number of Baseline Collections')

#verif_baseline_24_Af <- verif_baseline_24_Af[c(1,2,7:9,3:6), ]

# for(i in 1:9){
#   verif_baseline_24_Af$'Number of Basline Collections1' = (as.numeric('Total Number of Baseline Collections'[i]) - as.numeric('Number of Baseline Collections2'[i]))
# }
# Group1 <- c(verif_baseline_24_Af$Min1, verif_baseline_24_Af$Median1, verif_baseline_24_Af$Mean1, verif_baseline_24_Af$SD1, verif_baseline_24_Af$Max1)
# Group2 <- c(verif_baseline_24_Af$Min2, verif_baseline_24_Af$Median2, verif_baseline_24_Af$Mean2, verif_baseline_24_Af$SD2, verif_baseline_24_Af$Max2)
# 
# 
# 
# kbl(verif_baseline_24_Af) %>%
#   kable_classic() %>%
#   add_header_above("Upcoming Appointment" = Group1, "All Other Campaigns" = Group2)


# verif24Af <- verif_baseline_24_Af %>%  gt() %>% 
#   tab_spanner(
#     label = "Upcoming Appointment",
#     columns = c( #'Number of Baseline Collections1', 
#       Min1, Median1, Mean1, SD1, Max1
#     )) %>% 
#       tab_spanner(
#     label = "All Other Campaigns",
#     columns = c( #'Number of Baseline Collections2', 
#       Min2, Median2, Mean2, SD2, Max2
#     )) %>% cols_label(Min1=("Min"), Median1=("Median"), Mean1=("Mean"), SD1=("SD"), Max1=("Max"), Min2=("Min"), Median2=("Median"), Mean2=("Mean"), SD2=("SD"), Max2=("Max"))  %>% 
#   tab_header(title=md("Table 25. Time (in Days) from Verification to Clinical Baseline Collection for \n Participants Verified After 08/01/2023, by Campaign Type"))  %>% tab_options(
#     table.width = pct(20)
#   )
# 
# 
# 
# verif24Af %>% gtsave("bycampaign.png")





# verif_baseline_24_Af = BSL_after24 %>%group_by(Site) %>% select(Site, Connect_ID, time, campaign)
# verif_baseline_24_Af <- verif_baseline_24_Af %>% mutate(#'Number of Baseline Collections1'=n()[campaign=="Upcoming Appointment"],
#          'Number of Baseline Collections1'= sum(campaign=="Upcoming Appointment"),
#                    Min1 = round(min(time[campaign=="Upcoming Appointment"],na.rm = TRUE), digits=2),
#                    Median1 = round(median(time[campaign=="Upcoming Appointment"],na.rm = TRUE), digits=2),
#                    Mean1 = round(mean(time[campaign=="Upcoming Appointment"],na.rm = TRUE), digits=2),
#                    SD1= round(sd(time[campaign=="Upcoming Appointment"],na.rm = TRUE), digits=2),
#                    Max1 = round(max(time[campaign=="Upcoming Appointment"],na.rm = TRUE), digits=2),
#                    #'Number of Baseline Collections2'=n()[campaign=="All Other Campaigns"],
#                    'Number of Baseline Collections2'= sum(campaign=="All Other Campaigns"),
#                    Min2 = round(min(time[campaign=="All Other Campaigns"],na.rm = TRUE), digits=2),
#                    Median2 = round(median(time[campaign=="All Other Campaigns"],na.rm = TRUE), digits=2),
#                    Mean2 = round(mean(time[campaign=="All Other Campaigns"],na.rm = TRUE), digits=2),
#                    SD2= round(sd(time[campaign=="All Other Campaigns"],na.rm = TRUE), digits=2),
#                    Max2 = round(max(time[campaign=="All Other Campaigns"],na.rm = TRUE), digits=2),
#                    'Total Number of Baseline Collections'=n())




#, 'Number of Baseline Collections1'=("Number of Baseline Collections"), 'Number of Baseline Collections2'=('Number of Baseline Collections') 


# 
# parts24 <- "SELECT Connect_ID, state_d_667474224 FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` where Connect_ID IS NOT NULL"
# parts24_table <- bq_project_query(project, parts24)
# parts24_data <- bq_table_download(parts24_table, bigint = "integer64")
# parts24_data$Connect_ID <- as.numeric(parts24_data$Connect_ID)
# tab24 <- left_join(recrver1, biospe, by="Connect_ID") %>% left_join(parts24_data, by="Connect_ID")
# 
# baseline_24 <- tab24 %>%  filter(d_331584571== 266600170 & !is.na(d_914594314) & !is.na(d_556788178) ) # new-- research  and clinical combined
# 
#     ## BEFORE 2/1/23
# baseline_24_before <- baseline_24 %>%  filter(d_914594314<as.Date("2023-06-01"))
# 
# BSL_baseline_24B <- baseline_24_before %>%  mutate(time = as.numeric(difftime(as.POSIXct(ymd_hms(d_556788178)),as.POSIXct(ymd_hms(d_914594314)),units="days")),
#                                      Site = case_when(d_827220437.x==125001209 ~ "Kaiser Permanente Colorado",
#                                                   d_827220437.x==327912200 ~ "Kaiser Permanente Georgia",
#                                                   d_827220437.x==300267574 ~ "Kaiser Permanente Hawaii",
#                                                   d_827220437.x==452412599 ~ "Kaiser Permanente Northwest",
#                                                   d_827220437.x==548392715 ~ "Henry Ford",
#                                                   d_827220437.x==531629870 ~ "HealthPartners",
#                                                   d_827220437.x==303349821 ~ "Marshfield",
#                                                   d_827220437.x==657167265 ~ "Sanford",
#                                                   d_827220437.x==809703864 ~ "University of Chicago",
#                                                   d_827220437.x==517700004 ~ "NCI"),
#                                      campaign = case_when( (state_d_667474224==348281054 | state_d_667474224==324692899)  ~ "Upcoming Appointment" ,
#                                                             TRUE ~ "All Other Campaigns"),
#                                  "Number of Participants" = n(),
#                                  'Number of Baseline Collections' = case_when(!is.na(d_556788178) ~ n()))
# 
# 
# verif_BSL_baseline_24Bf = BSL_baseline_24B %>%group_by(Site) %>% #select("Number of Participants", 'Number of Baseline Collections', time) %>% 
#   dplyr::summarize('Number of Baseline Collections'=n(),
#                    Min1 = round(min(time[campaign=="Upcoming Appointment"],na.rm = TRUE), digits=2),
#                    Median1 = round(median(time[campaign=="Upcoming Appointment"], na.rm = TRUE), digits=2),
#                    Mean1 = round(mean(time[campaign=="Upcoming Appointment"],na.rm = TRUE), digits=2),
#                    SD1= round(sd(time[campaign=="Upcoming Appointment"],na.rm = TRUE), digits=2),
#                    Max1 = round(max(time[campaign=="Upcoming Appointment"],na.rm = TRUE), digits=2),
#                    Min2 = round(min(time[campaign=="All Other Campaigns"],na.rm = TRUE), digits=2),
#                    Median2 = round(median(time[campaign=="All Other Campaigns"],na.rm = TRUE), digits=2),
#                    Mean2 = round(mean(time[campaign=="All Other Campaigns"],na.rm = TRUE), digits=2),
#                    SD2= round(sd(time[campaign=="All Other Campaigns"],na.rm = TRUE), digits=2),
#                    Max2 = round(max(time[campaign=="All Other Campaigns"],na.rm = TRUE), digits=2))
# 
# 
# verif24Bf <- verif_BSL_baseline_24Bf %>%  gt() %>% 
#   tab_spanner(
#     label = "Upcoming Appointment",
#     columns = c(
#       Min1, Median1, Mean1, SD1, Max1
#     )) %>% 
#       tab_spanner(
#     label = "All Other Campaigns",
#     columns = c(
#       Min2, Median2, Mean2, SD2, Max2
#     )) %>% cols_label(Min1=("Min"), Median1=("Median"), Mean1=("Mean"), SD1=("SD"), Max1=("Max"), Min2=("Min"), Median2=("Median"), Mean2=("Mean"), SD2=("SD"), Max2=("Max") ) %>% 
#   tab_header(title=md("Table 24a. Time (in Days) from Verification to Clinical Baseline Collection for Participants \n Verified Before 06/01/2023, by Campaign Type"))
# 















#research.vt.length[is.na(research.vt.length)] <- replace_na(".")
#tapply(as.numeric(bio_survey$time_biochk),bio_survey$biochk_outlier,sd)
#Figure 17. Research biospecimen collection visit length (in minutes)
##Blood Collection Completeness by Walk-In vs Scheduled for UChicago Site
# sv_time<- recr.biospe %>% group_by(biochk_outlier, Site) %>%
#   dplyr::summarize(mean=mean(as.numeric(time_biochk)),sd=sd(as.numeric(time_biochk)), 
#                    min=min(as.numeric(time_biochk)),
#                    Q1=quantile(as.numeric(time_biochk),probs=0.25,na.rm=TRUE),
#                    median=median(as.numeric(time_biochk)),
#                    Q3=quantile(as.numeric(time_biochk),probs=0.75,na.rm=TRUE), max=max(as.numeric(time_biochk)))
# sv_time <- apply_labels(sv_time,
#                         d_827220437.y = "Site",#RcrtES_Site_v1r0
#                         d_827220437.y = c("HealthPartners"= 531629870, "Henry Ford Health System"=548392715, "Kaiser Permanente Colorado" = 125001209,
#                                         "Kaiser Permanente Georgia" = 327912200,"Kaiser Permanente Hawaii" = 300267574,"Kaiser Permanente Northwest" = 452412599,
#                                         "Marshfield Clinic Health System" = 303349821,"Sanford Health" = 657167265, "University of Chicago Medicine" = 809703864,
#                                         "National Cancer Institute" = 517700004,"National Cancer Institute" = 13,"Other" = 181769837),
#                         biochk_outlier = "Outlier Present?",
#                         biochk_outlier = c("No outliers"= 0, "Outliers"=1, "Missing(Not Checkout)"=" "))
# library(plyr)
# sv_time <- sv_time %>% mutate(Site= case_when(d_827220437.y ==125001209 ~ "KPCO", 
#                                               d_827220437.y == 327912200 ~ "KPGA", 
#                                               d_827220437.y == 452412599 ~ "KPNW", 
#                                               d_827220437.y == 303349821 ~ "Marshfield",
#                                               d_827220437.y == 300267574 ~ "KPHI",
#                                               d_827220437.y == 531629870 ~ "HP", 
#                                               d_827220437.y == 548392715 ~ "HFHS",
#                                               d_827220437.y == 657167265 ~ "SH",
#                                               d_827220437.y == 809703864 ~ "UoCh", 
#                                               d_827220437.y == 517700004 ~ "NIH",
#                                               d_827220437.y == 181769837 ~ "Others"),
#                             `Outlier Present?` = case_when(biochk_outlier == 0 ~ "No outliers",
#                                                            biochk_outlier == 1 ~ "Outliers",
#                                                            is.na(biochk_outlier)  ~ "Missing(Not Checkout)"))
# 
#Figure 17b. Research biospecimen collection visit length by site (in minutes)
# recr.biospe <- recr.biospe %>% mutate(Site= case_when(d_827220437 ==125001209 ~ "KPCO", 
#                                               d_827220437 == 327912200 ~ "KPGA", 
#                                               d_827220437 == 452412599 ~ "KPNW", 
#                                               d_827220437 == 303349821 ~ "Marshfield",
#                                               d_827220437 == 300267574 ~ "KPHI",
#                                               d_827220437 == 531629870 ~ "HP", 
#                                               d_827220437 == 548392715 ~ "HFHS",
#                                               d_827220437 == 657167265 ~ "SH",
#                                               d_827220437 == 809703864 ~ "UoCh", 
#                                               d_827220437 == 517700004 ~ "NIH",
#                                               d_827220437 == 181769837 ~ "Others"),
#                               `Outlier Present?` = case_when(biochk_outlier == 0 ~ "No outliers",
#                                                              biochk_outlier == 1 ~ "Outliers",
#                                                              is.na(biochk_outlier)  ~ "Missing(Not Checkout)"))
# 


###for the clinical collections
# ggplot(clinic.survey, aes(x=Site, y=as.numeric(time_biochk),fill=Site,color=Site)) + 
#   geom_boxplot() + geom_jitter(width = 0.2) +   scale_fill_brewer(palette="Dark2") +
#   geom_hline(linetype = "dashed", yintercept = 1440,color="red") + 
#   ggtitle("Research biospecimen collection visit length (in minutes) by site") +
#           ylab("Visit Length (minutes)") + xlab("Site") +
#   scale_y_continuous(limits = c(0, 50000)) +
#   theme(panel.background = element_blank(),
#         legend.title = element_text(size=7),
#         axis.line = element_line(size=0.2),
#         axis.text.x = element_text(hjust = 0.5,size = 8, face = "bold"),                                                            
#         plot.title = element_text(hjust = 0.5,size = 12, face = "bold"))
##Figure 4. Number of biospecimen collection visits over time by site
#BioCol_Starttime*wk*wk_date*RcrtES_Site_v1r0
#Table 18. Number of Blood Collection Completions By the Final Collection day of the week of Chicago Site
##to check the days of week for the collection in Chicago site
#d_556788178	as BioRec_CollectFinalTime_v1r0,
#d_678166505	as BioCol_ColTime_v1r0 "Collection Date/Time"
# if RcrtES_Site_v1r0=809703864 then Chicago=1;
# else chicago=0;
# if BioRec_CollectFinalTime_v1r0 ^=. and RcrtV_VerificationTm_V1R0 ^=. then do;
# BioRec_CollectFinalWeekDay_v1r0 =weekday(datepart(BioRec_CollectFinalTime_v1r0));
# attrib BioRec_CollectFinalWeekDay_v1r0 label="day of the week for Collection Entry Finalized" format=wkdayfmt.;
# end;


# visit_wk <- recr_survey1[,c("Connect_ID","d_678166505","d_827220437.y","d_556788178","start.date","visit.wk","weekday","chicago")]
# 
# visit_wk_site <- as.data.frame(CrossTable(visit_wk$d_827220437.y,visit_wk$visit.wk, prop.t=FALSE, prop.r=FALSE, prop.c=TRUE,prop.chisq=FALSE)$t)
# 
# visit_wk_site$start.date <- unique(visit_wk$start.date)
# week.date <- as.data.frame(seq(as.Date(as.POSIXct(ymd_hms(unique(visit_wk$start.date)))),as.Date(as.POSIXct(ymd_hms(unique(recr_survey1$current.date)))),by='week'))
# names(week.date) <- "week.date"
# week.date$week <- rownames(week.date)
# visit_wk_site <- visit_wk_site[order(visit_wk_site$x),]
# visit_wk_site$week.date <- week.date$week.date
# visit_wk_site <- visit_wk_site %>% mutate(Site= case_when(x ==125001209 ~ "KPCO", 
#                                                           x == 327912200 ~ "KPGA", 
#                                                           x == 452412599 ~ "KPNW", 
#                                                           x == 303349821 ~ "Marshfield",
#                                                           x == 300267574 ~ "KPHI",
#                                                           x == 531629870 ~ "HP", 
#                                                           x == 548392715 ~ "HFHS",
#                                                           x == 657167265 ~ "SH",
#                                                           x == 809703864 ~ "UoCh", 
#                                                           x == 517700004 ~ "NIH",
#                                                           x == 181769837 ~ "Others"))
# 




# #Don't think this is being used anymore
# research.vt <- ggplot(visit_wk_site, aes(x=as.Date(visit.wkdate), y=n)) +  #,fill=Site, color=Site
#   geom_line() + geom_point(width = 0.2) +
#   scale_y_continuous(name="# Number of Visits per Week", limits=c(0,30)) +
#   scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks")  +
#   scale_fill_brewer(palette="Dark2") + 
#   ggtitle(label="Fig 2. Number of Weekly Research Biospecimen Collection Visits over Time by Site") +
#   #theme_ipsum() +
#   theme(panel.background = element_blank(),
#         #legend.title = element_text(size=7),
#         #legend.position="bottom",
#         axis.line = element_line(size=0.2),
#         axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14, face = "bold") ,
#         axis.title.y = element_text(size = 14, face = "bold",color="black"),                                                       
#         plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) 
#         #guides(fill=guide_legend(nrow=2,byrow=TRUE))







```
 
 
 
```{r, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}
#Code for figures


#Figure 1-- for now, no longer being used
sv.outlier.research <- ggplot(research.survey, aes(x=Site, y=as.numeric(time_biochk),fill=Site,color=Site)) + 
  geom_boxplot() + geom_jitter(width = 0.2) +   scale_fill_brewer(palette="Dark2") +
  geom_hline(linetype = "dashed", yintercept = 1440,color="red") + 
  annotate('text', x=1, y=1800, label = "24 hours",size=3)+
  ggtitle("Fig 2. Research Biospecimen Collection \n Visit Length (in Minutes) by Site") +
    ylab("Visit Length (minutes)") + xlab("Site") +
    scale_y_continuous(limits = c(0, 50000)) +
    theme(panel.background = element_blank(),
          legend.title = element_text(size=7),
          axis.line = element_line(size=0.2),
          axis.text.x = element_text(angle = 60,hjust = 1, size = 8, face = "bold"), 
          plot.title = element_text(hjust = 0.5,size = 12, face = "bold"))


#Figure 2- 
research.survey<- research.survey %>% mutate(#weekday = weekdays(ymd_hms(collection.tm)),
                                    #chicago = ifelse(d_827220437.y == 809703864, "Chicago","non Chicago"),
                                    start.date = min(schedulecol.tm),
                                    current.date=max(as.POSIXct(ymd_hms(schedulecol.tm))),
                                    BioRec_CollectScheduled = ifelse(as.Date(ymd_hms(schedulecol.tm)) >= as.Date(as.POSIXct(ymd_hms(d_914594314))),1,0))
                                    
                                    
research.survey$visit.wk <- ceiling(as.numeric(difftime(ymd_hms(research.survey$collection.tm),research.survey$start.date, units="weeks")))
research.survey$visit.wkdate <- research.survey$start.date + dweeks(research.survey$visit.wk)






#NEED ONE NOT STRATIFIED BY SITE FOR NEW REQUEST OF LOCATION SPECIFIC METRICS





# 
# clc.bld_ur <- c("d_173836415_d_266600170_d_769615780","d_173836415_d_266600170_d_822274939","d_173836415_d_266600170_d_398645039","d_173836415_d_266600170_d_982213346","d_173836415_d_266600170_d_740582332", "d_173836415_d_266600170_d_139245758","d_173836415_d_266600170_d_224596428","d_173836415_d_266600170_d_541311218","d_173836415_d_266600170_d_939818935", "d_173836415_d_266600170_d_786930107", 'd_173836415_d_266600170_d_693370086')
# clc.both.vt <- clinic.survey[which(clinic.survey$Site!="HealthPartners"),c("Connect_ID","Site","bldcol_max","collection.tm",clc.bld_ur)]
# 
# for(i in 1:length(unique(clc.both.vt$Site))){
#   site <- unique(clc.both.vt$Site)[i]
# clc.both.vt <- clc.both.vt %>%  filter((clc.both.vt$d_173836415_d_266600170_d_786930107=="353358909" | clc.both.vt$d_173836415_d_266600170_d_693370086=="353358909") & Site==site)
# clc.both.vt$both.startdate <- min(as.POSIXct(ymd_hms(clc.both.vt$d_173836415_d_266600170_d_982213346)),na.rm=TRUE)
# clc.both.vt$both.receiveddate <- as.POSIXct(ymd_hms(clc.both.vt$d_173836415_d_266600170_d_398645039))
# clc.both.vt$visit.wk <- ceiling(as.numeric(difftime(clc.both.vt$both.receiveddate,clc.both.vt$both.startdate, units="weeks")))
# clc.both.vt = clc.both.vt %>% mutate(BioClin_SiteUrineColl_v1r0= case_when(d_173836415_d_266600170_d_786930107=="353358909"~ 1),
#                        BioClin_SiteBloodColl_v1r0= case_when(d_173836415_d_266600170_d_693370086=="353358909"~ 1))
# clc.both.vt$collected= sum(as.numeric(clc.both.vt$BioClin_SiteUrineColl_v1r0), na.rm=T)  + sum(as.numeric(clc.both.vt$BioClin_SiteBloodColl_v1r0), na.rm=T)
# clc.both.vt$visit.wkdate <- as_date(clc.both.vt$both.startdate + dweeks(clc.both.vt$visit.wk))
# clc.both.wk_site <- clc.both.vt %>% arrange(visit.wk, visit.wkdate, collected) %>% group_by(visit.wk,collected, visit.wkdate) %>% tally()
# clc_both_vt.site<-ggplot(clc.both.wk_site, aes(x=as_date(ymd(visit.wkdate)), y=collected)) + # y=n, ,fill=Site, color=Site
#   geom_line() + 
#   geom_point(width = 0.2) +
#   scale_y_continuous(name="# Number of Collections per Week") + #, limits=c(0,5)
#   scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "1 week")  +
#   scale_fill_brewer(palette="Dark2") + 
#   ggtitle(label="Fig 3. Weekly Biospecimen Collections at", site) +
#   #theme_ipsum() +
#   theme(panel.background = element_blank(),
#         legend.title = element_text(size=7),
#         axis.line = element_line(size=0.2),
#         axis.text.x = element_text(angle=60, hjust = 1,size = 8, face = "bold"),                                                            
#         plot.title = element_text(hjust = 0.5,size = 12, face = "bold"))
# print(clc_both_vt.site)
# }

  #+scale_x_date(limit=c(as.Date("2022-06-10"),as.Date("2023-10-16"))) + scale_y_continuous(breaks = seq(0, 30, by = 3))
###clnical blood collections
clc.bldtm <- c("d_173836415_d_266600170_d_769615780","d_173836415_d_266600170_d_822274939","d_173836415_d_266600170_d_398645039","d_173836415_d_266600170_d_982213346","d_173836415_d_266600170_d_740582332")
clc.urinetm <- c("d_173836415_d_266600170_d_139245758","d_173836415_d_266600170_d_224596428","d_173836415_d_266600170_d_541311218","d_173836415_d_266600170_d_939818935","d_173836415_d_266600170_d_740582332")
clc.blood.vt <- clinic.survey[which(clinic.survey$Site!="HealthPartners"),c("Connect_ID","Site","bldcol_max","collection.tm",clc.bldtm)]
clc.blood.vt$bld.startdate <- min(as.POSIXct(ymd_hms(clc.blood.vt$d_173836415_d_266600170_d_982213346)),na.rm=TRUE)
clc.blood.vt$bld.receiveddate <- as.POSIXct(ymd_hms(clc.blood.vt$d_173836415_d_266600170_d_398645039))
clc.blood.vt$visit.wk <- ceiling(as.numeric(difftime(clc.blood.vt$bld.receiveddate,clc.blood.vt$bld.startdate, units="weeks")))
clc.blood.vt$visit.wkdate <- as_date(clc.blood.vt$bld.startdate + dweeks(clc.blood.vt$visit.wk))
clc.blood.wk_site <- clc.blood.vt %>% arrange(Site,visit.wk,visit.wkdate) %>% group_by(Site,visit.wk,visit.wkdate) %>% tally()
clc_bld_vt.site<-ggplot(clc.blood.wk_site, aes(x=as_date(ymd(visit.wkdate)), y=n,fill=Site, color=Site)) +
  geom_line() + 
  geom_point(width = 0.2) +
  scale_y_continuous(name="# Number Collections", limits=c(0,5)) +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "1 week")  +
  scale_fill_brewer(palette="Dark2") + 
  ggtitle(label="TESTING--Fig 3. Number of biospecimen collection visits over time by site") +
  #theme_ipsum() +
  theme(panel.background = element_blank(),
        legend.title = element_text(size=7),
        axis.line = element_line(size=0.2),
        axis.text.x = element_text(angle=60, hjust = 1,size = 8, face = "bold"),                                                            
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) 







  #+scale_x_date(limit=c(as.Date("2022-11-29"),as.Date("2023-01-23")),date_breaks = "1 week", date_labels = "%Y %b %d") +
  #scale_y_continuous(breaks = seq(0, 30, by = 3))
# clc.urine.vt <- clinic.survey[which(clinic.survey$Site!="HealthPartners"),c("Connect_ID","Site","Urine_col_max","collection.tm",clc.urinetm)] #clc.bld_ur)]
# clc.urine.vt$urine.startdate <- min(as.POSIXct(ymd_hms(clc.urine.vt$d_173836415_d_266600170_d_139245758)),na.rm=TRUE)
# clc.urine.vt$urine.receiveddate <- as.POSIXct(ymd_hms(clc.urine.vt$d_173836415_d_266600170_d_541311218))
# clc.urine.vt$visit.wk <- ceiling(as.numeric(difftime(clc.urine.vt$urine.receiveddate,clc.urine.vt$urine.startdate, units="weeks")))
# clc.urine.vt$visit.wkdate <- as_date((clc.urine.vt$urine.startdate +  clc.blood.vt$bld.startdate) + (dweeks(clc.urine.vt$visit.wk) + dweeks(clc.blood.vt$visit.wk)))
# clc.urine.wk_site <- clc.urine.vt %>% arrange(Site,visit.wk,visit.wkdate) %>% group_by(Site,visit.wk,visit.wkdate) %>% tally()
# clc_urine_vt.site<-ggplot(clc.urine.wk_site, aes(x=as_date(ymd(visit.wkdate)), y=n,fill=Site, color=Site)) +
#   geom_line() + 
#   geom_point(width = 0.2) +
#   scale_y_continuous(name="# Number of Visits of Weekly Clinical Urine Collections", limits=c(0,5)) +
#   scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "1 week")  +
#   scale_fill_brewer(palette="Dark2") + 
#   ggtitle(label="Fig 4. Number of Weekly Clinical Urine \n Collection Visits over Time by Site") +
#   #theme_ipsum() +
#   theme(panel.background = element_blank(),
#         legend.title = element_text(size=7),
#         axis.line = element_line(size=0.2),
#         axis.text.x = element_text(angle=60, hjust = 1,size = 8, face = "bold"),                                                            
#         plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) 








clc.bothtm <- c("d_173836415_d_266600170_d_139245758","d_173836415_d_266600170_d_224596428","d_173836415_d_266600170_d_541311218","d_173836415_d_266600170_d_939818935","d_173836415_d_266600170_d_769615780","d_173836415_d_266600170_d_822274939","d_173836415_d_266600170_d_398645039","d_173836415_d_266600170_d_982213346")
clc.both.vt <- clinic.survey[which(clinic.survey$Site!="HealthPartners"),c("Connect_ID","Site","bldcol_max","Urine_col_max","collection.tm",clc.bothtm)]  ## On Hold, remove != HealthPartners/add HF
clc.both.vt$both.startdate <- min(ymd_hms(clc.both.vt$d_173836415_d_266600170_d_139245758), ymd_hms(clc.both.vt$d_173836415_d_266600170_d_982213346),na.rm=TRUE) #as.POSIXct()
clc.both.vt$both.receiveddate <- as.POSIXct(ymd_hms(clc.both.vt$d_173836415_d_266600170_d_541311218), ymd_hms(clc.both.vt$d_173836415_d_266600170_d_398645039))  
clc.both.vt$visit.wk <- ceiling(as.numeric(difftime(clc.both.vt$both.receiveddate,clc.both.vt$both.startdate, units="weeks")))
clc.both.vt$visit.wkdate <- as_date(clc.both.vt$both.startdate + dweeks(clc.both.vt$visit.wk))

clc.both.vt.KP <- clc.both.vt %>%  filter(visit.wkdate >=as.Date("2023-01-30"))

clc.both.vt.CO <- clc.both.vt.KP %>%  filter(clc.both.vt.KP$Site=="Kaiser Permanente Colorado")
clc.both.vt.GA <- clc.both.vt.KP %>%  filter(clc.both.vt.KP$Site=="Kaiser Permanente Georgia")
clc.both.vt.HI <- clc.both.vt.KP %>%  filter(clc.both.vt.KP$Site=="Kaiser Permanente Hawaii")
clc.both.vt.NW <- clc.both.vt.KP %>%  filter(clc.both.vt.KP$Site=="Kaiser Permanente Northwest")


clc.both.wk_site.CO <- clc.both.vt.CO %>% arrange(Site,visit.wk,visit.wkdate) %>% group_by(Site,visit.wk,visit.wkdate) %>% tally()
clc_both_vt.site.CO<-ggplot(clc.both.wk_site.CO, aes(x=as_date(ymd(visit.wkdate)), y=n,fill=Site, color=Site)) +
  geom_line() + 
  geom_point(width = 0.2) +
  scale_y_continuous(name="# Number Collections") + #, minor_breaks=0) + #, limits=c(0,max(clc.both.wk_site.CO$visit.wk))) + #, limits=c(0,5)) +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "1 week")  +
  scale_fill_brewer(palette="Dark2") + 
  ggtitle(label="Fig 8. Weekly Biospecimen Collections \n at Kaiser Permanente Colorado") +
  #theme_ipsum() +
  theme(panel.background = element_blank(),
        legend.title = element_text(size=7),
        axis.line = element_line(size=0.2),
        axis.text.x = element_text(angle=60, hjust = 1,size = 8, face = "bold"),                                                            
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) 

clc_both_vt.site.CO




clc.both.wk_site.GA <- clc.both.vt.GA %>% arrange(Site,visit.wk,visit.wkdate) %>% group_by(Site,visit.wk,visit.wkdate) %>% tally()
clc_both_vt.site.GA<-ggplot(clc.both.wk_site.GA, aes(x=as_date(ymd(visit.wkdate)), y=n,fill=Site, color=Site)) +
  geom_line() + 
  geom_point(width = 0.2) +
  scale_y_continuous(name="# Number Collections") + #, limits=c(0,5)) +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "1 week")  +
  scale_fill_brewer(palette="Dark2") + 
  ggtitle(label="Fig 9. Weekly Biospecimen Collections \n at Kaiser Permanente Georgia") +
  #theme_ipsum() +
  theme(panel.background = element_blank(),
        legend.title = element_text(size=7),
        axis.line = element_line(size=0.2),
        axis.text.x = element_text(angle=60, hjust = 1,size = 8, face = "bold"),                                                            
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) 

clc_both_vt.site.GA




clc.both.wk_site.HI <- clc.both.vt.HI %>% arrange(Site,visit.wk,visit.wkdate) %>% group_by(Site,visit.wk,visit.wkdate) %>% tally()
clc_both_vt.site.HI<-ggplot(clc.both.wk_site.HI, aes(x=as_date(ymd(visit.wkdate)), y=n,fill=Site, color=Site)) +
  geom_line() + 
  geom_point(width = 0.2) +
  scale_y_continuous(name="# Number Collections") + #, limits=c(0,5)) +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "1 week")  +
  scale_fill_brewer(palette="Dark2") + 
  ggtitle(label="Fig 10. Weekly Biospecimen Collections \n at Kaiser Permanente Hawaii") +
  #theme_ipsum() +
  theme(panel.background = element_blank(),
        legend.title = element_text(size=7),
        axis.line = element_line(size=0.2),
        axis.text.x = element_text(angle=60, hjust = 1,size = 8, face = "bold"),                                                            
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) 

clc_both_vt.site.HI




clc.both.wk_site.NW <- clc.both.vt.NW %>% arrange(Site,visit.wk,visit.wkdate) %>% group_by(Site,visit.wk,visit.wkdate) %>% tally()
clc_both_vt.site.NW<-ggplot(clc.both.wk_site.NW, aes(x=as_date(ymd(visit.wkdate)), y=n,fill=Site, color=Site)) +
  geom_line() + 
  geom_point(width = 0.2) +
  scale_y_continuous(name="# Number Collections") + #, limits=c(0,5)) +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "1 week")  +
  scale_fill_brewer(palette="Dark2") + 
  ggtitle(label="Fig 11. Weekly Biospecimen Collections \n at Kaiser Permanente Northwest") +
  #theme_ipsum() +
  theme(panel.background = element_blank(),
        legend.title = element_text(size=7),
        axis.line = element_line(size=0.2),
        axis.text.x = element_text(angle=60, hjust = 1,size = 8, face = "bold"),                                                            
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) 

clc_both_vt.site.NW










#Figure 4

recr_site_only <- recr.biospe %>%  select(d_650516960, Connect_ID)

blood_fig4 <- left_join(recr.bio, recr_site_only, by="Connect_ID") 

blood_placed= blood_fig4 %>%  filter(recr.bio$d_821247024==197316935  & (d_827220437==125001209 | d_827220437==327912200 |
                                                                        d_827220437==300267574 | d_827220437==452412599 | (d_650516960==664882224 & d_827220437==548392715)))
blood_placed= blood_placed %>%   mutate(bld_placed= case_when(d_173836415_d_266600170_d_530173840==353358909 ~ "Blood Draw Order Placed",
                               (d_173836415_d_266600170_d_530173840==104430631 | is.na(d_173836415_d_266600170_d_530173840))~ "No Blood Draw Order Placed"),
                               KP_Site= case_when(d_827220437==125001209 ~ "Kaiser Permanente Colorado",
                                                              d_827220437==327912200 ~ "Kaiser Permanente Georgia",
                                                              d_827220437==300267574 ~ "Kaiser Permanente Hawaii",
                                                              d_827220437==452412599 ~ "Kaiser Permanente Northwest",
                                                              d_827220437==548392715 ~ "Henry Ford Health System"), #on hold until hybrid
                               verif_bld= case_when(d_821247024==197316935 ~ 1,
                                                    TRUE ~ 0))

blood_placed_plot <- ggplot(blood_placed, aes(x=KP_Site, y=verif_bld, fill=bld_placed)) + #, label="Frequency of Status"
  geom_bar(position="stack",stat="identity") + 
  ggtitle("Fig 1. Clinical Blood Draw Order Status \n of Verified Participants by Site") + 
  ylab("Number of Verified Participants") + xlab("Site") +
  theme(panel.background = element_blank(),
          legend.title = element_blank(),
          axis.line = element_line(size=0.2),
          axis.text.x = element_text(angle = 60,hjust = 1, size = 8, face = "bold"), 
          plot.title = element_text(hjust = 0.5,size = 12, face = "bold"))







## Table 25 (used to be 23)
Table27_bld_draw <- blood_placed %>% dplyr::select(KP_Site, bld_placed)  %>% tbl_cross(
  row = KP_Site,
  col = bld_placed,
  percent = "row",
  digits=c(0,1),
  label=list(KP_Site~"Site", bld_placed~" "), 
  missing="ifany",
  missing_text="Unknown") %>%
  bold_labels() %>%
  #italicize_levels() %>% 
  modify_header() %>%
  modify_caption("Table 27. Clinical Blood Draw Order Status Among Verified Participants") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)














``` 
 
 
 
```{r, include=FALSE, echo=FALSE, warning=FALSE}

#Table 25

avg_ccc <-  "SELECT  d_173836415_d_266600170_d_769615780, d_173836415_d_266600170_d_982213346, d_827220437 FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` 
where d_878865966='353358909' and d_173836415_d_266600170_d_769615780 is not null and d_173836415_d_266600170_d_982213346 is not null"

avg_table_cc <- bq_project_query(project, avg_ccc)

avg <- bq_table_download(avg_table_cc, bigint = "integer64")


avg_coll <- avg %>%  filter(d_173836415_d_266600170_d_982213346>=as.Date("2023-02-01") & (d_827220437==125001209 |  d_827220437==327912200 | 
                                                                                                d_827220437==300267574 | d_827220437==452412599 | d_827220437==548392715))
#avg$Site<- droplevels(avg$Site)


avg_coll <- avg_coll %>%  mutate(time = as.numeric(difftime(as.POSIXct(ymd_hms(d_173836415_d_266600170_d_982213346)),as.POSIXct(ymd_hms(d_173836415_d_266600170_d_769615780)),units="days")),
                                 Site = case_when(d_827220437==125001209 ~ "Kaiser Permanente Colorado",
                                                  d_827220437==327912200 ~ "Kaiser Permanente Georgia",
                                                  d_827220437==300267574 ~ "Kaiser Permanente Hawaii",
                                                  d_827220437==452412599 ~ "Kaiser Permanente Northwest",
                                                  d_827220437==548392715 ~ "Henry Ford Health System"))
#research.vt.length <- research.survey %>%  mutate(time=as.numeric(time_biochk))

avg_draw_order = avg_coll %>%group_by(Site) %>% #biochk_outlier,
  dplyr::summarize('Number of Collection'=n(),
                   Min = round(min(time,na.rm = TRUE), digits=1),
                   Q1 = round(quantile(time, 0.25,na.rm = TRUE), digits=1),
                   Median = round(median(time,na.rm = TRUE), digits=1),
                   Mean = round(mean(time,na.rm = TRUE), digits=1),
                   SD= round(sd(time,na.rm = TRUE), digits=1),
                   Q3 = round(quantile(time, 0.75,na.rm = TRUE), digits=1),
                   Max = round(max(time,na.rm = TRUE), digits=1))

```




```{r, include=FALSE, echo=FALSE, warning=FALSE}



##Temporary Table -- recr.bio : d_764863765 is BU completion time stamp and d_222161762 is BUM,     biospe: d_678166505 is time stamp anything collected?

timestamps <-  "SELECT Connect_ID, d_764863765, d_222161762, d_173836415_d_266600170_d_982213346, d_173836415_d_266600170_d_139245758, d_173836415_d_266600170_d_561681068, d_173836415_d_266600170_d_847159717
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` where Connect_ID is not null"
TSofcollection <-  "SELECT Connect_ID, d_678166505, d_650516960 FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.biospecimen_JP` where Connect_ID is not null"

timestamps_cc <- bq_project_query(project, timestamps)
TSofcollection_cc <- bq_project_query(project, TSofcollection)

compTS <- bq_table_download(timestamps_cc, bigint = "integer64")
collTS <- bq_table_download(TSofcollection_cc, bigint = "integer64")

biosurvTS <- left_join(compTS, collTS, by="Connect_ID")

#####table(biosurvTS$d_650516960[!is.na(biosurvTS$d_678166505)])--- collection time stamp d_678166505 is only applicable to research samples

##BU (clinical)
BU_TS <- biosurvTS %>%  filter(!is.na(d_764863765) & (!is.na(d_173836415_d_266600170_d_982213346) | !is.na(d_173836415_d_266600170_d_139245758)) )  # &  d_650516960==664882224


#for( i in 1:dim(BU_TS)[[1]]){
# BU_TS <- BU_TS %>%  mutate(donation = case_when( !is.na(d_173836415_d_266600170_d_982213346) & is.na(d_173836415_d_266600170_d_139245758) ~ as.POSIXct(ymd_hms(d_173836415_d_266600170_d_982213346)),
#                                                   is.na(d_173836415_d_266600170_d_982213346) & !is.na(d_173836415_d_266600170_d_139245758) ~ as.POSIXct(ymd_hms(d_173836415_d_266600170_d_139245758)),
#                                                  !is.na(d_173836415_d_266600170_d_982213346) & !is.na(d_173836415_d_266600170_d_139245758) ~
#   min(as.POSIXct(ymd_hms(d_173836415_d_266600170_d_982213346)), as.POSIXct(ymd_hms(d_173836415_d_266600170_d_139245758)), na.rm=T )))


#### all but three people are donating their blood and urine simeltaneously, so running them as one time stamp for now



#BU_TS <- biosurvTS %>%  mutate(time = as.numeric(difftime(as.POSIXct(ymd_hms(d_678166505)),as.POSIXct(ymd_hms(d_764863765)),  units="days")))
#BU_TS <- BU_TS %>%  mutate(time = as.numeric(difftime(as.POSIXct(ymd_hms(d_678166505)),as.POSIXct(ymd_hms(d_764863765)),units="days")))
BU_TS <- BU_TS %>%  mutate(time = as.numeric(difftime( as.POSIXct(ymd_hms(d_764863765)),min(as.POSIXct(ymd_hms(d_173836415_d_266600170_d_982213346)), as.POSIXct(ymd_hms(d_173836415_d_266600170_d_139245758)), na.rm=T),
                                                       units="days")))

BU_TS_time_span = BU_TS %>% #group_by(Site) %>% #biochk_outlier,
  dplyr::summarize(#'Number of Collection'=n(),
                   Min = round(min(time,na.rm = TRUE), digits=1),
                   Q1 = round(quantile(time, 0.25,na.rm = TRUE), digits=1),
                   Median = round(median(time,na.rm = TRUE), digits=1),
                   Mean = round(mean(time,na.rm = TRUE), digits=1),
                   SD= round(sd(time,na.rm = TRUE), digits=1),
                   Q3 = round(quantile(time, 0.75,na.rm = TRUE), digits=1),
                   Max = round(max(time,na.rm = TRUE), digits=1))

timelag1 <- knitr::kable(BU_TS_time_span, caption='Time Lag (in Days) from Clinical Blood Urine Biospecimen Donation to Survey Completion', row.names=FALSE, align=c("l","c","c","c","c","c","c","c","c","c"),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "scale_down")




##BUM (research)
  # table(biosurvTS$d_650516960[!is.na(biosurvTS$d_173836415_d_266600170_d_561681068)])
  # table(biosurvTS$d_650516960[!is.na(biosurvTS$d_173836415_d_266600170_d_847159717)])
  # table(biosurvTS$d_650516960[!is.na(biosurvTS$d_222161762)])
  # table(biosurvTS$d_650516960[!is.na(biosurvTS$d_678166505)])


BUM_TS <- biosurvTS %>%  filter(!is.na(d_222161762)  & (!is.na(d_173836415_d_266600170_d_561681068) | !is.na(d_173836415_d_266600170_d_847159717))) #& !is.na(d_678166505)
#BUM_TS <- biosurvTS %>%  filter(!is.na(d_222161762) & !is.na(d_678166505) & d_650516960==534621077) # 

#BUM_TS$d_827220437<- droplevels(BUM_TS$d_827220437)


#BUM_TS <- BUM_TS %>%  mutate(time = as.numeric(difftime(as.POSIXct(ymd_hms(d_678166505)),as.POSIXct(ymd_hms(d_222161762)),units="days")))
#BUM_TS <- BUM_TS %>%  mutate(time = as.numeric(difftime(as.POSIXct(ymd_hms(d_222161762)),as.POSIXct(ymd_hms(d_678166505)),units="days")))
BUM_TS <- BUM_TS %>%  mutate(time = as.numeric(difftime(as.POSIXct(ymd_hms(d_222161762)),
                                                        min(as.POSIXct(ymd_hms(d_173836415_d_266600170_d_561681068)), as.POSIXct(ymd_hms(d_173836415_d_266600170_d_847159717)), na.rm=T) ,units="days")))

#table(is.na(BUM_TS$d_173836415_d_266600170_d_561681068) & !is.na(BUM_TS$d_173836415_d_266600170_d_847159717))

BUM_TS_time_span = BUM_TS %>% #group_by(Site) %>% #biochk_outlier,
  dplyr::summarize(#'Number of Collection'=n(),
                   Min = round(min(time,na.rm = TRUE), digits=1),
                   Q1 = round(quantile(time, 0.25,na.rm = TRUE), digits=1),
                   Median = round(median(time,na.rm = TRUE), digits=1),
                   Mean = round(mean(time,na.rm = TRUE), digits=1),
                   SD= round(sd(time,na.rm = TRUE), digits=1),
                   Q3 = round(quantile(time, 0.75,na.rm = TRUE), digits=1),
                   Max = round(max(time,na.rm = TRUE), digits=1))

timelag2 <- knitr::kable(BUM_TS_time_span, caption='Time Lag (in Days) from Research Biospecimen Donation to Blood Urine Mouthwash Survey Completion', row.names=FALSE, align=c("l","c","c","c","c","c","c","c","c","c"),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "scale_down")


timelag1
timelag2


```
 
 
 


```{r, eval=TRUE,echo=FALSE}
options(knitr.table.format = "latex")
options(kableExtra.auto_format = FALSE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
# #Table1_biospecol
# knitr::kable(biospe.t1,format.args = list(big.mark = ","),caption='Table 1. Baseline Biospecimen Collections Among Verified Participants',row.names=FALSE, align=c("l","l","l","c"), booktabs=TRUE)
# #[,c(5,3,4,6)],col.names=c("Site","Any Samples Collected", "No Samples Collected", "Total")
# #knitr::kable(t1_all1,caption='Table 1. Number (and percent) of Verified Participants with any Baseline Biospecimen Collections by Site',row.names=FALSE, align=c("l","l","l","c"), booktabs=TRUE)
# #Table2_bldcol
# knitr::kable(biospe.bld,format.args = list(big.mark = ","),caption='Table 2. Baseline Blood Collection Among Verified Participants',row.names=FALSE, align=c("l","l","l","c"), booktabs=TRUE)
# #Table3_urincol
# knitr::kable(biospe.urine,format.args = list(big.mark = ","),caption='Table 3. Baseline Urine Collection Among Verified Participants',row.names=FALSE, align=c("l","l","l","c"), booktabs=TRUE)
# #Table4_mwcol
# knitr::kable(biospe.mw,format.args = list(big.mark = ","),caption='Table 4. Baseline Mouthwash Collection Among Verified Participants',row.names=FALSE, align=c("l","l","l","c"), booktabs=TRUE)

biospe.t1 %>% kable_styling(latex_options = "scale_down")
biospe.bld %>% kable_styling(latex_options = "scale_down")
biospe.urine %>% kable_styling(latex_options = "scale_down")
biospe.mw %>% kable_styling(latex_options = "scale_down")



tab5=knitr::kable(bioset, col.names=c("Setting","Any Blood Collected", "Urine Collected", "Mouthwash Collected"), caption='Table 5. Baseline Biospecimen Collection by Collection Setting', row.names=FALSE, align=c("l","c","c","c"), format.args = list(big.mark = ","), booktabs = TRUE)   
add_footnote(tab5, "Note: Some cells are not applicable. Blood and Urine Samples cannot be collected in a Home Setting. Mouthwash cannot be collected in a Clinical Setting.", notation = "none")
#footnote(tab5, "Note: Some cells are not applicable. Blood and Urine Samples cannot be collected in a Home Setting. Mouthwash cannot be collected in a Clinical Setting.",fixed_small_size=T)

tab5_1=knitr::kable(bioset5_1, col.names=c("Setting","Any Blood Collected", "Urine Collected", "Mouthwash Collected"), caption='Table 5.1 Baseline Biospecimen Collection by Collection Setting at Henry Ford Health System', row.names=FALSE, align=c("l","c","c","c"), format.args = list(big.mark = ","), booktabs = TRUE)   
add_footnote(tab5_1, "Note: Some cells are not applicable. Blood and Urine Samples cannot be collected in a Home Setting. Mouthwash cannot be collected in a Clinical Setting.", notation = "none")


# tab6=knitr::kable(biocol, caption='Table 6. Baseline Biospecimen Collection Status Among Verified Participants',linesep = "", row.names=FALSE, align=c("l","c","c","c","c"), format.args = list(big.mark = ","),format="latex", booktabs = TRUE) %>% kable_styling(latex_options = "scale_down")
# add_footnote(tab6, "Note: Based on data entered into Connect Biospecimen Dashboard.", notation = "none")  #fixed_small_size = TRUE, general = NULL, number = NULL, alphabet = NULL,)
# #footnote(tab6, "Note: Based on data entered into Connect Biospecimen Dashboard.",fixed_small_size=T)

table6_redoneR %>% kable_styling(latex_options = "scale_down")
table6_redoneC %>% kable_styling(latex_options = "scale_down")


```

```{r,echo=FALSE,error=FALSE,message=FALSE,results='asis'}

########################## Had to undo loop to statify HF for collection setting
# for (i in 1:length(biocol.site)){
#   site <- names(biocol.site[i])
#   n <- i
#   tab6n=knitr::kable(biocol.site[[site]],col.names=c("Any Blood Collected","Urine Collected","Mouthwash Collected","Number","Percent"), caption=paste("Table 6.",n, " Baseline Biospecimen Collection Status Among Verified Participants of \n",site, sep=""), row.names=FALSE, align=c("l","c","c","c","c","c","c"), format.args = list(big.mark = ","), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down")
#   print(add_footnote(tab6n, "Note: Based on data entered into Connect Biospecimen Dashboard.", notation = "none"))
# }

# knitr::kable(biocol.site[["HealthPartners"]],col.names=c("Any Blood Collected","Urine Collected","Mouthwash Collected","Number","Percent"), caption=paste("Table 6.1 Baseline Biospecimen Collection Status Among Verified Participants of \n Health Partners", sep=""), row.names=FALSE, align=c("l","c","c","c","c","c","c"), format.args = list(big.mark = ","), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down")
# 
# knitr::kable(biocol.site$`Kaiser Permanente Hawaii`,col.names=c("Any Blood Collected","Urine Collected","Mouthwash Collected","Number","Percent"), caption=paste("Table 6.2 Baseline Biospecimen Collection Status Among Verified Participants of \n Kaiser Permanente Hawaii", sep=""), row.names=FALSE, align=c("l","c","c","c","c","c","c"), format.args = list(big.mark = ","), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down")
# 
# knitr::kable(biocol.site$`Kaiser Permanente Georgia`,col.names=c("Any Blood Collected","Urine Collected","Mouthwash Collected","Number","Percent"), caption=paste("Table 6.3 Baseline Biospecimen Collection Status Among Verified Participants of \n Kaiser Permanente Georgia", sep=""), row.names=FALSE, align=c("l","c","c","c","c","c","c"), format.args = list(big.mark = ","), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down")
# 
# knitr::kable(biocol.site$`Kaiser Permanente Northwest`,col.names=c("Any Blood Collected","Urine Collected","Mouthwash Collected","Number","Percent"), caption=paste("Table 6.4 Baseline Biospecimen Collection Status Among Verified Participants of \n Kaiser Permanente Northwest", sep=""), row.names=FALSE, align=c("l","c","c","c","c","c","c"), format.args = list(big.mark = ","), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down")
# 
# knitr::kable(biocol.site$`Kaiser Permanente Colorado`,col.names=c("Any Blood Collected","Urine Collected","Mouthwash Collected","Number","Percent"), caption=paste("Table 6.5 Baseline Biospecimen Collection Status Among Verified Participants of \n Kaiser Permanente Colorado", sep=""), row.names=FALSE, align=c("l","c","c","c","c","c","c"), format.args = list(big.mark = ","), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down")
# 
# 
# 
# knitr::kable(biocol.site$`Sanford Health`,col.names=c("Any Blood Collected","Urine Collected","Mouthwash Collected","Number","Percent"), caption=paste("Table 6.6 Baseline Biospecimen Collection Status Among Verified Participants of \n Sanford Health", sep=""), row.names=FALSE, align=c("l","c","c","c","c","c","c"), format.args = list(big.mark = ","), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down")
# 
# 
# knitr::kable(biocol.site$`Marshfield Clinic Health System`,col.names=c("Any Blood Collected","Urine Collected","Mouthwash Collected","Number","Percent"), caption=paste("Table 6.7 Baseline Biospecimen Collection Status Among Verified Participants of \n Marshfield Clinic Health System", sep=""), row.names=FALSE, align=c("l","c","c","c","c","c","c"), format.args = list(big.mark = ","), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down")
# 
# knitr::kable(biocol.site$`University of Chicago Medicine`,col.names=c("Any Blood Collected","Urine Collected","Mouthwash Collected","Number","Percent"), caption=paste("Table 6.8 Baseline Biospecimen Collection Status Among Verified Participants of \n University of Chicago Medicine", sep=""), row.names=FALSE, align=c("l","c","c","c","c","c","c"), format.args = list(big.mark = ","), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down")


```





```{r,echo=FALSE,error=FALSE,message=FALSE,results='asis'}
#table7
knitr::kable(bldcol_research1, col.names=c("Site","All Blood Tubes Collected","Partial Blood Tubes Collected","No Blood Tubes Collected","Total"), caption='Table 7. Blood Completeness for Participants with Baseline Research Collections', row.names=FALSE, align=c("l","c","c","c","c"), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down")


#table7.1
knitr::kable(bldcol_research_UC1, col.names=c("Collection Location","All Blood Tubes Collected","Partial Blood Tubes Collected","No Blood Tubes Collected","Total"), caption='Table 7.1 Blood Completeness among University of Chicago Baseline Research Collections by Collection Location', row.names=FALSE, align=c("l","c","c","c","c"), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down")


#table7.2
knitr::kable(bldcol_research_HF1, col.names=c("Collection Location","All Blood Tubes Collected","Partial Blood Tubes Collected","No Blood Tubes Collected","Total"), caption='Table 7.2 Blood Completeness among Henry Ford Baseline Research Collections by Collection Location', row.names=FALSE, align=c("l","c","c","c","c"), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down")


#table 7.3 --- need to wait until there's more data to go back to old code   
knitr::kable(bldcol_research_HF2, col.names=c("Collection Location","All Blood Tubes Collected","Partial Blood Tubes Collected","No Blood Tubes Collected","Total"), caption='Table 7.3 Blood Completeness among Henry Ford Baseline Clinical Collections by Clinic Location', row.names=FALSE, align=c("l","c","c","c","c"), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down")


# tab8= knitr::kable(bldcol_clinic[,c(6, 7, 1:4, 8, 5)], caption='Table 8. Blood Completeness (Number of Blood Tubes Collected) for Participants with Baseline Clinic Collections', row.names=FALSE, align=c("l","c","c","c","c"), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down")   
# add_footnote(tab8, "The expected number of blood collection tubes varies by site and is as follows: KPHI-9; KPGA-7; KPNW-9; KPCO-8") 

knitr::kable(notcol_combo[, c(7,1:6)] ,col.names=c("Site", "SS Tube1", "SS Tube 2", "Heparin Tube1", "EDTA Tube1", "ACD Tube1", "Total Not Collected"), caption='Table 8. Blood Tubes Not Collected Among Partial Blood Collections at Research Collection Visits', row.names=FALSE,align=c("l","c","c","c","c","c","c","c"), booktabs = TRUE)  %>% kable_styling(latex_options = "scale_down") %>% landscape()  ## used to be Table 13


## for now this is being removed
#knitr::kable(notcol_combo8_1[c(5,6), c(7,1:6)] ,col.names=c("Site", "SS Tube3", "SS Tube 4", "Heparin Tube2", "EDTA Tube2", "EDTA Tube3", "Total Not Collected"), caption='Table 8.1 Blood Tubes Not Collected Among Partial Blood Collections at Hybrid Collection Visits', row.names=FALSE,align=c("l","c","c","c","c","c","c","c"), booktabs = TRUE)  %>% kable_styling(latex_options = "scale_down") %>% landscape()


#tab14=knitr::kable(notcol_combo2[c(1:4,6),c(14,1:11)],caption='Table 9. Blood Tubes Collected by Tube Type at Clinical Collections', row.names=FALSE,align=c("l","c","c","c","c","c","c","c", "c","c","c","c","c","c","c"), booktabs = TRUE) %>%  kable_styling(latex_options = "scale_down") #%>% landscape()
#add_footnote(tab14, "Note: Expected number of collection tubes for each Kaiser Permanente site is as follows: (1)KPCO: 4 SST, 2 Heparin, 2 EDTA. (2)KPGA: 4 SST, 1 Heparin, 2 EDTA. (3)KPHI: 4 SST, 2 Heparin, 3 EDTA. (4)KPNW: 5 SST, 2 Heparin, 2 EDTA", notation = "none") ## Used to be Table 14


#Switched order of 9 and 10, so now 10 is first 
tab10_2= table10rd %>% kable_styling(latex_options = "scale_down")
add_footnote(tab10_2, "Note: The expected number of blood collection tubes varies by site and is as follows: KPHI-9; KPGA-7; KPNW-9; KPCO-8, HFH-5", notation = "none") 


tab14=knitr::kable(notcol_combo2[,c(1:12)],caption='Table 10. Blood Tubes Collected by Tube Type at Clinical Collections', row.names=FALSE,align=c("l","c","c","c","c","c","c","c","c","c","c","c","c","c"), booktabs = TRUE) %>%  kable_styling(latex_options = "scale_down") %>% landscape()
add_footnote(tab14, "Note: Expected number of collection tubes for each Kaiser Permanente site is as follows: (1)KPCO: 4 SST, 2 Heparin, 2 EDTA. (2)KPGA: 4 SST, 1 Heparin, 2 EDTA. (3)KPHI: 4 SST, 2 Heparin, 3 EDTA. (4)KPNW: 5 SST, 2 Heparin, 2 EDTA. (5)HFH: 2 SST, 1 Heparin, 1 EDTA, 1 ACD", notation = "none") 




tab11=Table11_BldCli
add_footnote(tab11, "Note: Data sent by KP lag up to 48 hours behind data from dashboard", notation = "none") 
tab12=Table12_UrineCli
add_footnote(tab12, "Note: Data sent by KP lag up to 48 hours behind data from dashboard", notation = "none") 

knitr::kable(Table13[,c(7,5,6,4)],col.names=c("Site","Any Deviations","No Deviations", "Total Tubes Collected"), caption='Table 13. Frequency of Tubes with Any Deviation by Site',row.names=FALSE, align=c("l","c","c","c"), booktabs = TRUE )
```


```{r,echo=FALSE,error=FALSE,message=FALSE,results='asis'}

#knitr::kable(dev_count[, 3:4], col.names=c("Deviation", "Number"), caption='Table 12. Biospecimen Deviations Reported by Site', row.names=FALSE, align=c("l","c","c","c"), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down") 


for (i in 1:length(dev_count.site)){
  site <- names(dev_count.site[i])
  n <- i
  print(knitr::kable(dev_count.site[[site]], col.names=c("Deviation", "Number"), caption=paste("Table 14.",n, " Biospecimen Deviations Reported by ",site, sep=""), row.names=FALSE,
         format.args = list(big.mark = ","), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down")) 
} 
#align=c("l","c","c","c","c","c","c","c"),

```



```{r,echo=FALSE,error=FALSE,message=FALSE,results='asis'}


# #Table 15a
# tab15a=research.notcolnotes_site %>%  kable_styling(latex_options = "scale_down")   #%>%  kable(align=c("l","c","c","c","c","c","c","c")) 
# tab15a
# # cols_align(
# #   tab15a,
# #   align = c("l","c","c","c","c","c","c","c"),
# #   columns = everything()
# # )   
# 
# #Table 15b
# tab15b=research.notcolnotes_tube %>%  kable_styling(latex_options = "scale_down")
# tab15b

#knitr::kable(reseachnotes.notcol[, c(8,1,2,4,5,3,6,7)], caption='Table 15a. Reason Not Collected for Tubes Not Collected at Research Collection Visits by Site',align=c("l","c","c","c","c","c","c","c"), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down")
# knitr::kable(research.notcolnotes_site[, c(8,1,2,4,5,3,6,7)], caption='Table 15a. Reason Not Collected for Tubes Not Collected at Research Collection Visits by Site',align=c("l","c","c","c","c","c","c","c"), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down")
# #[,c(8,1,2,4,5,3,6,7)], row.names=FALSE,
#knitr::kable(reseachnotes.coltype[, c(8,1,2,4,5,3,6,7)], caption='Table 15b. Reason Not Collected for Tubes Not Collected at Research Collection Visits by Tube Type',row.names=FALSE,align=c("l","c","c","c","c","c","c"), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down")
# #[,c(8,1,2,4,5,3,6,7)]
# knitr::kable(research.notcolnotes_tube[, c(8,1,2,4,5,3,6,7)], caption='Table 15b. Reason Not Collected for Tubes Not Collected at Research Collection Visits by Tube Type',row.names=FALSE,align=c("l","c","c","c","c","c","c"), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down")


research.notcolnotes_site
research.notcolnotes_tube

# knitr::kable(notcol.reasons.clinic[,c(3,4:8,1,2)], caption='Table 16. Number of Tube Not Collected by Tube Type, and By Site at Clinic Collections',row.names=FALSE,align=c("l","c","c","c","c","c","c"), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down")
knitr::kable(discard.site, caption='Table 16. Number of Tubes Discarded by Type and by Site', row.names=FALSE,  col.names=c("Site",  "SS Tube1", "SS Tube2", "SS Tube5", "Heparin Tube1", "Heparin Tube2", "EDTA Tubes", "ACD Tubes", "Urine Tubes", "Total Tubes"), align=c("l","c","c","c","c","c","c","c","c"), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down")
#col.names=c("Site",  "SS Tube1", "SS Tube2", "SS Tube5", "Heparin Tubes", "EDTA Tubes", "ACD Tubes", "Urine Tubes", "Total Tubes"), align=c("l","c","c","c","c","c","c","c","c"),



# knitr::kable(sv.complete[,c(2:3)],caption='Table 17. Baseline Research Biospecimen Survey Status', row.names=TRUE, col.names=c("Number","Percent"), align=c("l","c","c","c","c","c"), booktabs = TRUE)
# 
# knitr::kable(sv.completeHP[,c(2:3)],caption='Table 17.1 Baseline Research Biospecimen Survey Status at HealthPartners', row.names=TRUE, col.names=c("Number","Percent"), align=c("l","c","c","c","c","c"), booktabs = TRUE)
# 
# knitr::kable(sv.completeHF[,c(2:3)],caption='Table 17.2 Baseline Research Biospecimen Survey Status at Henry Ford', row.names=TRUE, col.names=c("Number","Percent"), align=c("l","c","c","c","c","c"), booktabs = TRUE)
# 
# knitr::kable(sv.completeMF[,c(2:3)],caption='Table 17.3 Baseline Research Biospecimen Survey Status at Marshfield Clinical Health System', row.names=TRUE, col.names=c("Number","Percent"), align=c("l","c","c","c","c","c"), booktabs = TRUE)
# 
# knitr::kable(sv.completeSH[,c(2:3)],caption='Table 17.4 Baseline Research Biospecimen Survey Status at Sanford Health', row.names=TRUE, col.names=c("Number","Percent"), align=c("l","c","c","c","c","c"), booktabs = TRUE)
# 
# knitr::kable(sv.completeUC[,c(2:3)],caption='Table 17.5 Baseline Research Biospecimen Survey Status at University of Chicago Medicine', row.names=TRUE, col.names=c("Number","Percent"), align=c("l","c","c","c","c","c"), booktabs = TRUE)



Table17_combined %>% kable_styling(latex_options = "scale_down")


# knitr::kable(clinicsv.complete[,c(2:3)],caption='Table 18. Baseline Clinical Biospecimen Survey Status', row.names=TRUE, col.names=c("Number","Percent"), align=c("l","c","c","c","c","c"), booktabs = TRUE)
# 
# knitr::kable(clinicsv.completeCO[,c(2:3)],caption='Table 18.1 Baseline Clinical Biospecimen Survey Status at Kaiser Permanente Colorado', row.names=TRUE, col.names=c("Number","Percent"), align=c("l","c","c","c","c","c"), booktabs = TRUE)
# 
# knitr::kable(clinicsv.completeGA[,c(2:3)],caption='Table 18.2 Baseline Clinical Biospecimen Survey Status at Kaiser Permanente Georgia', row.names=TRUE, col.names=c("Number","Percent"), align=c("l","c","c","c","c","c"), booktabs = TRUE)
# 
# knitr::kable(clinicsv.completeHI[,c(2:3)],caption='Table 18.3 Baseline Clinical Biospecimen Survey Status at Kaiser Permanente Hawaii', row.names=TRUE, col.names=c("Number","Percent"), align=c("l","c","c","c","c","c"), booktabs = TRUE)
# 
# knitr::kable(clinicsv.completeNW[,c(2:3)],caption='Table 18.4 Baseline Clinical Biospecimen Survey Status at Kaiser Permanente Northwest', row.names=TRUE, col.names=c("Number","Percent"), align=c("l","c","c","c","c","c"), booktabs = TRUE)


Table18_combined  %>% kable_styling(latex_options = "scale_down")



# knitr::kable(time.sv_checkin[,c(2,3)] , caption='Table 19. Baseline Research Biospecimen Survey Completion Time from Time of Visit Check-In',row.names=TRUE,col.names=c("Number","Percent "), align=c("l","c","c","c","c"), booktabs = TRUE)
# 
# knitr::kable(time.sv_checkinHP[,c(2,3)] , caption='Table 19.1 Baseline Research Biospecimen Survey Completion Time from Time of Visit Check-In at HealthPartners',row.names=TRUE,col.names=c("Number","Percent "), align=c("l","c","c","c","c"), booktabs = TRUE)
# 
# knitr::kable(time.sv_checkinHF[,c(2,3)] , caption='Table 19.2 Baseline Research Biospecimen Survey Completion Time from Time of Visit Check-In at Henry Ford',row.names=TRUE,col.names=c("Number","Percent "), align=c("l","c","c","c","c"), booktabs = TRUE)
# 
# knitr::kable(time.sv_checkinMF[,c(2,3)] , caption='Table 19.3 Baseline Research Biospecimen Survey Completion Time from Time of Visit Check-In at Marshfield Clinical Health',row.names=TRUE,col.names=c("Number","Percent "), align=c("l","c","c","c","c"), booktabs = TRUE)
# 
# knitr::kable(time.sv_checkinSH[,c(2,3)] , caption='Table 19.4 Baseline Research Biospecimen Survey Completion Time from Time of Visit Check-In at Sanford Health',row.names=TRUE,col.names=c("Number","Percent "), align=c("l","c","c","c","c"), booktabs = TRUE)
# 
# knitr::kable(time.sv_checkinUC[,c(2,3)] , caption='Table 19.5 Baseline Research Biospecimen Survey Completion Time from Time of Visit Check-In at University of Chicago Medicine',row.names=TRUE,col.names=c("Number","Percent "), align=c("l","c","c","c","c"), booktabs = TRUE)



#Table19_combined  %>% kable_styling(latex_options = "scale_down")
tbl19a <- Table19_combinedB  %>% kable_styling(latex_options = "scale_down")
add_footnote(tbl19a,"Note: The COVID-19 survey questions were separated from the Biospecimen Survey on July 5, 2023.", notation = "none") 
tbl19b <- Table19_combinedA  %>% kable_styling(latex_options = "scale_down")
add_footnote(tbl19b,"Note: The COVID-19 survey questions were separated from the Biospecimen Survey on July 5, 2023.", notation = "none") 





# knitr::kable(time.clcsv_checkin[, c(1:2)], caption='Table 20. Baseline Clinical Biospecimen Survey Completion Time from Time of Visit Collection',row.names=TRUE,col.names=c("Number","Percent "), align=c("c","c","c","c"), booktabs = TRUE)
# #colnames(research.vt.length)[1] = "Outlier"
# 
# knitr::kable(time.clcsv_checkinCO[, c(1:2)], caption='Table 20.1 Baseline Clinical Biospecimen Survey Completion Time from Time of Visit Collection at Kaiser Permanente Colorado',row.names=TRUE,col.names=c("Number","Percent "), align=c("c","c","c","c"), booktabs = TRUE)
# #colnames(research.vt.length)[1] = "Outlier"
# 
# knitr::kable(time.clcsv_checkinGA[, c(1:2)], caption='Table 20.2 Baseline Clinical Biospecimen Survey Completion Time from Time of Visit Collection at Kaiser Permanente Georgia',row.names=TRUE,col.names=c("Number","Percent "), align=c("c","c","c","c"), booktabs = TRUE)
# #colnames(research.vt.length)[1] = "Outlier"
# 
# knitr::kable(time.clcsv_checkinHI[, c(1:2)], caption='Table 20.3 Baseline Clinical Biospecimen Survey Completion Time from Time of Visit Collection at Kaiser Permanente Hawaii',row.names=TRUE,col.names=c("Number","Percent "), align=c("c","c","c","c"), booktabs = TRUE)
# #colnames(research.vt.length)[1] = "Outlier"
# 
# knitr::kable(time.clcsv_checkinNW[, c(1:2)], caption='Table 20.4 Baseline Clinical Biospecimen Survey Completion Time from Time of Visit Collection at Kaiser Permanente Northwest',row.names=TRUE,col.names=c("Number","Percent "), align=c("c","c","c","c"), booktabs = TRUE)
# #colnames(research.vt.length)[1] = "Outlier"



#Table20_combined  %>% kable_styling(latex_options = "scale_down")
Table20_combined  %>% kable_styling(latex_options = "scale_down")
# tbl20b <- Table20_combinedA  %>% kable_styling(latex_options = "scale_down")
# add_footnote(tbl20b,"Note: The COVID-19 survey questions were separated from the Biospecimen Survey on July 5, 2023.", notation = "none") 




tab21=knitr::kable(research.vt.length,caption='Table 21. Research Biospecimen Collection Visit Length (in Minutes) by Site',row.names=FALSE, align=c("l","c","c","c","c","c","c","c","c","c"),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "scale_down") #%>% landscape()
add_footnote(tab21,"Note: Expected visit length for each site is as follows: (1) HealthPartners: 25-60 minutes, (2) Henry Ford: 25-60 minutes, (3) Sanford: 10-45 minutes, (4) Marshfield: 10-45 minutes, and (5) UChicago:15-180 minutes  ", notation = "none") #and greater than 500 minutes 


# Going to have a new table 22, push the old ones back
tabbA <- knitr::kable(verif_BSL_colctC,caption='Table 22a. Time (in Days) from Verification to Research Baseline Collection for Participants Verified Before 08/01/2022',row.names=FALSE, align=c("l","c","c","c","c","c","c","c"),digits=1, booktabs = TRUE) %>% kable_styling(latex_options = "scale_down")
add_footnote(tabbA,"Note: August 2022 marks when research collection appointments were routinely offered to all new recruits at or near the time of verification. UChicago participant verification largely occurs at or near time of collection.", notation = "none")

#verif_BSL_colctC %>% gt() %>%  tab_header(title = html("Table 22c. Time (in Days) from Verification to Baseline Research Collection for Participants Verified Verified Before 02/01/2023"))

tabbB <- knitr::kable(verif_BSL_colctD,caption='Table 22b. Time (in Days) from Verification to Research Baseline Collection for Participants Verified on or After 08/01/2022',row.names=FALSE, align=c("l","c","c","c","c","c","c","c"),digits=1, booktabs = TRUE)  %>% kable_styling(latex_options = "scale_down")
add_footnote(tabbB,"Note: August 2022 marks when research collection appointments were routinely offered to all new recruits at or near the time of verification. UChicago participant verification largely occurs at or near time of collection.", notation = "none")
#verif_BSL_colctD %>% gt() %>%  tab_header(title = html("Table 22d. Time (in Days) from Verification to Baseline Research Collection for Participants Verified on or After 02/01/2023"))


knitr::kable(verif_BSL_colctA,caption='Table 23a. Time (in Days) from Verification to Clinical Baseline Collection for Participants Verified Before 02/01/2023',row.names=FALSE, align=c("l","c","c","c","c","c","c","c"),digits=1, booktabs = TRUE)  %>% 
  kable_styling(latex_options = "scale_down")

knitr::kable(verif_BSL_colctB,caption='Table 23b. Time (in Days) from Verification to Clinical Baseline Collection for Participants Verified on or After 02/01/2023',row.names=FALSE, align=c("l","c","c","c","c","c","c","c"),digits=1, booktabs = TRUE)  %>% 
  kable_styling(latex_options = "scale_down")






#verif24Af 
#output24 <- ggdraw() + draw_image("bycampaign.png", scale=0.655)
#output24


#knitr::kable(verif_baseline_24_Af, caption="Table 25. Time (in Days) from Verification to Clinical Baseline Collection for \n Participants Verified After 06/01/2022, by Campaign Type", row.names=FALSE, align=c("l","c","c","c","c","c","c","c","c","c"),digits=1, booktabs = TRUE) %>% kable_styling(latex_options = "scale_down") %>% landscape()



AF24 <- knitr::kable(verif_baseline_24_Af[c(1,2,7:9,3:6), ],caption = 'Table 24. Time (in Days) from Verification to Clinical Baseline Collection for \n Participants Verified After 06/01/2022, by Campaign Type',row.names=FALSE, booktabs = T, linesep = "", format.args = list(big.mark = ","), align = c("l", "c", "c","c", "c", "c", "c", "c", "c", "c", "c","c", "c","c"), col.names=c("Site",  'Number of Baseline Collections',"Min", "Median", "Mean", "SD", "Max", 'Number of Baseline Collections', "Min", "Median", "Mean", "SD", "Max","Total Number of Baseline Collections") ) %>% kable_styling(latex_options = "scale_down") %>% add_indent(c(1:9)) %>% add_header_above(c(" " = 1, "Upcoming Appointment" = 6, "All Other Campaigns" = 6,  " "=1)) %>% landscape() 
add_footnote(AF24, "Note: Upcoming Appointment includes Screening appointment and Non-screening appointment campaign types. All Other Campaigns include Random, Demographic Group, Aging out of study, Geographic group, Post-Screening Selection, Technology adapters, Low-income/health professional shortage areas, and Other campaign types.")


tabl25 <- knitr::kable(verif_draw_order,caption='Table 25. Time (in Days) from Verification to Draw Order Placement',row.names=FALSE, align=c("l","c","c","c","c","c","c"),digits=1, booktabs = TRUE)  %>% 
  kable_styling(latex_options = "scale_down")
add_footnote(tabl25, "Note: Time from verification to draw order placement calculated for participants verified on or after February 1, 2023.", notation="none")


knitr::kable(avg_draw_order, caption='Table 26. Time (in Days) from Draw Order Placement to Clinical Collection by Site', row.names=FALSE, align=c("l","c","c","c","c","c","c","c","c","c"),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "scale_down") #%>% landscape()

Table27_bld_draw 




```



\newpage
\FloatBarrier

# Plots
```{r, eval=TRUE,echo=FALSE, fig.cap='Figure 1'}
# fig.height = 5, fig.width = 5, 
blood_placed_plot


```





```{r, eval=TRUE,echo=FALSE,fig.cap='Figure 2'}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
#need sum of collections by week
#table(visit_wk_site$visit.wkdate, visit_wk_site$n)
#(d_684635302 == 353358909 | d_878865966 == 353358909| d_167958071 == 353358909)

fig2_all <- research.survey %>%  filter(d_684635302 == 353358909 | d_878865966 == 353358909| d_167958071 == 353358909)

fig2_1<- fig2_all %>% mutate(#weekday = weekdays(ymd_hms(collection.tm)),
                                    #chicago = ifelse(d_827220437.y == 809703864, "Chicago","non Chicago"),
                                    start.date = min(schedulecol.tm),
                                    current.date=max(as.POSIXct(ymd_hms(schedulecol.tm))),
                                    BioRec_CollectScheduled = ifelse(as.Date(ymd_hms(schedulecol.tm)) >= as.Date(as.POSIXct(ymd_hms(d_914594314))),1,0))
                                    
                                    
fig2_1$visit.wk <- ceiling(as.numeric(difftime(ymd_hms(fig2_1$collection.tm),fig2_1$start.date, units="weeks")))
fig2_1$visit.wkdate <- fig2_1$start.date + dweeks(fig2_1$visit.wk)
visit_wk_site1 <- fig2_1 %>% arrange(visit.wk,visit.wkdate) %>% group_by(visit.wk,visit.wkdate) %>% tally()


research.vt1 <- ggplot(visit_wk_site1, aes(x=as.Date(visit.wkdate), y=n)) + #,fill=Site, color=Site)) +
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="# Number of Collections") + #, limits=c(0,30), breaks=seq(0,30,5)) +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks")  +
  scale_fill_brewer(palette="Dark2") +
  ggtitle(label="Fig 2. Weekly Biospecimen Collections, All Sites") +
  #theme_ipsum() +
  theme(panel.background = element_blank(),
        legend.title = element_text(size=7),
        legend.position="bottom",
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14, face = "bold") ,
        axis.title.y = element_text(size = 14, face = "bold",color="black"),
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +
        guides(fill=guide_legend(nrow=2,byrow=TRUE))

research.vt1






```


```{r, eval=TRUE,echo=FALSE}
# research.vt_plHF <- visit_wk_site2 %>%  filter(Site=="Henry Ford Health System")
# research.vt_plUC <- visit_wk_site2 %>%  filter(Site=="University of Chicago Medicine")
# research.vt_plMF <- visit_wk_site2 %>%  filter(Site=="Marshfield Clinic Health System")

# Figure 3 now on report --will need second clinical line added too

 #  research.vt_plH= visit_wk_site %>%  filter( Site=="Henry Ford Health System")
 # research.vt_plotH <- ggplot(research.vt_plH, aes(x=as.Date(visit.wkdate), y=n, color=site )) + #,fill=site, color=site)) +   #research.vt <-    ,fill=Site, color=Site
 #   geom_line() + geom_point(width = 0.2) +
 #   scale_y_continuous(name="# Number Collections", limits=c(0,30), breaks=seq(0,30,5)) +
 #   scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks")  +
 #   scale_fill_brewer(palette="Dark2") +
 #   ggtitle(label="Fig 3. Weekly Biospecimen Collections at Henry Ford Locations") +
 #   #theme_ipsum() +
 #   theme(panel.background = element_blank(),
 #         #legend.title = element_text(size=7),
 #         axis.line = element_line(size=0.2),
 #         axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) ,  #, face = "bold"
 #         axis.title.y = element_text(size = 14,color="black"),   #, face = "bold"
 #         plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) #guides(fill=guide_legend(nrow=2,byrow=TRUE))
 # print(research.vt_plotH)
 
 
 
 
 
 
 #Hybird version
VW_biospe <- biospe %>%  select(d_951355211, Connect_ID)
VW_biospe$Connect_ID <- as.character(VW_biospe$Connect_ID)
Hybrid_VWS <- left_join(recr.biospe, VW_biospe, by="Connect_ID")
 
 
 research.survey.hybrid <- Hybrid_VWS %>% filter(Site=="Henry Ford Health System") #<- change to site=HF, color=d_650516960

research.survey.hybrid<-research.survey.hybrid %>% mutate(#weekday = weekdays(ymd_hms(collection.tm)),
                                    #chicago = ifelse(d_827220437.y == 809703864, "Chicago","non Chicago"),
                                    start.date = min(schedulecol.tm),
                                    current.date=max(as.POSIXct(ymd_hms(schedulecol.tm))),
                                    BioRec_CollectScheduled = ifelse(as.Date(ymd_hms(schedulecol.tm)) >= as.Date(as.POSIXct(ymd_hms(d_914594314))),1,0),
                                    Setting= case_when(d_650516960==534621077 ~ "Research",
                                                       d_650516960==664882224 ~ "Clinical"),
                                    Site_location = case_when(d_951355211==777644826 ~ "UC-DCAM",
                                                      d_951355211==145191545 ~ "Ingalls Harvey",
                                                      d_951355211==489380324 ~ "River East",
                                                      d_951355211==120264574 ~ "South Loop",
                                                      d_951355211==736183094 ~ "HFH K-13 Research Clinic",
                                                      d_951355211==886364332 ~ "HFH Cancer Pavilion Research Clinic",
                                                      d_951355211==706927479 ~ "HFH Livonia Research Clinic",
                                                      d_951355211==692275326 ~ "Marshfield",
                                                      d_951355211==813701399 ~ "Weston",
                                                      d_951355211==698283667 ~ "Lake Hallie",
                                                      d_951355211==691714762 ~ "Rice Lake",
                                                      d_951355211==487512085 ~ "Wisconsin Rapids",
                                                      d_951355211==983848564 ~ "Colby Abbotsford",
                                                      d_951355211==261931804 ~ "Minocqua",
                                                      d_951355211==665277300 ~ "Merrill",
                                                      d_951355211==589224449 ~ "Sioux Falls Imagenetics",
                                                      d_951355211==467088902 ~ "Fargo South University",
                                                      TRUE ~ "Hybrid"))
                                    
                                    
research.survey.hybrid$visit.wk <- ceiling(as.numeric(difftime(ymd_hms(research.survey.hybrid$collection.tm),research.survey.hybrid$start.date, units="weeks")))
research.survey.hybrid$visit.wkdate <-research.survey.hybrid$start.date + dweeks(research.survey.hybrid$visit.wk)
visit_wk_site.hybrid <-research.survey.hybrid %>% arrange(Site,Site_location, Setting,visit.wk,visit.wkdate) %>% group_by(Site,Site_location, Setting,visit.wk,visit.wkdate) %>% tally()


 
   #research.vt_plH= visit_wk_site %>%  filter( Site=="Henry Ford Health System")
 research.vt_plotH <- ggplot(visit_wk_site.hybrid, aes(x=as.Date(visit.wkdate), y=n, color=Setting )) + #,fill=site, color=site)) +   #research.vt <-    ,fill=Site, color=Site
   geom_line() + geom_point(width = 0.2) +
   scale_y_continuous(name="# Number Collections", limits=c(0,30), breaks=seq(0,30,5)) +
   scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks")  +
   scale_fill_brewer(palette="Dark2") +
   ggtitle(label="Fig 3. Weekly Biospecimen Collections at Henry Ford") +
   #theme_ipsum() +
   theme(panel.background = element_blank(),
         #legend.title = element_text(size=7),
         axis.line = element_line(size=0.2),
         axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) ,  #, face = "bold"
         axis.title.y = element_text(size = 14,color="black"),   #, face = "bold"
         plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) #guides(fill=guide_legend(nrow=2,byrow=TRUE))
 print(research.vt_plotH)
 
 

 edited_fig3_1 <-  visit_wk_site.hybrid %>%  filter(Site_location!="Hybrid")
  research.vt_plotH <- ggplot(edited_fig3_1, aes(x=as.Date(visit.wkdate), y=n, color=Site_location )) + #,fill=site, color=site)) +   #research.vt <-    ,fill=Site, color=Site
   geom_line() + geom_point(width = 0.2) +
   scale_y_continuous(name="# Number Collections", limits=c(0,30), breaks=seq(0,30,5)) +
   scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks")  +
   scale_fill_brewer(palette="Dark2") +
   ggtitle(label="Fig 3.1 Weekly Biospecimen Collections at \n Henry Ford Locations") +
   #theme_ipsum() +
   theme(panel.background = element_blank(),
         #legend.title = element_text(size=7),
         axis.line = element_line(size=0.2),
         axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) ,  #, face = "bold"
         axis.title.y = element_text(size = 14,color="black"),   #, face = "bold"
         plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) #guides(fill=guide_legend(nrow=2,byrow=TRUE))
 print(research.vt_plotH)
 
 
 
 
 
 
 
 
 
 
 ## On hold- need second line for HF clinical collections-- maybe fill by collection setting? Maybe combine with this clinical version 
 
#  clc.bothtm <- c("d_173836415_d_266600170_d_139245758","d_173836415_d_266600170_d_224596428","d_173836415_d_266600170_d_541311218","d_173836415_d_266600170_d_939818935","d_173836415_d_266600170_d_769615780","d_173836415_d_266600170_d_822274939","d_173836415_d_266600170_d_398645039","d_173836415_d_266600170_d_982213346")
# clc.both.vt <- clinic.survey[which(clinic.survey$Site!="HealthPartners"),c("Connect_ID","Site","bldcol_max","Urine_col_max","collection.tm",clc.bothtm)]
# clc.both.vt$both.startdate <- min(ymd_hms(clc.both.vt$d_173836415_d_266600170_d_139245758), ymd_hms(clc.both.vt$d_173836415_d_266600170_d_982213346),na.rm=TRUE) #as.POSIXct()
# clc.both.vt$both.receiveddate <- as.POSIXct(ymd_hms(clc.both.vt$d_173836415_d_266600170_d_541311218), ymd_hms(clc.both.vt$d_173836415_d_266600170_d_398645039))  
# clc.both.vt$visit.wk <- ceiling(as.numeric(difftime(clc.both.vt$both.receiveddate,clc.both.vt$both.startdate, units="weeks")))
# clc.both.vt$visit.wkdate <- as_date(clc.both.vt$both.startdate + dweeks(clc.both.vt$visit.wk))
# 
# clc.both.vt.KP <- clc.both.vt %>%  filter(visit.wkdate >=as.Date("2023-01-30"))
# 
# clc.both.vt.CO <- clc.both.vt.KP %>%  filter(clc.both.vt.KP$Site=="Kaiser Permanente Colorado")
# clc.both.vt.GA <- clc.both.vt.KP %>%  filter(clc.both.vt.KP$Site=="Kaiser Permanente Georgia")
# clc.both.vt.HI <- clc.both.vt.KP %>%  filter(clc.both.vt.KP$Site=="Kaiser Permanente Hawaii")
# clc.both.vt.NW <- clc.both.vt.KP %>%  filter(clc.both.vt.KP$Site=="Kaiser Permanente Northwest")
# 
# 
# clc.both.wk_site.CO <- clc.both.vt.CO %>% arrange(Site,visit.wk,visit.wkdate) %>% group_by(Site,visit.wk,visit.wkdate) %>% tally()
# clc_both_vt.site.CO<-ggplot(clc.both.wk_site.CO, aes(x=as_date(ymd(visit.wkdate)), y=n,fill=Site, color=Site)) +
#   geom_line() + 
#   geom_point(width = 0.2) +
#   scale_y_continuous(name="# Number Collections", limits=c(0,40)) + #, minor_breaks=0) + #, limits=c(0,max(clc.both.wk_site.CO$visit.wk))) + #, limits=c(0,5)) +
#   scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "1 week")  +
#   scale_fill_brewer(palette="Dark2") + 
#   ggtitle(label="Fig 8. Weekly Biospecimen Collections \n at Kaiser Permanente Colorado") +
#   #theme_ipsum() +
#   theme(panel.background = element_blank(),
#         legend.title = element_text(size=7),
#         axis.line = element_line(size=0.2),
#         axis.text.x = element_text(angle=60, hjust = 1,size = 8, face = "bold"),                                                            
#         plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) 
# 
# clc_both_vt.site.CO

VW_biospe <- biospe %>%  select(d_951355211, Connect_ID)
VW_biospe$Connect_ID <- as.character(VW_biospe$Connect_ID)
research.surveyVW <- research.survey %>%  select(Site, Connect_ID, visit.wk,visit.wkdate)
 VWS <- left_join(research.surveyVW, VW_biospe, by="Connect_ID")
 VWS_var <- VWS %>%  mutate(Site_location = case_when(d_951355211==777644826 ~ "UC-DCAM",
                                                      d_951355211==145191545 ~ "Ingalls Harvey",
                                                      d_951355211==489380324 ~ "River East",
                                                      d_951355211==120264574 ~ "South Loop",
                                                      d_951355211==736183094 ~ "HFH K-13 Research Clinic",
                                                      d_951355211==886364332 ~ "HFH Cancer Pavilion Research Clinic",
                                                      d_951355211==706927479 ~ "HFH Livonia Research Clinic",
                                                      d_951355211==692275326 ~ "Marshfield",
                                                      d_951355211==813701399 ~ "Weston",
                                                      d_951355211==698283667 ~ "Lake Hallie",
                                                      d_951355211==691714762 ~ "Rice Lake",
                                                      d_951355211==487512085 ~ "Wisconsin Rapids",
                                                      d_951355211==983848564 ~ "Colby Abbotsford",
                                                      d_951355211==261931804 ~ "Minocqua",
                                                      d_951355211==665277300 ~ "Merrill",
                                                      d_951355211==589224449 ~ "Sioux Falls Imagenetics",
                                                      d_951355211==467088902 ~ "Fargo South University") )
 
visit_wk_site_edited <- VWS_var %>% arrange(Site, Site_location, visit.wk,visit.wkdate) %>% group_by(Site_location, Site,visit.wk,visit.wkdate) %>% tally()


#- UCHICAGO = 777644826,145191545, 489380324, 120264574
#- HENRY FORD = 736183094, 886364332, 706927479
#- MARSHFIELD = 692275326, 813701399, 698283667, 691714762, 487512085, 983848564, 261931804, 665277300
#- SANFORD = 589224449, 467088902
 
 
 research.vt_plUC= visit_wk_site_edited %>%  filter( Site=="University of Chicago Medicine")
 research.vt_plotUC <- ggplot(research.vt_plUC, aes(x=as.Date(visit.wkdate), y=n)) + #,fill=site, color=site)) +   #research.vt <-    ,fill=Site, color=Site
   geom_line() + geom_point(width = 0.2) +
   scale_y_continuous(name="# Number Collections", limits=c(0,40), breaks=seq(0,40,5)) +
   scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks")  +
   scale_fill_brewer(palette="Dark2") +
   ggtitle(label="Fig 4. Weekly Biospecimen Collections at \n University of Chicago Medicine") +
   #theme_ipsum() +
   theme(panel.background = element_blank(),
         #legend.title = element_text(size=7),
         axis.line = element_line(size=0.2),
         axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) ,  #, face = "bold"
         axis.title.y = element_text(size = 14,color="black"),   #, face = "bold"
         plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) #guides(fill=guide_legend(nrow=2,byrow=TRUE))
 print(research.vt_plotUC)
 
 
 research.vt_plUC= visit_wk_site_edited %>%  filter( Site=="University of Chicago Medicine")
 research.vt_plotUC <- ggplot(research.vt_plUC, aes(x=as.Date(visit.wkdate), y=n, color=Site_location)) + #,fill=site, color=site)) +   #research.vt <-    ,fill=Site, color=Site
   geom_line() + geom_point(width = 0.2) +
   scale_y_continuous(name="# Number Collections", limits=c(0,40), breaks=seq(0,40,5)) +
   scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks")  +
   scale_fill_brewer(palette="Dark2") +
   ggtitle(label="Fig 4.1 Weekly Biospecimen Collections at \n University of Chicago Medicine Locations") +
   #theme_ipsum() +
   theme(panel.background = element_blank(),
         #legend.title = element_text(size=7),
         axis.line = element_line(size=0.2),
         axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) ,  #, face = "bold"
         axis.title.y = element_text(size = 14,color="black"),   #, face = "bold"
         plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) #guides(fill=guide_legend(nrow=2,byrow=TRUE))
 print(research.vt_plotUC)
 
 
 
 
 
 
 research.vt_plMF= visit_wk_site_edited %>%  filter( Site=="Marshfield Clinic Health System")
 research.vt_plotMF <- ggplot(research.vt_plMF, aes(x=as.Date(visit.wkdate), y=n)) + #,fill=site, color=site)) +   #research.vt <-    ,fill=Site, color=Site
   geom_line() + geom_point(width = 0.2) +
   scale_y_continuous(name="# Number Collections", limits=c(0,30), breaks=seq(0,30,5)) +
   scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks")  +
   scale_fill_brewer(palette="Dark2") +
   ggtitle(label="Fig 5. Weekly Biospecimen Collections at \n Marshfield Clinic Health System") +
   #theme_ipsum() +
   theme(panel.background = element_blank(),
         #legend.title = element_text(size=7),
         axis.line = element_line(size=0.2),
         axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) ,  #, face = "bold"
         axis.title.y = element_text(size = 14,color="black"),   #, face = "bold"
         plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) #guides(fill=guide_legend(nrow=2,byrow=TRUE))
 print(research.vt_plotMF)
 
  research.vt_plMF= visit_wk_site_edited %>%  filter( Site=="Marshfield Clinic Health System")
 research.vt_plotMF <- ggplot(research.vt_plMF, aes(x=as.Date(visit.wkdate), y=n,fill=Site, color=Site)) +   #research.vt <-    ,fill=Site, color=Site
   geom_line() + geom_point(width = 0.2) +
   scale_y_continuous(name="# Number Collections", limits=c(0,30), breaks=seq(0,30,5)) +
   scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks")  +
   scale_fill_brewer(palette="Dark2") +
   ggtitle(label="Fig 5. Weekly Biospecimen Collections at \n Marshfield Clinic Health System") +
   #theme_ipsum() +
   theme(panel.background = element_blank(),
         #legend.title = element_text(size=7),
         axis.line = element_line(size=0.2),
         axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) ,  #, face = "bold"
         axis.title.y = element_text(size = 14,color="black"),   #, face = "bold"
         plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) #guides(fill=guide_legend(nrow=2,byrow=TRUE))
 print(research.vt_plotMF)
 
 
  research.vt_plMF= visit_wk_site_edited %>%  filter( Site=="Marshfield Clinic Health System")
 research.vt_plotMF <- ggplot(research.vt_plMF, aes(x=as.Date(visit.wkdate), y=n, color=Site_location)) + #,fill=site, color=site)) +   #research.vt <-    ,fill=Site, color=Site
   geom_line() + geom_point(width = 0.2) +
   scale_y_continuous(name="# Number Collections", limits=c(0,30), breaks=seq(0,30,5)) +
   scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks")  +
   scale_fill_brewer(palette="Dark2") +
   ggtitle(label="Fig 5.1 Weekly Biospecimen Collections at \n Marshfield Clinic Health System Locations") +
   #theme_ipsum() +
   theme(panel.background = element_blank(),
         #legend.title = element_text(size=7),
         axis.line = element_line(size=0.2),
         axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) ,  #, face = "bold"
         axis.title.y = element_text(size = 14,color="black"),   #, face = "bold"
         plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) #guides(fill=guide_legend(nrow=2,byrow=TRUE))
 print(research.vt_plotMF)

```




```{r, eval=TRUE,echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 



research.vt_plSH= visit_wk_site_edited %>%  filter( Site=="Sanford Health")
research.vt_plotSH <- ggplot(research.vt_plSH, aes(x=as.Date(visit.wkdate), y=n)) + #,fill=site, color=site)) +   #research.vt <-    ,fill=Site, color=Site
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="# Number Collections", limits=c(0,30), breaks=seq(0,30,5)) +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks")  +
  scale_fill_brewer(palette="Dark2") +
  ggtitle(label="Fig 6. Weekly Biospecimen Collections at Sanford Health") +
  #theme_ipsum() +
  theme(panel.background = element_blank(),
        #legend.title = element_text(size=7),
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) ,  #, face = "bold"
        axis.title.y = element_text(size = 14,color="black"),   #, face = "bold"
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) #guides(fill=guide_legend(nrow=2,byrow=TRUE))
print(research.vt_plotSH)


research.vt_plSH= visit_wk_site_edited %>%  filter( Site=="Sanford Health")
research.vt_plotSH <- ggplot(research.vt_plSH, aes(x=as.Date(visit.wkdate), y=n, color=Site_location)) + #,fill=site, color=site)) +   #research.vt <-    ,fill=Site, color=Site
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="# Number Collections", limits=c(0,30), breaks=seq(0,30,5)) +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks")  +
  scale_fill_brewer(palette="Dark2") +
  ggtitle(label="Fig 6.1 Weekly Biospecimen Collections at Sanford Health Locations") +
  #theme_ipsum() +
  theme(panel.background = element_blank(),
        #legend.title = element_text(size=7),
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) ,  #, face = "bold"
        axis.title.y = element_text(size = 14,color="black"),   #, face = "bold"
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) #guides(fill=guide_legend(nrow=2,byrow=TRUE))
print(research.vt_plotSH)






research.vt_plHP= visit_wk_site_edited %>%  filter( Site=="HealthPartners")
research.vt_plotHP <- ggplot(research.vt_plHP, aes(x=as.Date(visit.wkdate), y=n)) + #,fill=site, color=site)) +   #research.vt <-    ,fill=Site, color=Site
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="# Number Collections") + #, limits=c(0,30), breaks=seq(0,30,5)) +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks")  +
  scale_fill_brewer(palette="Dark2") +
  ggtitle(label="Fig 7. Weekly Biospecimen Collections at HealthPartners") +
  #theme_ipsum() +
  theme(panel.background = element_blank(),
        #legend.title = element_text(size=7),
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14) ,  #, face = "bold"
        axis.title.y = element_text(size = 14,color="black"),   #, face = "bold"
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) #guides(fill=guide_legend(nrow=2,byrow=TRUE))
print(research.vt_plotHP)







```



```{r, eval=TRUE,echo=FALSE}
# knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
 ##clc_bld_vt.site
```

```{r, eval=TRUE,echo=FALSE}
# knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
# clc.urine.vt
```

```{r, eval=TRUE,echo=FALSE}
#fig.height = 5, fig.width = 5, 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
#clc_urine_vt.site

clc_both_vt.site.CO
clc_both_vt.site.GA
clc_both_vt.site.HI
clc_both_vt.site.NW

```




```{r data,eval=TRUE,echo=FALSE,include=FALSE, warning=FALSE}

###download the biospecimen data

 currentDate <- Sys.Date()
 # write.csv(biospe,paste("~/Biospecimen/data/prod_biospecimen_",currentDate,".csv",sep=""),row.names = F,na="")
 #
 # write.csv(data2,paste("~/Biospecimen/data/prod_flatBoxes_JP_",currentDate,".csv",sep=""),row.names = F,na="")
 #
 #  write.csv(recrver,paste("~/Biospecimen/data/Connect_prod_recr_veriBiospe_",currentDate,".csv",sep=""),row.names = F,na="")


  #write.csv(recr.bio,"~/Biospecimen/data/Connect_prod_recr_veriBiospe_02132023.csv",row.names = F,na="")
###for adding the formats to the variables



box_CID <- as.data.frame(as.numeric(sapply((strsplit(colnames(box_wl_flat),"d_")),tail,1)))
box_CID$variable <- colnames(box_wl_flat)

colnames(box_CID)[1] <-"CID"
box_CID$CID <- ifelse(is.na(box_CID$CID), 0, box_CID$CID)

box_CID_dd <- merge(box_CID, y[,c("Primary.Source","conceptId.2","conceptId.3","Variable.Name","Variable.Label","conceptId.4","Current.Format.Value")],by.x="CID",by.y="conceptId.3",all.x=TRUE)

box_CID_dd$Variable.Name <- ifelse(is.na(box_CID_dd$Variable.Name), box_CID_dd$variable,box_CID_dd$Variable.Name)
box_CID_dd$category<- ifelse(is.na(box_CID_dd$conceptId.4), 0,ifelse(!is.na(box_CID_dd$conceptId.4) &  box_CID_dd$conceptId.4 !=104430631, 2, 1))

select1 <- box_CID_dd$variable[which(box_CID_dd$category==0)]
yes_no <- box_CID_dd$variable[which(box_CID_dd$category==1)]
box1 <- subset(box_wl_flat,select=select1)
colnames(box1) <- box_CID_dd$Variable.Name[which(box_CID_dd$category==0)]

##for the categorical variables
box1$BioPack_Courier_v1r0 <- ifelse(box_wl_flat$d_666553960==712278213, "FedEx",ifelse(box_wl_flat$d_666553960==149772928, "World Courier",NA))

box_wl_flat$d_560975149 <- as.factor(box_wl_flat$d_560975149)
d_560975149_CIDs <- as.data.frame(cbind(unique(y$conceptId.4[grepl(paste(levels(box_wl_flat$d_560975149),collapse="|"),y$conceptId.4)]),unique(trimws(sapply(strsplit(y$Current.Format.Value[grepl(paste(levels(box_wl_flat$d_560975149),collapse="|"),y$conceptId.4)], "="),tail,1)))))

box1$d_560975149 <- plyr::mapvalues(box_wl_flat$d_560975149,from=d_560975149_CIDs$V1,to=d_560975149_CIDs$V2)
colnames(box1)[which(colnames(box1)=="d_560975149") ]<- box_CID_dd$Variable.Name[which(box_CID_dd$variable=="d_560975149")]

box_wl_flat$d_789843387 <- as.factor(box_wl_flat$d_789843387)
d_789843387_CIDs <- as.data.frame(cbind(unique(y$conceptId.4[grepl(paste(levels(box_wl_flat$d_789843387),collapse="|"),y$conceptId.4)]),unique(trimws(sapply(strsplit(y$Current.Format.Value[grepl(paste(levels(box_wl_flat$d_789843387),collapse="|"),y$conceptId.4)], "="),tail,1)))))


# box1$BioPack_BoxID_v1r0 <- box_wl_flat$d_132929440
# box1$BioPack_ModifiedTime_v1r0 <- box_wl_flat$d_555611076
# box1$BioShip_ShipTime_v1r0 <- box_wl_flat$d_656548982
# box1$BioPack_BoxStrtTime_v1r0 <- box_wl_flat$d_672863981
# box1$BioBPTL_ShipComments_v1r0 <- box_wl_flat$d_870456401
# box1$BioBPTL_DateRec_v1r0 <- box_wl_flat$d_926457119
# box1$BioShip_SignEmail_v1r0 <- box_wl_flat$d_948887825
# box1$BioPack_TrackScan1_v1r0 <- box_wl_flat$d_959708259
# box1$BioBPTL_ShipRec_v1r0 <- box_wl_flat$d_333524031 #check for yes/no structuring


#box1$d_789843387 <- boxes$d_789843387 %>% mutate(d_789843387=factor(d_789843387))
box1$d_789843387 <- plyr::mapvalues(box_wl_flat$d_789843387,from=d_789843387_CIDs$V1,to=d_789843387_CIDs$V2)
colnames(box1)[which(colnames(box1)=="d_789843387") ]<- box_CID_dd$Variable.Name[which(box_CID_dd$variable=="d_789843387")]

##for binary variables
for (i in 1:length(yes_no)){
  x <- yes_no[i]

  varname <- box_CID_dd$Variable.Name[grepl(x,box_CID_dd$variable)]
  #type.labels <- dd$`Variable Label`[grepl(CID,dd$CID)]
  check <- as.data.frame(box_wl_flat[,grepl(x, colnames(box_wl_flat))])
  check$variable <- ifelse(check[,1]== 353358909, "Yes",ifelse(check[,1]==104430631,"No",NA))
  colnames(check)[2] <- varname
  box1 <-   cbind(box1,subset(check,select=varname))
}


#gsub("[^[:alnum:][:blank:]+?&/\\-]", "", c) #to remove any specific character in a variable in r

box1 <- box1  %>% mutate(d_238268405=gsub("^[:alnum:][:blank:]","",d_238268405),
                          d_238268405_1=case_when(substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"121149986"~"Crushed",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"200183516" ~"Vials - Incorrect Material Type",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"289322354" ~ "Material Thawed",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"387564837" ~ "Damaged Vials",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"399948893" ~ "Vials - Missing Labels",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"405513630" ~ "Cold Packs - none",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"442684673" ~ "Participant Refusal",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"595987358" ~ "Cold Packs - warm",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"613022284" ~ "No Refrigerant",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"631290535" ~ "Vials - Empty",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"678483571" ~ "Damaged Container (outer and/or inner)",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"679749262" ~ "Package in good condition",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"842171722" ~ "No Pre-notification",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"847410060" ~ "Improper Packaging",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"853876696" ~ "Manifest - not provided",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	 "909529446" ~ "Cold Packs - insufficient",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"922995819" ~ "Manifest/Paperwork/Vial information do not match",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"933646000" ~ "Other- Package Condition",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),2,10)==	"958000780" ~ "Shipment Delay") ,
                          d_238268405_2=case_when(substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"121149986"~"Crushed",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"200183516" ~"Vials - Incorrect Material Type",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"289322354" ~ "Material Thawed",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"387564837" ~ "Damaged Vials",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"399948893" ~ "Vials - Missing Labels",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"405513630" ~ "Cold Packs - none",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"442684673" ~ "Participant Refusal",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"595987358" ~ "Cold Packs - warm",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"613022284" ~ "No Refrigerant",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"631290535" ~ "Vials - Empty",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"678483571" ~ "Damaged Container (outer and/or inner)",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"679749262" ~ "Package in good condition",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"842171722" ~ "No Pre-notification",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"847410060" ~ "Improper Packaging",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"853876696" ~ "Manifest - not provided",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	 "909529446" ~ "Cold Packs - insufficient",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"922995819" ~ "Manifest/Paperwork/Vial information do not match",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"933646000" ~ "Other- Package Condition",
                                                  substring(gsub("^[:alnum:][:blank:]","",d_238268405),12,20)==	"958000780" ~ "Shipment Delay"))

box1<- box1 %>% mutate(BioPack_ShipCondtion_v1r0=ifelse(is.na(d_238268405_2), d_238268405_1, paste(d_238268405_1,d_238268405_2,sep=",")))
#box1 <- box1[, c(1:4, 6:22, 25)] --- why are some columns missing???
#missing: BioPack_BoxID_v1r0	BioPack_ModifiedTime_v1r0	BioShip_ShipTime_v1r0	BioPack_BoxStrtTime_v1r0	BioBPTL_ShipComments_v1r0	BioBPTL_DateRec_v1r0	BioShip_SignEmail_v1r0	BioPack_TrackScan1_v1r0		BioBPTL_ShipRec_v1r0


box1$BioPack_BoxID_v1r0 <- box_wl_flat$d_132929440
box1$BioPack_ModifiedTime_v1r0 <- box_wl_flat$d_555611076
box1$BioShip_ShipTime_v1r0 <- box_wl_flat$d_656548982
box1$BioPack_BoxStrtTime_v1r0 <- box_wl_flat$d_672863981
box1$BioBPTL_ShipComments_v1r0 <- box_wl_flat$d_870456401
box1$BioBPTL_DateRec_v1r0 <- box_wl_flat$d_926457119
box1$BioShip_SignEmail_v1r0 <- box_wl_flat$d_948887825
box1$BioPack_TrackScan1_v1r0 <- box_wl_flat$d_959708259
box1$BioBPTL_ShipRec_v1r0 <- box_wl_flat$d_333524031 #check for yes/no structuring

box1 <- box1 %>%  mutate(BioBPTL_ShipRec_v1r0= case_when(BioBPTL_ShipRec_v1r0==353358909 ~ "Yes",
                                                         BioBPTL_ShipRec_v1r0==104430631  ~ "No"))


box1 <- box1 %>%  select(bagID,	bagType,	tubeID,	BioPack_BoxID_v1r0,	BioPack_ModifiedTime_v1r0,	BioShip_ShipTime_v1r0,	BioPack_BoxStrtTime_v1r0,	BioBPTL_ShipComments_v1r0,	d_885486943,
                         BioBPTL_DateRec_v1r0,	BioShip_SignEmail_v1r0,	BioPack_TrackScan1_v1r0,	BioPack_Courier_v1r0,	BioShip_LocalID_v1r0,	BioShip_LogSite_v1r0,	BioPack_TempProbe_v1r0,
                         BioShip_ShipSubmit_v1r0,	BioPack_OrphanBag_v1r0,	BioBPTL_ShipRec_v1r0,	BioPack_ContainsOrphan_v1r0,	BioPack_ShipCondtion_v1r0)
box1 <- box1[, c(1:8, 10:21)]
#View(box1)


write.csv(box1,glue("Formatted_prod_flatBoxes_JP_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")











  ###to get the formats and variable names from DD
factor_cid <-function(var,data){
  var <- as.factor(var)
  var_CIDs <- as.data.frame(cbind(unique(y$conceptId.4[grepl(paste(levels(var),collapse="|"),y$conceptId.4)]),unique(trimws(sapply(strsplit(y$Current.Format.Value[grepl(paste(levels(var),collapse="|"),y$conceptId.4)], "="),tail,1)))))

  var <- plyr::mapvalues(var,from=var_CIDs$V1,to=var_CIDs$V2)
}



bio_tb2 <- bq_project_query(project, query='SELECT * FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.biospecimen_JP`')  
biospe2 <- bq_table_download(bio_tb2,bigint="integer64")

biospe2$d_646899796 <- biospe2$d_646899796_integer

cnames <- names(biospe2)
for (i in 1: length(cnames)){
  varname <- cnames[i]
  var<-pull(biospe2,varname)
  biospe2[,cnames[i]] <- ifelse(numbers_only(var), as.numeric(as.character(var)), var)
}




biospe2_CID <- as.data.frame(sapply((strsplit(colnames(biospe2),"d_")),tail,1))
colnames(biospe2_CID)[1] <- "CID"
biospe2_CID$variable <- names(biospe2)
biospe2_CID_dd <- merge(biospe2_CID, y[,c("Primary.Source","conceptId.2","conceptId.3","Variable.Name","Variable.Label","conceptId.4","Current.Format.Value")],by.x="CID",by.y="conceptId.3",all.x=TRUE)

biospe2_CID_dd <- biospe2_CID_dd %>% mutate(category = case_when(conceptId.4 == 104430631~1,
                                                               !is.na(conceptId.4) & conceptId.4 !=104430631 ~ 2,
                                                               is.na(conceptId.4) ~0),
                                          firstCID = sapply(strsplit(variable,"_"),"[",2),
                                          label.1st = case_when(sapply(strsplit(variable,"_"),"[",2) == "973670172"  ~ "UrineTube1",
                                                                sapply(strsplit(variable,"_"),"[",2) == "143615646"  ~ "MWTube1",
                                                                sapply(strsplit(variable,"_"),"[",2) == "299553921"  ~ "SSTube1",
                                                                sapply(strsplit(variable,"_"),"[",2) == "703954371"  ~ "SSTube2",
                                                                sapply(strsplit(variable,"_"),"[",2) == "454453939"  ~ "EDTATube1",
                                                                sapply(strsplit(variable,"_"),"[",2) == "838567176"  ~ "HeparinTube1",
                                                                sapply(strsplit(variable,"_"),"[",2) == "652357376"  ~ "ACDTube1",
                                                                sapply(strsplit(variable,"_"),"[",2) == "677469051"  ~ "EDTATube2",
                                                                sapply(strsplit(variable,"_"),"[",2) == "683613884"  ~ "EDTATube3",
                                                                sapply(strsplit(variable,"_"),"[",2) == "376960806"  ~ "SSTube3",
                                                                sapply(strsplit(variable,"_"),"[",2) == "232343615"  ~ "SSTube4",
                                                                sapply(strsplit(variable,"_"),"[",2) == "589588440"  ~ "SSTube5",
                                                                sapply(strsplit(variable,"_"),"[",2) == "958646668"  ~ "HeparinTube2",
                                                                sapply(strsplit(variable,"_"),"[",2) == "223999569"  ~ "BiohazardMW",
                                                                sapply(strsplit(variable,"_"),"[",2) == "787237543"  ~ "BiohazardBIU" ))

biospe2_CID_dd$new.varname <- ifelse(is.na(biospe2_CID_dd$label.1st), biospe2_CID_dd$Variable.Name,paste(biospe2_CID_dd$label.1st,biospe2_CID_dd$Variable.Name,sep="_"))
biospe2_CID_dd$variable[is.na(biospe2_CID_dd$new.varname)]
#"d_611091485" "Connect_ID"  "date"        "id"          "Site"        "siteAcronym" "token"
biospe1 <- NULL
select0 <- biospe2_CID_dd$variable[which(biospe2_CID_dd$category==0 & !is.na(biospe2_CID_dd$Variable.Name))]
select2 <- biospe2_CID_dd$variable[which(biospe2_CID_dd$category==2)]
yes_no <- biospe2_CID_dd$variable[which(biospe2_CID_dd$category==1)]
biospe1 <- subset(biospe2,select =c("Connect_ID","token","siteAcronym","date",select0,select2))
n<- length(select0)
colnames(biospe1)[which(colnames(biospe1) %in% select0)] <-  biospe2_CID_dd$new.varname[which(biospe2_CID_dd$category==0 & !is.na(biospe2_CID_dd$Variable.Name))]


for (i in 1: length(select2)){
  eval(parse(text=paste("biospe1$",select2[i],"<-factor_cid(biospe1$",select2[i],")",sep="")))
}
colnames(biospe1)[which(colnames(biospe1) %in% select2)] <-  biospe2_CID_dd$new.varname[which(biospe2_CID_dd$category==2)]

for (i in 1:length(yes_no)){
  x <- yes_no[i]

  varname <- biospe2_CID_dd[grepl(yes_no[i],biospe2_CID_dd$variable),]$new.varname
  #type.labels <- dd$`Variable Label`[grepl(CID,dd$CID)]
  check <- as.data.frame(biospe2[,x])
  check$variable <- ifelse(check[,1]== 353358909, "Yes",ifelse(check[,1]==104430631,"No",NA))
  colnames(check)[2] <- varname
  biospe1 <-   cbind(biospe1,subset(check,select=varname))
}

colnames(biospe1) <- gsub("Object|Obj","Tube", colnames(biospe1))
colnames(biospe1) <- gsub("BioCol_Dev_v1r0","Deviation",colnames(biospe1))
biospe1 <- biospe1[,order(colnames(biospe1))]
biospe1_final <- biospe1[,c(43,162,42,29,38,35:36,41,30,39,40,22,37,23:28,145:161,31:34,164:219,45:65,104:124,1:21,298:315,66:103,125:143,220:296,144,297,163,44)]

biospe1_fin= subset(biospe1_final, select=-c(BioClin_DBBloodRRL_v1r0, BioClin_DBBloodRRLDt_v1r0, BioClin_DBUrineRRLDt_v1r0))

#write.csv(box_table2,glue("Biospecimen_Coordinating_Table_Two_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")
write.csv(biospe1_fin,glue("Connect_prod_Biospe_Formats_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")















###biospecimen data
recrver_CID <- as.data.frame(sapply((strsplit(colnames(recrver),"d_")),tail,1))
colnames(recrver_CID)[1] <- "CID"
recrver_CID$variable <- names(recr.bio)
recrvar_CID_dd <- merge(recrver_CID, y[,c("Primary.Source","conceptId.2","conceptId.3","Variable.Name","Variable.Label","conceptId.4","Current.Format.Value")],by.x="CID",by.y="conceptId.3",all.x=TRUE)

recrvar_CID_dd <- recrvar_CID_dd %>% mutate(category = case_when(conceptId.4 == 104430631~1,
                                                                 !is.na(conceptId.4) & conceptId.4 !=104430631 ~ 2,
                                                                 is.na(conceptId.4) ~0),
                                            Variable.Name=ifelse(is.na(Variable.Name), variable, Variable.Name))

recrbio1 <- NULL
select0 <- recrvar_CID_dd$variable[which(recrvar_CID_dd$category==0)]
select2 <- recrvar_CID_dd$variable[which(recrvar_CID_dd$category==2)]
yes_no <- recrvar_CID_dd$variable[which(recrvar_CID_dd$category==1)]
recrbio1 <- subset(recr.bio,select =c(select0,select2))
colnames(recrbio1)[which(colnames(recrbio1) %in% select0)] <-  recrvar_CID_dd$Variable.Name[which(recrvar_CID_dd$category==0)]
n<- length(select0)


for (i in 1: length(select2)){
  eval(parse(text=paste("recrbio1$",select2[i],"<-factor_cid(recrbio1$",select2[i],")",sep="")))
  colnames(recrbio1)[n+i] <- recrvar_CID_dd$Variable.Name[grepl(select2[i],recrvar_CID_dd$variable)]
}

for (i in 1:length(yes_no)){
  x <- yes_no[i]
  varname <- recrvar_CID_dd$Variable.Name[grepl(x,recrvar_CID_dd$variable)]
  #type.labels <- dd$`Variable Label`[grepl(CID,dd$CID)]
  check <- as.data.frame(recr.bio[,grepl(x, colnames(recr.bio))])
  check$variable <- ifelse(check[,1]== 353358909, "Yes",ifelse(check[,1]==104430631,"No",NA))
  colnames(check)[2] <- varname
  recrbio1 <-   cbind(recrbio1,subset(check,select=varname))
}

write.csv(recrbio1,glue("Connect_prod_recr_veriBiospe_Formats_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")







## Corrdination Csv file
# recrver1$d_914594314=paste0(str_sub(recrver1$d_914594314,6,7), "/", str_sub(recrver1$d_914594314,9,10), "/", str_sub(recrver1$d_914594314,3,4))
# head(recrver1$d_914594314)


coord= left_join(biospe, recrver1, by="Connect_ID") #%>%   left_join(box1, by="Connect_ID")-- this one doesn't have connect IDs

#coord$BioRec_CollectFinalTime_v1r0 = sort(coord$BioRec_CollectFinalTime_v1r0, decreasing=T)



coord$RcrtV_VerificationTm_V1R0 =paste0(str_sub(coord$d_914594314,6,7), "/", str_sub(coord$d_914594314,9,10), "/", str_sub(coord$d_914594314,3,4))

coord$BioRec_CollectFinalTime_v1r0=paste0(str_sub(coord$d_556788178,6,7), "/", str_sub(coord$d_556788178,9,10), "/", str_sub(coord$d_556788178,3,4))

coord$BioClin_BldOrderPlacdDt_v1r0 = ifelse(!is.na(coord$d_173836415_d_266600170_d_769615780), paste0(str_sub(coord$d_173836415_d_266600170_d_769615780,6,7), "/", str_sub(coord$d_173836415_d_266600170_d_769615780,9,10), "/", str_sub(coord$d_173836415_d_266600170_d_769615780,3,4)), "NA")


SMMet= bq_project_query(project,'SELECT Connect_ID, d_254109640, d_827220437 FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP`
where Connect_ID is not null')
BL_Coll <- bq_table_download(SMMet,bigint = "integer64")
BL_Coll$Connect_ID <- as.numeric(BL_Coll$Connect_ID)

coord_csv= left_join(coord, BL_Coll, by="Connect_ID")


coord_csv = coord_csv %>%  mutate(BioRec_CollectFinal=case_when(d_410912345==353358909 ~ 1,
                                                                is.na(d_410912345)~ 0),
                          BioClin_BldOrderPlaced_v1r0= case_when(d_173836415_d_266600170_d_530173840=="353358909" ~ 1,
                                                TRUE ~ 0),
                          BioSpm_Setting_v1r0= case_when(d_650516960==534621077 ~ "Research",
                                                         d_650516960==664882224 ~ "Clinical",
                                                         d_650516960==103209024 ~"Home"),
                         RcrtES_Site_v1r0=case_when(d_827220437 == 531629870 ~ "HealthPartners", 
                                                    d_827220437 == 548392715 ~"Henry Ford Health System",
                                                    d_827220437 == 303349821 ~ "Marshfield Clinic Health System",
                                                    d_827220437 == 657167265 ~ "Sanford Health", 
                                                    d_827220437 == 809703864 ~ "University of Chicago Medicine",
                                                    d_827220437 == 125001209 ~ "Kaiser Permanente Colorado",
                                                    d_827220437 == 327912200 ~ "Kaiser Permanente Georgia",
                                                    d_827220437 == 300267574 ~ "Kaiser Permanente Hawaii",
                                                    d_827220437 == 452412599 ~ "Kaiser Permanente Northwest",
                                                    d_827220437 == 517700004 ~ "National Cancer Institute",
                                                    d_827220437 == 517700004 ~ "National Cancer Institute",
                                                    d_827220437 == 181769837 ~"Other"),
                         BioSpm_Location_v1r0=case_when(d_951355211==706927479 ~ "HFH Livonia Research Clinic",
                                                        d_951355211==736183094 ~ "HFH K-13 Research Clinic",
                                                        d_951355211==886364332 ~ "HFH Cancer Pavilion Research Clinic",
                                                        d_951355211==777644826 ~ "UC-DCAM",
                                                        d_951355211==145191545 ~ "Ingalls Harvey",
                                                        d_951355211==489380324 ~ "River East",
                                                        d_951355211==120264574 ~ "South Loop",
                                                        d_951355211==692275326 ~ "Marshfield",
                                                        d_951355211==813701399 ~ "Weston",
                                                        d_951355211==834825425 ~ "HP Research Clinic",
                                                        d_951355211==589224449 ~ "Sioux Falls Imagenetics",
                                                        d_951355211==691714762 ~ "Rice Lake",
                                                        d_951355211==487512085 ~ "Wisconsin Rapids",
                                                        d_951355211==983848564 ~ "Colby Abbotsford",
                                                        d_951355211==261931804 ~ "Minocqua",
                                                        d_951355211==665277300 ~ " Merrill",
                                                        d_951355211==467088902 ~ "Fargo South University",
                                                        d_951355211==807835037 ~ "Other",
                                                        d_951355211==698283667 ~ "Lake Hallie"),
                         SMMet_BLSamplesColl_v1r0=case_when(d_254109640=="353358909" ~ 1,
                                                                    TRUE ~ 0),
                         BioFin_BaseBloodCol_v1r0=case_when(d_878865966==104430631 ~ 0,
                                                            d_878865966==353358909 ~ 1),
                         BioFin_BaseUrineCol_v1r0=case_when(d_167958071==104430631 ~ 0,
                                                            d_167958071==353358909 ~ 1),
                         BioFin_BaseMouthCol_v1r0=case_when(d_684635302==104430631 ~ 0,
                                                            d_684635302==353358909 ~ 1))

coord_csv = coord_csv %>%  mutate(Partial_Blood_Coll_Research=case_when((d_650516960==534621077 & # & BioSpm_Visit_v1r0=="Baseline") --- already all baseline
                                                               # (SSTube1_BioCol_TubeCollected_v1r0=="Yes" | SSTube2_BioCol_TubeCollected_v1r0=="Yes" |
                                                               #    HeparinTube1_BioCol_TubeCollected_v1r0=="Yes" |
                                                               #    EDTATube1_BioCol_TubeCollected_v1r0=="Yes" |
                                                               #    ACDTube1_BioCol_TubeCollected_v1r0=="Yes" & !(SSTube1_BioCol_TubeCollected_v1r0=="Yes" &
                                                               #     SSTube2_BioCol_TubeCollected_v1r0=="Yes" &
                                                               #    HeparinTube1_BioCol_TubeCollected_v1r0=="Yes" &
                                                               #      EDTATube1_BioCol_TubeCollected_v1r0=="Yes" &
                                                               #    ACDTube1_BioCol_TubeCollected_v1r0=="Yes")) &
                                                                 BioFin_BaseBloodCol_v1r0==1)  ~ 1,
                                                               TRUE ~0),
                         No_Blood_Coll_Research=case_when((d_650516960==534621077 & BioRec_CollectFinal==1 &
                                                            BioFin_BaseBloodCol_v1r0==0) ~ 1,
                                                          TRUE~0),
                         BioClin_BldOrderPlaced= case_when((d_650516960==664882224 & BioClin_BldOrderPlaced_v1r0==1) ~ 1,
                                                                     TRUE ~ 0),
                         All_Blood_Coll_Research= case_when((d_299553921_d_593843561==353358909 & d_703954371_d_593843561==353358909 & d_376960806_d_593843561==353358909 &
                                                            d_838567176_d_593843561==353358909 & d_454453939_d_593843561==353358909 & d_652357376_d_593843561)~ 1, 
                                                            TRUE ~0))


#View(coord_csv)
dim(coord_csv)
#coordn_csv$Partial_Blood_Coll_Research= coordn_csv %>%  filter(BioSpm_Setting_v1r0=="Research" & BioFin_BaseBloodCol_v1r0=="No blood collected")
coordination=coord_csv %>%  select(RcrtV_VerificationTm_V1R0, BioRec_CollectFinalTime_v1r0, BioClin_BldOrderPlacdDt_v1r0, BioSpm_Setting_v1r0, RcrtES_Site_v1r0, BioSpm_Location_v1r0, BioRec_CollectFinal, SMMet_BLSamplesColl_v1r0, Partial_Blood_Coll_Research, No_Blood_Coll_Research,All_Blood_Coll_Research, BioClin_BldOrderPlaced, BioFin_BaseBloodCol_v1r0, BioFin_BaseUrineCol_v1r0, BioFin_BaseMouthCol_v1r0)
#coordination=coord_csv[, c(7, 8, 36,11, 387, 389, 390, 391, 392)]
#View(coordination)

write.csv(coordination,glue("Biospecimen_Coordinating_Table_One_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")





## Separate table for the two boxes column; can't merge them with participants or biospec, they have no common columns



box_table2= box1 %>%  select(BioShip_ShipTime_v1r0, BioPack_TrackScan1_v1r0, BioShip_LogSite_v1r0, BioShip_LocalID_v1r0, BioPack_ShipCondtion_v1r0, BioShip_ShipSubmit_v1r0, BioBPTL_ShipRec_v1r0, bagID)
box_table2 <- box_table2 %>%  mutate(Boxes_shipped= case_when((BioShip_ShipSubmit_v1r0=="Yes" & BioBPTL_ShipRec_v1r0=="Yes")~1,
                                                          TRUE ~ 0),
                                 Boxes_Recvd_in_Good_Condition= case_when((BioPack_ShipCondtion_v1r0=="Package in good condition"& BioBPTL_ShipRec_v1r0=="Yes")~1,
                                                                          TRUE~0),
                                 BioCol_0008_Assigned=case_when(str_sub(box1$bagID,11,14)=="0008" ~ 1,
                                                                    TRUE ~ 0),
                                 BioCol_0009_Assigned=case_when(str_sub(box1$bagID,11,14)=="0009" ~ 1,
                                                                    TRUE ~ 0),
                                 BioSpm_Setting_v1r0= case_when(str_sub(box1$BioShip_LocalID_v1r0,1,2)=="KP" ~ "Clinical",
                                                                TRUE ~ "Research"))
box_table2$BioShip_ShipTime_v1r0=paste0(str_sub(box_table2$BioShip_ShipTime_v1r0,6,7), "/", str_sub(box_table2$BioShip_ShipTime_v1r0,9,10), "/", str_sub(box_table2$BioShip_ShipTime_v1r0,3,4))
box_table2$BioPack_TrackScan1_v1r0 <- as.numeric(box_table2$BioPack_TrackScan1_v1r0)

box_table2 <- box_table2[!duplicated(box_table2$BioPack_TrackScan1_v1r0), ]
#box_table2$BioPack_TrackScan1_v1r0 <- unique(box_table2$BioPack_TrackScan1_v1r0)

#coordination2 <- coordination2[c(1:5), c(23:24)]
box_table2 <- box_table2 %>%  select(BioShip_ShipTime_v1r0, BioPack_TrackScan1_v1r0, BioSpm_Setting_v1r0, BioShip_LogSite_v1r0, BioShip_LocalID_v1r0, Boxes_Recvd_in_Good_Condition, BioCol_0008_Assigned, BioCol_0009_Assigned)  %>%  group_by(BioShip_LocalID_v1r0)
#View(box_table2)

write.csv(box_table2,glue("Biospecimen_Coordinating_Table_Two_{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")



```