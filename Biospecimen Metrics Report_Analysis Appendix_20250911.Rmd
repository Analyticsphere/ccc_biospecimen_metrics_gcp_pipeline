---
title: "Biospecimen Weekly Metrics RMD"
author: "Kelsey Sanchez"
date: "Data Extracted and Report Ran: `r Sys.Date()`"
header-includes: 
  - \usepackage[labelformat=empty]{caption}
  - \usepackage{placeins}
  - \usepackage{booktabs}
  - \usepackage{pdflscape}
  - \usepackage{longtable}

output:
  pdf_document:
    latex_engine: xelatex
    extra_dependencies: ["float", "longtable", "booktabs"]
toc: true
keep_tex: yes
fig_width: 7
fig_height: 5
fig_caption: true
df_print: paged
---
  
  
  
  This Weekly Metrics report contains tables and plots for the Connect Biospecimen samples, many stratified
by health provider site. This information pertains to verified participants as of the date above and collections
that are finalized. This report does not include information from participants whose data have been destroyed. This report is limited to information from participants' first finalized specimen collection. In the event that a participant donated specimen(s) in a repeat collection, that information is not reflected in this report.

\textbf{\textcolor{blue}{Do not share any data from this report that indicate the number of individuals at any of the Connect recruitment sites with individuals outside of the Connect Study.  This includes in manuscripts, abstracts, presentations, etc. You may present data aggregated across all of the Connect sites.}}.
  
```{r setup,eval=TRUE,include=FALSE,echo=FALSE, warning=FALSE}

# Load Libraries


## Can check if any libraries need to be updated if getting odd error messages
#old.packages()
#update.packages()  

# NOTE: (Autumn Hullings 8/26/2025) - I separated the library chunk from the billing to be able to run libraries separately when code failed below due to package overwrite issues:
library(bigrquery)
library(tidyverse) ###for data management
library(reshape2)  # need for the melt() function
library(listr) ###to work on a list of vector, files or..
library(lubridate) ###date time
library(ggplot2) ###plots
library(tinytex) #for pdf
library(janitor) #need for adorn_totals() function
library(gmodels) #needed for custom n_pct_table function- Crosstable() function 
library(gtsummary)
library(kableExtra)
library(gt)
library(rio)
library(scales) #for commas in the thousands place to be applied automatically
```


```{r setup2,eval=TRUE,include=FALSE,echo=FALSE, warning=FALSE}
currentDate <- Sys.Date()
currentDate <- as.Date(currentDate)

bq_auth()

# ### Set Box folders for output CSV files 
# use_test_box_folder <- TRUE # Local user sets this (Jake or Kelsey)
# 
# # Over-ride if using plumber api on GCP (USER DOESN'T TOUCH THIS!)
# # Check if the environment variable exists and is not empty
# if (!is.null(Sys.getenv("USE_TEST_BOX_FOLDER")) &&
#     Sys.getenv("USE_TEST_BOX_FOLDER") != "") {
#   use_test_box_folder <- as.logical(Sys.getenv("USE_TEST_BOX_FOLDER"))
# }
# 
# if (use_test_box_folder) {
#   boxfolder <- 222593912729 # test box folder
# } else {
#   boxfolder <- 221280601453 # destination of CSV files (not pdf)
# }

```

```{r BQPull, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

## Import data to R

project <- "nih-nci-dceg-connect-prod-6d04"

bio_tb <- bq_project_query(project, 
                           query='SELECT * FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.biospecimen` where d_410912345 is not null and Connect_ID is not null')  
biospe <- bq_table_download(bio_tb,bigint="integer64",n_max = Inf, page_size = 1000)
cnames <- names(biospe)


numbers_only <- function(x) !grepl("\\D", x)

for (i in 1: length(cnames)){
  varname <- cnames[i]
  var<-pull(biospe,varname)
  biospe[,cnames[i]] <- ifelse(numbers_only(var), as.numeric(as.character(var)), var)
}

########### Pull in DD to be able to grab only variables with key words from the participants table #############################

##to select biospecimen data in recruitment 
recr_var <- bq_project_query(project, query="SELECT * FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect`.INFORMATION_SCHEMA.COLUMN_FIELD_PATHS WHERE table_name='participants'")
recrvar <- bigrquery::bq_table_download(recr_var, bigint="integer64",n_max = Inf, page_size = 10000)
urlfile<- "https://raw.githubusercontent.com/episphere/conceptGithubActions/master/csv/masterFile.csv" ###to grab the updated dd from github 
y <- read.csv(urlfile)
recrvar_nd <- recrvar[which(grepl("d_",recrvar$column_name)),c("column_name","field_path")]

recrvar_nd$last.CID <- ifelse(grepl("d_",recrvar_nd$column_name),substring(sapply(strsplit(recrvar_nd$column_name,"d_"),tail,1),1,9),NA)
recrvar_nd_label <- base::merge(recrvar_nd, y[,c("Primary.Source","conceptId.2","conceptId.3","Variable.Label","conceptId.4","Current.Format.Value")],by.x="last.CID",by.y="conceptId.3",all.x=TRUE)


recrvar.bio <- recrvar_nd_label[which(recrvar_nd_label$Primary.Source =="Biospecimen" | grepl("biospecimen|blood|urine|mouthwash|collection|Blood|Urine|Mouthwash|MW|Ur|Ur Surv|MW Surv",recrvar_nd_label$Variable.Label)),] 
query <- unique(recrvar.bio$column_name)
select <- paste(recrvar.bio$column_name,collapse=",")

tb_bq <- eval(parse(text=paste("bq_project_query(project, query=\"SELECT token,Connect_ID,d_512820379,d_821247024,d_914594314,d_827220437,d_699625233, d_265193023, d_822499427, 
                               d_222161762, state_d_667474224, state_d_934298480, state_d_684926335, state_d_849518448, state_d_119643471, state_d_253532712, state_d_435027713,
                               state_d_706256705, d_173836415_d_266600170_d_319972665_d_661940160, d_173836415_d_266600170_d_319972665_d_687158491,",
                               select,
                               "FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants` Where Connect_ID is not null and d_821247024 = '197316935' and 
                               d_831041022 = '104430631'\")",
                               sep=" ")))
#removed "date", as it is no longer in the participants table

recrver1 <- bigrquery::bq_table_download(tb_bq,bigint="integer64",n_max = Inf, page_size = 1000)

#############################################################

recrver1 <- recrver1 %>%
  mutate(
    d_827220437 = dplyr::recode(d_827220437,
                         `472940358` = "Baylor Scott and White Health",
                         `531629870` = "HealthPartners",
                         `548392715` = "Henry Ford Health",
                         `303349821` = "Marshfield Clinic Health System",
                         `657167265` = "Sanford Health",
                         `809703864` = "University of Chicago Medicine",
                         `125001209` = "Kaiser Permanente Colorado",
                         `327912200` = "Kaiser Permanente Georgia",
                         `300267574` = "Kaiser Permanente Hawaii",
                         `452412599` = "Kaiser Permanente Northwest"),
    
    d_878865966 = dplyr::recode(d_878865966,
                         `353358909` = "Any blood collected",
                         `104430631` = "No blood collected"),
    
    d_684635302 = dplyr::recode(d_684635302,
                         `353358909` = "Any mouthwash collected",
                         `104430631` = "No mouthwash collected"),
    
    d_167958071 = dplyr::recode(d_167958071,
                         `353358909` = "Any urine collected",
                         `104430631` = "No urine collected"),
    
    d_173836415_d_266600170_d_530173840 = dplyr::recode(d_173836415_d_266600170_d_530173840,
                                                 `104430631` = "No",
                                                 `353358909` = "Yes"),
    
    d_173836415_d_266600170_d_592099155 = dplyr::recode(d_173836415_d_266600170_d_592099155,
                                                 `534621077` = "Research",
                                                 `664882224` = "Clinical",
                                                 `103209024` = "Home"),
    
    d_173836415_d_266600170_d_718172863 = dplyr::recode(d_173836415_d_266600170_d_718172863,
                                                 `534621077` = "Research",
                                                 `664882224` = "Clinical",
                                                 `103209024` = "Home"),
    
    d_173836415_d_266600170_d_915179629 = dplyr::recode(d_173836415_d_266600170_d_915179629,
                                                 `534621077` = "Research",
                                                 `664882224` = "Clinical",
                                                 `103209024` = "Home"),
    
    d_265193023 = dplyr::recode(d_265193023,
                         `972455046` = "Not Started",
                         `615768760` = "Started",
                         `231311385` = "Submitted")
  )


###to convert to categorical variables
recrver1$BioFin_BaseMWCol_v1r0  <-factor(recrver1$d_684635302,exclude=NULL)
recrver1$BioFin_BaseBloodCol_v1r0 <- factor(recrver1$d_878865966,levels=c("Any blood collected","No blood collected"))
recrver1$BioFin_BaseUrineCol_v1r0 <- factor(recrver1$d_167958071,exclude=NULL)
recrver1$BioClin_BldOrderPlaced_v1r0 <- factor(recrver1$d_173836415_d_266600170_d_530173840,exclude=NULL) 




recrver1$BL_BioSpm_MWSetting_v1r0 <- factor(recrver1$d_173836415_d_266600170_d_915179629,levels=c("Clinical","Research","Home"))  
recrver1$BL_BioSpm_UrineSetting_v1r0 <- factor(recrver1$d_173836415_d_266600170_d_718172863, levels=c("Clinical","Research","Home"))  
recrver1$BL_BioSpm_BloodSetting_v1r0 <- factor(recrver1$d_173836415_d_266600170_d_592099155,levels=c("Clinical","Research","Home"))  


recrver1$Site <-factor(recrver1$d_827220437,levels=c("Baylor Scott and White Health","HealthPartners", "Henry Ford Health",
                                                     "Marshfield Clinic Health System",
                                                     "Sanford Health", "University of Chicago Medicine","Kaiser Permanente Colorado",
                                                     "Kaiser Permanente Georgia","Kaiser Permanente Hawaii","Kaiser Permanente Northwest"))



```


```{r Functions, include=FALSE}


n_pct_table <- function(x,y){
  ctable<- CrossTable(x,y)
  count <- as.data.frame.matrix(ctable$t)
  perc <- as.data.frame.matrix(ctable$prop.col)
  n<- as.numeric(length(levels(x)))
  m <- as.numeric(length(levels(y)))
  tb_combo <- array(pct_n(ctable$t,ctable$prop.col),dim=c(n,m)) 
  tb_combo <- as.data.frame(tb_combo)
  colnames(tb_combo) <- colnames(count)
  
  total <- sum(count)
  count$Total <- apply(count,1,sum)
  tb_combo$Total <- paste0(count$Total, "( ", round(100*(count$Total)/total,1), " %)")
  
  tb_combo$Site <- rownames(count)
  tb_combo[(n+1),c(1:(m+1))] <- as.character(apply(count,2,sum))
  tb_combo$Site[is.na(tb_combo$Site)] <- replace_na("Total")  
  return(tb_combo)
}


# Function to convert counts (N) to counts and percentage (N (%))
pct_n <- function(x,y){ paste0(x,"( ", round(100*y,2), " %)")}


# Function to create a crosstable
create_tbl_cross <- function(data, row_var, colm_var, row_or_col_pct, row_name, column_name){
cross__table <- data %>%  
  tbl_cross(
    row = !!sym(row_var),
    col = !!sym(colm_var),
    digits=c(0,1),
    percent = row_or_col_pct,
    label=list(!!sym(row_var) ~ row_name,
               !!sym(colm_var) ~ column_name),
    missing="ifany",
    margin_text="Total") 

#Ops doesn't like the grouped by variables on a different line the column labels
cross_table_df <- as.data.frame(cross__table)[-1, ]
  
}

# Function to create a cross table
### Same function as above, but this strips the percentages out of the total column 
create_tbl_cross2 <- function(data, row_var, colm_var, row_or_col_pct, row_name, column_name, margin_text) {
cross__table <- data %>%  
  tbl_cross(
    row = !!sym(row_var),
    col = !!sym(colm_var),
    digits=c(0,1),
    percent = row_or_col_pct,
    label=list(!!sym(row_var) ~ row_name,
               !!sym(colm_var) ~ column_name),
    missing="ifany",
    margin_text="Total") 

cross__table[["table_body"]]$stat_0 <- sapply(strsplit(cross__table[["table_body"]]$stat_0, " "), "[", 1)

#Ops doesn't like the grouped by variables on a different line the column labels
cross_table_df <- as.data.frame(cross__table)[-1, ]
  
}




# Function to add total row, total column, and calculate row/column percentages
add_totals_and_percentages <- function(df, total_position = c("row", "col", "both"), 
                                       percentage_type = c("row", "col")) {
  
  # Ensure the 'total_position' and 'percentage_type' are valid options
  total_position <- match.arg(total_position)
  percentage_type <- match.arg(percentage_type)
  
  # Add totals (row, column, or both)
  if (total_position == "row" || total_position == "both") {
    df <- df %>%
      adorn_totals("row")  # Add total row
  }
  
  if (total_position == "col" || total_position == "both") {
    df <- df %>%
      adorn_totals("col")  # Add total column
  }
  
  # Save counts separately to combine with percentages
  counts <- df
  
  # Calculate percentages (row or column)
  df <- df %>%
    adorn_percentages(percentage_type) %>%
    adorn_pct_formatting(digits = 1)
  
  # Combine counts and percentages in the desired format: "count (percentage)"
  df <- counts %>%
    mutate(across(-1, ~ paste0(comma(.x), " (", df[[cur_column()]], ")")))
  
  return(df)
}



#add one decimal place, even .0 for whole numbers
format_with_decimal <- function(x, digits = 1) {
  formatted_number <- sprintf("%0.1f", x)
  return(formatted_number)
}


###################



#allows gt tables to go onto a second page if it gets too long
gt::gt_latex_dependencies()


```




```{r Removing_Duplicates, include=FALSE}

# Ops no longer wants duplicate collections in this report
## REMOVING DUPLICATES: Method- take the first collection only for blood and urine. (If there's multiple collections we take the earliest)
##### NOTE: Home MW collections are separate collections BUT they are not finalized, so they will not be removed from the dataframe 
  ## confirmed that duplicate HMW collections don't mess up these counts and are handled in the kit section 

## Clinical blood/urine and Research blood/urine/mouthwash samples have a collection ID starting with CXA. Home MW start with CHA


# Step 1: Find the duplicate rows
actual_dups <- biospe %>%
  filter(!is.na(d_556788178)) %>%
  group_by(Connect_ID) %>%
  filter(n() > 1)

# Step2: Of the duplicate rows, keep the one with the first collection time stamp
rows_to_keep <- actual_dups %>%
  group_by(Connect_ID) %>%
  filter(d_556788178 == min(d_556788178, na.rm = TRUE)) %>%
  ungroup()


# Take all duplicate rows out of the original dataframe
non_duplicate_rows <- biospe %>%
    anti_join(actual_dups, by = c("Connect_ID", "d_556788178"))  # Ensure all columns are included

# Combine new overall dataframe with those duplicate rows we filtered with the earlier time stamp
no_dups <- bind_rows(rows_to_keep, non_duplicate_rows)


```

```{r Labeling2, include=FALSE}


no_dups <- no_dups %>%
  mutate(Site = case_when(d_827220437 == 472940358 ~ "Baylor Scott and White Health",
                          d_827220437 == 531629870 ~ "HealthPartners",
                          d_827220437 == 548392715 ~ "Henry Ford Health",
                          d_827220437 == 303349821 ~ "Marshfield Clinic Health System",
                          d_827220437 == 657167265 ~ "Sanford Health",
                          d_827220437 == 809703864 ~ "University of Chicago Medicine",
                          d_827220437 == 125001209 ~ "Kaiser Permanente Colorado",
                          d_827220437 == 327912200 ~ "Kaiser Permanente Georgia",
                          d_827220437 == 300267574 ~ "Kaiser Permanente Hawaii",
                          d_827220437 == 452412599 ~ "Kaiser Permanente Northwest"),
         Site = factor(Site,levels = c("Baylor Scott and White Health",  "HealthPartners",  "Henry Ford Health",
                                       "Marshfield Clinic Health System", "Sanford Health",  "University of Chicago Medicine",
                                       "Kaiser Permanente Colorado", "Kaiser Permanente Georgia", "Kaiser Permanente Hawaii", "Kaiser Permanente Northwest")))


## Research locations use d_951355211 (BioSpm_Location_v1r0) for Site location. These locations should all be in the DD as well

no_dups <- no_dups %>% 
  mutate(
    Site_location = case_when(
      #UC
      d_951355211 == 777644826 ~ "UC-DCAM",
      d_951355211 == 145191545 ~ "Ingalls Harvey",
      d_951355211 == 489380324 ~ "River East",
      d_951355211 == 120264574 ~ "South Loop",
      d_951355211 == 319518299 ~ "UCM Pop-Up",
      d_951355211 == 940329442 ~ "Orland Park",
      #HP
      d_951355211 == 834825425 ~ "HP Research Clinic",
      d_951355211 == 574368418 ~ "HP Park Nicollet",
      #HFH
      d_951355211 == 736183094 ~ "HFH K-13 Research Clinic",
      d_951355211 == 886364332 ~ "HFH Cancer Pavilion Research Clinic",
      d_951355211 == 706927479 ~ "HFH Livonia Research Clinic",
      d_951355211 == 322059622 ~ "HFH Pop-Up",
      d_951355211 == 911683679 ~ "HFH Detroit Northwest",
      d_951355211 == 852689772 ~ "In-home Collection",
      d_951355211 == 755034888 ~ "HFH Jackson",
      #MF
      d_951355211 == 692275326 ~ "Marshfield",
      d_951355211 == 813701399 ~ "Weston",
      d_951355211 == 698283667 ~ "Lake Hallie",
      d_951355211 == 691714762 ~ "Rice Lake",
      d_951355211 == 487512085 ~ "Wisconsin Rapids",
      d_951355211 == 983848564 ~ "Colby Abbotsford",
      d_951355211 == 261931804 ~ "Minocqua",
      d_951355211 == 665277300 ~ "Merrill",
      d_951355211 == 567969985 ~ "MF Pop-Up",
      d_951355211 == 255636184 ~ "Stevens Point",
      d_951355211 == 813412950 ~ "Neillsville",
      #BSWH
      d_951355211 == 723351427 ~ "BCC- HWC",
      d_951355211 == 807443231 ~ "FW All Saints",
      d_951355211 == 475614532 ~ "BCC- Plano",
      d_951355211 == 809370237 ~ "BCC- Worth St",
      d_951355211 == 856158129 ~ "BCC- Irving",
      d_951355211 == 397883980 ~ "Irving",
      d_951355211 == 436956777 ~ "NTX Biorepository",
      d_951355211 == 288564244 ~ "BCC- Fort Worth",
      d_951355211 == 483909879 ~ "North Garland",
      d_951355211 == 117840593 ~ "Temple CDM",
      d_951355211 == 574104518 ~ "Temple Roney",
      d_951355211 == 962830330 ~ "Waco - MacArthur",
      #d_951355211 ==  749199085 ~ "Temple Westfield"
      #SF
      d_951355211 == 769594361 ~ "Fargo Amber Valley",
      d_951355211 == 589224449 ~ "Sioux Falls Imagenetics",
      d_951355211 == 467088902 ~ "Fargo South University",
      d_951355211 == 246137578 ~ "Edith Sanford Breast Center (coded as Sanford Center)",
      d_951355211 == 433070901 ~ "Edith Sanford Breast Center",
      #Missing
      Site=='University of Chicago Medicine' ~ "Missing UC location",
      Site=='HealthPartners' ~ "Missing HP location",
      Site=='Marshfield Clinic Health System' ~ "Missing MF location",
      Site=='Sanford Health' ~ "Missing SF location",
      Site=='Henry Ford Health' ~ "Missing HFH location",
      Site=='Baylor Scott and White Health' ~ "Missing BSWH location",
      is.na(d_951355211) ~ "Unidentified location"
    )
  )



## Clinical locations use d_173836415_d_266600170_d_185243482 (BioClin_SiteBldLocBL_v1r0) and d_173836415_d_266600170_d_452847912 (BioClin_SiteUrLocatBL_v1r0) for Site location. 
# These locations will not be in the DD. We get these from the Sites directly and this is considered the running list.
# Sanford has a LONG list of hundreds of clinical sites, and those sites are saved in the csv file 'Sanford_Clinical_Locations.csv' in this repository.

recrver1 <- recrver1 %>%  mutate(Clin_Site_location=case_when(
  Site=="HealthPartners" & (d_173836415_d_266600170_d_185243482 == 1 | d_173836415_d_266600170_d_452847912 == 1) ~ "NSC",
  Site=="HealthPartners" & (d_173836415_d_266600170_d_185243482 == 2 | d_173836415_d_266600170_d_452847912 == 2) ~ "Elk River",
  Site=="HealthPartners" & (d_173836415_d_266600170_d_185243482 == 3 | d_173836415_d_266600170_d_452847912 == 3) ~ "Chanhassen",
  Site=="HealthPartners" & (d_173836415_d_266600170_d_185243482 == 4 | d_173836415_d_266600170_d_452847912 == 4) ~ "Park Nicollet Minneapolis Clinic",
  Site=="HealthPartners" & (d_173836415_d_266600170_d_185243482 == 6 | d_173836415_d_266600170_d_452847912 == 6) ~ "Brooklyn Center",
  Site=="HealthPartners" & (d_173836415_d_266600170_d_185243482 == 7 | d_173836415_d_266600170_d_452847912 == 7) ~ "Clinic Stillwater",
  Site=="HealthPartners" & (d_173836415_d_266600170_d_185243482 == 8 | d_173836415_d_266600170_d_452847912 == 8) ~ "New Richmond Clinic",
  d_173836415_d_266600170_d_185243482 == 1050010095 | d_173836415_d_266600170_d_452847912 == 1050010095 |
    d_173836415_d_266600170_d_185243482 == 1050010034 | d_173836415_d_266600170_d_452847912 == 1050010034 ~ "Wyandotte",
  d_173836415_d_266600170_d_185243482 == 1060010063 |
    d_173836415_d_266600170_d_185243482 == 1060170018 |
    d_173836415_d_266600170_d_452847912 == 1060010063 |
    d_173836415_d_266600170_d_452847912 == 1060170018 ~ "Macomb",
  d_173836415_d_266600170_d_185243482 == 1040010047 |
    d_173836415_d_266600170_d_185243482 == 1040010046 |
    d_173836415_d_266600170_d_185243482 == 1011220006 |
    d_173836415_d_266600170_d_452847912 == 1040010047 |
    d_173836415_d_266600170_d_452847912 == 1040010046 |
    d_173836415_d_266600170_d_452847912 == 1011220006 ~ "West Bloomfield",
  d_173836415_d_266600170_d_185243482 == 1011410008 |
    d_173836415_d_266600170_d_452847912 == 1011410008 ~ "Royal Oak",
  d_173836415_d_266600170_d_185243482 == 1010180040 |
    d_173836415_d_266600170_d_452847912 == 1010180040 ~ "Fairlane (Dearborn)",
  d_173836415_d_266600170_d_185243482 == 1010120026 |
    d_173836415_d_266600170_d_452847912 == 1010120026 ~ "Columbus",
  d_173836415_d_266600170_d_185243482 == 1011660013  |
    d_173836415_d_266600170_d_452847912 == 1011660013 ~ "Plymouth",
  d_173836415_d_266600170_d_185243482 == 1010360011 |
    d_173836415_d_266600170_d_452847912 == 1010360011 ~ "Troy",
  d_173836415_d_266600170_d_185243482 == 1010350019 | 
    d_173836415_d_266600170_d_452847912 == 1010350019~ "Taylor",
  d_173836415_d_266600170_d_185243482 == 1010240013 |
    d_173836415_d_266600170_d_452847912 == 1010240013 ~ "Livonia",
  d_173836415_d_266600170_d_185243482 == 1010320019 |
    d_173836415_d_266600170_d_452847912 == 1010320019 ~ "Sterling Heights",
  d_173836415_d_266600170_d_185243482 == 1010010193 |
    d_173836415_d_266600170_d_185243482 == 1010010114 |
    d_173836415_d_266600170_d_452847912 == 1010010193 |
    d_173836415_d_266600170_d_452847912 == 1010010114 ~ "K1 HFH Main",
  d_173836415_d_266600170_d_185243482 == 1010200009 |
    d_173836415_d_266600170_d_452847912 == 1010200009 ~ "Ford Road",
  d_173836415_d_266600170_d_185243482 == 1010270015 |
    d_173836415_d_266600170_d_452847912 == 1010270015 ~ "NCO",
  d_173836415_d_266600170_d_185243482 == 1050020026 | 
    d_173836415_d_266600170_d_452847912 == 1050020026 ~ "Brownstown",
  d_173836415_d_266600170_d_185243482 == 1010170010 | 
    d_173836415_d_266600170_d_452847912 == 1010170010 ~ "E Jefferson Pathology",
  d_173836415_d_266600170_d_185243482 == 1010380008 | 
    d_173836415_d_266600170_d_452847912 == 1010380008 ~ "Woodhaven Pathology",
  Site=="University of Chicago Medicine" & (d_173836415_d_266600170_d_185243482==1 | d_173836415_d_266600170_d_452847912==1) ~ "South Loop",
  Site=="University of Chicago Medicine" & (d_173836415_d_266600170_d_185243482==2 | d_173836415_d_266600170_d_452847912==2) ~ "Orland Park",
  Site=="University of Chicago Medicine" & (d_173836415_d_266600170_d_185243482==3 | d_173836415_d_266600170_d_452847912==3) ~ "Kenwood",
  Site=="University of Chicago Medicine" & (d_173836415_d_266600170_d_185243482==4 | d_173836415_d_266600170_d_452847912==4) ~ "River East",
  Site=="University of Chicago Medicine" & (d_173836415_d_266600170_d_185243482==5 | d_173836415_d_266600170_d_452847912==5) ~ "Dearborn Station",
  Site=="University of Chicago Medicine" & ((d_173836415_d_266600170_d_185243482==6 | d_173836415_d_266600170_d_452847912==6) |
                                              (d_173836415_d_266600170_d_185243482==34 | d_173836415_d_266600170_d_452847912==34)) ~ "Ingalls",
  Site=="University of Chicago Medicine" & ((d_173836415_d_266600170_d_185243482==7 | d_173836415_d_266600170_d_452847912==7) |
                                              (d_173836415_d_266600170_d_185243482==33 | d_173836415_d_266600170_d_452847912==33)) ~ "DCAM (Hyde Park)",
  Site=="University of Chicago Medicine" & (d_173836415_d_266600170_d_185243482==25 | d_173836415_d_266600170_d_452847912==25) ~ "Crown Point",
  d_173836415_d_266600170_d_185243482==22 | d_173836415_d_266600170_d_452847912==22 |
    d_173836415_d_266600170_d_185243482==24 | d_173836415_d_266600170_d_452847912==24 |
    d_173836415_d_266600170_d_185243482==28 | d_173836415_d_266600170_d_452847912==28 |
    d_173836415_d_266600170_d_185243482==33 | d_173836415_d_266600170_d_452847912==33 |
    d_173836415_d_266600170_d_185243482==34 | d_173836415_d_266600170_d_452847912==34 |
    d_173836415_d_266600170_d_185243482==35 | d_173836415_d_266600170_d_452847912==35 |
    d_173836415_d_266600170_d_185243482==38 | d_173836415_d_266600170_d_452847912==38 |
    d_173836415_d_266600170_d_185243482==40 | d_173836415_d_266600170_d_452847912==40 |
    d_173836415_d_266600170_d_185243482==55 | d_173836415_d_266600170_d_452847912==55 |
    d_173836415_d_266600170_d_185243482==71 | d_173836415_d_266600170_d_452847912==71 ~ "Oahu Clinics",
  d_173836415_d_266600170_d_185243482==23 | d_173836415_d_266600170_d_452847912==23 |
    d_173836415_d_266600170_d_185243482==26 | d_173836415_d_266600170_d_452847912==26 |
    d_173836415_d_266600170_d_185243482==27 | d_173836415_d_266600170_d_452847912==27 |
    d_173836415_d_266600170_d_185243482==32 | d_173836415_d_266600170_d_452847912==32 |
    d_173836415_d_266600170_d_185243482==37 | d_173836415_d_266600170_d_452847912==37 |
    d_173836415_d_266600170_d_185243482==49 | d_173836415_d_266600170_d_452847912==49 |
    d_173836415_d_266600170_d_185243482==56 | d_173836415_d_266600170_d_452847912==56 |
    d_173836415_d_266600170_d_185243482==69 | d_173836415_d_266600170_d_452847912==69 |
    d_173836415_d_266600170_d_185243482==74 | d_173836415_d_266600170_d_452847912==74 |
    d_173836415_d_266600170_d_185243482==76 | d_173836415_d_266600170_d_452847912==76 ~ "Non-Oahu Clinics",
  Site=="Kaiser Permanente Hawaii" & is.na(d_173836415_d_266600170_d_185243482) & is.na(d_173836415_d_266600170_d_452847912) ~ "Missing Both Location IDs",
  Site=="Kaiser Permanente Hawaii" ~ "Missing KPHI location",
  d_827220437==327912200 ~ "Kaiser Permanente Georgia",
  d_827220437==452412599 ~ "Kaiser Permanente Northwest",
  d_827220437==125001209 ~ "Kaiser Permanente Colorado",
  d_827220437==657167265 ~ "Sanford Health",
  Site=="HealthPartners" ~ "Missing HP location",
  Site=='Henry Ford Health' ~ "Missing HFH location",
  Site=='University of Chicago Medicine' ~ "Missing UC location",
  TRUE ~ "Unidentified location"),
  BiospeCollection = ifelse((d_878865966 == "Any blood collected" | d_167958071 == "Any urine collected" | 
                               d_684635302 == "Any mouthwash collected" ), "Any biospecimen Collections","No biospecimen collections"),
  age = case_when(state_d_934298480 == "713781738"~ "30-34",
                  state_d_934298480 == '631272782' ~ "35-39",
                  state_d_934298480 == '124276120' ~ "40-45",
                  state_d_934298480 == '450985724' ~ "46-50",
                  state_d_934298480 == '363147933' ~ "51-55",
                  state_d_934298480 == '636706443' ~ "56-60",
                  state_d_934298480 == '771230670' ~ "61-65",
                  state_d_934298480 == '722846087' ~ "66-70"),
  #Must inclide overall site race, HF defined race, SF defined race, and BSWH defined race
  race = case_when(state_d_684926335 == '635279662' |state_d_849518448 == '768826601' | 
                     state_d_119643471 == '635279662' | state_d_253532712=='723775357' ~ "White, Non-Hispanic" , 
                   state_d_684926335 %in% c('232334767', '401335456') |
                     state_d_849518448 == '181769837' |
                     state_d_253532712 %in% c('153444133','572474909','308427446','211228524','277568192','611398522','181769837') |
                     state_d_119643471 %in% c( '232334767', '211228524', '308427446', '432722256', '232663805', '785578696', 
                                               '200929978', '490725843', '965998904') ~ "Other",
                   TRUE ~ "Unknown"),
  sex = case_when(state_d_706256705 == '536341288' | state_d_435027713 == '536341288' ~ "Female",
                  state_d_706256705 == '654207589' | state_d_435027713 == '654207589' ~ "Male",
                  TRUE ~ "Unknown"))


## Overall dataframe of both biospecimen and participants table
recrver1$Connect_ID <- as.numeric(recrver1$Connect_ID)
no_dups$Connect_ID <- as.numeric(no_dups$Connect_ID)
recrver1$Site <- as.character(recrver1$Site)
no_dups$Site <- as.character(no_dups$Site)
biocol.tb <- left_join(recrver1, no_dups, by=c("Connect_ID", "Site"))


##Site is coming out of order somehow
biocol.tb <- biocol.tb %>% 
  mutate(Site = factor(Site,levels = c("Baylor Scott and White Health",  "HealthPartners",  "Henry Ford Health",
                                       "Marshfield Clinic Health System", "Sanford Health",  "University of Chicago Medicine",
                                       "Kaiser Permanente Colorado", "Kaiser Permanente Georgia", "Kaiser Permanente Hawaii", "Kaiser Permanente Northwest")))

```



```{r Tables1.1_1.5, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

## Collections or No collections among ALL participants 
table1 <- biocol.tb %>%
  mutate(biocol.appoint = case_when(BiospeCollection == "Any biospecimen Collections" & d_410912345== 353358909 ~ "Baseline Collection", 
                                    TRUE ~ "No Baseline Collection"))

table1_totals <- create_tbl_cross(table1, "Site", "biocol.appoint", "row", "Site", " ")

biospe.t1 <- knitr::kable(table1_totals, col.names=c("Site", "Baseline Collection","No Baseline Collection", "Total Verified Participants"), 
                          caption='Table 1.1: Baseline Biospecimen Collection Status Among Verified Participants', 
                          row.names=FALSE,align=c("l", rep("c", 3)), booktabs = TRUE) %>%  
  add_indent(seq(1, nrow(table1_totals) - 1)) %>% 
  kable_styling(latex_options = "scale_down")








## All collection setting counts 
### Note HMW collections are never finalized
### Removed all MW sample from Clinical to separate them out into "Home" only category
coll_sett_all <- table1 %>%  filter(BiospeCollection == "Any biospecimen Collections" & (d_410912345== 353358909 | BL_BioSpm_MWSetting_v1r0=="Home")) %>% 
  mutate(all_settings = case_when((d_650516960=="664882224" | BL_BioSpm_BloodSetting_v1r0=="Clinical" | 
                                    BL_BioSpm_UrineSetting_v1r0=="Clinical") ~ "Clinical",
                                  (d_650516960=="534621077" | BL_BioSpm_BloodSetting_v1r0=="Research" | 
                                    BL_BioSpm_UrineSetting_v1r0=="Research" | BL_BioSpm_MWSetting_v1r0=="Research")~ "Research",
                                  (d_650516960=="103209024" | BL_BioSpm_BloodSetting_v1r0=="Home" | 
                                    BL_BioSpm_UrineSetting_v1r0=="Home" | BL_BioSpm_MWSetting_v1r0=="Home") ~ "Home"))

table1_allsett <- create_tbl_cross(coll_sett_all, "Site", "all_settings", "row", "Site", "Collection Setting")  

settings_breakdown <- knitr::kable(table1_allsett, 
                                   caption='Table 1.2 Baseline Biospecimen Collection Setting of First Specimen Collected', 
                                   row.names=FALSE,align=c("l", rep("c", 3)), booktabs = TRUE) %>%  
  add_indent(seq(1, nrow(table1_allsett) - 1)) %>% 
  kable_styling(latex_options = c("scale_down", "hold_position")) %>% 
  footnote(general = "Note: Any collections indicated under 'Home' setting reflect collections in which home mouthwash was the only sample collected.", 
           general_title = "",
         footnote_as_chunk = TRUE, 
         escape = FALSE, 
         threeparttable = TRUE) 




## To be used in all Figures as the X-axis Date
## Weeks are considered Monday-Sunday
coll_sett_all <- coll_sett_all %>%  
  group_by(Connect_ID) %>% 
  mutate(col.Monday.date = floor_date(as.POSIXct(ymd_hms(d_556788178)), unit = "week", week_start = 1)) %>% # week of collection
  ungroup()





## Collection Counts by research location
biospe_R_locations<-coll_sett_all %>% filter(all_settings=="Research") 

biospe_R_locations$biocol.appoint[biospe_R_locations$biocol.appoint=="Baseline Collection"]="Number of Research Collections"


col_num <- table(biospe_R_locations$Site_location, biospe_R_locations$biocol.appoint)

col_num_1.1 <- as.data.frame(col_num)
col_num_1.1 <- col_num_1.1[, c(1,3)]
colnames(col_num_1.1) <- c("Collection Location", "N")
rownames(col_num_1.1) <- col_num_1.1$`Collection Location`


col_num_1.1 <- col_num_1.1 %>%
  mutate(Site_Group = case_when(
    `Collection Location` %in% c("UC-DCAM", "Ingalls Harvey", "River East", "South Loop", "UCM Pop-Up", "Orland Park", "Missing UC location") ~ "University of Chicago Medicine",
    `Collection Location` %in% c("HP Research Clinic",  "HP Park Nicollet", "Missing HP location") ~ "HealthPartners",
    `Collection Location` %in% c("Lake Hallie", "Marshfield", "MF Pop-Up", "Minocqua", "Weston", "Wisconsin Rapids", "Rice Lake", "Colby Abbotsford", "Merrill",
                                 "Stevens Point", "Neillsville", "Missing MF location") ~ "Marshfield Clinic Health System",
    `Collection Location` %in% c("Sioux Falls Imagenetics", "Fargo South University","Edith Sanford Breast Center (coded as Sanford Center)", 
                                  "Edith Sanford Breast Center","Fargo Amber Valley","Missing SF location") ~ "Sanford Health",
    `Collection Location` %in% c("HFH K-13 Research Clinic", "HFH Livonia Research Clinic", "HFH Cancer Pavilion Research Clinic", "HFH Pop-Up", 
                                 "HFH Detroit Northwest","In-home Collection", "HFH Jackson","Missing HFH location") ~ "Henry Ford Health",
    `Collection Location` %in% c("BCC- HWC","FW All Saints","BCC- Plano","BCC- Worth St","BCC- Irving","Irving","NTX Biorepository","BCC- Fort Worth",
                                 "North Garland", "Temple CDM", "Temple Roney", "Waco - MacArthur","Missing BSWH location") ~ "Baylor Scott and White Health",
    TRUE ~ "Other"
  ))


# Grouping Counts by Site

col_num_1.1$`N` <- as.numeric(col_num_1.1$`N`)
col_num_1.1 <- col_num_1.1 %>%
  filter(!is.na(`N`))


total_collections <- col_num_1.1 %>%
  group_by(Site_Group) %>%
  summarize(Total_Collections = sum(`N`, na.rm = TRUE))


col_num_1.1 <- col_num_1.1 %>%
  left_join(total_collections, by = "Site_Group")


col_num_1.1 <- col_num_1.1 %>%
  mutate(Percentage = round((`N` / Total_Collections * 100), digits=1))


total_rows <- col_num_1.1 %>%
  group_by(Site_Group) %>%
  summarize(`Collection Location` = "Total",
            `N` = sum(`N`),
            Percentage = 100) %>%
  ungroup()

col_num_1.1 <- bind_rows(col_num_1.1, total_rows)

col_num_1.1$`Total Research Collections` <- paste0(col_num_1.1$`N`, " (", col_num_1.1$Percentage,"%)")
col_num_1.1 <- col_num_1.1[, c(1,3,6)]

col_num_1.1 <- col_num_1.1 %>%
  mutate(`Collection Location` = paste0("\u00A0\u00A0\u00A0", `Collection Location`)) # need to manually create an indent for site locations under Site header


col_num_1.1_gt <- col_num_1.1 %>% 
  gt::gt(groupname_col = "Site_Group") 


col_num_1.1_gt <- col_num_1.1_gt %>%  
  summary_rows(
  groups = TRUE,
  columns = vars("Total Research Collections"),
  fns = (Sum = ~sum(.))
  ) %>% 
 tab_header("Table 1.3: Baseline Research Biospecimen Collections by Collection Location") %>% 
  tab_options(table.font.size = px(8))








## Collection Counts by clinical location
# Separate so I can use this df in the SF clinical table
table1_clin <-coll_sett_all %>% filter(all_settings=="Clinical") 

table1_2_locs<- table1_clin %>% filter(Site!="Kaiser Permanente Georgia"& Site!= "Kaiser Permanente Northwest"  & 
                                   Site!="Kaiser Permanente Colorado" & Site!="Kaiser Permanente Hawaii" & Site!= "Sanford Health") 


table1_2_locs$biocol.appoint[table1_2_locs$biocol.appoint=="Baseline Collection"]="Number of Clinical Collections"

table1_2_locations <-  table1_2_locs %>% filter(biocol.appoint=="Number of Clinical Collections")


col_num <- table(table1_2_locations$Clin_Site_location, table1_2_locations$biocol.appoint)


col_num_1.2 <- as.data.frame(col_num)
col_num_1.2 <- col_num_1.2[, c(1,3)]
colnames(col_num_1.2) <- c("Collection Location", "N")
rownames(col_num_1.2) <- col_num_1.2$`Collection Location`


col_num_1.2 <- col_num_1.2 %>%
  mutate(Site_Group = case_when(
    `Collection Location` %in% c("Macomb", "West Bloomfield", "Wyandotte","Fairlane (Dearborn)", "Plymouth", "Royal Oak", "Troy", "K1 HFH Main",
                                 "Sterling Heights","Columbus", "Livonia","Taylor", "Ford Road", "NCO","Brownstown", "E Jefferson Pathology", 
                                 "Woodhaven Pathology", "Missing HFH location") ~ "Henry Ford Health", 
    `Collection Location` %in% c("Elk River", "Chanhassen", "Park Nicollet Minneapolis Clinic", "Brooklyn Center", "Clinic Stillwater", "New Richmond Clinic",
                                 "NSC", "Missing HP location") ~ "HealthPartners",   
    `Collection Location` %in% c("South Loop","Orland Park","Kenwood","River East","Dearborn Station", "Ingalls", "DCAM (Hyde Park)", 
                                 "Crown Point", "Missing UC location") ~ "University of Chicago Medicine",
    TRUE ~ "Other"
  ))



# Grouping Counts by Site
col_num_1.2$`N` <- as.numeric(col_num_1.2$`N`)
col_num_1.2 <- col_num_1.2 %>%
  filter(!is.na(`N`))


total_collections <- col_num_1.2 %>%
  group_by(Site_Group) %>%
  summarize(Total_Collections = sum(`N`, na.rm = TRUE))


col_num_1.2 <- col_num_1.2 %>%
  left_join(total_collections, by = "Site_Group")


col_num_1.2 <- col_num_1.2 %>%
  mutate(Percentage = round((`N` / Total_Collections * 100), digits=1))



total_rows <- col_num_1.2 %>%
  group_by(Site_Group) %>%
  summarize(`Collection Location` = "Total",
            `N` = sum(`N`),
            Percentage = 100) %>%
  ungroup()

col_num_1.2 <- bind_rows(col_num_1.2, total_rows)

col_num_1.2$`Total Clinical Collections` <- paste0(col_num_1.2$`N`, " (", col_num_1.2$Percentage,"%)")
col_num_1.2 <- col_num_1.2[, c(1,3,6)]

col_num_1.2 <- col_num_1.2 %>%
  mutate(`Collection Location` = paste0("\u00A0\u00A0\u00A0", `Collection Location`)) #manually adding indent



col_num_1.2_gt <- col_num_1.2 %>%
  gt::gt(groupname_col = "Site_Group") 


col_num_1.2_gt <- col_num_1.2_gt %>%  summary_rows(
  groups = TRUE,
  columns = vars("Total Clinical Collections"),
  fns = (Sum = ~sum(.)),
) %>% tab_header("Table 1.4: Baseline Clinical Biospecimen Collections by Clinic Location") 
  





## Blood counts specifically
table1.5 <- create_tbl_cross(coll_sett_all, 'Site', "BioFin_BaseBloodCol_v1r0", "row", 'Site', " ")


biospe.bld <- knitr::kable(table1.5, 
                           col.names=c("Site", "Any Blood Collected","No Blood Collected", "Total Collections"),
                           caption='Table 1.7: Baseline Blood Collection Status Among Biospecimen Collections',
                           row.names=FALSE,align=c("l", rep("c", 3)), 
                           booktabs = TRUE)  %>% 
  add_indent(seq(1,  10)) %>%  
  kable_styling(latex_options = "scale_down") 



```

```{r Collections_by_Demographic, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

### Note: These 3 tables had a requested footnote update but its preventing the report from rendering. GH issue closed without these added, but keeping the code in case its brought back up 


BLCol_by_Sex_df <- create_tbl_cross2(table1, "sex", "biocol.appoint", "row", "Sex", "Baseline Biospecimen Collection Status", "Total")

colnames(BLCol_by_Sex_df)[ncol(BLCol_by_Sex_df)] <- "Total Verified \n Participants"

fem_pct <- round((sum(table1$sex=="Female")/sum(!is.na(table1$sex)))*100, digits=2)
m_pct <- round((sum(table1$sex=="Male")/sum(!is.na(table1$sex)))*100, digits=2)
uk_pct <- round((sum(table1$sex=="Unknown")/sum(!is.na(table1$sex)))*100, digits=2)
#NEED TO CHECK: Table 1.13 or Table 1.14? 
BLCol_by_Sex <- knitr::kable(BLCol_by_Sex_df, 
             caption='Table 1.13 Baseline Biospecimen Collection Status by Sex \n Among Verified Participants',
             row.names=FALSE, align=c("l",rep("c", 5)), booktabs = TRUE) %>%
    kable_styling(latex_options = "scale_down") %>%  
    add_indent(seq(1, nrow(BLCol_by_Sex_df) - 1)) %>% 
   footnote(general="Note: Sex defined as the de-identified sex data reported by sites at time of invitation.",
           general_title = "",
           footnote_as_chunk = TRUE,
           escape = FALSE,
           threeparttable = TRUE)
  
  # footnote(general=paste0("Note: Sex defined as the de-identified sex data reported by sites at time of invitation.",
  #                         "Of verified participants, ",fem_pct, "\\% are female, ",m_pct, "\\% are male , and ",uk_pct,"\\% are unknown sex"),
  #          general_title = "",
  #          footnote_as_chunk = TRUE, 
  #          escape = FALSE,
  #          threeparttable = TRUE)





BLCol_by_Age_df <- create_tbl_cross2(table1, "age", "biocol.appoint", "row", "Age", "Baseline Biospecimen Collection Status", "Total Verified Participants")

colnames(BLCol_by_Age_df)[ncol(BLCol_by_Age_df)] <- "Total Verified \n Participants"
#NEED TO CHECK: Table 1.14 or Table 1.15?
BLCol_by_Age <- knitr::kable(BLCol_by_Age_df, 
             caption="Table 1.14. Baseline Biospecimen Collection Status by Age \n Among Verified Participants",
             row.names=FALSE, align=c("l",rep("c", 5)), booktabs = TRUE) %>%
    kable_styling(latex_options = "scale_down") %>%  
    add_indent(seq(1, nrow(BLCol_by_Age_df) - 1)) %>% 
  footnote(general="Note: Age defined as the de-identified age data reported by sites at time of invitation, not current age at the time of specimen collection.",
           general_title = "",
           footnote_as_chunk = TRUE, 
           escape = FALSE, 
           threeparttable = TRUE)

  # footnote(general=paste0("Note: Age defined as the de-identified age data reported by sites at time of invitation, not current age at the time of specimen collection.",
  #                         "Of verified participants, ",
  #                         round((sum(table1$age=="30-34")/sum(!is.na(table1$age)))*100, digits=2), "% are 30-34, ",
  #                         round((sum(table1$age=="35-39")/sum(!is.na(table1$age)))*100, digits=2), "% are 35-39, ",
  #                         round((sum(table1$age=="40-45")/sum(!is.na(table1$age)))*100, digits=2), "% are 40-45, ",
  #                         round((sum(table1$age=="46-50")/sum(!is.na(table1$age)))*100, digits=2), "% are 46-50, ",
  #                         round((sum(table1$age=="51-55")/sum(!is.na(table1$age)))*100, digits=2), "% are 51-55, ",
  #                         round((sum(table1$age=="56-60")/sum(!is.na(table1$age)))*100, digits=2), "% are 56-60, ",
  #                         round((sum(table1$age=="61-65")/sum(!is.na(table1$age)))*100, digits=2), "% are 61-65, ",
  #                         round((sum(table1$age=="66-67")/sum(!is.na(table1$age)))*100, digits=2), "% are 66-70 ",
  #                         round((sum(table1$age=="Unknown")/sum(!is.na(table1$age)))*100, digits=2),"% are an unknown age."),
  #          general_title = "",
  #          footnote_as_chunk = TRUE, 
  #          escape = FALSE, 
  #          threeparttable = TRUE)



BLCol_by_Race_df <- create_tbl_cross2(table1, "race", "biocol.appoint", "row", "Race", "Baseline Biospecimen Collection Status", "Total Verified Participants")

colnames(BLCol_by_Race_df)[ncol(BLCol_by_Race_df)] <- "Total Verified \n Participants"
#NEED TO CHECK: Table 1.15 or Table 1.16?
BLCol_by_Race <- knitr::kable(BLCol_by_Race_df, 
             caption="Table 1.15. Baseline Biospecimen Collection Status by Race \n Among Verified Participants",
             row.names=FALSE, align=c("l",rep("c", 5)), booktabs = TRUE) %>%
    kable_styling(latex_options = "scale_down") %>%  
    add_indent(seq(1, nrow(BLCol_by_Race_df) - 1)) %>% 
    footnote(general = "Note: Race defined as the de-identified race data reported by sites at time of invitation.",
             general_title = "",
           footnote_as_chunk = TRUE, 
           escape = FALSE, 
           threeparttable = TRUE)

  # footnote(general=paste0("Note: Race defined as the de-identified race data reported by sites at time of invitation.",
  #                         "Of verified participants, ",
  #                         round((sum(table1$race=="Other")/sum(!is.na(table1$race)))*100, digits=2), "% are an 'other' race, ",
  #                         round((sum(table1$race=="Unknown")/sum(!is.na(table1$race)))*100, digits=2), "% are an 'unknown' race , and ",
  #                         round((sum(table1$race=='White, Non-Hispanic')/sum(!is.na(table1$race)))*100, digits=2),"% are White, Non-Hispanic."),
  #          general_title = "",
  #          ,
  #          footnote_as_chunk = TRUE, 
  #          escape = FALSE, 
  #          threeparttable = TRUE)


```




```{r Sanford_Table_1.4, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

### Separate code for Sanford clinical locations counts 


table1_4_locations <- table1_clin %>% filter(Site=="Sanford Health")
table1_4_locations$biocol.appoint[table1_4_locations$biocol.appoint == "Baseline Collection"] <- "Number of Clinical Collections"


## The amount of SF clinical locations is EXTEREMELY long. Saved in a separate csv 'Sanford_Clinical_Locations.csv' and that is extracted here

add_Site_location <- function(table1_4_locations, csv_file_path) {
  site_data <- read_csv(csv_file_path)
  
  if (!("ID" %in% colnames(site_data)) | !("Site_location" %in% colnames(site_data)) | !("Region" %in% colnames(site_data))) {
    stop("The CSV file must contain 'ID', 'Site_location', and 'Region' columns.")
  }
  
  case_when_string_location <- ""
  case_when_string_region <- ""
  
  for (i in 1:nrow(site_data)) {
    id <- site_data[i, "ID"]
    location <- site_data[i, "Site_location"]
    region <- site_data[i, "Region"]
    
    case_when_string_location <- paste0(
      case_when_string_location,
      "d_173836415_d_266600170_d_185243482 == ", id, " | d_173836415_d_266600170_d_452847912 == ", id, " ~ \"", location, "\",\n"
    )
    

    case_when_string_region <- paste0(
      case_when_string_region,
      "d_173836415_d_266600170_d_185243482 == ", id, " | d_173836415_d_266600170_d_452847912 == ", id, " ~ \"", region, "\",\n"
    )
  }
  
  
  #remove the last \n and comma at the end of the list
  case_when_string_location <- substr(case_when_string_location, 1, nchar(case_when_string_location) - 2)
  case_when_string_region <- substr(case_when_string_region, 1, nchar(case_when_string_region) - 2)
  
  
  table1_4_locations <- table1_4_locations %>%
    mutate(
      Site_location = eval(parse(text = paste0("case_when(\n", case_when_string_location, "\n)"))),
      Region = eval(parse(text = paste0("case_when(\n", case_when_string_region, "\n)")))
    )
  
  return(table1_4_locations)
}

# Apply the updated function to add Site_location and Region
table1_4_locations <- add_Site_location(table1_4_locations, "Sanford_Clincal_Locations.csv") 


## Some locations have two IDs from EPIC, need to be combined for tables
table1_4_locations$Site_location[table1_4_locations$Site_location=="Sioux Falls SD 32nd & Ellis Lab Old" | table1_4_locations$Site_location=="Sioux Falls SD 32nd & Ellis Lab"]="Sioux Falls SD 32nd & Ellis Lab "
table1_4_locations$Site_location[table1_4_locations$Site_location=="Sioux Falls SD 69th & Minnesota Lab A" | table1_4_locations$Site_location=="Sioux Falls SD 69th & Minnesota Lab B"]="Sioux Falls SD 69th & Minnesota Lab"
table1_4_locations$Site_location[table1_4_locations$Site_location=="Sioux Falls SD 69th & Louise Lab A" | table1_4_locations$Site_location=="Sioux Falls SD 69th & Louise Lab B"]="Sioux Falls SD 69th & Louise Lab"



## Handle those with missing location IDs
table1_4_locations$Site_location[is.na(table1_4_locations$d_173836415_d_266600170_d_185243482) &  
                                   is.na(table1_4_locations$d_173836415_d_266600170_d_452847912)]="Missing Both Location IDs" #doesn't have a blood or urine location ID

table1_4_locations$Site_location[is.na(table1_4_locations$Site_location) & 
                                   !(is.na(table1_4_locations$d_173836415_d_266600170_d_185243482) &  is.na(table1_4_locations$d_173836415_d_266600170_d_452847912))]="Unidentified SF Location" #has location ID(s) but SF hasn't told us its name yet

table1_4_locations$Region[table1_4_locations$Site_location=="Missing Both Location IDs" | table1_4_locations$Site_location=="Unidentified SF Location"] = "Unknown"



# Aggregate counts by Site_location and Region
count_all <- table1_4_locations %>%
  count(Region, Site_location) %>%
  dplyr::rename(Count_Total = n)

total_all <- sum(count_all$Count_Total)
count_all <- count_all %>%
  mutate(Percent_Total = paste0(round((Count_Total / total_all) * 100, 1), "%"))

# Define the filtered data frames for 7-day and 30-day counts
table1_4_locations_7days <- table1_4_locations %>% filter(d_556788178 >= currentDate - 7)
table1_4_locations_30days <- table1_4_locations %>% filter(d_556788178 >= currentDate - 30)

## All Counts
count_all <- table1_4_locations %>%
  count(Region, Site_location) %>%
   dplyr::rename(Count_Total = n)

total_all <- sum(count_all$Count_Total)
count_all <- count_all %>%
  mutate(Percent_Total = paste0(round((Count_Total / total_all) * 100, 1), "%"))



## 7-day Counts
count_7days <- table1_4_locations_7days %>%
  count(Region, Site_location) %>%
  dplyr::rename(Count_7days = n)

total_7days <- sum(count_7days$Count_7days)
count_7days <- count_7days %>%
  mutate(Percent_7days = paste0(round((Count_7days / total_7days) * 100, 1), "%"))


## 30-day Counts
count_30days <- table1_4_locations_30days %>%
  count(Region, Site_location) %>%
  dplyr::rename(Count_30days = n)

total_30days <- sum(count_30days$Count_30days)
count_30days <- count_30days %>%
  mutate(Percent_30days = paste0(round((Count_30days / total_30days) * 100, 1), "%"))


# Combine counts into the final table
final_col_num_1.5 <- full_join(count_all, count_7days, by = c("Region", "Site_location")) %>%
  full_join(count_30days, by = c("Region", "Site_location")) %>%
  replace_na(list(Count_Total = 0, Percent_Total = "0%", Count_7days = 0, Percent_7days = "0%", Count_30days = 0, Percent_30days = "0%"))

# Add total row
total_row <- data.frame(
  Region = "Total",
  Site_location = "Total",
  Count_Total = total_all,
  Percent_Total = "100%",
  Count_7days = total_7days,
  Percent_7days = "100%",
  Count_30days = total_30days,
  Percent_30days = "100%"
)

final_col_num_1.5 <- bind_rows(final_col_num_1.5, total_row)

# Add a helper column for sorting counts by region descending
final_col_num_1.5 <- final_col_num_1.5 %>%
  mutate(is_total = if_else(Region == "Total" & Site_location == "Total", 1, 0)) %>%
  arrange(is_total, Region, desc(Count_30days)) %>%
  dplyr::select(-is_total)  # Remove the helper column

final_col_num_1.5$'In the Past 7 Days' <- paste0(final_col_num_1.5$Count_7days, " (", final_col_num_1.5$Percent_7days, ")")
final_col_num_1.5$'In the Past 30 Days' <- paste0(final_col_num_1.5$Count_30days, " (", final_col_num_1.5$Percent_30days, ")")
final_col_num_1.5$'Collection Location' <- final_col_num_1.5$Site_location


SF_collections <- final_col_num_1.5 %>% filter(Count_7days>0 | Count_30days>0)


# Keep the Region column initially for arranging and grouping
SF_collections <- SF_collections[, c("Region", "Collection Location", "In the Past 7 Days", "In the Past 30 Days")]
SF_collections$Region <- factor(SF_collections$Region, levels=c("Bemidji","Bismarck","Fargo","Sioux Falls", "Unknown", "Total"))


SF_collections_tbl <- SF_collections %>%
  dplyr::select(-Region) %>%  # Remove Region just before rendering
  kbl(caption = "Table 1.5: Baseline Clinical Biospecimen Collections in the Past 30 Days at Sanford Health by Clinic Location",
      booktabs = TRUE, longtable = TRUE) %>%
  kable_styling(latex_options = "scale_down", full_width = FALSE, font_size = 6) %>%
  row_spec(0, bold = TRUE) %>%
  pack_rows(index = table(SF_collections$Region))  # Group by Region



```


```{r SF1.5, echo=FALSE, eval=TRUE,echo=FALSE,warning=FALSE,include=FALSE,results='hold'}

## Same table as above but only want top 10 collection locations listed per Region. 
### Note: If any are tied, we'll have more than 10

top10 <- count_all %>%
  group_by(Region) %>%
  top_n(10, Count_Total) %>%                 
  arrange(Region, desc(Count_Total))  %>%     
  ungroup() 


colnames(top10) <- c("Region", "Collection Location", "Top Collection Counts", "Total Percentage")

SF_top10_collections <- top10 %>%
  dplyr::select(-Region) %>%  
   kbl(caption = "Table 1.6 Top Baseline Clinical Collection Locations at Sanford Health by Region",
       booktabs = TRUE) %>%
  kable_styling(latex_options = "scale_down", full_width = FALSE) %>%
  row_spec(0, bold = TRUE) %>%
  pack_rows(index = table(top10$Region))  # Group by Region for display


colnames(top10) <- c("Region", "Collection Location", "Top Collection Counts", "Total Percentage")

## Used in footnote
SF_footnote <- count_all %>%  group_by(Region) %>%  tally(Count_Total) 

Bi_count <- SF_footnote$n[SF_footnote$Region=="Bismarck"]
F_count <- SF_footnote$n[SF_footnote$Region=="Fargo"]
S_count <- SF_footnote$n[SF_footnote$Region=="Sioux Falls"]
Be_count <- SF_footnote$n[SF_footnote$Region=="Bemidji"]
UK_count <- SF_footnote$n[SF_footnote$Region=="Unknown"]

footnote_text <- paste0("This table reflects Clinical Collections at the top 10 collection locations in each region. ",
                        "The total number of Clinical Collections in each region are as follows: Bemidji: ", Be_count,
                        "; Bismarck: ", Bi_count, "; Fargo: ", F_count, "; Sioux Falls: ", S_count, "; Missing Location IDs: ", UK_count, ".")




```


```{r BL_Collection_Settings_Alt, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

# Collection Counts per setting 


# Derived collection settings are somehow blank in some cases, have to fill in with overall collection setting
setting_ctabs <- coll_sett_all %>%  
  mutate(settings = factor(all_settings, levels=c("Clinical", "Research", "Home")),
         BL_BioSpm_BloodSetting_v1r0 = coalesce(BL_BioSpm_BloodSetting_v1r0, settings),
         BL_BioSpm_UrineSetting_v1r0 = coalesce(BL_BioSpm_UrineSetting_v1r0, settings),
         BL_BioSpm_MWSetting_v1r0 = coalesce(BL_BioSpm_MWSetting_v1r0, settings))


all_blood_settings <- as.data.frame(table(setting_ctabs$BL_BioSpm_BloodSetting_v1r0[setting_ctabs$d_878865966 == "Any blood collected"], exclude = NULL))
allurine_settings <- as.data.frame(table(setting_ctabs$BL_BioSpm_UrineSetting_v1r0[setting_ctabs$d_167958071 == "Any urine collected"], exclude = NULL))
all_mw_settings <- as.data.frame(table(setting_ctabs$BL_BioSpm_MWSetting_v1r0[setting_ctabs$d_684635302 == "Any mouthwash collected"], exclude = NULL))

distrb_allsetts <- cbind(all_blood_settings, allurine_settings, all_mw_settings)

#Remove duplicate columns
distrb_allsetts <- distrb_allsetts[, c(1,2,4,6)]
colnames(distrb_allsetts) <- c("Collection Setting", "Any Blood Collected", "Urine Collected", "Mouthwash Collected")


distrb_allsetts_with_totals <- distrb_allsetts %>%  add_totals_and_percentages(total_position = c("row"), percentage_type = "col")


```


```{r Coll_Sett_Hyrbids, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

# Collection Counts per setting, for hybird Sites



set_by_site <- coll_sett_all %>%  filter(Site=="Henry Ford Health" | Site=="HealthPartners" | Site=="Sanford Health" | Site=="University of Chicago Medicine")

sites <- unique(set_by_site$Site)
site_results <- list()

for (site in sites) {
  site_data <- filter(set_by_site, Site == site)
  
  # Derived collection settings are somehow blank in some cases, have to fill in with overall collection setting
setting_ctabs_Site <- site_data %>%  
  mutate(settings = case_when(d_650516960=="534621077" ~ "Research",
                              d_650516960=="664882224" ~ "Clinical",
                              d_650516960=="103209024" ~ "Home"),
         settings = factor(settings, levels=c("Clinical", "Research", "Home")),
         BL_BioSpm_BloodSetting_v1r0 = coalesce(BL_BioSpm_BloodSetting_v1r0, settings),
         BL_BioSpm_UrineSetting_v1r0 = coalesce(BL_BioSpm_UrineSetting_v1r0, settings),
         BL_BioSpm_MWSetting_v1r0 = coalesce(BL_BioSpm_MWSetting_v1r0, settings))


all_blood_settings_Site <- as.data.frame(table(setting_ctabs_Site$BL_BioSpm_BloodSetting_v1r0[setting_ctabs_Site$d_878865966 == "Any blood collected"], exclude = NULL))
allurine_settings_Site <- as.data.frame(table(setting_ctabs_Site$BL_BioSpm_UrineSetting_v1r0[setting_ctabs_Site$d_167958071 == "Any urine collected"], exclude = NULL))
all_mw_settings_Site <- as.data.frame(table(setting_ctabs_Site$BL_BioSpm_MWSetting_v1r0[setting_ctabs_Site$d_684635302 == "Any mouthwash collected"], exclude = NULL))

distrb_allsetts_Site <- cbind(all_blood_settings_Site, allurine_settings_Site, all_mw_settings_Site)

#Remove duplicate columns
distrb_allsetts_Site <- distrb_allsetts_Site[, c(1,2,4,6)]
colnames(distrb_allsetts_Site) <- c("Collection Setting", "Any Blood Collected", "Urine Collected", "Mouthwash Collected")


distrb_allsetts_Site_with_totals <- distrb_allsetts_Site %>% 
  add_totals_and_percentages(total_position = c("row"), percentage_type = "col")

  
  # Store the result for the current site
  site_results[[site]] <- distrb_allsetts_Site_with_totals
}


```



```{r Table5a5b, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

# Specimen collection counts and types, split by collection setting 



## Research
table4_redone__R <- coll_sett_all %>%  
  filter(all_settings == "Research") %>%
  mutate(blood = BioFin_BaseBloodCol_v1r0 == "Any blood collected",
         urine = BioFin_BaseUrineCol_v1r0 == "Any urine collected",
         mouthwash = BioFin_BaseMWCol_v1r0 == "Any mouthwash collected",
         `Specimens Collected` = case_when(blood & urine & mouthwash ~ "Blood, Urine, Mouthwash (All)",
                                           blood & urine & !mouthwash ~ "Blood & Urine Only",
                                           blood & !urine & mouthwash ~ "Blood & Mouthwash Only",
                                           !blood & urine & mouthwash ~ "Urine & Mouthwash Only",
                                           blood & !urine & !mouthwash ~ "Blood Only",
                                           !blood & urine & !mouthwash ~ "Urine Only",
                                           !blood & !urine & mouthwash ~ "Mouthwash Only",
                                           !blood & !urine & !mouthwash ~ "No Specimens Collected")) %>%
  dplyr::select(-blood, -urine, -mouthwash) %>%  # Remove helper columns
  mutate(`Specimens Collected` = factor(`Specimens Collected`,levels=c('Blood, Urine, Mouthwash (All)', 'Blood & Urine Only',
                                                                        'Blood & Mouthwash Only','Urine & Mouthwash Only','Blood Only',
                                                                        'Urine Only','Mouthwash Only','No Specimens Collected')))

table4_redone__R$Site <- droplevels(as.factor(table4_redone__R$Site))
table4_redone__R$`Specimens Collected` <- droplevels(as.factor(table4_redone__R$`Specimens Collected`))


spec_by_site_R <- create_tbl_cross(table4_redone__R, 'Specimens Collected', "Site", "column", " ", " ")
colnames(spec_by_site_R)[ncol(spec_by_site_R)] <- "Total Research Collections"






## Clinical #NEED TO CHECK: Should LINE 1281 say "No Specimens Collected"? 

table4_redone__C <- coll_sett_all %>%  
  filter(all_settings == "Clinical") %>%
  mutate(blood = BioFin_BaseBloodCol_v1r0 == "Any blood collected",
         urine = BioFin_BaseUrineCol_v1r0 == "Any urine collected",
         mouthwash = BioFin_BaseMWCol_v1r0 == "Any mouthwash collected",
         `Specimens Collected` = case_when(blood & urine ~ "Blood & Urine (All)",
                                           blood & !urine ~ "Blood Only",
                                           !blood & urine ~ "Urine Only",
                                           !blood & !urine ~ "Attempted but \n No Specimens Collected")) %>%
  dplyr::select(-blood, -urine, -mouthwash) %>%  # Remove helper columns
  mutate(`Specimens Collected` = factor(`Specimens Collected`,levels=c('Blood & Urine (All)', 'Blood Only', 'Urine Only', 'Attempted but \n No Specimens Collected')))

table4_redone__C$Site <- droplevels(as.factor(table4_redone__C$Site))
table4_redone__C$`Specimens Collected` <- droplevels(as.factor(table4_redone__C$`Specimens Collected`))


spec_by_site_C <- create_tbl_cross(table4_redone__C, 'Specimens Collected', "Site", "column", " ", " ")
colnames(spec_by_site_C)[ncol(spec_by_site_C)] <- "Total Clinical Collections"

```

```{r Data System, eval=TRUE,echo=FALSE,include=FALSE,results='hide'}
#NEED TO CHECK - Missing Data System chunk 





































```



```{r Table11, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

# Count of Deviation Existence by Site

## Grab all variables with Secondary Source 'Tube'
tubes <- unique(y[grepl(" Tube ",y$`Secondary.Source`),c("conceptId.1","Secondary.Source")])
tube.ls <- paste0("d_", trimws(paste(tubes$conceptId.1,collapes="")))


## Create loop to count deviations and collections
coll_sett_all$tubedev <-0 #biospecimen deviations
coll_sett_all$tubecol <- 0 #tube collections

for(i in 1:length(tube.ls)){
  
  tubecol <- ifelse(coll_sett_all[,paste(tube.ls[i],"d_593843561",sep="_")] == 104430631 | is.na(coll_sett_all[,paste(tube.ls[i],"d_593843561",sep="_")]),0,1)  ##for tube collected
  
  tubedev <- ifelse(coll_sett_all[,paste(tube.ls[i],"d_678857215",sep="_")]==104430631 | is.na(coll_sett_all[,paste(tube.ls[i],"d_678857215",sep="_")]),0,1) #for tube deviations yes/no
  
  coll_sett_all$tubedev <- coll_sett_all$tubedev+tubedev
  coll_sett_all$tubecol <- tubecol + coll_sett_all$tubecol 
}

## Count tubes with no deviations
coll_sett_all$tube_nodev <- coll_sett_all$tubecol-coll_sett_all$tubedev
total1 <- sum(coll_sett_all$tubedev) 
total2 <- sum(coll_sett_all$tube_nodev) 


## The code is grabbing the first tube type (SST1) randomly for a naming convention for the variable Any Deviation and No Deviation. 
## Unless renamed, all that can be seen is d_299553921_d_678857215 and d_299553921_d_593843561, but confirmed these are the aggregate tube counts, not just SST1
tube_dev <- as.data.frame(aggregate(coll_sett_all$tubedev,
                                    by = list(coll_sett_all$Site),
                                    FUN = sum)) 
# I get an error messgae unless this line is separated
tube_dev <- tube_dev %>% 
  rename(Site = Group.1, Any_Deviation = colnames(tube_dev)[2])


tube_nodev <- as.data.frame(aggregate(coll_sett_all$tube_nodev,
                                      by = list(coll_sett_all$Site),
                                      FUN = sum)) 
# I get an error messgae unless this line is separated
tube_nodev <- tube_nodev %>% 
  rename(Site = Group.1, No_Deviation = colnames(tube_nodev)[2]) #sometimes this switches from d_299553921_d_593843561 to d_958646668_d_593843561

## Combine them into one dataframe
Deviation_Freq <- base::merge(tube_dev,tube_nodev,by="Site")

Deviation_Freq <- Deviation_Freq %>%  
  mutate(`Total` = Any_Deviation + No_Deviation,
         `Any Deviations` = paste0(Any_Deviation, " (", round(Any_Deviation / Total * 100, 1), "%)"),
         `No Deviations` = paste0(No_Deviation, " (", round(No_Deviation / Total * 100, 1), "%)"),
         Site = factor(Site,levels = c("Baylor Scott and White Health",  "HealthPartners",  "Henry Ford Health",
                                       "Marshfield Clinic Health System", "Sanford Health",  "University of Chicago Medicine",
                                       "Kaiser Permanente Colorado", "Kaiser Permanente Georgia", "Kaiser Permanente Hawaii", "Kaiser Permanente Northwest"))) %>% 
  dplyr::select("Site", "Any Deviations", "No Deviations", "Total") %>% 
   arrange(Site)

## Add Total row
total_row <- Deviation_Freq %>%
  summarise(Site = "Total",
            Total = sum(Total, na.rm = TRUE),
            Any_num = sum(as.numeric(gsub(" .*", "", `Any Deviations`)), na.rm = TRUE),
            No_num = sum(as.numeric(gsub(" .*", "", `No Deviations`)), na.rm = TRUE)) %>%
  mutate(`Any Deviations` = paste0(Any_num, " (", round(Any_num / Total * 100, 1), "%)"),
         `No Deviations` = paste0(No_num, " (", round(No_num / Total * 100, 1), "%)")) %>%
  dplyr::select(Site, `Any Deviations`, `No Deviations`, Total)


Deviation_Freq <- Deviation_Freq %>% bind_rows(total_row)

































```

```{r Deviations, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

#Number of tubes collected, not collected, reason not collected, deviations, and discards -- collection_long used throughout the code elsewhere 

notcol_tubes <- colnames(coll_sett_all)[grepl("883732523",colnames(coll_sett_all))] 
notcol.ls <- sapply(strsplit(notcol_tubes, "_d"),"[[",1)
notcol_tube <- NULL


for (i in 1:length(notcol.ls)){

  tubecol <- paste(notcol.ls[i],"d_593843561",sep="_")
  tube_notcol <- paste(notcol.ls[i],"d_883732523", sep="_") #notcolnotes
  TubeID <- paste(tube.ls[i],"d_825582494",sep="_")

  tube_deviation <- paste(notcol.ls[i], "d_678857215",sep="_")

  select <- c(TubeID,tubecol,tube_notcol,tube_deviation)
  tmp <- coll_sett_all[,(colnames(coll_sett_all)%in% c(select,"d_820476880","Site","all_settings"))]
  notcol <- tmp
  colnames(notcol)[colnames(notcol)==TubeID] <- "TubeID"
  colnames(notcol)[colnames(notcol)==tubecol] <- "tubecol"
  colnames(notcol)[colnames(notcol)==tube_notcol] <- "tube_notcol"

  colnames(notcol)[colnames(notcol)==tube_deviation] <- "tube_deviation"


  notcol$tubeID <- notcol.ls[i]

  notcol_tube <- dplyr::bind_rows(notcol_tube,notcol)

}


collection_long <- NULL
for (i in 1:length(tube.ls)){

  tubeid <- paste(tube.ls[i],"d_825582494",sep="_")
  tubecol <- paste(tube.ls[i],"d_593843561",sep="_")
  tube_discard <- paste(tube.ls[i], "d_762124027",sep="_")
  select <- c(tubeid,tubecol,tube_deviation,tube_discard)
  tmp <- coll_sett_all[,(colnames(coll_sett_all)%in% c(select,"d_820476880","Site","all_settings"))]
  col <- tmp
  colnames(col)[colnames(col)==tubeid] <- "TubeID"
  colnames(col)[colnames(col)==tubecol] <- "tubecol"
  colnames(col)[colnames(col)==tube_discard] <- "tube_discard"

  col$tubeID <- tube.ls[i]
  collection_long <- dplyr::bind_rows(collection_long,col)
}

collection_long <- collection_long  %>%
   dplyr:: mutate(tube_type = case_when(tubeID == "d_973670172"  ~ "Urine Tube1",
                                       tubeID == "d_143615646"  ~ "MW Tube1",
                                       tubeID == "d_299553921"  ~ "SS Tube1",
                                       tubeID == "d_703954371"  ~ "SS Tube2",
                                       tubeID == "d_454453939"  ~ "EDTA Tube1",
                                       tubeID == "d_838567176"  ~ "Heparin Tube1",
                                       tubeID == "d_652357376"  ~ "ACD Tube1",
                                       tubeID == "d_677469051"  ~ "EDTA Tube2",
                                       tubeID == "d_683613884"  ~ "EDTA Tube3",
                                       tubeID == "d_376960806"  ~ "SS Tube3",
                                       tubeID == "d_232343615"  ~ "SS Tube4",
                                       tubeID == "d_589588440"  ~ "SS Tube5",
                                       tubeID == "d_505347689"  ~ "STRECK Tube1",
                                       tubeID == "d_958646668"  ~ "Heparin Tube2"),
      tube_type = factor(tube_type, levels=c("SS Tube1", "SS Tube2","SS Tube3", "SS Tube4", "SS Tube5",
                                              "Heparin Tube1","Heparin Tube2","EDTA Tube1", "EDTA Tube2",
                                              "EDTA Tube3","ACD Tube1", "STRECK Tube1", "Urine Tube1","MW Tube1" )))

## noticed that collection_ling shows more tubes than table 2.5 (Deviation_Freq) .... 
## This does show multiple duplicate rows, but exluding them drops the rows of this df from 700k to about 140 so thats not right
# collection_long %>%
#   group_by(Site, TubeID) %>%
#   summarise(dup_count = n()) %>%
#   filter(dup_count > 1)

```




```{r Table2.7_2.8, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

# Blood tubes collected by Site

research__blood <- collection_long %>% filter(all_settings == "Research" & tubecol == 353358909) %>% 
  mutate(Site=droplevels(as.factor(Site)),
         tube_type = factor(tube_type,levels=c("SS Tube1", "SS Tube2","Heparin Tube1","EDTA Tube1","ACD Tube1", "STRECK Tube1")))  

research__blood <- research__blood %>% filter(!is.na(tube_type))



bloodtubetype_R <- create_tbl_cross(research__blood, "Site", "tube_type", "none", "Site", " ")
colnames(bloodtubetype_R)[ncol(bloodtubetype_R)] <- "Total Blood Tubes Collected"
colnames(bloodtubetype_R)[1] <- "Site"

```



```{r Table10, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

## Number of tube tubes not collected at clinical collections
#Note-- ask erin if we can keep these consistent, don't see why we need two versions of the tube names

clinic.coltube <- collection_long %>%  mutate(tube_types= case_when(tube_type=="SS Tube1" ~ "SS T1",
                                                                    tube_type=="SS Tube2" ~ "SS T2",
                                                                    tube_type=="SS Tube3" ~ "SS T3",
                                                                    tube_type=="SS Tube4" ~ "SS T4",
                                                                    tube_type=="SS Tube5" ~ "SS T5",
                                                                    tube_type=="Heparin Tube1" ~ "Heparin 1",
                                                                    tube_type=="Heparin Tube2" ~ "Heparin 2",
                                                                    tube_type=="EDTA Tube1" ~ "EDTA 1",
                                                                    tube_type=="EDTA Tube2" ~ "EDTA 2",
                                                                    tube_type=="EDTA Tube3" ~ "EDTA 3",
                                                                    tube_type=="ACD Tube1" ~ "ACD 1",
                                                                    tube_type=="STRECK Tube1" ~ "STRECK 1",
                                                                    tube_type=="Urine Tube1" ~ "Urine 1",
                                                                    tube_type=="MW Tube1" ~ "Mouthwash")) %>% 
  filter(all_settings == "Clinical" & tubecol == 353358909 & tube_types!="Urine 1" & tube_types!="Mouthwash") %>% 
  mutate(Site=droplevels(as.factor(Site)))



bloodtubetype_C <- create_tbl_cross(clinic.coltube, "Site", "tube_types", "none", "Site", " ")
colnames(bloodtubetype_C)[ncol(bloodtubetype_C)] <- "Total Blood Tubes Collections"
colnames(bloodtubetype_C)[1] <- "Site"

#order SSTs, EDTAs, Heaparin, Streck -- factoring in the mutate doesn't work
bloodtubetype_C <- bloodtubetype_C[, c("Site","SS T1", "SS T2","SS T3", "SS T4", "SS T5", "EDTA 1","EDTA 2","EDTA 3",
                                       "Heparin 1","Heparin 2","STRECK 1","ACD 1","Total Blood Tubes Collections")]



```



```{r Table12a12b, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

 
## Reason not collected by tube type and by site for research collections only

a <- collection_long[which(collection_long$tubecol==104430631),]
b <- notcol_tube[which(notcol_tube$tubecol == 104430631),]
notcol_notes <- base::merge(a, b[,c("tubeID","d_820476880","tube_notcol")], by=c("tubeID","d_820476880"),all.x=TRUE)

notcol_notes <- notcol_notes %>% 
  mutate(notcol.notes = case_when(tubecol == 104430631 & tube_notcol==181769837 ~ "Other",
                                  tubecol == 104430631 & tube_notcol==234139565 ~ "Short Draw",
                                  tubecol == 104430631 & tube_notcol==681745422 ~ "Participant Refusal",
                                  tubecol == 104430631 & tube_notcol==745205161 ~ "Participant Attempted",
                                  tubecol == 104430631 & tube_notcol==889386523 ~ "Supply Unavailable",
                                  tubecol == 104430631 & is.na(tube_notcol) ~ "Missing Reasons"),
         Collected = case_when(tubecol ==353358909 ~ "Collected",
                               tubecol == 104430631 ~ "Not Collected"),
         biospecimen=ifelse(tubeID=="d_973670172", "urine",
                            ifelse(tubeID=="d_143615646","Mouthwash","blood")),
         tube_type = case_when(tubeID == "d_973670172"  ~ "Urine Tube1",
                               tubeID == "d_143615646"  ~ "MW Tube1",
                               tubeID == "d_299553921"  ~ "SS Tube1",
                               tubeID == "d_703954371"  ~ "SS Tube2",
                               tubeID == "d_454453939"  ~ "EDTA Tube1",
                               tubeID == "d_838567176"  ~ "Heparin Tube1",
                               tubeID == "d_652357376"  ~ "ACD Tube1",
                               tubeID == "d_677469051"  ~ "EDTA Tube2",
                               tubeID == "d_683613884"  ~ "EDTA Tube3",
                               tubeID == "d_376960806"  ~ "SS Tube3",
                               tubeID == "d_232343615"  ~ "SS Tube4",
                               tubeID == "d_589588440"  ~ "SS Tube5",
                               tubeID == "d_505347689"  ~ "STRECK Tube1",
                               tubeID == "d_958646668"  ~ "Heparin Tube2"),
         tube_type = factor(tube_type, levels=c("SS Tube1", "SS Tube2","SS Tube3", "SS Tube4", "SS Tube5",
                                                 "Heparin Tube1","Heparin Tube2","EDTA Tube1", "EDTA Tube2",
                                                 "EDTA Tube3","ACD Tube1","Urine Tube1","STRECK Tube1","MW Tube1" )),
         notcol.notes = factor(notcol.notes, levels=c("Short Draw","Participant Attempted", "Other", "Participant Refusal", "Supply Unavailable", "Missing Reasons")))





research.notcol <- notcol_notes %>% filter(all_settings=="Research" & tubecol==104430631) %>%
  mutate(Site=droplevels(as.factor(Site)),
         tube_type = factor(tube_type,levels=c("SS Tube1", "SS Tube2","Heparin Tube1","EDTA Tube1","ACD Tube1","STRECK Tube1","Urine Tube1","MW Tube1" )))

research.notcol$notcol.notes <- factor(research.notcol$notcol.notes, 
                                       levels=c("Short Draw","Participant Attempted", "Other", "Participant Refusal", "Supply Unavailable", "Missing Reasons"))

reseachnotes.notcol <- n_pct_table(research.notcol$Site,research.notcol$notcol.notes)
reseachnotes.coltype <- n_pct_table(research.notcol$tube_type,research.notcol$notcol.notes)
notcol.reasons.research <- rbind(reseachnotes.notcol,reseachnotes.coltype)



## Reasons not collected by site 
reason_notcol <- create_tbl_cross(research.notcol, "Site", "notcol.notes", "column", "Site", " ")
colnames(reason_notcol)[ncol(reason_notcol)] <- "Total Tubes Not Collected"
colnames(reason_notcol)[1] <- "Site"


## Reasons not collected by tube type
tube_type_notcolreasons <- create_tbl_cross(research.notcol, "tube_type", "notcol.notes", "row", "Tube Type", " ")
colnames(tube_type_notcolreasons)[ncol(tube_type_notcolreasons)] <- "Total Tubes Not Collected"
colnames(tube_type_notcolreasons)[1] <- "Tube Type"



```


```{r Table13, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

#Number of tube tubes Discarded by tube type and site

discard.tb <- collection_long  %>% filter(tube_discard == 353358909) %>% 
  mutate(Site=droplevels(as.factor(Site)),
         tube_type = droplevels(as.factor(tube_type)))
discard.site <- n_pct_table(discard.tb$Site,discard.tb$tube_type)
discard.site <- (discard.site[, c((ncol(discard.site)), 1:(ncol(discard.site)-1))])

discard.site[nrow(discard.site),c(2:ncol(discard.site))] <- paste(discard.site[nrow(discard.site),c(2:ncol(discard.site))], "(100%)")

```


```{r Research_Collections_Surveys, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

# Setting up variables for all research specific Tables and Figures
research.survey <- coll_sett_all %>% filter(all_settings == "Research") %>%
  mutate(Site=droplevels(as.factor(Site)),
         ctime = round(as.numeric(difftime(as.POSIXct(ymd_hms(d_222161762)),as.POSIXct(ymd_hms(d_822499427)),units="mins")), digits=1),
         tm_biocolsuv = difftime(as.POSIXct(ymd_hms(d_222161762)),as.POSIXct(ymd_hms(d_331584571_d_266600170_d_840048338)),units="hours"), #time b/w survey completion to bio collection visit check in
         checktmvisit = case_when( as.numeric(tm_biocolsuv) >72 ~"> 72hrs",
                                   72 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 48 ~ "> 48 hrs to 72 hrs",
                                   48 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 24 ~ "> 24 hrs to 48 hrs",   
                                   24 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 12 ~ "> 12 hrs to 24 hrs",
                                   12 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 3 ~ "> 3 hrs to 12 hrs",  
                                   3 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) >= 0 ~ "0 hrs to 3 hrs",
                                   d_265193023 != "Submitted" ~ "Not Submitted", 
                                   TRUE ~ "Missing Time"),
         #Waiting on Erin's approval for this change
         #tm_biocolsuv < 0 ~ "QC error,
         #is.na(tm_biocolsuv) ~ "Missing Time"),
         time_biochk = difftime(as.POSIXct(ymd_hms(d_331584571_d_266600170_d_343048998)),as.POSIXct(ymd_hms(d_331584571_d_266600170_d_840048338)),units="mins"),
         checktmvisit = factor(checktmvisit, levels=c( "Not Submitted", "Missing Time", "0 hrs to 3 hrs","> 3 hrs to 12 hrs",
                                                       "> 12 hrs to 24 hrs","> 24 hrs to 48 hrs","> 48 hrs to 72 hrs","> 72hrs"))) 

```


```{r Research_Tables, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

## BUM Survey completion by Site

BUM_status <- create_tbl_cross(research.survey, "d_265193023", "Site", "column", " ", " ")
colnames(BUM_status)[ncol(BUM_status)] = "Total Research Surveys"


##Check in until completion (pre and post covid)

research.survey_sec3 <- research.survey %>% filter(checktmvisit!="Not Submitted")
research.survey_sec3$checktmvisit <- droplevels(research.survey_sec3$checktmvisit)
  
precovR <- research.survey_sec3 %>%  filter(d_265193023 == "Submitted" & d_222161762<as.Date("2023-07-05"))

postcovR <- research.survey_sec3 %>%  filter(d_265193023 == "Submitted" & d_222161762>=as.Date("2023-07-05"))

precovid_BUMtime <- create_tbl_cross(precovR, "checktmvisit", "Site", "column", " ", " ")
colnames(precovid_BUMtime)[ncol(precovid_BUMtime)] = "Total Research Surveys"

postcovid_BUMtime <- create_tbl_cross(postcovR, "checktmvisit", "Site", "column", " ", " ")
colnames(postcovid_BUMtime)[ncol(postcovid_BUMtime)] = "Total Research Surveys"





##Start to submission (pre and post COVID)
precovR_comp <- research.survey %>%  filter(d_222161762<as.Date("2023-07-05") & d_265193023 == "Submitted" & ctime>0) 
postcovR_comp <- research.survey %>%  filter(d_222161762>=as.Date("2023-07-05") & d_265193023 == "Submitted" & ctime>0)


Table21R_Before = precovR_comp %>% group_by(Site) %>% 
  dplyr::summarize('Number of Submitted Research Surveys'=n(),
                   Min = min(ctime),
                   Q1 = quantile(ctime, 0.25),
                   Median = median(ctime),
                   Mean = mean(ctime),
                   Q3 = quantile(ctime, 0.75),
                   Perc.95= quantile(ctime, 0.95),
                   Max = max(ctime))


Table21R_After = postcovR_comp %>% group_by(Site) %>% 
  dplyr::summarize('Number of Submitted Research Surveys'=n(),
                   Min = min(ctime),
                   Q1 = quantile(ctime, 0.25),
                   Median = median(ctime),
                   Mean = mean(ctime),
                   Q3 = quantile(ctime, 0.75),
                   Perc.95= quantile(ctime, 0.95),
                   Max = max(ctime))


```


```{r Research_Srvy_Status, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}
## Collection Visit Length 

research.vt.length <- research.survey %>%  mutate(time=as.numeric(time_biochk)) 

research.vt.length.table = research.vt.length %>%group_by(Site) %>% 
  dplyr::summarize('Number of Research Collection Visits'=n(),
                   Min = min(time,na.rm = TRUE),
                   Q1 = quantile(time, 0.25,na.rm = TRUE),
                   Median = median(time,na.rm = TRUE),
                   Mean = mean(time,na.rm = TRUE),
                   Q3 = quantile(time, 0.75,na.rm = TRUE),
                   Perc.90= quantile(time, 0.90,na.rm = TRUE),
                   Perc.95= quantile(time, 0.95,na.rm = TRUE),
                   Perc.98= quantile(time, 0.98,na.rm = TRUE),
                   Max = max(time,na.rm = TRUE))

```


```{r UC_Avg_Visit, include=FALSE}


research.vt.length.UC <- research.vt.length %>% filter(Site=="University of Chicago Medicine") %>% 
  mutate(Site_location = case_when(d_951355211==777644826 ~ "UC-DCAM",
                                   d_951355211==145191545 ~ "Ingalls Harvey",
                                   d_951355211==489380324 ~ "River East",
                                   d_951355211==120264574 ~ "South Loop",
                                   d_951355211==319518299 ~ "UCM Pop-Up",
                                   d_951355211==940329442 ~ "Orland Park")) %>%  
  group_by(col.Monday.date, Site_location) %>% 
  tally(mean(time))


UC_Time <- ggplot(research.vt.length.UC, aes(x=as.Date(col.Monday.date), y=n, color=Site_location)) + 
  geom_line() + geom_point(width = 0.2) +
  scale_y_continuous(name="Average Number of Minutes",limits=c(0,300)) +
  scale_color_manual(values=c("Ingalls Harvey"="#B1C7D9", "Orland Park"="#2973A5", "River East"="#FDBE19", 
                              "South Loop"="#565C65", "UC-DCAM"="#3C989E", "UCM Pop-Up"="#CC7D15")) +
  scale_x_date(name="Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", limits=c( as.Date("2022-06-20"),(as.Date(currentDate)-1)),expand=c(0,0)) +
  ggtitle(label="Figure 4.1 Baseline- Weekly Average Research Collection Visit Length (in Minutes) \n by Collection Location, University of Chicago Medicine") +
  labs(color = "Collection Location") +
  theme(panel.background = element_blank(),
        legend.title = element_text(size=8),
        legend.position="bottom",
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1), axis.title.x = element_text( size = 14, face = "bold") ,
        axis.title.y = element_text(size = 14, face = "bold",color="black"),
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +
  guides(fill=guide_legend(nrow=2,byrow=TRUE))+
  labs(caption = "Note: Visit lengths greater than 300 minutes (5 hours) have been excluded, as they are likely the result of delayed \n
participant visit checkout.") +
  theme(plot.caption = element_text(hjust=0))

```


```{r Figures4, include=FALSE, echo=FALSE, warning=FALSE, eval=TRUE}

Section3_Figures <- function(site, title) {
  
  filtered <- research.survey %>%
    filter(Site == site & !is.na(checktmvisit) &
           (d_684635302 == "Any mouthwash collected" | d_878865966 == "Any blood collected" | d_167958071 == "Any urine collected")) %>%
    mutate(Site = droplevels(Site),
           hours3 = ifelse(checktmvisit == "0 hrs to 3 hrs", 1, 0))
  

  weekly_summary <- filtered %>%
    group_by(Site, col.Monday.date) %>%
    summarise(n = sum(!is.na(checktmvisit)),
              hours3 = sum(hours3),
              pct3 = 100 * round(hours3 / n, 2),
              .groups = "drop")
  

  plots3 <- ggplot(weekly_summary, aes(x = as.Date(col.Monday.date), y = pct3)) +
    geom_line() +
    geom_point(width = 0.2) +
    scale_y_continuous(name = "Percent %", breaks = seq(0, 100, 25)) +
    scale_x_date(name = "Date", date_labels = "%y-%m-%d", date_breaks = "2 weeks",
                 limits = c(as.Date("2022-06-20"), as.Date(currentDate - 1)), expand = c(0, 0)) +
    scale_fill_brewer(palette = "Dark2") +
    ggtitle(label = title) +
    theme(panel.background = element_blank(),
          axis.line = element_line(size = 0.2),
          axis.text.x = element_text(angle = 60, hjust = 1),
          axis.title.x = element_text(size = 14, face = "bold"),
          axis.title.y = element_text(size = 14, face = "bold", color = "black"),
          plot.title = element_text(hjust = 0.5, size = 12, face = "bold"))
  
  return(plots3)
}


research.4_1 <- Section3_Figures("Henry Ford Health", "Figure 3.1: Baseline- Weekly Percent of Biospecimen Surveys Submitted within 3 Hours of \n Research Collection Visit Check In, Henry Ford Health")

research.4_2 <- Section3_Figures("Sanford Health", "Figure 3.2: Baseline- Weekly Percent of Biospecimen Surveys Submitted within 3 Hours of \n Research Collection Visit Check In, Sanford Health")

research.4_3 <- Section3_Figures("University of Chicago Medicine", "Figure 3.3: Baseline- Weekly Percent of Biospecimen Surveys Submitted within 3 Hours of \n Research Collection Visit Check In, University of Chicago Medicine")

```


```{r Table28a,include=FALSE, echo=FALSE, warning=FALSE}

#### Section 5


## Overall dataframe for Section 5 research tables

str_sub(research.survey$d_143615646_d_926457119,12,24)[!is.na(research.survey$d_143615646_d_926457119)] <- "11:30:00.000Z"
str_sub(research.survey$d_232343615_d_926457119,12,24)[!is.na(research.survey$d_232343615_d_926457119)] <- "11:30:00.000Z"
str_sub(research.survey$d_299553921_d_926457119,12,24)[!is.na(research.survey$d_299553921_d_926457119)] <- "11:30:00.000Z"
str_sub(research.survey$d_376960806_d_926457119,12,24)[!is.na(research.survey$d_376960806_d_926457119)] <- "11:30:00.000Z"
str_sub(research.survey$d_454453939_d_926457119,12,24)[!is.na(research.survey$d_454453939_d_926457119)] <- "11:30:00.000Z"
str_sub(research.survey$d_505347689_d_926457119,12,24)[!is.na(research.survey$d_505347689_d_926457119)] <- "11:30:00.000Z"
str_sub(research.survey$d_589588440_d_926457119,12,24)[!is.na(research.survey$d_589588440_d_926457119)] <- "11:30:00.000Z"
str_sub(research.survey$d_652357376_d_926457119,12,24)[!is.na(research.survey$d_652357376_d_926457119)] <- "11:30:00.000Z"
str_sub(research.survey$d_677469051_d_926457119,12,24)[!is.na(research.survey$d_677469051_d_926457119)] <- "11:30:00.000Z"
str_sub(research.survey$d_683613884_d_926457119,12,24)[!is.na(research.survey$d_683613884_d_926457119)] <- "11:30:00.000Z"
str_sub(research.survey$d_703954371_d_926457119,12,24)[!is.na(research.survey$d_703954371_d_926457119)] <- "11:30:00.000Z"
str_sub(research.survey$d_838567176_d_926457119,12,24)[!is.na(research.survey$d_838567176_d_926457119)] <- "11:30:00.000Z"
str_sub(research.survey$d_958646668_d_926457119,12,24)[!is.na(research.survey$d_958646668_d_926457119)] <- "11:30:00.000Z"
str_sub(research.survey$d_973670172_d_926457119,12,24)[!is.na(research.survey$d_973670172_d_926457119)] <- "11:30:00.000Z"

 
biospe_adhoc_all <-  research.survey %>%  filter(d_410912345==353358909 & !is.na(d_678166505) & !is.na(Site_location) & !is.na(Site))

#BPTL null- not used in this table, but need to understand the denominator inconsistencies 
biospe_adhoc_missings = biospe_adhoc_all %>%  filter(is.na(d_143615646_d_926457119) & is.na(d_232343615_d_926457119) & 
                                                           is.na(d_299553921_d_926457119) & is.na(d_376960806_d_926457119) &
                                                           is.na(d_454453939_d_926457119) & is.na(d_505347689_d_926457119) & 
                                                           is.na(d_589588440_d_926457119) & is.na(d_652357376_d_926457119) &
                                                           is.na(d_677469051_d_926457119) & is.na(d_683613884_d_926457119) & 
                                                           is.na(d_703954371_d_926457119) & is.na(d_838567176_d_926457119) &
                                                           is.na(d_958646668_d_926457119) & is.na(d_973670172_d_926457119))
#Used for this table- BPTL not null
coll_bptl_diff <- biospe_adhoc_all %>%  
  filter(!is.na(d_143615646_d_926457119) | !is.na(d_232343615_d_926457119) |
                                                 !is.na(d_299553921_d_926457119) | !is.na(d_376960806_d_926457119) |
                                                 !is.na(d_454453939_d_926457119) | !is.na(d_505347689_d_926457119) |
                                                 !is.na(d_589588440_d_926457119) |!is.na(d_652357376_d_926457119) |
                                                 !is.na(d_677469051_d_926457119) | !is.na(d_683613884_d_926457119) |
                                                 !is.na(d_703954371_d_926457119) | !is.na(d_838567176_d_926457119) |
                                                 !is.na(d_958646668_d_926457119) | !is.na(d_973670172_d_926457119)) %>%
  mutate(Site_location = factor(Site_location,
                                levels=c("BCC- HWC","FW All Saints","BCC- Plano","BCC- Worth St","BCC- Irving",
                                         "Irving", "NTX Biorepository","BCC- Fort Worth","North Garland", "Temple CDM",
                                         "Temple Roney", "Waco - MacArthur","Missing BSWH location",
                                         "HP Research Clinic", "HP Park Nicollet", "Missing HP location",
                                         "HFH K-13 Research Clinic","HFH Cancer Pavilion Research Clinic",
                                         "HFH Livonia Research Clinic", "HFH Pop-Up", "HFH Detroit Northwest","In-home Collection", "HFH Jackson","Missing HFH location",
                                         "Neillsville", "Missing MF location",
                                         "Marshfield", "MF Pop-Up","Weston","Lake Hallie", "Rice Lake","Wisconsin Rapids", 
                                         "Colby Abbotsford","Minocqua","Merrill","Stevens Point",
                                         "Sioux Falls Imagenetics","Fargo South University","Edith Sanford Breast Center (coded as Sanford Center)", 
                                  "Edith Sanford Breast Center","Fargo Amber Valley",
                                         "Ingalls Harvey", "River East","South Loop","UCM Pop-Up","UC-DCAM","Orland Park", "Missing UC location")),
         Site = factor(Site, levels=c("Baylor Scott and White Health","HealthPartners","Henry Ford Health",
                                      "Marshfield Clinic Health System","Sanford Health","University of Chicago Medicine")))  %>% 
  group_by(as.character(Connect_ID),Site, Site_location) %>% 
  mutate(any_collection = min(d_143615646_d_926457119, d_232343615_d_926457119, d_299553921_d_926457119, d_376960806_d_926457119, d_454453939_d_926457119, 
                              d_505347689_d_926457119, d_589588440_d_926457119, d_652357376_d_926457119, d_677469051_d_926457119, d_683613884_d_926457119, 
                              d_703954371_d_926457119, d_838567176_d_926457119, d_958646668_d_926457119, d_973670172_d_926457119,  na.rm=T),
         day_past = difftime(as.Date(any_collection), as.Date(d_678166505), units="days"),
         coll_days_diff = ifelse(as.numeric(day_past)<2,"1 Day",
                                 ifelse(as.numeric(day_past)<3,"2 Days",
                                        ifelse(as.numeric(day_past)<4,"3 Days", 
                                               ifelse(as.numeric(day_past)<5,"4 Days",
                                                      ifelse(as.numeric(day_past)>=5,">4 Days", "Missing time stamp(s)"))))),
         coll_days_diff=factor(coll_days_diff, levels=c("1 Day","2 Days","3 Days","4 Days",">4 Days","Missing time stamp(s)")))
                                 
```




```{r Table5.1, message=FALSE, echo=FALSE, warning=FALSE}

## Collection-To-Receipt Time, Research

rsch_coll_bptl_days <- coll_bptl_diff %>% ungroup() %>% 
  mutate(coll_days_diff= droplevels(coll_days_diff))

research_coll_bptl1 <- create_tbl_cross(rsch_coll_bptl_days, "Site", "coll_days_diff", "row", "Site", " ")


```

```{r Table28b,include=FALSE, echo=FALSE, warning=FALSE}

## Collection-To-Receipt Time, Research, by Site location


rsch_loc_coll_bptl <- create_tbl_cross(rsch_coll_bptl_days, "Site_location", "coll_days_diff", "row", "Site", " ")
rsch_loc_coll_bptl <- as.data.frame(rsch_loc_coll_bptl)
colnames(rsch_loc_coll_bptl)[1] <- "Collection Location"


ctable_rsch_loc_bptl <- rsch_loc_coll_bptl %>%
  mutate(Site_Group = case_when(
    `Collection Location` %in% c("UC-DCAM", "Ingalls Harvey", "River East", "South Loop", "UCM Pop-Up", 
                               "Orland Park", "Missing UC location") ~ "University of Chicago Medicine",
    `Collection Location` %in% c("HP Research Clinic",  "HP Park Nicollet", "Missing HP location") ~ "HealthPartners",
    `Collection Location` %in% c("Lake Hallie", "Marshfield", "MF Pop-Up", "Minocqua", "Weston", "Wisconsin Rapids", "Rice Lake", 
                               "Colby Abbotsford", "Merrill", "Stevens Point",
                               "Neillsville", "Missing MF location") ~ "Marshfield Clinic Health System",
    `Collection Location` %in% c("Sioux Falls Imagenetics", "Fargo South University", "Edith Sanford Breast Center (coded as Sanford Center)", 
                               "Edith Sanford Breast Center","Fargo Amber Valley","Missing SF location") ~ "Sanford Health",
    `Collection Location` %in% c("HFH K-13 Research Clinic", "HFH Livonia Research Clinic", "HFH Cancer Pavilion Research Clinic", "HFH Pop-Up", 
                               "HFH Detroit Northwest", "In-home Collection","HFH Jackson","Missing HFH location") ~ "Henry Ford Health",
    `Collection Location` %in% c("BCC- HWC","FW All Saints","BCC- Plano","BCC- Worth St","BCC- Irving","Irving","NTX Biorepository","BCC- Fort Worth", 
                               "North Garland", "Temple CDM","Temple Roney", "Waco - MacArthur", "Missing BSWH location") ~ "Baylor Scott and White Health",
    `Collection Location` %in% c("Unidentified location") ~ "Other",
    TRUE ~ " "),
    Site_Group = factor(Site_Group, levels=c("Baylor Scott and White Health", "HealthPartners", "Henry Ford Health", "Marshfield Clinic Health System",
                                             "Sanford Health", "University of Chicago Medicine")))




# Removing rows with all 0's
ctable_rsch_loc_bptl <- ctable_rsch_loc_bptl %>%  filter(str_sub(Total, 1, 1) != "0")


# Separate the Total row
total_row <- ctable_rsch_loc_bptl %>% filter(`Collection Location` == "Total")

# Remove the Total row from the main table
rsch_coll_times <- ctable_rsch_loc_bptl %>%
  filter(`Collection Location` != "Total") %>%
  arrange(Site_Group, `Collection Location`)




# --- NEW: Adding Site Group Total Row ---

value_cols <- names(rsch_coll_times)[2:7]  # "1 Day","2 Days","3 Days","4 Day",">4 Days","Total"

# 1) Extract N from "N (%)" in each cell
counts_for_sum <- rsch_coll_times %>%
    dplyr::mutate(dplyr::across(
        dplyr::all_of(value_cols),
        ~ suppressWarnings(as.numeric(gsub(",", "", stringr::str_extract(.x, "^[0-9,]+"))))
    ))

# 2) Subtotal the Ns within each Site_Group
subtotals_count <- counts_for_sum %>%
    dplyr::group_by(Site_Group) %>%
    dplyr::summarise(dplyr::across(dplyr::all_of(value_cols), ~ sum(.x, na.rm = TRUE)), .groups = "drop")

# 3) Rebuild "N (%)" strings for the subtotal rows
subtotals_fmt <- subtotals_count %>%
    dplyr::mutate(row_total = .data$Total) %>%
    dplyr::mutate(dplyr::across(
        dplyr::all_of(setdiff(value_cols, "Total")),
        ~ paste0(formatC(.x, format = "d", big.mark = ","),
                 " (", sprintf("%.1f", ifelse(row_total > 0, 100 * .x / row_total, 0)), "%)")
    )) %>%
    dplyr::mutate(
        Total = formatC(Total, format = "d", big.mark = ","),
        `Collection Location` = "Total"              # label for the within-site total row
    ) %>%
    dplyr::select(`Collection Location`, dplyr::all_of(value_cols), Site_Group)

# 4) Insert the subtotal rows so they appear at the bottom of each Site_Group block
rsch_coll_times <- dplyr::bind_rows(rsch_coll_times, subtotals_fmt) %>%
    dplyr::arrange(Site_Group, (`Collection Location` == "Total"), `Collection Location`)






# Append the Total row at the bottom with Site_Group = "Total"
rsch_coll_times <- bind_rows(rsch_coll_times, total_row %>% mutate(Site_Group = "Total"))


rsch_coll_times$Site_Group <- factor(rsch_coll_times$Site_Group, levels = unique(rsch_coll_times$Site_Group))

# Count occurrences of each Site_Group 
site_group_counts <- table(rsch_coll_times$Site_Group)


rsch_coll_times52 <- knitr::kable(rsch_coll_times[, c(1:7)], 
                                  caption="Table 5.2: Baseline Collection-To-Receipt Time (in Days) Among Research Collections by Collection Location",
                                  col.names=c("Collection Location","1 Day","2 Days","3 Days","4 Day",">4 Days","Total Received Research Collections"),
                                  align=c("l",rep("c", 6)), 
                                  booktabs = TRUE, longtable = TRUE) %>%  
  pack_rows(index = site_group_counts) %>%  # Ensure "Total" is last
    row_spec(which(rsch_coll_times$Collection_Location %in% names(site_group_counts)), hline_after = TRUE) %>%
    kable_styling(latex_options = "scale_down", full_width = FALSE, font_size=7) %>% 
  landscape() %>% 
  kableExtra::footnote(general = paste0("Note: At the time of reporting, ", dim(biospe_adhoc_missings)[[1]], 
                            " of the Research Collections do not have receipt date/time information available."), 
           general_title = "",
           footnote_as_chunk = TRUE, 
           escape = FALSE, 
           threeparttable = TRUE)


rsch_coll_times52_6b <- knitr::kable(rsch_coll_times[, c(1:7)], 
             caption="Table 6b: Baseline Collection-To-Receipt Time (in Days) Among Research Collections by Collection Location",
             col.names=c("Collection Location","1 Day","2 Days","3 Days","4 Day",">4 Days","Total Received Research Collections"),
             align=c("l",rep("c", 6)), 
             booktabs = TRUE, longtable = TRUE) %>%  
  pack_rows(index = site_group_counts) %>%  # Ensure "Total" is last
    row_spec(which(rsch_coll_times$Collection_Location %in% names(site_group_counts)), hline_after = TRUE) %>%
    kable_styling(latex_options = "scale_down", full_width = FALSE, font_size=7) %>% 
  landscape() %>% 
  kableExtra::footnote(general = paste0("Note: At the time of reporting, ", dim(biospe_adhoc_missings)[[1]], 
                            " of the Research Collections do not have receipt date/time information available."), 
           general_title = "",
           footnote_as_chunk = TRUE, 
           escape = FALSE, 
           threeparttable = TRUE)



```



```{r Clinical_Collections_Surveys, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

# Setting up variables for all clinical specific Tables and Figures


clinical.survey <- coll_sett_all %>% filter(all_settings == "Clinical") %>%
  mutate(clin.sv = case_when(d_253883960 == 231311385 ~ "Submitted",
                             d_253883960 == 615768760 ~ "Started",
                             d_253883960 == 972455046 ~ "Not Started"),
         Site=droplevels(as.factor(Site)),
         d_173836415_d_266600170_d_139245758_clc = as.POSIXct(ymd_hms(d_173836415_d_266600170_d_139245758)), ##urine
         d_173836415_d_266600170_d_982213346_clc = as.POSIXct(ymd_hms(d_173836415_d_266600170_d_982213346)), ##blood collected
         d_173836415_d_266600170_d_740582332_clc = as.POSIXct(ymd_hms(d_173836415_d_266600170_d_740582332)), ##Autogenerated date/time stamp for Any specimen collected at RRL
         clinic.svtime =  difftime(as.POSIXct(ymd_hms(d_764863765)),as.POSIXct(ymd_hms(d_534669573)),units="hours"),
         ctime = round(as.numeric(difftime(as.POSIXct(ymd_hms(d_764863765)),as.POSIXct(ymd_hms(d_534669573)),units="mins")), digits=1)) ##survey time from start to complete

clinical.survey <- clinical.survey %>% 
  mutate(clc.coltm  = do.call(pmin, c(dplyr::select(.,ends_with('clc')),na.rm=TRUE)),
         tm_biocolsuv =  difftime(as.POSIXct(ymd_hms(d_764863765)),clc.coltm,units="hours")) #time between survey completion to biospecimen collection visit check in



clinical.survey <-clinical.survey %>%
  mutate(checktmvisit = case_when(as.numeric(tm_biocolsuv) >72 ~"> 72hrs",
                                  72 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 48 ~ "> 48 hrs to 72 hrs",
                                  48 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 24 ~ "> 24 hrs to 48 hrs",
                                  24 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 12 ~ "> 12 hrs to 24 hrs",
                                  12 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 3 ~ "> 3 hrs to 12 hrs",    
                                  3 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) >= 0 ~ "0 hrs to 3 hrs", 
                                  d_265193023 != 231311385 ~ "Not Submitted", 
                                  TRUE ~ "Missing Time"),
         #Waiting on Erin's approval for this change
                                   #tm_biocolsuv < 0 ~ "QC error,
                                   #is.na(tm_biocolsuv) ~ "Missing Time"),
         checktmvisit = factor(checktmvisit, levels=c("Not Submitted", "Missing Time", "0 hrs to 3 hrs", "> 3 hrs to 12 hrs", 
                                                      "> 12 hrs to 24 hrs", "> 24 hrs to 48 hrs", "> 48 hrs to 72 hrs", "> 72hrs")))

clinical.survey$checktmvisit <- droplevels(clinical.survey$checktmvisit)

```


```{r Clinical_Tables, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

## BU Completion by Site
BU_status <- create_tbl_cross(clinical.survey, "clin.sv", "Site", "column", " ", " ")
colnames(BU_status)[ncol(BU_status)] = "Total Clinical Surveys"


## Collection to BU Survey Completion
clin_comp <- clinical.survey %>%  filter(clin.sv == "Submitted" & checktmvisit!="Not Submitted")
clin_comp$checktmvisit <- droplevels(clin_comp$checktmvisit)

coll_comp_BU <- create_tbl_cross(clin_comp, "checktmvisit", "Site", "column", " ", " ")

colnames(coll_comp_BU)[ncol(coll_comp_BU)] <- "Total Submitted Clinical Surveys"



##Start to submission (pre and post covid)
precovC_comp <- clinical.survey %>%  filter(d_764863765<as.Date("2023-07-05") & clin.sv == "Submitted" & ctime>0)
postcovC_comp <- clinical.survey %>%  filter(d_764863765>=as.Date("2023-07-05") & clin.sv == "Submitted" & ctime>0)


ClinSrvy_Lgth_Before = precovC_comp %>% group_by(Site) %>% 
  dplyr::summarize('Number of Submitted \n Clinical Surveys'=n(),
                   Min = min(ctime),
                   Q1 = quantile(ctime, 0.25),
                   Median = median(ctime),
                   Mean = mean(ctime),
                   Q3 = quantile(ctime, 0.75),
                   Perc.95= quantile(ctime, 0.95),
                   Max = max(ctime))


ClinSrvy_Lgth_After = postcovC_comp %>% group_by(Site) %>% 
  dplyr::summarize('Number of Submitted \n Clinical Surveys'=n(),
                   Min = min(ctime),
                   Q1 = quantile(ctime, 0.25),
                   Median = median(ctime),
                   Mean = mean(ctime),
                   Q3 = quantile(ctime, 0.75),
                   Perc.95= quantile(ctime, 0.95),
                   Max = max(ctime))




##### Clinical Bio Collection to Bio Dashboard Entry
clinical.survey <- clinical.survey %>%  
  mutate(coll_to_DB_BU = as.numeric(difftime(as.POSIXct(ymd_hms(d_915838974)),
                                             pmin(as.POSIXct(ymd_hms(d_173836415_d_266600170_d_982213346)), 
                                                  as.POSIXct(ymd_hms(d_173836415_d_266600170_d_139245758)), na.rm=TRUE),units="hours")))


BU_coll_DB_comp = clinical.survey %>% group_by(Site) %>% 
  filter(!is.na(coll_to_DB_BU)) %>% 
  dplyr::summarize('Number of Clinical Collection Visits'=n(),
                   Min = round(min(coll_to_DB_BU,na.rm = TRUE), digits=1),
                   Q1 = round(quantile(coll_to_DB_BU, 0.25,na.rm = TRUE), digits=1),
                   Median = round(median(coll_to_DB_BU,na.rm = TRUE), digits=1),
                   Mean = round(mean(coll_to_DB_BU,na.rm = TRUE), digits=1),
                   SD= round(sd(coll_to_DB_BU,na.rm = TRUE), digits=1),
                   Q3= round(quantile(coll_to_DB_BU, 0.75,na.rm = TRUE), digits=1),
                   'Perc.95'= round(quantile(coll_to_DB_BU, 0.95,na.rm = TRUE), digits=1),
                   Max = round(max(coll_to_DB_BU,na.rm = TRUE), digits=1))



######BUM complete time from Survey Trigger Date

clinical.survey <- clinical.survey %>%  
  mutate(trig_to_comp_BU = as.numeric(difftime(as.POSIXct(ymd_hms(d_764863765)),as.POSIXct(ymd_hms(d_915838974)),units="hours")))


BU_trig_comp = clinical.survey %>% group_by(Site) %>% 
  dplyr::summarize('Number of Clinical Collection Visits'=n(),
                   Min = round(min(trig_to_comp_BU,na.rm = TRUE), digits=1),
                   Q1 = round(quantile(trig_to_comp_BU, 0.25,na.rm = TRUE), digits=1),
                   Median = round(median(trig_to_comp_BU,na.rm = TRUE), digits=1),
                   Mean = round(mean(trig_to_comp_BU,na.rm = TRUE), digits=1),
                   SD= round(sd(trig_to_comp_BU,na.rm = TRUE), digits=1),
                   Q3= round(quantile(trig_to_comp_BU, 0.75,na.rm = TRUE), digits=1),
                   'Perc.95'= round(quantile(trig_to_comp_BU, 0.95,na.rm = TRUE), digits=1),
                   Max = round(max(trig_to_comp_BU,na.rm = TRUE), digits=1))

```

```{r Table25, include=FALSE, echo=FALSE, warning=FALSE}

## Draw Order Placement to Clinical Collection

avg_draw_order <- clinical.survey %>%  filter(Site!='HealthPartners' & Site!="Sanford Health" & Site!='University of Chicago Medicine') %>% 
  mutate(time = as.numeric(difftime(as.POSIXct(ymd_hms(d_173836415_d_266600170_d_982213346)),
                                    as.POSIXct(ymd_hms(d_173836415_d_266600170_d_769615780)),units="days"))) %>%
  group_by(Site) %>% 
  dplyr::summarize('Number of Clinical Collections'=n(),
                   Min = round(min(time,na.rm = TRUE), digits=1),
                   Q1 = round(quantile(time, 0.25,na.rm = TRUE), digits=1),
                   Median = round(median(time,na.rm = TRUE), digits=1),
                   Mean = round(mean(time,na.rm = TRUE), digits=1),
                   Q3 = round(quantile(time, 0.75,na.rm = TRUE), digits=1),
                   Perc.80= quantile(time, 0.80,na.rm = TRUE),
                   Perc.90= quantile(time, 0.90,na.rm = TRUE),
                   Perc.95= quantile(time, 0.95,na.rm = TRUE),
                   Max = round(max(time,na.rm = TRUE), digits=1))

```



```{r, Table29b, include=FALSE, echo=FALSE, warning=FALSE}


## Overall dataframe for Section 5 clinical tables


biospe_adhoc_2 = clinical.survey %>%  filter(d_410912345==353358909 & !is.na(Clin_Site_location) & !is.na(Site)) %>% 
  mutate(Site=droplevels(as.factor(Site)))


#BPTL null- not used in this table, but used in the footnote to determine how many participants have missing data, if any
biospe_adhoc2_missings = biospe_adhoc_2 %>% filter((is.na(d_173836415_d_266600170_d_822274939) & is.na(d_173836415_d_266600170_d_139245758)) |
                                                     #d_173836415_d_266600170_d_982213346
                                                  !(!is.na(d_232343615_d_926457119) | !is.na(d_299553921_d_926457119) | !is.na(d_376960806_d_926457119) |
                                                      !is.na(d_454453939_d_926457119) | !is.na(d_505347689_d_926457119) | !is.na(d_589588440_d_926457119) |
                                                      !is.na(d_652357376_d_926457119) | !is.na(d_677469051_d_926457119) | !is.na(d_683613884_d_926457119) |
                                                      !is.na(d_703954371_d_926457119) |!is.na(d_838567176_d_926457119) | !is.na(d_958646668_d_926457119) |
                                                      !is.na(d_973670172_d_926457119)))


#Used for this table- BPTL not null
biospe_adhoc2= biospe_adhoc_2 %>%  filter((!is.na(d_232343615_d_926457119) | !is.na(d_299553921_d_926457119) | !is.na(d_376960806_d_926457119) |
                                         !is.na(d_454453939_d_926457119) | !is.na(d_505347689_d_926457119) | !is.na(d_589588440_d_926457119) |
                                         !is.na(d_652357376_d_926457119) | !is.na(d_677469051_d_926457119) | !is.na(d_683613884_d_926457119) |
                                         !is.na(d_703954371_d_926457119) |!is.na(d_838567176_d_926457119) | !is.na(d_958646668_d_926457119) |
                                         !is.na(d_973670172_d_926457119))) 


coll_bptl_diff2 <- biospe_adhoc2  %>% group_by(as.character(Connect_ID),Site, Clin_Site_location) %>% 
  mutate(any_collection = min(d_232343615_d_926457119, d_299553921_d_926457119, d_376960806_d_926457119, d_454453939_d_926457119, d_505347689_d_926457119,
                              d_589588440_d_926457119, d_652357376_d_926457119, d_677469051_d_926457119, d_683613884_d_926457119, d_703954371_d_926457119,
                              d_838567176_d_926457119, d_958646668_d_926457119, d_973670172_d_926457119, na.rm=T),
         clin_coll_bu = min(d_173836415_d_266600170_d_822274939, d_173836415_d_266600170_d_139245758, na.rm=T), #d_173836415_d_266600170_d_982213346
         day_past = difftime(as.Date(any_collection), as.Date(clin_coll_bu), units="days"),
         coll_days_diff = ifelse(as.numeric(day_past)<2,"1 Day",
                                 ifelse(as.numeric(day_past)<3,"2 Days",
                                        ifelse(as.numeric(day_past)<4,"3 Days", 
                                               ifelse(as.numeric(day_past)<5,"4 Days", 
                                                      ifelse(as.numeric(day_past)>=5,">4 Days", "Missing Time Stamp(s)"))))),
         coll_days_diff=factor(coll_days_diff, levels=c("1 Day","2 Days","3 Days","4 Days",">4 Days","Missing time stamp(s)")))

coll_bptl_diff2 <- coll_bptl_diff2 %>% filter(!is.na(coll_days_diff))

```

```{r Table5.3, message=FALSE, echo=FALSE, warning=FALSE}


## Collection-To-Receipt Time, Clinical 

clin_coll_bptl_diff3 <- coll_bptl_diff2 %>% ungroup() %>% 
  mutate(coll_days_diff= droplevels(coll_days_diff))

crosstable.clin_coll_days <- create_tbl_cross(clin_coll_bptl_diff3, "Site", "coll_days_diff", "row", "Site", " ")






## Collection-To-Receipt Time, Clinical, by Site Location 

clin_coll_bptl_diff3$Clin_Site_location[clin_coll_bptl_diff3$Site=="Kaiser Permanente Colorado"]="KPCO"
clin_coll_bptl_diff3$Clin_Site_location[clin_coll_bptl_diff3$Site=="Kaiser Permanente Georgia"]="KPGA"
clin_coll_bptl_diff3$Clin_Site_location[clin_coll_bptl_diff3$Site=="Kaiser Permanente Northwest"]="KPNW"
clin_coll_bptl_diff3$Clin_Site_location[clin_coll_bptl_diff3$Site=="Sanford Health"]="KPNW"

clin_coll_days <- create_tbl_cross(clin_coll_bptl_diff3, "Clin_Site_location", "coll_days_diff", "row", "Collection Location", " ")
clin_coll_days <- as.data.frame(clin_coll_days)
colnames(clin_coll_days)[1] <- "Collection Location"


clin_coll_days <- clin_coll_days %>%
  mutate(Site_Group = case_when(
    `Collection Location` %in% c("Macomb", "West Bloomfield", "Wyandotte","Fairlane (Dearborn)", "Plymouth", "Royal Oak", "Troy", 
                                 "K1 HFH Main","Sterling Heights","Columbus", "Livonia","Taylor", "Ford Road", "NCO","Brownstown", 
                                 "E Jefferson Pathology", "Woodhaven Pathology", "Missing HFH location") ~ "Henry Ford Health", 
    `Collection Location` %in% c("Elk River", "Chanhassen", "Park Nicollet Minneapolis Clinic", "Brooklyn Center", "Clinic Stillwater", "New Richmond Clinic", 
    "NSC", "Missing HP location") ~ "HealthPartners", 
    `Collection Location`== "KPCO" ~ "Kaiser Permanente Colorado",
    `Collection Location`== "KPGA" ~ "Kaiser Permanente Georgia",
    `Collection Location` %in% c("Oahu Clinics", "Non-Oahu Clinics", "Missing Both Location IDs","Missing KPHI location") ~ "Kaiser Permanente Hawaii",
    `Collection Location`== "KPNW" ~ "Kaiser Permanente Northwest",
    `Collection Location`== "Sanford Health" ~ "Sanford Health",
    `Collection Location` %in% c("South Loop","Orland Park","Kenwood","River East","Dearborn Station", "Ingalls", 
                                 "DCAM (Hyde Park)","Crown Point", "Missing UC location") ~ "University of Chicago Medicine",
    TRUE ~ " "),
    Site_Group = factor(Site_Group, levels=c("HealthPartners", "Henry Ford Health", "University of Chicago Medicine", 
                                             "Kaiser Permanente Colorado", "Kaiser Permanente Georgia", "Kaiser Permanente Northwest", "Kaiser Permanente Hawaii",
                                             "Sanford Health"))) 



# Removing rows with all 0's
clin_coll_days <- clin_coll_days %>%  filter(str_sub(Total, 1, 1) != "0")


# Separate the Total row
total_row <- clin_coll_days %>% filter(`Collection Location` == "Total")

# Remove the Total row from the main table
clin_coll_times <- clin_coll_days %>%
  filter(`Collection Location` != "Total") %>%
  arrange(Site_Group, `Collection Location`)






# --- NEW: Adding Site Group Total Row ---

value_cols <- names(clin_coll_times)[2:7]  # "1 Day","2 Days","3 Days","4 Day",">4 Days","Total"

# 1) Extract N from "N (%)" in each cell
counts_for_sum <- clin_coll_times %>%
  dplyr::mutate(dplyr::across(
    dplyr::all_of(value_cols),
    ~ suppressWarnings(as.numeric(gsub(",", "", stringr::str_extract(.x, "^[0-9,]+"))))
  ))

# 2) Subtotal the Ns within each Site_Group
subtotals_count <- counts_for_sum %>%
  dplyr::group_by(Site_Group) %>%
  dplyr::summarise(dplyr::across(dplyr::all_of(value_cols), ~ sum(.x, na.rm = TRUE)), .groups = "drop")

# 3) Rebuild "N (%)" strings for the subtotal rows
subtotals_fmt <- subtotals_count %>%
  dplyr::mutate(row_total = .data$Total) %>%
  dplyr::mutate(dplyr::across(
    dplyr::all_of(setdiff(value_cols, "Total")),
    ~ paste0(formatC(.x, format = "d", big.mark = ","),
             " (", sprintf("%.1f", ifelse(row_total > 0, 100 * .x / row_total, 0)), "%)")
  )) %>%
  dplyr::mutate(
    Total = formatC(Total, format = "d", big.mark = ","),
    `Collection Location` = "Total"              # label for the within-site total row
  ) %>%
  dplyr::select(`Collection Location`, dplyr::all_of(value_cols), Site_Group)

# 4) Insert the subtotal rows so they appear at the bottom of each Site_Group block
clin_coll_times <- dplyr::bind_rows(clin_coll_times, subtotals_fmt) %>%
  dplyr::arrange(Site_Group, (`Collection Location` == "Total"), `Collection Location`)








# Append the Total row at the bottom with Site_Group = "Total"
clin_coll_times <- bind_rows(clin_coll_times, total_row %>% mutate(Site_Group = "Total"))

#Make sure the Sites are in the right order
clin_coll_times$Site_Group <- factor(clin_coll_times$Site_Group, levels = unique(clin_coll_times$Site_Group))

# Count occurrences of each Site_Group
site_group_counts <- table(clin_coll_times$Site_Group)


ctable_clin_loc_bptl <- knitr::kable(clin_coll_times[, c(1:7)], 
             caption="Table 5.4: Baseline Collection-To-Receipt Time (in Days) \n Among Clinical Collections by Clinic Location",
             col.names=c("Collection Location","1 Day","2 Days","3 Days","4 Day",">4 Days","Total Received Clinical Collections"),
             align=c("l",rep("c", 6)), 
             booktabs = TRUE, longtable = TRUE) %>%  
  pack_rows(index = site_group_counts) %>%  # Ensure "Total" is last
  row_spec(which(clin_coll_times$Collection_Location %in% names(site_group_counts)), hline_after = TRUE) %>%
  kable_styling(latex_options = "scale_down", full_width = FALSE, font_size=7) %>% 
  footnote(general= paste0("At the time of reporting, ", dim(biospe_adhoc2_missings)[[1]], " of the Clinical Collections did not have collection and/or receipt date/time information available."), general_title = " ") %>% 
  landscape()



```




```{r Table21a21b, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}


## Time from Verif to Research Collection

baseline_colct <- coll_sett_all %>%  filter(d_331584571== 266600170 & !is.na(d_914594314) & !is.na(d_556788178))


# ON OR AFTER 8/1/22

baseline_colctD <- baseline_colct %>%  filter(d_914594314>=as.Date("2022-08-01") & all_settings=="Research")

BSL_colctD <- baseline_colctD %>%  mutate(time = as.numeric(difftime(as.POSIXct(ymd_hms(d_556788178)),as.POSIXct(ymd_hms(d_914594314)),units="days")))


verif_BSL_colctD = BSL_colctD %>%group_by(Site) %>% 
  dplyr::summarize('Number of Research Collection Visits'=n(),
                   Min = round(min(time,na.rm = TRUE), digits=1),
                   Q1 = round(quantile(time, 0.25,na.rm = TRUE), digits=1),
                   Median = round(median(time,na.rm = TRUE), digits=1),
                   Mean = round(mean(time,na.rm = TRUE), digits=1),
                   SD= round(sd(time,na.rm = TRUE), digits=1),
                   Q3= round(quantile(time, 0.75,na.rm = TRUE), digits=1),
                   'Perc.95'= round(quantile(time, 0.95,na.rm = TRUE), digits=1),
                   Max = round(max(time,na.rm = TRUE), digits=1))

# for the footnote
baseline_colctC <- baseline_colct %>%  filter(d_914594314<as.Date("2022-08-01"))





# BEFORE 2/1/23
baseline_colctA <- baseline_colct %>%  filter(d_914594314<as.Date("2023-02-01") & all_settings=="Clinical")

BSL_colctA <- baseline_colctA %>%  mutate(time = as.numeric(difftime(as.POSIXct(ymd_hms(d_556788178)),as.POSIXct(ymd_hms(d_914594314)),units="days")),
                                          "Number of Participants" = n(),
                                          'Number of Baseline Collections' = case_when(!is.na(d_556788178) ~ n()))


verif_BSL_colctA = BSL_colctA %>%group_by(Site) %>%
  dplyr::summarize('Number of Clinical Collections'=n(),
                   Min = round(min(time,na.rm = TRUE), digits=1),
                   Q1 = round(quantile(time, 0.25,na.rm = TRUE), digits=1),
                   Median = round(median(time,na.rm = TRUE), digits=1),
                   Mean = round(mean(time,na.rm = TRUE), digits=1),
                   SD= round(sd(time,na.rm = TRUE), digits=1),
                   Q3= round(quantile(time, 0.75,na.rm = TRUE), digits=1),
                   'Perc.90'= round(quantile(time, 0.90,na.rm = TRUE), digits=1),
                   Max = round(max(time,na.rm = TRUE), digits=1))




## ON OR AFTER 2/1/23

baseline_colctB <- baseline_colct %>%  filter(d_914594314>=as.Date("2023-02-01")  & all_settings=="Clinical")

BSL_colctB <- baseline_colctB %>%  mutate(time = as.numeric(difftime(as.POSIXct(ymd_hms(d_556788178)),as.POSIXct(ymd_hms(d_914594314)),units="days")))


verif_BSL_colctB = BSL_colctB %>% group_by(Site) %>%
  dplyr::summarize('Number of Clinical Collections'=n(),
                   Min = round(min(time,na.rm = TRUE), digits=1),
                   Q1 = round(quantile(time, 0.25,na.rm = TRUE), digits=1),
                   Median = round(median(time,na.rm = TRUE), digits=1),
                   Mean = round(mean(time,na.rm = TRUE), digits=1),
                   SD= round(sd(time,na.rm = TRUE), digits=1),
                   Q3= round(quantile(time, 0.75,na.rm = TRUE), digits=1),
                   'Perc.90'= round(quantile(time, 0.90,na.rm = TRUE), digits=1),
                   Max = round(max(time,na.rm = TRUE), digits=1))










##########################

## Verification to Draw Order

ver_draw <- biocol.tb %>%  filter(!is.na(d_173836415_d_266600170_d_769615780) & d_914594314>=as.Date("2023-02-01")  & 
                                    Site!='HealthPartners' & Site!='Sanford Health' & Site!='University of Chicago Medicine' &  
                                       Site!='Henry Ford Health') %>% mutate(Site = droplevels(Site))

verif_draw <- ver_draw %>%  mutate(time = as.numeric(difftime(as.POSIXct(ymd_hms(d_173836415_d_266600170_d_769615780)),as.POSIXct(ymd_hms(d_914594314)),units="days")))

# verif_draw_order = verif_draw %>%group_by(Site) %>%
#   dplyr::summarize('Number of Draw Orders Placed'=n(),
#                    Min = round(min(time,na.rm = TRUE), digits=1),
#                    Q1 = round(quantile(time, 0.25,na.rm = TRUE), digits=1),
#                    Median = round(median(time,na.rm = TRUE), digits=1),
#                    Mean = round(mean(time,na.rm = TRUE), digits=1),
#                    Q3 = round(quantile(time, 0.75,na.rm = TRUE), digits=1),
#                    Max = round(max(time,na.rm = TRUE), digits=1))

#### Change pending approval
verif_draw <-verif_draw %>% #group_by(Site) %>% filter(time>=0) %>%
  mutate(checktmvisit = case_when(as.numeric(time) < 0 ~ "Negative Time",
                                  as.numeric(time) <1 ~"Within 1 Day",
                                  as.numeric(time) < 3 ~ "1-3 Days",
                                  as.numeric(time) <30 ~ "4-30 Days",
                                  as.numeric(time) >= 30 ~ "More than 30 Days",
                                  TRUE ~ "Missing Time Stamp(s)"),
         checktmvisit = factor(checktmvisit, levels=c("Negative Time", "Within 1 Day", "1-3 Days",
                                                      "4-30 Days", "More than 30 Days", "Missing Time Stamp(s)")))

verif_draw_order <- create_tbl_cross(verif_draw, "checktmvisit", "Site", "column", " ", " ")
colnames(verif_draw_order)[ncol(verif_draw_order)] = "Total Draw Order Placements"



## Verification to Collection  by Campaign Type

verif_BL_Af <- coll_sett_all %>%  filter(d_331584571== 266600170 & !is.na(d_914594314) & !is.na(d_556788178) & d_914594314>=as.Date("2022-06-01")) %>%  
  mutate(time = as.numeric(difftime(as.POSIXct(ymd_hms(d_556788178)),as.POSIXct(ymd_hms(d_914594314)),units="days")),
         campaign = case_when((state_d_667474224==348281054 | state_d_667474224==324692899) ~ "Upcoming Appointment",
                               TRUE ~ "All Other Campaigns"),
         Site = factor(Site,levels=c("Baylor Scott and White Health","HealthPartners", "Henry Ford Health",
                                                     "Marshfield Clinic Health System",
                                                     "Sanford Health", "University of Chicago Medicine","Kaiser Permanente Colorado",
                                                     "Kaiser Permanente Georgia","Kaiser Permanente Hawaii","Kaiser Permanente Northwest"))) 

verif_baseline_Af <- verif_BL_Af %>% 
  group_by(Site) %>% 
  dplyr::summarize(#'Number of Baseline Collections1'=n()[campaign=="Upcoming Appointment"],
    'Number of Baseline Collections1' = sum(campaign == "Upcoming Appointment"),
    Min1 = round(min(time[campaign=="Upcoming Appointment"],na.rm = TRUE), digits=1),
    Median1 = round(median(time[campaign=="Upcoming Appointment"],na.rm = TRUE), digits=1),
    Mean1 = round(mean(time[campaign=="Upcoming Appointment"],na.rm = TRUE), digits=1),
    SD1= round(sd(time[campaign=="Upcoming Appointment"],na.rm = TRUE), digits=1),
    Max1 = round(max(time[campaign=="Upcoming Appointment"],na.rm = TRUE), digits=1),
    'Number of Baseline Collections2'=sum(campaign == "All Other Campaigns"),
    Min2 = round(min(time[campaign=="All Other Campaigns"],na.rm = TRUE), digits=1),
    Median2 = round(median(time[campaign=="All Other Campaigns"],na.rm = TRUE), digits=1),
    Mean2 = round(mean(time[campaign=="All Other Campaigns"],na.rm = TRUE), digits=1),
    SD2= round(sd(time[campaign=="All Other Campaigns"],na.rm = TRUE), digits=1),
    Max2 = round(max(time[campaign=="All Other Campaigns"],na.rm = TRUE), digits=1),
    'Total Number of Baseline Collections'=n()) %>%
  ungroup() %>%  
  select(Site,  'Number of Baseline Collections1', Min1, Median1, Mean1, SD1, Max1, 
         'Number of Baseline Collections2', Min2, Median2, Mean2, SD2, Max2, 'Total Number of Baseline Collections')


## Total Row
total_summary <- verif_BL_Af %>% 
  summarise(
    Site = "Total",
    'Number of Baseline Collections1' = sum(campaign == "Upcoming Appointment"),
    Min1    = round(min(time[campaign=="Upcoming Appointment"], na.rm = TRUE), 1),
    Median1 = round(median(time[campaign=="Upcoming Appointment"], na.rm = TRUE), 1),
    Mean1   = round(mean(time[campaign=="Upcoming Appointment"], na.rm = TRUE), 1),
    SD1     = round(sd(time[campaign=="Upcoming Appointment"], na.rm = TRUE), 1),
    Max1    = round(max(time[campaign=="Upcoming Appointment"], na.rm = TRUE), 1),
    'Number of Baseline Collections2' = sum(campaign == "All Other Campaigns"),
    Min2    = round(min(time[campaign=="All Other Campaigns"], na.rm = TRUE), 1),
    Median2 = round(median(time[campaign=="All Other Campaigns"], na.rm = TRUE), 1),
    Mean2   = round(mean(time[campaign=="All Other Campaigns"], na.rm = TRUE), 1),
    SD2     = round(sd(time[campaign=="All Other Campaigns"], na.rm = TRUE), 1),
    Max2    = round(max(time[campaign=="All Other Campaigns"], na.rm = TRUE), 1),
    'Total Number of Baseline Collections' = n()
  )

## Bind site + total
verif_baseline_Af_final <- bind_rows(verif_baseline_Af, total_summary)

```























```{r Table26_bldorder_present, include=FALSE, echo=FALSE, warning=FALSE}

## Draw Order Placement to Today for those with no blood colletion yet

avg_bldorder_present <- table1 %>%  filter(d_878865966=="No blood collected" & !is.na(d_173836415_d_266600170_d_769615780) & 
                                           Site!='HealthPartners' & Site!='Henry Ford Health'  & Site!='Sanford Health') %>%  
  mutate(time = as.numeric(difftime(currentDate,as.POSIXct(ymd_hms(d_173836415_d_266600170_d_769615780)),units="days"))) %>% 
  group_by(Site) %>% 
  dplyr::summarize('Number of Unfilled \n Blood Draw Orders'=n(),
                   Min = round(min(time,na.rm = TRUE), digits=1),
                   Q1 = round(quantile(time, 0.25,na.rm = TRUE), digits=1),
                   Median = round(median(time,na.rm = TRUE), digits=1),
                   Mean = round(mean(time,na.rm = TRUE), digits=1),
                   Q3 = round(quantile(time, 0.75,na.rm = TRUE), digits=1),
                   Perc.80= quantile(time, 0.80,na.rm = TRUE),
                   Perc.90= quantile(time, 0.90,na.rm = TRUE),
                   Perc.95= quantile(time, 0.95,na.rm = TRUE),
                   Max = round(max(time,na.rm = TRUE), digits=1))


```


```{r Table27, eval=TRUE,echo=FALSE,include=FALSE,results='hold'}

## Draw Order Status for KP Sites

Table_bld_draw= table1 %>%  filter(grepl("^Kaiser", Site)) %>% ## excluding hybrid sites
  mutate(Site = droplevels(Site),
         bld_placed= case_when(BioClin_BldOrderPlaced_v1r0=="Yes" ~ "Blood Draw Order Placed",
                               (BioClin_BldOrderPlaced_v1r0=="No" | is.na(BioClin_BldOrderPlaced_v1r0))~ "No Blood Draw Order Placed"),
         verif_bld= case_when(d_821247024==197316935 ~ 1,
                              TRUE ~ 0))  %>% 
  dplyr::select(Site, bld_placed)  %>% 
  tbl_cross(
  row = Site,
  col = bld_placed,
  percent = "row",
  digits=c(0,1),
  label=list(Site~"Site", bld_placed~" "), 
  missing="ifany",
  missing_text="Unknown") %>%
  bold_labels() %>%
  modify_header() %>%
  modify_caption("Table 4.9: Baseline Blood Draw Order Status Among Verified Participants") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE) %>%
  kable_styling(latex_options = "scale_down")




``` 

```{r Table26, warning=FALSE, eval=TRUE,echo=FALSE}


## Days since Verif for those with No Biospecimen Collection

ver_date_diff <-table1  %>% filter(biocol.appoint=="No Baseline Collection")  %>% 
  mutate(day_past = difftime(as.Date(currentDate), as.Date(d_914594314), units="days"),
         coll_days_diff = case_when(as.numeric(day_past)<30 ~ "< 30 Days",
                                    as.numeric(day_past)<60 ~ "30 to <60 Days",
                                    as.numeric(day_past)<90 ~ "60 to <90 Days",
                                    as.numeric(day_past)<180 ~ "90 to 180 Days",
                                    as.numeric(day_past)<270 ~ "180 to <270 Days",
                                    as.numeric(day_past)>=270 ~ "270 Days or More"),
         coll_days_diff = factor(coll_days_diff, levels=c("< 30 Days", "30 to <60 Days", "60 to <90 Days",
                                                          "90 to 180 Days", "180 to <270 Days", "270 Days or More")))


crosstable.coll_bptl1 <- create_tbl_cross(ver_date_diff, "Site", "coll_days_diff", "row", "Site", " ")



```

\newpage

# Baseline Collection Counts 
\vspace{-0.5em}
\FloatBarrier
```{r KnitrTables1, eval=TRUE,echo=FALSE,error=FALSE, message=FALSE, warning=FALSE, results='asis'}
options(knitr.table.format = "latex")
options(kableExtra.auto_format = FALSE)


biospe.t1  %>% kable_styling(latex_options = "scale_down")


settings_breakdown
  
```
\FloatBarrier
\newpage
```{r KnitrTables1.3, eval=TRUE,echo=FALSE,error=FALSE, message=FALSE,warning=FALSE,results='asis'}

col_num_1.1_gt 

```
\newpage
\FloatBarrier
```{r KnitrTables1.4, eval=TRUE,echo=FALSE,error=FALSE, message=FALSE,warning=FALSE,results='asis'}

col_num_1.2_gt 
```

\FloatBarrier
```{r KnitrTables1.5, eval=TRUE,echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, results='asis'}

add_footnote(SF_collections_tbl, 

             paste0("This table reflects Clincal Collections in the past 30 days; the total number of Clinical Collections at Sanford Health is ",
                    dim(table1_4_locations)[[1]]),
             notation = "none")

add_footnote(SF_top10_collections,footnote_text, notation= "none") 


```
\FloatBarrier
```{r KnitrTables1.7, eval=TRUE,echo=FALSE,error=FALSE, message=FALSE, warning=FALSE, results='asis'}
biospe.bld 
```

\FloatBarrier
```{r KnitrTables1.8, eval=TRUE,echo=FALSE,warning=FALSE, message=FALSE, results='asis'}

tab5=knitr::kable(distrb_allsetts_with_totals, 
                  caption='Table 1.8: Baseline Collection Setting Among Biospecimen Collections by Specimen Type', 
                  row.names=FALSE, align=c("l", rep("c", 3)), format.args = list(big.mark = ","), booktabs = TRUE)   
add_footnote(tab5, "Note: Blood and urine specimens are not collected in the Home setting, and mouthwash specimens are not collected in the Clinical setting.", 
             notation = "none")

```

\FloatBarrier
```{r KnitrTables1.9, eval=TRUE,echo=FALSE,warning=FALSE, message=FALSE, results='asis'}
tab5_1=knitr::kable(site_results["Henry Ford Health"], 
                    col.names=c("Collection Setting","Any Blood Collected", "Urine Collected", "Mouthwash Collected"), 
                    caption='Table 1.9: Baseline Collection Setting Among Biospecimen Collections by Specimen Type, Henry Ford Health', 
                    row.names=FALSE, align=c("l", rep("c", 3)), format.args = list(big.mark = ","), booktabs = TRUE)   
add_footnote(tab5_1, "Note: Blood and urine specimens are not collected in the Home setting, and mouthwash specimens are not collected in the Clinical setting.", 
             notation = "none")
```

\FloatBarrier
```{r KnitrTables1.10, eval=TRUE,echo=FALSE,warning=FALSE, message=FALSE, results='asis'}
tab5_2=knitr::kable(site_results["HealthPartners"], 
                    col.names=c("Collection Setting","Any Blood Collected", "Urine Collected", "Mouthwash Collected"), 
                    caption='Table 1.10: Baseline Collection Setting Among Biospecimen Collections by Specimen Type, HealthPartners', 
                    row.names=FALSE, align=c("l",rep("c", 3)), format.args = list(big.mark = ","), booktabs = TRUE)   
add_footnote(tab5_2, "Note: Blood and urine specimens are not collected in the Home setting, and mouthwash specimens are not collected in the Clinical setting.", 
             notation = "none")
```

\FloatBarrier
```{r KnitrTables1.11, eval=TRUE,echo=FALSE,warning=FALSE, message=FALSE, results='asis'}

tab5_3=knitr::kable(site_results["Sanford Health"], 
                    col.names=c("Collection Setting","Any Blood Collected", "Urine Collected", "Mouthwash Collected"), 
                    caption='Table 1.11: Baseline Collection Setting Among Biospecimen Collections by Specimen Type, Sanford Health', 
                    row.names=FALSE, align=c("l",rep("c", 3)), format.args = list(big.mark = ","), booktabs = TRUE)
add_footnote(tab5_3, "Note: Blood and urine specimens are not collected in the Home setting, and mouthwash specimens are not collected in the Clinical setting.", 
             notation = "none")
```

\FloatBarrier
```{r KnitrTables1.12, eval=TRUE,echo=FALSE,warning=FALSE, message=FALSE, results='asis'}

tab5_4=knitr::kable(site_results["University of Chicago Medicine"], 
                    col.names=c("Collection Setting","Any Blood Collected", "Urine Collected", "Mouthwash Collected"), 
                    caption='Table 1.12: Baseline Collection Setting Among Biospecimen Collections by Specimen Type, University of Chicago Medicine', 
                    row.names=FALSE, align=c("l",rep("c", 3)), format.args = list(big.mark = ","), booktabs = TRUE)
add_footnote(tab5_4, "Note: Blood and urine specimens are not collected in the Home setting, and mouthwash specimens are not collected in the Clinical setting.", 
             notation = "none")
```

```{r KnitrTables1.13, eval=TRUE,echo=FALSE,warning=FALSE, message=FALSE, results='asis'}
# NEED TO CHECK: Missing this code chunk







```



\FloatBarrier
```{r KnitrTables1.14_1.16, eval=TRUE,echo=FALSE,warning=FALSE, message=FALSE, results='asis'}

BLCol_by_Sex

BLCol_by_Age 

BLCol_by_Race

```



\FloatBarrier
\newpage
\newpage
# Baseline Collection Completeness
\vspace{-0.5em}

Tables in this section only take into account tubes obtained during the first finalized collection, which may or may not have included all specimen types and does not include specimens collected during re-draw collections. For actual tube counts and deviations, reference the BSI.

\FloatBarrier

```{r KnitrTables5, eval=TRUE,echo=FALSE,error=FALSE, message=FALSE, warning=FALSE, results='asis'}



knitr::kable(spec_by_site_R , 
             caption='Table 2.1: Baseline Research Biospecimens Collected by Specimen Type', 
             row.names=FALSE,align=c("l",rep("c", 6)), booktabs = TRUE)  %>% 
  kable_styling(latex_options = "scale_down")




knitr::kable(spec_by_site_C, 
             caption='Table 2.2: Baseline Clinical Biospecimens Collected by Specimen Type', 
             row.names=FALSE,align=c("l",rep("c", 9)), booktabs = TRUE)  %>% 
  column_spec(1, width = "4cm") %>% #make longer row name wrap into 2 lines
  kable_styling(latex_options = "scale_down") 


```


```{r KnitrTables7.3_11,echo=FALSE,error=FALSE,message=FALSE,warning=FALSE,results='asis'}



tab2_8= knitr::kable(bloodtubetype_R, 
                     caption='Table 2.3: Baseline Blood Tubes Collected Among Research Collections by Tube Type', 
                     row.names=FALSE,align=c("l",rep("c", 10)), booktabs = TRUE) %>%  
  add_indent(seq(1, nrow(bloodtubetype_R) - 1))  %>% 
  kable_styling(latex_options = "scale_down")
add_footnote(tab2_8, "Note: Collection of ACD tube was discontinued on 03/01/2024; Collection of Heparin tube was discontinued on 03/26/2025; Streck tube is only collected at certain sites .", notation = "none")






tab8=knitr::kable(bloodtubetype_C,
                  caption='Table 2.4: Baseline Blood Tubes Collected Among Clinical Biospecimen Collections by Tube Type',
                  row.names=FALSE,align=c("l", rep("c", 13)), booktabs = TRUE) %>%  
  add_indent(seq(1, nrow(bloodtubetype_C) - 1))  %>% 
  kable_styling(latex_options = "scale_down", full_width = FALSE)   %>% 
  landscape()
add_footnote(tab8, "Note: Tube configuration/quantity varies by site based on clinical lab supply to achieve collection closest to the desired volume of 20mL SST, 10mL EDTA, 10mL Heparin, 6mL ACD and 10mL Streck. Collection of ACD tube was discontinued on 03/01/2024; Collection of Heparin tube was discontinued on 06/01/2025; Streck tube collection was introduced at different time points and is only collected at certain sites", notation = "none") %>% 
  add_footnote(" Note: This table only takes into account tubes obtained during the first finalized Clinical collection, which may or may not have included blood and does not include tubes collected during re-draw collections. For actual tube counts, reference the BSI.", notation="none")



devns <- knitr::kable(Deviation_Freq,
             col.names=c("Site","Any Deviations","No Deviations", "Total Tubes Collected"), 
             caption='Table 2.5: Baseline- Deviation Status Among Biospecimen Tubes Collected',
             row.names=FALSE, align=c("l",rep("c", 3)), booktabs = TRUE )
add_footnote(devns, "Note: This table includes deviations on all baseline specimens except home mouthwash.", notation = "none") 

```


```{r KnitrTables13,echo=FALSE,error=FALSE,message=FALSE,warning=FALSE,results='asis'}


tabe2_12 <- knitr::kable(reason_notcol,  
                         caption='Table 2.6: Baseline- Reason Not Collected Among Research Collection Tubes Not Collected', 
                         row.names=FALSE,align=c("l",rep("c", 7)), booktabs = TRUE) %>%  
  add_indent(seq(1, nrow(reason_notcol) - 1)) %>% 
  kable_styling(latex_options = "scale_down")
add_footnote(tabe2_12,"Note: The 'Short Draw' is applicable to blood collection tubes only.", notation="none")



tubes2_12 <- knitr::kable(tube_type_notcolreasons,  
                          caption='Table 2.7: Baseline- Reason Not Collected Among Research Collection Tubes Not Collected by Tube Type',
                          row.names=FALSE,align=c("l",rep("c", 7)), booktabs = TRUE)  %>%  
  add_indent(seq(1, nrow(tube_type_notcolreasons) - 1))  %>% 
  kable_styling(latex_options = "scale_down")
add_footnote(tubes2_12, "Note: 'Short Draw' reason applicable to blood collection tubes only.", notation="none")



knitr::kable(discard.site, 
             caption='Table 2.8: Baseline- Discarded Tubes Among Biospecimen Collections by Tube Type', 
             row.names=FALSE,  
             align=c("l",rep("c", 10)), booktabs = TRUE) %>%
  kable_styling(latex_options = "scale_down")

```

\newpage
\newpage
\FloatBarrier
# Baseline Biospecimen Survey
\vspace{-0.5em}
\FloatBarrier
```{r KnitrTables14,echo=FALSE,error=FALSE,message=FALSE,warning=FALSE,results='asis'}


knitr::kable(BUM_status,  
             caption='Table 3.1: Baseline Biospecimen Survey Status Among Research Collections', 
             row.names=FALSE,align=c("l",rep("c", 6)), booktabs = TRUE)  %>% 
  kable_styling(latex_options = "scale_down")

```




```{r KnitrTables15_16,echo=FALSE,error=FALSE,message=FALSE,warning=FALSE, results='asis'}

knitr::kable(BU_status, 
             caption='Table 3.2: Baseline Biospecimen Survey Status Among Clinical Collections', 
             row.names=FALSE,align=c("l",rep("c", 8)), booktabs = TRUE)  %>% 
  kable_styling(latex_options = "scale_down")



tbl19a <-knitr::kable(precovid_BUMtime, 
                      caption='Table 3.3: Baseline Biospecimen Survey Completion Time from Research Collection Visit Check In \n (Pre-COVID- 19 Questions Removal)',
                      row.names=FALSE,align=c("l",rep("c", 6)), booktabs = TRUE)  %>% 
  kable_styling(latex_options = "scale_down")
add_footnote(tbl19a,"Note: The COVID-19 survey questions were separated from the Biospecimen Survey on July 5, 2023.", notation = "none") 



tbl19b <- knitr::kable(postcovid_BUMtime, 
                       caption='Table 3.4: Baseline Biospecimen Survey Completion Time from Research Collection Visit Check In \n (Post- COVID-19 Questions Removal)',
                       row.names=FALSE,align=c("l",rep("c", 6)), booktabs = TRUE)  %>% 
  kable_styling(latex_options = "scale_down")
add_footnote(tbl19b,"Note: The COVID-19 survey questions were separated from the Biospecimen Survey on July 5, 2023.", notation = "none") 

```


\newpage
\FloatBarrier

```{r Figures1_3, echo=FALSE, message=FALSE,warning=FALSE, eval=TRUE}

research.4_1
research.4_2
research.4_3

```

\newpage
\FloatBarrier
```{r KnitrTables17_20,echo=FALSE,error=FALSE,message=FALSE,warning=FALSE,results='asis'}

knitr::kable(coll_comp_BU, 
             caption='Table 3.5: Baseline Clinical Biospecimen Survey Complete Time from Collection Time', 
             row.names=FALSE,align=c("l", rep("c", 8)), booktabs = TRUE)  %>% kable_styling(latex_options = "scale_down")

# knitr::kable(BU_coll_DB_comp,
#              caption='Table 3.5.a Time (in Hours) From Clinical Biospecimen Collection to Biospecimen Dashboard Entry',
#              row.names=FALSE, align=c("l", rep("c", 9)),digits=1, booktabs = TRUE) %>%
#   kable_styling(latex_options = "scale_down")
# 
# 
# knitr::kable(BU_trig_comp,
#              caption='Table 3.5.b Baseline Clinical Biospecimen Survey Complete Time (in Hours) From Survey Becoming Available',
#              row.names=FALSE, align=c("l", rep("c", 9)),digits=1, booktabs = TRUE) %>%
#   kable_styling(latex_options = "scale_down")




tab21_rb=knitr::kable(Table21R_Before,
                      caption='Table 3.6: Baseline Biospecimen Survey Completion Length (in Minutes) Among Submitted \n Research Surveys (Pre-COVID-19 Questions Removal)',
                      row.names=FALSE, align=c("l", rep("c", 11)),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "scale_down")
add_footnote(tab21_rb,"Note: The COVID-19 survey questions were separated from the Biospecimen Survey on July 5, 2023. Research biospecimen surveys with a negative completion time have been excluded.",notation = "none")




tab21_ra=knitr::kable(Table21R_After,
                      caption='Table 3.7: Baseline Biospecimen Survey Completion Length (in Minutes) Among Submitted \n Research Surveys (Post-COVID-19 Questions Removal)',
                      row.names=FALSE, align=c("l", rep("c", 11)),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "scale_down")
add_footnote(tab21_ra,"Note: The COVID-19 survey questions were separated from the Biospecimen Survey on July 5, 2023. ", notation = "none")





tab21_cb=knitr::kable(ClinSrvy_Lgth_Before,
                      caption='Table 3.8: Baseline Biospecimen Survey Completion Length (in Minutes) Among Submitted Clinical Surveys \n (Pre-COVID-19 Questions Removal)',
                      row.names=FALSE, align=c("l", rep("c", 10)),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "scale_down")
add_footnote(tab21_cb,"Note: The COVID-19 survey questions were separated from the Biospecimen Survey on July 5, 2023.", notation = "none")




tab21_ca=knitr::kable(ClinSrvy_Lgth_After,
                      caption='Table 3.9: Baseline Biospecimen Survey Completion Length (in Minutes) Among Submitted Clinical Surveys \n (Post-COVID-19 Questions Removal)',
                      row.names=FALSE, align=c("l", rep("c", 10)),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "scale_down")
add_footnote(tab21_ca,"Note: The COVID-19 survey questions were separated from the Biospecimen Survey on July 5, 2023.", notation = "none")
```


\newpage
\FloatBarrier
# Baseline Collection Activity Durations
\vspace{-0.5em}
\FloatBarrier
```{r KnitrTables20,echo=FALSE,error=FALSE,message=FALSE,warning=FALSE,results='asis'}

tab23=knitr::kable(research.vt.length.table,
                   caption='Table 4.1: Baseline Research Collection Visit Length (in Minutes)',
                   row.names=FALSE, align=c("l", rep("c", 9)),digits=1, booktabs = TRUE)%>% 
  kable_styling(latex_options = "scale_down") 
add_footnote(tab23,"Note: Expected visit length for each site is as follows: (1) HealthPartners: 25-60 minutes, (2) Henry Ford: 25-60 minutes, (3) Sanford: 10-45 minutes, (4) Marshfield: 10-45 minutes, (5) UChicago: 15-180 minute, and (6) BSWH: 25-60 minutes", notation = "none") 

```

\FloatBarrier
```{r newFig5, eval=TRUE,echo=FALSE, warning=FALSE, message=FALSE}

UC_Time
```


```{r KnitrTable21_26,echo=FALSE,error=FALSE,message=FALSE,warning=FALSE,results='asis'}

knitr::kable(verif_BSL_colctD,
                      caption='Table 4.2: Baseline- Time (in Days) from Verification to Research Collection Among Participants Verified on or After 8/01/2022',
                      row.names=FALSE, align=c("l", rep("c", 8)),digits=1, booktabs = TRUE)  %>% 
  kable_styling(latex_options = "scale_down") %>% 
  kableExtra::footnote(general = "August 2022 marks when research collection appointments were routinely offered to all new recruits at or near the time of verification. UChicago participant verification largely occurs at or near the time of collection.",
           footnote_as_chunk = TRUE, 
           escape = FALSE, 
           threeparttable = TRUE) %>% 
  footnote(paste0(nrow(baseline_colctC), " research collection visits occurred for participants verified before 8/1/2022."))

# add_footnote(tabbB,
#              paste0("Note: August 2022 marks when research collection appointments were routinely offered to all new recruits at or near the time of verification. UChicago participant verification largely occurs at or near the time of collection.
#                     Note: ",
#                nrow(BSL_colctD), 
#                    " research collection visits occurred for participants verified before 8/1/2022. "),
#              notation = "none")



BSL_A <- knitr::kable(verif_BSL_colctA,
                      caption='Table 4.3: Baseline- Time (in Days) from Verification to Clinical Collection Among Participants Verified Before 2/01/2023',
                      row.names=FALSE, align=c("l", rep("c", 8)),digits=1, booktabs = TRUE)  %>% 
  kable_styling(latex_options = "scale_down") 

add_footnote(BSL_A,"Note: Baseline Clinical Collections were launched in February 2023 at the KP sites; June 2023 at Henry Ford; December 2023 at HealthPartners; April 2024 at Sanford; June 2024 at UChicago.", notation = "none") %>% 
  add_footnote(" Note: Data reflected in this table are an estimate, based on when samples were finalized in the Biospecimen Dashboard, actual collections would have occurred prior to the Connect team receiving the samples.", notation="none")



BSL_B <-knitr::kable(verif_BSL_colctB,
                     caption='Table 4.4: Baseline- Time (in Days) from Verification to Clinical Collection Among Participants Verified on or After 2/01/2023',
                     row.names=FALSE,  align=c("l", rep("c", 8)),digits=1, booktabs = TRUE)  %>% 
  kable_styling(latex_options = "scale_down")
add_footnote(BSL_B,"Note: Baseline Clinical Collections were launched in February 2023 at the KP sites; June 2023 at Henry Ford; December 2023 at HealthPartners; April 2024 at Sanford; June 2024 at UChicago.", notation = "none")



AF26 <- knitr::kable(verif_baseline_Af_final,
                     caption = 'Table 4.5: Baseline- Time (in Days) from Verification to Collection Among Participants Verified on or After 6/01/2022 by Campaign Type',
                     row.names=FALSE, booktabs = T, linesep = "", format.args = list(big.mark = ","), 
                     align = c("l",  rep("c", 13)), 
                     col.names=c("Site",  'Number of Collections',"Min", "Median", "Mean", "SD", "Max", 'Number of Collections', 
                                 "Min", "Median", "Mean", "SD", "Max","Total Baseline Collections") ) %>% 
  kable_styling(latex_options = "scale_down") %>% 
  add_indent(seq(1, nrow(verif_baseline_Af_final)-1)) %>% 
  add_header_above(c(" " = 1, "Upcoming Appointment" = 6, "All Other Campaigns" = 6,  " "=1)) %>% landscape() 
add_footnote(AF26, "Note: Upcoming Appointment includes Screening appointment and Non-screening appointment campaign types. All Other Campaigns include Random, Demographic Group, Aging out of study, Geographic group, Post-Screening Selection, Technology adapters, Low-income/health professional shortage areas, and Other campaign types.", notation = "none")




tabl27 <- knitr::kable(verif_draw_order,
                       caption='Table 4.6: Baseline- Time (in Days) from Verification to Draw Order Placement',
                       row.names=FALSE, align=c("l", rep("c", 3)),digits=1, booktabs = TRUE)  %>% 
  kable_styling(latex_options = "scale_down")
add_footnote(tabl27, "Time from verification to draw order placement calculated for participants verified on or after February 1, 2023. HealthPartners, University of Chicago Medicine and Sanford Health are excluded due to the limited availability of draw order placement data. Henry Ford is excluded because participants have collection type options, therefore, the placement of draw orders post-verification may be delayed.", notation="none")



tab4_9 <- knitr::kable(avg_draw_order, 
                       caption='Table 4.7: Baseline- Time (in Days) from Draw Order Placement to Clinical Collection', 
                       row.names=FALSE, align=c("l", rep("c", 11)),digits=1, booktabs = TRUE) %>% 
  kable_styling(latex_options = "scale_down") 
add_footnote(tab4_9, "Note: HealthPartners, University of Chicago Medicine and Sanford Health are excluded due to the limited availability of draw order placement data.", notation="none")



tab4_10 <- knitr::kable(avg_bldorder_present, 
                        caption='Table 4.8: Baseline- Time (in Days) from Blood  Draw Order Placement to Present Date by Site \n for Participants with No Baseline Clincial Blood Collection', 
                        row.names=FALSE, align=c("l", rep("c", 11)),digits=1, booktabs = TRUE) %>% 
  column_spec(2, width = "4cm") %>% #make longer column name wrap into 2 lines
  kable_styling(latex_options = "scale_down") 
add_footnote(tab4_10, "Note: Table includes information for Kaiser sites only, other clinical collection sites are excluded.", notation="none")



add_footnote(Table_bld_draw , "Note: Table includes information for Kaiser sites only, other clinical collection sites are excluded.", notation="none")



knitr::kable(crosstable.coll_bptl1, 
             col.names=c("Site", "< 30 Days", "30 to <60 Days","60 to <90 Days", "90 to <180 Days", "180 to <270 Days", 
                         "270 Days or More", "Total Participants with No Basline Collections"), 
             caption='Table 4.10: Baseline- Time (in Days) Since Verification Among Participants with No Biospecimen Collection ', 
             row.names=FALSE, align=c("l", rep("c", 7)), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down") 

```

\newpage
\newpage
\FloatBarrier
# Baseline Collection-To-Receipt Times
\vspace{-0.5em}
\FloatBarrier
```{r KnitrTable28_30,echo=FALSE,error=FALSE,message=FALSE,warning=FALSE,results='asis'}

all_rsch_days <- knitr::kable(research_coll_bptl1, 
             col.names=c("Site", "1 Day", "2 Days", "3 Days", "4 Day", ">4 Days", "Total Received Research Collections"), 
             caption='Table 5.1: Baseline Collection-To-Receipt Time (in Days) Among Research Collections', 
             row.names=FALSE, align=c("l", rep("c", 5)), booktabs = TRUE) %>% kable_styling(latex_options = "scale_down")
add_footnote(all_rsch_days, paste0("At the time of reporting, ", dim(biospe_adhoc_missings)[[1]], 
                                   " of the Research Collections do not have not receipt date/time information available."), 
             notation="none")
```

\FloatBarrier
```{r Rsch_clt_days,echo=FALSE,error=FALSE,message=FALSE,warning=FALSE,results='asis'}


rsch_coll_times52

```

\FloatBarrier
```{r clin_clt_days,echo=FALSE,error=FALSE,message=FALSE,warning=FALSE,results='asis'}
clin_bptl <- knitr::kable(crosstable.clin_coll_days, 
             col.names=c("Site", "1 Day", "2 Days", "3 Days", "4 Days", ">4 Days", "Total Received Clinical Collections"), 
             caption='Table 5.3: Baseline Collection-To-Receipt Time (in Days) Among Clinical Collections', 
             row.names=FALSE, align=c("l", rep("c", 6)), booktabs = TRUE) %>% 
  kable_styling(latex_options = "scale_down")
add_footnote(clin_bptl, paste0("At the time of reporting, ", dim(biospe_adhoc2_missings)[[1]], 
                               " of the Clinical Collections did not have collection and/or receipt date/time information available."), notation="none")
```

\FloatBarrier
```{r clin_loc_clt_days,echo=FALSE,error=FALSE,message=FALSE,warning=FALSE,results='asis'}

ctable_clin_loc_bptl

```



\newpage
\FloatBarrier
\newpage
\newpage

```{r Figs6_14_Plots, warning=FALSE, eval=TRUE,echo=FALSE, message=FALSE}

## Collection to Receipt Times, Stratified by Appt Day of the Week

coll_bptl_diff <- coll_bptl_diff %>% 
  mutate(hrs_past = difftime(as.POSIXct(ymd_hms(any_collection)), as.POSIXct(ymd_hms(d_678166505)), units="hours"),
         hrs_past = as.numeric(hrs_past),
         Weekdays = factor(weekdays(as.Date(d_678166505))),
         Weekdays = factor(Weekdays,levels=c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"))) %>%  
  filter(hrs_past>0)



coll_bptl_diff2 <- coll_bptl_diff2 %>% 
  mutate(hrs_past = difftime(as.POSIXct(ymd_hms(any_collection)), as.POSIXct(ymd_hms(clin_coll_bu)), units="hours"),
         hrs_past = as.numeric(hrs_past),
         Weekdays = factor(weekdays(as.Date(clin_coll_bu))),
         Weekdays = factor(Weekdays,levels=c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday")))




scatMF <- coll_bptl_diff %>%  filter(Site=="Marshfield Clinic Health System")
scatSF <- coll_bptl_diff %>%  filter(Site=="Sanford Health")
scatUC <- coll_bptl_diff %>%  filter(Site=="University of Chicago Medicine")
scatRHF <- coll_bptl_diff %>%  filter(Site=="Henry Ford Health")
scatRHP <- coll_bptl_diff %>%  filter(Site=="HealthPartners")

scatKPCO <- coll_bptl_diff2 %>%  filter(Site=="Kaiser Permanente Colorado")
scatKPGA <- coll_bptl_diff2 %>%  filter(Site=="Kaiser Permanente Georgia")
scatKPHI <- coll_bptl_diff2 %>%  filter(Site=="Kaiser Permanente Hawaii")
scatKPNW <- coll_bptl_diff2 %>%  filter(Site=="Kaiser Permanente Northwest")
scatCHF <- coll_bptl_diff2 %>%  filter(Site=="Henry Ford Health")
scatCHP <- coll_bptl_diff2 %>%  filter(Site=="HealthPartners")
scatCSF <- coll_bptl_diff2 %>%  filter(Site=="Sanford Health")
scatCUC <- coll_bptl_diff2 %>%  filter(Site=="University of Chicago Medicine")


scatRHP$coldate <- scatRHP$d_678166505
scatCHP$coldate <- scatCHP$clin_coll_bu
scatCSF$coldate <- scatCSF$clin_coll_bu
scatCUC$coldate <- scatCUC$clin_coll_bu
scatRHF$coldate <- scatRHF$d_678166505
scatCHF$coldate <- scatCHF$clin_coll_bu


weekday_order <- c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday")


research_plot <- function(df, start_date, plot_title){
  ggplot(df, aes(x=as.Date(d_678166505), y=hrs_past, color = Weekdays)) + 
  geom_point() + scale_x_date(name="Collection Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", 
                              limits=c( as.Date(start_date),as.Date(currentDate)-7), expand=c(0,0)) + 
  scale_y_continuous(name="Number of Hours",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  scale_color_manual(values=c("Sunday"="#B1C7D9", "Monday"="#164C71", "Tuesday"="#FDBE19", "Wednesday"="#FBE5B5", 
                              "Thursday"="#565C65", "Friday"="#3C989E", "Saturday"="#CC7D15")) +
  theme(panel.background = element_blank(),         
        legend.position = "bottom",        
        axis.line = element_line(size=0.2),        
        axis.text.x=element_text(angle=60, hjust=1), 
        axis.title.x = element_text( size = 14, face = "bold") ,         
        axis.title.y = element_text(size = 14, face = "bold",color="black"),         
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +     
  theme(plot.caption = element_text(hjust=0))  + ggtitle(label=plot_title)
}


clinical_plot <- function(df, start_date, plot_title){
  ggplot(df, aes(x = as.Date(clin_coll_bu), y = hrs_past, color = factor(weekdays(as.Date(clin_coll_bu))))) + 
  geom_point() + scale_x_date(name="Collection Date",date_labels = "%y-%m-%d", date_breaks = "2 weeks", 
                              limits=c( as.Date(start_date),(as.Date(currentDate)-7)), expand=c(0,0)) + 
  scale_y_continuous(name="Number of Hours",  breaks=seq(0,168,24), limits = c(0, 168), expand = c(0, 0)) +
  scale_color_manual(values=c("Sunday"="#B1C7D9", "Monday"="#164C71", "Tuesday"="#FDBE19", "Wednesday"="#FBE5B5", 
                              "Thursday"="#565C65", "Friday"="#3C989E", "Saturday"="#CC7D15")) +
    theme(panel.background = element_blank(),
        legend.title = element_text(size=7),
        legend.position = "bottom",
        axis.line = element_line(size=0.2),
        axis.text.x=element_text(angle=60, hjust=1),
        axis.title.x = element_text( size = 14, face = "bold") ,
        axis.title.y = element_text(size = 14, face = "bold",color="black"),
        plot.title = element_text(hjust = 0.5,size = 12, face = "bold")) +
    theme(plot.caption = element_text(hjust=0), legend.title = element_text(size = 8.5))  +  
    ggtitle(label=plot_title) +
    labs(color = "Weekdays")
  }



research_plot(scatMF, "2022-06-20", "Figure 5.1: Baseline Collection-To-Receipt Time (in Hours), \n Marshfield")

research_plot(scatSF, "2022-06-20", "Figure 5.2: Baseline Collection-To-Receipt Time (in Hours), \n Sanford Health Research Setting")
clinical_plot(scatCSF, "2024-03-25", "Figure 5.3: Baseline- Collection-To-Receipt Time (in Hours), \n Sanford Health Clinical Setting")

research_plot(scatUC, "2022-06-20", "Figure 5.4: Baseline Collection-To-Receipt Time (in Hours),  \n University of Chicago Medicine Research Setting")
clinical_plot(scatCUC, "2024-03-25", "Figure 5.5: Baseline- Collection-To-Receipt Time (in Hours), \n University of Chicago Medicine Clinical Setting")

clinical_plot(scatKPCO, "2022-10-10", "Figure 5.6: Baseline Collection-To-Receipt Time (in Hours),  \n Kaiser Permanente Colorado")
clinical_plot(scatKPGA, "2022-10-10", "Figure 5.7: Baseline Collection-To-Receipt Time (in Hours),  \n Kaiser Permanente Georgia")
clinical_plot(scatKPHI, "2022-10-10", "Figure 5.8: Baseline Collection-To-Receipt Time (in Hours),  \n Kaiser Permanente Hawaii")
clinical_plot(scatKPCO, "2022-10-10", "Figure 5.9: Baseline Collection-To-Receipt Time (in Hours),  \n Kaiser Permanente Northwest")

research_plot(scatRHP, "2022-06-20", "Figure 5.10: Baseline- Collection-To-Receipt Time (in Hours), \n HealthPartners Research Setting")
clinical_plot(scatCHP, "2023-10-23", "Figure 5.11: Baseline- Collection-To-Receipt Time (in Hours), \n HealthPartners Clinical Setting")

research_plot(scatRHF, "2022-06-20", "Figure 5.12: Baseline- Collection-To-Receipt Time (in Hours), \n Henry Ford Research Setting")
clinical_plot(scatCHF, "2023-04-24", "Figure 5.13: Baseline- Collection-To-Receipt Time (in Hours), \n Henry Ford Clinical Setting")


```





\newpage

# Baseline Weekly Biospecimen Collection
\vspace{-0.5em}
\FloatBarrier

```{r Section6_Plot_Function, include=FALSE}

## Weekly Collections by Site

### Plots for All Sites, by Site, and by Site and Collection Setting
Section6_plot_function <- function(data, start_date, title, site = "all", color_by_setting = FALSE, color_var = NULL) {
  
  # Will either look at All Sites or by Site
  if (site != "all") {
    data <- data %>% filter(Site == site)
  }
  
  # To stratify by Collection Setting or Site location
  if (color_by_setting && !is.null(color_var)) {
    weekly_counts <- data %>% 
      arrange(col.Monday.date) %>% 
      group_by(col.Monday.date, .data[[color_var]]) %>% 
      tally()
    
    plt <- ggplot(weekly_counts, aes(x = as.Date(col.Monday.date), y = n, color = .data[[color_var]])) +
      scale_color_manual(values = c("Clinical" = "#164C71", "Research" = "#FDBE19")) +
      labs(color = "Collection Setting")
    
  } else {
    weekly_counts <- data %>% 
      arrange(col.Monday.date) %>% 
      group_by(col.Monday.date) %>% 
      tally()
    
    plt <- ggplot(weekly_counts, aes(x = as.Date(col.Monday.date), y = n))
  }
  

  plot6 <- plt +
    geom_line() +
    geom_point(width = 0.2) +
    scale_y_continuous(name = "Number of Collections") +
    scale_x_date(name = "Date", date_labels = "%y-%m-%d", date_breaks = "4 weeks",limits = c(as.Date(start_date), as.Date(currentDate) - 7), expand = c(0, 0)) +
    ggtitle(label = title) +
    theme(panel.background = element_blank(),
          legend.title = element_text(size = 7),
          legend.position = "bottom",
          axis.line = element_line(size = 0.2),
          axis.text.x = element_text(angle = 60, hjust = 1),
          axis.title.x = element_text(size = 14, face = "bold"),
          axis.title.y = element_text(size = 14, face = "bold", color = "black"),
          plot.title = element_text(hjust = 0.5, size = 12, face = "bold")) +
    guides(fill = guide_legend(nrow = 2, byrow = TRUE))

  return(plot6)
}



```



```{r Section6_Plot_Function2, include=FALSE}

## Weekly Collections by Site

### Plots by Site and Collection Setting
Section6_plot_function2 <- function(data, start_date, title, site, settings, color_var) {

    data <- data %>% filter(Site == site & all_settings== settings)
    
    weekly_counts <- data %>% 
      arrange(col.Monday.date) %>% 
      group_by(col.Monday.date, .data[[color_var]]) %>%
      tally() 
  
  # Startify by Clinical/Research Site Location
  if (site == "Henry Ford Health" && settings=="Research"){
    
    plt <- ggplot(weekly_counts, aes(x = as.Date(col.Monday.date), y = n, color = .data[[color_var]])) +
      scale_color_manual(name = "Collection Location",
                     values=c("HFH K-13 Research Clinic"="#164C71", "HFH Cancer Pavilion Research Clinic"="#FDBE19", 
                              "HFH Livonia Research Clinic"="#3C989E", "HFH Pop-Up"="#CC7D15",
                              "HFH Detroit Northwest"="#BBBEC1", "In-home Collection"="#2973A5",
                              "HFH Jackson"="#B9D7E3"),
                     guide = guide_legend(nrow = 3, byrow = TRUE)) +
      labs(color = "Collection Location")
    
  } else if(site == "Henry Ford Health" && settings=="Clinical"){
    
    plt <- ggplot(weekly_counts, aes(x = as.Date(col.Monday.date), y = n, color = .data[[color_var]])) +
    scale_color_manual(values=c("Wyandotte"="#B1C7D9", "Macomb"="#164C71", "West Bloomfield"="#FDBE19", "Royal Oak"="#F8D991", 
                              "Fairlane (Dearborn)"="#565C65", "Columbus"= "#3C989E", "Plymouth"="#CC7D15", "Troy"="#DAB384",
                              "Taylor"="#7C94A8","Brownstown"="#2973A5",
                              "Livonia"="#BBBEC1", "Ford Road"="#99C0C4", "NCO"="#B9D7E3", "Sterling Heights"="#309EBD", "K1 HFH Main"="#97C4D5", 
                              "E Jefferson Pathology"="#74B0C7", "Woodhaven Pathology" = "#FBE5B5")) + 
  labs(color = "Clinic Location")
  } else if(site == "University of Chicago Medicine" && settings=="Research"){
    
    plt <- ggplot(weekly_counts, aes(x = as.Date(col.Monday.date), y = n, color = .data[[color_var]])) +
      scale_color_manual(values=c("Ingalls Harvey"="#B1C7D9", "Orland Park"="#2973A5", "River East"="#FDBE19", 
                                "South Loop"="#565C65", "UC-DCAM"="#3C989E", "UCM Pop-Up"="#CC7D15"),
                       guide = guide_legend(nrow = 2, byrow = TRUE)) +
    labs(color = "Collection Location")
  } else if(site == "University of Chicago Medicine" && settings=="Clinical"){
     
    #UC more recently had clinical collections, harder to follow counts when 0 isn't explicitly marked 
    weekly_countsUC_Clin <- data %>% 
      arrange(col.Monday.date) %>%
      group_by(col.Monday.date, .data[[color_var]]) %>%
      tally() %>% ungroup() %>%
      complete(col.Monday.date = seq(min(col.Monday.date), max(col.Monday.date), by = "1 week"), 
               .data[[color_var]], fill = list(n = 0))
    
    plt <- ggplot(weekly_countsUC_Clin, aes(x = as.Date(col.Monday.date), y = n, color = .data[[color_var]])) +
      scale_color_manual(values = c("Orland Park" = "#2973A5", "River East" = "#FDBE19", 
                                  "South Loop" = "#565C65", "Kenwood" = "#3C989E", "Ingalls"="#B1C7D9",
                                  "DCAM (Hyde Park)"="#164C71", "Dearborn Station" = "#CC7D15", "Crown Point"="#309EBD"),
                       guide = guide_legend(nrow = 3, byrow = TRUE)) +
    labs(color = "Clinic Location") 
  } else if(site == "Marshfield Clinic Health System" && settings=="Research"){
    
    plt <- ggplot(weekly_counts, aes(x = as.Date(col.Monday.date), y = n, color = .data[[color_var]])) +
      scale_color_manual(values=c("Lake Hallie"="#B1C7D9", "Marshfield"="#164C71", "MF Pop-Up"="#FDBE19", 
                                "Minocqua"="#565C65", "Weston"="#3C989E", "Wisconsin Rapids"="#CC7D15",
                                "Neillsville"="#309EBD"),
                       guide = guide_legend(nrow = 2, byrow = TRUE)) +
    labs(color = "Collection Location") 
  } else if(site == "Sanford Health" && settings=="Research"){
    
    plt <- ggplot(weekly_counts, aes(x = as.Date(col.Monday.date), y = n, color = .data[[color_var]])) +
      scale_color_manual(values=c("Fargo South University"="#3C989E", "Sioux Falls Imagenetics"="#CC7D15",
                                "Edith Sanford Breast Center (coded as Sanford Center)"="#FDBE19", 
                                "Edith Sanford Breast Center"="#2973A5","Fargo Amber Valley"="#309EBD")) +
    guides(color = guide_legend(nrow = 3, byrow = TRUE, title = "Collection Location")) +
    labs(color = "Collection Location") 
  } else if(site == "HealthPartners" && settings=="Clinical"){
      
    plt <- ggplot(weekly_counts, aes(x = as.Date(col.Monday.date), y = n, color = .data[[color_var]])) +
      scale_color_manual(values=c("NSC"="#99C0C4", "Elk River"="#565C65", "Chanhassen"="#CC7D15", "Park Nicollet Minneapolis Clinic"="#FDBE19",
                                "Brooklyn Center"="#3C989E", "Clinic Stillwater"="#2973A5", "New Richmond Clinic"="#E7CCAD" )) +
    labs(color = "Clinic Location") 
  } else if(site == "Baylor Scott and White Health" && settings=="Research"){
    
    plt <- ggplot(weekly_counts, aes(x = as.Date(col.Monday.date), y = n, color = .data[[color_var]])) +
      scale_color_manual(values=c("BCC- Fort Worth"="#B1C7D9", "BCC- HWC"="#164C71", "BCC- Worth St"="#FDBE19", 
                                "FW All Saints"="#565C65", "NTX Biorepository"="#3C989E",
                                "BCC- Plano"="#FBE5B5","BCC- Irving"="#E7CCAD","Irving"="#309EBD",
                                "North Garland"="#CC7D15", "Temple CDM"="#BBBEC1", "Temple Roney"="#2973A5",
                                "Waco - MacArthur"="#99C0C4"),
                         guide = guide_legend(nrow = 3, byrow = TRUE)) +
    labs(color = "Collection Location") 
  }
  
  plot6 <- plt +
    geom_line() +
    geom_point(width = 0.2) +
    scale_y_continuous(name = "Number of Collections") +
    scale_x_date(name = "Date", date_labels = "%y-%m-%d", date_breaks = "4 weeks",limits = c(as.Date(start_date), as.Date(currentDate) - 7), expand = c(0, 0)) +
    ggtitle(label = title) +
    theme(panel.background = element_blank(),
          legend.title = element_text(size = 7),
          legend.position = "bottom",
          axis.line = element_line(size = 0.2),
          axis.text.x = element_text(angle = 60, hjust = 1),
          axis.title.x = element_text(size = 14, face = "bold"),
          axis.title.y = element_text(size = 14, face = "bold", color = "black"),
          plot.title = element_text(hjust = 0.5, size = 12, face = "bold")) +
    guides(fill = guide_legend(nrow = 2, byrow = TRUE))

  return(plot6)
  
}

```


```{r Section6_Figures, eval=TRUE,echo=FALSE, warning = FALSE, message = FALSE}

  
#Figure 6.1
Section6_plot_function(coll_sett_all,start_date = "2022-06-20", title = "Figure 6.1: Baseline - Weekly Total Biospecimen Collections")

#Figure 6.2
Section6_plot_function(coll_sett_all,start_date = "2022-06-20", site = "Henry Ford Health", 
                       color_by_setting = TRUE, color_var="all_settings",
                       title = "Figure 6.2: Baseline- Weekly Biospecimen Collections by Collection Setting, \n Henry Ford")
#Figure 6.3
Section6_plot_function2(coll_sett_all,start_date = "2022-06-20", 
                        title="Figure 6.3: Baseline- Weekly Research Biospecimen Collections \n by Collection Location, Henry Ford Health", 
                        site="Henry Ford Health", settings="Research", color_var="Site_location")
#Figure 6.4
Section6_plot_function2(coll_sett_all,start_date = "2023-05-22", 
                        title="Figure 6.4: Baseline- Weekly Clinical Biospecimen Collections \n by Clinic Location, Henry Ford Health", 
                        site="Henry Ford Health", settings="Clinical", color_var="Clin_Site_location")
#Figure 6.5
Section6_plot_function(coll_sett_all,start_date = "2022-06-20", site = "University of Chicago Medicine", 
                       title = "Figure 6.5: Baseline- Weekly Biospecimen Collections, \n University of Chicago Medicine")
#Figure 6.6
Section6_plot_function(coll_sett_all,start_date = "2022-06-20", site = "University of Chicago Medicine", 
                       color_by_setting = TRUE, color_var="all_settings",
                       title = "Figure 6.6: Baseline- Weekly Biospecimen Collections by Collection Setting, \n University of Chicago Medicine")
#Figure 6.7
Section6_plot_function2(coll_sett_all,start_date = "2022-06-20", 
                        title="Figure 6.7: Baseline- Weekly Research Biospecimen Collections \n by Collection Location, University of Chicago Medicine", 
                        site="University of Chicago Medicine", settings="Research", color_var="Site_location")
#Figure 6.8
Section6_plot_function2(coll_sett_all,start_date = "2024-05-20", 
                        title="Figure 6.8: Baseline- Weekly Clinical Biospecimen Collections by Clinic Location, \n University of Chicago Medicine", 
                        site="University of Chicago Medicine", settings="Clinical", color_var="Clin_Site_location")
#Figure 6.9
Section6_plot_function(coll_sett_all,start_date = "2022-06-20", site = "Marshfield Clinic Health System", 
                       title = "Figure 6.9 Baseline- Weekly Biospecimen Collections, \n Marshfield Clinic Health System")
#Figure 6.10
Section6_plot_function2(coll_sett_all,start_date = "2022-06-20", 
                        title="Figure 6.10: Baseline- Weekly Research Biospecimen Collections \n by Collection Location, Marshfield Clinic Health System", 
                        site="Marshfield Clinic Health System", settings="Research", color_var="Site_location")
#Figure 6.11
Section6_plot_function(coll_sett_all,start_date = "2022-06-20", site = "Sanford Health", 
                       title = "Figure 6.11 Baseline- Weekly Biospecimen Collections, \n Sanford Health")
#Figure 6.12
Section6_plot_function(coll_sett_all,start_date = "2022-06-20", site = "Sanford Health", 
                       color_by_setting = TRUE, color_var="all_settings",
                       title = "Figure 6.12 Baseline- Weekly Biospecimen Collections by Collection Setting, \n Sanford Health")
#Figure 6.13
Section6_plot_function2(coll_sett_all,start_date = "2022-06-20", 
                        title="Figure 6.13: Baseline- Weekly Research Biospecimen Collections \n by Collection Location, Sanford Health", 
                        site="Sanford Health", settings="Research", color_var="Site_location")
#Figure 6.14
Section6_plot_function(coll_sett_all,start_date = "2022-06-20", site = "HealthPartners", 
                       color_by_setting = TRUE, color_var="all_settings",
                       title = "Figure 6.14 Baseline- Weekly Biospecimen Collections by Collection Setting, \n HealthPartners")
#Figure 6.15
Section6_plot_function2(coll_sett_all,start_date = "2023-11-20", 
                        title="Figure 6.15: Baseline- Weekly Clinical Biospecimen Collections \n  by Clinic Location, HealthPartners", 
                        site="HealthPartners", settings="Clinical", color_var="Clin_Site_location")
#Figure 6.16
Section6_plot_function(coll_sett_all,start_date = "2024-06-24", site = "Baylor Scott and White Health", 
                       title = "Figure 6.16 Baseline- Weekly Biospecimen Collections, \n Baylor Scott and White Health")
#Figure 6.17
Section6_plot_function2(coll_sett_all,start_date = "2024-06-24", 
                        title="Figure 6.17: Baseline- Weekly Research Biospecimen Collections \n by Collection Location, Baylor Scott and White Health", 
                        site="Baylor Scott and White Health", settings="Research", color_var="Site_location")
#Figure 6.18
Section6_plot_function(coll_sett_all,start_date = "2023-01-16", site = "Kaiser Permanente Colorado", 
                       title = "Figure 6.18 Baseline- Weekly Biospecimen Collections, \n Kaiser Permanente Colorado")
#Figure 6.19
Section6_plot_function(coll_sett_all,start_date = "2023-01-16", site = "Kaiser Permanente Georgia", 
                       title = "Figure 6.19 Baseline- Weekly Biospecimen Collections, \n Kaiser Permanente Georgia")
#Figure 6.20
Section6_plot_function(coll_sett_all,start_date = "2023-01-16", site = "Kaiser Permanente Hawaii", 
                       title = "Figure 6.20 Baseline- Weekly Biospecimen Collections, \n Kaiser Permanente Hawaii")
#Figure 6.21
Section6_plot_function(coll_sett_all,start_date = "2023-01-16", site = "Kaiser Permanente Northwest", 
                       title = "Figure 6.21 Baseline- Weekly Biospecimen Collections, \n Kaiser Permanente Northwest")

```


\newpage

# Baseline Home Mouthwash Collections

\vspace{-0.5em}




```{r HomeMW_DataPull, include=FALSE, echo=FALSE, warning=FALSE}

# Updated kit eligibility: Initial Kit Status is not null or Date Initial Kit Requested not null

kitstatus <- "SELECT Connect_ID, 
  CASE d_827220437
    WHEN '125001209' THEN 'Kaiser Permanente Colorado'
    WHEN '327912200' THEN 'Kaiser Permanente Georgia'
    WHEN '300267574' THEN 'Kaiser Permanente Hawaii'
    WHEN '452412599' THEN 'Kaiser Permanente Northwest'
    WHEN '657167265' THEN 'Sanford Health'
    WHEN '548392715' THEN 'Henry Ford Health'
    WHEN '531629870' THEN 'HealthPartners'
    WHEN '303349821' THEN 'Marshfield'
    WHEN '809703864' THEN 'University of Chicago Medicine'
    WHEN '472940358' THEN 'Baylor Scott and White Health'
    ELSE NULL
  END AS Site,

  CASE
    WHEN d_173836415_d_266600170_d_319972665_d_221592017 = '728267588' THEN 'Initialized'
    WHEN d_173836415_d_266600170_d_319972665_d_221592017 = '849527480' THEN 'Address Printed'
    WHEN d_173836415_d_266600170_d_319972665_d_221592017 = '241974920' THEN 'Assigned'
    WHEN d_173836415_d_266600170_d_319972665_d_221592017 = '277438316' THEN 'Shipped'
    WHEN d_173836415_d_266600170_d_319972665_d_221592017 = '375535639' THEN 'Received'
    WHEN d_173836415_d_266600170_d_319972665_d_221592017 = '332067457' THEN 'Undeliverable'
    WHEN d_173836415_d_266600170_d_319972665_d_221592017 IS NULL THEN 'No Status'
    ELSE NULL
  END AS Kit_Status_int,

  CASE
    WHEN d_173836415_d_266600170_d_541483796_d_221592017 = '728267588' THEN 'Initialized'
    WHEN d_173836415_d_266600170_d_541483796_d_221592017 = '849527480' THEN 'Address Printed'
    WHEN d_173836415_d_266600170_d_541483796_d_221592017 = '241974920' THEN 'Assigned'
    WHEN d_173836415_d_266600170_d_541483796_d_221592017 = '277438316' THEN 'Shipped'
    WHEN d_173836415_d_266600170_d_541483796_d_221592017 = '375535639' THEN 'Received'
    WHEN d_173836415_d_266600170_d_541483796_d_221592017 = '332067457' THEN 'Undeliverable'
    WHEN d_173836415_d_266600170_d_541483796_d_221592017 IS NULL THEN 'No Status'
    ELSE NULL
  END AS Kit_Status_r1,

  CASE
    WHEN d_173836415_d_266600170_d_641006239_d_221592017 = '728267588' THEN 'Initialized'
    WHEN d_173836415_d_266600170_d_641006239_d_221592017 = '849527480' THEN 'Address Printed'
    WHEN d_173836415_d_266600170_d_641006239_d_221592017 = '241974920' THEN 'Assigned'
    WHEN d_173836415_d_266600170_d_641006239_d_221592017 = '277438316' THEN 'Shipped'
    WHEN d_173836415_d_266600170_d_641006239_d_221592017 = '375535639' THEN 'Received'
    WHEN d_173836415_d_266600170_d_641006239_d_221592017 = '332067457' THEN 'Undeliverable'
    WHEN d_173836415_d_266600170_d_641006239_d_221592017 IS NULL THEN 'No Status'
    ELSE NULL
  END AS Kit_Status_r2,

d_173836415_d_266600170_d_319972665_d_661940160, d_173836415_d_266600170_d_319972665_d_687158491, d_173836415_d_266600170_d_319972665_d_826941471,
d_173836415_d_266600170_d_319972665_d_379252329, d_173836415_d_266600170_d_319972665_d_759651991,

d_173836415_d_266600170_d_541483796_d_661940160, d_173836415_d_266600170_d_541483796_d_759651991, d_173836415_d_266600170_d_541483796_d_687158491, d_173836415_d_266600170_d_541483796_d_826941471, d_173836415_d_266600170_d_541483796_d_379252329,

d_173836415_d_266600170_d_641006239_d_661940160, d_173836415_d_266600170_d_641006239_d_759651991, d_173836415_d_266600170_d_641006239_d_687158491, d_173836415_d_266600170_d_641006239_d_826941471, d_173836415_d_266600170_d_641006239_d_379252329, 

d_265193023, d_547363263, d_173836415_d_266600170_d_448660695, d_195145666, d_286191859, d_123868967, d_906417725, d_747006172, d_987563196, d_167958071, d_878865966, d_684635302, d_173836415_d_266600170_d_915179629, d_914594314, d_173836415_d_266600170_d_982213346,d_173836415_d_266600170_d_139245758, d_265193023, d_253883960
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants` 
where Connect_ID IS NOT NULL and 
(d_173836415_d_266600170_d_319972665_d_221592017 IS NOT NULL or d_173836415_d_266600170_d_319972665_d_759651991 IS NOT NULL)"


kitstatus_table <- bq_project_query(project, kitstatus)
kit_table <- bq_table_download(kitstatus_table, bigint="integer64",n_max = Inf, page_size = 10000)



kit_table <- kit_table %>%  
    mutate(Kit_Status_int = factor(Kit_Status_int,levels=c("Undeliverable","No Status","Initialized", "Address Printed", "Assigned", "Shipped", "Received")),
           Kit_Status_r1 = factor(Kit_Status_r1,levels=c("Undeliverable","No Status","Initialized", "Address Printed", "Assigned", "Shipped", "Received")),
           Kit_Status_r2 = factor(Kit_Status_r2,levels=c("Undeliverable","No Status","Initialized", "Address Printed", "Assigned", "Shipped", "Received")))



## Need BioKit_CollCardMissing_v1r0 and Kit Conditions from the KitAssembly Table
### These variables are in tables that look at these look at initial, received kits only
#### Participants table KitAssembledIDs and ConnectID match those in the KitAssembly Table, though the KitAssembly table has more

kitA_bq <- "SELECT pts.Connect_ID,
CASE d_827220437
    WHEN '125001209' THEN 'Kaiser Permanente Colorado'
    WHEN '327912200' THEN 'Kaiser Permanente Georgia'
    WHEN '300267574' THEN 'Kaiser Permanente Hawaii'
    WHEN '452412599' THEN 'Kaiser Permanente Northwest'
    WHEN '657167265' THEN 'Sanford Health'
    WHEN '548392715' THEN 'Henry Ford Health'
    WHEN '531629870' THEN 'HealthPartners'
    WHEN '303349821' THEN 'Marshfield'
    WHEN '809703864' THEN 'University of Chicago Medicine'
    WHEN '472940358' THEN 'Baylor Scott and White Health'
    ELSE NULL
  END AS Site,
d_687158491 as KitAssembledID,
d_173836415_d_266600170_d_448660695,
d_195145666,
d_547363263,
d_173836415_d_266600170_d_319972665_d_687158491 as KitID,
kt.Connect_ID as ktCID ,
case when d_137401245='353358909'  then 'Collection Card Not Included'
ELSE 'Collection Card Included'
END AS Card_Status,
d_633640710_d_950521660, d_633640710_d_545319575, d_633640710_d_938338155, d_633640710_d_205954477, d_633640710_d_289239334,d_633640710_d_992420392, d_633640710_d_541085383,d_633640710_d_427719697, d_633640710_d_100618603, d_426588510, d_221592017
 FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants` pts
 left join `nih-nci-dceg-connect-prod-6d04.FlatConnect.kitAssembly` kt
 on pts.d_173836415_d_266600170_d_319972665_d_687158491=kt.d_687158491
 where --((kt.Connect_ID is not null and d_426588510='663273321' and d_221592017 = '375535639') or ##confirmed these are the values, but adding this condition changes the counts...
 (pts.Connect_ID is not null and d_173836415_d_266600170_d_319972665_d_221592017 = '375535639' ) "
kit_assmb_table <- bq_project_query(project, kitA_bq)
kit_assembly <- bq_table_download(kit_assmb_table, bigint="integer64",n_max = Inf, page_size = 10000)


```


 
 
```{r tbl7.1, include=FALSE, echo=FALSE, message=FALSE,warning=FALSE}

## 'No Status' kits will now be a QC issue and should not be in the tables 

#### Need Tables for every level of kit. If they EVER had an initial kit, they need to be in the initial table, ect.
## On a kit level, NOT a participant level
 

### Initial Kit Status Count
status_elgA <- kit_table %>%
  #Not everyone will have a requested initial kit
  #filter(!is.na(d_173836415_d_266600170_d_319972665_d_759651991) | Kit_Status_int!="No Status") %>% -- already in the BQ conditionality 
  mutate(Kit_Status_int = factor(Kit_Status_int,
                                 levels=c("Undeliverable","Initialized", "Address Printed", "Assigned", "Shipped", "Received"))) 
 
status_elg7.1A <- create_tbl_cross(status_elgA, "Site", "Kit_Status_int", "row", "Site", "Kit Status")
colnames(status_elg7.1A)[ncol(status_elg7.1A)] <- "Total Eligible"

status_elg_knA <- knitr::kable(status_elg7.1A,
             caption="Table 7.1a:  Baseline- Home Mouthwash Initial Kit Status Among Eligible Participants",
             row.names=FALSE, align=c("l", rep("c", 7)),booktabs = TRUE) %>% 
  add_indent(seq(1, nrow(status_elg7.1A) - 1)) %>% 
  kable_styling(latex_options = "scale_down")
 
 
  
  

### Replacement Kit 1 Status Count
status_elgB <-kit_table %>%
  filter(!is.na(d_173836415_d_266600170_d_541483796_d_759651991) & Kit_Status_r1!="No Status") %>% 
  mutate(Kit_Status_r1 = factor(Kit_Status_r1,
                                 levels=c("Undeliverable","Initialized", "Address Printed", "Assigned", "Shipped", "Received"))) 

 
status_elg7.1B <- create_tbl_cross(status_elgB, "Site", "Kit_Status_r1", "row", "Site", "Kit Status")
colnames(status_elg7.1B)[ncol(status_elg7.1B)] <- "Total Eligible"

status_elg_knB <- knitr::kable(status_elg7.1B,
             caption="Table 7.1b:  Baseline- Home Mouthwash Replacement Kit 1 Status \n Among All R1 Kits Requested",
             row.names=FALSE, align=c("l", rep("c", 7)),booktabs = TRUE) %>% 
  add_indent(seq(1, nrow(status_elg7.1B) - 1)) %>% 
  kable_styling(latex_options = "scale_down")
 
 
 
### Replacement Kit 2 Status Count
status_elgC <- kit_table %>%
  filter(!is.na(d_173836415_d_266600170_d_641006239_d_759651991)  & Kit_Status_r2!="No Status") %>% 
  mutate(Kit_Status_r2 = factor(Kit_Status_r2,
                                 levels=c("Undeliverable","Initialized", "Address Printed", "Assigned", "Shipped", "Received"))) 

status_elg7.1C <- create_tbl_cross(status_elgC, "Site", "Kit_Status_r2", "row", "Site", "Kit Status")
colnames(status_elg7.1C)[ncol(status_elg7.1C)] <- "Total Eligible"

status_elg_knC <- knitr::kable(status_elg7.1C,
             caption="Table 7.1c:  Baseline- Home Mouthwash Replacement Kit 2 Status \n Among All R2 Kits Requested",
             row.names=FALSE, align=c("l", rep("c", 7)),booktabs = TRUE) %>% 
  add_indent(seq(1, nrow(status_elg7.1C) - 1)) %>% 
  kable_styling(latex_options = "scale_down")
 
 

```
 
 
 
```{r Table_new_7.2, include=FALSE, echo=FALSE, message=FALSE,warning=FALSE,results='hold'}

## Counts of Kits Shipped, Kits Shipped within the last 2 Weeks, and Kits Received, by Site
 
filtered_data <- filter(kit_table, Kit_Status_int %in% c("Received", "Shipped"))
 
summary_table2_all<- filtered_data %>%
  group_by(Site) %>%
  summarise(Shipped = sum(Kit_Status_int %in% c("Received", "Shipped")), #kits received were once shipped
            Shipped_TwoWeeks = sum(Kit_Status_int %in% c("Received", "Shipped") &
                                    as.Date(d_173836415_d_266600170_d_319972665_d_661940160) < currentDate-14),
            Received = sum(Kit_Status_int == "Received")) 
 
 

total_shipped <- sum(summary_table2_all$Shipped)
total_received <- sum(summary_table2_all$Received)
total_ship_previous_week <- sum(summary_table2_all$Shipped_TwoWeeks)
total_received_percentage <- paste(total_received, "(", round(total_received/total_ship_previous_week*100, digits = 1), "%)")
total_row <- c("Total", total_shipped, total_ship_previous_week, total_received)
 
# Create a new data frame for the "Total" row
total_df <- data.frame(t(total_row), stringsAsFactors = FALSE)
 
# Set column names
colnames(total_df) <- colnames(summary_table2_all)

 
# Append the "Total" row to summary_table2_all
all_shipped_2 <- rbind(summary_table2_all, total_df)


# Add percentages to received column (out of shipped two weeks ago)
all_shipped_2$Received_PCT <- paste0(all_shipped_2$Received, " (",
                                      round(as.numeric(all_shipped_2$Received)/as.numeric(all_shipped_2$Shipped_TwoWeeks)*100, digits=1),
                                      "%)")
 
 
```
 
 
```{r new_Figs7.3, include=FALSE, echo=FALSE, message=FALSE,warning=FALSE}
 
## Counts of Kits Shipped within the last 2 Weeks and Kits Received, by Site


#site names too long and getting cut off 
all_shipped_2_filtered <- all_shipped_2 %>%
  filter(Site != "Total")  %>%
  mutate(Site = gsub("Kaiser Permanente", "KP", Site),
         Site = gsub("University of Chicago Medicine", "UChicago", Site),
         Site = gsub("Henry Ford Health", "Henry Ford", Site))
 

fig7_1 <- ggplot(all_shipped_2_filtered, aes(x = Site)) +
  geom_bar(aes(y = as.numeric(Shipped_TwoWeeks), fill = "Shipped"), stat = "identity", width = 0.8, position = position_dodge(width = 0.8)) +
  geom_bar(aes(y = as.numeric(Received), fill = "Received"), stat = "identity", width = 0.8, position = position_dodge(width = 0.8)) +
  scale_fill_manual(values = c("Shipped" = "#FDBE19", "Received" = "#164C71")) +
  labs(x = NULL, y = "Counts", fill = "") +
  theme_minimal() +
  theme(legend.position = "right",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.text.x = element_text(angle = 25, vjust = 0.5, hjust = 1, size = 7),
        axis.line = element_line(color = "black", size = 0.5)) +
  ggtitle("Figure 7.1. Baseline- Total Initial Kits Received of Total Initial Kits Shipped \n Up To 2 Weeks Ago, by Site")

```
 
 
 
```{r Table7.3_7.6, include=FALSE, echo=FALSE, message=FALSE,warning=FALSE}
 
## Collection Card Status in Kits

Coll_Card_Status <- create_tbl_cross(kit_assembly, "Site", "Card_Status", "row", "Site", " ")
 
 
 
 

## Shipment time to BPTL receipt time
test30 <- kit_table %>%
  filter(Kit_Status_int=="Received" & !is.na(d_173836415_d_266600170_d_319972665_d_826941471) & !is.na(d_173836415_d_266600170_d_319972665_d_661940160))
 
test30 <-  test30 %>%
  mutate(ctime = as.numeric(difftime(as.POSIXct(ymd_hms(d_173836415_d_266600170_d_319972665_d_826941471)),as.POSIXct(ymd_hms(d_173836415_d_266600170_d_319972665_d_661940160)),units="days"))) %>% 
  filter(ctime>0)
 
Table7.4 = test30 %>% group_by(Site) %>%
  dplyr::summarize(N=n(),
                   Min = min(ctime),
                   Q1 = quantile(ctime, 0.25),
                   Median = median(ctime),
                   Mean = mean(ctime),
                   Q3 = quantile(ctime, 0.75),
                   Max = max(ctime))
 
 
 
## Clinical Collection time to Kit Shipment time
 
firstcoltime <- coll_sett_all %>% filter(all_settings=="Clinical")  %>% select(Connect_ID, d_556788178)

firstcoltime$Connect_ID <- as.numeric(firstcoltime$Connect_ID)
kit_table$Connect_ID <- as.numeric(kit_table$Connect_ID)
first_col_time <- left_join(kit_table, firstcoltime, by="Connect_ID")
 
test31 <- first_col_time %>% 
  filter(!is.na(d_556788178) & !is.na(d_173836415_d_266600170_d_319972665_d_661940160))
 
test31 <-  test31 %>%
  mutate(ctime = as.numeric(difftime(as.POSIXct(ymd_hms(d_173836415_d_266600170_d_319972665_d_661940160)),
                                     as.POSIXct(ymd_hms(d_556788178)),units="days")))
test31b <-  test31 %>%  filter(ctime>0)
 
 
Table7.5 = test31b %>% group_by(Site) %>%
  dplyr::summarize(N =n(),
                   Min = min(ctime),
                   Q1 = quantile(ctime, 0.25),
                   Median = median(ctime),
                   Mean = mean(ctime),
                   Q3 = quantile(ctime, 0.75),
                   Max = max(ctime))
 
 
 
 
## Kit Conditions

condition_cols <- c("d_633640710_d_950521660", "d_633640710_d_545319575", "d_633640710_d_938338155", "d_633640710_d_205954477", "d_633640710_d_289239334","d_633640710_d_992420392",
           "d_633640710_d_541085383","d_633640710_d_427719697", "d_633640710_d_100618603")
kit_assembly <- kit_assembly %>%
  mutate(
    multi_cond = rowSums(across(all_of(condition_cols), ~ .x == 353358909, .names = NULL), na.rm = TRUE)
  )
 
table_32 <- kit_assembly %>% 
  mutate(kit_condition = case_when(multi_cond>1 & d_633640710_d_950521660!=353358909 ~ "Two of More Conditions Selected",
                                   d_633640710_d_545319575==353358909 ~ "Package Crushed",
                                   d_633640710_d_938338155==353358909 ~ "Improper Packaging",
                                   d_633640710_d_205954477==353358909 ~ "Collection Cup Damaged",
                                   d_633640710_d_289239334==353358909 ~ "Collection Cup Leaked",
                                   d_633640710_d_992420392==353358909 ~ "Empty Cup Returned",
                                   d_633640710_d_541085383==353358909 ~ "Incorrect Collection Type Returned",
                                   d_633640710_d_427719697==353358909 ~ "Collection Cup Not Returned",
                                   d_633640710_d_950521660==353358909 ~ "Package in Good Conditon",
                                   d_633640710_d_100618603==353358909 ~ "Other",
                                   TRUE ~ "No Conditions Selected"))
 
 
table32_pct <- table_32 %>%
  count(kit_condition, name = "n") %>%
  mutate(`Total Received Kits` = paste0(comma(n), " (", percent(n / sum(n), accuracy = 0.01), ")")) %>%
  bind_rows(
    tibble(
      kit_condition = "Total",
      n = sum(.$n),
      `Total Received Kits` = paste0(comma(sum(.$n)), " (100%)")
    )
  ) %>%
  select(Condition = kit_condition, `Total Received Kits`)
 
 
```
 
 
 
\FloatBarrier
 
```{r Kit_Fig2, include=FALSE, echo=FALSE, message=FALSE,warning=FALSE}

## Weekly Counts of Shipped and Received Kits-- ALL kits
### Need on a kit level, not participant level, as they can have 0-3 kits


################# Received-- need one set of data for the received line
received_long <- kit_table %>%
  # Put all three received date columns into one over kit received date
  pivot_longer(
    cols = c(
      d_173836415_d_266600170_d_319972665_d_826941471, # initial received
      d_173836415_d_266600170_d_541483796_d_826941471, # repl1 received
      d_173836415_d_266600170_d_641006239_d_826941471  # repl2 received
    ),
    names_to = "kit_received_var",
    values_to = "received_date"
  ) %>%
  filter(!is.na(received_date)) %>%  # only keep actual kits
  mutate(
    col.Monday.date = floor_date(as.POSIXct(ymd_hms(received_date)), unit = "week", week_start = 1)
  ) %>%
  filter(
    d_173836415_d_266600170_d_319972665_d_379252329 == 976461859,
    col.Monday.date >= as.Date("2024-03-29"),
    col.Monday.date < currentDate
  )

fig5_week_total_1 <- received_long %>%
  group_by(col.Monday.date) %>%
  summarise(total_received = n(), .groups = "drop") # count all kits, not just people

# Fill in missing Mondays
all_mondays <- data.frame(
  col.Monday.date = seq(as.Date("2024-04-01"), currentDate - 7, by = "week")
)
fig5_week_total_1 <- left_join(all_mondays, fig5_week_total_1, by = "col.Monday.date") %>%
  mutate(total_received = replace_na(total_received, 0))


################## Shipped-- need another set of data for the shipped line
shipped_long <- kit_table %>%
  # Put all three shipped date columns into one over kit shipped date
  pivot_longer(
    cols = c(
      d_173836415_d_266600170_d_319972665_d_661940160, # initial shipped
      d_173836415_d_266600170_d_541483796_d_661940160, # repl1 shipped
      d_173836415_d_266600170_d_641006239_d_661940160  # repl2 shipped
    ),
    names_to = "kit_shipped_var",
    values_to = "shipped_date"
  ) %>%
  filter(!is.na(shipped_date)) %>%
  mutate(
    col.Monday.date = floor_date(as.POSIXct(ymd_hms(shipped_date)), unit = "week", week_start = 1)
  ) %>%
  filter(
    d_173836415_d_266600170_d_319972665_d_379252329 == 976461859,
    col.Monday.date >= as.Date("2024-03-29"),
    col.Monday.date < currentDate
  )

fig5_week_total_2 <- shipped_long %>%
  group_by(col.Monday.date) %>%
  summarise(total_shipped = n(), .groups = "drop") # count kits, not participants

fig5_week_total_2 <- left_join(all_mondays, fig5_week_total_2, by = "col.Monday.date") %>%
  mutate(total_shipped = replace_na(total_shipped, 0))


####################### Combine the shipped and received data 
fig5_week_final <- left_join(fig5_week_total_1, fig5_week_total_2, by = "col.Monday.date")

MW_Coll_Kits <- ggplot(fig5_week_final, aes(x = as.Date(col.Monday.date))) +
  geom_line(aes(y = total_shipped, color = "Total Shipped"), linetype = "dashed", size = 1) +
  geom_line(aes(y = total_received, color = "Total Received"), linetype = "dashed", size = 1) +
  geom_point(aes(y = total_shipped, color = "Total Shipped"), size = 2) +
  geom_point(aes(y = total_received, color = "Total Received"), size = 2) +
  scale_y_continuous(name = "Number of Kits") +
  scale_x_date(name = "Date", date_labels = "%y-%m-%d", date_breaks = "2 weeks",
               limits = c(as.Date("2024-03-25"), as.Date(currentDate - 7)), expand = c(0,0)) +
  scale_color_manual(values = c("Total Received" = "#565C65", "Total Shipped" = "#CC7D15")) +
  ggtitle("Figure 7.2: Baseline- Weekly Shipped and Received Baseline Home \n Mouthwash Kits") +
  labs(color = "Kit Status",
       caption = "This figure includes all home mouthwash kit types: Initial, Replacement Kit 1, and Replacement Kit 2") +
  theme(panel.background = element_blank(),
        legend.title = element_text(size = 8),
        legend.position = "bottom",
        axis.line = element_line(size = 0.2),
        axis.text.x = element_text(angle = 60, hjust = 1),
        axis.title.x = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 14, face = "bold", color = "black"),
        plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),
        plot.caption = element_text(hjust = 0))


```
 
 
```{r FigMW2, include=FALSE, echo=FALSE, message=FALSE,warning=FALSE}

## Same figure as above, but cumulative and initial kits only
 
################# Received
kit_set_col_2 <- kit_table %>% filter(Kit_Status_int=="Received") %>% 
  mutate(col.Monday.date = floor_date(as.POSIXct(ymd_hms(d_173836415_d_266600170_d_319972665_d_826941471)), unit = "week", week_start = 1))

 
fig5_new_2 <- kit_set_col_2 %>%
  filter(d_173836415_d_266600170_d_319972665_d_379252329 == 976461859 & as.Date(col.Monday.date) >= "2024-03-29" & as.Date(col.Monday.date) < currentDate)
 
 
fig5_week_total_2 <- fig5_new_2 %>%
  group_by(col.Monday.date) %>%
  summarise(total_received = sum(!is.na(d_173836415_d_266600170_d_319972665_d_826941471)))
 
# Create a data frame with all Mondays from April 1st, 2024, until today
all_mondays <- data.frame(col.Monday.date = seq(as.Date("2024-04-01"), currentDate-7, by = "week"))
 
 
fig5_week_total_2 <- left_join(all_mondays, fig5_week_total_2, by = "col.Monday.date") %>%
  mutate(total_received = replace(total_received, is.na(total_received), 0))
 
 
############### Shipped
kit_table2 <- kit_table %>%  filter(!is.na(d_173836415_d_266600170_d_319972665_d_661940160)) %>% 
  mutate(col.Monday.date = floor_date(as.POSIXct(ymd_hms(d_173836415_d_266600170_d_319972665_d_661940160)), unit = "week", week_start = 1))

 
 
fig5_new_3 <- kit_table2 %>%
  filter(d_173836415_d_266600170_d_319972665_d_379252329 == 976461859 & as.Date(col.Monday.date) >= "2024-03-29" & as.Date(col.Monday.date) < currentDate)
 
fig5_week_totals_3 <- fig5_new_3 %>%
  group_by(col.Monday.date) %>%
  summarise(total_shipped = sum(!is.na(d_173836415_d_266600170_d_319972665_d_661940160)))
 
 
fig5_week_total_3 <- left_join(all_mondays, fig5_week_totals_3, by = "col.Monday.date") %>%
  mutate(total_shipped = replace(total_shipped, is.na(total_shipped), 0))
 
 
 
################ Combine received and shipped 
fig_7.3_totals <- fig5_week_total_2
 
fig_7.3_totals[,3] <- fig5_week_total_3[,2]
 
colnames(fig_7.3_totals) <- c("col.Monday.date", "total_received", "total_shipped")
 
 
fig5_week_total2 <- fig_7.3_totals %>%
  arrange(col.Monday.date) %>%
  mutate(cumulative_shipped = cumsum(total_shipped),
         cumulative_received = cumsum(total_received))
 
fig5_week_total2 <- fig5_week_total2 %>%
  mutate(percentage_received_to_shipped = round(cumulative_received / cumulative_shipped * 100, digits=2))
 
 
##Percentage they want noted is the total received as of today/total shipped as of end of week prior
#all_shipped_2_filtered already looks at initial kits only
thus_far <- round(sum(as.numeric(all_shipped_2_filtered$Received))/sum(as.numeric(all_shipped_2_filtered$Shipped_TwoWeeks))*100, digits=2)
 
 

MW_overtime <- ggplot(fig5_week_total2, aes(x = as.Date(col.Monday.date))) +
  geom_ribbon(aes(ymin = 0, ymax = cumulative_shipped, fill = "Total Shipped"), alpha = 0.3) +
  geom_ribbon(aes(ymin = 0, ymax = cumulative_received, fill = "Return Rate"), alpha = 0.3) +
  geom_text(data = fig5_week_total2 %>% filter(col.Monday.date == max(col.Monday.date)),
            aes(x = as.Date(col.Monday.date),
                label = paste0(thus_far, "%")),
            y = thus_far, vjust = -0.5, hjust = 1.2,  color = "black",  size = 3) +
  scale_x_date(name = "Date", date_labels = "%y-%m-%d", date_breaks = "2 weeks",
               limits = c(as.Date("2024-03-25"), as.Date(currentDate-7)), expand = c(0,0)) +
  scale_y_continuous(name = "# Kits Shipped") +
  scale_fill_manual(name = "", values = c("Total Shipped" = "#CC7D15", "Return Rate" = "#0072B2")) +
  ggtitle(label = "Figure 7.3: Baseline- Home Mouthwash Initial Kit Return Rate \n for Kits Shipped Up To 2 Weeks Ago") +
  labs(caption = paste("Note: Shipped data are current through",as.Date(currentDate)-7, ".")) +
  theme(panel.background = element_blank(),
        legend.position = "bottom",
        axis.line = element_line(size = 0.2),
        axis.text.x = element_text(angle = 60, hjust = 1),
        axis.title.x = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 14, face = "bold", color = "black"),
        plot.title = element_text(hjust = 0.5, size = 12, face = "bold"))
 
```
 
 
 
 
 
\FloatBarrier
```{r newTables7.1A,eval=TRUE,echo=FALSE,message=FALSE,warning=FALSE,results='asis'}
#results='asis'
 
status_elg_knA
```
 
\FloatBarrier
```{r newTables7.1B,eval=TRUE,echo=FALSE,message=FALSE,warning=FALSE,results='asis'}
#results='asis'
 
status_elg_knB
```
 
\FloatBarrier
```{r newTables7.1C,eval=TRUE,echo=FALSE,message=FALSE,warning=FALSE,results='asis'}
#results='asis'
 
add_footnote(status_elg_knC, "Note: Eligible participants are those who had a clinical collection with blood or urine collected on or after March 29, 2024, and did not refuse, withdraw, or pass away prior to April 2024. Home mouthwash collections were launched for eligible participants in April 2024. Home mouthwash collections for backlog collections (before April 2024) will be launched at a later date.", notation = "none")
```
 
```{r, include=FALSE}

## Add a new Table 7.2: Of participants where "Kit Request Eligible" = yes and "Kit Request Eligible" date was at least 24 hours ago, how many have kit status that is not null. (distrbution of kit statuses)
#Variables aren't in prod just yet 
#https://github.com/episphere/connect/issues/1326#issuecomment-2960611399

```
 
 
\FloatBarrier
```{r KnitrTables7.2,eval=TRUE,echo=FALSE,message=FALSE, warning = FALSE, results='asis'}
 
knitr::kable(all_shipped_2[, c(1:3,5)],format.args = list(big.mark = ","),
             col.names=c("Site", "Shipped","Shipped 2 Weeks Ago", "Received"),
             caption='Table 7.2 Baseline- Total Home Mouthwash Initial Kit Return Rate for Packages Shipped up to 2 Weeks Ago',
             row.names=FALSE, align=c("l", rep("c", 3)),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "HOLD_position")
 
```
 
 
 
\FloatBarrier
```{r Fig7_1, eval=TRUE,echo=FALSE, warning = FALSE, message = FALSE}
 
fig7_1
 
```
 
 
\FloatBarrier
```{r Fig7_2, eval=TRUE,echo=FALSE, warning = FALSE, message = FALSE}
 
MW_Coll_Kits
 
```
 
\FloatBarrier
```{r Fig7_3, eval=TRUE,echo=FALSE, warning = FALSE, message = FALSE}

MW_overtime
 
```
 
\FloatBarrier
```{r KnitrTables7.3_7.4,eval=TRUE,echo=FALSE,error=FALSE, message=FALSE,warning=FALSE, results='asis'}
 
knitr::kable(Coll_Card_Status,
             caption="Table 7.3: Baseline- Collection Card Status Among Home Mouthwash Initial Kits Received",
             row.names=FALSE, align=c("l", rep("c", 3)),booktabs = TRUE) %>% 
  add_indent(seq(1, nrow(Coll_Card_Status) - 1)) %>% 
  kable_styling(latex_options = "scale_down")
 
 
```
 
 
 
\FloatBarrier
```{r KnitrTables7.5_7.8,eval=TRUE,echo=FALSE,error=FALSE, message=FALSE,warning=FALSE, results='asis'}
 
 
#all these will move down a table number
table7.4 <- knitr::kable(Table7.4,
                               caption='Table 7.4: Baseline- Time (in Days) from Home Mouthwash Initial Kit Shipment to \n BPTL Receipt',
                               row.names=FALSE, align=c("l", rep("c", 6)),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "HOLD_position")
add_footnote(table7.4, "Note: Kits were returned using USPS prior to 6/17/2024.", notation = "none")
 
 
 
knitr::kable(Table7.5,
             caption='Table 7.5: Baseline- Time (in Days) from Clinical Collection to Home Mouthwash Initial Kit Shipment',
             row.names=FALSE, align=c("l", rep("c", 6)),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "HOLD_position")
 
 
knitr::kable(table32_pct,
             caption='Table 7.6: Baseline- Kit Conditions Among Received Home Mouthwash Initial Kits',
             row.names=FALSE, align=c("l","c"),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "HOLD_position")
```
 
 
 
 
 
 
\FloatBarrier
 
```{r Tables7.9_7.12, eval=TRUE,echo=FALSE,message=FALSE,warning=FALSE,results='asis'}
 
 
######### Need on a participant level- can have multiple kits but only one survey
 
 
 
table7_8 <- kit_table %>%  filter(Kit_Status_r2=="Received" | Kit_Status_r1=="Received" | Kit_Status_int=="Received") %>%
  mutate(MWSrvy_status = case_when(d_547363263==972455046 ~ "Not Started",
                                   d_547363263==615768760 ~ "Started",
                                   d_547363263==231311385 ~ "Submitted"),
         MWSrvy_status = factor(MWSrvy_status, levels=c("Not Started","Started", "Submitted")))  


table7_8_totals <- create_tbl_cross(table7_8, "Site", "MWSrvy_status", "row", "Site", " ")
colnames(table7_8_totals)[ncol(table7_8_totals)] <- "Total Participants with Received Kits"

knitr::kable(table7_8_totals,
             caption="Table 7.7: Baseline- Mouthwash Biospecimen Survey Status Among Any Received Home Mouthwash Kits",
             row.names=FALSE, align=c("l", rep("c", 4)),booktabs = TRUE) %>% 
  add_indent(seq(1, nrow(table7_8_totals) - 1)) %>% 
  kable_styling(latex_options = "scale_down")
 
```
 
```{r MW_Survey_before_after, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
 
 # Define shared function
generate_mw_table <- function(comparison) {
  kit_table %>% 
    filter((Kit_Status_r2 == "Received" | Kit_Status_r1 == "Received" | Kit_Status_int == "Received") &
             eval(parse(text = paste0("as.Date(d_173836415_d_266600170_d_319972665_d_661940160) ", comparison, " as.Date('2024-05-22')")))) %>%
    mutate(MWSrvy_status = case_when(d_547363263 == 972455046 ~ "Not Started",
                                     d_547363263 == 615768760 ~ "Started",
                                     d_547363263 == 231311385 ~ "Submitted"),
           MW_completion = difftime(as.Date(d_173836415_d_266600170_d_448660695), as.Date(d_195145666), units = "days"),
           MW_comp_diff = case_when(MWSrvy_status != "Submitted" ~ "Not Submitted",
                                    as.numeric(MW_completion) <= -4 ~ "4+ Days before Collection",
                                    as.numeric(MW_completion) == -3 ~ "3 Days before Collection",
                                    as.numeric(MW_completion) == -2 ~ "2 Days before Collection",
                                    as.numeric(MW_completion) == -1 ~ "1 Day before Collection",
                                    as.numeric(MW_completion) == 0 ~ "Same Day as Collection",
                                    as.numeric(MW_completion) == 1 ~ "1 Day after Collection",
                                    as.numeric(MW_completion) == 2 ~ "2 Days after Collection",
                                    as.numeric(MW_completion) == 3 ~ "3 Days after Collection",
                                    as.numeric(MW_completion) >= 4 ~ "4+ Days after Collection"),
           MW_comp_diff = factor(MW_comp_diff,levels = c("Not Submitted", "4+ Days before Collection", "3 Days before Collection",
                                                         "2 Days before Collection", "1 Day before Collection", "Same Day as Collection",
                                                         "1 Day after Collection", "2 Days after Collection", "3 Days after Collection",
                                                         "4+ Days after Collection")))
}



##### Table 7.8 (Before PWA update)
table7_9 <- generate_mw_table(comparison = "<")
table7_9_totals <- create_tbl_cross(table7_9, "Site", "MW_comp_diff", "row", "Site", " ")

tbl_7_9 <- knitr::kable(table7_9_totals,
                        caption = "Table 7.8: Baseline- Mouthwash Biospecimen Survey Completion Time Relative to Collection Time Reported on Collection Card \n(Pre-update to survey description on PWA)",
                        row.names = FALSE, align = c("l", rep("c", 11)), booktabs = TRUE) %>%
  add_indent(seq(1, nrow(table7_9_totals) - 1)) %>%
  kable_styling(latex_options = "scale_down") %>%
  landscape()

add_footnote(tbl_7_9, "Only includes data from mouthwash kits returned with completed Collection Card.", notation = "none")


######### Table 7.9 (After PWA update)
table7_10 <- generate_mw_table(comparison = ">=")
table7_10_totals <- create_tbl_cross(table7_10, "Site", "MW_comp_diff", "row", "Site", " ")

tbl_7_10 <- knitr::kable(table7_10_totals,
                         caption = "Table 7.9: Baseline- Mouthwash Biospecimen Survey Completion Time Relative to Collection Time Reported on Collection Card \n(Post-update to survey description on PWA)",
                         row.names = FALSE, align = c("l", rep("c", 11)), booktabs = TRUE) %>%
  add_indent(seq(1, nrow(table7_10_totals) - 1)) %>%
  kable_styling(latex_options = "scale_down") %>%
  landscape()

add_footnote(tbl_7_10, "Only includes data from mouthwash kits returned with completed Collection Card.", notation = "none")
  

 
```
 
 
\FloatBarrier
 
```{r Tables10s, eval=TRUE,echo=FALSE, message=FALSE,warning=FALSE, results='asis'}


survey_cc_int <- kit_table %>%  filter(!is.na(d_195145666) & !is.na(d_173836415_d_266600170_d_448660695) & as.Date(d_195145666) > "2025-05-01") 

survey_cc_int <-  survey_cc_int %>% 
  mutate(ctime = as.numeric(difftime(as.POSIXct(ymd_hms(d_195145666)),as.POSIXct(ymd_hms(d_173836415_d_266600170_d_448660695)),units="hours"))) %>%  
  filter(ctime>0)

Table7.10a = survey_cc_int %>% group_by(Site) %>% 
  dplyr::summarize(N=n(),
                   Min = min(ctime),
                   Q1 = quantile(ctime, 0.25),
                   Median = median(ctime),
                   Mean = mean(ctime),
                   Q3 = quantile(ctime, 0.75),
                   Max = max(ctime))
 
Table7_10a <- knitr::kable(Table7.10a,
                           caption='Table 7.10 Baseline- Mouthwash Biospecimen Survey Completion Time (in Days) Relative to Collection Time \n Reported on Collection Card for Initial Kit (Post update to  survey introduction)',
                           row.names=FALSE, align=c("l",rep("c", 7)),digits=1, booktabs = TRUE) %>%
  kable_styling(latex_options = "HOLD_position")
add_footnote(Table7_10a, "Note: Only includes data from mouthwash kits returned with completed Collection Card.", notation = "none")
         

```







\newpage
# Appendix: Biospecimen Analysis Request

**Exclusion Criteria:** 

The Biospecimen Analysis Request followed the same exclusion criteria as used in the Biospecimen Weekly Metrics Report where:  

1) Connect_ID is not null
2) Collection Entry Final is not null
3) Verification Status (CID: 821247024) = Verified (CID: 197316935) and Data Destruction (CID: 831041022) = No (CID: 104430631) 
4) Used only finalized collections for clinical and research specimens
5) Removed duplicate collections from all clinical & research collections
6) Among those with sequential collections, used only the first collection based on the Date/Time Collection Entry Final (CID: 556788178)   

**Data "freeze" date for this report:** XX/XX/XXXX 
 
\newpage

##  Request 1: Density plot/histogram of recruitment and biospecimens collected by age

```{r Request1,echo=FALSE,error=FALSE,message=FALSE,warning=FALSE, results='hold'}
#===========================================================================
# REQUEST 1: Histogram of recruitment and biospeciemen collections by age
#===========================================================================

# Figure 1a: Histogram of all verified participants ages 30-70 years
age_bin_counts <- biocol.tb %>%
  filter(!is.na(age)) %>%
  group_by(age) %>%
  summarise(n = n()) %>%
  ungroup() %>%
  # Optional: reorder the factor levels so the plot goes left to right
  mutate(age = factor(age, levels = sort(unique(age))))

age_bin_counts_plot <- ggplot(age_bin_counts, aes(x = age, y = n)) +
  geom_col(fill = "#5B9BD5") +
  labs(title = "Figure 1a. All verified participants by 5-year age group from 30-70 years",
       x = "Age Group",
       y = "Count of Verified Participants") +
  scale_y_continuous(breaks = seq(0, 20000, by = 1000)) + 
  theme_classic(base_size = 12) +
  theme(
    plot.title = element_text(size = 11, face = "bold", hjust = 0.5),  # center & enlarge title
    axis.title.x = element_text(size = 10),  # x-axis title size
    axis.title.y = element_text(size = 10)   # y-axis title size
  )

print(age_bin_counts_plot)


# Table 1b: Histogram of biospecimen collections for participants 30-70 years
age_bin_biocol <- table1 %>%
  filter(biocol.appoint == "Baseline Collection", !is.na(age)) %>%
  group_by(age) %>%
  summarise(n = n()) %>%
  ungroup() %>%
  mutate(age = factor(age, levels = sort(unique(age))))  # keep age bin order consistent

age_bin_biocol_plot <- ggplot(age_bin_biocol, aes(x = age, y = n)) +
  geom_col(fill = "#5B9BD5") +
  labs(title = "Figure 1b. All biospecimen collections by 5-year age group from 30-70 years",
       x = "Age Group",
       y = "Count of Baseline Collections") +
  scale_y_continuous(breaks = seq(0, 10000, by = 1000)) + 
    theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(size = 11, face = "bold", hjust = 0.5),  # center & enlarge title
    axis.title.x = element_text(size = 10),  # x-axis title size
    axis.title.y = element_text(size = 10)   # y-axis title size
  )

print(age_bin_biocol_plot)

```

\newpage

##  Request 2: Total number of collection sites

a. Clinical collection IHC sites (N = 8): KPCO, KPHI, KPGA, KPNW, HFH, HP, Sanford, UChicago

b. Research collection IHC sites (N = 6): BSWH, Sanford, HFH, HP, UChicago, Marshfield

c. Number of unique collection sites per IHC: 
   - Kaiser Permanente (KP): Dynamic (for Clinical only)
   - HealthPartners (HP): N = 8 (6 Clinical, 2 Research)
   - Henry Ford Health System (HFH): N = 25 (18 Clinical, 7 Research: 5 main, 1 pop-up, 1 in-home)
   - Sanford Health (Sanford): N = Dynamic (for Clinical only), N = 5 (Research)
   - University of Chicago Medicine (UChicago): N = 14 (8 Clinical, 6 Research: 5 main, 1 pop-up)
   - Baylor Scott & White Health (BSWH): N = 10 (Research)
   - Marshfield Clinic Health System (Marshfield): N = 10 (Research: 9 main, 1 pop-up)
  
d. Number of unique shipping sites per IHC: 
   - Overall: N = 23
     - Kaiser Permanente (KP): 
        - KP-Colorado (KPCO): N = 1
        - KP-Georgia (KPGA): N = 1
        - KP-Northwest (KPNW): N = 1
        - KP-Hawaii (KPHI): N = 1
     - HealthPartners (HP): N = 2
     - Henry Ford Health System (HFH): N = 1
     - Sanford Health (Sanford): N = 3
     - University of Chicago Medicine (UChicago): N = 2
     - Baylor Scott & White Health (BSWH): N = 4
     - Marshfield Clinic Health System (Marshfield): N = 7 (5 main, 2 pop-up)
  
**NOTE:** Clinical and research biospecimen collections are broken down by sub-site below in Table 2a and Table 2b, respectively. 
  
```{r Request2,echo=FALSE,error=FALSE,message=FALSE,warning=FALSE, results='asis'}
#===========================================================
# REQUEST 2: Total number of Collection Sites
#===========================================================

# Table 2
coll_sett_all <- table1 %>%  filter(BiospeCollection == "Any biospecimen Collections" & (d_410912345== 353358909 | BL_BioSpm_MWSetting_v1r0=="Home")) %>% 
  mutate(all_settings = case_when((d_650516960=="664882224" | BL_BioSpm_BloodSetting_v1r0=="Clinical" | 
                                    BL_BioSpm_UrineSetting_v1r0=="Clinical" | BL_BioSpm_MWSetting_v1r0=="Clinical") ~ "Clinical",
                                  (d_650516960=="534621077" | BL_BioSpm_BloodSetting_v1r0=="Research" | 
                                    BL_BioSpm_UrineSetting_v1r0=="Research" | BL_BioSpm_MWSetting_v1r0=="Research")~ "Research",
                                  (d_650516960=="103209024" | BL_BioSpm_BloodSetting_v1r0=="Home" | 
                                    BL_BioSpm_UrineSetting_v1r0=="Home" | BL_BioSpm_MWSetting_v1r0=="Home") ~ "Home"))

table1_allsett <- create_tbl_cross(coll_sett_all, "Site", "all_settings", "row", "Site", "Collection Setting")  

# Table 2:
knitr::kable(table1_allsett,
                                   caption='Table 2. Number of baseline biospecimen collections by setting for first specimen collected', 
                                   row.names=FALSE,align=c("l", rep("c", 3)), booktabs = TRUE) %>%  
  add_indent(seq(1, nrow(table1_allsett) - 1)) %>% 
  kable_styling(latex_options = c("scale_down", "hold_position")) %>% 
  kableExtra::footnote(general = "Note: This table was taken directly from Biospecimen Weekly Metrics Report: Table 1.2.", 
           general_title = "",
         footnote_as_chunk = TRUE, 
         escape = FALSE, 
         threeparttable = TRUE) 

#print(settings_breakdown)

#Table 2a: Clinical Collections
Table2a <- col_num_1.2_gt %>%  summary_rows(
  groups = TRUE,
  columns = vars("Total Clinical Collections"),
  fns = (Sum = ~sum(.)),
) %>% tab_header("Table 2a: Baseline Clinical Biospecimen Collections by Collection Location") %>% 
 tab_footnote(
    footnote = "This table was taken directly from Biospecimen Weekly Metrics Report: Table 1.4. KP and Sanford sites are not included due to the high number of individual collection sites.",
    locations = cells_title(groups = "title")
  ) %>% 
tab_source_note(source_note = "")

#Table 2b: Research Collections
Table2b <-col_num_1.1_gt %>%  
  summary_rows(
    groups = TRUE,
    columns = vars("Total Research Collections"),
    fns = (Sum = ~sum(.))
  ) %>% 
  tab_header("Table 2b: Baseline Research Biospecimen Collections by Collection Location") %>% 
  tab_options(table.font.size = px(8))  %>% 
 tab_footnote(
    footnote = "This table was taken directly from Biospecimen Weekly Metrics Report: Table 1.3.",
    locations = cells_title(groups = "title")
  ) %>% 
tab_source_note(source_note = "")


#Print Tables:
Table2a
Table2b

```


\FloatBarrier
\newpage
\FloatBarrier

## Request 3: Time from recruitment to blood collection (restricted to 2024 onwards)

\FloatBarrier
```{r Request3, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, results='asis'}
#========================================================================
# REQUEST 3: Time from Recruitment to Blood Collection (2024 onwards)
#========================================================================

# SITE VARIABLE CHECKS
invisible(
  grep("site", names(coll_sett_all), value = TRUE, ignore.case = TRUE)
)

invisible(
  coll_sett_all %>%
     dplyr::select(Site, Clin_Site_location, siteAcronym, Site_location) %>%
    summarise(across(everything(), ~ list(unique(.)))) %>%
    pivot_longer(cols = everything(), names_to = "Variable", values_to = "Unique_Values")
)

invisible(unique(coll_sett_all$Site))
invisible(unique(coll_sett_all$Clin_Site_location))
invisible(unique(coll_sett_all$siteAcronym))
invisible(unique(coll_sett_all$Site_location))
invisible(unique(coll_sett_all$all_settings))


# BASE DATASETS
baseline_col_research <- coll_sett_all %>%
  filter(
    d_331584571 == 266600170,
    !is.na(d_914594314),
    !is.na(d_556788178),
    all_settings == "Research"
  )

baseline_col_clinical <- coll_sett_all %>%
  filter(
    d_331584571 == 266600170,
    !is.na(d_914594314),
    !is.na(d_556788178),
    all_settings == "Clinical"
  )


# FILTERED ON OR AFTER 1/1/2024
baseline_colct_clinical <- baseline_col_clinical %>%
  filter(d_914594314 >= as.Date("2024-01-01"))

BSL_colctD_clinical <- baseline_colct_clinical %>%
  mutate(time = as.numeric(difftime(
    as.POSIXct(ymd_hms(d_556788178)),
    as.POSIXct(ymd_hms(d_914594314)),
    units = "days"
  )))

baseline_colct_research <- baseline_col_research %>%
  filter(d_914594314 >= as.Date("2024-01-01"))

BSL_colctD_research <- baseline_colct_research %>%
  mutate(time = as.numeric(difftime(
    as.POSIXct(ymd_hms(d_556788178)),
    as.POSIXct(ymd_hms(d_914594314)),
    units = "days"
  )))



# SUMMARY + TOTAL ROWS
add_total_rows <- function(site_summary, datasets, labels, site_var = "siteAcronym") {
  totals <- purrr::map2(datasets, labels, function(data, label) {
    # format bold only when knitting
    label_fmt <- if (knitr::is_html_output()) {
      cell_spec(label, bold = TRUE)
    } else if (knitr::is_latex_output()) {
      cell_spec(label, bold = TRUE, format = "latex")
    } else {
      label  # plain text in console
    }

    data %>%
      dplyr::summarize(
        Site = label_fmt,
        'Number of Collection Visits' = n(),
        Min     = round(min(time, na.rm = TRUE), 1),
        Q1      = round(quantile(time, 0.25, na.rm = TRUE), 1),
        Median  = round(median(time, na.rm = TRUE), 1),
        Mean    = round(mean(time, na.rm = TRUE), 1),
        SD      = round(sd(time, na.rm = TRUE), 1),
        Q3      = round(quantile(time, 0.75, na.rm = TRUE), 1),
        'Perc.95' = round(quantile(time, 0.95, na.rm = TRUE), 1),
        Max     = round(max(time, na.rm = TRUE), 1)
      )
  }) %>%
    dplyr::bind_rows()

  site_summary %>%
    rename(Site = {{ site_var }}) %>%
    bind_rows(totals)
}



# CLINICAL TABLE (with Clinical + Research Totals)
verif_BSL_colct_clinical <- BSL_colctD_clinical %>%
  group_by(siteAcronym) %>%
  dplyr::summarize(
    'Number of Collection Visits' = n(),
    Min     = round(min(time, na.rm = TRUE), 1),
    Q1      = round(quantile(time, 0.25, na.rm = TRUE), 1),
    Median  = round(median(time, na.rm = TRUE), 1),
    Mean    = round(mean(time, na.rm = TRUE), 1),
    SD      = round(sd(time, na.rm = TRUE), 1),
    Q3      = round(quantile(time, 0.75, na.rm = TRUE), 1),
    'Perc.95' = round(quantile(time, 0.95, na.rm = TRUE), 1),
    Max     = round(max(time, na.rm = TRUE), 1),
    .groups = "drop"
  )

verif_BSL_colct_clinical <- add_total_rows(
  verif_BSL_colct_clinical,
  datasets = list(
    BSL_colctD_clinical,
    dplyr::bind_rows(BSL_colctD_clinical, BSL_colctD_research)
  ),
  labels = c("Clinical Total", "Overall Total (Research + Clinical)"),
)

# Table 3a: Clinical collection
knitr::kable(
  verif_BSL_colct_clinical,
  caption = 'Table 3a: Time (in Days) from Recruitment to Clinical Collection Among Participants Verified on or After 1/01/2024',
  row.names = FALSE,
  align = c("l", rep("c", 8)),
  booktabs = TRUE,
  escape = FALSE
) %>%
  row_spec(0, bold = TRUE) %>%
  row_spec(nrow(verif_BSL_colct_clinical) - 1, bold = TRUE) %>%
  row_spec(nrow(verif_BSL_colct_clinical), bold = TRUE) %>%
  kable_styling(latex_options = "scale_down") %>%
  footnote(general = "Note: Baseline Clinical Collections were launched in February 2023 at the KP sites; June 2023 at Henry Ford; December 2023 at HealthPartners; April 2024 at Sanford; June 2024 at UChicago", 
           general_title = "",
         footnote_as_chunk = TRUE, 
         escape = FALSE, 
         threeparttable = TRUE) 

#invisible(Table3_clinical_withresearch)



# RESEARCH TABLE (with Research + Clinical Totals)
verif_BSL_colct_research <- BSL_colctD_research %>%
  group_by(siteAcronym) %>%
  dplyr::summarize(
    'Number of Collection Visits' = n(),
    Min     = round(min(time, na.rm = TRUE), 1),
    Q1      = round(quantile(time, 0.25, na.rm = TRUE), 1),
    Median  = round(median(time, na.rm = TRUE), 1),
    Mean    = round(mean(time, na.rm = TRUE), 1),
    SD      = round(sd(time, na.rm = TRUE), 1),
    Q3      = round(quantile(time, 0.75, na.rm = TRUE), 1),
    'Perc.95' = round(quantile(time, 0.95, na.rm = TRUE), 1),
    Max     = round(max(time, na.rm = TRUE), 1),
    .groups = "drop"
  )

verif_BSL_colct_research <- add_total_rows(
  verif_BSL_colct_research,
  datasets = list(
    BSL_colctD_research,
    dplyr::bind_rows(BSL_colctD_research, BSL_colctD_clinical)
  ),
  labels = c("Research Total", "Overall Total (Research + Clinical)")
)

# Table 3b: Research collection
knitr::kable(
  verif_BSL_colct_research,
  caption = 'Table 3b: Time (in Days) from Recruitment to Research Collection Among Participants Verified on or After 1/01/2024',
  row.names = FALSE,
  align = c("l", rep("c", 8)),
  booktabs = TRUE,
  escape = FALSE
) %>%
  row_spec(0, bold = TRUE) %>%
  row_spec(nrow(verif_BSL_colct_research) - 1, bold = TRUE) %>%
  row_spec(nrow(verif_BSL_colct_research), bold = TRUE) %>%
  kable_styling(latex_options = "scale_down") %>%
    footnote(general = "Note: August 2022 marks when research collection appointments were routinely offered to all new recruits at or near the time of verification. UChicago participant verification largely occurs at or near the time of collection.", 
           general_title = "",
         footnote_as_chunk = TRUE, 
         escape = FALSE, 
         threeparttable = TRUE) 
#invisible(Table3_research_withclinical)


# # PRINT TABLES
# print(Table3_clinical_withresearch)
# print(Table3_research_withclinical)

```
\FloatBarrier
\newpage
\FloatBarrier
```{r Request4_setup, eval=TRUE,echo=FALSE,include=FALSE} 

# ======================================================================================
# REQUEST 4: PULL IN MODULE 1 DATA TO MERGE WITH BIOSPECIMENS
# ======================================================================================

# Pulling in Module 1 completion to get participant defined race for the next few tables:

recr_M1 <- bq_project_query(project, query="SELECT Connect_ID, d_821247024, d_914594314,  d_512820379, d_255077064,
                            d_949302066 , d_517311251  FROM  `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants` WHERE  d_821247024='197316935' and (d_512820379='486306141' OR d_512820379='854703046')")
recr_m1 <- bq_table_download(recr_M1,bigint = "integer64",n_max = Inf, page_size = 10000)
cnames <- names(recr_m1)
# Check that it doesn't match any non-number
numbers_only <- function(x) !grepl("\\D", x)
# to check variables in recr_noinact_wl1
for (i in 1: length(cnames)){
  varname <- cnames[i]
  var<-pull(recr_m1,varname)
  recr_m1[,cnames[i]] <- ifelse(numbers_only(var), as.numeric(as.character(var)), var)
}


# Handling participants that somehow completed both Mod1 version 1 and Mod1 version 2:

sql_M1_1 <- bq_project_query(project, query="SELECT Connect_ID, D_384191091_D_384191091_D_583826374, D_384191091_D_384191091_D_636411467, 
                             D_384191091_D_384191091_D_458435048, D_384191091_D_384191091_D_706998638, D_384191091_D_384191091_D_973565052, 
                             D_384191091_D_384191091_D_586825330, D_384191091_D_384191091_D_412790539, D_384191091_D_384191091_D_807835037,
                             D_384191091_D_747350323,D_384191091_D_384191091_D_746038746, d_784119588
                             FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.module1_v1` where Connect_ID is not null")
sql_M1_2 <- bq_project_query(project, query="SELECT Connect_ID, D_384191091_D_384191091_D_583826374 ,D_384191091_D_384191091_D_636411467, 
                             D_384191091_D_384191091_D_458435048, D_384191091_D_384191091_D_706998638, D_384191091_D_384191091_D_973565052,
                             D_384191091_D_384191091_D_586825330,D_384191091_D_384191091_D_412790539,D_384191091_D_384191091_D_807835037,
                             D_384191091_D_747350323,D_384191091_D_384191091_D_746038746, d_784119588
                             FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.module1_v2` where Connect_ID is not null")


M1_V1 <- bq_table_download(sql_M1_1, bigint = "integer64")
M1_V2 <- bq_table_download(sql_M1_2, bigint = "integer64")

# Select matching column names
M1_V1_vars <- colnames(M1_V1)
M1_V2_vars <- colnames(M1_V2)
common_vars <- intersect(M1_V1_vars, M1_V2_vars)

# Subset to common columns
M1_V1_common <- M1_V1[, common_vars]
M1_V2_common <- M1_V2[, common_vars]

# Add version indicator
M1_V1_common$version <- 1
M1_V2_common$version <- 2

# Identify columns with mismatched types
mismatched_cols <- names(M1_V1_common)[sapply(names(M1_V1_common), function(col) {
  class(M1_V1_common[[col]]) != class(M1_V2_common[[col]])
})]

# Convert mismatched columns to character for consistency
M1_V1_common <- M1_V1_common %>%
  mutate(across(all_of(mismatched_cols), as.character))
M1_V2_common <- M1_V2_common %>%
  mutate(across(all_of(mismatched_cols), as.character))

# Combine both versions for participants who completed both
M1_common <- bind_rows(M1_V1_common, M1_V2_common) %>%
  arrange(Connect_ID, desc(version))

# For columns unique to each version
V1_only_vars <- setdiff(M1_V1_vars, common_vars)
V2_only_vars <- setdiff(M1_V2_vars, common_vars)

# Subset each version for unique columns and add version indicator
m1_v1_only <- M1_V1[, c("Connect_ID", V1_only_vars)] %>%
  mutate(version = 1)
m1_v2_only <- M1_V2[, c("Connect_ID", V2_only_vars)] %>%
  mutate(version = 2)

# Combine the unique and common data
m1_common_v1 <- left_join(M1_common, m1_v1_only, by = c("Connect_ID", "version"))
m1_combined_v1v2 <- left_join(m1_common_v1, m1_v2_only, by = c("Connect_ID", "version"))

# Filter for complete cases where specific completion criteria are met
m1_complete <- m1_combined_v1v2 %>%
  filter(Connect_ID %in% recr_m1$Connect_ID[recr_m1$d_949302066 == 231311385]) %>%
  arrange(desc(version))

# Remove duplicates, keeping only the most recent version for each Connect_ID
m1_complete_nodup <- m1_complete[!duplicated(m1_complete$Connect_ID),]

m1_complete_nodup$Connect_ID <- as.numeric(m1_complete_nodup$Connect_ID)







############ Added:/Updated 

#Need to include recr_M1 because it has the survey flag variable d_949302066 and participant requirements (verified, no data deletion)
m1_race <- left_join(recr_m1, m1_complete_nodup, by="Connect_ID")

# Merge M1 dataset with biospecimens dataset: - you need to merge this with Table 1.1 (dataframe table1) in order to include those with or without collections
coll_sett_all_m1 <- left_join(table1, m1_race, by="Connect_ID")

# Then add the settings variable derivation. All those with a populated setting have a collection, so research.survey.m1 and clinical.survey.m1 aren't affected
# Remove filter so the No Collection counts show up, and then apply the filter so only true finalized collections are counted and given settings
coll_sett_all_m1 <- coll_sett_all_m1 %>%  
  #filter(BiospeCollection == "Any biospecimen Collections" & (d_410912345== 353358909 | BL_BioSpm_MWSetting_v1r0=="Home")) %>% 
    mutate(all_settings = case_when(BiospeCollection == "Any biospecimen Collections" & d_410912345== 353358909 & 
                                      (d_650516960=="664882224" | BL_BioSpm_BloodSetting_v1r0=="Clinical" | 
                                         BL_BioSpm_UrineSetting_v1r0=="Clinical") ~ "Clinical",
                                    
                                    BiospeCollection == "Any biospecimen Collections" & d_410912345== 353358909 & 
                                    (d_650516960=="534621077" | BL_BioSpm_BloodSetting_v1r0=="Research" | 
                                         BL_BioSpm_UrineSetting_v1r0=="Research" | BL_BioSpm_MWSetting_v1r0=="Research")~ "Research",
                                    
                                    BiospeCollection == "Any biospecimen Collections" &
                                    (d_650516960=="103209024" | BL_BioSpm_BloodSetting_v1r0=="Home" | 
                                         BL_BioSpm_UrineSetting_v1r0=="Home" | BL_BioSpm_MWSetting_v1r0=="Home") ~ "Home"))

#############



race_columns <- c("D_384191091_D_384191091_D_583826374", 
                  "D_384191091_D_384191091_D_636411467",
                  "D_384191091_D_384191091_D_458435048",
                  "D_384191091_D_384191091_D_706998638",
                  "D_384191091_D_384191091_D_973565052",
                  "D_384191091_D_384191091_D_586825330",
                  "D_384191091_D_384191091_D_412790539",
                  "D_384191091_D_384191091_D_807835037")


# All data is currently string values, need to convert "1" and "0" to 1 and 0 to be summarized
coll_sett_all_m1[race_columns] <- lapply(coll_sett_all_m1[race_columns], as.numeric)

coll_sett_all_m1$multi_racial <- ifelse(rowSums(coll_sett_all_m1[race_columns], na.rm = TRUE) > 1, 1, 0)

coll_sett_all_m1 <- coll_sett_all_m1 %>%  
  mutate(m1_race = case_when( ### Updte: naming 'race' to 'm1_race' to be able to differenciate in all the tables WHICH race is being referenced.
    d_949302066!="231311385" ~ "Module1 Not Completed", 
    multi_racial == 1 ~ "Multi-Racial",
    D_384191091_D_384191091_D_583826374 == 1 ~ "American Indian or Native American",
    D_384191091_D_384191091_D_636411467 == 1 ~ "Asian/Asian American",
    D_384191091_D_384191091_D_458435048 == 1 ~ "Black, African American, or African",
    D_384191091_D_384191091_D_706998638 == 1 ~ "Hispanic, Latino, or Spanish",
    D_384191091_D_384191091_D_973565052 == 1 ~ "Middle Eastern or North African",
    D_384191091_D_384191091_D_586825330 == 1 ~ "Hawaiian or Pacific Islander",
    D_384191091_D_384191091_D_412790539 == 1 ~ "White",
    (D_384191091_D_384191091_D_807835037 == 1 | !is.na(D_384191091_D_747350323)) ~ "Other",
    D_384191091_D_384191091_D_746038746==1 ~ "Prefer Not to Answer",
    TRUE ~ "Skipped this question"
  )) %>%
  mutate(m1_race = factor(m1_race, levels = c(
    "Multi-Racial",
    "American Indian or Native American",
    "Asian/Asian American",
    "Black, African American, or African",
    "Hispanic, Latino, or Spanish",
    "Middle Eastern or North African",
    "Hawaiian or Pacific Islander",
    "White",
    "Other",
    "Prefer Not to Answer",
    "Skipped this question",
    "Unknown",
    "Module1 Not Completed"   #forcing this row last in tables
  )))



# Re-define data sets using coll_sett_all_m1 for all Module1-derived variables: 

## Research Survey (& module 1): research.survey.m1 
research.survey.m1 <- coll_sett_all_m1 %>% filter(all_settings == "Research") %>%
  mutate(Site=droplevels(as.factor(siteAcronym)),
         ctime = round(as.numeric(difftime(as.POSIXct(ymd_hms(d_222161762)),as.POSIXct(ymd_hms(d_822499427)),units="mins")), digits=1),
         tm_biocolsuv = difftime(as.POSIXct(ymd_hms(d_222161762)),as.POSIXct(ymd_hms(d_331584571_d_266600170_d_840048338)),units="hours"), #time b/w survey completion to bio collection visit check in
         checktmvisit = case_when( as.numeric(tm_biocolsuv) >72 ~"> 72hrs",
                                   72 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 48 ~ "> 48 hrs to 72 hrs",
                                   48 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 24 ~ "> 24 hrs to 48 hrs",   
                                   24 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 12 ~ "> 12 hrs to 24 hrs",
                                   12 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) > 3 ~ "> 3 hrs to 12 hrs",  
                                   3 >= as.numeric(tm_biocolsuv) & as.numeric(tm_biocolsuv) >= 0 ~ "0 hrs to 3 hrs",
                                   d_265193023 != "Submitted" ~ "Not Submitted", 
                                   TRUE ~ "Missing Time"),
         #Waiting on Erin's approval for this change
         #tm_biocolsuv < 0 ~ "QC error,
         #is.na(tm_biocolsuv) ~ "Missing Time"),
         time_biochk = difftime(as.POSIXct(ymd_hms(d_331584571_d_266600170_d_343048998)),as.POSIXct(ymd_hms(d_331584571_d_266600170_d_840048338)),units="mins"),
         checktmvisit = factor(checktmvisit, levels=c( "Not Submitted", "Missing Time", "0 hrs to 3 hrs","> 3 hrs to 12 hrs",
                                                       "> 12 hrs to 24 hrs","> 24 hrs to 48 hrs","> 48 hrs to 72 hrs","> 72hrs"))) 



## Clincial Survey (& module 1): clinical.survey.m1

clinical_cols <- c("d_173836415_d_266600170_d_139245758",
                   "d_173836415_d_266600170_d_982213346",
                   "d_173836415_d_266600170_d_740582332")

coll_sett_all_m1 <- coll_sett_all_m1 %>%
  mutate(across(all_of(clinical_cols), ~ as.POSIXct(ymd_hms(.)), .names = "{.col}_clc"))

clinical.survey.m1 <- coll_sett_all_m1 %>%
  filter(all_settings == "Clinical") %>%
  mutate(
    clin.sv = case_when(
      d_253883960 == 231311385 ~ "Submitted",
      d_253883960 == 615768760 ~ "Started",
      d_253883960 == 972455046 ~ "Not Started"
    ),
    Site = droplevels(factor(Site)),
    d_173836415_d_266600170_d_139245758_clc = as.POSIXct(ymd_hms(d_173836415_d_266600170_d_139245758)),
    d_173836415_d_266600170_d_982213346_clc = as.POSIXct(ymd_hms(d_173836415_d_266600170_d_982213346)),
    d_173836415_d_266600170_d_740582332_clc = as.POSIXct(ymd_hms(d_173836415_d_266600170_d_740582332)),
    clinic.svtime = difftime(as.POSIXct(ymd_hms(d_764863765)), as.POSIXct(ymd_hms(d_534669573)), units = "hours"),
    ctime = round(as.numeric(clinic.svtime, units = "mins"), 1),
    clc.coltm = do.call(pmin, c(as.list(dplyr::select(., ends_with("clc"))), na.rm = TRUE)),
    tm_biocolsuv = difftime(as.POSIXct(ymd_hms(d_764863765)), clc.coltm, units = "hours"),
    checktmvisit = case_when(
      as.numeric(tm_biocolsuv) > 72 ~ "> 72hrs",
      between(as.numeric(tm_biocolsuv), 48, 72) ~ "> 48 hrs to 72 hrs",
      between(as.numeric(tm_biocolsuv), 24, 48) ~ "> 24 hrs to 48 hrs",
      between(as.numeric(tm_biocolsuv), 12, 24) ~ "> 12 hrs to 24 hrs",
      between(as.numeric(tm_biocolsuv), 3, 12)  ~ "> 3 hrs to 12 hrs",
      between(as.numeric(tm_biocolsuv), 0, 3)   ~ "0 hrs to 3 hrs",
      d_265193023 != 231311385                  ~ "Not Submitted",
      TRUE                                      ~ "Missing Time"
    )
  ) %>%
  mutate(
    checktmvisit = factor(checktmvisit, levels = c(
      "Not Submitted", "Missing Time", "0 hrs to 3 hrs",
      "> 3 hrs to 12 hrs", "> 12 hrs to 24 hrs",
      "> 24 hrs to 48 hrs", "> 48 hrs to 72 hrs", "> 72hrs"
    ))
  ) %>%
  droplevels()


```

\newpage
\newpage
\FloatBarrier

## Request 4: Biospecimen collection visits and biospecimen survey completion 

a. Overall and by site, age group, sex, race/ethnicity, collection type (clinical vs. research) 
b. Separately for home mouthwash collections

**NOTE:** Since the research and clinical collection surveys are two different processes, they are represented separately in the metrics report.

\FloatBarrier

### Biospecimen Collection Status (Table 4a: Parts 1-6)
```{r Request4a_parts1_6, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, results='asis'}

#=======================================================================================
# REQUEST 4 - PART A: Biospecimen Collection Status 
#=======================================================================================

# COLLECTION STATUS by Groups:

## Collections - By Site:
collection_bysite <- knitr::kable(table1_totals, col.names=c("Site", "Baseline Collection","No Baseline Collection", "Total Verified Participants"), 
                          caption='Table 4a.Part 1: Baseline Biospecimen Collection Status Among Verified Participants by Site', 
                          row.names=FALSE,align=c("l", rep("c", 3)), booktabs = TRUE) %>%  
  add_indent(seq(1, nrow(table1_totals) - 1)) %>% 
  kable_styling(latex_options = "scale_down") %>% 
    footnote(general = "Note: This table was taken directly from the Biospecimen Weekly Metrics Report: Table 1.1.", 
           general_title = "",
         footnote_as_chunk = TRUE, 
         escape = FALSE, 
         threeparttable = TRUE) 

## Collections - By Age Group:
collection_byage <- knitr::kable(BLCol_by_Age_df, 
             caption="Table 4a.Part 2: Biospecimen Collection Status Among Verified Participants by Age",
             row.names=FALSE, align=c("l",rep("c", 5)), booktabs = TRUE) %>%
    kable_styling(latex_options = "scale_down") %>%  
    add_indent(seq(1, nrow(BLCol_by_Age_df) - 1)) %>% 
  kableExtra::footnote(general="Note: This table was taken directly from the Biospecimen Weekly Metrics Report: Table 1.15. Age defined as the de-identified age data reported by sites at time of invitation, not current age at the time of specimen collection. Any missing or unknown age has been reported to the sites as a quality control issue to be resolved.",
           general_title = "",
           footnote_as_chunk = TRUE, 
           escape = FALSE, 
           threeparttable = TRUE)

### check for any Connect_IDs with unknown age:
 # unknown_age_table <- table1 %>%
 #   filter(is.na(age)) %>%
 #  select(Connect_ID, age, Site)

## Collections - By Race/Ethnicity - Site Reported:
collection_byrace_site <- knitr::kable(BLCol_by_Race_df, 
                              caption="Table 4a.Part 3: Baseline Biospecimen Collection Status Among Verified Participants by Site-Reported Race",
                              row.names=FALSE, align=c("l",rep("c", 5)), booktabs = TRUE) %>%
  kable_styling(latex_options = "scale_down") %>%  
  add_indent(seq(1, nrow(BLCol_by_Race_df) - 1)) %>% 
  kableExtra::footnote(general = "Note: Race defined as the de-identified race data reported by sites at time of invitation.",
           general_title = "",
           footnote_as_chunk = TRUE, 
           escape = FALSE, 
           threeparttable = TRUE)



## Collections - By Race/Ethnicity - Module 1 Reported:
BLCol_by_Race_m1 <- create_tbl_cross2(coll_sett_all_m1, "m1_race", "biocol.appoint", "row", "race", "Baseline Biospecimen Collection Status", "Total Verified Participants")

collection_byrace_m1 <- knitr::kable(
  BLCol_by_Race_m1,  
  caption = 'Table 4a.Part 4: Baseline Biospecimen Collection Status Among Verified Participants by Module 1-Reported Race', 
  row.names = FALSE,
  align = c("l", rep("c", 6)),
  booktabs = TRUE
) %>% 
  kable_styling(latex_options = "scale_down", "HOLD_position") 


## Collections - By Sex:
collection_bysex <- knitr::kable(BLCol_by_Sex_df, 
                             caption='Table 4a.Part 5: Baseline Biospecimen Collection Status Among Verified Participants by Sex',
                             row.names=FALSE, align=c("l",rep("c", 5)), booktabs = TRUE) %>%
  kable_styling(latex_options = "scale_down") %>%  
  add_indent(seq(1, nrow(BLCol_by_Sex_df) - 1)) %>% 
  kableExtra::footnote(general="Note: This table was taken directly from the Biospecimen Weekly Metrics Report: Table 1.14. Sex defined as the de-identified sex data reported by sites at time of invitation.",
           general_title = "",
           footnote_as_chunk = TRUE,
           escape = FALSE,
           threeparttable = TRUE)



## Collections - By Collection Type (redefine dataframe from Table 1.2):  
coll_sett_all_NR <- table1 %>%  
  filter(BiospeCollection == "Any biospecimen Collections" & (d_410912345== 353358909 | BL_BioSpm_MWSetting_v1r0=="Home")) %>% 
  mutate(all_settings = case_when((d_650516960=="534621077" | BL_BioSpm_BloodSetting_v1r0=="Research Only" | 
                                    BL_BioSpm_UrineSetting_v1r0=="Research" | BL_BioSpm_MWSetting_v1r0=="Research")~ "Research",
                                  
                                  (d_650516960=="664882224" | BL_BioSpm_BloodSetting_v1r0=="Clinical" | 
                                    BL_BioSpm_UrineSetting_v1r0=="Clinical") & d_684635302=="No mouthwash collected" ~ "Clinical Only", #exclude HMW
                                  
                                  (d_650516960=="103209024" | BL_BioSpm_BloodSetting_v1r0=="Home" | 
                                    BL_BioSpm_UrineSetting_v1r0=="Home" | BL_BioSpm_MWSetting_v1r0=="Home") &
                                    d_878865966=="No blood collected" & d_167958071=="No urine collected" ~ "Home MW Only", #exclude blood or urine
                                  
                                  (d_650516960=="103209024" | BL_BioSpm_BloodSetting_v1r0=="Home" | 
                                    BL_BioSpm_UrineSetting_v1r0=="Home" | BL_BioSpm_MWSetting_v1r0=="Home") ~ "Clinical + Home")) #else clinical & home

table1_allsett_NR <- create_tbl_cross(coll_sett_all_NR, "Site", "all_settings", "row", "Site", "Collection Setting")  

# Collections - By Collection Type:
collection_bytype <- knitr::kable(table1_allsett_NR, 
                                   caption='Table 4a.Part 6: Baseline Biospecimen Collection Status Among Verified Participants by Collection Type', 
                                   row.names=FALSE,align=c("l", rep("c", 3)), booktabs = TRUE) %>%  
  add_indent(seq(1, nrow(table1_allsett_NR) - 1)) %>% 
  kable_styling(latex_options = c("scale_down", "hold_position")) %>% 
  footnote(general = "Note: Any collections indicated under 'Clinical' setting reflect collections in which blood and or urine were the only sample(s) collected; those with any home mouthwash collections are excluded. Any collections indicated under 'Home' setting reflect collections in which home mouthwash was collected, regardless of whether blood or urine was collected.", 
           general_title = "",
         footnote_as_chunk = TRUE, 
         escape = FALSE, 
         threeparttable = TRUE) 


#Print tables - Collection visits by groups (Parts 1 - 6):
collection_bysite
collection_byage
collection_byrace_site
collection_byrace_m1
collection_bysex
collection_bytype
```

\FloatBarrier

### Biospecimen Survey Status (Research and Clinical separately) (Table 4a: Parts 7-16)

```{r Request4a_parts7_16, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, results='asis'}

#=======================================================================================
# REQUEST 4 - PART A: Survey Status (Research [BUM] & Clinical [BU])
#=======================================================================================


## By Site - dataframes:
BUM_status_site <- create_tbl_cross(research.survey, "Site", "d_265193023", "row", " ", " ")
colnames(BUM_status_site)[ncol(BUM_status_site)] = "Total Research Surveys"

BU_status_site <- create_tbl_cross(clinical.survey, "Site", "clin.sv","row", " ", " ")
colnames(BU_status_site)[ncol(BU_status_site)] = "Total Clinical Surveys"

### By Site - Research Collections:
bysite_research <- knitr::kable(
  BUM_status_site,  
  caption = 'Table 4a.Part 7: Baseline Biospecimen Survey Status Among Research Collections by Site', 
  row.names = FALSE,
  align = c("l", rep("c", 6)),
  booktabs = TRUE
) %>% 
  kable_styling(latex_options = "scale_down", "HOLD_position") %>% 
  footnote(general = "Note: This table was taken directly from the Biospecimen Weekly Metrics Report: Table 3.1.", 
           general_title = "",
         footnote_as_chunk = TRUE, 
         escape = FALSE, 
         threeparttable = TRUE) 

### By Site - Clinical Collections:
bysite_clinical <- knitr::kable(
  BU_status_site, 
  caption = 'Table 4a.Part 8: Baseline Biospecimen Survey Status Among Clinical Collections by Site', 
  row.names = FALSE,
  align = c("l", rep("c", 8)),
  booktabs = TRUE
) %>% 
  kable_styling(latex_options = "scale_down", "HOLD_position") %>% 
  footnote(general = "Note: This table was taken directly from the Biospecimen Weekly Metrics Report: Table 3.2.", 
           general_title = "",
         footnote_as_chunk = TRUE, 
         escape = FALSE, 
         threeparttable = TRUE) 




## By Age Group - dataframes:
BUM_status_age <- create_tbl_cross(research.survey, "age", "d_265193023", "row", " ", " ")
colnames(BUM_status_age)[ncol(BUM_status_age)] = "Total Research Surveys"

BU_status_age <- create_tbl_cross(clinical.survey, "age", "clin.sv","row", " ", " ")
colnames(BU_status_age)[ncol(BU_status_age)] = "Total Clinical Surveys"

### By Age - Research Collections:
byage_research <- knitr::kable(
  BUM_status_age,  
  caption = 'Table 4a.Part 9: Baseline Biospecimen Survey Status Among Research Collections by Age Group', 
  row.names = FALSE,
  align = c("l", rep("c", 6)),
  booktabs = TRUE
) %>% 
  kable_styling(latex_options = "scale_down", "HOLD_position") %>% 
  footnote(general = "Note: Age defined as the de-identified age data reported by sites at time of invitation. Any missing or unknown age has been report to the sites as a quality control issue to be resolved.", 
           general_title = "",
         footnote_as_chunk = TRUE, 
         escape = FALSE, 
         threeparttable = TRUE) 

### By Age - Clinical Collections:
byage_clinical <- knitr::kable(
  BU_status_age, 
  caption = 'Table 4a.Part 10: Baseline Biospecimen Survey Status Among Clinical Collections by Age Group ', 
  row.names = FALSE,
  align = c("l", rep("c", 8)),
  booktabs = TRUE
) %>% 
  kable_styling(latex_options = "scale_down", "HOLD_position") %>% 
  footnote(general = "Note: Age defined as the de-identified age data reported by sites at time of invitation. Any missing or unknown age has been report to the sites as a quality control issue to be resolved.", 
           general_title = "",
         footnote_as_chunk = TRUE, 
         escape = FALSE, 
         threeparttable = TRUE) 



### By Race/Ethnicity - dataframes:
BUM_status_race <- create_tbl_cross(research.survey, "race", "d_265193023", "row", " ", " ")
colnames(BUM_status_race)[ncol(BUM_status_race)] = "Total Research Surveys"

BUM_status_race_m1 <- create_tbl_cross(research.survey.m1, "m1_race", "d_265193023", "row", " ", " ")
colnames(BUM_status_race_m1)[ncol(BUM_status_race_m1)] = "Total Research Surveys" 

BU_status_race <- create_tbl_cross(clinical.survey, "race", "clin.sv","row", " ", " ")
colnames(BU_status_race)[ncol(BU_status_race)] = "Total Clinical Surveys" 

BU_status_race_m1 <- create_tbl_cross(clinical.survey.m1, "m1_race", "clin.sv","row", " ", " ")
colnames(BU_status_race_m1)[ncol(BU_status_race_m1)] = "Total Clinical Surveys" 

### By Site-Reported Race/Ethnicity - Research Collections:
byrace_site_research <- knitr::kable(
  BUM_status_race,  
  caption = 'Table 4a.Part 11: Baseline Biospecimen Survey Status Among Research Collections by Site-Reported Race/Ethnicity', 
  row.names = FALSE,
  align = c("l", rep("c", 6)),
  booktabs = TRUE
) %>% 
  kable_styling(latex_options = "scale_down", "HOLD_position") %>% 
  kableExtra::footnote(general = "Note: Race defined as the de-identified race data reported by sites at time of invitation.",
           general_title = "",
           footnote_as_chunk = TRUE, 
           escape = FALSE, 
           threeparttable = TRUE)

### By Module1-Reported Race/Ethnicity - Research Collections:
byrace_m1_research <- knitr::kable(
  BUM_status_race_m1,  
  caption = 'Table 4a.Part 12: Baseline Biospecimen Survey Status Among Research Collections by Module1-Reported Race/Ethnicity', 
  row.names = FALSE,
  align = c("l", rep("c", 6)),
  booktabs = TRUE
) %>% 
  kable_styling(latex_options = "scale_down", "HOLD_position") 
 
### By Site-Reported Race/Ethnicity - Clinical Collections:
byrace_site_clinical <- knitr::kable(
  BU_status_race,  
  caption = 'Table 4a.Part 13: Baseline Biospecimen Survey Status Among Clinical Collections by Site-Reported Race/Ethnicity', 
  row.names = FALSE,
  align = c("l", rep("c", 6)),
  booktabs = TRUE
) %>% 
  kable_styling(latex_options = "scale_down", "HOLD_position") %>% 
  kableExtra::footnote(general = "Note: Race defined as the de-identified race data reported by sites at time of invitation.",
           general_title = "",
           footnote_as_chunk = TRUE, 
           escape = FALSE, 
           threeparttable = TRUE)

### By Module1-Reported Race/Ethnicity - Clinical Collections:
byrace_m1_clinical <- knitr::kable(
  BU_status_race_m1,  
  caption = 'Table 4a.Part 14: Baseline Biospecimen Survey Status Among Clinical Collections by Module1-Reported Race/Ethnicity', 
  row.names = FALSE,
  align = c("l", rep("c", 6)),
  booktabs = TRUE
) %>% 
  kable_styling(latex_options = "scale_down", "HOLD_position") 
 



## By Sex - dataframes:
BUM_status_sex <- create_tbl_cross(research.survey, "sex", "d_265193023", "row", " ", " ")
colnames(BUM_status_sex)[ncol(BUM_status_sex)] = "Total Research Surveys"

BU_status_sex <- create_tbl_cross(clinical.survey, "sex", "clin.sv", "row", " ", " ")
colnames(BU_status_sex)[ncol(BU_status_sex)] = "Total Clinical Surveys"



### By Sex - Research Collections:
bysex_research <- knitr::kable(
  BUM_status_sex,  
  caption = 'Table 4a.Part 15: Baseline Biospecimen Survey Status Among Research Collections by Sex', 
  row.names = FALSE,
  align = c("l", rep("c", 6)),
  booktabs = TRUE
) %>% 
  kable_styling(latex_options = "scale_down", "HOLD_position") 

### By Sex - Clinical Collections:
bysex_clinical <- knitr::kable(
  BU_status_sex, 
  caption = 'Table 4a.Part 16: Baseline Biospecimen Survey Status Among Clinical Collections by Sex', 
  row.names = FALSE,
  align = c("l", rep("c", 8)),
  booktabs = TRUE
) %>% 
  kable_styling(latex_options = "scale_down", "HOLD_position") 

###

# Print tables: 
print(bysite_research)
print(bysite_clinical)
print(byage_research)
print(byage_clinical)
print(byrace_site_research)
print(byrace_m1_research)
print(byrace_site_clinical)
print(byrace_m1_clinical)
print(bysex_research)
print(bysex_clinical)
```

\FloatBarrier
\newpage
\FloatBarrier

### Home Mouthwash Collections (Table 4b: Parts 1-5)

```{r Request4b, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, results='asis'}

#================================================
# REQUEST 4 - PART B: Mouthwash
#================================================

# Add in MW variables from coll_sett_all_m1
kit_table_merged <- kit_table %>%
  mutate(Connect_ID = as.character(Connect_ID)) %>%
  left_join(
    coll_sett_all_m1 %>%
      mutate(Connect_ID = as.character(Connect_ID)) %>%
      dplyr::select(Connect_ID, siteAcronym, age, sex, race, m1_race, all_settings),
    by = "Connect_ID"
  ) %>%
  left_join(
    clinical.survey.m1 %>%
      mutate(Connect_ID = as.character(Connect_ID)) %>%
      dplyr::select(Connect_ID, m1_race) %>%
      rename(multi_race = m1_race),
    by = "Connect_ID"
  )

# grep("race", names(kit_table_merged), value = TRUE)
# unique(kit_table_merged$race) 
# unique(kit_table_merged$multi_race)   


MW_status <- kit_table_merged %>%  filter(Kit_Status_r2=="Received" | Kit_Status_r1=="Received" | Kit_Status_int=="Received") %>%
  mutate(MWSrvy_status = case_when(d_547363263==972455046 ~ "Not Started",
                                   d_547363263==615768760 ~ "Started",
                                   d_547363263==231311385 ~ "Submitted"),
         MWSrvy_status = factor(MWSrvy_status, levels=c("Not Started","Started", "Submitted")))  



#MW_bysite
MW_status_bysite <- create_tbl_cross(MW_status, "Site", "MWSrvy_status", "row", "Site", " ")
colnames(MW_status_bysite)[ncol(MW_status_bysite)] <- "Total Participants with Received Kits"


knitr::kable(MW_status_bysite,
             caption="Table 4b. Part 1: Baseline - Mouthwash Biospecimen Survey Status Among Any Received Home Mouthwash Kits by Site",
             row.names=FALSE, align=c("l", rep("c", 4)),booktabs = TRUE) %>% 
  add_indent(seq(1, nrow(MW_status_bysite) - 1)) %>% 
  kable_styling(latex_options = "scale_down") %>% 
  kableExtra::footnote(
    general = "Note: This table was taken directly from Biospecimen Weekly Metrics Report: Table 7.7.",
    general_title = " "
  )
 

#MW_byage
MW_status_byage <- create_tbl_cross2(
  MW_status,
  "age",
  "MWSrvy_status",
  "row",
  "Age",
  " ",
  margin_text = "Total Participants with Received Kits"
)
colnames(MW_status_byage)[ncol(MW_status_byage)] <- "Total Verified Participants"


knitr::kable(MW_status_byage, 
  caption="Table 4b. Part 2: Baseline - Mouthwash Biospecimen Survey Status Among Any Received Home Mouthwash Kits by Age Group",
  row.names=FALSE, align=c("l", rep("c", 5)), booktabs = TRUE) %>%
  kable_styling(latex_options = "scale_down") %>%
  add_indent(seq(1, nrow(MW_status_bysite) - 1)) %>%
  footnote(general = "Note: Age defined as the de-identified age data reported by sites at time of invitation. Any missing or unknown age has been report to the sites as a quality control issue to be resolved.", 
           general_title = "",
         footnote_as_chunk = TRUE, 
         escape = FALSE, 
         threeparttable = TRUE) 

### check for any Connect_IDs with unknown age:
# unknown_age_table_MW <- MW_status %>%
#   filter(is.na(age)) %>%
#   select(Connect_ID, age, Site)

#MW_byrace_site
MW_status_byrace_site <- create_tbl_cross2(
  MW_status,
  "race",
  "MWSrvy_status",
  "row",
  "race",
  " ",
  margin_text = "Total Participants with Received Kits"
)
colnames(MW_status_byrace_site)[ncol(MW_status_byrace_site)] <- "Total Verified Participants"


knitr::kable(MW_status_byrace_site, 
  caption="Table 4b. Part 3: Baseline - Mouthwash Biospecimen Survey Status Among Any Received Home Mouthwash Kits by Site-Reported Race/Ethnicity",
  row.names=FALSE, align=c("l", rep("c", 5)), booktabs = TRUE) %>%
    footnote(general = "Note: Race defined as the de-identified race data reported by sites at time of invitation.", 
           general_title = "",
         footnote_as_chunk = TRUE, 
         escape = FALSE, 
         threeparttable = TRUE) %>%
  kable_styling(latex_options = "scale_down") %>%
  add_indent(seq(1, nrow(MW_status_byrace_site) - 1)) 


#MW_byrace_m1
MW_status_byrace_m1 <- create_tbl_cross2(
  MW_status,
  "multi_race",
  "MWSrvy_status",
  "row",
  "multi_race",
  " ",
  margin_text = "Total Participants with Received Kits"
)
colnames(MW_status_byrace_m1)[ncol(MW_status_byrace_m1)] <- "Total Verified Participants"


knitr::kable(MW_status_byrace_m1, 
  caption="Table 4b. Part 4: Baseline - Mouthwash Biospecimen Survey Status Among Any Received Home Mouthwash Kits by Module1-Reported Race/Ethnicity",
  row.names=FALSE, align=c("l", rep("c", 5)), booktabs = TRUE) %>%
  kable_styling(latex_options = "scale_down") %>%
  add_indent(seq(1, nrow(MW_status_byrace_m1) - 1))
  


#MW_bysex
MW_status_bysex <- create_tbl_cross2(
  MW_status,
  "sex",
  "MWSrvy_status",
  "row",
  "sex",
  " ",
  margin_text = "Total Participants with Received Kits"
)
colnames(MW_status_bysex)[ncol(MW_status_bysex)] <- "Total Verified Participants"


knitr::kable(MW_status_bysex, 
  caption="Table 4b. Part 5: Baseline - Mouthwash Biospecimen Survey Status Among Any Received Home Mouthwash Kits by Sex",
  row.names=FALSE, align=c("l", rep("c", 5)), booktabs = TRUE) %>%
  kable_styling(latex_options = "scale_down") %>%
  add_indent(seq(1, nrow(MW_status_bysex) - 1)) 



###

# Print tables - Request 4b: Parts 1-5: 
# print(MW_bysite)
# print(MW_byage)
# print(MW_byrace_site)
# print(MW_byrace_m1)
# print(MW_bysex)

```

\FloatBarrier
\newpage

## Request 5: Number of specimens collected

a. Overall
b. By specimen type

\FloatBarrier
```{r Request5, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, results='asis'}

#================================================
# REQUEST 5: Number of Specimens Collected
#================================================

spec_by_site_R2 <- create_tbl_cross(table4_redone__R, 'Specimens Collected', "Site", "row", " ", " ")
colnames(spec_by_site_R2)[ncol(spec_by_site_R2)] <- "Total Research Collections"

knitr::kable(spec_by_site_R2 , 
             caption='Table 5a: Baseline Research Biospecimens Collected by Specimen Type', 
             row.names=FALSE,align=c("l",rep("c", 6)), booktabs = TRUE)  %>% 
  kable_styling(latex_options = "scale_down") %>% 
  landscape() %>% 
  kableExtra::footnote(
    general = "Note: This table was taken directly from Biospecimen Weekly Metrics Report: Table 2.1",
    general_title = " "
  )

spec_by_site_C2 <- create_tbl_cross(table4_redone__C, 'Specimens Collected', "Site", "row", " ", " ")
colnames(spec_by_site_C2)[ncol(spec_by_site_C2)] <- "Total Clinical Collections"

knitr::kable(spec_by_site_C2, 
             caption='Table 5b: Baseline Clinical Biospecimens Collected by Specimen Type', 
             row.names=FALSE,align=c("l",rep("c", 9)), booktabs = TRUE)  %>% 
  kable_styling(latex_options = "scale_down")  %>% 
  landscape() %>% 
  kableExtra::footnote(
    general = "Note: This table was taken directly from Biospecimen Metrics Weekly Report: Table 2.2",
    general_title = " "
  )
```

\FloatBarrier
\newpage

## Request 6: Needle to processing time

**NOTE:** Table 6a (Clinical) and Table 6b (Research) were taken directly from the Biospecimen Weekly Metrics Report: Table 5.4 and Table 5.2, respectively. Totals per IHC and overall were generated for each collection approach separately.


```{r Request6, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, results='asis'}
## Note: In previous metrics reports, there were no totals per IHC. Kelsey added / modified code for in Section Table28b to generate these totals

#================================================
# REQUEST 6: Needle to Processing Time
#================================================

# BY CLINICAL COLLECTIONS
# Table 6a: Baseline Collection-To-Receipt Time (in Days) Among Clinical Collections by Site

ctable_clin_loc_bptl <- knitr::kable(clin_coll_times[, c(1:7)], 
caption="Table 6a: Baseline Collection-To-Receipt Time (in Days) \n Among Clinical Collections by Clinic Location",
col.names=c("Collection Location","1 Day","2 Days","3 Days","4 Day",">4 Days","Total Received Clinical Collections"),
                                     align=c("l",rep("c", 6)), 
                                     booktabs = TRUE, longtable = TRUE) %>%  
  pack_rows(index = site_group_counts) %>%  # Ensure "Total" is last
  row_spec(which(clin_coll_times$Collection_Location %in% names(site_group_counts)), hline_after = TRUE) %>%
  kable_styling(latex_options = "scale_down", full_width = FALSE, font_size=7) %>% 
  landscape() %>% 
  kableExtra::footnote(general = paste0("Note: At the time of reporting, ", dim(biospe_adhoc2_missings)[[1]], 
                              " of the Clinical Collections did not have collection and/or receipt date/time information available."), 
           general_title = "",
           footnote_as_chunk = TRUE, 
           escape = FALSE, 
           threeparttable = TRUE)

ctable_clin_loc_bptl

# BY RESEARCH COLLECTIONS
# Table 6b: Baseline Collection-To-Receipt Time (in Days) Among Research Collections by Site

rsch_coll_times52_6b <- knitr::kable(rsch_coll_times[, c(1:7)], 
             caption="Table 6b: Baseline Collection-To-Receipt Time (in Days) Among Research Collections by Collection Location",
             col.names=c("Collection Location","1 Day","2 Days","3 Days","4 Day",">4 Days","Total Received Research Collections"),
             align=c("l",rep("c", 6)), 
             booktabs = TRUE, longtable = TRUE) %>%  
  pack_rows(index = site_group_counts) %>%  # Ensure "Total" is last
    row_spec(which(rsch_coll_times$Collection_Location %in% names(site_group_counts)), hline_after = TRUE) %>%
    kable_styling(latex_options = "scale_down", full_width = FALSE, font_size=7) %>% 
  landscape() %>% 
  kableExtra::footnote(general = paste0("Note: At the time of reporting, ", dim(biospe_adhoc_missings)[[1]], 
                            " of the Research Collections do not have receipt date/time information available."), 
           general_title = "",
           footnote_as_chunk = TRUE, 
           escape = FALSE, 
           threeparttable = TRUE)

rsch_coll_times52_6b

# print(clin_coll_times[, 1:7])
# rsch_coll_times[, 1:7] 

```

\FloatBarrier
\newpage

## Request 7: Biospecimen collection incidents and deviations

  - Incidents at biospecimen collection: Non-complete draws, fainting, other incidents
  - Incidents after collection, before arrival at NCI lab
  - Processing incidents and deviations

**NOTE:** Many of the requested tables can be found in Baseline Collection Completeness section of the Biospecimen Metrics 

```{r Request7, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, results='asis'}

#============================================================
# REQUEST 7: Biospecimen Collection Incidents and Deviations
#============================================================

# TABLES DIRECTLY FROM BIOSPECIMEN REPORT:

# Table7a: Total Number of Deviations from Baseline Specimens by Site
Table7a <- knitr::kable(Deviation_Freq,
                      col.names=c("Site","Any Deviations","No Deviations", "Total Tubes Collected"), 
                      caption='Table 7a: Total Number of Deviations from Baseline Specimens by Site',
                      row.names=FALSE, align=c("l",rep("c", 3)), booktabs = TRUE ) 
add_footnote(Table7a, "Note: This table was taken directly from Biospecimen Weekly Metrics Report: Table 2.5. This table includes deviations on all baseline specimens except home mouthwash.", notation = "none") 


# Table7b: 
Table7b <- knitr::kable(discard.site, 
             caption='Table 7b: Number of Discarded Tubes Among Biospecimen Collections by Tube Type and Site', 
             row.names=FALSE,  
             align=c("l",rep("c", 10)), booktabs = TRUE) %>%
  kable_styling(latex_options = "scale_down")
add_footnote(Table7b, "Note: This table was taken directly from Biospecimen Weekly Metrics Report: Table 2.8. 'Short Draw' reason applicable to blood collection tubes only.", notation="none")


# Table7c: Reason Not Collected Among Baseline Research Collection Tubes by Site
Table7c <- knitr::kable(reason_notcol,  
                         caption='Table 7c: Reason Not Collected Among Baseline Research Collection Tubes by Site', 
                         row.names=FALSE,align=c("l",rep("c", 7)), booktabs = TRUE) %>%  
  add_indent(seq(1, nrow(reason_notcol) - 1)) %>% 
  kable_styling(latex_options = "scale_down")
add_footnote(Table7c,"Note: This table was taken directly from Biospecimen Weekly Metrics Report: Table 2.6. The 'Short Draw' is applicable to blood collection tubes only.", notation="none")


# Table7d: Reason Not Collected Among Baseline Research Collection Tubes by Site
Table7d <- knitr::kable(tube_type_notcolreasons,  
                          caption='Table 7d: Reason Not Collected Among Baseline Research Collection Tubes by Tube Type',
                          row.names=FALSE,align=c("l",rep("c", 7)), booktabs = TRUE)  %>%  
  add_indent(seq(1, nrow(tube_type_notcolreasons) - 1))  %>% 
  kable_styling(latex_options = "scale_down")
add_footnote(Table7d, "Note: This table was taken directly from Biospecimen Weekly Metrics Report: Table 2.7. 'Short Draw' reason applicable to blood collection tubes only.", notation="none")
```
\FloatBarrier
\newpage

```{r Request7_dataset, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, results='asis'}

coll_sett_all<- coll_sett_all%>% arrange(Site)

tubes <- unique(y[grepl(" Tube ",y$`Secondary.Source`),c("conceptId.1","Secondary.Source")])
#tubes[grepl("00", tubes$`Variable Name`),]


bld.ls <- c("d_299553921","d_703954371","d_454453939","d_838567176","d_652357376","d_376960806","d_232343615","d_589588440","d_677469051", "d_683613884","d_958646668", "d_505347689") #STRECK added 

tubeid <- grep("d_825582494", names(coll_sett_all), value=TRUE) #tube ID
deviation <- grep("d_678857215",names(coll_sett_all),value=TRUE) 
colid <- grep("d_593843561", names(coll_sett_all), value=TRUE) #collected yes/no
discard <- grep("d_762124027",names(coll_sett_all),value=TRUE) #discard yes/no
biodiscard <- coll_sett_all[,(which(names(coll_sett_all) %in% discard))]

coll_sett_all$blddev <- 0 #blood deviations
coll_sett_all$bldcol <- 0 #blood collections
coll_sett_all$blddid <- 0 #discarded
for(i in 1:length(bld.ls)){
  
  bldcol <- ifelse(coll_sett_all[,paste(bld.ls[i],"d_593843561",sep="_")] == 104430631 | is.na(coll_sett_all[,paste(bld.ls[i],"d_593843561",sep="_")]),0,1)  ##for tube collected
  
  blddev <- ifelse(coll_sett_all[,paste(bld.ls[i],"d_678857215",sep="_")]==104430631 | is.na(coll_sett_all[,paste(bld.ls[i],"d_678857215",sep="_")]),0,1) #for tube deviations yes/no
  
  blddid <- ifelse(coll_sett_all[,paste(bld.ls[i],"d_762124027",sep="_")]==104430631 | is.na(coll_sett_all[,paste(bld.ls[i],"d_762124027",sep="_")]),0,1)
  
  coll_sett_all$blddev <- coll_sett_all$blddev+blddev
  coll_sett_all$bldcol <- bldcol + coll_sett_all$bldcol ###to check collection
  coll_sett_all$blddid <- coll_sett_all$blddid+blddid  
  
}

#table(coll_sett_all$d_650516960,coll_sett_all$bldcol)
coll_sett_all<- coll_sett_all%>% mutate(bloodcomplete = ifelse((d_650516960==534621077 & bldcol == 5) | (d_650516960==664882224 & bldcol == 11), "Blood.Completion" ,#blood collection completion
                                                   ifelse( (d_650516960==534621077 & (bldcol<5 & bldcol>0)) | (d_650516960==664882224 & (bldcol <  11 & bldcol > 0)),"Blood.Incompleted","NoBlood")),
                            Urine_col = ifelse(d_973670172_d_593843561==353358909, 1, ifelse(d_973670172_d_593843561==104430631,0,0)),
                            MW_col = ifelse(d_143615646_d_593843561==353358909,1,ifelse(d_143615646_d_593843561==104430631,0,0)),
                            biocol_Setting = case_when(d_650516960==534621077  ~"Research",
                                                       d_650516960==664882224 ~ "Clinical",
                                                       d_650516960 ==103209024 ~ "Home")) 
coll_sett_all$Biospe_col <- coll_sett_all$bldcol + coll_sett_all$Urine_col + coll_sett_all$MW_col    
coll_sett_all$BaseBLDCol <-ifelse(coll_sett_all$bldcol>0,1,ifelse(is.na(coll_sett_all$bldcol),NA,0)) #blood collection Yes/No
#coll_sett_all[duplicated(coll_sett_all$Connect_ID),]$Connect_ID



#Participants who checked in for a baseline biospecimen visit but did not give any samples

tube_col <- coll_sett_all %>% group_by(as.character(Connect_ID),Site,all_settings) %>% 
  filter(d_410912345== 353358909) %>% 
  dplyr::summarise(bldcol_max = max(bldcol),
                   Urine_col_max= max(Urine_col),
                   MW_col_max=max(MW_col),
                   d_973670172_d_593843561_max=max(d_973670172_d_593843561),
                   d_143615646_d_593843561_max = max(d_143615646_d_593843561),
                   d_410912345_max=max(d_410912345),
                   collection.tm =max(as.POSIXct(ymd_hms(d_556788178))),
                   schedulecol.tm =min(as.POSIXct(ymd_hms(d_678166505))))

#dd[grepl("BioChk",dd$`Variable Name`),]
names(tube_col)[names(tube_col) == "as.character(Connect_ID)"] <- "Connect_ID"
recr_bio <- base::merge(recrver1,tube_col,by="Connect_ID")
bio_checkin_resh <- recr_bio  %>% filter(!is.na(d_331584571_d_266600170_d_840048338) & all_settings=="Research") %>% select(BiospeCollection ) %>% tbl_summary()
#table(bio_checkin_resh$BiospeCollection)

tubes <- unique(y[grepl(" Tube ",y$`Secondary.Source`),c("conceptId.1","Secondary.Source")])
tube.ls <- paste0("d_", trimws(paste(tubes$conceptId.1,collapes="")))

coll_sett_all$tubedev <- 0 #biospecimen deviations
coll_sett_all$tubecol <- 0 #tube collections
coll_sett_all$tubedid <- 0 #tube discarded

for(i in 1:length(tube.ls)){
  
  tubecol <- ifelse(coll_sett_all[,paste(tube.ls[i],"d_593843561",sep="_")] == 104430631 | is.na(coll_sett_all[,paste(tube.ls[i],"d_593843561",sep="_")]),0,1)  ##for tube collected
  
  tubedev <- ifelse(coll_sett_all[,paste(tube.ls[i],"d_678857215",sep="_")]==104430631 | is.na(coll_sett_all[,paste(tube.ls[i],"d_678857215",sep="_")]),0,1) #for tube deviations yes/no
  
  tubedid <- ifelse(coll_sett_all[,paste(tube.ls[i],"d_762124027",sep="_")]==104430631 | is.na(coll_sett_all[,paste(tube.ls[i],"d_762124027",sep="_")]),0,1)
  
  coll_sett_all$tubedev <- coll_sett_all$tubedev+tubedev
  coll_sett_all$tubecol <- tubecol + coll_sett_all$tubecol ###to check collection
  coll_sett_all$tubedid <- coll_sett_all$tubedid+tubedid  
}
#table(coll_sett_all$tubecol)
#table(coll_sett_all$tubedev)




coll_sett_all$tube_nodev <- coll_sett_all$tubecol-coll_sett_all$tubedev
total1 <- sum(coll_sett_all$tubedev) 
total2 <- sum(coll_sett_all$tube_nodev) 
tube_dev <- as.data.frame(aggregate( coll_sett_all$tubedev,                
                                     by = list(coll_sett_all$Site),              
                                     FUN = sum))
tube_nodev <- as.data.frame(aggregate( coll_sett_all$tube_nodev,               
                                       by = list(coll_sett_all$Site),              
                                       FUN = sum))



Deviation_Freq <- base::merge(tube_dev,tube_nodev,by="row.names")

Deviation_Freq <- Deviation_Freq[,c(2,3,5)]
Deviation_Freq$Total <- Deviation_Freq[,2]+Deviation_Freq[,3]
Deviation_Freq$dev_n_pct <- ifelse(Deviation_Freq[,2] >0, paste0(format(Deviation_Freq[,2],big.mark=",")," (", round(100*Deviation_Freq[,2]/Deviation_Freq$Total, 1)," %)"), "0 (0 %)")
Deviation_Freq$nodev_n_pct <- ifelse(Deviation_Freq[,3] >0, paste0(format(Deviation_Freq[,3],big.mark=",")," (",  round(100*Deviation_Freq[,3]/Deviation_Freq$Total,1), " %)"), "0 (0 %)")

Deviation_Freq[10,c(1:6)] <- c("Total",total1, total2,format(sum(coll_sett_all$tubecol),big.mark=","),
                               paste0(format(total1,big.mark=",")," (", round(100*sum(as.numeric(Deviation_Freq[1:9,2]))/sum(as.numeric(Deviation_Freq$Total), na.rm=T), 1)," %)"),  
                               paste0(format(total2,big.mark=",")," (", round(100*sum(as.numeric(Deviation_Freq[1:9,3]))/sum(as.numeric(Deviation_Freq$Total), na.rm=T),1)," %)"))     
Deviation_Freq <- Deviation_Freq %>% mutate(Site = ifelse(is.na(Group.1.x), "Total",  as.character(Group.1.x))) ###to replace NA in the factor variable



#Number of deviations by biospecimen type and by tube type 
tubes <- unique(y[grepl(" Tube ",y$`Secondary.Source`),c("conceptId.1","Secondary.Source")])
tube.ls <- paste0("d_", trimws(paste(tubes$conceptId.1,collapes="")))

dev_tube <- NULL
for (i in 1:length(tube.ls)){
  
  id <- paste(tube.ls[i],"d_825582494",sep="_")
  tube <- paste(tube.ls[i],"d_678857215",sep="_")
  tube_dev <- paste(tube.ls[i],"d_248868659", sep="_")
  deviation <- grep(tube_dev,colnames(coll_sett_all),value=TRUE)
  tmp <- as.data.frame(coll_sett_all[,which(colnames(coll_sett_all) %in% c(id,tube,deviation))] )
  tmp <- tmp[which(!is.na(tmp[,(colnames(tmp) == id)])),]
  
  dev_long <- reshape2::melt(tmp, 
                               id.vars=c(id,tube), 
                               measure.vars=deviation,
                               variable.name="dev_type",
                               value.name="deviation")
  
  
  colnames(dev_long)[grep("d_678857215",names(dev_long))] <- "d_678857215"
  colnames(dev_long)[grep("d_825582494",names(dev_long))] <- "TubeID"
  
  dev_long <- dev_long[complete.cases(dev_long[,c("TubeID","d_678857215","dev_type","deviation")]),]
  
  dev_tube <- dplyr::bind_rows(dev_tube,dev_long)
  
}  

dev_tube1   <- dev_tube %>% filter(d_678857215 ==353358909 & deviation == 353358909)  %>%  
  mutate(biospecimen=ifelse(grepl("d_973670172",dev_type), "urine",
                            ifelse(grepl("d_143615646",dev_type),"Mouthwash","blood")),
         tube_type = case_when(grepl("d_973670172",dev_type) ~ "Urine Tube1",
                               grepl("d_143615646",dev_type) ~ "MW Tube1",
                               grepl("d_299553921",dev_type) ~ "SS Tube1",
                               grepl("d_703954371",dev_type) ~ "SS Tube2",
                               grepl("d_454453939",dev_type) ~ "EDTA Tube1",
                               grepl("d_838567176",dev_type) ~ "Heparin Tube1",
                               grepl("d_652357376",dev_type) ~ "ACD Tube1",
                               grepl("d_677469051",dev_type) ~ "EDTA Tube2",
                               grepl("d_683613884",dev_type) ~ "EDTA Tube3",
                               grepl("d_376960806",dev_type) ~ "SS Tube3",
                               grepl("d_232343615",dev_type) ~ "SS Tube4",
                               grepl("d_589588440",dev_type) ~ "SS Tube5",
                               grepl("d_958646668",dev_type) ~ "Heparin Tube2",
                               grepl("d_505347689",dev_type) ~ "STRECK Tube1"), 
         
         deviationnotes =case_when(sapply(strsplit(as.character(dev_type),"d_"),tail,1) =="102695484" ~ "Deviation Clot < 30min",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="242307474" ~ "Hemolyzed", 
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="283900611" ~ "Mislabel Resolved",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="313097539" ~ "Outside Contamated",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="453343022" ~ "Other",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="472864016" ~ "Broken", 
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="550088682" ~ "Temparture Too Low",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="561005927" ~ "Cent Low",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="635875253" ~ "Broken Gel",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="654002184" ~ "Centrifuge Too Long",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="684617815" ~ "MisLabled Discard",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="690540566" ~"Tempature Too High",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="728366619" ~"Low Volume-(tube/container partially filled but still usable)",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="742806035" ~"MW < 30s",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="757246707" ~"Leak/Spilled",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="777486216" ~"Tube Size",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="810960823" ~"Discard",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="861162895" ~"Cent High",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="912088602" ~"Clot > 2h",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="937362785" ~"Centrifuge Too Short",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="956345366" ~"Insufficient Volume",
                                   sapply(strsplit(as.character(dev_type),"d_"),"[[",4) =="982885431" ~ "Not Found"))
notcol_tubes <- colnames(coll_sett_all)[grepl("883732523",colnames(coll_sett_all))] 
col_tubes <- colnames(coll_sett_all)[grepl("d_593843561",colnames(coll_sett_all))] 
dev_tubes <- colnames(coll_sett_all)[grepl("d_678857215",colnames(coll_sett_all))] 
notcol.ls <- sapply(strsplit(notcol_tubes, "_d"),"[[",1)
notcol_tube <- NULL
tubenotcol.ls <-list()


for (i in 1:length(notcol.ls)){
  
  tubecol <- paste(notcol.ls[i],"d_593843561",sep="_")
  tube_notcol <- paste(notcol.ls[i],"d_883732523", sep="_") #notcolnotes
  TubeID <- paste(tube.ls[i],"d_825582494",sep="_")
  
  tube_deviation <- paste(notcol.ls[i], "d_678857215",sep="_")
  
  select <- c(TubeID,tubecol,tube_notcol,tube_deviation)
  tmp <- coll_sett_all[,(colnames(coll_sett_all)%in% c(select,"d_820476880","Site","biocol_Setting"))] 
  notcol <- tmp 
  colnames(notcol)[colnames(notcol)==TubeID] <- "TubeID"
  colnames(notcol)[colnames(notcol)==tubecol] <- "tubecol"
  colnames(notcol)[colnames(notcol)==tube_notcol] <- "tube_notcol"
  
  colnames(notcol)[colnames(notcol)==tube_deviation] <- "tube_deviation"
  
  
  notcol$tubeID <- notcol.ls[i]
  
  notcol_tube <- dplyr::bind_rows(notcol_tube,notcol)
  
} 


collection_long <- NULL
for (i in 1:length(tube.ls)){
  
  tubeid <- paste(tube.ls[i],"d_825582494",sep="_")
  tubecol <- paste(tube.ls[i],"d_593843561",sep="_")
  tube_deviation <- paste(tube.ls[i], "d_678857215",sep="_")
  tube_discard <- paste(tube.ls[i], "d_762124027",sep="_")
  select <- c(tubeid,tubecol,tube_deviation,tube_discard)
  tmp <- coll_sett_all[,(colnames(coll_sett_all)%in% c(select,"d_820476880","Site","biocol_Setting"))] 
  col <- tmp 
  colnames(col)[colnames(col)==tubeid] <- "TubeID"
  colnames(col)[colnames(col)==tubecol] <- "tubecol"
  colnames(col)[colnames(col)==tube_deviation] <- "tube_deviation"
  colnames(col)[colnames(col)==tube_discard] <- "tube_discard"
  
  col$tubeID <- tube.ls[i]
  collection_long <- dplyr::bind_rows(collection_long,col)
} 

collection_long <- collection_long  %>% 
  dplyr:: mutate(deviation = case_when(tube_deviation == 353358909 ~ "Any Deviation",
                                       tube_deviation == 104430631 ~ "No Deviation"),
                 Collected = case_when(tubecol ==353358909 ~ "Collected",
                                       tubecol == 104430631 ~ "Not  Collected"),
                 Discarded = case_when(tube_discard == 353358909 ~ "Any Discard",
                                       tube_discard == 104430631 ~ "No Discard"),
                 biospecimen=ifelse(tubeID=="d_973670172", "urine",
                                    ifelse(tubeID=="d_143615646","Mouthwash","blood")),
                 tube_type = case_when(tubeID == "d_973670172"  ~ "Urine Tube1",
                                       tubeID == "d_143615646"  ~ "MW Tube1",
                                       tubeID == "d_299553921"  ~ "SS Tube1",
                                       tubeID == "d_703954371"  ~ "SS Tube2",
                                       tubeID == "d_454453939"  ~ "EDTA Tube1",
                                       tubeID == "d_838567176"  ~ "Heparin Tube1",
                                       tubeID == "d_652357376"  ~ "ACD Tube1",
                                       tubeID == "d_677469051"  ~ "EDTA Tube2",
                                       tubeID == "d_683613884"  ~ "EDTA Tube3",
                                       tubeID == "d_376960806"  ~ "SS Tube3",
                                       tubeID == "d_232343615"  ~ "SS Tube4",
                                       tubeID == "d_589588440"  ~ "SS Tube5",
                                       tubeID == "d_505347689"  ~ "STRECK Tube1", 
                                       tubeID == "d_958646668"  ~ "Heparin Tube2"))
collection_long$tube_type <- factor(collection_long$tube_type, levels=c("SS Tube1", "SS Tube2","SS Tube3", "SS Tube4", "SS Tube5",
                                                                        "Heparin Tube1","Heparin Tube2","EDTA Tube1", "EDTA Tube2",
                                                                        "EDTA Tube3","ACD Tube1", "STRECK Tube1", "Urine Tube1","MW Tube1" ) )   



dev_tube1$tube_dev <- paste(dev_tube1$tube_type,"Deviation", dev_tube1$deviationnotes,sep=" ")
dev_tube1$tubeID <- substr(dev_tube1$dev_type,1,11)
dev <- collection_long %>% filter(tube_deviation==353358909) 
dev_tube2 <- base::merge(dev,dev_tube1[,c("dev_type","TubeID","tubeID","deviationnotes","tube_dev")],by.x=c("TubeID","tubeID"), by.y=c("TubeID","tubeID")) ##to get the deviation notes
```

```{r Request7_incidenttypes, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, results='asis'}

# BY SITE
# Summarize deviations by Site and Tube Type
devns_by_type_df <- dev_tube2 %>%
  filter(biospecimen != "Mouthwash") %>%
  group_by(Site,
           Tube_Type = tube_type,
           Deviation = deviationnotes) %>%
  summarise(`Number of Deviations` = n(), .groups = "drop")

# Sort rows for display
devns_by_type_df <- devns_by_type_df %>%
  arrange(Site, Tube_Type)

#  Mark indented tube type rows
devns_by_type_df <- devns_by_type_df %>%
  group_by(Site) %>%
  mutate(Row_Label = paste0("  ", Tube_Type),
         is_header = FALSE) %>%
  ungroup()

# Create site header rows (not indented)
headers <- devns_by_type_df %>%
  distinct(Site) %>%
  mutate(Row_Label = Site,
         is_header = TRUE,
         Tube_Type = NA,
         Deviation = NA,
         `Number of Deviations` = NA)

# Add site total rows
site_totals <- devns_by_type_df %>%
  group_by(Site) %>%
  summarise(`Number of Deviations` = sum(`Number of Deviations`, na.rm = TRUE)) %>%
  mutate(Row_Label = "Total",
         is_header = FALSE,
         Tube_Type = NA,
         Deviation = NA)

# Combine all rows
devns_by_type_display_site <- bind_rows(headers, devns_by_type_df, site_totals) %>%
  arrange(Site, desc(is_header), Row_Label)

# Save indent rows (exclude headers and total rows)
indent_rows_site <- which(!(devns_by_type_display_site$is_header | devns_by_type_display_site$Row_Label == "Total"))

# Summarize and pivot to wide format
devns_by_site_wide <- devns_by_type_display_site %>%
  filter(!is.na(Deviation)) %>%
  group_by(Site, Deviation) %>%
  summarise(`Number of Deviations` = sum(`Number of Deviations`, na.rm = TRUE), .groups = "drop") %>%
  bind_rows(
    devns_by_type_display_site %>%
      filter(!is.na(Deviation)) %>%
      group_by(Deviation) %>%
      summarise(`Number of Deviations` = sum(`Number of Deviations`), .groups = "drop") %>%
      mutate(Site = "Total")
  ) %>%
  pivot_wider(names_from = Deviation, values_from = `Number of Deviations`, values_fill = 0)


# Table 7e
knitr::kable(
  devns_by_site_wide,
  caption = "Table 7e. Incident Type by Site",
  align = c("l", rep("c", ncol(devns_by_site_wide) - 1)),
  booktabs = TRUE,
  row.names = FALSE,
  format = "latex"  
) %>%
  kable_styling(latex_options = "scale_down") %>%
   kableExtra::footnote(
    general = "Note: Table summarizes incident reasons by site, excluding home mouthwash collections.",
    general_title = "",
    footnote_as_chunk = TRUE,
    escape = FALSE,
    threeparttable = TRUE
  )


# BY COLLECTION SETTING
# Summarize deviations
devns_by_type_df <- dev_tube2 %>%
  filter(biospecimen != "Mouthwash") %>%
  group_by(`Collection Setting` = biocol_Setting,
           Tube_Type = tube_type,
           Deviation = deviationnotes) %>%
  summarise(`Number of Deviations` = n(), .groups = "drop")

# Add indenting
devns_by_type_df <- devns_by_type_df %>%
  arrange(`Collection Setting`, Tube_Type) %>%
  group_by(`Collection Setting`) %>%
  mutate(Row_Label = paste0("  ", Tube_Type),
         is_header = FALSE) %>%
  ungroup()

# Add collection setting headers
headers <- devns_by_type_df %>%
  distinct(`Collection Setting`) %>%
  mutate(Row_Label = `Collection Setting`,
         is_header = TRUE,
         Tube_Type = NA,
         Deviation = NA,
         `Number of Deviations` = NA)

# Add collection setting totals
setting_totals <- devns_by_type_df %>%
  group_by(`Collection Setting`) %>%
  summarise(`Number of Deviations` = sum(`Number of Deviations`, na.rm = TRUE)) %>%
  mutate(Row_Label = "Total",
         is_header = FALSE,
         Tube_Type = NA,
         Deviation = NA)

# Combine all rows
devns_by_type_display_sett <- bind_rows(headers, devns_by_type_df, setting_totals) %>%
  arrange(`Collection Setting`, desc(is_header), Row_Label)

# Save indent rows
indent_rows_sett <- which(!(devns_by_type_display_sett$is_header | devns_by_type_display_sett$Row_Label == "Total"))

#  Summarize and pivot to wide format
devns_by_setting_wide <- devns_by_type_display_sett %>%
  filter(!is.na(Deviation)) %>%
  group_by(`Collection Setting`, Deviation) %>%
  summarise(`Number of Deviations` = sum(`Number of Deviations`, na.rm = TRUE), .groups = "drop") %>%
  bind_rows(
    devns_by_type_display_sett %>%
      filter(!is.na(Deviation)) %>%
      group_by(Deviation) %>%
      summarise(`Number of Deviations` = sum(`Number of Deviations`), .groups = "drop") %>%
      mutate(`Collection Setting` = "Total")
  ) %>%
  pivot_wider(names_from = Deviation, values_from = `Number of Deviations`, values_fill = 0)



# Table 7f:
knitr::kable(
  devns_by_setting_wide,
  caption = "Table 7f. Incident Type by Collection Setting",
  align = c("l", rep("c", ncol(devns_by_setting_wide) - 1)),
  booktabs = TRUE,
  row.names = FALSE
) %>%
  kable_styling(latex_options = "scale_down") %>%
    landscape() %>% 
  kableExtra::footnote(
    general = "Note: Table summarizes incident reasons by collection setting, excluding home mouthwash collections.",
    general_title = "",
    footnote_as_chunk = TRUE,
    escape = FALSE,
    threeparttable = TRUE
  )



```
