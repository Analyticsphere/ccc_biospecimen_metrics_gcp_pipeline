---
title: "Biospecimen QC Metric"
author: "Kelsey Dowling"
date: "`r Sys.Date()`"
header-includes:  
    \usepackage{placeins}


output:
  pdf_document:
    latex_engine: xelatex
    extra_dependencies: ["float"]
    toc: false
    keep_tex: yes
    fig_width: 7
    fig_height: 5
    fig_caption: true
    df_print: paged 
---



```{r library, include=FALSE}

library(bigrquery)
library(lubridate)
library(dplyr)
library(stringr)
library(gt)
library(expss)
library(knitr)
library(kableExtra)
library(glue)
library(expss) # needed for xlxs
bq_auth()


### Set Box folders for output CSV files #######################################
use_test_box_folder <- FALSE # Local user sets this (Jake or Kelsey)

# TODO: Fix conditional box folder configuration.

# Over-ride if using plumber api on GCP (USER DOESN'T TOUCH THIS!)
# Check if the environment variable exists and is not empty
#if (!is.null(Sys.getenv("USE_TEST_BOX_FOLDER")) &&
#    Sys.getenv("USE_TEST_BOX_FOLDER") != "") {
#  use_test_box_folder <- as.logical(Sys.getenv("USE_TEST_BOX_FOLDER"))
#}

if (use_test_box_folder) {
  boxfolder <- 222593912729 # test box folder
} else {
  boxfolder <- 221297686961 # destination of CSV files (not pdf)
}
################################################################################
```


```{r BQ_pull, include=FALSE}
project <- "nih-nci-dceg-connect-prod-6d04"


# bio <- "WITH T AS (
#   SELECT Connect_ID FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.biospecimen_JP`
#   GROUP BY Connect_ID
#   HAVING COUNT(Connect_ID) =1) 
# SELECT * FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.biospecimen_JP`
# INNER JOIN T ON `nih-nci-dceg-connect-prod-6d04.FlatConnect.biospecimen_JP`.Connect_ID = T.Connect_ID ;"


bio <- "WITH T AS (
  SELECT Connect_ID
  FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.biospecimen_JP`
  WHERE d_820476880 LIKE 'CXA%'
  GROUP BY Connect_ID
  HAVING COUNT(Connect_ID) = 1
)
SELECT * 
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.biospecimen_JP`
WHERE (d_820476880 LIKE 'CHA%') 
   OR (d_820476880 LIKE 'CXA%' AND d_410912345='353358909' AND Connect_ID IN (SELECT Connect_ID FROM T));"

parts <- "SELECT Connect_ID, d_173836415_d_266600170_d_139245758, d_173836415_d_266600170_d_156605577, d_173836415_d_266600170_d_184451682, d_173836415_d_266600170_d_185243482, d_173836415_d_266600170_d_198261154, d_173836415_d_266600170_d_210921343, d_173836415_d_266600170_d_224596428, d_173836415_d_266600170_d_316824786, d_173836415_d_266600170_d_341570479, d_173836415_d_266600170_d_398645039, d_173836415_d_266600170_d_448660695, d_173836415_d_266600170_d_452847912, d_173836415_d_266600170_d_453452655, d_173836415_d_266600170_d_530173840, d_173836415_d_266600170_d_534041351, d_173836415_d_266600170_d_541311218, d_173836415_d_266600170_d_561681068, d_173836415_d_266600170_d_592099155, d_173836415_d_266600170_d_693370086, d_173836415_d_266600170_d_718172863, d_173836415_d_266600170_d_728696253, d_173836415_d_266600170_d_740582332, d_173836415_d_266600170_d_769615780, d_173836415_d_266600170_d_786930107, d_173836415_d_266600170_d_822274939, d_173836415_d_266600170_d_847159717, d_173836415_d_266600170_d_860477844, d_173836415_d_266600170_d_880794013, d_173836415_d_266600170_d_915179629, d_173836415_d_266600170_d_939818935, d_173836415_d_266600170_d_982213346, d_684635302, d_254109640, d_878865966, d_167958071, d_827220437, d_173836415_d_266600170_d_543608829, d_173836415_d_266600170_d_110349197, d_831041022, d_173836415_d_266600170_d_319972665_d_379252329, d_173836415_d_266600170_d_319972665_d_221592017, d_173836415_d_266600170_d_319972665_d_661940160, d_195145666, d_173836415_d_266600170_d_319972665_d_826941471
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` where Connect_ID IS NOT NULL and d_831041022='104430631'"




parts_table <- bq_project_query(project, parts)

parts_data <- bq_table_download(parts_table, bigint = "integer64", n_max = Inf, page_size = 1000)

bio_table <- bq_project_query(project, bio)
bio_data <- bq_table_download(bio_table, bigint = "integer64", n_max = Inf, page_size = 1000)


bio_data$Connect_ID <- as.numeric(bio_data$Connect_ID)
parts_data$Connect_ID <- as.numeric(parts_data$Connect_ID)



#bioqc_join= left_join(parts_data, bio_data, by="Connect_ID") 

bioqc= inner_join(bio_data,parts_data,  by=c("Connect_ID", "d_827220437") )

knitr::opts_chunk$set(comment = NA)





bioqc <- bioqc %>%  mutate(Site=case_when(d_827220437==472940358 ~ "Baylor Scott and White Health",
                                          d_827220437==531629870 ~ "HealthPartners",
                                          d_827220437==548392715 ~ "Henry Ford Health System",
                                          d_827220437==303349821 ~ "Marshfield Clinical Health System",
                                          d_827220437==657167265 ~ "Sanford Health",
                                          d_827220437==809703864 ~ "University of Chicago Medicine",
                                          d_827220437==125001209 ~ "Kaiser Permanente Colorado",
                                          d_827220437==327912200 ~ "Kaiser Permanente Georgia",
                                          d_827220437==300267574 ~ "Kaiser Permanente Hawaii",
                                          d_827220437==452412599 ~ "Kaiser Permanente Northwest"))



##Report output needs to have the text for yes/no or clinical/research, not the concept IDs

bioqc <- bioqc %>%
  mutate(across(everything(), ~ case_when(
    . == 353358909 ~ "Yes",
    . == 104430631 ~ "No",
    . == 534621077 ~ "Research",
    . == 664882224 ~ "Clinical",
    . == 103209024 ~ "Home",
    TRUE ~ as.character(.)
  )))








##### Making sure personal C drives aren't referenced if this code is being used by others


#Change to FALSE if referencing this code for Box outputs

write_to_local_drive = F #F



### This function below determines whether the file will be created locally or not.
local_drive= ifelse(write_to_local_drive, "~/Biospecimen/data/", "")







```

\newpage




### 1. (Derived) Clinical DB Blood RRL Received (BioClin_DBBloodRRL_v1r0): If all blood tubes are not collected, this should be no
```{r BioClin_DBBloodRRL_v1r0, echo=FALSE, warning=FALSE, message=FALSE}

qc2 <- bioqc %>%  filter( d_232343615_d_593843561=="No" & d_299553921_d_593843561=="No" & d_376960806_d_593843561=="No" & d_454453939_d_593843561=="No" & d_589588440_d_593843561=="No" & d_958646668_d_593843561=="No" & d_677469051_d_593843561=="No" & d_683613884_d_593843561=="No" & d_703954371_d_593843561=="No" & d_838567176_d_593843561=="No" & d_173836415_d_266600170_d_534041351!="No") 

qc2 <- qc2  %>% select(Site, Connect_ID, d_173836415_d_266600170_d_534041351)  %>%  sort_by(Site)


colnames(qc2) <- c("Site", "Connect ID", "Value")
knitr::kable(qc2)
```



### 2.a. If all blood tubes are not collected, (Derived) Clinical Site Blood Collected (BioClin_SiteBloodColl_v1r0) should be no or NULL.
```{r Clin_SiteBloodColl, echo=FALSE, warning=FALSE, message=FALSE}

qc2_1 <- bioqc %>%  filter( d_232343615_d_593843561=="No" & d_299553921_d_593843561=="No" & d_376960806_d_593843561=="No" & d_454453939_d_593843561=="No" &
                              d_589588440_d_593843561=="No" & d_958646668_d_593843561=="No" & d_677469051_d_593843561=="No" & d_683613884_d_593843561=="No" &
                              d_703954371_d_593843561=="No" & d_838567176_d_593843561=="No" &  d_173836415_d_266600170_d_693370086=="Yes" & 
                              !(Connect_ID %in% c("2300063524","7848933050", "3467573584"))) 
qc2_1 <- qc2_1  %>% select(Site, Connect_ID, d_173836415_d_266600170_d_693370086)  %>%  sort_by(Site)


colnames(qc2_1) <- c("Site", "Connect ID", "Value")
knitr::kable(qc2_1)


```


### 2.b. If any urine tubes is not collected, (Derived) Clinical Site Urine Collected (BioClin_SiteUrineCollBL_v1r0) should be no or NULL.
```{r Clin_SiteUrineColl, echo=FALSE, warning=FALSE, message=FALSE}

qc2_1a <- bioqc %>%  filter( d_973670172_d_593843561=="No"  & d_173836415_d_266600170_d_786930107=="Yes" &
                               !(Connect_ID %in% c("1140047316", "1215003341", "1250934825", "2300063524", "2039357566", "2755205973", 
                                                   "3287102562", "3862626013", "4479873637", "4980503471", "6321294709", "7352978604", 
                                                   "7882825421", "8184138489", "8633594373", "1102086935", "1375421153", "2871811858", 
                                                   "2887898061", "3456526723", "3992444928", "4207529981", "4838682809", "6467484794", 
                                                   "6523900663", "6538980272", "7106367407", "9366425281", "9652100378", "9672292896", 
                                                   "6422794867", "1349953410", "1731138933", "2769291903", "3589595480", "3722445358", 
                                                   "5972658064", "8553891957", "9121406600", "9575612025", "4057490101", "9167792140",
                                                   "8924667241", "9694753790", "5899565591", "6568449334", "1371560328", "8625295305",
                                                   "6862754687", "9143436002")))

qc2_1a <- qc2_1a  %>% select(Site, Connect_ID, d_973670172_d_593843561, d_173836415_d_266600170_d_786930107)  %>%  sort_by(Site)


colnames(qc2_1a) <- c("Site", "Connect ID", "Urine Collected", "BioClin_SiteUrineCollBL_v1r0")
knitr::kable(qc2_1a)


# qc2_1b <- bioqc %>%  filter( d_973670172_d_593843561=="No"  & d_173836415_d_266600170_d_786930107=="Yes") %>%  
#   select(Site, Connect_ID, d_820476880, d_173836415_d_266600170_d_139245758, d_173836415_d_266600170_d_198261154, d_173836415_d_266600170_d_110349197)
# colnames(qc2_1b) <- c("Site", "Connect ID", "Collection ID", "BioClin_ClinicalUrnTmBL_v1r0", "BioClin_SntUrineAccIDBL_v1r0", "BioClin_PolyUrineIDBL_v1r0")
# knitr::kable(qc2_1b)
# write.csv(qc2_1b,paste0('Bio_QC_Issue__Rule_2b', Sys.Date(), '.csv'), row.names = F,na="")
# openxlsx::write.xlsx(qc2_1b,paste0('Bio_QC_Issue__Rule_2b', Sys.Date(), '.xlsx'), row.names = F,na="")

```



### 3. (Derived) Baseline blood sample collected (BioFin_BaseBloodCol_v1r0): If all blood tubes are not collected, this should be no
```{r BioFin_BaseBloodCol_v1r0, echo=FALSE, warning=FALSE, message=FALSE}

qc2_2 <- bioqc %>%  filter( d_232343615_d_593843561=="No" & d_299553921_d_593843561=="No" & d_376960806_d_593843561=="No" & d_454453939_d_593843561=="No" & d_589588440_d_593843561=="No" & d_958646668_d_593843561=="No" & d_677469051_d_593843561=="No" & d_683613884_d_593843561=="No" & d_703954371_d_593843561=="No" & d_838567176_d_593843561=="No" & d_878865966!="No" & 
                              Connect_ID!="2310991421") #HP sent clinical sample when it should've only been research- needs to be manually removed
qc2_2 <- qc2_2  %>% select(Site, Connect_ID, d_878865966)  %>%  sort_by(Site)


colnames(qc2_2) <- c("Site", "Connect ID", "Value")
knitr::kable(qc2_2)

```



#### 3b. (Derived) Baseline blood sample collected (BioFin_BaseBloodCol_v1r0): If any blood tubes are collected, this should be yes
```{r BioFin_BaseBloodCol_v1r0___reverse, include=FALSE}

qc3b <- bioqc %>%  filter( (d_232343615_d_593843561=="Yes" | d_299553921_d_593843561=="Yes" | d_376960806_d_593843561=="Yes" | d_454453939_d_593843561=="Yes" | d_589588440_d_593843561=="Yes" | d_958646668_d_593843561=="Yes" | d_677469051_d_593843561=="Yes" | d_683613884_d_593843561=="Yes" | d_703954371_d_593843561=="Yes" | d_838567176_d_593843561=="Yes") & d_878865966=="No" )
qc3b <- qc3b  %>% select(Site, Connect_ID, d_878865966)  %>%  sort_by(Site)


colnames(qc3b) <- c("Site", "Connect ID", "Value")
knitr::kable(qc3b)

```





### 4. (Derived) Baseline urine sample collected (BioFin_BaseUrineCol_v1r0): If any urine tubes are not collected, this should be no

```{r BioFin_BaseUrineCol_v1r0, echo=FALSE, warning=FALSE, message=FALSE}

derv_ur <- bioqc %>%  filter(d_973670172_d_593843561=="No"  & d_678166505>=as.Date("2022-11-21") & d_167958071!="No") %>% 
  select(Site, Connect_ID, d_167958071) %>%  sort_by(Site)


colnames(derv_ur) <- c("Site", "Connect ID", "Baseline Urine Collected (Supposed to be no)")
knitr::kable(derv_ur)

```





### 5. If BioClin_BldOrderPlacdDt_v1r0 occured before BioClin_UrnOrderPlacdDt_v1r0, then BioClin_BldUrnPlacedTm_v1r0 should = BioClin_BldOrderPlacdDt_v1r0

```{r BioClin_BldUrnPlacedTm_1, echo=FALSE, warning=FALSE, message=FALSE}

qc3_1 <- bioqc %>%  filter(as.POSIXct(ymd_hms(d_173836415_d_266600170_d_769615780)) < as.POSIXct(ymd_hms(d_173836415_d_266600170_d_939818935)) & as.POSIXct(ymd_hms(d_173836415_d_266600170_d_184451682))!=as.POSIXct(ymd_hms(d_173836415_d_266600170_d_769615780))) %>%  
  select(Site, Connect_ID, d_173836415_d_266600170_d_184451682) %>%  sort_by(Site)


colnames(qc3_1) <- c("Site", "Connect ID", "Value")
knitr::kable(qc3_1)
```


### 6. If BioClin_BldOrderPlacdDt_v1r0 occured after BioClin_UrnOrderPlacdDt_v1r0, then BioClin_BldUrnPlacedTm_v1r0 should = BioClin_UrnOrderPlacdDt_v1r0
```{r BioClin_BldUrnPlacedTm_2, echo=FALSE, warning=FALSE, message=FALSE}
qc3_2 <- bioqc %>%  filter(as.POSIXct(ymd_hms(d_173836415_d_266600170_d_769615780)) > as.POSIXct(ymd_hms(d_173836415_d_266600170_d_939818935)) & as.POSIXct(ymd_hms(d_173836415_d_266600170_d_184451682))!=as.POSIXct(ymd_hms(d_173836415_d_266600170_d_939818935))) %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_184451682) %>%  sort_by(Site)


colnames(qc3_2) <- c("Site", "Connect ID", "Value")
knitr::kable(qc3_2)

```



###	7. If BioFin_BaseUrineCol_v1r0 was collected, BioSpm_BloodSettingBL_v1r0 is clincial, and BioClin_DBUrineRRLDt_v1r0 occurred more than seven days ago, BioClin_SiteUrineColl_v1r0 must be yes
```{r BioClin_SiteUrineColl_v1r0, echo=FALSE, warning=FALSE, message=FALSE}

currentDate <- Sys.Date()

qc_7 <- bioqc %>%  filter(d_167958071=="Yes" & d_650516960=="Clinical" & as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_541311218, units="days"), digits=0)) > 7  & 
                           is.na(d_173836415_d_266600170_d_786930107)) %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_786930107) %>%  sort_by(Site)


colnames(qc_7) <- c("Site", "Connect ID", "Value")
knitr::kable(qc_7)

```

###	8. If BioFin_BaseBloodCol_v1r0 = yes, collection setting is Clincial and BioClin_DBBloodRRLDtBL_v1r0 occurred more than 7 days ago, BioClin_SiteBloodColl_v1r0 must be yes
```{r BioClin_SiteBloodColl_v1r0, echo=FALSE, warning=FALSE, message=FALSE}

currentDate <- Sys.Date()

qc_8 <- bioqc %>%  filter(d_878865966=="Yes" & d_650516960=="Clinical" & as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_398645039, units="days"), digits=0)) > 7  & 
                           is.na(d_173836415_d_266600170_d_693370086)) %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_693370086) %>%  sort_by(Site)


colnames(qc_8) <- c("Site", "Connect ID", "Value")
knitr::kable(qc_8)

```



### 9. All baseline samples (BioFin_BaseBloodCol_v1r0,BioFin_BaseUrineCol_v1r0,BioFin_BaseMWCol_v1r0) are collected, and BioCol_ColTime_v1r0 occured on or after 11/21/2022 then SMMet_BLSamplesColl_v1r0 must be YES
```{r SMMET, echo=FALSE, warning=FALSE, message=FALSE}

qc8 <- bioqc %>%  filter(d_878865966=="Yes" & d_167958071=="Yes" & d_684635302=="Yes" & 
                           d_678166505>=as.Date("2022-11-21")  & d_254109640 !="Yes") %>% 
  select(Site, Connect_ID, d_254109640) %>%  sort_by(Site)


colnames(qc8) <- c("Site", "Connect ID", "All baseline samples collected (Supposed to be Yes)")
knitr::kable(qc8)

```



### 10. If BioFin_BaseBloodCol_v1r0 is yes and the collection setting is Research, and BioCol_ColTime_v1r0 occured on or after 11/21/2022 then (Autogenerated) Date/time Baseline Research Blood Collected must be populated  
```{r BloodDateTime, echo=FALSE, warning=FALSE, message=FALSE}

qc9B <- bioqc %>%  filter(d_878865966=="Yes" & d_650516960=="Research" & 
                            d_678166505>=as.Date("2022-11-21") & is.na(d_173836415_d_266600170_d_561681068)) %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_561681068) %>%  sort_by(Site)


colnames(qc9B) <- c("Site", "Connect ID", "(Autogenerated) Date/time Baseline Research Blood Collected")
knitr::kable(qc9B)
```

### 11. If BioFin_BaseUrineCol_v1r0 is yes and the collection setting is Research, and BioCol_ColTime_v1r0 occured on or after 11/21/2022 then (Autogenerated) Date/time Baseline Research Urine Collected must be populated
```{r UrineDateTime, echo=FALSE, warning=FALSE, message=FALSE}
qc9U <- bioqc %>%  filter(d_167958071=="Yes" & d_650516960=="Research"  & d_678166505>=as.Date("2022-11-21") & 
                            is.na(d_173836415_d_266600170_d_847159717)) %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_847159717) %>%  sort_by(Site)

colnames(qc9U) <- c("Site", "Connect ID", "(Autogenerated) Date/time Baseline Research Urine Collected")
knitr::kable(qc9U)



```



### 12. If BioFin_BaseBloodCol_v1r0 is yes and the collection setting is Research, BioCol_ColTime_v1r0 must be populated 
```{r BioCol_ColTime_v1r0, echo=FALSE, warning=FALSE, message=FALSE}

qc10 <- bioqc %>%  filter(d_878865966=="Yes" & d_650516960=="Research"   & is.na(d_678166505)) %>% 
  select(Site, Connect_ID, d_678166505) %>%  sort_by(Site)


colnames(qc10) <- c("Site", "Connect ID", "Collection Date/Time (Supposed to be populated)")
knitr::kable(qc10)

```



### 13. If BioCol_ObjCollected_v1r0 (mouthwash), and BioCol_ColTime_v1r0 occured on or after 11/21/2022, then  BioFin_BaseMouthCol_v1r0 should be no 
```{r BioFin_BaseMouthCol_v1r0, echo=FALSE, warning=FALSE, message=FALSE}

qc11 <- bioqc %>%  filter(d_143615646_d_593843561=="No"  & d_678166505>=as.Date("2022-11-21") & d_684635302!="No") %>% 
  select(Site, Connect_ID, d_684635302) %>%  sort_by(Site)


colnames(qc11) <- c("Site", "Connect ID", "Baseline Mouthwash Collected (Supposed to be no)")
knitr::kable(qc11)

```



### 14. If Urine tube was collected, site was Clinical, and BioReg_ArRegTime_v1r0 occurred more than 7 days ago, BioClin_SiteUrineColl_v1r0 must be yes
```{r BioClin_SiteUrineColl, echo=FALSE, warning=FALSE, message=FALSE}


qc12 <- bioqc %>%  filter(Connect_ID!="5667758818" & d_973670172_d_593843561=="Yes"  & 
                            d_650516960=="Clinical" & as.numeric(round(difftime(currentDate, d_915838974, units="days"), digits=0)) >7 & 
                            is.na(d_173836415_d_266600170_d_786930107)) %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_786930107) %>%  sort_by(Site)


colnames(qc12) <- c("Site", "Connect ID", "Site Clinical_Site Urine Collected")
knitr::kable(qc12) 


```






### 15. IF BioClin_BldOrderPlaced_v1r0 = 1, THEN BioClin_BldOrderPlacdDt_v1r0 must be populated. HP, UC, and SF Excluded
```{r HPExcluded5, echo=FALSE, warning=FALSE, message=FALSE}

BloodDtTm_noHP <- bioqc %>%  filter(is.na(d_173836415_d_266600170_d_769615780) & d_173836415_d_266600170_d_530173840=="Yes"	& 
                                         d_827220437!="531629870" & d_827220437!="657167265" & d_827220437!="809703864") %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_769615780) %>%  sort_by(Site)

colnames(BloodDtTm_noHP) <- c("Site", "Connect ID", "BioClin_BldOrderPlacdDt")
knitr::kable(BloodDtTm_noHP) 

```




```{r HPExcluded6, echo=FALSE, warning=FALSE, message=FALSE}

### IF  BioClin_BldOrderPlacdDt_v1r0 is populated, THEN BioClin_BldOrderPlaced_v1r0 = 1. HP Excluded

BloodDtTmVs_noHP <- bioqc %>%  filter(!is.na(d_173836415_d_266600170_d_769615780) & d_173836415_d_266600170_d_530173840!="Yes"	& 
                                         d_827220437!="531629870" & d_827220437!="657167265") %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_530173840) %>%  sort_by(Site)

colnames(BloodDtTmVs_noHP) <- c("Site", "Connect ID", "BioClin_BldOrderPlaced")


```



### 16. IF BioClin_UrnOrdPlaced = 1, THEN BioClin_UrnOrderPlacdDt_v1r0 must be populated. HP, UC and SF Excluded
```{r HPExcluded3, echo=FALSE, warning=FALSE, message=FALSE}

UrineDtTm_noHP <- bioqc %>%  filter(is.na(d_173836415_d_266600170_d_939818935) & d_173836415_d_266600170_d_860477844=="Yes"	& 
                                         d_827220437!="531629870" & d_827220437!="657167265" & d_827220437!="809703864") %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_939818935) %>%  sort_by(Site)

colnames(UrineDtTm_noHP) <- c("Site", "Connect ID", "BioClin_BldOrderPlacdDt")
knitr::kable(UrineDtTm_noHP) 

```




```{r HPExcluded4, echo=FALSE, warning=FALSE, message=FALSE}
### IF  BioClin_BldOrderPlacdDt_v1r0 is populated, THEN BioClin_UrnOrdPlaced must = 1. HP Excluded

UrineDtTmVs_noHP <- bioqc %>%  filter(!is.na(d_173836415_d_266600170_d_939818935) & d_173836415_d_266600170_d_860477844!="Yes"	& 
                                         d_827220437!="531629870" & d_827220437!="657167265") %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_860477844) %>%  sort_by(Site)

colnames(UrineDtTmVs_noHP) <- c("Site", "Connect ID", "BioClin_UrnOrdPlaced")


```






### 17. Tube Date Received Clinical - If BioClin_DBBloodRRLDt_v1r0 occurred more than 4 days ago, (tube type) was collected, and (tube type) was not discarded, then BioBPTL_DateRec_v1r0 for that tube type should be populated 
```{r BioBPTL_DateRecClinical, echo=FALSE, warning=FALSE, message=FALSE}


 ###########chnage to tube collected =yes and BioBPTL_DateRec_v1r0 is na for all & deviation!= discard deviation (one flag triggered)


qc13_tube2 <- bioqc %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_398645039, units="days"), digits=0))>4 & d_299553921_d_593843561=="Yes" & d_299553921_d_762124027=="No" & is.na(d_299553921_d_926457119)
                                & Connect_ID!="7609852429") %>% 
  select(Site, Connect_ID, d_299553921_d_926457119) %>%  sort_by(Site)

colnames(qc13_tube2) <- c("Site", "Connect ID", "Serum Separator Tube 1- Date Received")
knitr::kable(qc13_tube2)


qc13_tube5 <- bioqc %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_398645039, units="days"), digits=0))>4 & d_703954371_d_593843561=="Yes" & d_703954371_d_762124027=="No" & is.na(d_703954371_d_926457119)
                                & Connect_ID!="7609852429") %>% 
  select(Site, Connect_ID, d_703954371_d_926457119) %>%  sort_by(Site)

colnames(qc13_tube5) <- c("Site", "Connect ID", "Serum Separator Tube 2- Date Received")
knitr::kable(qc13_tube5)

qc13_tube_sst3 <- bioqc %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_398645039, units="days"), digits=0))>4 & d_376960806_d_593843561=="Yes" & d_376960806_d_762124027=="No" & is.na(d_376960806_d_926457119) & 
                                      Connect_ID!="9729007313" & Connect_ID!="7609852429") %>% 
  select(Site, Connect_ID, d_376960806_d_926457119) %>%  sort_by(Site)

colnames(qc13_tube_sst3) <- c("Site", "Connect ID", "Serum Separator Tube 3- Date Received")
knitr::kable(qc13_tube_sst3)

qc13_tube_sst4 <- bioqc %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_398645039, units="days"), digits=0))>4 & d_232343615_d_593843561=="Yes" & d_232343615_d_762124027=="No" & is.na(d_232343615_d_926457119) & 
                                      Connect_ID!="9729007313" & Connect_ID!="7609852429") %>% 
  select(Site, Connect_ID, d_232343615_d_926457119) %>%  sort_by(Site)

colnames(qc13_tube_sst4) <- c("Site", "Connect ID", "Serum Separator Tube 4- Date Received")
knitr::kable(qc13_tube_sst4)

qc13_tube_sst5 <- bioqc %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_398645039, units="days"), digits=0))>4 & d_589588440_d_593843561=="Yes" & d_589588440_d_762124027=="No" & is.na(d_589588440_d_926457119)) %>% 
  select(Site, Connect_ID, d_589588440_d_926457119) %>%  sort_by(Site)

colnames(qc13_tube_sst5) <- c("Site", "Connect ID", "Serum Separator Tube 5- Date Received")
knitr::kable(qc13_tube_sst5)

qc13_tube3 <- bioqc %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_398645039, units="days"), digits=0))>4 & d_454453939_d_593843561=="Yes" & d_454453939_d_762124027=="No" & is.na(d_454453939_d_926457119) & 
                                  Connect_ID!="9729007313" & Connect_ID!="7609852429") %>% 
  select(Site, Connect_ID, d_454453939_d_926457119) %>%  sort_by(Site)

colnames(qc13_tube3) <- c("Site", "Connect ID", "EDTA Tube 1- Date Received")
knitr::kable(qc13_tube3)


qc13_tube_edat2 <- bioqc %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_398645039, units="days"), digits=0))>4 & d_677469051_d_593843561=="Yes" & d_677469051_d_762124027=="No" & is.na(d_677469051_d_926457119) & 
                                  Connect_ID!="9729007313" & Connect_ID!="7609852429") %>% 
  select(Site, Connect_ID, d_677469051_d_926457119) %>%  sort_by(Site)

colnames(qc13_tube_edat2) <- c("Site", "Connect ID", "EDTA Tube 2- Date Received")
knitr::kable(qc13_tube_edat2)


qc13_tube_edat3 <- bioqc %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_398645039, units="days"), digits=0))>4 & d_683613884_d_593843561=="Yes" & d_683613884_d_762124027=="No" & is.na(d_683613884_d_926457119) & 
                                  Connect_ID!="9729007313" & Connect_ID!="7609852429") %>% 
  select(Site, Connect_ID, d_683613884_d_926457119) %>%  sort_by(Site)

colnames(qc13_tube_edat3) <- c("Site", "Connect ID", "EDTA Tube 3- Date Received")
knitr::kable(qc13_tube_edat3)



qc13_tube4 <- bioqc %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_398645039, units="days"), digits=0))>4 & d_652357376_d_593843561=="Yes" & d_652357376_d_762124027=="No" & is.na(d_652357376_d_926457119) & d_827220437==548392715 & d_650516960=="Clinical") %>% # | d_827220437==657167265 once Sanford is hybrid
  select(Site, Connect_ID, d_652357376_d_926457119) %>%  sort_by(Site)

colnames(qc13_tube4) <- c("Site", "Connect ID", "ACD Tube 1- Date Received")
knitr::kable(qc13_tube4)









qc13_tube6 <- bioqc %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_398645039, units="days"), digits=0))>4 & d_838567176_d_593843561=="Yes" & d_838567176_d_762124027=="No" &  is.na(d_838567176_d_926457119)
                                & Connect_ID!="7609852429") %>% 
  select(Site, Connect_ID, d_838567176_d_926457119) %>%  sort_by(Site)

colnames(qc13_tube6) <- c("Site", "Connect ID", "Heparin Tube 1- Date Received")
knitr::kable(qc13_tube6)



qc13_tube8 <- bioqc %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_398645039, units="days"), digits=0))>4 & d_958646668_d_593843561=="Yes" & d_958646668_d_762124027=="No" &  is.na(d_958646668_d_926457119)
                                & Connect_ID!="7609852429") %>% 
  select(Site, Connect_ID, d_958646668_d_926457119) %>%  sort_by(Site)

colnames(qc13_tube8) <- c("Site", "Connect ID", "Heparin Tube 2- Date Received")
knitr::kable(qc13_tube8)




qc13_tube7 <- bioqc %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_541311218, units="days"), digits=0))>4 & 
                                  d_973670172_d_593843561=="Yes" & d_973670172_d_762124027=="No" & is.na(d_973670172_d_926457119) & 
                                  Connect_ID!="2215062576" & #KPNW exclusion
                                  Connect_ID!="4002548016" &  #HF exclusion
                                  Connect_ID!="7609852429") %>%  #SF exclusion
  select(Site, Connect_ID, d_973670172_d_926457119) %>%  sort_by(Site)

colnames(qc13_tube7) <- c("Site", "Connect ID", "Urine Tube 1- Date Received")
knitr::kable(qc13_tube7)



qc13_tube9 <- bioqc %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_541311218, units="days"), digits=0))>4 & d_505347689_d_593843561=="Yes" & d_505347689_d_762124027=="No" & is.na(d_505347689_d_926457119)) %>%
  select(Site, Connect_ID, d_505347689_d_926457119) %>%  sort_by(Site)


colnames(qc13_tube9) <- c("Site", "Connect ID", "STRECK Tube- Date Received")
knitr::kable(qc13_tube9)




```



### 18. Tube Date Received Research - If (tube type) was collected, and (tube type) was not discarded, then BioBPTL_DateRec_v1r0 for that tube type should be populated 
```{r BioBPTL_DateRecResearch, echo=FALSE, warning=FALSE, message=FALSE}


 ###########chnage to tube collected =yes and BioBPTL_DateRec_v1r0 is na for all & deviation!= discard deviation (one flag triggered)

bioqcR <- bioqc %>%  filter(d_650516960=="Research")


qc13_Rtube1 <- bioqcR %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_448660695, units="days"), digits=0))>4 & d_143615646_d_593843561=="Yes" & d_143615646_d_762124027=="No" & is.na(d_143615646_d_926457119) & 
                                    !(Connect_ID %in% c("2330722643", "3080768933", "9375710580", "3409243008"))) %>% 

  select(Site, Connect_ID, d_143615646_d_926457119)%>%  sort_by(Site)

colnames(qc13_Rtube1) <- c("Site", "Connect ID", "Mouthwash Tube- Date Received")
knitr::kable(qc13_Rtube1)




qc13_Rtube2 <- bioqcR %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_561681068, units="days"), digits=0))>4 & d_299553921_d_593843561=="Yes" & d_299553921_d_762124027=="No" & is.na(d_299553921_d_926457119) &
                                    Connect_ID!="3409243008") %>% 
  select(Site, Connect_ID, d_299553921_d_926457119) %>%  sort_by(Site)

colnames(qc13_Rtube2) <- c("Site", "Connect ID", "Serum Separator Tube 1- Date Received")
knitr::kable(qc13_Rtube2)




qc13_Rtube3 <- bioqcR %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_561681068, units="days"), digits=0))>4 & d_454453939_d_593843561=="Yes" & d_454453939_d_762124027=="No" & is.na(d_454453939_d_926457119) &
                                    !(Connect_ID %in% c("3409243008", "8193439990", "5743151720", "5861017989"))) %>% 
  select(Site, Connect_ID, d_454453939_d_926457119) %>%  sort_by(Site)

colnames(qc13_Rtube3) <- c("Site", "Connect ID", "EDTA Tube 1- Date Received")
knitr::kable(qc13_Rtube3)




qc13_Rtube4 <- bioqcR %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_561681068, units="days"), digits=0))>4 & d_652357376_d_593843561=="Yes" & d_652357376_d_762124027=="No" & is.na(d_652357376_d_926457119) & #| d_827220437==657167265 once Sanford is hybrid
                                    !(Connect_ID %in% c("1735874266", "3409243008"))) %>% # HF exclusion

  select(Site, Connect_ID, d_652357376_d_926457119) %>%  sort_by(Site)

colnames(qc13_Rtube4) <- c("Site", "Connect ID", "ACD Tube 1- Date Received")
knitr::kable(qc13_Rtube4)




qc13_Rtube5 <- bioqcR %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_561681068, units="days"), digits=0))>4 & d_703954371_d_593843561=="Yes" & d_703954371_d_762124027=="No" & is.na(d_703954371_d_926457119) &
                                    Connect_ID!="3409243008") %>% 
  select(Site, Connect_ID, d_703954371_d_926457119) %>%  sort_by(Site)

colnames(qc13_Rtube5) <- c("Site", "Connect ID", "Serum Separator Tube 2- Date Received")
knitr::kable(qc13_Rtube5)




qc13_Rtube6 <- bioqcR %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_561681068, units="days"), digits=0))>4 & d_838567176_d_593843561=="Yes" & d_838567176_d_762124027=="No" &  is.na(d_838567176_d_926457119) & 
                                    !(Connect_ID %in% c("3409243008", "8193439990"))) %>% 
  select(Site, Connect_ID, d_838567176_d_926457119) %>%  sort_by(Site)

colnames(qc13_Rtube6) <- c("Site", "Connect ID", "Heparin Tube 1- Date Received")
knitr::kable(qc13_Rtube6)


qc13_Rtube7 <- bioqcR %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_561681068, units="days"), digits=0))>4 &  d_973670172_d_593843561=="Yes" & d_973670172_d_762124027=="No" & is.na(d_973670172_d_926457119) & 
                                    Connect_ID!="9145733933" & Connect_ID!="9618974099" & Connect_ID!="8527264977" & Connect_ID!="6473532641" & #HF exclusion 
                                    Connect_ID!="4174960021" & #UC exclusion)
                                     Connect_ID!= "4435276749") %>% #Sanford exclusion

  select(Site, Connect_ID, d_973670172_d_926457119) %>%  sort_by(Site)

colnames(qc13_Rtube7) <- c("Site", "Connect ID", "Urine Tube 1- Date Received")
knitr::kable(qc13_Rtube7)



qc13_tube8 <- bioqc %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_398645039, units="days"), digits=0))>4 & d_505347689_d_593843561=="Yes" & d_505347689_d_762124027=="No" & is.na(d_505347689_d_926457119) &
                                  d_827220437=="548392715" & d_650516960=="Clinical") %>% # | d_827220437==657167265 once Sanford is hybrid
  select(Site, Connect_ID, d_505347689_d_926457119) %>%  sort_by(Site)


colnames(qc13_tube8) <- c("Site", "Connect ID", "STRECK Tube 1- Date Received")
knitr::kable(qc13_tube8)

```


### 19. If BioClin_BldOrderPlcdBL_v1r0=yes or BioClin_UrnOrdPlacedBL_v1r0=yes, then BioClin_BldUrnPlcdTmBL_v1r0 is the first of BioClin_BldOrdPlacdDtBL_v1r0 and BioClin_UrnOrdPlcdDtBL_v1r0
```{r BioClin_BldUrnPlcdTmBL_v1r0, echo=FALSE, warning=FALSE, message=FALSE}

BLUR_Time <- bioqc %>% filter( (d_173836415_d_266600170_d_530173840 == "Yes" | d_173836415_d_266600170_d_860477844 == "Yes") & 
                             d_173836415_d_266600170_d_184451682 != min(as.Date(d_173836415_d_266600170_d_769615780), as.Date(d_173836415_d_266600170_d_939818935))) %>% 
    select(Site, Connect_ID, d_173836415_d_266600170_d_184451682, d_173836415_d_266600170_d_769615780, d_173836415_d_266600170_d_939818935) %>%  sort_by(Site)

colnames(BLUR_Time) <- c("Site", "Connect ID", "Dt Either Order Placed", "Dt Blood Order Placed", "Dt Urine Order Placed")
knitr::kable(BLUR_Time)


```



### 20. If any blood tube is collected and BioSpm_Setting_v1r0= Research then BioSpm_BloodSettingBL_v1r0 must be Research.
```{r BioSpm_BloodSettingBL_res, echo=FALSE, warning=FALSE, message=FALSE}

bio_bl_setting_res <- bioqc %>%  filter((d_232343615_d_593843561=="Yes" | d_299553921_d_593843561=="Yes" | d_376960806_d_593843561=="Yes" | d_454453939_d_593843561=="Yes" | d_589588440_d_593843561=="Yes" | d_958646668_d_593843561=="Yes" | d_677469051_d_593843561=="Yes" | d_683613884_d_593843561=="Yes" | d_703954371_d_593843561=="Yes" | d_838567176_d_593843561=="Yes") & 
                    d_650516960=="Research" & d_173836415_d_266600170_d_592099155 !="Research") %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_592099155) %>%  sort_by(Site)


colnames(bio_bl_setting_res) <- c("Site", "Connect ID", "BioSpm_BloodSettingBL_v1r0")
knitr::kable(bio_bl_setting_res)                             
                              
```  


### 21. If any blood tube is collected and BioSpm_Setting_v1r0= Clinical then BioSpm_BloodSettingBL_v1r0 must be Clinical.
```{r BioSpm_BloodSettingBL_clin, echo=FALSE, warning=FALSE, message=FALSE}

bio_bl_setting_clin <- bioqc %>%  filter((d_232343615_d_593843561=="Yes" | d_299553921_d_593843561=="Yes" | d_376960806_d_593843561=="Yes" | d_454453939_d_593843561=="Yes" | d_589588440_d_593843561=="Yes" | d_958646668_d_593843561=="Yes" | d_677469051_d_593843561=="Yes" | d_683613884_d_593843561=="Yes" | d_703954371_d_593843561=="Yes" | d_838567176_d_593843561=="Yes") & 
                    d_650516960=="Clinical" & d_173836415_d_266600170_d_592099155 !="Clinical") %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_592099155) %>%  sort_by(Site)


colnames(bio_bl_setting_clin) <- c("Site", "Connect ID", "BioSpm_BloodSettingBL_v1r0")
knitr::kable(bio_bl_setting_clin)                                 
                              
                              
```  
                              
### 22. If the Urine tube is collected and BioSpm_Setting_v1r0= Clinical then BioSpm_UrineSettingBL_v1r0 must be Clinical.
```{r BioSpm_UrineSettingBL_clin, echo=FALSE, warning=FALSE, message=FALSE}

bio_ur_setting_clin <- bioqc %>%  filter((d_973670172_d_593843561=="Yes") & d_650516960=="Clinical" & d_173836415_d_266600170_d_718172863 !="Clinical") %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_718172863) %>%  sort_by(Site)


colnames(bio_ur_setting_clin) <- c("Site", "Connect ID", "BioSpm_UrineSettingBL_v1r0")
knitr::kable(bio_ur_setting_clin)                                 
                              
```  

### 23. If the Urine tube is collected and BioSpm_Setting_v1r0= Research then BioSpm_UrineSettingBL_v1r0 must be Research.
```{r BioSpm_UrineSettingBL_res, echo=FALSE, warning=FALSE, message=FALSE}

bio_ur_setting_res <- bioqc %>%  filter((d_973670172_d_593843561=="Yes") & d_650516960=="Research" & d_173836415_d_266600170_d_718172863 !="Research") %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_718172863) %>%  sort_by(Site)


colnames(bio_ur_setting_res) <- c("Site", "Connect ID", "BioSpm_UrineSettingBL_v1r0")
knitr::kable(bio_ur_setting_res)                                
                              
```  

                              
### 24. If the Mouthwash tube is collected and BioSpm_Setting_v1r0= Clinical then BioSpm_MWSettingBL_v1r0 must be Clinical.
```{r BioSpm_MWSettingBL_clin, echo=FALSE, warning=FALSE, message=FALSE}

bio_mw_setting_clin <- bioqc %>%  filter((d_143615646_d_593843561=="Yes") & d_650516960=="Clinical" & d_173836415_d_266600170_d_915179629 !="Clinical") %>% 
    select(Site, Connect_ID, d_173836415_d_266600170_d_915179629) %>%  sort_by(Site)


colnames(bio_mw_setting_clin) <- c("Site", "Connect ID", "BioSpm_MWSettingBL_v1r0")
knitr::kable(bio_mw_setting_clin) 
                              
                              
```  

### 25. If the Mouthwash tube is collected and BioSpm_Setting_v1r0= Research then BioSpm_MWSettingBL_v1r0 must be Research. 
```{r BioSpm_MWSettingBL_res, echo=FALSE, warning=FALSE, message=FALSE}

bio_mw_setting_res <- bioqc %>%  filter((d_143615646_d_593843561=="Yes") & d_650516960=="Research" & d_173836415_d_266600170_d_915179629 !="Research") %>% 
    select(Site, Connect_ID, d_173836415_d_266600170_d_915179629) %>%  sort_by(Site)


colnames(bio_mw_setting_res) <- c("Site", "Connect ID", "BioSpm_MWSettingBL_v1r0")
knitr::kable(bio_mw_setting_res) 
                              
                              
```



### 26.a. If BioFin_BaseBloodCol_v1r0= yes, and BioSpm_BloodSettingBL_v1r0= Research, then BioFin_ResearchBldTmBL_v1r0 must be populated.
```{r All3_R_B1, echo=FALSE, warning=FALSE, message=FALSE}

r_blood3.1 <- bioqc %>%  filter(d_878865966=="Yes" & d_173836415_d_266600170_d_592099155=="Research" & is.na(d_173836415_d_266600170_d_561681068))  %>%  
    select(Site, Connect_ID, d_878865966, d_173836415_d_266600170_d_592099155, d_173836415_d_266600170_d_561681068) %>%  sort_by(Site)


colnames(r_blood3.1) <- c("Site", "Connect ID", "Blood Collected", "Blood Setting", "Collection Time")
knitr::kable(r_blood3.1) 
                              
```
### 26.b. If BioSpm_BloodSettingBL_v1r0 is populated, then BioFin_BaseBloodCol_v1r0= yes.
```{r All3_R_B2, echo=FALSE, warning=FALSE, message=FALSE}

r_blood3.2 <- bioqc %>%  filter(!is.na(d_173836415_d_266600170_d_592099155) & d_878865966=="No") %>% 
    select(Site, Connect_ID, d_173836415_d_266600170_d_592099155, d_878865966) %>%  sort_by(Site)


colnames(r_blood3.2) <- c("Site", "Connect ID", "Blood Setting","Blood Collected")
knitr::kable(r_blood3.2) 
                              
```
### 26.c. If BioFin_BaseBloodCol_v1r0= yes, then BioSpm_BloodSettingBL_v1r0 must be populated.
```{r All3_R_B3, echo=FALSE, warning=FALSE, message=FALSE}

r_blood3.3 <- bioqc %>%  filter(d_878865966=="Yes" & is.na(d_173836415_d_266600170_d_592099155)) %>%  #not all populated
    select(Site, Connect_ID, d_878865966, d_173836415_d_266600170_d_592099155) %>%  sort_by(Site)


colnames(r_blood3.3) <- c("Site", "Connect ID", "Blood Collected", "Blood Setting")
knitr::kable(r_blood3.3) 
                              
```
### 26.d. If BioFin_ResearchBldTmBL_v1r0 is populated, then BioSpm_BloodSettingBL_v1r0 must be Research and BioFin_BaseBloodCol_v1r0 must be yes.
```{r All3_R_B4, echo=FALSE, warning=FALSE, message=FALSE}

r_blood3.4 <- bioqc %>%  filter(!is.na(d_173836415_d_266600170_d_561681068) & (d_173836415_d_266600170_d_592099155=="Clinical" | is.na(d_173836415_d_266600170_d_592099155) | d_878865966=="No")) %>% 
    select(Site, Connect_ID, d_878865966, d_173836415_d_266600170_d_592099155, d_173836415_d_266600170_d_561681068) %>%  sort_by(Site)


colnames(r_blood3.4) <- c("Site", "Connect ID", "Blood Collected", "Blood Setting", "Time Collected")
knitr::kable(r_blood3.4) 
                              
```




### 27.a. If BioFin_BaseUrineCol_v1r0= yes, and BioSpm_UrineSettingBL_v1r0= Research, then BioFin_ResearchUrnTmBL_v1r0 must be populated.
```{r All3_U_B1, echo=FALSE, warning=FALSE, message=FALSE}

r_urine3.1 <- bioqc %>% filter(d_167958071=="Yes" & d_173836415_d_266600170_d_718172863=="Research" & is.na(d_173836415_d_266600170_d_847159717)) %>% 
    select(Site, Connect_ID, d_167958071, d_173836415_d_266600170_d_718172863, d_173836415_d_266600170_d_847159717) %>%  sort_by(Site)


colnames(r_urine3.1) <- c("Site", "Connect ID", "Urine Collected", "Collection Setting", "Time Collected")
knitr::kable(r_urine3.1) 
                              
```
### 27.b. If BioSpm_UrineSettingBL_v1r0 is populated, then BioFin_BaseUrineCol_v1r0= yes.
```{r All3_U_B2, echo=FALSE, warning=FALSE, message=FALSE}

r_urine3.2 <- bioqc %>% filter(!is.na(d_173836415_d_266600170_d_718172863) & d_167958071=="No") %>% 
    select(Site, Connect_ID, d_167958071, d_173836415_d_266600170_d_718172863) %>%  sort_by(Site)


colnames(r_urine3.2) <- c("Site", "Connect ID", "Urine Collected", "Collection Setting")
knitr::kable(r_urine3.2) 
                              
```
### 27.c. If BioFin_BaseUrineCol_v1r0= yes, then BioSpm_UrineSettingBL_v1r0 must be populated.
```{r All3_U_B3, echo=FALSE, warning=FALSE, message=FALSE}

r_urine3.3 <- bioqc %>% filter(d_167958071=="Yes" & is.na(d_173836415_d_266600170_d_718172863)) %>% 
    select(Site, Connect_ID, d_167958071, d_173836415_d_266600170_d_718172863) %>%  sort_by(Site)


colnames(r_urine3.3) <- c("Site", "Connect ID", "Urine Collected", "Collection Setting")
knitr::kable(r_urine3.3) 
                              
```
### 27.d. If BioFin_ResearchUrnTmBL_v1r0 is populated, then BioSpm_UrineSettingBL_v1r0 must be Research and BioFin_BaseUrineCol_v1r0 must be yes.
```{r All3_U_B4, echo=FALSE, warning=FALSE, message=FALSE}

r_urine3.4 <- bioqc %>% filter(!is.na(d_173836415_d_266600170_d_847159717) & (d_173836415_d_266600170_d_718172863=="Clinical" | is.na(d_173836415_d_266600170_d_718172863) | d_167958071=="No")) %>% 
    select(Site, Connect_ID, d_167958071, d_173836415_d_266600170_d_718172863, d_173836415_d_266600170_d_847159717) %>%  sort_by(Site)


colnames(r_urine3.4) <- c("Site", "Connect ID", "Urine Collected", "Collection setting", "Time Collected")
knitr::kable(r_urine3.4) 
                              
```



### 28.a. If BioFin_BaseMouthCol_v1r0= yes, and BioSpm_MWSettingBL_v1r0 is populated, then BioFin_BMTimeBL_v1r0 must be populated.
```{r All3_R_MW1, echo=FALSE, warning=FALSE, message=FALSE}

r_mw3.1 <- bioqc %>%  filter(d_684635302=="Yes" & !is.na(d_173836415_d_266600170_d_915179629) & is.na(d_173836415_d_266600170_d_448660695)) %>% 
    select(Site, Connect_ID, d_684635302, d_173836415_d_266600170_d_915179629, d_173836415_d_266600170_d_448660695) %>%  sort_by(Site)


colnames(r_mw3.1) <- c("Site", "Connect ID", "MW Collected", "Collection Setting", "Time Collected")
knitr::kable(r_mw3.1) 
                              
```
### 28.b. If BioSpm_MWSettingBL_v1r0 is populated, then BioFin_BaseMouthCol_v1r0= yes.
```{r All3_R_MW2, echo=FALSE, warning=FALSE, message=FALSE}

r_mw3.2 <- bioqc %>%  filter(!is.na(d_173836415_d_266600170_d_915179629) & d_684635302=="No") %>%  
    select(Site, Connect_ID, d_684635302, d_173836415_d_266600170_d_915179629) %>%  sort_by(Site)


colnames(r_mw3.2) <- c("Site", "Connect ID", "MW Collected", "Collection Setting")
knitr::kable(r_mw3.2) 
                              
```
### 28.c. If BioFin_BaseMouthCol_v1r0= yes, then BioSpm_MWSettingBL_v1r0 must be populated.
```{r All3_R_MW3, echo=FALSE, warning=FALSE, message=FALSE}

r_mw3.3 <- bioqc %>%  filter(d_684635302=="Yes" & is.na(d_173836415_d_266600170_d_915179629)) %>%  #not all populated
    select(Site, Connect_ID, d_684635302, d_173836415_d_266600170_d_915179629) %>%  sort_by(Site)


colnames(r_mw3.3) <- c("Site", "Connect ID", "MW Collected", "Collection Setting")
knitr::kable(r_mw3.3) 
                              
```
### 28.d. If BioFin_BMTimeBL_v1r0 is populated, then BioSpm_MWSettingBL_v1r0 must be populated and BioFin_BaseMouthCol_v1r0 must be yes.
```{r All3_R_MW4, echo=FALSE, warning=FALSE, message=FALSE}

r_mw3.4 <- bioqc %>%  filter(!is.na(d_173836415_d_266600170_d_448660695) & (is.na(d_173836415_d_266600170_d_915179629) | d_684635302=="No")) %>%  
    select(Site, Connect_ID, d_684635302, d_173836415_d_266600170_d_915179629, d_173836415_d_266600170_d_448660695) %>%  sort_by(Site)


colnames(r_mw3.4) <- c("Site", "Connect ID", "MW Collected", "Collection Setting", "Time Collected")
knitr::kable(r_mw3.4) 
                              
```



### 29.a. If BioFin_BaseBloodCol_v1r0= yes, BioSpm_BloodSettingBL_v1r0= Clinical, and BioClin_DBBloodRRLDt_v1r0 occurred more than seven days ago, then BioClin_ClinBloodTmBL_v1r0 must be populated.
```{r All3_C_B1, echo=FALSE, warning=FALSE, message=FALSE}

c_blood3.1 <- bioqc %>%  filter(d_878865966=="Yes" & d_173836415_d_266600170_d_592099155=="Clinical" & 
                                  as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_398645039, units="days"), digits=0)) > 7 & is.na(d_173836415_d_266600170_d_982213346)) %>% 
    select(Site, Connect_ID, d_878865966, d_173836415_d_266600170_d_592099155, d_173836415_d_266600170_d_982213346) %>%  sort_by(Site)


colnames(c_blood3.1) <- c("Site", "Connect ID", "Blood Collected", "Collection Setting", "Time Collected")
knitr::kable(c_blood3.1) 
                              
```

### 29.b. If BioClin_ClinBloodTmBL_v1r0 is populated, then BioSpm_BloodSettingBL_v1r0 must be Clinical and BioFin_BaseBloodCol_v1r0 must be yes.
```{r All3_C_B4, echo=FALSE, warning=FALSE, message=FALSE}

c_blood3.4 <- bioqc %>%  filter(!is.na(d_173836415_d_266600170_d_982213346) & 
                                  ((d_173836415_d_266600170_d_592099155=="Research" | is.na(d_173836415_d_266600170_d_592099155)) | d_878865966=="No") &
                                  !(Connect_ID %in%  c("7848933050", "5885436394", "9258958214", "2300063524"))) %>% 
    select(Site, Connect_ID, d_878865966, d_173836415_d_266600170_d_592099155, d_173836415_d_266600170_d_982213346) %>%  sort_by(Site)


colnames(c_blood3.4) <- c("Site", "Connect ID", "Blood Collected", "Collection Setting", "Time Collected")
knitr::kable(c_blood3.4) 
                              
```



### 30.a. If BioFin_BaseUrineCol_v1r0= yes, and BioSpm_UrineSettingBL_v1r0= Clinical, and BioClin_DBUrineRRLDt_v1r0 occurred more than seven days ago, then BioClin_ClinicalUrnTmBL_v1r0 must be populated.
```{r All3_C_U1, echo=FALSE, warning=FALSE, message=FALSE}

c_urine3.1 <- bioqc %>%  filter(d_167958071=="Yes" & d_173836415_d_266600170_d_718172863=="Clinical" & 
                                  as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_541311218, units="days"), digits=0)) > 7 & is.na(d_173836415_d_266600170_d_139245758))  %>%  
    select(Site, Connect_ID, d_167958071, d_173836415_d_266600170_d_718172863, d_173836415_d_266600170_d_139245758) %>%  sort_by(Site)


colnames(c_urine3.1) <- c("Site", "Connect ID", "Urine Collected", "Urine Setting", "Time Collected")
knitr::kable(c_urine3.1) 
                              
```


### 30.b. If BioClin_ClinicalUrnTmBL_v1r0 is populated, then BioSpm_UrineSettingBL_v1r0 must be Clinical and BioFin_BaseUrineCol_v1r0 must be yes.
```{r All3_C_U4, echo=FALSE, warning=FALSE, message=FALSE}

c_urine3.4 <- bioqc %>%  filter(!is.na(d_173836415_d_266600170_d_139245758) & d_173836415_d_266600170_d_718172863=="Clinical" & d_167958071=="No")  %>%  
    select(Site, Connect_ID, d_167958071, d_173836415_d_266600170_d_718172863, d_173836415_d_266600170_d_139245758) %>%  sort_by(Site)


colnames(c_urine3.4) <- c("Site", "Connect ID",  "Urine Collected", "Urine Setting", "Time Collected")
knitr::kable(c_urine3.4) 
                              
```


```{r TBA1, echo=FALSE, warning=FALSE, message=FALSE}
### TBA1. If BioClin_SiteBloodCollBL_v1r0 is yes, then BioFin_BaseBloodCol_v1r0 should be yes
no_db_blood <- bioqc %>%  filter(d_173836415_d_266600170_d_693370086=="Yes" & d_878865966=="No")  %>%  
    select(Site, Connect_ID, d_173836415_d_266600170_d_693370086, d_878865966) %>%  sort_by(Site)


# colnames(no_db_blood) <- c("Site", "Connect ID",  "BioClin_SiteBloodCollBL_v1r0", "BioFin_BaseBloodCol_v1r0")
# knitr::kable(no_db_blood) 
# write.csv(no_db_blood,paste0('Github_Issue185', Sys.Date(), '.csv'), row.names = F,na="")
                              
```


```{r TBA2, echo=FALSE, warning=FALSE, message=FALSE}
### TBA2. If BioClin_SiteUrineCollBL_v1r0 is yes, then BioFin_BaseUrineCol_v1r0 should be yes
# no_db_urine <- bioqc %>%  filter(d_173836415_d_266600170_d_786930107=="Yes" & d_167958071=="No")  %>%  
#     select(Site, Connect_ID, d_173836415_d_266600170_d_786930107, d_167958071) %>%  sort_by(Site)
# 
# 
# colnames(no_db_urine) <- c("Site", "Connect ID",  "BioClin_SiteUrineCollBL_v1r0", "BioFin_BaseUrineCol_v1r0")
# knitr::kable(no_db_urine) 
# write.csv(no_db_urine,paste0('Github_Issue_185', Sys.Date(), '.csv'), row.names = F,na="")
                              
```



\newpage
\FloatBarrier
### 31. BioClin_DBBloodID_v1r0 must be in BioClin_PolyBloodID_v1r0 if and BioClin_DBBloodRRLDt_v1r0 occured more than 7 days ago


```{r BioClin_PolyBloodID_v1r0, echo=FALSE, warning=FALSE, message=FALSE}


bioqc1 <- bioqc %>%
  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_398645039, units="days"), digits=0)) > 7 &
           !is.na(d_646899796_integer) & 
           (Site=="Henry Ford Health System" | Site=="University of Chicago Medicine") & #only HP and UC sends this
               #d_173836415_d_266600170_d_543608829 != "[]") & 
           !(Connect_ID %in% c("2824989966","3759939890" ,"4688823720" ,"8589481620" ,"6336258662","5461650381","4900116130",
             "4462616750","9111871102","8476952861","2974054638" ,"3544623873","3293040395","7571439842","3165368475",
             "6954174713","6361337944","1629086681","3544623873","3293040395","7571439842","3165368475","6954174713",
             "6361337944","1629086681","9768745029","3770024701","8836251245","3312148528",# HFH exclusions
             "4782195164", "6229346420",# UC exclusions
             "8336144924","7515171846","9963945282" ,"9554775290" ,"8570090186", "4727512872","5506703775","8123989364","9843228847")) & #SF exclusions 
           !(Connect_ID %in% qc_8$`Connect ID`) # Don't count the empty bracket people if they're in rule #8, because those would be expected
  )

#remove any brackets or blank spaces around polyID
str1 <- bioqc1$d_173836415_d_266600170_d_543608829
str1 <- str_trim(str1)
PolyBloodID <- unlist(strsplit(gsub("\\[|\\]", "", str1), ",")) 
bioqc1$d_646899796_integer <- str_trim(bioqc1$d_646899796_integer)

#Sometimes this poly accession comes in as an array, sometimes it doesn't, so just selecting the integer version of the variable
bioqc1 <- bioqc1 %>% mutate(BioClin_DBBloodID_v1r0=ifelse(Site=="Henry Ford Health System", paste0("L", d_646899796_integer), d_646899796_integer))


polyblood <- bioqc1 %>%  filter(!(bioqc1$BioClin_DBBloodID_v1r0 %in% PolyBloodID)) %>%  select(Site, Connect_ID, BioClin_DBBloodID_v1r0, d_173836415_d_266600170_d_543608829) %>% sort_by(Site)
colnames(polyblood) <- c("Site", "Connect ID", "BioClin_DBBloodID_v1r0", "BioClin_PolyBloodID_v1r0")
knitr::kable(polyblood) %>% kable_styling(latex_options = "HOLD_position") %>% row_spec(1:nrow(polyblood), font_size = 3)


```
\newpage
\FloatBarrier
### 32. BioClin_DBUrineID_v1r0 must be in BioClin_PolyUrineID_v1r0 if BioClin_DBUrineRRLDt_v1r0 occurred more than seven days ago.

```{r PolyUrineID, echo=FALSE, warning=FALSE, message=FALSE}



bioqc2 <- bioqc %>%  filter( as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_541311218, units="days"), digits=0)) > 7 &
                               (Site=="Henry Ford Health System" | Site=="University of Chicago Medicine") & #only HP and UC sends this
                               !is.na(d_928693120_integer) & #d_173836415_d_266600170_d_110349197!="[]" & 
                               !(Connect_ID %in% c("1629086681", "3165368475", "3293040395", "3544623873", "6361337944", "6954174713", "7571439842",
                                                   "3770024701", "8836251245", "9768745029", "5461650381", "4900116130", "4435276749",  
                                                   "6473532641", "6336258662", "8589481620", "4688823720", "3759939890", "2824989966")) & #HFH exclusions
                               !(Connect_ID %in% qc_7$`Connect ID`)) # Don't count the empty bracket people if they're in rule #7, because those would be expected

#remove any brackets around polyID
str2 <- bioqc2$d_173836415_d_266600170_d_110349197
str2 <- str_trim(str2)
PolyUrineID <- unlist(strsplit(gsub("\\[|\\]", "", str2), ",")) 
bioqc2$d_928693120_integer <- str_trim(bioqc2$d_928693120_integer) 


#Sometimes this poly accession comes in as an array, sometimes it doesn't, so just selecting the integer version of the variable
bioqc2 <- bioqc2 %>%   mutate(BioClin_DBUrineID_v1r0=ifelse(Site=="Henry Ford Health System", paste0("L", d_928693120_integer),d_928693120_integer))


polyurine <- bioqc2 %>%  filter(!(bioqc2$BioClin_DBUrineID_v1r0 %in% PolyUrineID)) %>%  select(Site, Connect_ID, BioClin_DBUrineID_v1r0, d_173836415_d_266600170_d_110349197) %>% sort_by(Site)
colnames(polyurine) <- c("Site", "Connect ID", "BioClin_DBUrineID_v1r0", "BioClin_PolyUrineID_v1r0")
knitr::kable(polyurine) %>% kable_styling(latex_options =  "scale_down") %>% row_spec(1:nrow(polyurine), font_size = 3)


```





\FloatBarrier
\newpage

```{r home_collections, include=FALSE}


MW <- "SELECT  Connect_ID, d_143615646_d_593843561, d_143615646_d_825582494, d_820476880 FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.biospecimen_JP`  where Connect_ID IS NOT NULL"


MW_table <- bq_project_query(project, MW)
MW_data <- bq_table_download(MW_table, bigint = "integer64", n_max = Inf, page_size = 1000)



kit <- "SELECT * FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.kitAssembly_JP` where Connect_ID is not null"

kit_table <- bq_project_query(project, kit)

kit_data <- bq_table_download(kit_table, bigint = "integer64", n_max = Inf, page_size = 1000)


MW_data$Connect_ID <- as.numeric(MW_data$Connect_ID)
kit_data$Connect_ID <- as.numeric(kit_data$Connect_ID)


HMW= left_join(parts_data, kit_data, by="Connect_ID" ) 


HMW <- HMW %>%  mutate(Site=case_when(d_827220437==531629870 ~ "HealthPartners",
                                      d_827220437 == 548392715 ~ "Henry Ford Health System",
                                      d_827220437 == 303349821 ~ "Marshfield Clinical Health System",
                                      d_827220437 == 657167265 ~ "Sanford Health",
                                      d_827220437 == 809703864 ~ "University of Chicago Medicine",
                                      d_827220437 == 125001209 ~ "Kaiser Permanente Colorado",
                                      d_827220437 == 327912200 ~ "Kaiser Permanente Georgia",
                                      d_827220437 == 300267574 ~ "Kaiser Permanente Hawaii",
                                      d_827220437 == 452412599 ~ "Kaiser Permanente Northwest",
                                      d_827220437 == 472940358 ~ "Baylor Scott and White Health"))


Bio_HMW <- HMW %>%  left_join(MW_data,  by="Connect_ID") 


```


### 33. If kit status is Pending, then date/time kit pending should populate
```{r pending, echo=FALSE, warning=FALSE, message=FALSE}


#IF BioKit_KitStatus_v1r0 (221592017) = 0 THEN BioKit_KitDatePend_v1r0 (341636034) = populate

pend <- HMW %>%  filter(d_173836415_d_266600170_d_319972665_d_221592017==517216441 & is.na(d_341636034)) %>% 
  select(Site, Connect_ID, d_341636034) %>%  sort_by(Site)

colnames(pend) <- c("Site", "Connect ID", "BioKit_KitDatePend")
knitr::kable(pend) %>% kable_styling(latex_options = "HOLD_position")

```

### 34. If kit type is Mouthwash, then return kit tracking number, supply kit ID, return kit ID, collection cup ID, and collection card ID should populate.

```{r all_populate, echo=FALSE, warning=FALSE, message=FALSE}


#IF BioKit_KitType_v1r0 (379252329) = 0 THEN BioKit_ReturnKitTrack_v1r0 (972453354), BioKit_SupplyKitID_v1r0 (690210658), BioKit_ReturnKitID_v1r0 (194252513), BioKit_MWCupID_v1r0 (259846815), and BioKit_MWCardID_v1r0 (786397882) = populate


all_populate <- HMW %>%  filter(d_173836415_d_266600170_d_319972665_d_379252329==976461859 & 
                                  (d_173836415_d_266600170_d_319972665_d_221592017==241974920 | 
                                     d_173836415_d_266600170_d_319972665_d_221592017==277438316 |
                                     d_173836415_d_266600170_d_319972665_d_221592017==375535639) &
                                  (is.na(d_972453354) | is.na(d_690210658) | is.na(d_194252513) | is.na(d_259846815) | is.na(d_786397882) )) %>% 
  select(Site, Connect_ID, d_972453354, d_690210658, d_194252513, d_259846815, d_786397882) %>%  sort_by(Site)

colnames(all_populate) <- c("Site", "Connect ID", "ReturnKitTrack", "SupplyKitID", "ReturnKitID", "MWCupID", "MWCardID")
knitr::kable(all_populate) %>% kable_styling(latex_options = "HOLD_position")

```


### 35. If kit type is Mouthwash, then supply kit ID should be equal to return kit ID 
```{r HC_Rules1, echo=FALSE, warning=FALSE, message=FALSE}


hmw1 <- HMW %>%  filter(d_173836415_d_266600170_d_319972665_d_379252329==976461859 & d_690210658!=d_194252513 & 
                          Connect_ID!=4765411890) %>% #KPCO exclusion
  select(Site, Connect_ID, d_690210658) %>%  sort_by(Site)

colnames(hmw1) <- c("Site", "Connect ID", "Supply Kit ID")
knitr::kable(hmw1) %>% kable_styling(latex_options = "HOLD_position")
```

### 36.  If kit type is Mouthwash, then collection cup ID should be equal to collection card ID

```{r HC_Rules2, echo=FALSE, warning=FALSE, message=FALSE}



hmw2 <- HMW %>%  filter(d_173836415_d_266600170_d_319972665_d_379252329==976461859 & d_259846815!=d_786397882) %>% 
  select(Site, Connect_ID, d_259846815) %>%  sort_by(Site)

colnames(hmw2) <- c("Site", "Connect ID", "Collection Cup ID")
knitr::kable(hmw2) %>% kable_styling(latex_options = "HOLD_position")
```


### 37. If kit status is Assigned, then supply kit tracking number should populate
```{r assigned, echo=FALSE, warning=FALSE, message=FALSE}


#IF BioKit_KitStatus_v1r0 (221592017) = 2 THEN BioKit_SupplyKitTrack_v1r0 (531858099) = populate

asgn <- HMW %>%  filter(d_173836415_d_266600170_d_319972665_d_221592017==241974920 & is.na(d_531858099)) %>% 
  select(Site, Connect_ID, d_531858099) %>%  sort_by(Site)

colnames(asgn) <- c("Site", "Connect ID", "BioKit_SupplyKitTrack")
knitr::kable(asgn) %>% kable_styling(latex_options = "HOLD_position")

```


### 38. If kit status is Shipped, then supply kit tracking number and date/time kit shipped should populate
```{r shipped, echo=FALSE, warning=FALSE, message=FALSE}


#IF BioKit_KitStatus_v1r0 (221592017) = 3 THEN BioKit_SupplyKitTrack_v1r0 (531858099) and BioKit_KitShipTm_v1r0 (661940160) = populate
# BioKit_SupplyKitTrack_v1r0  is all null here, but 39 rows in prod

shipt <- HMW %>%  filter(d_173836415_d_266600170_d_319972665_d_221592017==277438316 & (is.na(d_531858099) | is.na(d_173836415_d_266600170_d_319972665_d_661940160))) %>% 
  select(Site, Connect_ID, d_531858099, d_173836415_d_266600170_d_319972665_d_661940160) %>%  sort_by(Site)

colnames(shipt) <- c("Site", "Connect ID", "BioKit_SupplyKitTrack", "BioKit_KitShipTm")
knitr::kable(shipt) %>% kable_styling(latex_options = "HOLD_position")

```

### 39. If kit status is Received, then supply kit tracking number, date/time kit shipped, date/time kit received should populate
```{r recvd, echo=FALSE, warning=FALSE, message=FALSE}



#IF BioKit_KitStatus_v1r0 (221592017) = 4 THEN BioKit_SupplyKitTrack_v1r0 (531858099), BioKit_KitShipTm_v1r0 (661940160), BioKit_KitRecdTm_v1r0 (826941471), and BioKit_CollCardRet_v1r0 (137401245) = populate

recvd <- HMW %>%  filter(d_173836415_d_266600170_d_319972665_d_221592017==375535639 & (is.na(d_531858099) | is.na(d_661940160) |
                                                                        is.na(d_826941471) |  is.na(d_137401245))) %>% 
  select(Site, Connect_ID, d_531858099, d_661940160, d_826941471, d_137401245) %>%  sort_by(Site)

colnames(recvd) <- c("Site", "Connect ID", "SupplyKitTrack", "KitShipTm", "KitRecdTm", "CollCardRet")
knitr::kable(recvd) %>% kable_styling(latex_options = "HOLD_position")

```



### 40. If kit status is Received, then the mouthwash sample is collected.
```{r collected, echo=FALSE, warning=FALSE, message=FALSE}


# IF BioKit_KitStatus_v1r0 (221592017) = 4 THEN MWTube1_BioCol_TubeCollected_v1r0 (d_143615646_d_593843561) = 1

collctd <- Bio_HMW %>%  filter(str_sub(d_820476880,1,3)=="CHA" & d_173836415_d_266600170_d_319972665_d_221592017==375535639 & (is.na(d_143615646_d_593843561) |
                                                                                        d_143615646_d_593843561=="No")) %>% 
  select(Site, Connect_ID, d_143615646_d_593843561) %>%  sort_by(Site)

colnames(collctd) <- c("Site", "Connect ID", "MWTube1_BioCol_TubeCollected")
knitr::kable(collctd) %>% kable_styling(latex_options = "HOLD_position")
 
```


### 41. If kit status is Received, then the mouthwash sample tube ID should populate.

```{r mwtubeid, echo=FALSE, warning=FALSE, message=FALSE}


#IF BioKit_KitStatus_v1r0 (221592017) = 4 THEN MWTube1_BioCol_TubeID_v1r0 (d_143615646_d_825582494) = populate

mwtubeid <- Bio_HMW %>%  filter(str_sub(d_820476880,1,3)=="CHA" & d_173836415_d_266600170_d_319972665_d_221592017==375535639 & is.na(d_143615646_d_825582494)) %>% 
  select(Site, Connect_ID, d_143615646_d_825582494) %>%  sort_by(Site)

colnames(mwtubeid) <- c("Site", "Connect ID", "MWTube1_BioCol_TubeID")
knitr::kable(mwtubeid) %>% kable_styling(latex_options = "HOLD_position")

```


### 42.a If kit status (from the participants table) is Received, and kit type is Mouthwash, then the populated mouthwash sample tube ID (full specimen ID) should equal the populated collection cup ID.

```{r HC_Rules3, echo=FALSE, warning=FALSE, message=FALSE}


#IF BioKit_KitStatus_v1r0 from the particpants table (221592017) = 4  AND BioKit_KitType_v1r0 (379252329) = 0, THEN MWTube1_BioCol_TubeID_v1r0 (d_143615646_d_825582494) = BioKit_MWCupID_v1r0 (259846815)
hmw3 <- Bio_HMW %>%  filter(str_sub(d_820476880,1,3)=="CHA" & d_173836415_d_266600170_d_319972665_d_221592017==375535639 & d_173836415_d_266600170_d_319972665_d_379252329==976461859 & d_143615646_d_825582494!=d_259846815) %>% 
  select(Site, Connect_ID, d_143615646_d_825582494) %>%  sort_by(Site)

colnames(hmw3) <- c("Site", "Connect ID", "Mouthwash Sample Tube ID (Full Specimen ID)")
knitr::kable(hmw3) %>% kable_styling(latex_options = "HOLD_position")

```


### 42.b If kit status (from the kit assembly table) is Received, and kit type is Mouthwash, then the populated mouthwash sample tube ID (full specimen ID) should equal the populated collection cup ID.

```{r HC_Rules4, echo=FALSE, warning=FALSE, message=FALSE}


#IF BioKit_KitStatus_v1r0 from the kit assembly table (221592017) = 4  AND BioKit_KitType_v1r0 (379252329) = 0, THEN MWTube1_BioCol_TubeID_v1r0 (d_143615646_d_825582494) = BioKit_MWCupID_v1r0 (259846815)
hmw4 <-  Bio_HMW %>%  filter(str_sub(d_820476880,1,3)=="CHA" & d_221592017==375535639 & d_173836415_d_266600170_d_319972665_d_379252329==976461859 & d_143615646_d_825582494!=d_259846815) %>% 
  select(Site, Connect_ID, d_143615646_d_825582494) %>%  sort_by(Site)

colnames(hmw4) <- c("Site", "Connect ID", "Mouthwash Sample Tube ID (Full Specimen ID)")
knitr::kable(hmw4) %>% kable_styling(latex_options = "HOLD_position")


```


### 43. If kit status is Received, and the kit type is Mouthwash, then the mouthwash collection setting is Home.

```{r homsetting, echo=FALSE, warning=FALSE, message=FALSE}



# IF BioKit_KitStatus_v1r0 (221592017) = 4 AND BioKit_KitType_v1r0 (379252329) = 0 THEN BioSpm_MWSettingBL_v1r0 (915179629) = 2
homsetting <- HMW %>%  filter(d_173836415_d_266600170_d_319972665_d_221592017==375535639 & d_173836415_d_266600170_d_319972665_d_379252329==976461859 & d_173836415_d_266600170_d_915179629!=103209024) %>% 
  mutate(BioSpm_MWSettingBL = case_when(d_173836415_d_266600170_d_915179629=="103209024" ~ "Home",
                                        d_173836415_d_266600170_d_915179629=="534621077" ~ "Research",
                                        d_173836415_d_266600170_d_915179629=="664882224" ~ "Clinical",
                                        TRUE ~ "NA")) %>% 
  select(Site, Connect_ID, BioSpm_MWSettingBL) %>%  sort_by(Site)

#colnames(homsetting) <- c("Site", "Connect ID", "BioSpm_MWSettingBL")
knitr::kable(homsetting) %>% kable_styling(latex_options = "HOLD_position")


```


### 44. If the mouthwash collection setting is Home, and the mouthwash sample is collected, then baseline mouthwash is collected.
```{r bl_mw, echo=FALSE, warning=FALSE, message=FALSE}



# If BioSpm_MWSettingBL_v1r0 (915179629) = 2 AND MWTube1_BioCol_TubeCollected_v1r0 (d_143615646_d_593843561) = 1 THEN BioFin_BaseMouthCol_v1r0 (684635302) = 1
bl_mw <-  Bio_HMW %>%  filter(str_sub(d_820476880,1,3)=="CHA" & d_173836415_d_266600170_d_915179629==103209024 & d_143615646_d_593843561=="Yes" & 
                           (d_684635302=="No" | is.na(d_684635302)) ) %>% 
  select(Site, Connect_ID, d_684635302) %>%  sort_by(Site)

colnames(bl_mw) <- c("Site", "Connect ID", "BioFin_BaseMouthCol")
knitr::kable(bl_mw) %>% kable_styling(latex_options = "HOLD_position")


```



### 45. If the mouthwash collection setting is Home, and the mouthwash sample is collected, then the mouthwash date/time collected should populate.
```{r mw_dt, echo=FALSE, warning=FALSE, message=FALSE}



# If BioSpm_MWSettingBL_v1r0 (915179629) = 2 AND MWTube1_BioCol_TubeCollected_v1r0 (d_143615646_d_593843561) = 1 THEN BioFin_BMTimeBL_v1r0 (448660695) = populate
mw_dt <-  Bio_HMW %>%  filter(str_sub(d_820476880,1,3)=="CHA" & d_173836415_d_266600170_d_915179629==103209024 & d_143615646_d_593843561=="Yes" & 
                           is.na(d_173836415_d_266600170_d_448660695)) %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_448660695) %>%  sort_by(Site)

colnames(mw_dt) <- c("Site", "Connect ID", "BioFin_BMTimeBL")
knitr::kable(mw_dt) %>% kable_styling(latex_options = "HOLD_position")


```


### 46. If BioSpm_MWSettingBL_v1r0 is Home and SrvMtW_TmComplete_v1r0 is more than 10 days ago, BioKit_KitStatusBL_v1r0 should be Received
```{r kit_recvd, echo=FALSE, warning=FALSE, message=FALSE}

kits_recvd <- HMW %>%  filter(#d_173836415_d_266600170_d_915179629==103209024 & #--- sometimes this is null, sometimes its home 
                                  as.numeric(round(difftime(currentDate, d_195145666, units="days"), digits=0)) > 10 & 
                                  d_173836415_d_266600170_d_319972665_d_221592017!="375535639") %>% 
  select(Site, Connect_ID, d_195145666, d_972453354) %>%  sort_by(Site)

colnames(kits_recvd) <- c("Site", "Connect ID", "SrvMtW_TmComplete_v1r0", "BioKit_ReturnKitTrack")
#knitr::kable(kits_recvd) %>% kable_styling(latex_options = "HOLD_position")

cat(paste0("There are ", nrow(kits_recvd), " rows. This has been made into a separate XLXS file called", "\n", "'Biospecimen_QC_Rule46_Errors[current date]_[box folder number].xlxs'"))

openxlsx::write.xlsx(kits_recvd,glue("{local_drive}Biospecimen_QC_Rule46_Errors{currentDate}_boxfolder_{boxfolder}.xlsx"),row.names = F,na="")

```


### 47. BioFin_BMTimeBL_v1r0 must be in the structure of YYYY-MM-DDTHH:MM:SS or YYYY-MM-DDTHH:MM:SS.SSSZ
\FloatBarrier
```{r MW_coll_DT, echo=FALSE, warning=FALSE, message=FALSE}


#date/time can be YYYY-MM-DDTHH:MM:SS or YYYY-MM-DDTHH:MM:SS.SSSZ
datetime_regex <- "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}$|^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d{3}Z$"

invalid_rows <- HMW %>%
    filter(!is.na(d_173836415_d_266600170_d_448660695) & 
           !grepl(datetime_regex, d_173836415_d_266600170_d_448660695)) %>%
    select(Site, Connect_ID, d_173836415_d_266600170_d_448660695, d_173836415_d_266600170_d_319972665_d_661940160,d_173836415_d_266600170_d_319972665_d_826941471) %>%
    arrange(Site)


invalid_rows2 <-  HMW %>%
    filter((as.POSIXct(ymd_hms(d_173836415_d_266600170_d_448660695)) < as.POSIXct(ymd_hms(d_173836415_d_266600170_d_319972665_d_661940160))) |
             (as.POSIXct(ymd_hms(d_173836415_d_266600170_d_448660695)) > as.POSIXct(ymd_hms(d_173836415_d_266600170_d_319972665_d_826941471))) |
             as.numeric(difftime(as.POSIXct(ymd_hms(d_173836415_d_266600170_d_448660695)), as.POSIXct(ymd_hms(d_173836415_d_266600170_d_319972665_d_661940160)), units="days"))>60) %>%
    select(Site, Connect_ID, d_173836415_d_266600170_d_448660695, d_173836415_d_266600170_d_319972665_d_661940160, d_173836415_d_266600170_d_319972665_d_826941471) %>%
    arrange(Site)

invalid_rows_all <- rbind(invalid_rows,invalid_rows2)

colnames(invalid_rows) <- c("Site", "Connect ID", "BioFin_BMTimeBL_v1r0k", "BioKit_KitShipTm_v1r0", "BioKit_KitRecdTm_v1r0")
knitr::kable(invalid_rows) %>% kable_styling(latex_options = "scale_down", full_width = FALSE, font_size = 8)

```
\FloatBarrier



```{r bioqcSetUp, include=FALSE}



# bio2 <- "WITH T AS (
#   SELECT Connect_ID FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.biospecimen_JP`
#   GROUP BY Connect_ID
#   HAVING COUNT(Connect_ID) =1 ) 
# SELECT * FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.biospecimen_JP`
# INNER JOIN T ON `nih-nci-dceg-connect-prod-6d04.FlatConnect.biospecimen_JP`.Connect_ID = T.Connect_ID ;"



# parts2 <- "SELECT Connect_ID, d_173836415_d_266600170_d_139245758, d_173836415_d_266600170_d_156605577, d_173836415_d_266600170_d_184451682, d_173836415_d_266600170_d_185243482, d_173836415_d_266600170_d_198261154, d_173836415_d_266600170_d_210921343, d_173836415_d_266600170_d_224596428, d_173836415_d_266600170_d_316824786, d_173836415_d_266600170_d_341570479, d_173836415_d_266600170_d_398645039, d_173836415_d_266600170_d_448660695, d_173836415_d_266600170_d_452847912, d_173836415_d_266600170_d_453452655, d_173836415_d_266600170_d_530173840, d_173836415_d_266600170_d_534041351, d_173836415_d_266600170_d_541311218, d_173836415_d_266600170_d_561681068, d_173836415_d_266600170_d_592099155, d_173836415_d_266600170_d_693370086, d_173836415_d_266600170_d_718172863, d_173836415_d_266600170_d_728696253, d_173836415_d_266600170_d_740582332, d_173836415_d_266600170_d_769615780, d_173836415_d_266600170_d_786930107, d_173836415_d_266600170_d_822274939, d_173836415_d_266600170_d_847159717, d_173836415_d_266600170_d_860477844, d_173836415_d_266600170_d_880794013, d_173836415_d_266600170_d_915179629, d_173836415_d_266600170_d_939818935, d_173836415_d_266600170_d_982213346, d_684635302, d_254109640, d_878865966, d_167958071, d_827220437
# FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` where Connect_ID IS NOT NULL"
# 
# parts_table2 <- bq_project_query(project, parts2)
# 
# parts_data2 <- bq_table_download(parts_table2, bigint = "integer64", n_max = Inf, page_size = 1000)
# 
# #bio_table2 <- bq_project_query(project, bio2)
# #bio_data2 <- bq_table_download(bio_table2, bigint = "integer64", n_max = Inf, page_size = 1000)
# 
# 
# #bio_data$Connect_ID <- as.numeric(bio_data$Connect_ID)
# parts_data2$Connect_ID <- as.numeric(parts_data2$Connect_ID)


# 
# #bioqc_join= left_join(parts_data, bio_data, by="Connect_ID") 
# 
# #bioqc <- as_tibble(bioqc_join)
# 
# bioqc2= left_join(bio_data2, parts_data2,  by=c("Connect_ID", "d_827220437") )
# 
# knitr::opts_chunk$set(comment = NA)
# 
# 
# 
# 
# 
# bioqc2 <- bioqc2 %>%  mutate(Site=case_when(d_827220437==531629870 ~ "HealthPartners",
#                                                  d_827220437==548392715 ~ "Henry Ford Health System",
#                                                  d_827220437==303349821 ~ "Marshfield Clinical Health System",
#                                                  d_827220437==657167265 ~ "Sanford Health",
#                                                  d_827220437==809703864 ~ "University of Chicago Medicine",
#                                                 d_827220437==125001209 ~ "Kaiser Permanente Colorado",
#                                                  d_827220437==327912200 ~ "Kaiser Permanente Georgia",
#                                                  d_827220437==300267574 ~ "Kaiser Permanente Hawaii",
#                                                  d_827220437==452412599 ~ "Kaiser Permanente Northwest"))

```





```{r Duplicates, include=FALSE}

dup <- "WITH T AS (
  SELECT Connect_ID 
  FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.biospecimen_JP`
  WHERE d_820476880 LIKE 'CXA%' 
  AND d_820476880 NOT LIKE 'CHA%'
  GROUP BY Connect_ID
  HAVING COUNT(Connect_ID) > 1
) 
SELECT * 
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.biospecimen_JP`
WHERE Connect_ID IN (SELECT Connect_ID FROM T) and d_820476880 NOT LIKE 'CHA%'"


dup_table <- bq_project_query(project, dup)


dup_data <- bq_table_download(dup_table, bigint = "integer64", n_max = Inf, page_size = 1000)


dup_data$Connect_ID <- as.numeric(dup_data$Connect_ID)


bio_dup= left_join(dup_data, parts_data, by=c("Connect_ID", "d_827220437") )

bio_dup <- bio_dup %>%  mutate(Site=case_when(d_827220437==531629870 ~ "HP",
                                                 d_827220437==548392715 ~ "HF",
                                                 d_827220437==303349821 ~ "Marshfield",
                                                 d_827220437==657167265 ~ "Sanford",
                                                 d_827220437==809703864 ~ "UChicago",
                                                d_827220437==125001209 ~ "KPCO",
                                                 d_827220437==327912200 ~ "KPGA",
                                                 d_827220437==300267574 ~ "KPHI",
                                                 d_827220437==452412599 ~ "KPNW"),
                               Finalized= case_when(d_410912345=="104430631" ~ "No",
                                                    d_410912345=="353358909" ~ "Yes",
                                                    TRUE ~ "Null"),
                               Setting = case_when(d_650516960== "664882224" ~ "Clinical",
                                                   d_650516960== "534621077" ~ "Research",
                                                   d_650516960== "103209024" ~ "Home",
                                                   is.na(d_650516960) ~ "Null"),
                               SST1_Tube_Collected= case_when(d_299553921_d_593843561=="353358909" ~ "Yes",
                                                              TRUE ~ "No"),
                               SST2_Tube_Collected= case_when(d_703954371_d_593843561=="353358909" ~ "Yes",
                                                              TRUE ~ "No"),
                               SST3_Tube_Collected= case_when(d_376960806_d_593843561=="353358909" ~ "Yes",
                                                              TRUE ~ "No"),
                               SST4_Tube_Collected= case_when(d_232343615_d_593843561=="353358909" ~ "Yes",
                                                              TRUE ~ "No"),
                               SST5_Tube_Collected= case_when(d_589588440_d_593843561=="353358909" ~ "Yes",
                                                              TRUE ~ "No"),
                               HeparinT1_Tube_Collected= case_when(d_838567176_d_593843561=="353358909" ~ "Yes",
                                                                   TRUE ~ "No"),
                               HeparinT2_Tube_Collected= case_when(d_958646668_d_593843561=="353358909" ~ "Yes",
                                                                   TRUE ~ "No"),
                               EDTAT1_Tube_Collected= case_when(d_454453939_d_593843561=="353358909" ~ "Yes",
                                                                TRUE ~ "No"),
                               EDTAT2_Tube_Collected= case_when(d_677469051_d_593843561=="353358909" ~ "Yes",
                                                                TRUE ~ "No"),
                               EDTAT3_Tube_Collected= case_when(d_683613884_d_593843561=="353358909" ~ "Yes",
                                                                TRUE ~ "No"),
                               ACD_Tube_Collected= case_when(d_652357376_d_593843561=="353358909" ~ "Yes",
                                                             TRUE ~ "No"),
                               STRECK_Tube_Collected= case_when(d_505347689_d_593843561=="353358909" ~ "Yes",
                                                                TRUE ~ "No"),
                               Urine_Tube_Collected= case_when(d_973670172_d_593843561=="353358909" ~ "Yes",
                                                               TRUE ~ "No"),
                               MW_Tube_Collected= case_when(d_143615646_d_593843561=="353358909" ~ "Yes",
                                                            TRUE ~ "No"))


finalized_counts <- bio_dup %>%
  group_by(Connect_ID) %>%
  summarize(Finalized_Count = sum(Finalized == "Yes"))

#Add the new column indicating if the count is more than 1
finalized_counts <- finalized_counts %>%
  mutate(Finalized_Status = ifelse(Finalized_Count > 1, "Yes", "No"))

# Step 4: Join back with the original data to get the Finalized_Status for all participants
bio_dup_with_status <- bio_dup %>%
  left_join(finalized_counts %>% select(Connect_ID, Finalized_Status), by = "Connect_ID")


dup_list <- bio_dup_with_status %>%
  select(Connect_ID, Site, Setting, d_820476880, d_556788178, Finalized, Finalized_Status,
         SST1_Tube_Collected, SST2_Tube_Collected, SST3_Tube_Collected, SST4_Tube_Collected,
         SST5_Tube_Collected, HeparinT1_Tube_Collected, HeparinT2_Tube_Collected, EDTAT1_Tube_Collected,
         EDTAT2_Tube_Collected, EDTAT3_Tube_Collected, ACD_Tube_Collected, STRECK_Tube_Collected,
         Urine_Tube_Collected, MW_Tube_Collected) %>%
  arrange(Connect_ID)

colnames(dup_list) <- c("Connect ID", "Site", "Collection Setting", "Collection ID", "Collection Date/Time", "Collection Finalized", "True Duplicate",
                        "SST1_Tube_Collected", "SST2_Tube_Collected", "SST3_Tube_Collected", "SST4_Tube_Collected",
                        "SST5_Tube_Collected", "HeparinT1_Tube_Collected", "HeparinT2_Tube_Collected", "EDTAT1_Tube_Collected",
                        "EDTAT2_Tube_Collected", "EDTAT3_Tube_Collected", "ACD_Tube_Collected", "STRECK_Tube_Collected","Urine_Tube_Collected", "MW_Tube_Collected")


```




### 48. If BioSpm_Visit_v1r0 is Baseline and the collection is finalized, then BioSpm_Setting_v1r0 for all collections for the participant should either all be Research or Clinical. This only applies to participants with duplicate baseline collections.
```{r Double_Baseline, echo=FALSE, warning=FALSE, message=FALSE}

# Identify Connect_IDs with different d_650516960 values
different_values <- bio_dup_with_status %>%
  filter(d_410912345=="353358909" & 
           !(Connect_ID %in% c("2589415525", "4545815202", "4545815202", "2589415525"))) %>% #Biospecimen team has handled these ones
  group_by(Connect_ID) %>% 
  summarize(unique_values = n_distinct(d_650516960), .groups = "drop") %>%
  filter(unique_values > 1) %>%
  pull(Connect_ID)


split_setting <- bio_dup_with_status %>% filter(Connect_ID %in% different_values) %>% select(Connect_ID)

print(split_setting$Connect_ID)

```




###	49. If BioFin_BaseBloodCol_v1r0 was collected, BioSpm_BloodSettingBL_v1r0 is clincial, and BioClin_DBBloodRRLDtBL_v1r0 occurred more than seven days ago, BioClin_SiteBldLocBL_v1r0 must be populated.
```{r BioClin_SiteBldLocBL_v1r0, echo=FALSE, warning=FALSE, message=FALSE}


blood_loc <- bioqc %>%  filter(d_878865966=="Yes" & d_173836415_d_266600170_d_592099155=="Clinical" & as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_398645039, units="days"), digits=0)) > 7  & 
                           is.na(d_173836415_d_266600170_d_185243482)) %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_398645039, d_173836415_d_266600170_d_185243482) %>%  sort_by(Site)


colnames(blood_loc) <- c("Site", "Connect ID", "BioClin_DBBloodRRLDtBL", "BioClin_SiteBldLocBL")
knitr::kable(blood_loc)

```




###	50. If BioFin_BaseBloodCol_v1r0 was collected, BioSpm_BloodSettingBL_v1r0 is clincial, and BioClin_DBBloodRRLDtBL_v1r0 occurred more than seven days ago, BioClin_SntBloodAccIDBL_v1r0 or BioClin_PolyBloodIDBL_v1r0 must be populated.
```{r New_PolyBlood_Check, echo=FALSE, warning=FALSE, message=FALSE}


blood_locPL <- bioqc %>%  filter(d_878865966=="Yes" & d_173836415_d_266600170_d_592099155=="Clinical" & as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_398645039, units="days"), digits=0)) > 7  & 
                           (is.na(d_173836415_d_266600170_d_341570479) & is.na(d_173836415_d_266600170_d_543608829))) %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_341570479, d_173836415_d_266600170_d_543608829) %>%  sort_by(Site)


colnames(blood_locPL) <- c("Site", "Connect ID", "BioClin_SntBloodAccIDBL", "BioClin_PolyBloodIDBL")
knitr::kable(blood_locPL)

```



###	51. If BioFin_BaseUrineCol_v1r0 was collected, BioSpm_UrineSettingBL_v1r0 is clincial, and BioClin_DBUrineRRLDtBL_v1r0 occurred more than seven days ago, BioClin_SiteUrLocatBL_v1r0 must be populated.

```{r BioClin_SiteUrLocatBL_v1r0, echo=FALSE, warning=FALSE, message=FALSE}


urine_loc <- bioqc %>%  filter(d_167958071=="Yes" & d_173836415_d_266600170_d_718172863=="Clinical" & as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_541311218, units="days"), digits=0)) > 7  & 
                           is.na(d_173836415_d_266600170_d_452847912)) %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_541311218, d_173836415_d_266600170_d_452847912) %>%  sort_by(Site)


colnames(urine_loc) <- c("Site", "Connect ID", "BioClin_DBUrineRRLBL_v1r0", "BioClin_SiteUrLocatBL_v1r0")
knitr::kable(urine_loc)

```


###	52. If BioFin_BaseUrineCol_v1r0 was collected, BioSpm_UrineSettingBL_v1r0 is clincial, and BioClin_DBUrineRRLDtBL_v1r0 occurred more than seven days ago, BioClin_SntUrineAccIDBL_v1r0 or BioClin_PolyUrineIDBL_v1r0 must be populated.
```{r New_PolyUrine_Check, echo=FALSE, warning=FALSE, message=FALSE}


urine_locPL <- bioqc %>%  filter(d_167958071=="Yes" & d_173836415_d_266600170_d_718172863=="Clinical" & as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_541311218, units="days"), digits=0)) > 7  & 
                           (is.na(d_173836415_d_266600170_d_198261154) & is.na(d_173836415_d_266600170_d_110349197))) %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_198261154, d_173836415_d_266600170_d_110349197) %>%  sort_by(Site)


colnames(urine_locPL) <- c("Site", "Connect ID", "BioClin_SntUrineAccIDBL", "BioClin_PolyUrineIDBL")
knitr::kable(urine_locPL)

```


### 53. Connect ID and token in Participants Table must match Connect ID and token in Biospecimens table
```{r tokens_match, echo=FALSE, warning=FALSE, message=FALSE}

tokens <- "SELECT 
CASE 
  WHEN b.d_827220437 = '472940358' THEN 'Baylor Scott and White Health'
  WHEN b.d_827220437 = '531629870' THEN 'HealthPartners'
  WHEN b.d_827220437 = '548392715' THEN 'Henry Ford Health System'
  WHEN b.d_827220437 = '303349821' THEN 'Marshfield Clinical Health System'
  WHEN b.d_827220437 = '657167265' THEN 'Sanford Health'
  WHEN b.d_827220437 = '809703864' THEN 'University of Chicago Medicine'
  WHEN b.d_827220437 = '125001209' THEN 'Kaiser Permanente Colorado'
  WHEN b.d_827220437 = '327912200' THEN 'Kaiser Permanente Georgia'
  WHEN b.d_827220437 = '300267574' THEN 'Kaiser Permanente Hawaii'
  WHEN b.d_827220437 = '452412599' THEN 'Kaiser Permanente Northwest'
END AS Site,
b.Connect_ID, d_820476880, 
b.token as bio_token, 
p.token as parts_token
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.biospecimen` b
left join `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants` p
on b.Connect_ID=p.Connect_ID
where b.token!=p.token
group by Site, b.Connect_ID, d_820476880, b.token, p.token
order by b.Connect_ID asc"

token_table <- bq_project_query(project, tokens)
token_match <- bq_table_download(token_table, bigint = "integer64")

colnames(token_match) <- c("Site", "Connect ID", "Collection ID", "Bio Table Token", "Parts. Table Token")
knitr::kable(token_match)

```


```{r AddRules, include=FALSE}

#Add to Jake's rule list

#STRECK Tube 1_ID  // d_505347689_d_825582494 // crossValid1 equal to or less than char() // 14 // d_505347689_d_593843561 //	353358909

# STRECK Tube 1- Tube Collected	    d_505347689_d_593843561	valid	353358909, 104430631		
# STRECK Tube 1- Deviation	          d_505347689_d_678857215	NA or crossValid1	353358909, 104430631		
# STRECK Tube 1- Discard Flag	      d_505347689_d_762124027	NA or crossValid1	353358909, 104430631	d_505347689_d_248868659_d_472864016	353358909
# STRECK Tube 1- Deviation Hemolyzed	d_505347689_d_248868659_d_242307474	NA or crossValid1	353358909, 104430631	d_505347689_d_678857215	353358909
# STRECK Tube 1- Deviation Mislabeled Resolved	d_505347689_d_248868659_d_283900611	NA or crossValid1	353358909, 104430631	d_505347689_d_678857215	353358909
# STRECK Tube 1- Deviation Outside Contaminated	d_505347689_d_248868659_d_313097539	NA or crossValid1	353358909, 104430631	d_505347689_d_678857215	353358909
# STRECK Tube 1- Deviation Other	d_505347689_d_248868659_d_453343022	NA or crossValid1	353358909, 104430631	d_505347689_d_678857215	353358909
# STRECK Tube 1- Deviation Broken	d_505347689_d_248868659_d_472864016	NA or crossValid1	353358909, 104430631	d_505347689_d_678857215	353358909
# STRECK Tube 1- Deviation Temperature Too Low	d_505347689_d_248868659_d_550088682	NA or crossValid1	353358909, 104430631	d_505347689_d_678857215	353358909
# STRECK Tube 1- Deviation Mislabeled Discard	d_505347689_d_248868659_d_684617815	NA or crossValid1	353358909, 104430631	d_505347689_d_678857215	353358909
# STRECK Tube 1- Deviation Temperature Too High	d_505347689_d_248868659_d_690540566	NA or crossValid1	353358909, 104430631	d_505347689_d_678857215	353358909
# STRECK Tube 1- Deviation Low Volume-(tube/container partially filled but still usable)	d_505347689_d_248868659_d_728366619	NA or crossValid1	353358909, 104430631	d_505347689_d_678857215	353358909
# STRECK Tube 1- Deviation Leaked/Spilled	d_505347689_d_248868659_d_757246707	NA or crossValid1	353358909, 104430631	d_505347689_d_678857215	353358909
# STRECK Tube 1- Deviation Tube Size	d_505347689_d_248868659_d_777486216	NA or crossValid1	353358909, 104430631	d_505347689_d_678857215	353358909
# STRECK Tube 1- Deviation Discard	d_505347689_d_248868659_d_810960823	NA or crossValid1	353358909, 104430631	d_505347689_d_678857215	353358909
# STRECK Tube 1- Deviation Not Found	d_505347689_d_248868659_d_982885431	NA or crossValid1	353358909, 104430631	d_505347689_d_678857215	353358909


#STRECK Tube 1 Collected BS	d_878865966	crossValid2	353358909	d_505347689_d_593843561	353358909	d_331584571	266600170							If the visit type is Baseline and any blood tube is collected, then the baseline blood is maked as collected																																																			

#STEK Tube HF Collected DB	d_173836415_d_266600170_d_534041351	crossValid3	353358909	d_505347689_d_593843561	353358909	d_650516960	664882224	d_505347689_d_762124027	104430631	 d_827220437 548392715					If any indiviudal blood tubes collected=yes than BioClin_DBBloodRRL_v1r0 needs to be yes



#EVENTUALLY: STEK Tube Sanford Collected DB	d_173836415_d_266600170_d_534041351	crossValid3	353358909	d_505347689_d_593843561	353358909	d_650516960	664882224	d_505347689_d_762124027	104430631	 d_827220437 657167265					If any indiviudal blood tubes collected=yes than BioClin_DBBloodRRL_v1r0 needs to be yes

#EVENTUALLY: STEK Tube HP Collected DB	d_173836415_d_266600170_d_534041351	crossValid3	353358909	d_505347689_d_593843561	353358909	d_650516960	664882224	d_505347689_d_762124027	104430631	 d_827220437 531629870					If any indiviudal blood tubes collected=yes than BioClin_DBBloodRRL_v1r0 needs to be yes


#EVENTUALLY: ACD Tube Sanford Collected DB	d_173836415_d_266600170_d_534041351	crossValid3	353358909	d_652357376_d_593843561	353358909	d_650516960	664882224	d_652357376_d_762124027	104430631		 d_827220437 657167265				If any indiviudal blood tubes collected=yes than BioClin_DBBloodRRL_v1r0 needs to be yes
#EVENTUALLY: ACD Tube HP Collected DB	d_173836415_d_266600170_d_534041351	crossValid3	353358909	d_652357376_d_593843561	353358909	d_650516960	664882224	d_652357376_d_762124027	104430631		 d_827220437 531629870				If any indiviudal blood tubes collected=yes than BioClin_DBBloodRRL_v1r0 needs to be yes




```





