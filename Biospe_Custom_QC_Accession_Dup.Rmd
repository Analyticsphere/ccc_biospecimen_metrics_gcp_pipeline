---
title: "Biospecimen QC Metric"
author: "Kelsey Dowling"
date: "`r Sys.Date()`"
header-includes:  
    \usepackage{placeins}


output:
  pdf_document:
    extra_dependencies: ["float"]
    toc: false
    keep_tex: yes
    fig_width: 7
    fig_height: 5
    fig_caption: true
    latex_engine: xelatex
    df_print: paged 
---



```{r library, include=FALSE}


library(bigrquery)
library(lubridate)
library(dplyr)
library(stringr)
library(gt)
library(expss)
library(knitr)
library(kableExtra)
library(glue)
bq_auth()
2

### Set Box folders for output CSV files #######################################
use_test_box_folder <- FALSE # Local user sets this (Jake or Kelsey)

# TODO: Fix conditional box folder configuration.

# Over-ride if using plumber api on GCP (USER DOESN'T TOUCH THIS!)
# Check if the environment variable exists and is not empty
#if (!is.null(Sys.getenv("USE_TEST_BOX_FOLDER")) &&
#    Sys.getenv("USE_TEST_BOX_FOLDER") != "") {
#  use_test_box_folder <- as.logical(Sys.getenv("USE_TEST_BOX_FOLDER"))
#}

if (use_test_box_folder) {
  boxfolder <- 222593912729 # test box folder
} else {
  boxfolder <- 221297686961 # destination of CSV files (not pdf)
}
################################################################################



project <- "nih-nci-dceg-connect-prod-6d04"

# bio <- "SELECT  Connect_ID, d_232343615_d_593843561, d_143615646_d_593843561, d_223999569_d_593843561,  d_299553921_d_593843561, d_376960806_d_593843561, d_454453939_d_593843561, d_589588440_d_593843561, d_652357376_d_593843561, d_677469051_d_593843561, d_683613884_d_593843561, d_703954371_d_593843561, d_787237543_d_593843561, d_838567176_d_593843561, d_958646668_d_593843561, d_973670172_d_593843561, d_650516960, d_678166505,  d_143615646_d_926457119, d_232343615_d_926457119, d_299553921_d_926457119, d_376960806_d_926457119, d_454453939_d_926457119, d_589588440_d_926457119, d_652357376_d_926457119, d_677469051_d_926457119, d_683613884_d_926457119, d_703954371_d_926457119, d_838567176_d_926457119, d_958646668_d_926457119, d_973670172_d_926457119, d_143615646_d_883732523, d_299553921_d_883732523, d_454453939_d_883732523, d_652357376_d_883732523, d_703954371_d_883732523, d_838567176_d_883732523, d_973670172_d_883732523, d_143615646_d_593843561, d_223999569_d_593843561, d_299553921_d_593843561, d_376960806_d_593843561, d_454453939_d_593843561, d_589588440_d_593843561, d_652357376_d_593843561, d_677469051_d_593843561, d_683613884_d_593843561, d_703954371_d_593843561, d_787237543_d_593843561, d_838567176_d_593843561, d_958646668_d_593843561, d_973670172_d_593843561, d_915838974, d_646899796, 
# d_928693120_integer FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.biospecimen_JP`  where Connect_ID IS NOT NULL"


bio <- "WITH T AS (
  SELECT Connect_ID FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.biospecimen_JP`
  GROUP BY Connect_ID
  HAVING COUNT(Connect_ID) =1) 
SELECT * FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.biospecimen_JP`
INNER JOIN T ON `nih-nci-dceg-connect-prod-6d04.FlatConnect.biospecimen_JP`.Connect_ID = T.Connect_ID ;"



parts <- "SELECT Connect_ID, d_173836415_d_266600170_d_139245758, d_173836415_d_266600170_d_156605577, d_173836415_d_266600170_d_184451682, d_173836415_d_266600170_d_185243482, d_173836415_d_266600170_d_198261154, d_173836415_d_266600170_d_210921343, d_173836415_d_266600170_d_224596428, d_173836415_d_266600170_d_316824786, d_173836415_d_266600170_d_341570479, d_173836415_d_266600170_d_398645039, d_173836415_d_266600170_d_448660695, d_173836415_d_266600170_d_452847912, d_173836415_d_266600170_d_453452655, d_173836415_d_266600170_d_530173840, d_173836415_d_266600170_d_534041351, d_173836415_d_266600170_d_541311218, d_173836415_d_266600170_d_561681068, d_173836415_d_266600170_d_592099155, d_173836415_d_266600170_d_693370086, d_173836415_d_266600170_d_718172863, d_173836415_d_266600170_d_728696253, d_173836415_d_266600170_d_740582332, d_173836415_d_266600170_d_769615780, d_173836415_d_266600170_d_786930107, d_173836415_d_266600170_d_822274939, d_173836415_d_266600170_d_847159717, d_173836415_d_266600170_d_860477844, d_173836415_d_266600170_d_880794013, d_173836415_d_266600170_d_915179629, d_173836415_d_266600170_d_939818935, d_173836415_d_266600170_d_982213346, d_684635302, d_254109640, d_878865966, d_167958071, d_827220437, d_173836415_d_266600170_d_543608829, d_173836415_d_266600170_d_110349197
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` where Connect_ID IS NOT NULL and d_831041022='104430631'"

parts_table <- bq_project_query(project, parts)

parts_data <- bq_table_download(parts_table, bigint = "integer64", n_max = Inf, page_size = 1000)

bio_table <- bq_project_query(project, bio)
bio_data <- bq_table_download(bio_table, bigint = "integer64", n_max = Inf, page_size = 1000)


bio_data$Connect_ID <- as.numeric(bio_data$Connect_ID)
parts_data$Connect_ID <- as.numeric(parts_data$Connect_ID)



#bioqc_join= left_join(parts_data, bio_data, by="Connect_ID") 

bioqc= left_join(bio_data, parts_data, by=c("Connect_ID", "d_827220437") )

knitr::opts_chunk$set(comment = NA)





bioqc <- bioqc %>%  mutate(Site=case_when(d_827220437==531629870 ~ "HealthPartners",
                                                 d_827220437==548392715 ~ "Henry Ford Health System",
                                                 d_827220437==303349821 ~ "Marshfield Clinical Health System",
                                                 d_827220437==657167265 ~ "Sanford Health",
                                                 d_827220437==809703864 ~ "University of Chicago Medicine",
                                                d_827220437==125001209 ~ "Kaiser Permanente Colorado",
                                                 d_827220437==327912200 ~ "Kaiser Permanente Georgia",
                                                 d_827220437==300267574 ~ "Kaiser Permanente Hawaii",
                                                 d_827220437==452412599 ~ "Kaiser Permanente Northwest"))











##### Making sure personal C drives aren't referenced if this code is being used by others


#Change to FALSE if referencing this code for Box outputs

write_to_local_drive = F #F



### This function below determines whether the file will be created locally or not.
local_drive= ifelse(write_to_local_drive, "~/Biospecimen/data/", "")







```

\newpage


```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
# Accession ID Comparison: KP vs Biospecimen Dashboard
## Blood

#### IN A SEPARATE REPORT


### HAWAII ONLY: They're sending one extra number

qc1 <- bioqc %>%  filter(d_827220437==300267574)

#Blood
qc1_blood <- qc1 %>%  filter(str_sub(d_173836415_d_266600170_d_341570479,1,11)!=str_sub(d_646899796_integer,1,11)) 

qc1_blood <- qc1_blood %>% select(Site, Connect_ID, d_173836415_d_266600170_d_341570479, d_646899796_integer ) %>%  sort_by(Site)


# qc1_blood %>%  gt() %>%  
#   tab_header(title = md("KPHI Blood Accession ID Errors")) %>% 
#   cols_label(Connect_ID = md("**Connect ID**"), d_173836415_d_266600170_d_341570479 = md("**KPHI Accession ID**"), d_646899796= md("**Expected Accession ID**"))

colnames(qc1_blood) <- c("Site", "Connect ID", "KP Accession ID" , "Expected Accession ID")
#knitr::kable(qc1_blood)



#### IN A SEPARATE REPORT





#Urine
qc1_urine <- qc1 %>%  filter(str_sub(qc1$d_173836415_d_266600170_d_198261154,1,11)!=str_sub(qc1$d_928693120_integer,1,11)) 

qc1_urine$AID<- strtoi(qc1_urine$d_928693120_integer, base = 0L)

qc1_urine <- qc1_urine %>% select(Site, Connect_ID, d_173836415_d_266600170_d_198261154, d_928693120_integer ) %>%  sort_by(Site)

# qc1_urine %>%  gt() %>%  
#   tab_header(title = md("KPHI Urine Accession ID Errors")) %>% 
#   cols_label(Connect_ID = md("**Connect ID**"), d_173836415_d_266600170_d_198261154 = md("**KPHI Accession ID**"), d_928693120_integer= md("**Expected Accession ID**"))

colnames(qc1_urine) <- c("Site", "Connect ID", "KP Accession ID" , "Expected Accession ID")
#knitr::kable(qc1_urine)

```


 

```{r ignore, echo=FALSE, warning=FALSE, message=FALSE}

# KP Accession IDs: Accession ID sent by sites not equal to accession ID entered in dashboard, for all other KP Sites

#### IN A SEPARATE REPORT



#### ALL OTHER KPS: They're sending the worng number entirely




#Blood

qcKP <- bioqc %>%  filter(d_827220437==125001209 | d_827220437==327912200 | d_827220437== 452412599) 

qcKP_blood <- qcKP %>%  filter(d_173836415_d_266600170_d_341570479!=d_646899796_integer)  %>% select(Site, Connect_ID, d_173836415_d_266600170_d_341570479, d_646899796_integer ) %>%  sort_by(Site)

colnames(qcKP_blood) <- c("Site", "Connect ID", "KP Accession ID" , "Expected Accession ID")

#knitr::kable(qcKP_blood)




#Urine

qcKP_urine <- qcKP %>%  filter(d_173836415_d_266600170_d_198261154!=d_928693120_integer) %>% select(Site, Connect_ID, d_173836415_d_266600170_d_198261154, d_928693120_integer ) %>%  sort_by(Site)

colnames(qcKP_urine) <- c("Site", "Connect ID", "KP Accession ID" , "Expected Accession ID")

#knitr::kable(qcKP_urine)



```





### (Derived) Clinical DB Blood RRL Received (BioClin_DBBloodRRL_v1r0): If all blood tubes are not collected, this should be no
```{r BioClin_DBBloodRRL_v1r0, echo=FALSE, warning=FALSE, message=FALSE}

qc2 <- bioqc %>%  filter( d_232343615_d_593843561==104430631 & d_299553921_d_593843561==104430631 & d_376960806_d_593843561==104430631 & d_454453939_d_593843561==104430631 & d_589588440_d_593843561==104430631 & d_958646668_d_593843561==104430631 & d_677469051_d_593843561==104430631 & d_683613884_d_593843561==104430631 & d_703954371_d_593843561==104430631 & d_838567176_d_593843561==104430631 & d_173836415_d_266600170_d_534041351!=104430631) 
#qc2 <- qc2  %>% select(Site, Connect_ID, d_173836415_d_266600170_d_534041351)  %>%  group_by(Site)
qc2 <- qc2  %>% select(Site, Connect_ID, d_173836415_d_266600170_d_534041351)  %>%  sort_by(Site)


colnames(qc2) <- c("Site", "Connect ID", "Value")
knitr::kable(qc2)
```



### If all blood tubes are not collected, (Derived) Clinical Site Blood Collected (BioClin_SiteBloodColl_v1r0) should be no or NULL.
```{r Clin_SiteBloodColl, echo=FALSE, warning=FALSE, message=FALSE}

qc2_1 <- bioqc %>%  filter( d_232343615_d_593843561==104430631 & d_299553921_d_593843561==104430631 & d_376960806_d_593843561==104430631 & d_454453939_d_593843561==104430631 & d_589588440_d_593843561==104430631 & d_958646668_d_593843561==104430631 & d_677469051_d_593843561==104430631 & d_683613884_d_593843561==104430631 & d_703954371_d_593843561==104430631 & d_838567176_d_593843561==104430631 & !is.na(d_173836415_d_266600170_d_693370086)) 
qc2_1 <- qc2_1  %>% select(Site, Connect_ID, d_173836415_d_266600170_d_534041351)  %>%  sort_by(Site)

# qc2_1 %>%  gt() %>%  
#   tab_header(title = md("Dervied Clinical DB Blood RRL Received (Supposed to be No")) %>% 
#   cols_label(Connect_ID = md("**Connect ID**"), d_173836415_d_266600170_d_534041351 = md("**Value**"))

colnames(qc2_1) <- c("Site", "Connect ID", "Value")
knitr::kable(qc2_1)


```



### (Derived) Baseline blood sample collected (BioFin_BaseBloodCol_v1r0): If all blood tubes are not collected, this should be no
```{r BioFin_BaseBloodCol_v1r0, echo=FALSE, warning=FALSE, message=FALSE}

qc2_2 <- bioqc %>%  filter( d_232343615_d_593843561==104430631 & d_299553921_d_593843561==104430631 & d_376960806_d_593843561==104430631 & d_454453939_d_593843561==104430631 & d_589588440_d_593843561==104430631 & d_958646668_d_593843561==104430631 & d_677469051_d_593843561==104430631 & d_683613884_d_593843561==104430631 & d_703954371_d_593843561==104430631 & d_838567176_d_593843561==104430631 & d_878865966!=104430631 & 
                              Connect_ID!=2310991421) #HP sent clinical sample when it should've only been research- needs to be manually removed
qc2_2 <- qc2_2  %>% select(Site, Connect_ID, d_173836415_d_266600170_d_534041351)  %>%  sort_by(Site)

# qc2_2 %>%  gt() %>%  
#   tab_header(title = md("Dervied Clinical DB Blood RRL Received (Supposed to be No")) %>% 
#   cols_label(Connect_ID = md("**Connect ID**"), d_173836415_d_266600170_d_534041351 = md("**Value**"))

colnames(qc2_2) <- c("Site", "Connect ID", "Value")
knitr::kable(qc2_2)

```




### If BioClin_BldOrderPlacdDt_v1r0 occured before BioClin_UrnOrderPlacdDt_v1r0, then BioClin_BldUrnPlacedTm_v1r0 should = BioClin_BldOrderPlacdDt_v1r0
```{r BioClin_BldUrnPlacedTm_1, echo=FALSE, warning=FALSE, message=FALSE}

qc3_1 <- bioqc %>%  filter(as.POSIXct(ymd_hms(d_173836415_d_266600170_d_769615780)) < as.POSIXct(ymd_hms(d_173836415_d_266600170_d_939818935)) & as.POSIXct(ymd_hms(d_173836415_d_266600170_d_184451682))!=as.POSIXct(ymd_hms(d_173836415_d_266600170_d_769615780))) %>%  select(Site, Connect_ID, d_173836415_d_266600170_d_184451682) %>%  sort_by(Site)


# qc3_1 %>%  gt() %>%  
#   tab_header(title = md("Date/Time first baseline blood order placed")) %>% 
#   cols_label(Connect_ID = md("**Connect ID**"), d_173836415_d_266600170_d_184451682 = md("**Value**"))

colnames(qc3_1) <- c("Site", "Connect ID", "Value")
knitr::kable(qc3_1)
```


### If BioClin_BldOrderPlacdDt_v1r0 occured after BioClin_UrnOrderPlacdDt_v1r0, then BioClin_BldUrnPlacedTm_v1r0 should = BioClin_UrnOrderPlacdDt_v1r0
```{r BioClin_BldUrnPlacedTm_2, echo=FALSE, warning=FALSE, message=FALSE}
qc3_2 <- bioqc %>%  filter(as.POSIXct(ymd_hms(d_173836415_d_266600170_d_769615780)) > as.POSIXct(ymd_hms(d_173836415_d_266600170_d_939818935)) & as.POSIXct(ymd_hms(d_173836415_d_266600170_d_184451682))!=as.POSIXct(ymd_hms(d_173836415_d_266600170_d_939818935))) %>% select(Site, Connect_ID, d_173836415_d_266600170_d_184451682) %>%  sort_by(Site)


# qc3_2 %>%  gt() %>%  
#   tab_header(title = md("Date/Time first baseline urine order placed")) %>% 
#   cols_label(Connect_ID = md("**Connect ID**"), d_173836415_d_266600170_d_184451682 = md("**Value**"))

colnames(qc3_2) <- c("Site", "Connect ID", "Value")
knitr::kable(qc3_2)

```



###	If the Urine Tube was collected and BioClin_DBUrineRRLDt_v1r0 occurred more than seven days ago, BioClin_SiteUrineColl_v1r0 must be yes
```{r BioClin_SiteUrineColl_v1r0, echo=FALSE, warning=FALSE, message=FALSE}

currentDate <- Sys.Date()

qc4 <- bioqc %>%  filter(d_973670172_d_593843561==353358909 & as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_541311218, units="days"), digits=0)) > 7  & is.na(d_173836415_d_266600170_d_786930107)) %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_786930107) %>%  sort_by(Site)

# qc4 %>%  gt() %>%  
#   tab_header(title = md("Site Clinical Urine Collected (Supposed to be Yes")) %>% 
#   cols_label(Connect_ID = md("**Connect ID**"), d_173836415_d_266600170_d_786930107 = md("**Value**"))

colnames(qc4) <- c("Site", "Connect ID", "Value")
knitr::kable(qc4)

```


### If(Site Serum Separator Tube Number) has been collected, the collection site is clinical, and BioClin_DBBloodRRLDt_v1r0 occured more than 7 days ago, then BioClin_SiteBloodColl_v1r0 should be yes
```{r Clin_SiteBloodColl_v1r0, echo=FALSE, warning=FALSE, message=FALSE}

qc5_tube4 <- bioqc %>%  filter( d_232343615_d_593843561==353358909 & d_650516960==664882224 & as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_398645039, units="days"), digits=0)) > 7  & d_173836415_d_266600170_d_693370086 !=353358909) %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_693370086) %>%  sort_by(Site)

# qc5_tube4 %>%  gt() %>%  
#   tab_header(title = md("Site Serum Separator Tube 4 Collected (Supposed to be Yes)")) %>% 
#   cols_label(Connect_ID = md("**Connect ID**"), d_173836415_d_266600170_d_693370086 = md("**Value**"))

colnames(qc5_tube4) <- c("Site", "Connect ID", "Site Serum Separator Tube 4 Collected (Supposed to be Yes)")
knitr::kable(qc5_tube4)





qc5_tube1 <- bioqc %>%  filter( d_299553921_d_593843561==353358909 & d_650516960==664882224 & as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_398645039, units="days"), digits=0)) > 7  & d_173836415_d_266600170_d_693370086 !=353358909) %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_693370086) %>%  sort_by(Site)

# qc5_tube1 %>%  gt() %>%  
#   tab_header(title = md("Site Serum Separator Tube 1 Collected (Supposed to be Yes)")) %>% 
#   cols_label(Connect_ID = md("**Connect ID**"), d_173836415_d_266600170_d_693370086 = md("**Value**"))

colnames(qc5_tube1) <- c("Site", "Connect ID", "Site Serum Separator Tube 1 Collected (Supposed to be Yes)")
knitr::kable(qc5_tube1)




qc5_tube3 <- bioqc %>%  filter( d_376960806_d_593843561==353358909 & d_650516960==664882224 & as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_398645039, units="days"), digits=0)) > 7  & d_173836415_d_266600170_d_693370086 !=353358909) %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_693370086) %>%  sort_by(Site)

# qc5_tube3 %>%  gt() %>%  
#   tab_header(title = md("Site Serum Separator Tube 3 Collected (Supposed to be Yes)")) %>% 
#   cols_label(Connect_ID = md("**Connect ID**"), d_173836415_d_266600170_d_693370086 = md("**Value**"))

colnames(qc5_tube3) <- c("Site", "Connect ID", "Site Serum Separator Tube 3 Collected (Supposed to be Yes)")
knitr::kable(qc5_tube3)




qc5_tube5 <- bioqc %>%  filter( d_589588440_d_593843561==353358909 & d_650516960==664882224 & as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_398645039, units="days"), digits=0)) > 7  & d_173836415_d_266600170_d_693370086 !=353358909) %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_693370086) %>%  sort_by(Site)

# qc5_tube5 %>%  gt() %>%  
#   tab_header(title = md("Site Serum Separator Tube 5 Collected (Supposed to be Yes)")) %>% 
#   cols_label(Connect_ID = md("**Connect ID**"), d_173836415_d_266600170_d_693370086 = md("**Value**"))

colnames(qc5_tube5) <- c("Site", "Connect ID", "Site Serum Separator Tube 5 Collected (Supposed to be Yes)")
knitr::kable(qc5_tube5)




qc5_tube2 <- bioqc %>%  filter( d_703954371_d_593843561==353358909 & d_650516960==664882224 & as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_398645039, units="days"), digits=0)) > 7  & d_173836415_d_266600170_d_693370086 !=353358909) %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_693370086) %>%  sort_by(Site)

# qc5_tube2 %>%  gt() %>%  
#   tab_header(title = md("Site Serum Separator Tube 2 Collected (Supposed to be Yes)")) %>% 
#   cols_label(Connect_ID = md("**Connect ID**"), d_173836415_d_266600170_d_693370086 = md("**Value**"))

colnames(qc5_tube2) <- c("Site", "Connect ID", "Site Serum Separator Tube 2 Collected (Supposed to be Yes)")
knitr::kable(qc5_tube2)


```



### If(EDTA Tube Number) has been collected, the collection site is clinical, and BioClin_DBBloodRRLDt_v1r0 occured more than 7 days ago, then BioClin_SiteBloodColl_v1r0 should be yes
```{r BioClin_SiteBloodColl_v1r0, echo=FALSE, warning=FALSE, message=FALSE}

qc6_tube1 <- bioqc %>%  filter( d_454453939_d_593843561==353358909 & d_650516960==664882224 & as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_398645039, units="days"), digits=0)) > 7  & d_173836415_d_266600170_d_693370086 !=353358909) %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_693370086) %>%  sort_by(Site)

# qc6_tube1 %>%  gt() %>%  
#   tab_header(title = md("Site EDTA Tube 1 Collected (Supposed to be Yes)")) %>% 
#   cols_label(Connect_ID = md("**Connect ID**"), d_173836415_d_266600170_d_693370086 = md("**Value**"))

colnames(qc6_tube1) <- c("Site", "Connect ID", "Site EDTA Tube 1 Collected (Supposed to be Yes)")
knitr::kable(qc6_tube1)




qc6_tube2 <- bioqc %>%  filter( d_677469051_d_593843561==353358909 & d_650516960==664882224 & as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_398645039, units="days"), digits=0)) > 7  & d_173836415_d_266600170_d_693370086 !=353358909) %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_693370086) %>%  sort_by(Site)

# qc6_tube2 %>%  gt() %>%  
#   tab_header(title = md("Site EDTA Tube 2 Collected (Supposed to be Yes)")) %>% 
#   cols_label(Connect_ID = md("**Connect ID**"), d_173836415_d_266600170_d_693370086 = md("**Value**"))

colnames(qc6_tube2) <- c("Site", "Connect ID", "Site EDTA Tube 2 Collected (Supposed to be Yes)")
knitr::kable(qc6_tube2)




qc6_tube3 <- bioqc %>%  filter( d_683613884_d_593843561==353358909 & d_650516960==664882224 & as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_398645039, units="days"), digits=0)) > 7  & d_173836415_d_266600170_d_693370086 !=353358909) %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_693370086) %>%  sort_by(Site)

# qc6_tube3 %>%  gt() %>%  
#   tab_header(title = md("Site EDTA Tube 3 Collected (Supposed to be Yes)")) %>% 
#   cols_label(Connect_ID = md("**Connect ID**"), d_173836415_d_266600170_d_693370086 = md("**Value**"))

colnames(qc6_tube3) <- c("Site", "Connect ID", "Site EDTA Tube 3 Collected (Supposed to be Yes)")
knitr::kable(qc6_tube3)



```


###  If Heparin Tube 1 was collected, site was Clinical, and BioClin_DBBloodRRLDt_v1r0 occurred more than 7 days ago, BioClin_SiteBloodColl_v1r0 must be yes

```{r Herapin1, echo=FALSE, warning=FALSE, message=FALSE}

qc7_tube1 <- bioqc %>%  filter( d_838567176_d_593843561==353358909 & d_650516960==664882224 & as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_398645039, units="days"), digits=0)) > 7  & is.na(d_173836415_d_266600170_d_693370086)) %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_693370086) %>%  sort_by(Site)

# qc7_tube1 %>%  gt() %>%  
#   tab_header(title = md("Site Heparin Tube 1 Collected (Supposed to be Yes")) %>% 
#   cols_label(Connect_ID = md("**Connect ID**"), d_173836415_d_266600170_d_693370086 = md("**Value**"))

colnames(qc7_tube1) <- c("Site", "Connect ID", "Site Heparin Tube 1 Collected (Supposed to be Yes)")
knitr::kable(qc7_tube1)
```

### If Heparin Tube 2 was collected, site was Clinical, and BioClin_DBBloodRRLDt_v1r0 occurred more than 7 days ago, BioClin_SiteBloodColl_v1r0 must be yes
```{r Herapin2, echo=FALSE, warning=FALSE, message=FALSE}
qc7_tube2 <- bioqc %>%  filter( d_958646668_d_593843561==353358909 & d_650516960==664882224 & as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_398645039, units="days"), digits=0)) > 7  & is.na(d_173836415_d_266600170_d_693370086)) %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_693370086) %>%  sort_by(Site)

# qc7_tube2 %>%  gt() %>%  
#   tab_header(title = md("Site Heparin Tube 2 Collected (Supposed to be Yes")) %>% 
#   cols_label(Connect_ID = md("**Connect ID**"), d_173836415_d_266600170_d_693370086 = md("**Value**"))

colnames(qc7_tube2) <- c("Site", "Connect ID", "Site Heparin Tube 2 Collected (Supposed to be Yes)")
knitr::kable(qc7_tube2)

```



### All baseline samples ("BioFin_BaseBloodCol_v1r0","BioFin_BaseUrineCol_v1r0","BioFin_BaseMWCol_v1r0") are collected, and BioCol_ColTime_v1r0 occured on or after 11/21/2022 then SMMet_BLSamplesColl_v1r0 must be YES
```{r SMMET, echo=FALSE, warning=FALSE, message=FALSE}

qc8 <- bioqc %>%  filter(d_878865966==353358909 & d_167958071==353358909 & d_684635302==353358909 & d_678166505>=as.Date("2022-11-21")  & d_254109640 !=353358909) %>% 
  select(Site, Connect_ID, d_254109640) %>%  sort_by(Site)

# qc8 %>%  gt() %>%  
#   tab_header(title = md("All baseline samples collected (Supposed to be Yes)")) %>% 
#   cols_label(Connect_ID = md("**Connect ID**"), d_254109640 = md("**Value**"))

colnames(qc8) <- c("Site", "Connect ID", "All baseline samples collected (Supposed to be Yes)")
knitr::kable(qc8)

```



### If BioFin_BaseBloodCol_v1r0 is yes and the collection setting is Research, and BioCol_ColTime_v1r0 occured on or after 11/21/2022 then (Autogenerated) Date/time Baseline Research Blood Collected must be populated  
```{r BloodDateTime, echo=FALSE, warning=FALSE, message=FALSE}

qc9B <- bioqc %>%  filter(d_878865966==353358909 & d_650516960==534621077 & d_678166505>=as.Date("2022-11-21") & is.na(d_173836415_d_266600170_d_561681068)) %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_561681068) %>%  sort_by(Site)

# qc9B %>%  gt() %>%  
#   tab_header(title = md("(Autogenerated) Date/time Baseline Research Blood Collected")) %>% 
#   cols_label(Connect_ID = md("**Connect ID**"), d_173836415_d_266600170_d_561681068 = md("**Value**"))

colnames(qc9B) <- c("Site", "Connect ID", "(Autogenerated) Date/time Baseline Research Blood Collected")
knitr::kable(qc9B)
```

### If BioFin_BaseUrineCol_v1r0 is yes and the collection setting is Research, and BioCol_ColTime_v1r0 occured on or after 11/21/2022 then (Autogenerated) Date/time Baseline Research Urine Collected must be populated
```{r UrineDateTime, echo=FALSE, warning=FALSE, message=FALSE}
qc9U <- bioqc %>%  filter(d_167958071==353358909 & d_650516960==534621077  & d_678166505>=as.Date("2022-11-21") & is.na(d_173836415_d_266600170_d_847159717)) %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_847159717) %>%  sort_by(Site)

# qc9U %>%  gt() %>%  
#   tab_header(title = md("(Autogenerated) Date/time Baseline Research Urine Collected")) %>% 
#   cols_label(Connect_ID = md("**Connect ID**"), d_173836415_d_266600170_d_847159717 = md("**Value**"))

colnames(qc9U) <- c("Site", "Connect ID", "(Autogenerated) Date/time Baseline Research Urine Collected")
knitr::kable(qc9U)



```



### If BioFin_BaseBloodCol_v1r0 is yes and the collection setting is Research, BioCol_ColTime_v1r0 must be populated 
```{r BioCol_ColTime_v1r0, echo=FALSE, warning=FALSE, message=FALSE}

qc10 <- bioqc %>%  filter(d_878865966==353358909 & d_650516960==534621077   & is.na(d_678166505)) %>% #& d_678166505>=as.Date("2022-11-21")) %>% 
  select(Site, Connect_ID, d_678166505) %>%  sort_by(Site)

# qc10 %>%  gt() %>%  
#   tab_header(title = md("Collection Date/Time")) %>% 
#   cols_label(Connect_ID = md("**Connect ID**"), d_678166505 = md("**Value**"))

colnames(qc10) <- c("Site", "Connect ID", "Collection Date/Time (Supposed to be populated)")
knitr::kable(qc10)

```



### If BioCol_ObjCollected_v1r0 (mouthwash), and BioCol_ColTime_v1r0 occured on or after 11/21/2022, then  BioFin_BaseMouthCol_v1r0 should be no 
```{r BioFin_BaseMouthCol_v1r0, echo=FALSE, warning=FALSE, message=FALSE}

qc11 <- bioqc %>%  filter(d_143615646_d_593843561==104430631  & d_678166505>=as.Date("2022-11-21") & d_684635302!=104430631) %>% 
  select(Site, Connect_ID, d_684635302) %>%  sort_by(Site)

# qc11 %>%  gt() %>%  
#   tab_header(title = md("Baseline Mouthwash Collected B")) %>% 
#   cols_label(Connect_ID = md("**Connect ID**"), d_684635302 = md("**Value**"))

colnames(qc11) <- c("Site", "Connect ID", "Baseline Mouthwash Collected (Supposed to be no)")
knitr::kable(qc11)

```



### If Urine tube was collected, site was Clinical, and BioReg_ArRegTime_v1r0 occurred more than 7 days ago, BioClin_SiteUrineColl_v1r0 must be yes
```{r BioClin_SiteUrineColl, echo=FALSE, warning=FALSE, message=FALSE}


qc12 <- bioqc %>%  filter(d_973670172_d_593843561==353358909  & d_650516960==664882224 & as.numeric(round(difftime(currentDate, d_915838974, units="days"), digits=0)) >7 & is.na(d_173836415_d_266600170_d_786930107)) %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_786930107) %>%  sort_by(Site)

# qc12 %>%  gt() %>%  
#   tab_header(title = md("Site Clinical_Site Urine Collected (Supposed to be Yes)")) %>% 
#   cols_label(Connect_ID = md("**Connect ID**"), d_173836415_d_266600170_d_786930107 = md("**Value**"))

colnames(qc12) <- c("Site", "Connect ID", "Site Clinical_Site Urine Collected")
knitr::kable(qc12) 


```




```{r HPExcluded1, echo=FALSE, warning=FALSE, message=FALSE}

### IF BioClin_SiteBloodColl_v1r0 = 1, THEN BioClin_BldOrderPlaced_v1r0 = 1. HP Excluded
#11/24 - Domonique requested this removed

BloodOrderPl_noHP <- bioqc %>%  filter(d_173836415_d_266600170_d_530173840!=353358909 & d_173836415_d_266600170_d_693370086==353358909	& 
                                         d_827220437!=531629870) %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_530173840) %>%  sort_by(Site)

colnames(BloodOrderPl_noHP) <- c("Site", "Connect ID", "BioClin_BldOrderPlaced")
#knitr::kable(BloodOrderPl_noHP) 

```



```{r HPExcluded2, echo=FALSE, warning=FALSE, message=FALSE}
### IF BioClin_SiteUrineColl_v1r0 = 1, THEN BioClin_UrnOrdPlacedBL_v1r0 = 1. HP Excluded
##11/24 - Domonique requested this removed


UrineOrderPl_noHP <- bioqc %>%  filter(d_173836415_d_266600170_d_860477844!=353358909 & d_173836415_d_266600170_d_786930107==353358909	& 
                                         d_827220437!=531629870) %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_860477844) %>%  sort_by(Site)

colnames(UrineOrderPl_noHP) <- c("Site", "Connect ID", "BioClin_UrnOrdPlacedBL_v1r0")
#knitr::kable(UrineOrderPl_noHP) 

```


### IF BioClin_BldOrderPlaced_v1r0 = 1, THEN BioClin_BldOrderPlacdDt_v1r0 must be populated. HP Excluded
```{r HPExcluded5, echo=FALSE, warning=FALSE, message=FALSE}

BloodDtTm_noHP <- bioqc %>%  filter(is.na(d_173836415_d_266600170_d_769615780) & d_173836415_d_266600170_d_530173840==353358909	& 
                                         d_827220437!=531629870) %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_769615780) %>%  sort_by(Site)

colnames(BloodDtTm_noHP) <- c("Site", "Connect ID", "BioClin_BldOrderPlacdDt")
knitr::kable(BloodDtTm_noHP) 

```




```{r HPExcluded6, echo=FALSE, warning=FALSE, message=FALSE}

### IF  BioClin_BldOrderPlacdDt_v1r0 is populated, THEN BioClin_BldOrderPlaced_v1r0 = 1. HP Excluded

BloodDtTmVs_noHP <- bioqc %>%  filter(!is.na(d_173836415_d_266600170_d_769615780) & d_173836415_d_266600170_d_530173840!=353358909	& 
                                         d_827220437!=531629870) %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_530173840) %>%  sort_by(Site)

colnames(BloodDtTmVs_noHP) <- c("Site", "Connect ID", "BioClin_BldOrderPlaced")
#knitr::kable(BloodDtTmVs_noHP) -- removed. "Please adjust the blood and urine draw order flag-to-date/time QC rules to run one-way, as it is possible for a draw order date to be populated and the draw order placement flag to be "No". This happens when a site cancels an order; the flag switches from "Yes" to "No", but the original placement date cannot be retracted by the site. " 

```



### IF BioClin_UrnOrdPlaced = 1, THEN BioClin_BldOrderPlacdDt_v1r0 must be populated. HP Excluded
```{r HPExcluded3, echo=FALSE, warning=FALSE, message=FALSE}

UrineDtTm_noHP <- bioqc %>%  filter(is.na(d_173836415_d_266600170_d_939818935) & d_173836415_d_266600170_d_860477844==353358909	& 
                                         d_827220437!=531629870) %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_939818935) %>%  sort_by(Site)

colnames(UrineDtTm_noHP) <- c("Site", "Connect ID", "BioClin_BldOrderPlacdDt")
knitr::kable(UrineDtTm_noHP) 

```




```{r HPExcluded4, echo=FALSE, warning=FALSE, message=FALSE}
### IF  BioClin_BldOrderPlacdDt_v1r0 is populated, THEN BioClin_UrnOrdPlaced must = 1. HP Excluded

UrineDtTmVs_noHP <- bioqc %>%  filter(!is.na(d_173836415_d_266600170_d_939818935) & d_173836415_d_266600170_d_860477844!=353358909	& 
                                         d_827220437!=531629870) %>% 
  select(Site, Connect_ID, d_173836415_d_266600170_d_860477844) %>%  sort_by(Site)

colnames(UrineDtTmVs_noHP) <- c("Site", "Connect ID", "BioClin_UrnOrdPlaced")
#knitr::kable(UrineDtTmVs_noHP)  -- removed. "Please adjust the blood and urine draw order flag-to-date/time QC rules to run one-way, as it is possible for a draw order date to be populated and the draw order placement flag to be "No". This happens when a site cancels an order; the flag switches from "Yes" to "No", but the original placement date cannot be retracted by the site. " 

```






### Tube Date Received Clinical - If BioClin_DBBloodRRLDt_v1r0 occurred more than 4 days ago, (tube type) was collected, and (tube type) was not discarded, then BioBPTL_DateRec_v1r0 for that tube type should be populated 
```{r BioBPTL_DateRecClinical, echo=FALSE, warning=FALSE, message=FALSE}


 ###########chnage to tube collected =yes and BioBPTL_DateRec_v1r0 is na for all & deviation!= discard deviation (one flag triggered)


qc13_tube2 <- bioqc %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_398645039, units="days"), digits=0))>4 & d_299553921_d_593843561==353358909 & d_299553921_d_762124027==104430631 & is.na(d_299553921_d_926457119)) %>% 
  select(Site, Connect_ID, d_299553921_d_926457119) %>%  sort_by(Site)

colnames(qc13_tube2) <- c("Site", "Connect ID", "Serum Separator Tube 1- Date Received")
knitr::kable(qc13_tube2)




qc13_tube3 <- bioqc %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_398645039, units="days"), digits=0))>4 & d_454453939_d_593843561==353358909 & d_454453939_d_762124027==104430631 & is.na(d_454453939_d_926457119)) %>% 
  select(Site, Connect_ID, d_454453939_d_926457119) %>%  sort_by(Site)

colnames(qc13_tube3) <- c("Site", "Connect ID", "EDTA Tube 1- Date Received")
knitr::kable(qc13_tube3)



qc13_tube4 <- bioqc %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_398645039, units="days"), digits=0))>4 & d_652357376_d_593843561==353358909 & d_652357376_d_762124027==104430631 & is.na(d_652357376_d_926457119) & d_827220437==548392715 & d_650516960==664882224) %>% # | d_827220437==657167265 once Sanford is hybrid
  select(Site, Connect_ID, d_652357376_d_926457119) %>%  sort_by(Site)

colnames(qc13_tube4) <- c("Site", "Connect ID", "ACD Tube 1- Date Received")
knitr::kable(qc13_tube4)




qc13_tube5 <- bioqc %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_398645039, units="days"), digits=0))>4 & d_703954371_d_593843561==353358909 & d_703954371_d_762124027==104430631 & is.na(d_703954371_d_926457119)) %>% 
  select(Site, Connect_ID, d_703954371_d_926457119) %>%  sort_by(Site)

colnames(qc13_tube5) <- c("Site", "Connect ID", "Serum Separator Tube 2- Date Received")
knitr::kable(qc13_tube5)




qc13_tube6 <- bioqc %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_398645039, units="days"), digits=0))>4 & d_838567176_d_593843561==353358909 & d_838567176_d_762124027==104430631 &  is.na(d_838567176_d_926457119)) %>% 
  select(Site, Connect_ID, d_838567176_d_926457119) %>%  sort_by(Site)

colnames(qc13_tube6) <- c("Site", "Connect ID", "Heparin Tube 1- Date Received")
knitr::kable(qc13_tube6)



qc13_tube8 <- bioqc %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_398645039, units="days"), digits=0))>4 & d_958646668_d_593843561==353358909 & d_958646668_d_762124027==104430631 &  is.na(d_958646668_d_926457119)) %>% 
  select(Site, Connect_ID, d_958646668_d_926457119) %>%  sort_by(Site)

colnames(qc13_tube8) <- c("Site", "Connect ID", "Heparin Tube 2- Date Received")
knitr::kable(qc13_tube8)




qc13_tube7 <- bioqc %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_541311218, units="days"), digits=0))>4 & d_973670172_d_593843561==353358909 & d_973670172_d_762124027==104430631 & is.na(d_973670172_d_926457119)
                                & Connect_ID!=2215062576) %>% #KPNW exclusion 
  select(Site, Connect_ID, d_973670172_d_926457119) %>%  sort_by(Site)

colnames(qc13_tube7) <- c("Site", "Connect ID", "Urine Tube 1- Date Received")
knitr::kable(qc13_tube7)



# qc13_tube8 <- bioqc %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_541311218, units="days"), digits=0))>4 & d_505347689_d_593843561==353358909 & d_505347689_d_762124027==104430631 & is.na(d_505347689_d_926457119)) %>% 
#   select(Site, Connect_ID, d_505347689_d_926457119) %>%  sort_by(Site)
# 
# 
# colnames(qc13_tube8) <- c("Site", "Connect ID", "STRECK Tube- Date Received")
# knitr::kable(qc13_tube8)




```



### Tube Date Received Research - If (tube type) was collected, and (tube type) was not discarded, then BioBPTL_DateRec_v1r0 for that tube type should be populated 
```{r BioBPTL_DateRecResearch, echo=FALSE, warning=FALSE, message=FALSE}


 ###########chnage to tube collected =yes and BioBPTL_DateRec_v1r0 is na for all & deviation!= discard deviation (one flag triggered)

bioqcR <- bioqc %>%  filter(d_650516960==534621077)


qc13_Rtube1 <- bioqcR %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_448660695, units="days"), digits=0))>4 & d_143615646_d_593843561==353358909 & d_143615646_d_762124027==104430631 & is.na(d_143615646_d_926457119) ) %>% 

  select(Site, Connect_ID, d_143615646_d_926457119)%>%  sort_by(Site)

colnames(qc13_Rtube1) <- c("Site", "Connect ID", "Mouthwash Tube- Date Received")
knitr::kable(qc13_Rtube1)




qc13_Rtube2 <- bioqcR %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_561681068, units="days"), digits=0))>4 & d_299553921_d_593843561==353358909 & d_299553921_d_762124027==104430631 & is.na(d_299553921_d_926457119)) %>% 
  select(Site, Connect_ID, d_299553921_d_926457119) %>%  sort_by(Site)

colnames(qc13_Rtube2) <- c("Site", "Connect ID", "Serum Separator Tube 1- Date Received")
knitr::kable(qc13_Rtube2)




qc13_Rtube3 <- bioqcR %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_561681068, units="days"), digits=0))>4 & d_454453939_d_593843561==353358909 & d_454453939_d_762124027==104430631 & is.na(d_454453939_d_926457119)) %>% 
  select(Site, Connect_ID, d_454453939_d_926457119) %>%  sort_by(Site)

colnames(qc13_Rtube3) <- c("Site", "Connect ID", "EDTA Tube 1- Date Received")
knitr::kable(qc13_Rtube3)




qc13_Rtube4 <- bioqcR %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_561681068, units="days"), digits=0))>4 & d_652357376_d_593843561==353358909 & d_652357376_d_762124027==104430631 & is.na(d_652357376_d_926457119) & #| d_827220437==657167265 once Sanford is hybrid
                                    Connect_ID!=1735874266) %>% # HF exclusion

  select(Site, Connect_ID, d_652357376_d_926457119) %>%  sort_by(Site)

colnames(qc13_Rtube4) <- c("Site", "Connect ID", "ACD Tube 1- Date Received")
knitr::kable(qc13_Rtube4)




qc13_Rtube5 <- bioqcR %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_561681068, units="days"), digits=0))>4 & d_703954371_d_593843561==353358909 & d_703954371_d_762124027==104430631 & is.na(d_703954371_d_926457119)) %>% 
  select(Site, Connect_ID, d_703954371_d_926457119) %>%  sort_by(Site)

colnames(qc13_Rtube5) <- c("Site", "Connect ID", "Serum Separator Tube 2- Date Received")
knitr::kable(qc13_Rtube5)




qc13_Rtube6 <- bioqcR %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_561681068, units="days"), digits=0))>4 & d_838567176_d_593843561==353358909 & d_838567176_d_762124027==104430631 &  is.na(d_838567176_d_926457119)) %>% 
  select(Site, Connect_ID, d_838567176_d_926457119) %>%  sort_by(Site)

colnames(qc13_Rtube6) <- c("Site", "Connect ID", "Heparin Tube 1- Date Received")
knitr::kable(qc13_Rtube6)



qc13_Rtube8 <- bioqcR %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_561681068, units="days"), digits=0))>4 & d_958646668_d_593843561==353358909 & d_958646668_d_762124027==104430631 &  is.na(d_958646668_d_926457119)) %>% 
  select(Site, Connect_ID, d_958646668_d_926457119) %>%  sort_by(Site)

colnames(qc13_Rtube8) <- c("Site", "Connect ID", "Heparin Tube 2- Date Received")
knitr::kable(qc13_Rtube8)





qc13_Rtube7 <- bioqcR %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_561681068, units="days"), digits=0))>4 &  d_973670172_d_593843561==353358909 & d_973670172_d_762124027==104430631 & is.na(d_973670172_d_926457119) & 
                                    Connect_ID!=9145733933 & Connect_ID!=9618974099 & Connect_ID!=8527264977 & Connect_ID!=6473532641 & #HF exclusion 
                                    Connect_ID!=4174960021 & #UC exclusion)
                                     Connect_ID!= 4435276749) %>% #Sanford exclusion

  select(Site, Connect_ID, d_973670172_d_926457119) %>%  sort_by(Site)

colnames(qc13_Rtube7) <- c("Site", "Connect ID", "Urine Tube 1- Date Received")
knitr::kable(qc13_Rtube7)



# qc13_Rtube8 <- bioqcR %>%  filter( d_505347689_d_593843561==353358909 & d_505347689_d_762124027==104430631 & is.na(d_505347689_d_926457119)) %>% 
#   select(Site, Connect_ID, d_505347689_d_926457119) %>%  sort_by(Site)
# 
# 
# colnames(qc13_Rtube8) <- c("Site", "Connect ID", "STRECK Tube- Date Received")
# knitr::kable(qc13_Rtube8)




```








## BioClin_DBBloodID_v1r0 must be in BioClin_PolyBloodID_v1r0
\FloatBarrier

```{r BioClin_PolyBloodID_v1r0, echo=FALSE, warning=FALSE, message=FALSE}

bioqc1 <- bioqc %>%  filter(d_173836415_d_266600170_d_543608829!="[]" & !is.na(d_646899796_integer) &
                        Connect_ID!=2824989966 & Connect_ID!=3759939890 & Connect_ID!=4688823720 & Connect_ID!=8589481620 & Connect_ID!=6336258662) #HFH exclusions

# bioqc1$str1 <- bioqc1$d_173836415_d_266600170_d_543608829
# 
# bioqc1 %>%  group_by(Connect_ID) %>%  mutate(PolyBloodID = unlist(strsplit(gsub("\\[|\\]", "", str1), ",")) )

str1 <- bioqc1$d_173836415_d_266600170_d_543608829
PolyBloodID <- unlist(strsplit(gsub("\\[|\\]", "", str1), ",")) 

 


bioqc1 <- bioqc1 %>%  #filter(d_173836415_d_266600170_d_543608829!="[]" & !is.na(d_646899796_integer)) %>%  
mutate(BioClin_DBBloodID_v1r0=paste0("L", d_646899796_integer))

#polyblood <- bioqc1 %>%  filter(!(BioClin_DBBloodID_v1r0 %in% as.list(d_173836415_d_266600170_d_543608829))) %>%  select(Site, Connect_ID, BioClin_DBBloodID_v1r0, d_173836415_d_266600170_d_543608829) %>%

polyblood <- bioqc1 %>%  filter(!(bioqc1$BioClin_DBBloodID_v1r0 %in% PolyBloodID)) %>%  select(Site, Connect_ID, BioClin_DBBloodID_v1r0, d_173836415_d_266600170_d_543608829) %>% sort_by(Site)
colnames(polyblood) <- c("Site", "Connect ID", "BioClin_DBBloodID_v1r0", "BioClin_PolyBloodID_v1r0")
knitr::kable(polyblood) %>% kable_styling(latex_options = "scale_down")


```


## BioClin_DBUrineID_v1r0 must be in BioClin_PolyUrineID_v1r0
\FloatBarrier

```{r PolyUrineID, echo=FALSE, warning=FALSE, message=FALSE}

bioqc2 <- bioqc %>%  filter(d_173836415_d_266600170_d_110349197!="[]" & !is.na(d_928693120_integer) &

                        Connect_ID!=2824989966 & Connect_ID!=3759939890 & Connect_ID!=4688823720 & Connect_ID!=8589481620 & Connect_ID!=6336258662 &
                          Connect_ID!=6473532641 & Connect_ID!=4435276749 ) #HFH exclusions)


str2 <- bioqc2$d_173836415_d_266600170_d_110349197
PolyUrineID <- unlist(strsplit(gsub("\\[|\\]", "", str2), ",")) 

 

bioqc2 <- bioqc2 %>%  
mutate(BioClin_DBUrineID_v1r0=paste0("L", d_928693120_integer))


polyurine <- bioqc2 %>%  filter(!(bioqc2$BioClin_DBUrineID_v1r0 %in% PolyUrineID)) %>%  select(Site, Connect_ID, BioClin_DBUrineID_v1r0, d_173836415_d_266600170_d_110349197) %>% sort_by(Site)
colnames(polyurine) <- c("Site", "Connect ID", "BioClin_DBUrineID_v1r0", "BioClin_PolyUrineID_v1r0")
knitr::kable(polyurine) %>% kable_styling(latex_options = "scale_down")


```








```{r Reasons, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}


### Reason Tube Not Collected: Will circle back to addressing this?

qc14_tube1 <- bioqc %>%  filter(d_143615646_d_593843561==104430631 & d_650516960== 534621077 & is.na(d_143615646_d_883732523) ) %>% 
  select(Site, Connect_ID, d_143615646_d_883732523) %>%  sort_by(Site)

# qc14_tube1 %>%  gt() %>%  
#   tab_header(title = md("MW Tube 1- Reason Tube Not Collected")) %>% 
#   cols_label(Connect_ID = md("**Connect ID**"), d_143615646_d_883732523 = md("**Value**"))

# colnames(qc14_tube1) <- c("Site", "Connect ID", "MW Tube 1- Reason Tube Not Collected")
#knitr::kable( qc14_tube1)



qc14_tube2 <- bioqc %>%  filter(d_299553921_d_593843561==104430631 & d_650516960== 534621077 & is.na(d_299553921_d_883732523)) %>% 
  select(Site, Connect_ID, d_299553921_d_883732523) %>%  sort_by(Site)

# qc14_tube2 %>%  gt() %>%  
#   tab_header(title = md("Serum Separator Tube 1- Reason Tube Not Collected")) %>% 
#   cols_label(Connect_ID = md("**Connect ID**"), d_299553921_d_883732523 = md("**Value**"))

colnames(qc14_tube2) <- c("Site", "Connect ID", "Serum Separator Tube 1- Reason Tube Not Collected")
#knitr::kable(qc14_tube2)




qc14_tube3 <- bioqc %>%  filter(d_454453939_d_593843561==104430631 & d_650516960== 534621077 & is.na(d_454453939_d_883732523)) %>% 
  select(Site, Connect_ID, d_454453939_d_883732523) %>%  sort_by(Site)

# qc14_tube3 %>%  gt() %>%  
#   tab_header(title = md("EDTA Tube 1- Reason Tube Not Collected")) %>% 
#   cols_label(Connect_ID = md("**Connect ID**"), d_454453939_d_883732523 = md("**Value**"))

colnames(qc14_tube3) <- c("Site", "Connect ID", "EDTA Tube 1- Reason Tube Not Collected")
#knitr::kable(qc14_tube3)




qc14_tube4 <- bioqc %>%  filter(d_652357376_d_593843561==104430631 & d_650516960== 534621077 & is.na(d_652357376_d_883732523)) %>% 
  select(Site, Connect_ID, d_652357376_d_883732523) %>%  sort_by(Site)

# qc14_tube4 %>%  gt() %>%  
#   tab_header(title = md("ACD Tube 1- Reason Tube Not Collected")) %>% 
#   cols_label(Connect_ID = md("**Connect ID**"), d_652357376_d_883732523 = md("**Value**"))

colnames(qc14_tube4) <- c("Site", "Connect ID", "ACD Tube 1- Reason Tube Not Collected")
#knitr::kable(qc14_tube4)



qc14_tube5 <- bioqc %>%  filter(d_703954371_d_593843561==104430631 & d_650516960== 534621077 & is.na(d_703954371_d_883732523)) %>% 
  select(Site, Connect_ID, d_703954371_d_883732523) %>%  sort_by(Site)

# qc14_tube5 %>%  gt() %>%  
#   tab_header(title = md("Serum Separator Tube 2-- Reason Tube Not Collected")) %>% 
#   cols_label(Connect_ID = md("**Connect ID**"), d_703954371_d_883732523 = md("**Value**"))

colnames(qc14_tube5) <- c("Site", "Connect ID", "Serum Separator Tube 2- Reason Tube Not Collected")
#knitr::kable(qc14_tube5)



qc14_tube6 <- bioqc %>%  filter(d_838567176_d_593843561==104430631 & d_650516960== 534621077 & is.na(d_838567176_d_883732523)) %>% 
  select(Site, Connect_ID, d_838567176_d_883732523) %>%  sort_by(Site)

# qc14_tube6 %>%  gt() %>%  
#   tab_header(title = md("Heparin Tube 1- Reason Tube Not Collected")) %>% 
#   cols_label(Connect_ID = md("**Connect ID**"), d_838567176_d_883732523 = md("**Value**"))

colnames(qc14_tube6) <- c("Site", "Connect ID", "Heparin Tube 1- Reason Tube Not Collected")
#knitr::kable(qc14_tube6)



qc14_tube7 <- bioqc %>%  filter(d_973670172_d_593843561==104430631 & d_650516960== 534621077 & is.na(d_973670172_d_883732523)) %>% 
  select(Site, Connect_ID, d_973670172_d_883732523) %>%  sort_by(Site)

# qc14_tube7 %>%  gt() %>%  
#   tab_header(title = md("Urine Tube 1- Reason Tube Not Collected")) %>% 
#   cols_label(Connect_ID = md("**Connect ID**"), d_973670172_d_883732523 = md("**Value**"))

colnames(qc14_tube7) <- c("Site", "Connect ID", "Urine Tube 1- Reason Tube Not Collected")
#knitr::kable(qc14_tube7)

```






























```{r bioqcSetUp, include=FALSE}



bio <- "WITH T AS (
  SELECT Connect_ID FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.biospecimen_JP`
  GROUP BY Connect_ID
  HAVING COUNT(Connect_ID) =1 ) 
SELECT * FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.biospecimen_JP`
INNER JOIN T ON `nih-nci-dceg-connect-prod-6d04.FlatConnect.biospecimen_JP`.Connect_ID = T.Connect_ID ;"



parts <- "SELECT Connect_ID, d_173836415_d_266600170_d_139245758, d_173836415_d_266600170_d_156605577, d_173836415_d_266600170_d_184451682, d_173836415_d_266600170_d_185243482, d_173836415_d_266600170_d_198261154, d_173836415_d_266600170_d_210921343, d_173836415_d_266600170_d_224596428, d_173836415_d_266600170_d_316824786, d_173836415_d_266600170_d_341570479, d_173836415_d_266600170_d_398645039, d_173836415_d_266600170_d_448660695, d_173836415_d_266600170_d_452847912, d_173836415_d_266600170_d_453452655, d_173836415_d_266600170_d_530173840, d_173836415_d_266600170_d_534041351, d_173836415_d_266600170_d_541311218, d_173836415_d_266600170_d_561681068, d_173836415_d_266600170_d_592099155, d_173836415_d_266600170_d_693370086, d_173836415_d_266600170_d_718172863, d_173836415_d_266600170_d_728696253, d_173836415_d_266600170_d_740582332, d_173836415_d_266600170_d_769615780, d_173836415_d_266600170_d_786930107, d_173836415_d_266600170_d_822274939, d_173836415_d_266600170_d_847159717, d_173836415_d_266600170_d_860477844, d_173836415_d_266600170_d_880794013, d_173836415_d_266600170_d_915179629, d_173836415_d_266600170_d_939818935, d_173836415_d_266600170_d_982213346, d_684635302, d_254109640, d_878865966, d_167958071, d_827220437
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` where Connect_ID IS NOT NULL"

parts_table <- bq_project_query(project, parts)

parts_data <- bq_table_download(parts_table, bigint = "integer64", n_max = Inf, page_size = 1000)

bio_table <- bq_project_query(project, bio)
bio_data <- bq_table_download(bio_table, bigint = "integer64", n_max = Inf, page_size = 1000)


bio_data$Connect_ID <- as.numeric(bio_data$Connect_ID)
parts_data$Connect_ID <- as.numeric(parts_data$Connect_ID)



#bioqc_join= left_join(parts_data, bio_data, by="Connect_ID") 

#bioqc <- as_tibble(bioqc_join)

bioqc= left_join(bio_data, parts_data,  by=c("Connect_ID", "d_827220437") )

knitr::opts_chunk$set(comment = NA)





bioqc <- bioqc %>%  mutate(Site=case_when(d_827220437==531629870 ~ "HealthPartners",
                                                 d_827220437==548392715 ~ "Henry Ford Health System",
                                                 d_827220437==303349821 ~ "Marshfield Clinical Health System",
                                                 d_827220437==657167265 ~ "Sanford Health",
                                                 d_827220437==809703864 ~ "University of Chicago Medicine",
                                                d_827220437==125001209 ~ "Kaiser Permanente Colorado",
                                                 d_827220437==327912200 ~ "Kaiser Permanente Georgia",
                                                 d_827220437==300267574 ~ "Kaiser Permanente Hawaii",
                                                 d_827220437==452412599 ~ "Kaiser Permanente Northwest"))

```


```{r CSV1, echo=FALSE, warning=FALSE, message=FALSE}


#### IN A SEPARATE REPORT


### HAWAII ONLY: They're sending one extra number

#qc1 <- bioqc %>%  filter(d_827220437==300267574)

#Blood
qc1_blood <- bioqc %>%  filter(str_sub(d_173836415_d_266600170_d_341570479,1,11)!=str_sub(d_646899796_integer,1,11)) 

qc1_blood <- qc1_blood %>% select(Site, Connect_ID, d_173836415_d_266600170_d_341570479, d_646899796_integer, d_556788178 ) %>%  sort_by(Site)


# qc1_blood %>%  gt() %>%  
#   tab_header(title = md("KPHI Blood Accession ID Errors")) %>% 
#   cols_label(Connect_ID = md("**Connect ID**"), d_173836415_d_266600170_d_341570479 = md("**KPHI Accession ID**"), d_646899796_integer= md("**Expected Accession ID**"))

colnames(qc1_blood) <- c("Site", "Connect ID", "KP Accession ID" , "Expected Accession ID", "Collection Date/Time")
#knitr::kable(qc1_blood)


write.csv(qc1_blood,glue("{local_drive}Mismatched_Blood_Accession_IDs{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")


```



```{r CSV2, echo=FALSE, warning=FALSE, message=FALSE}


#### IN A SEPARATE REPORT





#Urine
qc1_urine <- bioqc %>%  filter(str_sub(d_173836415_d_266600170_d_198261154,1,11)!=str_sub(d_928693120_integer,1,11)) 

qc1_urine$AID<- strtoi(qc1_urine$d_928693120_integer, base = 0L)

qc1_urine <- qc1_urine %>% select(Site, Connect_ID, d_173836415_d_266600170_d_198261154, d_928693120_integer, d_556788178 ) %>%  sort_by(Site)

# qc1_urine %>%  gt() %>%  
#   tab_header(title = md("KPHI Urine Accession ID Errors")) %>% 
#   cols_label(Connect_ID = md("**Connect ID**"), d_173836415_d_266600170_d_198261154 = md("**KPHI Accession ID**"), d_928693120_integer= md("**Expected Accession ID**"))

colnames(qc1_urine) <- c("Site", "Connect ID", "KP Accession ID" , "Expected Accession ID", "Collection Date/Time")
#knitr::kable(qc1_urine)


write.csv(qc1_urine,glue("{local_drive}Mismatched_Urine_Accession_IDs{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")


```







```{r Duplicates, include=FALSE}

dup <- "WITH T AS (
  SELECT Connect_ID FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.biospecimen_JP`
  GROUP BY Connect_ID
  HAVING COUNT(Connect_ID) > 1) 
SELECT * FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.biospecimen_JP`
INNER JOIN T ON `nih-nci-dceg-connect-prod-6d04.FlatConnect.biospecimen_JP`.Connect_ID = T.Connect_ID ;"


dup_table <- bq_project_query(project, dup)


dup_data <- bq_table_download(dup_table, bigint = "integer64", n_max = Inf, page_size = 1000)


dup_data$Connect_ID <- as.numeric(dup_data$Connect_ID)


bio_dup= left_join(dup_data, parts_data, by=c("Connect_ID", "d_827220437") )

bio_dup <- bio_dup %>%  mutate(Site=case_when(d_827220437==531629870 ~ "HP",
                                                 d_827220437==548392715 ~ "HF",
                                                 d_827220437==303349821 ~ "Marshfield",
                                                 d_827220437==657167265 ~ "Sanford",
                                                 d_827220437==809703864 ~ "UChicago",
                                                d_827220437==125001209 ~ "KPCO",
                                                 d_827220437==327912200 ~ "KPGA",
                                                 d_827220437==300267574 ~ "KPHI",
                                                 d_827220437==452412599 ~ "KPNW"),
                               Finalized= case_when(d_410912345==104430631 ~ "No",
                                                    d_410912345==353358909 ~ "Yes",
                                                    TRUE ~ "Not Enterted"))


```


```{r DupCsv, echo=FALSE, warning=FALSE, message=FALSE}

dup_list <- bio_dup %>%  select(Site, Connect_ID, d_820476880, d_556788178, Finalized)
colnames(dup_list) <- c("Site", "Connect ID", "Collection ID", "Collection Date/Time", "Collection Finalized")
#knitr::kable(dup_list)


write.csv(dup_list,glue("{local_drive}Duplicate_Baseline_Biospecimen_Collections{currentDate}_boxfolder_{boxfolder}.csv"),row.names = F,na="")



```












```{r AddRules, include=FALSE}

#Add to Jake's rule list

#STRECK Tube 1_ID  // d_505347689_d_825582494 // crossValid1 equal to or less than char() // 14 // d_505347689_d_593843561 //	353358909

# STRECK Tube 1- Tube Collected	    d_505347689_d_593843561	valid	353358909, 104430631		
# STRECK Tube 1- Deviation	          d_505347689_d_678857215	NA or crossValid1	353358909, 104430631		
# STRECK Tube 1- Discard Flag	      d_505347689_d_762124027	NA or crossValid1	353358909, 104430631	d_505347689_d_248868659_d_472864016	353358909
# STRECK Tube 1- Deviation Hemolyzed	d_505347689_d_248868659_d_242307474	NA or crossValid1	353358909, 104430631	d_505347689_d_678857215	353358909
# STRECK Tube 1- Deviation Mislabeled Resolved	d_505347689_d_248868659_d_283900611	NA or crossValid1	353358909, 104430631	d_505347689_d_678857215	353358909
# STRECK Tube 1- Deviation Outside Contaminated	d_505347689_d_248868659_d_313097539	NA or crossValid1	353358909, 104430631	d_505347689_d_678857215	353358909
# STRECK Tube 1- Deviation Other	d_505347689_d_248868659_d_453343022	NA or crossValid1	353358909, 104430631	d_505347689_d_678857215	353358909
# STRECK Tube 1- Deviation Broken	d_505347689_d_248868659_d_472864016	NA or crossValid1	353358909, 104430631	d_505347689_d_678857215	353358909
# STRECK Tube 1- Deviation Temperature Too Low	d_505347689_d_248868659_d_550088682	NA or crossValid1	353358909, 104430631	d_505347689_d_678857215	353358909
# STRECK Tube 1- Deviation Mislabeled Discard	d_505347689_d_248868659_d_684617815	NA or crossValid1	353358909, 104430631	d_505347689_d_678857215	353358909
# STRECK Tube 1- Deviation Temperature Too High	d_505347689_d_248868659_d_690540566	NA or crossValid1	353358909, 104430631	d_505347689_d_678857215	353358909
# STRECK Tube 1- Deviation Low Volume-(tube/container partially filled but still usable)	d_505347689_d_248868659_d_728366619	NA or crossValid1	353358909, 104430631	d_505347689_d_678857215	353358909
# STRECK Tube 1- Deviation Leaked/Spilled	d_505347689_d_248868659_d_757246707	NA or crossValid1	353358909, 104430631	d_505347689_d_678857215	353358909
# STRECK Tube 1- Deviation Tube Size	d_505347689_d_248868659_d_777486216	NA or crossValid1	353358909, 104430631	d_505347689_d_678857215	353358909
# STRECK Tube 1- Deviation Discard	d_505347689_d_248868659_d_810960823	NA or crossValid1	353358909, 104430631	d_505347689_d_678857215	353358909
# STRECK Tube 1- Deviation Not Found	d_505347689_d_248868659_d_982885431	NA or crossValid1	353358909, 104430631	d_505347689_d_678857215	353358909


#STRECK Tube 1 Collected BS	d_878865966	crossValid2	353358909	d_505347689_d_593843561	353358909	d_331584571	266600170							If the visit type is Baseline and any blood tube is collected, then the baseline blood is maked as collected																																																			

#STEK Tube HF Collected DB	d_173836415_d_266600170_d_534041351	crossValid3	353358909	d_505347689_d_593843561	353358909	d_650516960	664882224	d_505347689_d_762124027	104430631	 d_827220437 548392715					If any indiviudal blood tubes collected=yes than BioClin_DBBloodRRL_v1r0 needs to be yes



#EVENTUALLY: STEK Tube Sanford Collected DB	d_173836415_d_266600170_d_534041351	crossValid3	353358909	d_505347689_d_593843561	353358909	d_650516960	664882224	d_505347689_d_762124027	104430631	 d_827220437 657167265					If any indiviudal blood tubes collected=yes than BioClin_DBBloodRRL_v1r0 needs to be yes

#EVENTUALLY: STEK Tube HP Collected DB	d_173836415_d_266600170_d_534041351	crossValid3	353358909	d_505347689_d_593843561	353358909	d_650516960	664882224	d_505347689_d_762124027	104430631	 d_827220437 531629870					If any indiviudal blood tubes collected=yes than BioClin_DBBloodRRL_v1r0 needs to be yes


#EVENTUALLY: ACD Tube Sanford Collected DB	d_173836415_d_266600170_d_534041351	crossValid3	353358909	d_652357376_d_593843561	353358909	d_650516960	664882224	d_652357376_d_762124027	104430631		 d_827220437 657167265				If any indiviudal blood tubes collected=yes than BioClin_DBBloodRRL_v1r0 needs to be yes
#EVENTUALLY: ACD Tube HP Collected DB	d_173836415_d_266600170_d_534041351	crossValid3	353358909	d_652357376_d_593843561	353358909	d_650516960	664882224	d_652357376_d_762124027	104430631		 d_827220437 531629870				If any indiviudal blood tubes collected=yes than BioClin_DBBloodRRL_v1r0 needs to be yes





#add to my rule list 

#qc14_tube8 <- bioqc %>%  filter(d_505347689_d_593843561==104430631 & d_650516960== 534621077 & is.na(d_505347689_d_883732523)) %>%  select(Site, Connect_ID, d_505347689_d_883732523) %>%  sort_by(Site)
#colnames(qc14_tube8) <- c("Site", "Connect ID", "STRECK Tube 1- Reason Tube Not Collected")

# qc13_tube8 <- bioqc %>%  filter(as.numeric(round(difftime(currentDate, d_173836415_d_266600170_d_398645039, units="days"), digits=0))>4 & d_505347689_d_593843561==353358909 & d_505347689_d_762124027==104430631 & is.na(d_505347689_d_926457119) & d_827220437==548392715 & d_650516960==664882224) %>% # | d_827220437==657167265 once Sanford is hybrid
#   select(Site, Connect_ID, d_505347689_d_926457119) %>%  sort_by(Site)
# 
# 
# colnames(qc13_tube8) <- c("Site", "Connect ID", "STRECK Tube 1- Date Received")
# knitr::kable(qc13_tube8)


```













